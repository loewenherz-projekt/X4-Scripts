<?xml version="1.0" encoding="iso-8859-1" ?>
<aiscript name="boarding.pod" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="2">
  <params>
    <param name="target" />
    <param name="targetpos" />
    <param name="targetrot" />
    <param name="initialwaittime" />
    <param name="operation" default="null" comment="Boarding operation"/>
    <param name="debugchance" default="0"/>
  </params>
  <interrupts>
    <handler ref="TargetInvalidHandler"/>
  </interrupts>
  <attention min="unknown">
    <actions>
      <set_command command="command.move" param="$target"/>

      <set_value name="$startship" exact="this.ship" />
      <do_if value="$operation and $target != $operation.boardee">
        <debug_text text="'Target: ' + $target + ' is not the boarding operation target ' + $operation + ' - ' + $operation.boardee + ' ' + $operation.boardee.knownname" filter="error"/>
      </do_if>
      <do_if value="$operation">
        <!--Fire a signal the MD Boarding script is waiting for-->
        <signal_objects object="$target" param="$operation" param2="'boarding__podstarted'" param3="$startship"/>
      </do_if>
      
      <wait exact="$initialwaittime" />

       <!-- Note: generic flightbehaviour does not take the target size into account for the event_object_approaching_waypoint -->
      <move_to destination="$target" object="this.ship" flightbehaviour="flightbehaviour.droneattach" uselocalhighways="false" finishonapproach="true" forcesteering="true" avoid="false">
        <interrupt>
          <conditions>
            <event_object_approaching_waypoint object="this.ship" />
            <check_value value="$target.bboxdistanceto.{this.ship} lt 100m"/>
          </conditions>
        </interrupt>
      </move_to>

      <!-- Disable my collision reaction with the target -->
      <set_avoid_collisions object="this.ship" bigobjects="false" smallobjects="false" />
      <disable_collision_response object="this.ship" />

      <set_value name="$find_targetpos_timeout" exact="player.age + 3s"/>

      <label name="findsurfaceposition"/>
      
      <!-- find surface and move to it -->
      <do_if value="$target.isphysicsready">
        <find_object_surface object="$target" posname="$targetpos" rotname="$targerrot"/>
      </do_if>
      <!-- in case of no surface position -->
      <do_if value="not @$targetpos">
        <do_if value="player.age lt $find_targetpos_timeout">
          <wait exact="20ms" sinceversion="2"/>
          <resume label="findsurfaceposition"/>
        </do_if>
        <do_else>
          <create_position name="$targetpos" space="$target" />
          <create_rotation name="$targerrot"/>
          <debug_text text="'no target pos found on find_surface: %s'.[$targetpos]" />
        </do_else>
      </do_if>

      <debug_text text="'moving to attach to target.'" chance="$debugchance"/>

      <move_to destination="$target" object="this.ship" flightbehaviour="flightbehaviour.droneattach" forcerotation="true" uselocalhighways="false" forcesteering="true" abortpath="true" relativemovement="true">
        <position value="$targetpos" />
        <rotation value="$targerrot" />
      </move_to>


      <!-- attach it -->
      <attach_object_to_target object="this.ship" target="$target" keepoffset="true" />
      <!-- play the animation -->
      <set_object_active object="this.ship" activate="true" />

      <wait min="100ms" max="250ms" />

      <do_if value="$operation">
        <!--Fire a signal the MD Boarding script is waiting for-->
        <signal_objects object="$target" param="$operation" param2="'boarding__podattached'" param3="$startship"/>
      </do_if>
      <debug_text text="'Boarding done!! '" chance="$debugchance" />

    </actions>
  </attention>
</aiscript>
