<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="order.transferworkers.routine" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">
  <order id="TransferWorkersRoutine" name="{1041, 791}" description="{1041, 792}" category="internal" infinite="true" allowinloop="false">
    <params>
      <param name="targetsector" type="sector" text="{1041, 10117}" required="true" default="null" comment="Sector in which workers will be transported."/>
      <param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
        <input_param name="truevalue" value="100"/>
      </param>
    </params>
  </order>
  <interrupts>
    <handler ref="SectorChangeHandler"/>
    <handler ref="TargetInvalidHandler"/>
    <handler ref="AttackHandler"/>
    <handler ref="MissileLockHandler" />
    <handler ref="ScannedHandler"/>
    <handler ref="InspectedHandler"/>
    <handler ref="FoundAbandonedHandler"/>
    <handler ref="FoundLockboxHandler"/>
    <handler ref="ResupplyHandler"/>
  </interrupts>
  <attention min="unknown">
    <actions>

      <do_if value="this.assignedcontrolled.isvisitor and not $targetsector.exists">
        <do_if value="not this.assignedcontrolled.sector">
          <debug_text text="'Visitor ship %s %s %s is not in a sector. Unable to initialize. Aborting.'.[@this.assignedcontrolled.idcode, this.assignedcontrolled.knownname, this.assignedcontrolled]" filter="error"/>
          <resume label="finish"/>
        </do_if>
        <set_value name="$targetsector" exact="this.assignedcontrolled.sector"/>
        <do_if value="this.assignedcontrolled.order and this.assignedcontrolled.order.$targetsector?">
          <edit_order_param order="this.assignedcontrolled.order" param="'targetsector'" value="$targetsector"/>
        </do_if>
      </do_if>

      <do_if value="not $targetsector.exists">
        <debug_text text="'Targetsector %s %s does not exist. Aborting.'.[$targetsector.idcode, $targetsector.knownname]" filter="error"/>
        <resume label="finish"/>
      </do_if>

      <label name="prep"/>

      <find_station groupname="$sectorstations" space="$targetsector" knownto="if this.assignedcontrolled.isplayerowned then faction.player else null" multiple="true">
        <match_relation_to object="this.assignedcontrolled" relation="neutral" comparison="ge"/>
      </find_station>

      <label name="start"/>

      <set_value name="$peoplecap" exact="this.assignedcontrolled.people.{entityrole.worker}.count + this.assignedcontrolled.people.free"/>
      <shuffle_group group="$sectorstations"/>
      <do_for_each name="$potentialorigin" in="$sectorstations">
        <set_value name="$origin" exact="$potentialorigin"/>
        <set_value name="$raceamounts_origin" exact="$origin.workforce.amounts"/>
        <do_for_each name="$potentialdestination" in="$sectorstations" reverse="true">
          <do_if value="$potentialdestination == $origin">
            <continue/>
          </do_if>
          <do_for_each name="$locspecies" valuename="$locamount" in="$raceamounts_origin">
            <set_value name="$locfree" exact="$potentialdestination.workforce.{$locspecies}.capacity - $potentialdestination.workforce.{$locspecies}.amount"/>
            <do_if value="$potentialdestination.workforce.races.indexof.{$locspecies} and ($locfree ge 0)">
              <do_if value="$locfree ge $peoplecap">
                <set_value name="$destination" exact="$potentialdestination"/>
                <set_value name="$numpeople" exact="$peoplecap"/>
                <set_value name="$species" exact="$locspecies"/>
                <break/>
              </do_if>
              <do_elseif value="not $bestdestination? or ($locfree gt @$bestfree)">
                <set_value name="$bestdestination" exact="$potentialdestination"/>
                <set_value name="$bestfree" exact="$locfree"/>
                <set_value name="$bestspecies" exact="$locspecies"/>
              </do_elseif>
            </do_if>
          </do_for_each>
          <remove_value name="$locfree"/>
          <do_if value="@$destination.isoperational">
            <break/>
          </do_if>
        </do_for_each>
        <do_if value="@$destination.isoperational">
          <break/>
        </do_if>
        <wait min="2s" max="5s"/>
      </do_for_each>
      <remove_value name="$raceamounts_origin"/>
      <do_if value="not @$destination.isoperational and @$bestdestination.isoperational and $bestdestination != $origin">
        <set_value name="$destination" exact="$bestdestination"/>
        <set_value name="$numpeople" exact="$bestfree"/>
        <set_value name="$species" exact="$bestspecies"/>
      </do_if>
      <remove_value name="$bestspecies"/>
      <remove_value name="$bestfree"/>
      <remove_value name="$bestdestination"/>

      <do_if value="@$origin.isoperational and @$destination.isoperational">
        <debug_text text="'%s %s %s ferrying %s %s workers from %s %s %s to %s %s %s in sector %s %s.'.[@this.assignedcontrolled.idcode, this.assignedcontrolled.knownname, this.assignedcontrolled, $numpeople, $species, @$origin.idcode, $origin.knownname, $origin, @$destination.idcode, $destination.knownname, $destination, $targetsector.knownname, $targetsector]" chance="$debugchance"/>
        <create_order id="'TransferWorkers'" object="this.assignedcontrolled">
          <param name="origin" value="$origin"/>
          <param name="destination" value="$destination"/>
          <param name="numpeople" value="[$numpeople, $peoplecap].min"/>
          <param name="species" value="$species"/>
          <param name="debugchance" value="$debugchance"/>
        </create_order>
      </do_if>
      <do_else>
        <do_if value="this.assignedcontrolled.isvisitor">
          <do_all exact="15" counter="$i">
            <find_sector_in_range name="$newsector" object="this.assignedcontrolled" mindistance="$i" maxdistance="$i" excluded="$targetsector" reachablefrom="this.assignedcontrolled">
              <match_relation_to object="this.assignedcontrolled" relation="dock" comparison="ge"/>
            </find_sector_in_range>
            <do_if value="@$newsector.isoperational">
              <break/>
            </do_if>
          </do_all>
          <do_if value="@$newsector.isoperational">
            <debug_text text="'sector changed from %s (%s) to %s (%s), %s gates away.'.[$targetsector.knownname, $targetsector.macro, $newsector.knownname, $newsector.macro, this.assignedcontrolled.gatedistance.{$newsector}]" chance="$debugchance"/>
            <set_value name="$targetsector" exact="$newsector"/>
            <do_if value="$targetsector.exists and this.assignedcontrolled.order and this.assignedcontrolled.order.$targetsector?">
              <edit_order_param order="this.assignedcontrolled.order" param="'targetsector'" value="$targetsector"/>
            </do_if>
          </do_if>
          <do_else>
            <debug_text text="'No valid sector found within 15 gates of sector %s (%s).'.[@this.assignedcontrolled.sector.knownname, @this.assignedcontrolled.sector.macro]" filter="error"/>
          </do_else>
          <remove_value name="$newsector"/>
        </do_if>
        <debug_text text="'no station pair with compatible workforce found. waiting then looping back.'"/>
      </do_else>

      <do_if value="@this.assignedcontrolled.order.isinfinite">
        <!-- syncpoint reached after first pair of transfers is decided. -->
        <set_order_syncpoint_reached order="this.assignedcontrolled.order"/>
      </do_if>

      <wait min="17min" max="23min"/>

      <!-- back to prep rather than start in case more stations have been built in the interim. -->
      <resume label="prep"/>

      <label name="finish"/>

    </actions>
  </attention>
</aiscript>