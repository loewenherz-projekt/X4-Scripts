<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="lib.target.selection" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">
  <params>
    <param name="primarytarget" comment="Object to attack" />
    <param name="secondarytargets" comment="List/Group of objects to attack" />
    <param name="escort" comment="A friendly object to stay in pursuedistance range to it and prefer targets near him" />
    <param name="pursuedistance" comment="Distance to pursue/escort (if pursuetargets false or 'escort' provided)" />
    <param name="pursuetargets" comment="Pursue the target no matter what" />
    <param name="list_objectstoignore" default="[]" comment="List of objects to ignore. Only used from move.seekenemies at the moment."/>
    <param name="allowothertargets" comment="Whether the script shall keep running when all primary targets have been destroyed"/>
    <param name="checkrelation" comment="Check may attack (faction enemy relation)" />
    <param name="targetpurposes" default="[]" />
    <param name="targetclasses" default="[]"/>

    <param name="radius" default="null" comment="disengage if target goes beyond this distance relative to radiusanchorpos in radiusanchorspace"/>
    <param name="radiusanchorpos" default="null"/>
    <param name="radiusanchorspace" default="null"/>

    <param name="engageonlyonline" default="false"/>
    <param name="shootindestructibleprimary" default="false"/>

    <param name="debugchance" default="0" />
  </params>
  <attention min="unknown">
    <actions>
      <!-- if primary target is a station:
              * if this is a small fighter:
                 - go for surface elements
              * if this is a capship
                 - go to big modules
      -->

      <set_value name="$targets" exact="[]"/>

      <do_if value="not $targetclasses.count">
        <set_value name="$targetclasses" exact="[class.ship, class.station]"/>
      </do_if>

      <!-- if primary/secondary targets set, set them as the target list -->
      <do_if value="$primarytarget.canbeattacked">
        <do_if value="not $list_objectstoignore.indexof.{$primarytarget}">
          <debug_text text="'Primary target found, preferring it'" chance="$debugchance" />
          <append_to_list name="$targets" exact="$primarytarget" />
        </do_if>
        <do_else>
          <debug_text text="'%1 (%2) cannot attack %3 (%4) right now because we were told to ignore it.'.[this.ship.knownname, this.ship, $primarytarget.knownname, $primarytarget]" chance="$debugchance"/>
        </do_else>
      </do_if>
      <do_elseif value="@$secondarytargets.count">
        <debug_text text="'Secondary targets found, choosing one of them'" chance="$debugchance" />
        <!-- $secondarytargets can be a group or list -->
        
        <do_for_each name="$secondarytarget" in="$secondarytargets">
          <do_if value="not $list_objectstoignore.indexof.{$secondarytarget}">
            <append_to_list name="$targets" exact="$secondarytarget"/>
          </do_if>
          <do_else>
            <debug_text text="'%1 (%2) cannot attack %3 (%4) right now because we were told to ignore it.'.[this.ship.knownname, this.ship, $secondarytarget.knownname, $secondarytarget]" chance="$debugchance"/>
          </do_else>
        </do_for_each>
      </do_elseif>
      <do_elseif value="$allowothertargets">
        <do_if value="$targets.count == 0">
          <debug_text text="'Checking blackboard for a target object'" chance="$debugchance" />
          <set_value name="$commandertarget" exact="@this.assignedcontrolled.commander.pilot.$attacktarget"/>
          <do_if value="$commandertarget and $commandertarget.canbeattacked">
            <do_if value="not $list_objectstoignore.indexof.{$commandertarget}">
              <append_to_list name="$targets" exact="$commandertarget"/>
            </do_if>
            <do_else>
              <debug_text text="'%1 (%2) cannot attack %3 (%4) right now because we were told to ignore it.'.[this.ship.knownname, this.ship, $commandertarget.knownname, $commandertarget]" chance="$debugchance"/>
            </do_else>
          </do_if>
        </do_if>
        <!-- else, use enemy gravidar contacts as the target list -->
        <do_if value="$targets.count == 0 and this.sector">
          <debug_text text="'Checking gravidar for enemies'" chance="$debugchance" />
          <find_gravidar_contact name="$targets" multiple="true" docked="false" object="this.ship" class="$targetclasses" masstraffic="false" checkoperational="false" maybeattackedby="if $checkrelation then this.assignedcontrolled else null" excluded="$list_objectstoignore" append="true">
            <match_context macro="this.sector.macro"/>
            <match class="class.buildstorage" negate="true"/>
            <match state="componentstate.wreck" negate="true"/>
          </find_gravidar_contact>
        </do_if>
        <!-- if we *still* have no enemies, and are escorting something, see if there are enemies of any of them around -->
        <do_if value="$targets.count == 0 and @$escort.exists and this.sector">
          <debug_text text="'Checking gravidar for enemies of escort ' + $escort.knownname" chance="$debugchance" />
          <find_gravidar_contact name="$targets" multiple="true" docked="false" object="this.ship" class="$targetclasses" masstraffic="false" checkoperational="false" maybeattackedby="if $checkrelation then $escort else null" excluded="$list_objectstoignore" append="true">
            <match_context macro="this.sector.macro"/>
            <match class="class.buildstorage" negate="true"/>
            <match state="componentstate.wreck" negate="true"/>
          </find_gravidar_contact>
        </do_if>
      </do_elseif>

      <label name="selection" />

      <set_value name="$selected" exact="0" />
      <set_value name="$highest" exact="-1" />
      <do_for_each name="$target" in="$targets" counter="$i">
        <!-- Skip conditions -->
        <do_if value="(not $target.canbeattacked) or ($checkrelation and not this.mayattack.{$target}) or (this.trueowner == $target.trueowner) or (@$target.dock)">
          <debug_text text="'cannot attack %1 (%2) because it is not operational: %3, it is friendly: %4, or it is docked: %5.'.[$target.knownname, $target, not $target.isoperational, $checkrelation and not this.mayattack.{$target}, @$target.dock]" chance="$debugchance"/>
          <continue />
        </do_if>
        <do_elseif value="$target.zone.isclass.highway">
          <debug_text text="'%1 (%2) cannot attack %3 (%4) right now because it is in a highway.'.[this.ship.knownname, this.ship, $target.knownname, $target]" chance="$debugchance"/>
          <continue/>
        </do_elseif>
        <do_elseif value="$target.isclass.buildstorage">
          <debug_text text="'%s %s %s cannot attack %s %s %s because it is a build storage module. ignoring.'.[this.assignedcontrolled.idcode, this.assignedcontrolled.knownname, this.assignedcontrolled, $target.idcode, $target.knownname, $target]" chance="$debugchance"/>
          <continue/>
        </do_elseif>
        <do_elseif value="$radius and $radiusanchorpos and $radiusanchorspace.exists and not $pursuetargets and this.isplayerowned and ($target.distanceto.[$radiusanchorspace, $radiusanchorpos] gt $radius)">
          <debug_text text="'%1 (%2) cannot attack %3 (%4) right now because target is outside our engagement area.\n target distance to anchor: %sm\n radius: %sm'.[this.ship.knownname, this.ship, $target.knownname, $target, $target.distanceto.[$radiusanchorspace, $radiusanchorpos], $radius]" chance="$debugchance"/>
          <continue/>
        </do_elseif>
        <do_elseif value="not $target.isclass.{$targetclasses} and not @$target.container.isclass.{$targetclasses} and (not $targetclasses.indexof.{class.station} or (not @$target.ismodular and not @$target.container.ismodular) or (@$target.isclass.ship and not @$target.canhaveattackablemodules and not @$target.container.canhaveattackablemodules))">
          <debug_text text="'%s %s %s cannot attack %s %s %s which does not belong to a valid class and is not contained within anything.'.[this.assignedcontrolled.idcode, this.assignedcontrolled.knownname, this.assignedcontrolled, $target.class, $target.knownname, $target]" chance="$debugchance"/>
          <continue/>
        </do_elseif>
        <!--<do_elseif value="not $target.isclass.defensible and not $target.container and not $target.ismodular">
          <debug_text text="'%s %s %s cannot attack %s %s which is neither a ship, a station, nor something connected to anything.'.[this.assignedcontrolled.idcode, this.assignedcontrolled.knownname, this.assignedcontrolled, $target.knownname, $target]" chance="$debugchance"/>
          <continue/>
        </do_elseif>-->
        <do_elseif value="$target.isclass.ship_xs and not $target.islasertower and not $target.isclass.spacesuit and ($target != $primarytarget)">
          <debug_text text="'%s %s %s cannot attack %s %s which is not a lasertower.'.[@this.assignedcontrolled.idcode, @this.assignedcontrolled.knownname, this.assignedcontrolled, @$target.knownname, $target]" chance="$debugchance"/>
          <continue/>
        </do_elseif>
        <do_elseif value="$target.isclass.spacesuit and not $targetclasses.indexof.{class.spacesuit} and ($target != $primarytarget)">
          <debug_text text="'%s %s %s cannot attack %s %s which is a spacesuit.'.[@this.assignedcontrolled.idcode, @this.assignedcontrolled.knownname, this.assignedcontrolled, @$target.knownname, $target]" chance="$debugchance"/>
          <continue/>
        </do_elseif>
        <do_elseif value="$target.isindestructible and (not this.isplayerowned or @this.assignedcontrolled.order.$internalorder)">
          <do_if value="this.isplayerowned">
            <set_value name="$rep" exact="player.entity"/>
          </do_if>
          <do_elseif value="this.trueowner.representative">
            <set_value name="$rep" exact="this.trueowner.representative"/>
          </do_elseif>
          <do_else>
            <set_value name="$rep" exact="this"/>
          </do_else>

          <do_if value="@$rep.$indestructibleobjects.indexof.{$target}">
            <debug_text text="'%s %s %s refusing to attack %s %s which we have learned is indestructible.'.[this.assignedcontrolled.idcode, this.assignedcontrolled.knownname, this.assignedcontrolled, $target.knownname, $target]" chance="$debugchance"/>
            <continue/>
          </do_if>
        </do_elseif>
        <do_elseif value="$engageonlyonline and not $target.isonlineobject">
          <debug_text text="'ignoring %s %s %s which is not an online object.'.[@$target.idcode, @$target.knownname, $target]" chance="$debugchance"/>
          <continue/>
        </do_elseif>

        <do_if value="(not this.isplayerowned or @this.assignedcontrolled.order.$internalorder) and @$target.boardingoperations.count gt 0">
          <do_for_each name="$op" in="$target.boardingoperations">
            <do_if value="$op.attackers.count and not this.assignedcontrolled.hasrelation.enemy.{$op.attackers.{1}.owner}">
              <set_value name="$_break"/>
              <break/>
            </do_if>
          </do_for_each>
          <do_if value="$_break?">
            <remove_value name="$_break"/>
            <debug_text text="'%s %s %s cannot attack %s %s %s because it is being boarded by a non-hostile faction. ignoring.'.[this.assignedcontrolled.idcode, this.assignedcontrolled.knownname, this.assignedcontrolled, $target.idcode, $target.knownname, $target]" chance="$debugchance"/>
            <continue/>
          </do_if>
        </do_if>

        <do_if value="$escort.exists">
          <set_value name="$refobject" exact="$escort"/>
        </do_if>
        <do_else>
          <set_value name="$refobject" exact="this.ship"/>
        </do_else>

        <!-- distance to this ship -->
        <set_value name="$distance" exact="$target.distanceto.{$refobject}"/>

        <!-- skip if too far away -->
        <do_if value="not $pursuetargets and ($refobject.sector != $target.sector)">
          <debug_text text="'%s (%s) is in a different sector. skipping target.'.[$target.knownname, $target]" chance="$debugchance"/>
          <continue/>
        </do_if>
        <debug_text text="'%s %s checking distance to target.\n distance to target: %s\n pursue distance: %s'.[this.ship.knownname, this.ship, $distance, $pursuedistance]" chance="0"/>
        <do_if value="not $pursuetargets">
          <do_if value="not $escort and $radius and $radiusanchorpos and $radiusanchorspace.exists">
            <do_if value="$target.distanceto.[$radiusanchorspace, $radiusanchorpos] gt $radius">
              <debug_text text="'%1 %2 %3 is too far away from radiusanchorpos. skipping target.\n target: %1 %2 %3 \n distance: %4 \n radius: %5'.[@$target.idcode, @$target.knownname, $target, $target.distanceto.[$radiusanchorspace, $radiusanchorpos], $radius]" chance="$debugchance"/>
              <continue/>
            </do_if>
          </do_if>
          <do_elseif value="$pursuedistance">
            <do_if value="$distance gt $pursuedistance">
              <debug_text text="'%1 (%2) is too far away. skipping target.\n target: %1 (%2) \n distance: %3 \n temp_pursuedistance: %4'.[$target.knownname, $target, $distance, $pursuedistance]" chance="$debugchance"/>
              <continue/>
            </do_if>
          </do_elseif>
        </do_if>

        <!-- Set initial priority -->
        <set_value name="$priority" exact="0.0"/>

        <!-- prioritize targets by certain conditions -->
        <do_if value="$target == $primarytarget or $target.container == $primarytarget">
          <!-- is the current target (prioritize higher to prevent frequent switching) -->
          <set_value name="$priority" exact="$priority + 10.0"/>
        </do_if>
        <do_else>
          <do_if value="$targetpurposes.count and not $targetpurposes.indexof.{@$target.primarypurpose}">
            <debug_text text="'%1 (%2) is not of the type that i am looking for. \n target: %1 (%2) \n target purpose: %3 \n target container purpose: %4'.[$target.knownname, $target, @$target.primarypurpose, @$target.container.primarypurpose]" chance="$debugchance"/>
            <continue />
          </do_if>
          <do_elseif value="$targetclasses.count">
            <do_if value="not $target.isclass.{$targetclasses} and ($target.isclass.defensible or not @$target.defensible.isclass.{$targetclasses})">
              <debug_text text="'%s %s %s is not of a class that i am looking for.'.[$target.class, @$target.knownname, $target]" chance="$debugchance"/>
              <continue/>
            </do_if>
          </do_elseif>
        </do_else>

        <!-- add priority linearly between min and max distance -->
        <do_if value="@$closestmodule.canbeattacked and ($closestmodule == $target)">
          <set_value name="$priority" exact="$priority + 10.0"/>
          <debug_text text="'evaluated distance. closest module. priority: %s, distance: %sm'.[$priority, $distance]" chance="$debugchance"/>
        </do_if>
        <do_elseif value="$distance lt 5500m">
          <do_if value="$distance gt 500m">
            <set_value name="$priority" exact="$priority + (10.0 - ($distance - 500m)f / 500.0)" />
          </do_if>
          <do_else>
            <set_value name="$priority" exact="$priority + 10.0" />
          </do_else>
          <debug_text text="'evaluated distance. priority: %s, distance: %sm'.[$priority, $distance]" chance="$debugchance"/>
        </do_elseif>

        <!-- faction relation to this ship and escort (the lower the combined relation, the higher the priority) -->
        <set_value name="$priority" exact="$priority - $target.relationto.{this.assignedcontrolled} * 5.0" />

        <!-- closest distance to any escort, if there are any -->
        <do_if value="@$escort.exists">
          <!-- (the lower the combined relation, the higher the priority) -->
          <set_value name="$priority" exact="$priority - $target.relationto.{$escort} * 3.0" />
        </do_if>

        <!-- damage potential vs. time to destroy -->
        <do_if value="($target.hull + $target.shield) gt 0">
          <set_value name="$targetdps" exact="@$target.dps.all"/>
          <do_if value="$targetdps">
            <set_value name="$priority" exact="$priority + 10.0 * ($targetdps)f / ($target.hull + $target.shield)f" />
          </do_if>
          <debug_text text="'evaluated dps.\ntarget: %s %s\npriority: %s\ndps: %s\nhull + shield: %s'.[$target.knownname, $target, $priority, $targetdps, $target.hull + $target.shield]" chance="$debugchance"/>
          <remove_value name="$targetdps"/>
        </do_if>

        <!-- TODO: recent damage against this ship, an escort or allies -->
        <!-- TODO: evaluate fight/flight by comparing combined enemy strength to combined allied strength? -->

        <do_if value="$priority gt $highest">
          <set_value name="$highest" exact="$priority" />
          <set_value name="$selected" exact="$i" />
          <debug_text text="'switching targets to: %s %s\npriority: %s'.[$target.knownname, $target, $priority]" chance="$debugchance"/>
        </do_if>
      </do_for_each>

      <!-- Set the target (if there is a valid one) -->
      <do_if value="$selected == 0">
        <!-- no valid targets left -->
        <debug_text text="'No valid targets left'" chance="$debugchance" />
        <set_value name="$target" exact="null" />
      </do_if>
      <do_elseif value="$targets.{$selected} != $primarytarget">
        <set_value name="$target" exact="$targets.{$selected}" />
        <debug_text text="'%1 (%2) changed target to: %3 (%4)'.[this.ship.knownname, this.ship, $target.knownname, $target]" chance="$debugchance" />
      </do_elseif>
      <do_else>
        <set_value name="$target" exact="$primarytarget" />
        <debug_text text="'%1 (%2) stays with primary target: %3 (%4)'.[this.ship.knownname, this.ship, $target.knownname, $target]" chance="$debugchance" />
      </do_else>

      <!-- after the main target is selected, if it is big (station or capital ship) -->
      <do_if value="@$target.ismodular or @$target.canhaveattackablemodules or (not this.assignedcontrolled.iscapitalship and @$target.iscapitalship)">
        <!-- clear targets, and reselect again -->
        <clear_list list="$targets" />

        <!-- Capital ship vs station, we must acquire a station module. Otherwise, move against the target. -->
        <do_if value="this.ship.iscapitalship">
          <find_object_component name="$targets" object="$target" checkoperational="false" integrated="false" indestructible="false" invulnerable="false" sortbydistanceto="$refobject" excluded="$list_objectstoignore" append="true">
            <match module="@$target.ismodular or @$target.canhaveattackablemodules"/>
            <match state="componentstate.wreck" negate="true"/>
            <match_is_in_view_of object="this.assignedcontrolled" horizontal="360deg" vertical="120deg"/>
          </find_object_component>
          <debug_text text="'acquired target in view: %s %s'.[@$targets.{1}.knownname, @$targets.{1}]" chance="$debugchance"/>
          <do_if value="not $targets.count">
            <find_object_component name="$targets" object="$target" checkoperational="false" integrated="false" indestructible="false" invulnerable="false" sortbydistanceto="$refobject" excluded="$list_objectstoignore" append="true">
              <match module="@$target.ismodular or @$target.canhaveattackablemodules"/>
              <match state="componentstate.wreck" negate="true"/>
            </find_object_component>
          </do_if>
          <do_if value="@$target.ismodular or @$target.canhaveattackablemodules">
            <do_if value="$shootindestructibleprimary">
              <find_module name="$targets" object="$target" checkoperational="false" indestructible="true" invulnerable="false" sortbydistanceto="$refobject" excluded="$list_objectstoignore" multiple="true" append="true">
                <match state="componentstate.wreck" negate="true"/>
              </find_module>
            </do_if>
            <do_if value="$targets.count">
              <set_value name="$closestmodule" exact="$targets.{1}"/>
            </do_if>
          </do_if>
          <debug_text text="'bigship found %s subtargets'.[$targets.count]" chance="$debugchance"/>
        </do_if>
        <!-- small ship vs big target -->
        <do_else>
          <find_object_component name="$component" object="$target" class="[class.shieldgenerator, class.weapon, class.engine]" surfaceelement="true" integrated="false" indestructible="false" invulnerable="false" excluded="$list_objectstoignore"/>
          <do_if value="not $component">
            <!-- No components. find anything and move to it.
              If target is a station, move against a module or a surface element.
              If target is a capital ship, move against a surface element. -->
            <debug_text text="'no component found. Find anything else'" chance="$debugchance" />
            <find_object_component name="$component" object="$target" checkoperational="false" integrated="false" indestructible="false" invulnerable="false" excluded="$list_objectstoignore">
              <match_any>
                <match surfaceelement="true"/>
                <match module="@$target.ismodular or @$target.canhaveattackablemodules"/>
              </match_any>
              <match state="componentstate.wreck" negate="true"/>
            </find_object_component>
          </do_if>
          <!-- add it to the targets list -->
          <do_if value="$component">
            <debug_text text="'component found. %1 (%2) of class %3'.[$component.knownname, $component, $component.class]" chance="$debugchance" />
            <append_to_list name="$targets" exact="$component" />
            <do_if value="@$target.ismodular">
              <debug_text text="'removing %s %s %s %s from list of potential targets.'.[$target.class, $target.idcode, $target.knownname, $target]" chance="$debugchance"/>
              <remove_from_list name="$targets" exact="$target" comment="pointless to attack the station itself. station is destroyed when all modules are destroyed."/>
            </do_if>
          </do_if>
          <do_else>
            <debug_text text="'no component found.'" chance="$debugchance" />
          </do_else>
          <remove_value name="$component" />
        </do_else>
        <!-- If there are any subcomponents of target, re-select logic with those -->
        <do_if value="$targets.count">
          <!-- reselection -->
          <resume label="selection" />
        </do_if>
        <do_else>
          <debug_text text="'%1 (%2) stays with the selected target: %3 (%4)'.[this.ship.knownname, this.ship, $target.knownname, $target]" chance="$debugchance" />
        </do_else>
      </do_if>

      <return >
        <retval name="target" value="$target" />
      </return>

    </actions>
  </attention>
</aiscript>
