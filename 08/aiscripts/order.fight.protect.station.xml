<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="order.fight.protect.station" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="4">
  <!--
      
  by Adrian
  -->
  <order id="ProtectStation" name="{1041, 361}" description="{1041, 362}" category="combat" allowinloop="false">
    <params>
      <param name="station" type="object" text="{1041, 10150}" comment="Station to protect">
        <input_param name="class" value="[class.station]" />
      </param>
      <param name="radius" type="length" default="(this.ship.maxradarrange + $station.size/2f)m" text="{1041, 10093}" advanced="true" comment="Radius">
        <input_param name="min" value="(1km + $station.size/2f)m"/>
        <input_param name="max" value="(this.ship.maxradarrange + $station.size/2f)m"/>
        <input_param name="step" value="1km"/>
      </param>
      <param name="timeout" type="time" default="0s" infinitevalue="0s" text="{1041, 10034}" advanced="true" comment="Duration">
        <input_param name="max" value="1h" />
        <input_param name="step" value="30s" />
      </param>
      <param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
        <input_param name="truevalue" value="100"/>
      </param>
    </params>
    <requires>
      <match shiptype="shiptype.lasertower" negate="true"/>
      <match class="class.spacesuit" negate="true"/>
    </requires>
    <location object="$station" radius="$radius" />
  </order>
  <interrupts>
    <handler>
      <conditions>
        <event_object_changed_zone object="$station"/>
      </conditions>
      <actions>
        <abort_called_scripts resume="start"/>
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_destroyed object="$station"/>
      </conditions>
      <actions>
        <debug_text text="'station %s %s %s destroyed. ending.'.[@$station.idcode, @$station.knownname, $station]" chance="$debugchance"/>
        <set_value name="$failurereason" exact="{1045, 103}" comment="Station was destroyed."/>
        <abort_called_scripts resume="finish"/>
      </actions>
    </handler>
    <handler>
      <conditions>
        <check_any>
          <event_object_changed_owner object="$station"/>
          <event_object_relation_range_changed object="$station"/>
        </check_any>
        <check_value value="$station.mayattack.{this.assignedcontrolled}"/>
      </conditions>
      <actions>
        <debug_text text="'station %s %s %s is now hostile. ending.'.[@$station.idcode, @$station.knownname, $station]" chance="$debugchance"/>
        <set_value name="$failurereason" exact="{1045, 104}" comment="Station became hostile."/>
        <abort_called_scripts resume="finish"/>
      </actions>
    </handler>
    <handler comment="ship gets new assignment">
      <conditions>
        <check_any>
          <event_object_changed_assignment object="this.assignedcontrolled"/>
          <check_all>
            <event_object_changed_assignment object="$assignmentobject" check="false"/>
            <check_value value="this.assignedcontrolled.assignment == assignment.assist"/>
          </check_all>
        </check_any>
      </conditions>
      <actions>
        <do_if value="event.param3 != $assignment">
          <debug_text text="'%s %s %s assignment changed from %s to %s.'.[@this.assignedcontrolled.idcode, @this.assignedcontrolled.knownname, this.assignedcontrolled, $assignment, event.param3]" chance="$debugchance"/>
          <set_value name="$assignment" exact="event.param3"/>
        </do_if>
        <abort_called_scripts resume="finish"/>
      </actions>
    </handler>
    <handler ref="SectorChangeHandler"/>
    <handler ref="ScannedHandler"/>
    <handler ref="InspectedHandler"/>
    <handler ref="FoundAbandonedHandler"/>
    <handler ref="FoundLockboxHandler"/>
    <handler ref="TargetInvalidHandler"/>
    <handler ref="ResupplyHandler" />
    <handler ref="TideHandler"/>
  </interrupts>
  <init>
    <do_if value="not @$station.sector">
      <debug_text text="'station %s %s %s is not in a sector. radius will not be enforced.'.[@$station.idcode, @$station.knownname, $station]" filter="error" chance="($station.isrealclass.station and not $station.iswreck) * 100"/>
      <set_value name="$radius" exact="null"/>
    </do_if>
    <do_else>
      <set_value name="$radiusanchorspace" exact="$station.sector"/>
      <create_position name="$radiusanchorpos" space="$radiusanchorspace" object="$station"/>
    </do_else>

    <!-- no need to update since changing assignment should result in a new instance of this script. -->
    <set_value name="$assignment" exact="this.assignedcontrolled.assignment"/>
    <set_value name="$assignmentobject" exact="null"/>
    <do_if value="($assignment == assignment.assist) and (@this.assignedcontrolled.defaultorder.id == 'Assist')">
      <do_if value="@this.assignedcontrolled.defaultorder.$orderobject.isoperational">
        <set_value name="$assignmentobject" exact="this.assignedcontrolled.defaultorder.$orderobject"/>
        <set_value name="$assignment" exact="$assignmentobject.assignment"/>
      </do_if>
    </do_if>

    <set_command command="command.protect" param="$station" />
    <set_value name="$inittime" exact="player.age" />

  </init>
  <patch sinceversion="1">
    <do_if value="not $station.sector">
      <set_value name="$radius" exact="null"/>
      <set_value name="$radiusanchorspace" exact="null"/>
      <set_value name="$radiusanchorpos" exact="null"/>
    </do_if>
    <do_else>
      <set_value name="$radiusanchorspace" exact="$station.sector"/>
      <create_position name="$radiusanchorpos" space="$radiusanchorspace" object="$station"/>
    </do_else>
  </patch>
  <patch sinceversion="2">
    <set_value name="$newstation" exact="$station"/>
    <do_if value="not $station.isrealclass.station or $station.iswreck">
      <debug_text text="'PATCH: No valid station specified, and no commander found - exiting script'" filter="savegame"/>
      <set_value name="$newstation" exact="null"/>
    </do_if>
    <do_if value="@$station.mayattack.{this.assignedcontrolled}">
      <debug_text text="'PATCH: %s %s %s set to protect %s %s %s which is hostile. aborting.'.[@this.assignedcontrolled.idcode, @this.assignedcontrolled.knownname, this.assignedcontrolled, @$station.idcode, @$station.knownname, $station]" filter="savegame"/>
      <set_value name="$newstation" exact="null"/>
    </do_if>

    <do_if value="$newstation != $station">
      <set_value name="$station" exact="$newstation"/>
      <do_if value="this.assignedcontrolled.order.id == 'ProtectStation'">
        <edit_order_param order="this.assignedcontrolled.order" param="'station'" value="$station"/>
      </do_if>
    </do_if>
    <remove_value name="$newstation"/>
  </patch>
  <patch sinceversion="3">
    <do_if value="this.assignedcontrolled.order.id == 'ProtectStation'">
      <do_if value="not $station.exists or not $station.isrealclass.station or $station.iswreck or $station.mayattack.{this.assignedcontrolled}">
        <!-- restart the order which should redirect to finish -->
        <edit_order_param order="this.assignedcontrolled.order" param="'station'" value="$station"/>
      </do_if>
    </do_if>
  </patch>
  <patch sinceversion="4" early="true">
    <set_value name="$assignment" exact="this.assignedcontrolled.assignment"/>
    <set_value name="$assignmentobject" exact="null"/>
    <do_if value="($assignment == assignment.assist) and (@this.assignedcontrolled.defaultorder.id == 'Assist')">
      <do_if value="@this.assignedcontrolled.defaultorder.$orderobject.isoperational">
        <set_value name="$assignmentobject" exact="this.assignedcontrolled.defaultorder.$orderobject"/>
        <set_value name="$assignment" exact="$assignmentobject.assignment"/>
      </do_if>
    </do_if>
  </patch>
  <attention min="unknown">
    <actions>

      <!-- Initial checks -->
      <label name="start" />

      <do_if value="not $station.exists or not $station.isrealclass.station or $station.iswreck">
        <set_value name="$failurereason" exact="{1045, 103}" comment="Station was destroyed."/>
        <debug_text text="'No valid station specified, and no commander found - exiting script'" chance="$debugchance"/>
        <resume label="finish"/>
      </do_if>

      <do_if value="$station.mayattack.{this.assignedcontrolled}">
        <set_value name="$failurereason" exact="{1045, 104}" comment="Station became hostile."/>
        <debug_text text="'%s %s %s set to protect %s %s %s which is hostile. aborting.'.[@this.assignedcontrolled.idcode, @this.assignedcontrolled.knownname, this.assignedcontrolled, @$station.idcode, @$station.knownname, $station]" filter="error"/>
        <resume label="finish"/>
      </do_if>

      <do_if value="this.assignedcontrolled.hullpercentage lt 100">
        <!-- check on start in case we're coming in off of combat. -->
        <signal_objects object="this.ship" param="'resupply'" param2="[false]" param3="$debugchance" comment="param2 = [urgent?, resupplystationID], param3 = $debugchance"/>
      </do_if>

      <!-- if different zone, go there -->
      <do_if value="this.zone != $station.zone">
        <run_script name="'move.generic'" result="$movesuccess">
          <param name="destination" value="$station.zone" />
          <param name="endintargetzone" value="true" />
          <param name="activepatrol" value="true"/>
          <param name="radius" value="$radius"/>
          <param name="radiusanchorpos" value="$radiusanchorpos"/>
          <param name="radiusanchorspace" value="$radiusanchorspace"/>
          <param name="debugchance" value="$debugchance"/>
        </run_script>
        <do_if value="not $movesuccess">
          <set_value name="$failurereason" exact="{1045, 101}" comment="Unable to reach destination."/>
          <debug_text text="'Unable to reach destination. Aborting.'" chance="$debugchance"/>
          <resume label="finish"/>
        </do_if>
      </do_if>

      <!-- Required for all infinite orders, no effect in case of finite timeout -->
      <set_order_syncpoint_reached order="this.ship.order" />

      <do_while value="$station.zone.exists">
        <!-- Evaluate exit condition -->
        <do_if value="$timeout and (player.age ge $inittime + $timeout)">
          <resume label="finish" />
        </do_if>
        <!-- initial random position in zone -->
        <get_safe_pos result="$pos" zone="$station.zone" object="$station" radius="this.ship.size/2f" min="$station.size/2f" max="[$radius, this.assignedcontrolled.maxradarrange].max" />

        <run_script name="'move.seekenemies'" >
          <param name="destination" value="$station.zone" />
          <param name="pos" value="$pos" />
          <param name="escort" value="$station" />
          <param name="pursuedistance" value="$radius"/>
          <param name="radius" value="$radius"/>
          <param name="radiusanchorpos" value="$radiusanchorpos"/>
          <param name="radiusanchorspace" value="$radiusanchorspace"/>
          <param name="internalorder" value="true"/>
          <param name="debugchance" value="$debugchance" />
        </run_script>

        <do_if value="player.age gt @$next_resupply_check" chance="30">
          <debug_text text="'%1 (%2) ready to resupply.'.[this.ship.knownname, this.ship]" chance="$debugchance"/>
          <signal_objects object="this.ship" param="'resupply'" param2="[false]" param3="$debugchance" comment="param2 = [urgent?, resupplystationID], param3 = $debugchance"/>
          <set_value name="$next_resupply_check" exact="player.age + 30min"/>
        </do_if>

        <wait exact="500ms" />
      </do_while>

      <do_if value="this.isplayerowned and not this.isclass.computer and not this.assignedcontrolled.nextorder and (not this.assignedcontrolled.commander or (this.assignedcontrolled.commander == player.occupiedship)) and notification.npc_await_orders.active">
        <!-- Player notification -->
        <set_value name="$speakline" exact="10304" comment="Awaiting orders."/>
        <run_script name="'player.interaction'">
          <param name="Line" value="$speakline"/>
          <param name="MaxQueueDelay" value="10s"/>
          <param name="caption" value="{1016,6}.[this.assignedcontrolled.knownname, this.assignedcontrolled.idcode]"/>
          <param name="interactive" value="false"/>
          <param name="debugchance" value="$debugchance"/>
        </run_script>
      </do_if>

      <!-- Required for sync point handler -->
      <label name="finish" />

      <do_if value="this.assignedcontrolled.order.id == 'ProtectStation'">
        <do_if value="$failurereason?">
          <debug_text text="'order failed. reason: %s'.[$failurereason]" chance="$debugchance"/>
          <set_order_failed order="this.assignedcontrolled.order" text="$failurereason"/>
        </do_if>
        <do_if value="this.assignedcontrolled.order == this.assignedcontrolled.defaultorder">
          <cancel_order order="this.assignedcontrolled.defaultorder"/>
        </do_if>
      </do_if>

    </actions>
  </attention>
</aiscript>