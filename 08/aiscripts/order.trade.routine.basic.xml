<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="order.trade.routine.basic" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="1">
  <order id="TradeRoutine_Basic" name="{1041, 841}" description="{1041, 842}" category="trade" allowinloop="false">
    <params>
      <param name="warebasket" required="true" default="this.ship.warebasket.random" type="ware" text="{1041, 10144}" comment="Ware. Resource that we will supply.">
        <input_param name="cancarry" value="this.ship"/>
      </param>
      <param name="range" default="if @this.ship.commanderentity.$config_subordinate_range then @this.ship.commanderentity.$config_subordinate_range 
             else (if (@this.ship.commander.sector.exists and (this.ship.commander.isclass.[class.station, class.buildstorage] or this.ship.commander.type == shiptype.resupplier)) then this.ship.commander.sector else (if this.ship.jobmainsector then this.ship.jobmainsector else this.sector))" type="sector" text="{1041, 10005}" comment="Anchor space">
        <patch condition="not $range" value="if this.sector then this.sector else (if this.zone.isclass.highway then this.zone.destination.sector else null)" sinceversion="1"/>
      </param>
      <param name="minbuy" default="0" type="internal" text="{1041, 10067}" comment="Min gate distance to gather resources. Gathering range supported if $minsell and $maxsell are provided"/>
      <param name="maxbuy" default="0" type="internal" text="{1041, 10056}" comment="Max gate distance to gather resources. Gathering range supported if $minsell and $maxsell are provided"/>
      <param name="minsell" default="0" type="internal" text="{1041, 10069}" comment="Min gate distance to sell resources. Sell range supported if $minsell and $maxsell are provided"/>
      <param name="maxsell" default="0" type="internal" text="{1041, 10058}" comment="Max gate distance to sell resources. Sell range supported if $minsell and $maxsell are provided"/>

      <param name="duration" default="0s" type="time" infinitevalue="0s" advanced="true" text="{1041, 10034}" comment="Duration">
        <input_param name="startvalue" value="0s"/>
        <input_param name="min" value="0s"/>
        <input_param name="max" value="24h"/>
        <input_param name="step" value="1min"/>
      </param>
      <param name="tradeforbuildstorage" default="null" type="internal" comment="Only used for trade.find.commander. Set to look for trade offers on the connected build storage rather than on the commander."/>
      <param name="usecover" default="false" type="internal" text="Use Cover" comment="used by smugglers"/>
      <param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
        <input_param name="truevalue" value="100"/>
      </param>
      <param name="debugchance2" type="bool" default="0" advanced="true" text="{1041, 10142}" comment="Verbose debug output">
        <input_param name="truevalue" value="100"/>
      </param>
    </params>
    <requires>
      <match shiptype="shiptype.lasertower" negate="true"/>
      <match class="class.spacesuit" negate="true"/>
    </requires>
  </order>
  <patch sinceversion="1">
    <do_if value="not $range">
      <do_if value="this.sector">
        <set_value name="$range" exact="this.sector"/>
      </do_if>
      <do_elseif value="this.zone.isclass.highway">
        <set_value name="$range" exact="this.zone.destination.sector"/>
      </do_elseif>
      <do_else>
        <debug_text text="'PATCH: failed trying to set $range. ship is neither in a sector nor a highway. parent: %s %s %s'.[@this.assignedcontrolled.parent.knownname, this.assignedcontrolled.parent, this.assignedcontrolled.parent.macro]" filter="error"/>
      </do_else>
      <do_if value="this.assignedcontrolled.defaultorder.id == 'TradeRoutine_Basic'">
        <edit_order_param order="this.assignedcontrolled.defaultorder" param="'range'" value="$range"/>
      </do_if>
    </do_if>
  </patch>
  <attention min="unknown">
    <actions>
      <do_if value="not @$warebasket.count">
        <set_value name="$warebasket" exact="[$warebasket]"/>
      </do_if>
      <do_else>
        <set_value name="$warebasket" exact="[$warebasket.random]"/>
      </do_else>

      <run_script name="'order.trade.routine'">
        <param name="warebasket" value="$warebasket"/>
        <param name="range" value="$range"/>
        <param name="minbuy" value="$minbuy"/>
        <param name="maxbuy" value="$maxbuy"/>
        <param name="minsell" value="$minsell"/>
        <param name="maxsell" value="$maxsell"/>
        <param name="duration" value="$duration"/>
        <param name="tradeforbuildstorage" value="$tradeforbuildstorage"/>
        <param name="usecover" value="$usecover"/>
        <param name="debugchance" value="$debugchance"/>
        <param name="debugchance2" value="$debugchance2"/>
      </run_script>
    </actions>
  </attention>
</aiscript>