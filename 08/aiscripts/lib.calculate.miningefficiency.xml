<?xml version="1.0" encoding="utf-8"?>
<aiscript name="lib.calculate.miningefficiency" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">
  <interrupts>
    <library>
      <!-- assumes variables $evalware and $basescantime
            returns $_result_efficiency and $_result_scantime-->
      <actions name="CalculateMiningEfficiency">
        <set_value name="$_result_efficiency" exact="1.0f"/>
        <set_value name="$_result_scantime" exact="3s"/>
        <do_if value="@$evalware and (typeof $evalware == datatype.ware) and @$basescantime and this.sector">
          <set_value name="$_result_scantime" exact="$basescantime"/>
          <set_value name="$_wareefficiency" exact="[[param.mining.efficiency.{$evalware}, 1.0f].min, 0.001f].max"/>
          <set_value name="$_scantimefactor" exact="1.7f"/>
          <set_value name="$_skillexponent" exact="4"/>
          <!-- 0 to 1.0f -->
          <set_value name="$_skillproportion" exact="0.5f"/>

          <!-- this can only increase efficiency to 1.0 -->
          <do_if value="($_wareefficiency lt 1) and ($_skillproportion gt 0)">
            <find_object name="$_resourceprobe" class="class.resourceprobe" space="this.sector" owner="this.owner">
              <match_distance max="40km" object="this.assignedcontrolled"/>
            </find_object>
            <debug_text text="'wareefficiency: ' + $_wareefficiency" chance="0"/>
            <set_value name="$_result_efficiency" exact="(1.0f - $_wareefficiency) * (([this.assignedcontrolled.combinedskill, 1].max / 100.0f) ^ $_skillexponent)"/>
            <do_if value="not $_resourceprobe.exists">
              <set_value name="$_result_efficiency" exact="$_result_efficiency * $_skillproportion"/>
            </do_if>
            <set_value name="$_result_efficiency" exact="$_result_efficiency + $_wareefficiency"/>
            <debug_text text="'efficiency: %s, skill: %s'.[$_result_efficiency, this.assignedcontrolled.combinedskill]" chance="0"/>
            <set_value name="$_result_scantime" exact="$basescantime * $_scantimefactor / $_result_efficiency"/>
            <debug_text text="'effectivescantime: ' + $_result_scantime" chance="0"/>
          </do_if>
          <remove_value name="$_resourceprobe"/>
          <remove_value name="$_skillproportion"/>
          <remove_value name="$_skillexponent"/>
          <remove_value name="$_scantimefactor"/>
          <remove_value name="$_wareefficiency"/>
        </do_if>
      </actions>
    </library>
  </interrupts>
</aiscript>