<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Terraforming" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="Start" namespace="this" mapeditor="false" version="3">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
        <check_value value="player.galaxy.macro.ismacro.{macro.xu_ep2_universe_macro}" comment="only in main-galaxy"/>
      </conditions>
      <actions>
        <set_value name="$DebugChance"                exact="0"/>
        <set_value name="$DeepDebugChance"            exact="0"     comment="for AI scripts and similar external code"/>
        <create_list name="$MissionCues"/>
        <create_list name="$OfferCues"/>
        <append_to_list name="md.$SubscribedMissionGroups" exact="missiongroup.terraforming"/>
        <create_group groupname="$TerraformingClusters"/>
        <create_group groupname="$XenonTerraformingClusters"/>
        <set_value name="$GlobalWarmingLimitTable" exact="table[]"/>
        <set_value name="$AddedAtmoPressureTable" exact="table[]"/>
        <create_list name="$TrainingProjects"/>
        <append_to_list name="$TrainingProjects" exact="'trn_boarding_group'"/>
        <append_to_list name="$TrainingProjects" exact="'trn_boarding_single'"/>
        <append_to_list name="$TrainingProjects" exact="'trn_pilot_group'"/>
        <append_to_list name="$TrainingProjects" exact="'trn_pilot_single'"/>
        <create_list name="$CompetitionProjects"/>
        <append_to_list name="$CompetitionProjects" exact="'trn_boarding_competition'"/>
        <append_to_list name="$CompetitionProjects" exact="'trn_pilot_competition'"/>
        <do_if value="player.debug">
          <create_list name="$DebugWarpCues"/>
          <create_list name="$DebugSetStatsCues"/>
        </do_if>
        <debug_text text="'Initializing Terraforming Feature'" chance="$DebugChance"/>
      </actions>
      <patch sinceversion="2">
        <clear_list list="$TrainingProjects"/>
        <append_to_list name="$TrainingProjects" exact="'trn_boarding_group'"/>
        <append_to_list name="$TrainingProjects" exact="'trn_boarding_single'"/>
        <append_to_list name="$TrainingProjects" exact="'trn_pilot_group'"/>
        <append_to_list name="$TrainingProjects" exact="'trn_pilot_single'"/>
        <clear_list list="$CompetitionProjects"/>
        <append_to_list name="$CompetitionProjects" exact="'trn_boarding_competition'"/>
        <append_to_list name="$CompetitionProjects" exact="'trn_pilot_competition'"/>
      </patch>
      <patch sinceversion="3">
        <set_value name="$AddedAtmoPressureTable" exact="table[]"/>
        <do_for_each in="$TerraformingClusters" name="$Cluster">
          <set_value name="$AddedAtmoPressureTable.{$Cluster}" exact="($Cluster.terraforming.stat.oxygen.value + $Cluster.terraforming.stat.methane.value + $Cluster.terraforming.stat.carbondioxide.value) / 4"/>
        </do_for_each>
      </patch>
      <cues>

        <cue name="Debug_Skipper" onfail="cancel">
          <conditions>
            <check_value value="player.debug" comment="skipper only in debug builds"/>
          </conditions>
          <actions>
            <set_value name="$MissionCue" exact="this"/>
          </actions>
          <cues>
            <cue name="Debug_SkipperShip">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.Setup.Debug_Setup_SkipperShip_Create"/>
              </actions>
            </cue>

            <cue name="Debug_SkipperShip_Completed">
              <conditions>
                <event_cue_completed cue="md.Setup.Debug_Setup_SkipperShip_Create_Completed"/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="Debug_Skipper_CreateActor"/>
                <signal_cue cue="Debug_Skipper_Spawn"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_CreateActor">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentCheatChapter" exact="null"/>
                <create_cue_actor name="$SkipperActor" cue="$MissionCue" macro="character_teladi_female_generic_01_macro">
                  <owner exact="faction.civilian"/>
                  <name name="'Terraforming Planets Skipper'"/>
                </create_cue_actor>
                <set_entity_type entity="$SkipperActor" type="entitytype.crowd"/>
                <set_entity_traits entity="$SkipperActor" missionactor="true" customhandler="true"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Spawn" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_position name="$SkipperPos" x="10.702m" y="-2.8m" z="7.764m"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = md.Setup.Debug_Setup_SkipperShip.$SkipperShip.controlroom,
                                                                                                                                      $position = $SkipperPos,
                                                                                                                                      $rotation = rotation.[180deg, 0deg, 0deg],
                                                                                                                                      $debugchance = 0,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

              </actions>
            </cue>

            <cue name="Debug_Skipper_Disconnect" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Conversation">
              <conditions>
                <event_cue_completed cue="Debug_Skipper_CreateActor"/>
              </conditions>
              <cues>

                <cue name="Debug_Skipper_Conversation_Start" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$SkipperActor"/>
                  </conditions>
                  <actions>
                    <add_player_choice highlighted="true" section="skipper_main" text="'PLEASE SAVE YOUR GAME'"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$SkipperActor" section="skipper_main"/>
                      <event_conversation_returned_to_section actor="$SkipperActor" section="skipper_main"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="not ware.research_teleportation_range_03.research.unlocked">
                      <add_player_choice_sub section="skipper_basicresearch" text="'Instant Teleport Research 1-4'"/>
                    </do_if>
                    <do_if value="md.X4Ep1_Mentor_Subscriptions.RM_Warp_HQ_Select_Beacon_Selected.state == cuestate.complete">
                      <add_player_choice_sub section="skipper_hqwarpresearch" text="'Add second HQ Warp research'"/>
                    </do_if>
                    <do_if value="not ware.research_warp_hq_01.research.unlocked">
                      <add_player_choice_sub section="skipper_manualresearch" text="'Manual Teleport Research (Adds wares)'"/>
                    </do_if>
                    <do_if value="Debug_Skipper_CheatHQModules.state != cuestate.complete">
                      <add_player_choice_sub section="skipper_hqmodules" text="'Cheat HQ Modules (ShipFab+Trader)'"/>
                    </do_if>
                    <do_if value="Debug_Skipper_CheatHQStorage.state != cuestate.complete">
                      <add_player_choice_sub section="skipper_hqstorage" text="'Cheat HQ Additional Storage'"/>
                    </do_if>
                    <do_if value="$SkipperActiveProject?">
                      <add_player_choice_sub section="skipper_projectwares" text="'Cheat HQ Project-Wares'"/>
                    </do_if>
                    <do_if value="Debug_Skipper_CheatTrainees.state != cuestate.complete">
                      <add_player_choice_sub section="skipper_trainees" text="'Cheat Trainees'"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_HQ_Warp_Research" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_hqwarpresearch"/>
                  </conditions>
                  <actions>
                    <add_encyclopedia_entry type="researchables" item="'research_warp_hq_02'"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_HQ_BasicResearch">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_basicresearch"/>
                  </conditions>
                  <actions>
                    <add_research ware="ware.research_teleportation"/>
                    <add_research ware="ware.research_teleportation_range_01"/>
                    <add_research ware="ware.research_teleportation_range_02"/>
                    <add_research ware="ware.research_teleportation_range_03"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_HQ_ManualResearch">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_manualresearch"/>
                  </conditions>
                  <actions>
                    <!-- Add required resources Teleport Phase 1-->
                    <add_cargo object="$HQ" ware="ware.advancedelectronics" exact="100"/>
                    <add_cargo object="$HQ" ware="ware.energycells" exact="2000"/>
                    <!-- Add required resources Teleport Phase 2-->
                    <add_cargo object="$HQ" ware="ware.advancedelectronics" exact="200"/>
                    <add_cargo object="$HQ" ware="ware.antimatterconverters" exact="300"/>
                    <add_cargo object="$HQ" ware="ware.energycells" exact="5000"/>
                    <!-- Add required resources Teleport Phase 3-->
                    <add_cargo object="$HQ" ware="ware.advancedelectronics" exact="300"/>
                    <add_cargo object="$HQ" ware="ware.energycells" exact="7000"/>
                    <add_cargo object="$HQ" ware="ware.nividium" exact="50"/>
                    <add_cargo object="$HQ" ware="ware.plasmaconductors" exact="750"/>
                    <!-- Add required resources Teleport Phase 4-->
                    <add_cargo object="$HQ" ware="ware.advancedelectronics" exact="1500"/>
                    <add_cargo object="$HQ" ware="ware.energycells" exact="25000"/>
                    <add_cargo object="$HQ" ware="ware.fieldcoils" exact="2500"/>
                    <add_cargo object="$HQ" ware="ware.nividium" exact="2000"/>
                    <add_cargo object="$HQ" ware="ware.superfluidcoolant" exact="7500"/>
                    <!-- Add required resources High Mass Teleportation I -->
                    <add_cargo object="$HQ" ware="ware.advancedelectronics" exact="10000"/>
                    <add_cargo object="$HQ" ware="ware.energycells" exact="12500"/>
                    <add_cargo object="$HQ" ware="ware.fieldcoils" exact="5000"/>
                    <add_cargo object="$HQ" ware="ware.nividium" exact="1000"/>
                    <add_cargo object="$HQ" ware="ware.superfluidcoolant" exact="8000"/>
                    <!-- Add required resources High Mass Teleportation I -->
                    <add_cargo object="$HQ" ware="ware.advancedelectronics" exact="27500"/>
                    <add_cargo object="$HQ" ware="ware.energycells" exact="25000"/>
                    <add_cargo object="$HQ" ware="ware.fieldcoils" exact="30000"/>
                    <add_cargo object="$HQ" ware="ware.nividium" exact="5000"/>
                    <add_cargo object="$HQ" ware="ware.superfluidcoolant" exact="20000"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_CheatHQStorage" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_hqstorage"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Scheduling HQ expansion'"/>
                  </actions>
                  <cues>
                    <cue name="Debug_Skipper_HQ_Extend_Phase1" comment="connections to make sure we don't get stuck">
                      <actions>
                        <create_construction_sequence macros="[
                              macro.struct_tel_cross_01_macro, macro.struct_tel_cross_01_macro,macro.struct_tel_cross_01_macro, macro.struct_tel_cross_01_macro, macro.struct_tel_cross_01_macro, 
                              macro.struct_tel_base_02_macro, macro.struct_tel_base_02_macro, macro.struct_tel_base_02_macro, macro.struct_tel_base_02_macro, macro.struct_tel_base_02_macro,
                            ]" station="$HQ" base="$HQ.plannedconstruction.sequence" comment="async calculation"/>
                      </actions>
                      <cues>
                        <cue name="Debug_Skipper_HQ_Extend_Phase1_Callback">
                          <conditions>
                            <event_object_construction_sequence_created object="$HQ" />
                          </conditions>
                          <actions>
                            <debug_text text="'Expanding HQ'"/>
                            <set_value name="$ConstructionSequence" exact="event.param" />
                            <apply_construction_sequence station="$HQ" sequence="event.param"/>
                            <signal_cue cue="Debug_Skipper_HQ_Extend_Phase2"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Debug_Skipper_HQ_Extend_Phase2" comment="storage">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <create_construction_sequence macros="[
                              macro.storage_tel_l_container_01_macro, macro.storage_tel_l_container_01_macro, macro.storage_tel_l_container_01_macro, macro.storage_tel_l_container_01_macro, 
                              macro.storage_tel_l_liquid_01_macro, macro.storage_tel_l_liquid_01_macro, macro.storage_tel_l_liquid_01_macro, macro.storage_tel_l_liquid_01_macro, 
                              macro.storage_tel_l_solid_01_macro, macro.storage_tel_l_solid_01_macro, macro.storage_tel_l_solid_01_macro, macro.storage_tel_l_solid_01_macro, 
                              macro.storage_tel_l_container_01_macro, macro.storage_tel_l_container_01_macro, macro.storage_tel_l_container_01_macro, macro.storage_tel_l_container_01_macro, 
                              macro.storage_tel_l_liquid_01_macro, macro.storage_tel_l_liquid_01_macro, macro.storage_tel_l_liquid_01_macro, macro.storage_tel_l_liquid_01_macro, 
                              macro.storage_tel_l_solid_01_macro, macro.storage_tel_l_solid_01_macro, macro.storage_tel_l_solid_01_macro, macro.storage_tel_l_solid_01_macro, 
                              macro.storage_tel_l_container_01_macro, macro.storage_tel_l_container_01_macro, macro.storage_tel_l_container_01_macro, macro.storage_tel_l_container_01_macro, 
                              macro.storage_tel_l_liquid_01_macro, macro.storage_tel_l_liquid_01_macro, macro.storage_tel_l_liquid_01_macro, macro.storage_tel_l_liquid_01_macro, 
                              macro.storage_tel_l_solid_01_macro, macro.storage_tel_l_solid_01_macro, macro.storage_tel_l_solid_01_macro, macro.storage_tel_l_solid_01_macro, 
                              ]" station="$HQ" base="$HQ.plannedconstruction.sequence" comment="async calculation"/>
                      </actions>
                      <cues>
                        <cue name="Debug_Skipper_HQ_Extend_Phase2_Callback">
                          <conditions>
                            <event_object_construction_sequence_created object="$HQ" />
                          </conditions>
                          <actions>
                            <set_value name="$ConstructionSequence" exact="event.param" />
                            <apply_construction_sequence station="$HQ" sequence="$ConstructionSequence"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Debug_Skipper_CheatHQModules">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_hqmodules"/>
                  </conditions>
                  <actions>
                    <create_construction_sequence macros="[
                          macro.storage_arg_l_container_01_macro, macro.storage_arg_l_liquid_01_macro, macro.storage_arg_l_solid_01_macro, 
                          macro.buildmodule_gen_ships_m_dockarea_01_macro, macro.buildmodule_gen_ships_m_dockarea_01_macro, macro.buildmodule_gen_ships_m_dockarea_01_macro, macro.buildmodule_gen_ships_m_dockarea_01_macro, macro.buildmodule_gen_ships_m_dockarea_01_macro]" station="$HQ" base="$HQ.constructionsequence">
                      <immediate result="$sequence"/>
                    </create_construction_sequence>
                    <apply_construction_sequence station="$HQ" sequence="$sequence"/>
                    <remove_value name="$sequence"/>
                    <create_cue_actor cue="this" name="$shiptrader">
                      <select faction="faction.argon" tags="tag.shiptrader"/>
                      <owner exact="faction.player" />
                    </create_cue_actor>
                    <assign_control_entity actor="$shiptrader" object="$HQ" post="controlpost.shiptrader" transfer="true"/>
                    <remove_value name="$shiptrader"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_CheatTrainees">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$SkipperActor" section="skipper_trainees"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_all exact="10">
                      <get_character_definition macro="$Macro" faction="faction.argon" tags="tag.pilot"/>
                      <create_npc_template name="$Crew" object="$HQ" macro="$Macro" role="entityrole.trainee_group"/>
                      <do_if value="$Crew">
                        <set_skill object="$HQ" template="$Crew" type="skilltype.boarding" min="0" max="9"/>
                        <set_skill object="$HQ" template="$Crew" type="skilltype.engineering" min="0" max="9"/>
                        <set_skill object="$HQ" template="$Crew" type="skilltype.management" min="0" max="9"/>
                        <set_skill object="$HQ" template="$Crew" type="skilltype.piloting" min="0" max="9"/>
                        <set_skill object="$HQ" template="$Crew" type="skilltype.morale" min="0" max="9"/>
                      </do_if>
                    </do_all>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_CheatProjectWares" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$SkipperActor" section="skipper_projectwares"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <!-- example: $HQ.cluster.terraforming.project.pwr_antimatter.resources.count and $HQ.cluster.terraforming.project.pwr_antimatter.resources.{ $HQ.cluster.terraforming.project.pwr_antimatter.resources.{1} }.count -->
                    <do_if value="$SkipperActiveProject?" comment="additional check, in case of the cue being forced without terraforming project active">
                      <do_all exact="$HQ.cluster.terraforming.project.{$SkipperActiveProject}.resources.count" counter="$i">
                        <set_value name="$ware" exact="$HQ.cluster.terraforming.project.{$SkipperActiveProject}.resources.{$i}"/>
                        <set_value name="$amount" exact="$HQ.cluster.terraforming.project.{$SkipperActiveProject}.resources.{$ware}.count"/>
                        <add_cargo object="$HQ" ware="$ware" exact="$amount" result="$added"/>
                        <debug_text text="'Added %s #%s'.[$ware.name, $amount]"/>
                      </do_all>
                    </do_if>
                    <do_else>
                      <debug_text text="'Ignoring, no terraforming project active!'"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Terraforming_Skipper_Project_StartedProduction" instantiate="true">
                  <conditions>
                    <event_terraforming_project_started_production group="$TerraformingClusters" comment="wares need to be delivered"/>
                  </conditions>
                  <actions>
                    <set_value name="$SkipperActiveProject" exact="event.param"/>
                    <debug_text text="'Terraforming started production: ' + event.param"/>
                    <!--debug_text text="'count=' + $HQ.cluster.terraforming.project.{event.param}.resources.count"/>
                    <do_all exact="$HQ.cluster.terraforming.project.{event.param}.resources.count" counter="$i">
                      <set_value name="$ware" exact="$HQ.cluster.terraforming.project.{event.param}.resources.{$i}"/>
                      <debug_text text="'Ware %s #%s'.[$ware.name, $HQ.cluster.terraforming.project.{event.param}.resources.{$ware}.count]"/>
                    </do_all-->
                  </actions>
                </cue>

                <cue name="Terraforming_Skipper_Project_Finished" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_terraforming_project_succeeded group="$TerraformingClusters"/>
                      <event_terraforming_project_failed group="$TerraformingClusters"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <remove_value name="$SkipperActiveProject"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_HQ_DrainStorage" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.Drain_Stations.DrainStationAll">
                      <param name="Station"     value="$HQ"/>
                      <param name="TradeWares"  value="$HQ.cargo.list"/>
                      <param name="DebugChance" value="100"/>
                    </run_actions>
                  </actions>
                </cue>

              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="DEBUG_Terraforming_Screenshot_All">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$DebugClusters" exact="$TerraformingClusters"/>
          </actions>
          <cues>
            <cue name="DEBUG_Terraforming_Warp_To_Next">
              <actions>
                <signal_cue cue="$DebugWarpCues.{1}"/>
              </actions>
              <!--let everything load-->
              <delay exact="4s"/>
              <actions>
                <capture_screen directory="'terraforming'"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="$DebugSetStatsCues.{1}"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <capture_screen directory="'terraforming'"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <set_terraforming_stat cluster="$DebugClusters.{1}" id="'population'" value="10000000000L"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <capture_screen directory="'terraforming'"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <remove_from_group group="$DebugClusters" object="$DebugClusters.{1}"/>
                <remove_value name="$DebugWarpCues.{1}"/>
                <remove_value name="$DebugSetStatsCues.{1}"/>
                <do_if value="$DebugClusters.count gt 0">
                  <reset_cue cue="this"/>
                </do_if>
              </actions>
            </cue>
          </cues>
        </cue>

        <library name="DEBUG_Terraforming_WarpPlayerShip" purpose="run_actions">
          <params>
            <param name="Cluster"/>
          </params>
          <actions>
            <find_sector name="$Sectors" space="$Cluster" multiple="true"/>
            <do_if value="$Sectors.count == 1">
              <set_value name="$Sector" exact="$Sectors.{1}"/>
            </do_if>
            <do_else>
              <do_for_each in="$Sectors" name="$TestSector">
                <set_value name="$TestPlanetDistance" exact="$Cluster.terraforming.planetposition.{$TestSector}.distanceto.{position.[0,0,0]}"/>
                <do_if value="not $PlanetDistance? or $TestPlanetDistance lt $PlanetDistance">
                  <set_value name="$Sector" exact="$TestSector"/>
                  <set_value name="$PlanetDistance" exact="$TestPlanetDistance"/>
                </do_if>
              </do_for_each>
            </do_else>
            <get_safe_pos result="$WarpPosition" sector="$Sector" radius="10km"/>
            <create_orientation name="$WarpRotation" orientation="look_at" refposition="$Cluster.terraforming.planetposition.{$Sector}">
              <position value="$WarpPosition"/>
            </create_orientation>
            <warp object="player.ship" sector="$Sector">
              <position value="$WarpPosition"/>
              <rotation value="$WarpRotation"/>
            </warp>
          </actions>
        </library>

        <cue name="Signal_Terraforming_Cues" version="1">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!--For now we activate all missions by default-->
            <signal_cue cue="Terraforming_ScalePlateGreen"/>
            <signal_cue cue="Terraforming_BlackHoleSun"/>
            <signal_cue cue="Terraforming_GetsuFune"/>
            <signal_cue cue="Terraforming_FrontierEdge"/>
            <signal_cue cue="Terraforming_AtiyasMisfortune"/>
            <signal_cue cue="Terraforming_18Billion"/>
            <signal_cue cue="Terraforming_MemoryOfProfit"/>
            <!--<signal_cue cue="Terraforming_Xenon_TharkasCascade"/>-->
          </actions>

          <patch sinceversion="1">
            <do_for_each in="$TerraformingClusters" name="$Cluster">
              <do_if value="$Cluster.terraforming.stat.airpressure.exists">
                <add_terraforming_project cluster="$Cluster" id="'atm_nitrogen_fix'">
                  <predecessors>
                    <predecessor id="'agr_fertilize'"/>
                  </predecessors>
                </add_terraforming_project>
                <add_terraforming_project cluster="$Cluster" id="'atm_helium_import'" />
              </do_if>
            </do_for_each>
          </patch>
        </cue>

        <!--Add drone blueprints when the missions are activated.
        DLC drones must be added in their own cue with the following conditions and Patch_ cue-->
        <cue name="Add_Drone_Blueprints_Base">
          <conditions>
            <check_any>
              <event_cue_completed cue="Signal_Terraforming_Cues"/>
              <event_cue_signalled/>
            </check_any>
          </conditions>
          <actions>
            <add_blueprints macros="[macro.ship_gen_m_transdrone_container_01_a_macro, macro.ship_gen_s_transdrone_container_01_a_macro]"/>
            <debug_text text="'Adding base game terraforming drone blueprints'" filter="savegame" chance="if event.name == 'event_cue_signalled' then 100 else 0"/>
          </actions>
        </cue>

        <cue name="Patch_Add_Drone_Blueprints_Base">
          <actions>
            <do_if value="Signal_Terraforming_Cues.state == cuestate.complete">
              <signal_cue cue="Add_Drone_Blueprints_Base"/>
            </do_if>
          </actions>
        </cue>

        <cue name="Patch_18Billion_AirPressure">
          <actions>
            <do_if value="$Cluster_18Billion?">
              <set_terraforming_stat cluster="$Cluster_18Billion" id="'airpressure'" value="$Cluster_18Billion.terraforming.stat.airpressure.value + 1"/>
            </do_if>
          </actions>
        </cue>

        <cue name="Patch_Frontier_Edge_AirPressure">
          <actions>
            <do_if value="$Cluster_FrontierEdge?">
              <set_terraforming_stat cluster="$Cluster_FrontierEdge" id="'airpressure'" value="$Cluster_FrontierEdge.terraforming.stat.airpressure.value - 1"/>
            </do_if>
          </actions>
        </cue>
        
        <!--Note: it's generally better to put patch code into <patch> nodes because those don't run when the cue gets initialized. Separate cues only make sense if they have to wait for a newly added cue to be enabled, e.g. to send an event to it.-->

        <cue name="Offer_Manager">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="1ms"/>
          <actions>
            <signal_cue cue="Refresh_Offers"/>
          </actions>
          <cues>
            <cue name="TerraformingOfferAccepted" instantiate="true">
              <conditions>
                <event_object_signalled object="$BosoTa" param="'accept'"/>
              </conditions>
              <actions>
                <debug_text text="'Terraforming mission offer accepted: ' + event.param2" chance="$DebugChance"/>
                <signal_cue cue="event.param2"/>
              </actions>
            </cue>
            <cue name="Refresh_Offers" instantiate="true" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Refreshing mission offers'" chance="$DebugChance"/>
                <do_for_each in="$OfferCues" name="$OfferCue">
                  <do_if value="$OfferCue != @$AcceptedOfferCue">
                    <debug_text text="'Signalling ' + $OfferCue" chance="$DebugChance"/>
                    <signal_cue cue="$OfferCue" check="false"/>
                  </do_if>
                  <do_else>
                    <debug_text text="$OfferCue + ' is accepted, skipping'" chance="$DebugChance"/>
                  </do_else>
                </do_for_each>
              </actions>
              <patch sinceversion="2">
                <signal_cue cue="Refresh_Offers" comment="reset Offers"/>
              </patch>
            </cue>
          </cues>
        </cue>

        <cue name="Boso_Intro">
          <cues>
            <cue name="Activate_Immediately" onfail="cancel">
              <conditions>
                <check_value value="md.X4Ep1_Mentor_Subscriptions.UnlockResearch.state == cuestate.complete"/>
              </conditions>
              <actions>
                <cancel_cue cue="Check_For_Scientific_Mentor_Ending"/>
                <signal_cue cue="Wait_For_HQ_Warp"/>
              </actions>
            </cue>

            <cue name="Check_For_Scientific_Mentor_Ending">
              <conditions>
                <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.UnlockResearch"/>
              </conditions>
              <actions>
                <signal_cue cue="Wait_For_HQ_Warp"/>
              </actions>
            </cue>

            <cue name="Wait_For_HQ_Warp">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
              </actions>
              <cues>
                <cue name="HQ_WarpCheck" checkinterval="20s">
                  <conditions>
                    <check_value value="player.encyclopedia.researchables.{'research_warp_hq_02'}.exists"/>
                  </conditions>
                  <!--If the research was added via a gamestart, delay the call-->
                  <delay exact="if @md.X4Ep1_Mentor_Subscriptions.Start.$LastHQWarpTime then 3min else 10min"/>
                  <actions>
                    <do_if value="Boso_Call.state == cuestate.waiting">
                      <signal_cue cue="Boso_Call"/>
                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Boso_Call">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Terraforming_Boso_Intro_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="Cutscene"          value="$BosoTa.room != player.room"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
                  <param name="Lines"             value="[[30500024]]"/>
                  <param name="IsInMission"       value="false"/>
                </cue>

                <cue name="Boso_Reminder">
                  <delay exact="30min"/>
                  <cues>
                    <cue name="Boso_Reminder_Delay_wait">
                      <conditions>
                        <event_cue_completed cue="Boso_Reminder"/>
                      </conditions>
                      <cues>
                        <cue name="Terraforming_Boso_Reminder_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="Cutscene"          value="$BosoTa.room != player.room"/>
                          <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
                          <param name="Lines"             value="[[30500025]]"/>
                          <param name="IsInMission"       value="false"/>
                          <param name="EndSignalCue"      value="Terraforming_Boso_Reminder_SpeakFinished"/>
                        </cue>

                        <cue name="Terraforming_Boso_Reminder_SpeakFinished">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <reset_cue cue="Boso_Reminder"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Boso_Conversation_Start" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$BosoTa"/>
                    <check_value value="$BosoTa.room == player.entity.room"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$BosoTa" line="30500026" comment="Are you here for my proposal?"/>
                    <add_player_choice text="{30500,10001}" position="top_right" section="boso_terraforming_intro" choiceparam="'start'"/>
                    <do_if value="player.debug">
                      <add_player_choice text="'[Skip Terraforming conversation]'" position="right" section="boso_terraforming_intro" choiceparam="'skip'"/>
                    </do_if>
                    <add_player_choice_return text="{1002,3009}" position="bottom_right" comment="Never mind"/>
                  </actions>
                </cue>

                <cue name="Boso_Explanation" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$BosoTa" section="boso_terraforming_intro"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Boso_Reminder"/>
                    <cancel_cue cue="Boso_Conversation_Start"/>
                    <allow_conversation_escape enabled="false"/>
                    <debug_text text="'Boso_Explanation ' + event.param + ' ' + event.param2"/>
                    <do_if value="event.param2 == 'start'">
                      <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500027" comment="Very well. Now that we have the ability to relocate this station I have been thinking about the opportunities that being in another location would open up. And what I have come up with is..."/>
                      <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500028" delay="0.2s" comment="Wait for it..."/>
                      <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500029" delay="1s" comment="Terraforming!"/>
                      <add_player_choice text="{30500,10002}" position="top_right" section="boso_terraforming_intro" choiceparam="'continue_terraforming'"/>
                      <add_player_choice text="{30500,10003}" position="right" section="boso_terraforming_intro" choiceparam="'continue_terraforming'"/>
                      <add_player_choice text="{30500,10004}" position="bottom_right" section="boso_terraforming_intro" choiceparam="'continue_terraforming'"/>
                    </do_if>
                    <do_elseif value="event.param2 == 'continue_terraforming'">
                      <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500030" comment="A Terran loan word... obviously, I suppose. It is the process of transforming a world's environment to more closely match the narrow parameters that complex life requires."/>
                      <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500031" comment="The effort and materials required truly boggle even my mind, but they are necessary if we intend to bring a new and welcoming equilibrium to a currently inhospitable world."/>
                      <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500032" comment="This station's technology, combined with a mind as sophisticated as mine, contains truly remarkable depths of potential which we have not yet plumbed."/>
                      <find_object_component name="$WharfModule" object="$HQ" class="class.buildmodule">
                        <match_any>
                          <match canbuildclass="class.ship_m"/>
                          <match canbuildclass="class.ship_s"/>
                        </match_any>
                      </find_object_component>
                      <do_if value="$HQ.cargo.capacity.solid gt 0 and $HQ.cargo.capacity.liquid gt 0 and $HQ.cargo.capacity.container gt 0 and $WharfModule.exists">
                        <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500033" comment="We appear to have all the modules that we require, but do not ask me if they're enough, logistics bore me so much!"/>
                      </do_if>
                      <do_else>
                        <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500034" comment="Still, we will need to extend this station in order to produce the required technology. Your mission interface will have the details."/>
                      </do_else>
                      <remove_value name="$WharfModule"/>
                      <add_player_choice text="{30500,10005}" position="top_right" section="boso_terraforming_intro" choiceparam="'continue_profit'"/>
                      <add_player_choice text="{30500,10006}" position="bottom_right" section="boso_terraforming_intro" choiceparam="'continue_profit'"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'continue_profit'">
                      <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500035" comment="Now, before you ask, do not expect this to turn a profit! Even if you do end up developing a strong economy, any possible returns will absolutely be dwarfed by our expenditures."/>
                      <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500036" comment="But is profit really more important than leaving a lasting positive mark on history?"/>
                      <add_player_choice text="{30500,10007}" position="top_right" section="boso_terraforming_intro" choiceparam="'continue_profit_agree'"/>
                      <add_player_choice text="{30500,10008}" position="bottom_right" section="boso_terraforming_intro" choiceparam="'continue_profit_disagree'"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'skip'">
                      <signal_cue cue="DEBUG_CheatHQModules"/>
                      <signal_cue cue="Signal_Terraforming_Cues"/>
                      <signal_cue cue="Offer_Manager"/>
                      <cancel_cue cue="this"/>
                    </do_elseif>
                    <do_else>
                      <do_if value="event.param2 == 'continue_profit_agree'">
                        <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500037" comment="Of course it isn't!"/>
                      </do_if>
                      <do_elseif value="event.param2 == 'continue_profit_disagree'">
                        <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500038" comment="It was supposed to be a rhetorical question..."/>
                      </do_elseif>
                      <add_npc_line speaker="$BosoTa" hidechoices="true" line="30500039" comment="I have taken the liberty of looking into specific opportunities and adding them to your list of mission offers. Peruse them at your leisure, and simply accept the one that most strikes your fancy!"/>
                      <signal_cue cue="Signal_Terraforming_Cues"/>
                      <signal_cue cue="Offer_Manager"/>
                      <cancel_cue cue="this"/>
                    </do_else>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <library name="SetupGeneralProjects" purpose="run_actions">
          <params>
            <param name="Cluster"/>
            <param name="EnergyProject" default="'pwr_antimatter'" comment="Alternatives: pwr_geothermal, pwr_wind"/>
            <param name="PilotTrainingCourseProject" default="'trn_pilot'" comment="Alternatives: trn_pilot_canyons"/>
            <param name="Biosphere" default="true"/>
            <param name="GlobalWarmingLimit" default="null"/>
          </params>
          <actions>
            <run_actions ref="SetupStatDependentProjects">
              <param name="Cluster" value="$Cluster"/>
              <param name="GlobalWarmingLimit" value="$GlobalWarmingLimit"/>
            </run_actions>
            <run_actions ref="SetupGeneralProjects_Industrial">
              <param name="Cluster" value="$Cluster"/>
              <param name="EnergyProject" value="$EnergyProject"/>
            </run_actions>
            <do_if value="$Biosphere">
              <run_actions ref="SetupGeneralProjects_Biosphere">
                <param name="Cluster" value="$Cluster"/>
              </run_actions>
            </do_if>
            <run_actions ref="SetupGeneralProjects_Agriculture">
              <param name="Cluster" value="$Cluster"/>
            </run_actions>
            <run_actions ref="SetupGeneralProjects_Amenities">
              <param name="Cluster" value="$Cluster"/>
            </run_actions>
            <run_actions ref="SetupGeneralProjects_Residential">
              <param name="Cluster" value="$Cluster"/>
            </run_actions>
            <run_actions ref="SetupGeneralProjects_Training">
              <param name="Cluster" value="$Cluster"/>
              <param name="PilotTrainingCourseProject" value="$PilotTrainingCourseProject"/>
            </run_actions>
            <run_actions ref="SetupGeneralProjects_Economy">
              <param name="Cluster" value="$Cluster"/>
            </run_actions>
          </actions>
        </library>

        <library name="SetupGeneralProjects_Industrial" purpose="run_actions">
          <params>
            <param name="Cluster"/>
            <param name="EnergyProject" default="'pwr_antimatter'" comment="Alternatives: pwr_geothermal, pwr_wind"/>
          </params>
          <actions>
            <add_terraforming_project cluster="$Cluster" id="$EnergyProject"/>
            <add_terraforming_project cluster="$Cluster" id="'ind_refineries_clean'">
              <predecessors>
                <predecessor group="'power'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'ind_refineries_cheap'">
              <predecessors>
                <predecessor group="'power'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'ind_factories'">
              <predecessors any="true">
                <predecessor id="'ind_refineries_cheap'"/>
                <predecessor id="'ind_refineries_clean'"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </library>

        <library name="SetupGeneralProjects_Water" purpose="run_actions">
          <params>
            <param name="Cluster"/>
          </params>
          <actions>
            <add_terraforming_project cluster="$Cluster" id="'wat_import'"/>
            <add_terraforming_project cluster="$Cluster" id="'wat_irrigation'"/>
          </actions>
        </library>

        <library name="SetupGeneralProjects_Biosphere" purpose="run_actions">
          <params>
            <param name="Cluster"/>
          </params>
          <actions>
            <add_terraforming_project cluster="$Cluster" id="'bio_tailored'"/>
            <add_terraforming_project cluster="$Cluster" id="'bio_jumpstart'"/>
            <add_terraforming_project cluster="$Cluster" id="'agr_fertilize'">
              <predecessors any="true">
                <predecessor id="'bio_tailored'"/>
                <predecessor id="'bio_jumpstart'"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </library>

        <library name="SetupGeneralProjects_Agriculture" purpose="run_actions">
          <params>
            <param name="Cluster"/>
          </params>
          <actions>
            <add_terraforming_project cluster="$Cluster" id="'agr_hydroponics'"/>
            <add_terraforming_project cluster="$Cluster" id="'agr_forestation'">
              <predecessors>
                <predecessor id="'agr_fertilize'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'agr_fields_wheat'">
              <predecessors>
                <predecessor id="'agr_fertilize'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'agr_fields_sunrise'">
              <predecessors>
                <predecessor id="'agr_fertilize'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'agr_fields_soja'">
              <predecessors>
                <predecessor id="'agr_fertilize'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'agr_fields_spices'">
              <predecessors>
                <predecessor id="'agr_fertilize'"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </library>

        <library name="SetupGeneralProjects_Amenities" purpose="run_actions">
          <params>
            <param name="Cluster"/>
          </params>
          <actions>
            <add_terraforming_project cluster="$Cluster" id="'ame_themepark'">
              <predecessors>
                <predecessor group="'power'"/>
                <predecessor group="'food_staple'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'ame_venues'">
              <predecessors>
                <predecessor group="'power'"/>
                <predecessor group="'food_staple'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'ame_temple'">
              <predecessors>
                <predecessor group="'power'"/>
                <predecessor group="'food_staple'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'ame_finedining'">
              <predecessors>
                <predecessor group="'power'"/>
                <predecessor group="'food_staple'"/>
                <predecessor group="'food_fine'"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </library>

        <library name="SetupGeneralProjects_Residential" purpose="run_actions">
          <params>
            <param name="Cluster"/>
          </params>
          <actions>
            <add_terraforming_project cluster="$Cluster" id="'res_bubblecity'">
              <predecessors>
                <predecessor group="'power'"/>
                <predecessor group="'food_staple'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'res_habmodule'">
              <predecessors>
                <predecessor group="'power'"/>
                <predecessor group="'food_staple'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'res_housing_dense'">
              <predecessors>
                <predecessor group="'power'"/>
                <predecessor group="'food_staple'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'res_arcology'">
              <predecessors>
                <predecessor group="'power'"/>
                <predecessor group="'food_staple'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'res_housing_luxury'">
              <predecessors>
                <predecessor group="'power'"/>
                <predecessor group="'food_staple'"/>
                <predecessor group="'amenities'"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </library>

        <library name="SetupGeneralProjects_Training" purpose="run_actions">
          <params>
            <param name="Cluster"/>
            <param name="PilotTrainingCourseProject" default="'trn_pilot'" comment="Alternatives: trn_pilot_canyons"/>
          </params>
          <actions>
            <!--Marine training-->
            <add_terraforming_project cluster="$Cluster" id="'trn_boarding'"/>
            <add_terraforming_project cluster="$Cluster" id="'trn_boarding_group'">
              <predecessors>
                <predecessor id="'trn_boarding'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'trn_boarding_single'">
              <predecessors>
                <predecessor id="'trn_boarding'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'trn_boarding_competition'">
              <predecessors>
                <predecessor id="'trn_boarding'"/>
              </predecessors>
            </add_terraforming_project>
            <!--Pilot training-->
            <add_terraforming_project cluster="$Cluster" id="$PilotTrainingCourseProject"/>
            <add_terraforming_project cluster="$Cluster" id="'trn_pilot_group'">
              <predecessors>
                <predecessor id="$PilotTrainingCourseProject"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'trn_pilot_single'">
              <predecessors>
                <predecessor id="$PilotTrainingCourseProject"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'trn_pilot_competition'">
              <predecessors>
                <predecessor id="$PilotTrainingCourseProject"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </library>

        <library name="SetupGeneralProjects_Economy" purpose="run_actions">
          <params>
            <param name="Cluster"/>
          </params>
          <actions>
            <add_terraforming_project cluster="$Cluster" id="'eco_clinic'"/>
            <add_terraforming_project cluster="$Cluster" id="'eco_clinic_supply'">
              <predecessors>
                <predecessor id="'eco_clinic'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'eco_campus'"/>
            <add_terraforming_project cluster="$Cluster" id="'eco_campus_supply'">
              <predecessors>
                <predecessor id="'eco_campus'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'eco_bank'"/>
            <add_terraforming_project cluster="$Cluster" id="'eco_bank_supply'">
              <predecessors>
                <predecessor id="'eco_bank'"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </library>

        <library name="SetupStatDependentProjects" purpose="run_actions">
          <params>
            <param name="Cluster"/>
            <param name="GlobalWarmingLimit"/>
            <param name="IgnoreTemperature" default="false"/>
            <param name="IgnoreOxygen" default="false"/>
            <param name="IgnoreMethane" default="false"/>
            <param name="IgnoreCarbonDioxide" default="false"/>
            <param name="IgnoreToxicity" default="false"/>
            <param name="IgnoreRadioactivity" default="false"/>
            <param name="IgnoreHumidity" default="false"/>
            <param name="IgnoreAirPressure" default="false"/>
          </params>
          <actions>
            <debug_text text="'SetupStatDependentProjects for cluster ' + $Cluster.knownname"/>
            <debug_text text="'temperature value: ' + $Cluster.terraforming.stat.temperature.value"/>
            <do_if value="not $IgnoreTemperature">
              <run_actions ref="TemperatureProjectsHelper">
                <param name="Cluster" value="$Cluster"/>
              </run_actions>
            </do_if>
            <do_if value="not $IgnoreOxygen and $Cluster.terraforming.stat.oxygen.value lt 4">
              <add_terraforming_project cluster="$Cluster" id="'bio_cyanobacteria'">
                <predecessors any="true">
                  <predecessor id="'bio_tailored'"/>
                  <predecessor id="'bio_jumpstart'"/>
                </predecessors>
              </add_terraforming_project>
            </do_if>
            <do_if value="not $IgnoreMethane and $Cluster.terraforming.stat.methane.value gt 0">
              <run_actions ref="SetupStatProjectsAndEvents_Methane">
                <param name="Cluster" value="$Cluster"/>
                <param name="GlobalWarmingLimit" value="$GlobalWarmingLimit"/>
              </run_actions>
            </do_if>
            <do_if value="not $IgnoreCarbonDioxide and $Cluster.terraforming.stat.carbondioxide.value gt 0">
              <run_actions ref="SetupStatProjectsAndEvents_CO2">
                <param name="Cluster" value="$Cluster"/>
                <param name="GlobalWarmingLimit" value="$GlobalWarmingLimit"/>
              </run_actions>
            </do_if>
            <do_if value="not $IgnoreToxicity and $Cluster.terraforming.stat.toxicity.value gt 0">
              <add_terraforming_project cluster="$Cluster" id="'atm_toxin_cleanup'">
                <predecessors>
                  <predecessor group="'src_toxicity'" any="false"/>
                </predecessors>
              </add_terraforming_project>
            </do_if>
            <do_if value="not $IgnoreRadioactivity and $Cluster.terraforming.stat.radioactivity.value gt 0">
              <add_terraforming_project cluster="$Cluster" id="'ter_radioactive_cleanup'"/>
            </do_if>
            <do_if value="not $IgnoreHumidity and $Cluster.terraforming.stat.humidity.value lt 6">
              <run_actions ref="SetupGeneralProjects_Water">
                <param name="Cluster" value="$Cluster"/>
              </run_actions>
            </do_if>
            <do_if value="not $IgnoreAirPressure and $Cluster.terraforming.stat.airpressure.exists">
              <add_terraforming_project cluster="$Cluster" id="'atm_nitrogen_fix'">
                <predecessors>
                  <predecessor id="'agr_fertilize'"/>
                </predecessors>
              </add_terraforming_project>
              <add_terraforming_project cluster="$Cluster" id="'atm_helium_import'" />
            </do_if>
          </actions>
        </library>

        <library name="SetupStatProjectsAndEvents_Methane" purpose="run_actions">
          <params>
            <param name="Cluster"/>
            <param name="GlobalWarmingLimit"/>
          </params>
          <actions>
            <add_terraforming_project cluster="$Cluster" id="'atm_methane_oxidizers'">
              <predecessors>
                <predecessor group="'power'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'atm_methane_oxidize'">
              <predecessors>
                <predecessor id="'atm_methane_oxidizers'"/>
              </predecessors>
            </add_terraforming_project>
            <do_if value="$GlobalWarmingLimit?">
              <add_terraforming_event cluster="$Cluster" id="'evt_globalwarming_methane'">
                <conditions>
                  <condition stat="'methane'" min="1" />
                  <condition stat="'temperature'" maxvalue="$GlobalWarmingLimit - 1" />
                </conditions>
              </add_terraforming_event>
            </do_if>
            <do_else>
              <add_terraforming_event cluster="$Cluster" id="'evt_globalwarming_methane'"/>
            </do_else>
          </actions>
        </library>

        <library name="SetupStatProjectsAndEvents_CO2" purpose="run_actions">
          <params>
            <param name="Cluster"/>
            <param name="GlobalWarmingLimit"/>
          </params>
          <actions>
            <add_terraforming_project cluster="$Cluster" id="'atm_carbon_mineralizers'">
              <predecessors>
                <predecessor group="'power'"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project cluster="$Cluster" id="'atm_carbon_mineralize'">
              <predecessors>
                <predecessor id="'atm_carbon_mineralizers'"/>
              </predecessors>
            </add_terraforming_project>
            <do_if value="$GlobalWarmingLimit?">
              <add_terraforming_event cluster="$Cluster" id="'evt_globalwarming_co2'">
                <conditions>
                  <condition stat="'carbondioxide'" min="1" />
                  <condition stat="'methane'" max="0" />
                  <condition stat="'temperature'" maxvalue="$GlobalWarmingLimit - 1" />
                </conditions>
              </add_terraforming_event>
            </do_if>
            <do_else>
              <add_terraforming_event cluster="$Cluster" id="'evt_globalwarming_co2'"/>
            </do_else>
          </actions>
        </library>

        <!--General handlers for stat changes-->

        <cue name="StatChanged_AnyAtmosphere" instantiate="true">
          <conditions>
            <check_any>
              <event_terraforming_stat_changed group="$TerraformingClusters" stat="'oxygen'"/>
              <event_terraforming_stat_changed group="$TerraformingClusters" stat="'methane'"/>
              <event_terraforming_stat_changed group="$TerraformingClusters" stat="'carbondioxide'"/>
            </check_any>
            <check_value value="event.object.terraforming.stat.airpressure.exists"/>
          </conditions>
          <actions>
            <!--every full 4 "squares" of gases increase the air pressure by one-->
            <set_value name="$AddedAirPressure" exact="(event.object.terraforming.stat.oxygen.value + event.object.terraforming.stat.methane.value + event.object.terraforming.stat.carbondioxide.value) / 4"/>
            <do_if value="$AddedAirPressure != $AddedAtmoPressureTable.{event.object}">
              <set_terraforming_stat cluster="event.object" id="'airpressure'" value="event.object.terraforming.stat.airpressure.value + $AddedAirPressure - $AddedAtmoPressureTable.{event.object}"/>
              <set_value name="$AddedAtmoPressureTable.{event.object}" exact="$AddedAirPressure"/>
            </do_if>
          </actions>
        </cue>

        <cue name="StatAdded_Methane" instantiate="true">
          <conditions>
            <event_terraforming_stat_added group="$TerraformingClusters" stat="'methane'"/>
          </conditions>
          <actions>
            <debug_text text="'Methane stat became relevant, adding projects to clean it up'" chance="$DebugChance"/>
            <run_actions ref="SetupStatProjectsAndEvents_Methane">
              <param name="Cluster" value="event.object"/>
              <param name="GlobalWarmingLimit" value="if $GlobalWarmingLimitTable.{event.object}? then $GlobalWarmingLimitTable.{event.object} else null"/>
            </run_actions>
          </actions>
        </cue>
        <cue name="StatRemoved_Methane" instantiate="true">
          <conditions>
            <event_terraforming_stat_removed group="$TerraformingClusters" stat="'methane'"/>
          </conditions>
          <actions>
            <do_if value="not event.object.terraforming.project.atm_methane_oxidizers.complete">
              <debug_text text="'Methane stat became irrelevant, removing projects to clean it up'" chance="$DebugChance"/>
              <remove_terraforming_project cluster="event.object" id="'atm_methane_oxidize'"/>
              <remove_terraforming_project cluster="event.object" id="'atm_methane_oxidizers'"/>
              <remove_terraforming_event cluster="event.object" id="'evt_globalwarming_methane'"/>
            </do_if>
            <do_else>
              <debug_text text="'Methane stat became irrelevant but clean-up project was already completed - leaving it in'" chance="$DebugChance"/>
            </do_else>
          </actions>
        </cue>

        <cue name="StatAdded_CO2" instantiate="true">
          <conditions>
            <event_terraforming_stat_added group="$TerraformingClusters" stat="'carbondioxide'"/>
          </conditions>
          <actions>
            <debug_text text="'CO2 stat became relevant, adding projects to clean it up'" chance="$DebugChance"/>
            <run_actions ref="SetupStatProjectsAndEvents_CO2">
              <param name="Cluster" value="event.object"/>
              <param name="GlobalWarmingLimit" value="if $GlobalWarmingLimitTable.{event.object}? then $GlobalWarmingLimitTable.{event.object} else null"/>
            </run_actions>
          </actions>
        </cue>
        <cue name="StatRemoved_CO2" instantiate="true">
          <conditions>
            <event_terraforming_stat_removed group="$TerraformingClusters" stat="'carbondioxide'"/>
          </conditions>
          <actions>
            <do_if value="not event.object.terraforming.project.atm_carbon_mineralizers.complete">
              <debug_text text="'CO2 stat became irrelevant, removing projects to clean it up'" chance="$DebugChance"/>
              <remove_terraforming_project cluster="event.object" id="'atm_carbon_mineralize'"/>
              <remove_terraforming_project cluster="event.object" id="'atm_carbon_mineralizers'"/>
              <remove_terraforming_event cluster="event.object" id="'evt_globalwarming_co2'"/>
            </do_if>
            <do_else>
              <debug_text text="'CO2 stat became irrelevant but clean-up project was already completed - leaving it in'" chance="$DebugChance"/>
            </do_else>
          </actions>
        </cue>

        <cue name="StatAdded_Toxicity" instantiate="true">
          <conditions>
            <check_any>
              <event_terraforming_stat_added group="$TerraformingClusters" stat="'toxicity'"/>
              <event_cue_signalled/>
            </check_any>
          </conditions>
          <actions>
            <debug_text text="'Toxicity stat became relevant, adding project to clean it up'" chance="$DebugChance"/>
            <add_terraforming_project cluster="event.object" id="'atm_toxin_cleanup'">
              <predecessors>
                <predecessor group="'src_toxicity'" any="false"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </cue>
        <cue name="StatRemoved_Toxicity" instantiate="true">
          <conditions>
            <event_terraforming_stat_removed group="$TerraformingClusters" stat="'toxicity'"/>
          </conditions>
          <actions>
            <debug_text text="'Toxicity stat became irrelevant, removing project to clean it up'" chance="$DebugChance"/>
            <remove_terraforming_project cluster="event.object" id="'atm_toxin_cleanup'"/>
          </actions>
        </cue>

        <cue name="StatAdded_Radioactivity" instantiate="true">
          <conditions>
            <event_terraforming_stat_added group="$TerraformingClusters" stat="'radioactivity'"/>
          </conditions>
          <actions>
            <debug_text text="'Radioactivity stat became relevant, adding project to clean it up'" chance="$DebugChance"/>
            <add_terraforming_project cluster="event.object" id="'ter_radioactive_cleanup'"/>
          </actions>
        </cue>
        <cue name="StatRemoved_Radioactivity" instantiate="true">
          <conditions>
            <event_terraforming_stat_removed group="$TerraformingClusters" stat="'radioactivity'"/>
          </conditions>
          <actions>
            <debug_text text="'Radioactivity stat became irrelevant, removing project to clean it up'" chance="$DebugChance"/>
            <remove_terraforming_project cluster="event.object" id="'ter_radioactive_cleanup'"/>
          </actions>
        </cue>

        <cue name="StatAdded_SeismicActivity" instantiate="true">
          <conditions>
            <event_terraforming_stat_added group="$TerraformingClusters" stat="'seismicactivity'"/>
          </conditions>
          <actions>
            <debug_text text="'Seismic activity stat became relevant, adding events'" chance="$DebugChance"/>
            <add_terraforming_event cluster="event.object" id="'evt_quake_mild'"/>
            <add_terraforming_event cluster="event.object" id="'evt_quake_moderate'"/>
            <add_terraforming_event cluster="event.object" id="'evt_quake_severe'"/>
          </actions>
        </cue>
        <cue name="StatRemoved_SeismicActivity" instantiate="true">
          <conditions>
            <event_terraforming_stat_removed group="$TerraformingClusters" stat="'seismicactivity'"/>
          </conditions>
          <actions>
            <debug_text text="'Seismic activity stat became irrelevant, removing events'" chance="$DebugChance"/>
            <remove_terraforming_event cluster="event.object" id="'evt_quake_mild'"/>
            <remove_terraforming_event cluster="event.object" id="'evt_quake_moderate'"/>
            <remove_terraforming_event cluster="event.object" id="'evt_quake_severe'"/>
          </actions>
        </cue>

        <library name="TemperatureProjectsHelper" purpose="run_actions">
          <params>
            <param name="Cluster"/>
          </params>
          <actions>
            <do_if value="$Cluster.terraforming.stat.temperature.value lt 5">
              <do_if value="not $Cluster.terraforming.project.tmp_moholes.exists">
                <debug_text text="'adding tmp_moholes project to %s to increase temperature'.[$Cluster.knownname]"/>
                <add_terraforming_project cluster="$Cluster" id="'tmp_moholes'"/>
              </do_if>
              <do_if value="not $Cluster.terraforming.project.tmp_blackdust.exists">
                <debug_text text="'adding tmp_blackdust project to %s to increase temperature'.[$Cluster.knownname]"/>
                <add_terraforming_project cluster="$Cluster" id="'tmp_blackdust'"/>
              </do_if>
              <do_if value="not $Cluster.terraforming.project.atm_methane_import.exists">
                <debug_text text="'adding atm_methane_import project to %s to increase temperature'.[$Cluster.knownname]"/>
                <add_terraforming_project cluster="$Cluster" id="'atm_methane_import'"/>
              </do_if>
            </do_if>
            <do_if value="$Cluster.terraforming.stat.temperature.value gt 5">
              <do_if value="not $Cluster.terraforming.project.tmp_cloudparticles.exists">
                <debug_text text="'adding tmp_cloudparticles project to %s to decrease temperature'.[$Cluster.knownname]"/>
                <do_if value="$Cluster.terraforming.stat.humidity.value lt 1 and $Cluster.terraforming.project.wat_import.exists">
                  <add_terraforming_project cluster="$Cluster" id="'tmp_cloudparticles'">
                    <predecessors any="true">
                      <predecessor id="'wat_import'"/>
                    </predecessors>
                  </add_terraforming_project>
                </do_if>
                <do_else>
                  <add_terraforming_project cluster="$Cluster" id="'tmp_cloudparticles'"/>
                </do_else>
              </do_if>
            </do_if>
          </actions>
        </library>

        <cue name="StatChanged_Temperature" instantiate="true">
          <conditions>
            <event_terraforming_stat_changed group="$TerraformingClusters" stat="'temperature'"/>
          </conditions>
          <actions>
            <run_actions ref="TemperatureProjectsHelper">
              <param name="Cluster" value="event.object"/>
            </run_actions>
          </actions>
        </cue>

        <cue name="Patch_Add_Temperature_Projects">
          <actions>
            <!--re-check all previously initialized clusters-->
            <do_for_each in="$TerraformingClusters" name="$Cluster">
              <run_actions ref="TemperatureProjectsHelper">
                <param name="Cluster" value="$Cluster"/>
              </run_actions>
            </do_for_each>
          </actions>
        </cue>

        <cue name="StatChanged_Habitability_And_Population" instantiate="true">
          <conditions>
            <event_terraforming_stat_changed group="$TerraformingClusters"/>
          </conditions>
          <actions>
            <do_if value="event.object.terraforming.stat.population.value gt 0">
              <set_world_population cluster="event.object" partname="event.object.terraforming.partname" page="1042" line="10021" comment="$POPULATION$"/>
            </do_if>
            <do_elseif value="event.object.terraforming.habitable">
              <set_world_population cluster="event.object" partname="event.object.terraforming.partname" page="1042" line="16011" comment="Uninhabited"/>
            </do_elseif>
            <do_else>
              <set_world_population cluster="event.object" partname="event.object.terraforming.partname" page="1042" line="10011" comment="None"/>
            </do_else>
          </actions>
        </cue>

        <cue name="Patch_Set_Population_String">
          <actions>
            <do_for_each in="$TerraformingClusters" name="$Cluster">
              <do_if value="$Cluster.terraforming.stat.population.value gt 0">
                <set_world_population cluster="$Cluster" partname="$Cluster.terraforming.partname" page="1042" line="10021" comment="$POPULATION$"/>
              </do_if>
              <do_elseif value="$Cluster.terraforming.habitable">
                <set_world_population cluster="$Cluster" partname="$Cluster.terraforming.partname" page="1042" line="16011" comment="Uninhabited"/>
              </do_elseif>
              <do_else>
                <set_world_population cluster="$Cluster" partname="$Cluster.terraforming.partname" page="1042" line="10011" comment="None"/>
              </do_else>
            </do_for_each>
          </actions>
        </cue>

        <!--Repeatable Boso voice feedback cues-->

        <cue name="Terraforming_Project_Started_Production" instantiate="true">
          <conditions>
            <event_terraforming_project_started_production group="$TerraformingClusters"/>
            <check_value value="$TrainingProjects.indexof.{event.param} == 0 and $CompetitionProjects.indexof.{event.param} == 0"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Project_Started_Production_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[[30500001,30500002,30500003].random]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Project_Completed" instantiate="true">
          <conditions>
            <check_any>
              <check_all>
                <event_terraforming_project_succeeded group="$TerraformingClusters"/>
                <check_value value="$TrainingProjects.indexof.{event.param} == 0 and $CompetitionProjects.indexof.{event.param} == 0"/>
              </check_all>
              <event_terraforming_project_failed group="$TerraformingClusters"/>
            </check_any>
          </conditions>
          <actions>
            <remove_value name="$Terraforming_Project_Completed_Lines"/>
            <create_list name="$Terraforming_Project_Completed_Lines"/>
            <do_if value="event.name == 'event_terraforming_project_succeeded'">
              <unlock_achievement name="TERRAFORMING_PROJECT"/>
              <set_value name="stat.terraforming_projects_completed" operation="add"/>
              <do_if value="terraforming.project.{event.param}.successchance ge 100">
                <append_to_list name="$Terraforming_Project_Completed_Lines" exact="[[30500004,30500005].random]"/>
              </do_if>
              <do_else>
                <append_to_list name="$Terraforming_Project_Completed_Lines" exact="[30500006]"/>
              </do_else>
              <do_if value="event.param2.{1}">
                <append_to_list name="$Terraforming_Project_Completed_Lines" exact="[30500007]"/>
              </do_if>
              <do_if value="event.param2.{2}">
                <set_value name="stat.terraforming_complications_suffered" operation="add"/>
                <append_to_list name="$Terraforming_Project_Completed_Lines" exact="[30500008]"/>
              </do_if>
            </do_if>
            <do_else>
              <set_value name="stat.terraforming_projects_failed" operation="add"/>
              <append_to_list name="$Terraforming_Project_Completed_Lines" exact="[30500009]"/>
              <do_if value="event.param2.{2}">
                <set_value name="stat.terraforming_complications_suffered" operation="add"/>
                <append_to_list name="$Terraforming_Project_Completed_Lines" exact="[30500011]"/>
              </do_if>
              <do_if value="event.param2.{1}">
                <append_to_list name="$Terraforming_Project_Completed_Lines" exact="[30500010]"/>
              </do_if>
            </do_else>
            <debug_text text="'Lines to speak: ' + $Terraforming_Project_Completed_Lines"/>
          </actions>
          <cues>
            <cue name="Terraforming_Project_Completed_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="$Terraforming_Project_Completed_Lines"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Ice_Melt_Started" instantiate="true">
          <conditions>
            <event_terraforming_event_started group="$TerraformingClusters" project="'evt_icemelt'"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Ice_Melt_Started_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500012]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_World_Became_Habitable" instantiate="true">
          <conditions>
            <event_terraforming_habitability_changed group="$TerraformingClusters"/>
            <check_value value="event.object.terraforming.habitable"/>
          </conditions>
          <cues>
            <cue name="Terraforming_World_Became_Habitable_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500040]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Supply_Available" instantiate="true">
          <conditions>
            <event_terraforming_project_available group="$TerraformingClusters"/>
            <check_value value="event.param == 'eco_clinic_supply' or event.param == 'eco_campus_supply' or event.param == 'eco_nividium_supply'"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Supply_Available_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500013],[30500015]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Investment_Available" instantiate="true">
          <conditions>
            <event_terraforming_project_available group="$TerraformingClusters" project="'eco_bank_supply'"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Investment_Available_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500014],[30500015]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Investment_Succeeded" instantiate="true">
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters" project="'eco_bank_supply'"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Investment_Succeeded_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500017]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Investment_Failed" instantiate="true">
          <conditions>
            <event_terraforming_project_failed group="$TerraformingClusters" project="'eco_bank_supply'"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Investment_Failed_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500016]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Training_Or_Competiton_Production_Started" instantiate="true">
          <conditions>
            <event_terraforming_project_started_production group="$TerraformingClusters"/>
            <check_value value="$TrainingProjects.indexof.{event.param} != 0 or $CompetitionProjects.indexof.{event.param} != 0"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Training_Or_Competiton_Production_Started_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500020]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Training_Started" instantiate="true">
          <conditions>
            <event_terraforming_project_started group="$TerraformingClusters"/>
            <check_value value="$TrainingProjects.indexof.{event.param} != 0"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Training_Started_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500018]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Training_Finished" instantiate="true">
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters"/>
            <check_value value="$TrainingProjects.indexof.{event.param} != 0"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Training_Finished_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500019]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Competition_Started" instantiate="true">
          <conditions>
            <event_terraforming_project_started group="$TerraformingClusters"/>
            <check_value value="$CompetitionProjects.indexof.{event.param} != 0"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Competition_Started_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500021]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Competition_Finished" instantiate="true">
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters"/>
            <check_value value="$CompetitionProjects.indexof.{event.param} != 0"/>
          </conditions>
          <cues>
            <cue name="Terraforming_Competition_Finished_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$BosoTa"/>
              <param name="Cutscene"          value="$BosoTa.room != player.room"/>
              <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
              <param name="Lines"             value="[[30500022],[30500023]]"/>
              <param name="IsInMission"       value="false"/>
            </cue>
          </cues>
        </cue>

        <!--Xenon-specific helper cues-->

        <library name="AddXenonDistricts" purpose="run_actions">
          <params>
            <param name="Cluster"/>
            <param name="Index"/>
          </params>
          <actions>
            <!--Habitation District-->
            <run_actions ref="AddXenonDistrict">
              <param name="Cluster" value="$Cluster"/>
              <param name="Project" value="'xen_dis_hab'"/>
              <param name="Index" value="$Index"/>
              <param name="Description" value="'{20227,2061}'"/>
            </run_actions>
            <!--Administration District-->
            <run_actions ref="AddXenonDistrict">
              <param name="Cluster" value="$Cluster"/>
              <param name="Project" value="'xen_dis_admin'"/>
              <param name="Index" value="$Index"/>
              <param name="Description" value="'{20227,2091}'"/>
              <param name="Predecessor" value="'xen_dis_hab'"/>
            </run_actions>
            <!--Commerce District-->
            <run_actions ref="AddXenonDistrict">
              <param name="Cluster" value="$Cluster"/>
              <param name="Project" value="'xen_dis_com'"/>
              <param name="Index" value="$Index"/>
              <param name="Description" value="'{20227,2071}'"/>
            </run_actions>
            <!--Industrial District-->
            <run_actions ref="AddXenonDistrict">
              <param name="Cluster" value="$Cluster"/>
              <param name="Project" value="'xen_dis_ind'"/>
              <param name="Index" value="$Index"/>
              <param name="Description" value="'{20227,2101}'"/>
              <param name="Predecessor" value="'xen_dis_com'"/>
            </run_actions>
            <!--Farming District-->
            <run_actions ref="AddXenonDistrict">
              <param name="Cluster" value="$Cluster"/>
              <param name="Project" value="'xen_dis_farm'"/>
              <param name="Index" value="$Index"/>
              <param name="Description" value="'{20227,2081}'"/>
            </run_actions>
            <!--Recreation District-->
            <run_actions ref="AddXenonDistrict">
              <param name="Cluster" value="$Cluster"/>
              <param name="Project" value="'xen_dis_rec'"/>
              <param name="Index" value="$Index"/>
              <param name="Description" value="'{20227,2111}'"/>
              <param name="Predecessor" value="'xen_dis_farm'"/>
            </run_actions>
            <!--AGI Core-->
            <add_terraforming_project id="'xen_core_subvert'" postfix="$Index" cluster="$Cluster">
              <predecessors any="true">
                <predecessor id="'xen_dis_admin' + $Index"/>
                <predecessor id="'xen_dis_ind' + $Index"/>
                <predecessor id="'xen_dis_rec' + $Index"/>
              </predecessors>
            </add_terraforming_project>
            <add_terraforming_project id="'xen_reactor_detonate'" postfix="$Index" cluster="$Cluster">
              <predecessors any="true">
                <predecessor id="'xen_dis_admin' + $Index"/>
                <predecessor id="'xen_dis_ind' + $Index"/>
                <predecessor id="'xen_dis_rec' + $Index"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </library>

        <library name="AddXenonDistrict" purpose="run_actions">
          <params>
            <param name="Cluster"/>
            <param name="Project"/>
            <param name="Index"/>
            <param name="Description"/>
            <param name="Predecessor" default="null"/>
          </params>
          <actions>
            <set_value name="$Postfix" exact="'_' + $Project + $Index"/>
            <do_if value="$Predecessor?">
              <add_terraforming_project id="'xen_dis_claim'" postfix="$Postfix" cluster="$Cluster">
                <predecessors any="true">
                  <predecessor id="$Predecessor + $Index"/>
                </predecessors>
              </add_terraforming_project>
              <add_terraforming_project id="'xen_dis_destroy'" postfix="$Postfix" cluster="$Cluster">
                <predecessors any="true">
                  <predecessor id="$Predecessor + $Index"/>
                </predecessors>
              </add_terraforming_project>
            </do_if>
            <do_else>
              <add_terraforming_project id="'xen_dis_claim'" postfix="$Postfix" cluster="$Cluster"/>
              <add_terraforming_project id="'xen_dis_destroy'" postfix="$Postfix" cluster="$Cluster"/>
            </do_else>
            <add_terraforming_project id="$Project" postfix="$Index" description="$Description + '\n\n{20227,2030}\n{20227,2031}'" cluster="$Cluster">
              <predecessors any="true">
                <predecessor id="'xen_dis_claim' + $Postfix"/>
                <predecessor id="'xen_dis_destroy' + $Postfix"/>
              </predecessors>
            </add_terraforming_project>
          </actions>
        </library>

        <!--Note: the following should be set by MD according to the current state:
        {20227,2030} 'Under Xenon control'
        {20227,2031} 'Xenon drones regularly patrol this district, preventing us from passing through it.'
        {20227,2040} 'Liberated'
        {20227,2041} 'The Xenon presence has been curbed for the time being, making it safe to pass through.'
        {20227,2050} 'Destroyed'
        {20227,2051} 'Without anything to protect, the Xenon are ignoring this ruined district for the time being, making it safe to pass through.'
        -->

        <!--
        <project id="evt_xen_reclaim" group="xenon" name="{20227,2140}" description="{20227,2141}">
          <deliveries>
            <ship macro="ship_gen_m_transdrone_container_01_a_macro" amount="5" buildduration="30" />
            <ship macro="ship_gen_s_transdrone_container_01_a_macro" amount="20" buildduration="15" />
          </deliveries>
        </project>
        <project id="evt_xen_rebuild" group="xenon" name="{20227,2150}" description="{20227,2151}">
        </project>
        <project id="xen_drones_emp" group="xenon" name="{20227,2160}" description="{20227,2161}">
          <deliveries>
            <ship macro="ship_gen_m_transdrone_container_01_a_macro" amount="5" buildduration="30" />
            <ship macro="ship_gen_s_transdrone_container_01_a_macro" amount="20" buildduration="15" />
          </deliveries>
        </project>
        <project id="xen_drones_bombard_reclaim" group="xenon" name="{20227,2170}" description="{20227,2171} {20227,2172}">
          <deliveries>
            <ship macro="ship_gen_m_transdrone_container_01_a_macro" amount="5" buildduration="30" />
            <ship macro="ship_gen_s_transdrone_container_01_a_macro" amount="20" buildduration="15" />
          </deliveries>
        </project>
        <project id="xen_drones_bombard_rebuild" group="xenon" name="{20227,2170}" description="{20227,2171} {20227,2173}">
          <deliveries>
            <ship macro="ship_gen_m_transdrone_container_01_a_macro" amount="5" buildduration="30" />
            <ship macro="ship_gen_s_transdrone_container_01_a_macro" amount="20" buildduration="15" />
          </deliveries>
        </project>
        -->
        <!--<cue name="XenonDistrictClaimedOrDestroyed">
          <conditions>
            <event_terraforming_project_completed group="$XenonTerraformingClusters"/>
          </conditions>
          <actions></actions>
        </cue>

        <cue name="XenonDistrictDestroyed"></cue>

        <cue name="XenonDistrictReclaimed"></cue>

        <cue name="CoreSubverted">
          <conditions>
            <event_terraforming_project_completed group="$XenonTerraformingClusters"/>
            <check_value value="event.param.indexof.{'xen_core_subvert'}"/>
          </conditions>
          <actions></actions>
        </cue>

        <cue name="CoreDestroyed">
          <conditions>
            <event_terraforming_project_completed group="$XenonTerraformingClusters"/>
            <check_value value="event.param.indexof.{'xen_core_detonate'}"/>
          </conditions>
          <actions></actions>
        </cue>-->

        <!--Miscellaneous helper cues-->

        <cue name="Terraforming_Group_Boarding_Training_Finished" instantiate="true">
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters" project="'trn_boarding_group'"/>
          </conditions>
          <actions>
            <do_for_each in="$HQ.people.{entityrole.trainee_group}.list" name="$Trainee">
              <set_value name="$CurrentSkill" exact="$HQ.people.{$Trainee}.skill.boarding"/>
              <do_if value="$CurrentSkill lt 12" comment="4 stars">
                <add_skill object="$HQ" template="$Trainee" type="skilltype.boarding" exact="3 - ($CurrentSkill % 3)" comment="add enough to go exactly to the next star"/>
              </do_if>
            </do_for_each>
          </actions>
        </cue>

        <cue name="Terraforming_Single_Boarding_Training_Finished" instantiate="true">
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters" project="'trn_boarding_single'"/>
          </conditions>
          <actions>
            <set_value name="$Trainee" exact="$HQ.assignedcontrolentity.{controlpost.trainee_individual}"/>
            <do_if value="$Trainee">
              <set_value name="$CurrentSkill" exact="$Trainee.skill.boarding"/>
              <do_if value="$CurrentSkill lt 15" comment="5 stars">
                <add_skill entity="$Trainee" type="skilltype.boarding" exact="3 - ($CurrentSkill % 3)" comment="add enough to go exactly to the next star"/>
              </do_if>
            </do_if>
          </actions>
        </cue>

        <cue name="Terraforming_Boarding_Competition_Finished" instantiate="true">
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters" project="'trn_boarding_competition'"/>
          </conditions>
          <actions>
            <do_all exact="3" counter="$i">
              <do_any comment="Needed for DLC patching">
                <get_character_definition macro="$Macro" faction="faction.scaleplate" tags="tag.marine"/>
              </do_any>
              <create_npc_template name="$Crew" object="$HQ" macro="$Macro" role="entityrole.passenger"/>
              <do_if value="$Crew">
                <set_skill object="$HQ" template="$Crew" type="skilltype.boarding" min="if $i == 1 then 15 else 13" max="15"/>
                <set_skill object="$HQ" template="$Crew" type="skilltype.engineering" min="1" max="9"/>
                <set_skill object="$HQ" template="$Crew" type="skilltype.management" min="1" max="9"/>
                <set_skill object="$HQ" template="$Crew" type="skilltype.piloting" min="1" max="9"/>
                <set_skill object="$HQ" template="$Crew" type="skilltype.morale" min="13" max="15"/>
              </do_if>
            </do_all>
          </actions>
        </cue>

        <cue name="Terraforming_Group_Piloting_Training_Finished" instantiate="true">
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters" project="'trn_pilot_group'"/>
          </conditions>
          <actions>
            <do_for_each in="$HQ.people.{entityrole.trainee_group}.list" name="$Trainee">
              <set_value name="$CurrentSkill" exact="$HQ.people.{$Trainee}.skill.piloting"/>
              <do_if value="$CurrentSkill lt 12" comment="4 stars">
                <add_skill object="$HQ" template="$Trainee" type="skilltype.piloting" exact="3 - ($CurrentSkill % 3)" comment="add enough to go exactly to the next star"/>
                <set_value name="stat.terraforming_personnel_trained_in_groups" operation="add"/>
              </do_if>
            </do_for_each>
          </actions>
        </cue>

        <cue name="Terraforming_Single_Piloting_Training_Finished" instantiate="true">
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters" project="'trn_pilot_single'"/>
          </conditions>
          <actions>
            <set_value name="$Trainee" exact="$HQ.assignedcontrolentity.{controlpost.trainee_individual}"/>
            <do_if value="$Trainee">
              <set_value name="$CurrentSkill" exact="$Trainee.skill.piloting"/>
              <do_if value="$CurrentSkill lt 15" comment="5 stars">
                <add_skill entity="$Trainee" type="skilltype.piloting" exact="3 - ($CurrentSkill % 3)" comment="add enough to go exactly to the next star"/>
                <set_value name="stat.terraforming_personnel_trained_individually" operation="add"/>
              </do_if>
            </do_if>
          </actions>
        </cue>

        <cue name="Terraforming_Piloting_Competition_Finished" instantiate="true" >
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters" project="'trn_pilot_competition'"/>
          </conditions>
          <actions>
            <do_all exact="3" counter="$i">
              <do_any comment="Needed for DLC patching">
                <get_character_definition macro="$Macro" faction="faction.scaleplate" tags="tag.pilot"/>
              </do_any>
              <create_npc_template name="$Crew" object="$HQ" macro="$Macro" role="entityrole.passenger"/>
              <do_if value="$Crew">
                <set_skill object="$HQ" template="$Crew" type="skilltype.boarding" min="1" max="9"/>
                <set_skill object="$HQ" template="$Crew" type="skilltype.engineering" min="1" max="9"/>
                <set_skill object="$HQ" template="$Crew" type="skilltype.management" min="1" max="9"/>
                <set_skill object="$HQ" template="$Crew" type="skilltype.piloting" min="if $i == 1 then 15 else 13" max="15"/>
                <set_skill object="$HQ" template="$Crew" type="skilltype.morale" min="13" max="15"/>
              </do_if>
            </do_all>
          </actions>
        </cue>

        <cue name="Terraforming_Create_Antigone_Reporter">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_cue_actor name="$Antigone_Reporter" cue="namespace" macro="character_argon_female_terraforming_ant_reporter_macro">
              <page exact="10154"/>
              <owner exact="faction.antigone"/>
              <skills>
                <skill type="management"  exact="9"/>
                <skill type="morale"      exact="15"/>
                <skill type="piloting"    exact="0"/>
                <skill type="engineering" exact="6"/>
                <skill type="boarding"    exact="0"/>
              </skills>
            </create_cue_actor>
            <set_entity_traits entity="$Antigone_Reporter" missionactor="true"/>
          </actions>
        </cue>

        <library name="AdditionalObjective_BuildModule" comment="requires: $UpdateCue">
          <params>
            <param name="UpdateCue"/>
            <param name="Station"/>
          </params>
          <cues>
            <cue name="CheckStation_BuildModule" instantiate="true">
              <conditions>
                <check_all>
                  <event_player_build_finished_components comment="check each time a module is completed"/>
                  <check_value value="event.param.buildanchor == $Station"/>
                </check_all>
              </conditions>
              <actions>
                <!--Update Wharf Module Group-->
                <find_object_component groupname="$WharfModules" object="$Station" class="class.buildmodule">
                  <match_any>
                    <match canbuildclass="class.ship_m"/>
                    <match canbuildclass="class.ship_s"/>
                  </match_any>
                </find_object_component>
                <do_if value="$WharfModules.count">
                  <signal_cue_instantly cue="$UpdateCue" param="['ModulesGroup',$WharfModules]"/>
                  <cancel_cue cue="AdditionalObjective_BuildModule"/>
                </do_if>
              </actions>
            </cue>
          </cues>
        </library>

        <!-- Notifications -->
        <cue name="TerraformingProjectCompletedSucessfully" instantiate="true">
          <conditions>
            <event_terraforming_project_succeeded group="$TerraformingClusters"/>
          </conditions>
          <actions>
            <set_value name="$ProjectPayout" exact="event.param3"/>
            <set_value name="$logtext" exact="{30500,1001} + ' ' + terraforming.project.{event.param}.name"/>
            <do_if value="$ProjectPayout gt 0">
              <substitute_text text="$logtext2" source="{30500,1003}">
                <replace string="'$CREDITS$'" with="$ProjectPayout.formatted.default"/>
              </substitute_text>
              <set_value name="$logtext" exact="$logtext + '\n' + $logtext2"/>
            </do_if>

            <show_notification text="$logtext" sound="ui_mission_completed" />
            <write_to_logbook category="missions" title="event.object.knownname" text="$logtext" money="$ProjectPayout"/>
          </actions>
        </cue>

        <cue name="TerraformingProjectFailed" instantiate="true">
          <conditions>
            <event_terraforming_project_failed group="$TerraformingClusters"/>
          </conditions>
          <actions>
            <set_value name="$logtext" exact="{30500,1002} + ' ' + terraforming.project.{event.param}.name"/>

            <show_notification text="$logtext" sound="notification_warning" />
            <write_to_logbook category="missions" title="event.object.knownname" text="$logtext"/>
          </actions>
        </cue>

        <!--Actual terraforming cues-->

        <cue name="Terraforming_ScalePlateGreen" version="1">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="not $Cluster_ScalePlateGreen_Completed?">
              <find_cluster name="$Cluster_ScalePlateGreen" macro="macro.cluster_21_macro"/>
              <add_to_group groupname="$TerraformingClusters" object="$Cluster_ScalePlateGreen"/>
              <append_to_list name="$OfferCues" exact="Terraforming_ScalePlateGreen_CreateOffer"/>
              <signal_cue cue="Refresh_Offers" check="false"/>
              <initialise_terraforming cluster="$Cluster_ScalePlateGreen" partname="'planet001b'"/>
              <!--Set initial stats-->
              <set_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'temperature'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'oxygen'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'carbondioxide'" value="1"/>
              <set_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'radioactivity'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'population'" value="0"/>
              <set_value name="$GlobalWarmingLimitTable.{$Cluster_ScalePlateGreen}" exact="3"/>
              <set_value name="$AddedAtmoPressureTable.{$Cluster_ScalePlateGreen}" exact="1" comment="(3 oxygen + 1 co2) / 4"/>
              <!--Set up projects-->
              <run_actions ref="SetupGeneralProjects">
                <param name="Cluster" value="$Cluster_ScalePlateGreen"/>
                <param name="Biosphere" value="false"/>
                <param name="GlobalWarmingLimit" value="3"/>
              </run_actions>
              <add_terraforming_project cluster="$Cluster_ScalePlateGreen" id="'bio_reintroduce'"/>
              <add_terraforming_project cluster="$Cluster_ScalePlateGreen" id="'ame_zoo'"/>
              <set_value name="$Terraforming_ScalePlateGreen_HousingTargetAmount" exact="1000000000"/>
              <!--Create mission character-->
              <create_cue_actor name="$ScalePlate_Contact" cue="namespace" macro="character_argon_male_terraforming_sca_contact_macro">
                <page exact="10155"/>
                <owner exact="faction.scaleplate"/>
                <skills>
                  <skill type="management"  exact="3"/>
                  <skill type="morale"      exact="9"/>
                  <skill type="piloting"    exact="9"/>
                  <skill type="engineering" exact="6"/>
                  <skill type="boarding"    exact="9"/>
                </skills>
              </create_cue_actor>
              <set_entity_traits entity="$ScalePlate_Contact" missionactor="true"/>
            </do_if>
          </actions>
          <patch sinceversion="1">
            <do_if value="$Cluster_ScalePlateGreen.terraforming.stat.airpressure.exists">
              <remove_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'airpressure'"/>
              <debug_text text="'Removed airpressure from $Cluster_ScalePlateGreen - test: ' + $Cluster_ScalePlateGreen.terraforming.stat.airpressure.exists"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Terraforming_ScalePlateGreen_CreateOffer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating offer for cue Terraforming_ScalePlateGreen_CreateMission'" chance="$DebugChance"/>
                <do_if value="$HQ.hasbeenrenamed">
                  <set_value name="$HQName" exact="$HQ.knownname"/>
                </do_if>
                <do_else>
                  <set_value name="$HQName" exact="{20102,2011}"/>
                </do_else>
                <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                  <replace string="'$STATION$'" with="$HQName"/>
                  <replace string="'$LOCATION$'" with="$Cluster_ScalePlateGreen.knownname"/>
                </substitute_text>
                <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                  <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_ScalePlateGreen_HousingTargetAmount]"/>
                </substitute_text>
                <create_offer cue="Terraforming_ScalePlateGreen_CreateMission" type="missiontype.think" actor="$BosoTa" difficulty="level.veryhard" faction="faction.scaleplate" group="missiongroup.terraforming" name="{30503,1000}" description="{30503,1001}" rewardtext="{30503,1002}">
                  <briefing>
                    <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_ScalePlateGreen"/>
                    <objective step="2" action="objective.neutralize" text="terraforming.stat.radioactivity.name"/>
                    <objective step="3" action="objective.build_project" text="terraforming.project.agr_fields_sunrise.name"/>
                    <objective step="4" action="objective.build_housing" text="$HousingObjectiveText"/>
                    <objective step="5" action="objective.build_project" text="terraforming.project.res_housing_luxury.name"/>
                  </briefing>
                </create_offer>
                <remove_value name="$RelocateObjectiveText"/>
                <remove_value name="$HousingObjectiveText"/>
              </actions>
            </cue>

            <cue name="Terraforming_ScalePlateGreen_CreateMission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating mission for cue Terraforming_ScalePlateGreen_CreateMission'" chance="$DebugChance"/>
                <create_mission cue="Terraforming_ScalePlateGreen_CreateMission" offercue="Terraforming_ScalePlateGreen_CreateMission"/>
                <set_terraforming_mission_activated cluster="$Cluster_ScalePlateGreen" missioncue="Terraforming_ScalePlateGreen_CreateMission"/>
                <remove_offer cue="Terraforming_ScalePlateGreen_CreateMission"/>
                <set_value name="$AcceptedOfferCue" exact="Terraforming_ScalePlateGreen_CreateOffer"/>
                <do_if value="@$AbortMissionCue">
                  <signal_cue cue="$AbortMissionCue"/>
                </do_if>
                <set_value name="$AbortMissionCue" exact="Terraforming_ScalePlateGreen_AbortMission"/>
                <set_value name="$OptionalSteps" exact="0"/>
              </actions>
              <cues>
                <cue name="Terraforming_ScalePlateGreen_Intro_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterBoron']"/>
                  <param name="Lines"             value="[[30503001]]"/>
                  <param name="MissionCue"        value="Terraforming_ScalePlateGreen_CreateMission"/>
                </cue>

                <cue name="Terraforming_ScalePlateGreen_AbortMission">
                  <conditions>
                    <check_any>
                      <event_mission_aborted cue="Terraforming_ScalePlateGreen_CreateMission"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Removing mission for cue Terraforming_ScalePlateGreen_CreateMission'" chance="$DebugChance"/>
                    <remove_mission cue="Terraforming_ScalePlateGreen_CreateMission"/>
                    <remove_value name="$AcceptedOfferCue"/>
                    <remove_value name="$AbortMissionCue"/>
                    <set_terraforming_mission_deactivated cluster="$Cluster_ScalePlateGreen"/>
                    <reset_cue cue="Terraforming_ScalePlateGreen_CreateMission"/>
                    <reset_cue cue="Terraforming_ScalePlateGreen_CreateOffer"/>
                    <signal_cue cue="Refresh_Offers"/>
                  </actions>
                </cue>

                <cue name="Terraforming_ScalePlateGreen_Init_ObjectiveManager" version="5">
                  <actions>
                    <do_if value="not $Cluster_ScalePlateGreen_Completed?">
                      <do_if value="$HQ.cluster != $Cluster_ScalePlateGreen">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="1"/>
                        </do_if>
                        <set_value name="$RelocateComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$RelocateComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_ScalePlateGreen.terraforming.stat.radioactivity.state != 0">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="2"/>
                        </do_if>
                        <set_value name="$HabitableComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HabitableComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_ScalePlateGreen.terraforming.project.agr_fields_sunrise.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="3"/>
                        </do_if>
                        <set_value name="$SunriseFieldsComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$SunriseFieldsComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_ScalePlateGreen.terraforming.stat.population.value lt $Terraforming_ScalePlateGreen_HousingTargetAmount">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="4"/>
                        </do_if>
                        <set_value name="$HousingComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HousingComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_ScalePlateGreen.terraforming.project.res_housing_luxury.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="5"/>
                        </do_if>
                        <set_value name="$LuxuryHousingComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$LuxuryHousingComplete" exact="true"/>
                      </do_else>

                      <do_if value="$HQ.hasbeenrenamed">
                        <set_value name="$HQName" exact="$HQ.knownname"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HQName" exact="{20102,2011}"/>
                      </do_else>
                      <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                        <replace string="'$STATION$'" with="$HQName"/>
                        <replace string="'$LOCATION$'" with="$Cluster_ScalePlateGreen.knownname"/>
                      </substitute_text>
                      <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                        <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_ScalePlateGreen_HousingTargetAmount]"/>
                      </substitute_text>

                      <do_if value="not $HQ.canbuildclass.{class.ship_s}">
                        <update_mission cue="Terraforming_ScalePlateGreen_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.build_module" object="$HQ" text="{20104,61301}" comment="Build S/M Ship Fabrication Module"/>
                            <objective step="2" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_ScalePlateGreen" completed="$RelocateComplete"/>
                            <objective step="3" action="objective.neutralize" text="terraforming.stat.radioactivity.name" completed="$HabitableComplete"/>
                            <objective step="4" action="objective.build_project" text="terraforming.project.agr_fields_sunrise.name" completed="$SunriseFieldsComplete"/>
                            <objective step="5" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                            <objective step="6" action="objective.build_project" text="terraforming.project.res_housing_luxury.name" completed="$LuxuryHousingComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="not $BuildObjective?">
                          <set_value name="$OptionalSteps" operation="add" exact="1"/>
                          <set_value name="$BuildObjective"/>
                          <signal_cue cue="Terraforming_ScalePlateGreen_Trigger_BuildModule_Objective"/>
                        </do_if>
                        <set_objective_from_briefing cue="Terraforming_ScalePlateGreen_CreateMission" step="1"/>
                      </do_if>
                      <do_else>
                        <do_if value="$BuildObjective?">
                          <set_value name="$OptionalSteps" operation="subtract" exact="1"/>
                          <remove_value name="$BuildObjective"/>
                        </do_if>
                        <update_mission cue="Terraforming_ScalePlateGreen_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_ScalePlateGreen" completed="$RelocateComplete"/>
                            <objective step="2" action="objective.neutralize" text="terraforming.stat.radioactivity.name" completed="$HabitableComplete"/>
                            <objective step="3" action="objective.build_project" text="terraforming.project.agr_fields_sunrise.name" completed="$SunriseFieldsComplete"/>
                            <objective step="4" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                            <objective step="5" action="objective.build_project" text="terraforming.project.res_housing_luxury.name" completed="$LuxuryHousingComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="$OptionalSteps ge 1">
                          <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        </do_if>
                        <do_else>
                          <set_value name="$OptionalSteps" exact="0"/>
                        </do_else>
                        <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        <set_objective_from_briefing cue="Terraforming_ScalePlateGreen_CreateMission" step="$ProjectStep"/>
                      </do_else>

                      <remove_value name="$ProjectStep"/>
                      <remove_value name="$RelocateObjectiveText"/>
                      <remove_value name="$HousingObjectiveText"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$OptionalSteps" exact="0"/>
                    <reset_cue cue="Terraforming_ScalePlateGreen_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="3">
                    <reset_cue cue="Terraforming_ScalePlateGreen_Trigger_BuildModule_Objective"/>
                    <reset_cue cue="Terraforming_ScalePlateGreen_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="5">
                    <reset_cue cue="Terraforming_ScalePlateGreen_Init_ObjectiveManager"/>
                  </patch>
                </cue>

                <cue name="Terraforming_ScalePlateGreen_BuildModule_Check">
                  <actions>
                    <find_object_component groupname="$WharfModules" object="$HQ" class="class.buildmodule">
                      <match_any>
                        <match canbuildclass="class.ship_m"/>
                        <match canbuildclass="class.ship_s"/>
                      </match_any>
                    </find_object_component>
                  </actions>
                  <cues>
                    <cue name="Terraforming_ScalePlateGreen_BuildModuleDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$WharfModules"/>
                        <check_value value="$WharfModules.count == 1" comment="trigger another check when the last build module is destroyed"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Terraforming_ScalePlateGreen_ObjectiveUpdate_v2" param="['RequestBuildModule']"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Terraforming_ScalePlateGreen_ObjectiveUpdate_v2" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_terraforming_stat_changed cluster="$Cluster_ScalePlateGreen"/>
                      <event_terraforming_project_succeeded cluster="$Cluster_ScalePlateGreen"/>
                      <event_object_changed_cluster object="$HQ"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="typeof event.param == datatype.list ">
                      <do_if value="event.param.{1} == 'ModulesGroup'" comment="make sure the signal came from CheckStation_BuildModule">
                        <add_to_group groupname="$WharfModules" group="event.param.{2}"/>
                      </do_if>
                    </do_if>
                    <reset_cue cue="Terraforming_ScalePlateGreen_Init_ObjectiveManager"/>
                  </actions>
                </cue>

                <cue name="Terraforming_ScalePlateGreen_Trigger_BuildModule_Objective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Terraforming_ScalePlateGreen_BuildModule" ref="AdditionalObjective_BuildModule">
                      <!-- Required to Signal the Update Cue when Building is finished -->
                      <param name="UpdateCue" value="Terraforming_ScalePlateGreen_ObjectiveUpdate_v2"/>
                      <param name="Station" value="$HQ"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <!--Objective cues-->
            <cue name="Terraforming_ScalePlateGreen_Milestone_1" version="1">
              <conditions>
                <event_terraforming_project_succeeded cluster="$Cluster_ScalePlateGreen"/>
              </conditions>
              <actions>
                <set_faction_relation_locked faction="faction.scaleplate" locked="false"/>
                <!-- HACK. factions with relations at exactly the friend threshold are not always friendly. -->
                <set_faction_relation faction="faction.scaleplate" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="faction.scaleplate.relation.friend.min + 0.01"/>
                <set_faction_relation_locked faction="faction.scaleplate" locked="true"/>
              </actions>
              <patch sinceversion="1">
                <set_faction_relation_locked faction="faction.scaleplate" locked="false"/>
                <set_faction_relation faction="faction.scaleplate" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="faction.scaleplate.relation.friend.min + 0.01"/>
                <do_if value="Terraforming_ScalePlateGreen_Milestone_1_UnlockRelation.state != cuestate.complete">
                  <set_faction_relation_locked faction="faction.scaleplate" locked="true"/>
                </do_if>
              </patch>
              <cues>
                <cue name="Terraforming_ScalePlateGreen_Contact_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$ScalePlate_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30503001]]"/>
                  <param name="MissionCue"        value="Terraforming_ScalePlateGreen_CreateMission"/>
                </cue>

                <cue name="Terraforming_ScalePlateGreen_Milestone_1_UnlockRelation" version="2">
                  <delay exact="5min"/>
                  <actions>
                    <set_faction_relation_locked faction="faction.scaleplate" locked="false"/>
                    <set_faction_diplomacy_active faction="faction.scaleplate" active="true"/>
                  </actions>
                  <patch sinceversion="2">
                    <set_faction_diplomacy_active faction="faction.scaleplate" active="true"/>
                  </patch>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_ScalePlateGreen_Milestone_2">
              <conditions>
                <event_terraforming_stat_changed cluster="$Cluster_ScalePlateGreen"/>
                <check_value value="$Cluster_ScalePlateGreen.terraforming.habitable"/>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.scaleplate" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.1"/>
                <create_group groupname="$CommandeeredLPlunderers"/>
              </actions>
              <cues>
                <cue name="Terraforming_ScalePlateGreen_Contact_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$ScalePlate_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30503002]]"/>
                  <param name="MissionCue"        value="Terraforming_ScalePlateGreen_CreateMission"/>
                </cue>

                <library name="Terraforming_ScalePlateGreen_Commandeer_Plunderer" purpose="run_actions">
                  <params>
                    <param name="Station"/>
                    <param name="ShipGroup"/>
                    <param name="DeepDebugChance"/>
                  </params>
                  <actions>
                    <find_ship name="$Ship" space="player.galaxy" job="'scaleplate_plunderer_l_cluster'" commandeerable="true"/>
                    <do_if value="$Ship.exists">
                      <commandeer_object object="$Ship"/>
                      <create_order object="$Ship" id="'ProtectStation'">
                        <param name="station" value="$Station"/>
                        <param name="debugchance" value="$DeepDebugChance"/>
                      </create_order>
                      <add_to_group groupname="$ShipGroup" object="$Ship"/>
                    </do_if>
                  </actions>
                </library>

                <cue name="Terraforming_ScalePlateGreen_Commandeer_Plunderers">
                  <actions>
                    <do_all exact="5">
                      <run_actions ref="Terraforming_ScalePlateGreen_Commandeer_Plunderer">
                        <param name="Station" value="$HQ"/>
                        <param name="ShipGroup" value="$CommandeeredLPlunderers"/>
                        <param name="DeepDebugChance" value="$DeepDebugChance"/>
                      </run_actions>
                    </do_all>
                  </actions>
                  <cues>
                    <cue name="Terraforming_ScalePlateGreen_Commandeered_Ship_Destroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$CommandeeredLPlunderers"/>
                      </conditions>
                      <actions>
                        <run_actions ref="Terraforming_ScalePlateGreen_Commandeer_Plunderer">
                          <param name="Station" value="$HQ"/>
                          <param name="ShipGroup" value="$CommandeeredLPlunderers"/>
                          <param name="DeepDebugChance" value="$DeepDebugChance"/>
                        </run_actions>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_ScalePlateGreen_MissionComplete" version="6">
              <conditions>
                <check_any>
                  <event_terraforming_stat_changed cluster="$Cluster_ScalePlateGreen" stat="'population'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_ScalePlateGreen" project="'res_housing_luxury'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_ScalePlateGreen" project="'agr_fields_sunrise'"/>
                </check_any>
                <check_value value="$Cluster_ScalePlateGreen.terraforming.stat.population.value ge $Terraforming_ScalePlateGreen_HousingTargetAmount"/>
                <check_value value="$Cluster_ScalePlateGreen.terraforming.project.res_housing_luxury.complete"/>
                <check_value value="$Cluster_ScalePlateGreen.terraforming.project.agr_fields_sunrise.complete"/>
              </conditions>
              <actions>
                <cancel_cue cue="Terraforming_ScalePlateGreen_ObjectiveUpdate_v2"/>
                <remove_from_list name="$OfferCues" exact="Terraforming_ScalePlateGreen_CreateOffer" multiple="false"/>
                <remove_value name="$AbortMissionCue"/>
                <remove_mission cue="Terraforming_ScalePlateGreen_CreateMission" type="completed"/>
                <set_world_settlements cluster="$Cluster_ScalePlateGreen" partname="'planet001b'" page="1042" line="16041" comment="Multiple Cities"/>
                <set_value name="$Cluster_ScalePlateGreen_Completed"/>
                <set_terraforming_mission_completed cluster="$Cluster_ScalePlateGreen"/>
                <unlock_achievement name="TERRAFORMING_MISSION"/>
                <set_value name="stat.terraforming_missions_completed" operation="add"/>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_scale_plate_green"/>
              </actions>
              <patch sinceversion="2">
                <remove_from_list name="$OfferCues" exact="Terraforming_ScalePlateGreen_CreateOffer" multiple="false" />
              </patch>
              <patch sinceversion="3">
                <set_terraforming_mission_completed cluster="$Cluster_ScalePlateGreen"/>
              </patch>
              <patch sinceversion="4">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_scale_plate_green"/>
              </patch>
              <patch sinceversion="5" state="complete">
                <set_world_settlements cluster="$Cluster_ScalePlateGreen" partname="'planet001b'" page="1042" line="16041" comment="Multiple Cities"/>
              </patch>
              <patch sinceversion="6" state="complete">
                <!--disabling 7.0 aggressive/anarchy pirates-->
                <set_job_active job="'scaleplate_patrol_s_cluster_anarchy_aggresive'" activate="false"/>
                <set_job_active job="'scaleplate_patrol_m_cluster_anarchy_aggresive'" activate="false"/>
                <set_job_active job="'scaleplate_patrol_l_cluster_anarchy_aggresive'" activate="false"/>
              </patch>
              <cues>
                <cue name="Terraforming_ScalePlateGreen_VideoEmail">
                  <actions>
                    <substitute_text text="$EmailTitle" source="{30500,11001}">
                      <replace string="'$CLUSTERNAME$'" with="$Cluster_ScalePlateGreen.knownname"/>
                    </substitute_text>

                    <write_incoming_message title="$EmailTitle" text="{30500,11002}" source="if player.target then player.target else player.entity.container" highpriority="true" comment="Scaleplate Green Terraforming Wrap Email">
                      <cutscene key="'terraforming_scaleplate_green'"/>
                    </write_incoming_message>
                  </actions>
                </cue>

                <cue name="Terraforming_ScalePlateGreen_Contact_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$ScalePlate_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30503003]]"/>
                  <param name="MissionCue"        value="Terraforming_ScalePlateGreen_CreateMission"/>
                </cue>

                <library name="Terraforming_ScalePlateGreen_TransferJobShipToPlayer" purpose="run_actions">
                  <params>
                    <param name="Ship"/>
                    <param name="AddCrew"/>
                  </params>
                  <actions>
                    <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                      <param name="Ship" value="$Ship"/>
                      <param name="Faction" value="faction.player"/>
                    </run_actions>
                    <set_known object="$Ship.sector" known="true"/>
                    <set_known object="$Ship.cluster" known="true"/>
                    <!--cancel default order, but not current order; by default they should finish what they're currently doing-->
                    <cancel_order order="$Ship.defaultorder"/>
                    <!--make pilot very skilled-->
                    <set_skill entity="$Ship.pilot" type="skilltype.boarding" min="1" max="9"/>
                    <set_skill entity="$Ship.pilot" type="skilltype.engineering" min="1" max="9"/>
                    <set_skill entity="$Ship.pilot" type="skilltype.management" min="1" max="9"/>
                    <set_skill entity="$Ship.pilot" type="skilltype.piloting" min="13" max="15"/>
                    <set_skill entity="$Ship.pilot" type="skilltype.morale" min="13" max="15"/>
                    <!--remove existing crew-->
                    <do_for_each in="$Ship.people.{entityrole.service}.list" name="$Crew">
                      <remove_npc_template template="$Crew" object="$Ship"/>
                    </do_for_each>
                    <do_for_each in="$Ship.people.{entityrole.marine}.list" name="$Crew">
                      <remove_npc_template template="$Crew" object="$Ship"/>
                    </do_for_each>
                    <do_if value="$AddCrew">
                      <!--add a small and random amount of skilled crew-->
                      <do_all min="0" max="2">
                        <get_character_definition macro="$Macro" faction="faction.scaleplate" tags="tag.service"/>
                        <create_npc_template name="$Crew" object="$Ship" macro="$Macro" role="entityrole.service"/>
                        <do_if value="$Crew">
                          <set_skill object="$Ship" template="$Crew" type="skilltype.boarding" min="1" max="9"/>
                          <set_skill object="$Ship" template="$Crew" type="skilltype.engineering" min="13" max="15"/>
                          <set_skill object="$Ship" template="$Crew" type="skilltype.management" min="1" max="9"/>
                          <set_skill object="$Ship" template="$Crew" type="skilltype.piloting" min="1" max="9"/>
                          <set_skill object="$Ship" template="$Crew" type="skilltype.morale" min="13" max="15"/>
                        </do_if>
                      </do_all>
                      <do_all min="0" max="2">
                        <get_character_definition macro="$Macro" faction="faction.scaleplate" tags="tag.marine"/>
                        <create_npc_template name="$Crew" object="$Ship" macro="$Macro" role="entityrole.marine"/>
                        <do_if value="$Crew">
                          <set_skill object="$Ship" template="$Crew" type="skilltype.boarding" min="13" max="15"/>
                          <set_skill object="$Ship" template="$Crew" type="skilltype.engineering" min="1" max="9"/>
                          <set_skill object="$Ship" template="$Crew" type="skilltype.management" min="1" max="9"/>
                          <set_skill object="$Ship" template="$Crew" type="skilltype.piloting" min="1" max="9"/>
                          <set_skill object="$Ship" template="$Crew" type="skilltype.morale" min="13" max="15"/>
                        </do_if>
                      </do_all>
                    </do_if>
                    <!--give the ship a very good loadout (variation is not to reduce value but to not have all ships identically equipped)-->
                    <generate_loadout result="$Loadout" macro="$Ship.macro" level="0.9" variation="0.1"/>
                    <apply_loadout object="$Ship" loadout="$Loadout.{1}"/>
                    <!--add some mods-->
                    <add_equipment_mods object="$Ship">
                      <engine ware="[ware.mod_engine_forwardthrust_01_mk3, ware.mod_engine_rotationthrust_01_mk3, ware.mod_engine_boostthrust_01_mk3, ware.mod_engine_travelthrust_01_mk3].random"/>
                    </add_equipment_mods>
                    <add_equipment_mods object="$Ship">
                      <ship ware="[ware.mod_ship_drag_01_mk2, ware.mod_ship_mass_01_mk3, ware.mod_ship_maxhull_01_mk1, ware.mod_ship_radarrange_01_mk1].random"/>
                    </add_equipment_mods>
                    <add_equipment_mods object="$Ship">
                      <shield ware="[ware.mod_shield_capacity_01_mk3, ware.mod_shield_capacity_02_mk3, ware.mod_shield_rechargedelay_01_mk1, ware.mod_shield_rechargerate_01_mk3].random"/>
                    </add_equipment_mods>
                    <do_for_each in="$Ship.weapons.all.list" name="$Weapon">
                      <do_if value="$Weapon.grouptag">
                        <debug_text text="'Weapon: ' + $Weapon.knownname + ' in group ' + $Weapon.grouptag"/>
                        <add_equipment_mods object="$Ship">
                          <weapon ware="[ware.mod_weapon_damage_01_mk3, ware.mod_weapon_damage_02_mk3, ware.mod_weapon_rotationspeed_01_mk1].random" context="'..'" group="$Weapon.grouptag"/>
                        </add_equipment_mods>
                      </do_if>
                      <do_else>
                        <debug_text text="'Weapon: ' + $Weapon.knownname"/>
                        <add_equipment_mods object="$Ship">
                          <weapon ware="[ware.mod_weapon_damage_01_mk3, ware.mod_weapon_damage_02_mk3, ware.mod_weapon_surfaceelement_01_mk3, ware.mod_weapon_cooling_04_mk2, ware.mod_weapon_cooling_05_mk2].random" macro="$Weapon.macro"/>
                        </add_equipment_mods>
                      </do_else>
                    </do_for_each>
                  </actions>
                </library>

                <cue name="Terraforming_ScalePlateGreen_TransferJobShipsToPlayer">
                  <actions>
                    <cancel_cue cue="Terraforming_ScalePlateGreen_Commandeer_Plunderers"/>
                    <do_for_each in="$CommandeeredLPlunderers" name="$Ship">
                      <release_commandeered_object object="$Ship"/>
                    </do_for_each>
                    <remove_value name="$CommandeeredLPlunderers"/>
                    <add_faction_relation faction="faction.scaleplate" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.2"/>
                    <find_ship name="$Plunderers_L" space="player.galaxy" job="'scaleplate_plunderer_l_cluster'" multiple="true"/>
                    <find_ship name="$Plunderers_M" space="player.galaxy" job="'scaleplate_plunderer_m_cluster'" multiple="true"/>
                    <do_for_each in="$Plunderers_L" name="$Ship" counter="$i">
                      <!--leave 1 ship for the new job-->
                      <do_if value="$i > 1">
                        <run_actions ref="Terraforming_ScalePlateGreen_TransferJobShipToPlayer">
                          <param name="Ship" value="$Ship"/>
                          <param name="AddCrew" value="true"/>
                        </run_actions>
                      </do_if>
                    </do_for_each>
                    <do_for_each in="$Plunderers_M" name="$Ship" counter="$i">
                      <run_actions ref="Terraforming_ScalePlateGreen_TransferJobShipToPlayer">
                        <param name="Ship" value="$Ship"/>
                        <param name="AddCrew" value="false"/>
                      </run_actions>
                    </do_for_each>
                    <remove_value name="$Plunderers_L"/>
                    <remove_value name="$Plunderers_M"/>
                    <set_job_active job="'scaleplate_plunderer_l_cluster'" activate="false" successor="'scaleplate_plunderer_l_cluster_reduced'"/>
                    <set_job_active job="'scaleplate_plunderer_m_cluster'" activate="false"/>
                    <set_job_active job="'scaleplate_plunderer_l_cluster_reduced'" activate="true"/>
                    <!--disabling 7.0 aggressive/anarchy pirates-->
                    <set_job_active job="'scaleplate_patrol_s_cluster_anarchy_aggresive'" activate="false"/>
                    <set_job_active job="'scaleplate_patrol_m_cluster_anarchy_aggresive'" activate="false"/>
                    <set_job_active job="'scaleplate_patrol_l_cluster_anarchy_aggresive'" activate="false"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="DEBUG_Terraforming_ScalePlateGreen" onfail="cancel">
              <conditions>
                <check_value value="$DebugWarpCues?"/>
              </conditions>
              <delay exact="1ms"/>
              <actions>
                <append_to_list name="$DebugWarpCues" exact="DEBUG_Terraforming_ScalePlateGreen_WarpPlayerShip"/>
                <append_to_list name="$DebugSetStatsCues" exact="DEBUG_Terraforming_ScalePlateGreen_SetEndStats"/>
              </actions>
              <cues>
                <cue name="DEBUG_Terraforming_ScalePlateGreen_WarpPlayerShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="DEBUG_Terraforming_WarpPlayerShip">
                      <param name="Cluster" value="$Cluster_ScalePlateGreen"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="DEBUG_Terraforming_ScalePlateGreen_SetEndStats">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'temperature'" value="4"/>
                    <set_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'oxygen'" value="9"/>
                    <set_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'carbondioxide'" value="0"/>
                    <set_terraforming_stat cluster="$Cluster_ScalePlateGreen" id="'radioactivity'" value="0"/>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_BlackHoleSun" version="1">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="not $Cluster_BlackHoleSun_Completed?">
              <find_cluster name="$Cluster_BlackHoleSun" macro="macro.cluster_06_macro"/>
              <add_to_group groupname="$TerraformingClusters" object="$Cluster_BlackHoleSun"/>
              <append_to_list name="$OfferCues" exact="Terraforming_BlackHoleSun_CreateOffer"/>
              <signal_cue cue="Refresh_Offers" check="false"/>
              <initialise_terraforming cluster="$Cluster_BlackHoleSun" partname="'planet001b'"/>
              <!--Set initial stats-->
              <set_terraforming_stat cluster="$Cluster_BlackHoleSun" id="'temperature'" value="6"/>
              <set_terraforming_stat cluster="$Cluster_BlackHoleSun" id="'oxygen'" value="0"/>
              <set_terraforming_stat cluster="$Cluster_BlackHoleSun" id="'methane'" value="1"/>
              <set_terraforming_stat cluster="$Cluster_BlackHoleSun" id="'humidity'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_BlackHoleSun" id="'population'" value="0"/>
              <set_value name="$GlobalWarmingLimitTable.{$Cluster_BlackHoleSun}" exact="6"/>
              <set_value name="$AddedAtmoPressureTable.{$Cluster_BlackHoleSun}" exact="0" comment="1 methane / 4"/>
              <!--Set up projects-->
              <run_actions ref="SetupGeneralProjects">
                <param name="Cluster" value="$Cluster_BlackHoleSun"/>
                <param name="EnergyProject" value="'pwr_wind'"/>
                <param name="GlobalWarmingLimit" value="6"/>
              </run_actions>
              <add_terraforming_project cluster="$Cluster_BlackHoleSun" id="'ame_resort_tropical'"/>
              <set_value name="$Terraforming_BlackHoleSun_HousingTargetAmount" exact="100000000"/>
              <!--Create mission characters-->
              <create_cue_actor name="$Argon_Contact_1" cue="namespace" macro="character_argon_female_terraforming_arg_contact_macro">
                <page exact="10108"/>
                <owner exact="faction.argon"/>
                <skills>
                  <skill type="management"  exact="15"/>
                  <skill type="morale"      exact="15"/>
                  <skill type="piloting"    exact="2"/>
                  <skill type="engineering" exact="4"/>
                  <skill type="boarding"    exact="0"/>
                </skills>
              </create_cue_actor>
              <set_entity_traits entity="$Argon_Contact_1" missionactor="true"/>
              <create_cue_actor name="$Argon_Computer" cue="namespace" macro="character_computer_terraforming_arg_contact_macro">
                <page exact="10156"/>
                <owner exact="faction.argon"/>
                <skills>
                  <skill type="management"  exact="6"/>
                  <skill type="morale"      exact="0"/>
                  <skill type="piloting"    exact="0"/>
                  <skill type="engineering" exact="0"/>
                  <skill type="boarding"    exact="0"/>
                </skills>
              </create_cue_actor>
              <set_entity_traits entity="$Argon_Computer" missionactor="true"/>
            </do_if>
          </actions>
          <patch sinceversion="1">
            <do_if value="$Cluster_BlackHoleSun.terraforming.stat.airpressure.exists">
              <remove_terraforming_stat cluster="$Cluster_BlackHoleSun" id="'airpressure'"/>
              <debug_text text="'Removed airpressure from $Cluster_BlackHoleSun - test: ' + $Cluster_BlackHoleSun.terraforming.stat.airpressure.exists"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Terraforming_BlackHoleSun_CreateOffer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating offer for cue Terraforming_BlackHoleSun_CreateMission'" chance="$DebugChance"/>
                <do_if value="$HQ.hasbeenrenamed">
                  <set_value name="$HQName" exact="$HQ.knownname"/>
                </do_if>
                <do_else>
                  <set_value name="$HQName" exact="{20102,2011}"/>
                </do_else>
                <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                  <replace string="'$STATION$'" with="$HQName"/>
                  <replace string="'$LOCATION$'" with="$Cluster_BlackHoleSun.knownname"/>
                </substitute_text>
                <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                  <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_BlackHoleSun_HousingTargetAmount]"/>
                </substitute_text>
                <create_offer cue="Terraforming_BlackHoleSun_CreateMission" type="missiontype.think" actor="$BosoTa" difficulty="level.veryhard" faction="faction.argon" group="missiongroup.terraforming" name="{30507,1000}" description="{30507,1001}" rewardtext="{30507,1002}">
                  <briefing>
                    <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_BlackHoleSun"/>
                    <objective step="2" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name"/>
                    <objective step="3" action="objective.build_housing" text="$HousingObjectiveText"/>
                  </briefing>
                </create_offer>
                <remove_value name="$RelocateObjectiveText"/>
                <remove_value name="$HousingObjectiveText"/>
              </actions>
            </cue>

            <cue name="Terraforming_BlackHoleSun_CreateMission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating mission for cue Terraforming_BlackHoleSun_CreateMission'" chance="$DebugChance"/>
                <create_mission cue="Terraforming_BlackHoleSun_CreateMission" offercue="Terraforming_BlackHoleSun_CreateMission"/>
                <set_terraforming_mission_activated cluster="$Cluster_BlackHoleSun" missioncue="Terraforming_BlackHoleSun_CreateMission"/>
                <!--TODO: check current state, mark objectives as complete when appropriate-->
                <remove_offer cue="Terraforming_BlackHoleSun_CreateMission"/>
                <set_value name="$AcceptedOfferCue" exact="Terraforming_BlackHoleSun_CreateOffer"/>
                <do_if value="@$AbortMissionCue">
                  <signal_cue cue="$AbortMissionCue"/>
                </do_if>
                <set_value name="$AbortMissionCue" exact="Terraforming_BlackHoleSun_AbortMission"/>
                <set_value name="$OptionalSteps" exact="0"/>
              </actions>
              <cues>
                <!--TODO: either use a different cutscene or change how the call happens-->
                <cue name="Terraforming_BlackHoleSun_Intro_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Argon_Computer"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterArgon']"/>
                  <param name="Lines"             value="[[30507001]]"/>
                  <param name="MissionCue"        value="Terraforming_BlackHoleSun_CreateMission"/>
                </cue>

                <cue name="Terraforming_BlackHoleSun_AbortMission">
                  <conditions>
                    <check_any>
                      <event_mission_aborted cue="Terraforming_BlackHoleSun_CreateMission"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Removing mission for cue Terraforming_BlackHoleSun_CreateMission'" chance="$DebugChance"/>
                    <remove_mission cue="Terraforming_BlackHoleSun_CreateMission"/>
                    <remove_value name="$AcceptedOfferCue"/>
                    <remove_value name="$AbortMissionCue"/>
                    <set_terraforming_mission_deactivated cluster="$Cluster_BlackHoleSun"/>
                    <reset_cue cue="Terraforming_BlackHoleSun_CreateMission"/>
                    <reset_cue cue="Terraforming_BlackHoleSun_CreateOffer"/>
                    <signal_cue cue="Refresh_Offers"/>
                  </actions>
                </cue>

                <cue name="Terraforming_BlackHoleSun_Init_ObjectiveManager" version="4">
                  <actions>
                    <do_if value="not $Cluster_BlackHoleSun_Completed?">

                      <do_if value="$HQ.cluster != $Cluster_BlackHoleSun">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="1"/>
                        </do_if>
                        <set_value name="$RelocateComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$RelocateComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_BlackHoleSun.terraforming.project.agr_fields_wheat.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="2"/>
                        </do_if>
                        <set_value name="$WheatFieldsComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$WheatFieldsComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_BlackHoleSun.terraforming.stat.population.value lt $Terraforming_BlackHoleSun_HousingTargetAmount">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="3"/>
                        </do_if>
                        <set_value name="$HousingComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HousingComplete" exact="true"/>
                      </do_else>

                      <do_if value="$HQ.hasbeenrenamed">
                        <set_value name="$HQName" exact="$HQ.knownname"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HQName" exact="{20102,2011}"/>
                      </do_else>
                      <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                        <replace string="'$STATION$'" with="$HQName"/>
                        <replace string="'$LOCATION$'" with="$Cluster_BlackHoleSun.knownname"/>
                      </substitute_text>
                      <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                        <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_BlackHoleSun_HousingTargetAmount]"/>
                      </substitute_text>

                      <do_if value="not $HQ.canbuildclass.{class.ship_s}">
                        <update_mission cue="Terraforming_BlackHoleSun_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.build_module" object="$HQ" text="{20104,61301}" comment="Build S/M Ship Fabrication Module"/>
                            <objective step="2" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_BlackHoleSun" completed="$RelocateComplete"/>
                            <objective step="3" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name" completed="$WheatFieldsComplete"/>
                            <objective step="4" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="not $BuildObjective?">
                          <set_value name="$OptionalSteps" operation="add" exact="1"/>
                          <set_value name="$BuildObjective"/>
                          <signal_cue cue="Terraforming_BlackHoleSun_Trigger_BuildModule_Objective"/>
                        </do_if>
                        <set_objective_from_briefing cue="Terraforming_BlackHoleSun_CreateMission" step="1"/>
                      </do_if>
                      <do_else>
                        <do_if value="$BuildObjective?">
                          <set_value name="$OptionalSteps" operation="subtract" exact="1"/>
                          <remove_value name="$BuildObjective"/>
                        </do_if>
                        <update_mission cue="Terraforming_BlackHoleSun_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_BlackHoleSun" completed="$RelocateComplete"/>
                            <objective step="2" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name" completed="$WheatFieldsComplete"/>
                            <objective step="3" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="$OptionalSteps ge 1">
                          <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        </do_if>
                        <do_else>
                          <set_value name="$OptionalSteps" exact="0"/>
                        </do_else>
                        <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        <set_objective_from_briefing cue="Terraforming_BlackHoleSun_CreateMission" step="$ProjectStep"/>
                      </do_else>

                      <remove_value name="$ProjectStep"/>
                      <remove_value name="$RelocateObjectiveText"/>
                      <remove_value name="$HousingObjectiveText"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$OptionalSteps" exact="0"/>
                    <reset_cue cue="Terraforming_BlackHoleSun_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="3">
                    <reset_cue cue="Terraforming_BlackHoleSun_Trigger_BuildModule_Objective"/>
                    <reset_cue cue="Terraforming_BlackHoleSun_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="4">
                    <reset_cue cue="Terraforming_BlackHoleSun_Init_ObjectiveManager"/>
                  </patch>
                </cue>

                <cue name="Terraforming_BlackHoleSun_BuildModule_Check">
                  <actions>
                    <find_object_component groupname="$WharfModules" object="$HQ" class="class.buildmodule">
                      <match_any>
                        <match canbuildclass="class.ship_m"/>
                        <match canbuildclass="class.ship_s"/>
                      </match_any>
                    </find_object_component>
                  </actions>
                  <cues>
                    <cue name="Terraforming_BlackHoleSun_BuildModuleDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$WharfModules"/>
                        <check_value value="$WharfModules.count == 1" comment="trigger another check when the last build module is destroyed"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Terraforming_BlackHoleSun_ObjectiveUpdate" param="['RequestBuildModule']"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Terraforming_BlackHoleSun_ObjectiveUpdate" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_terraforming_stat_changed cluster="$Cluster_BlackHoleSun"/>
                      <event_terraforming_project_succeeded cluster="$Cluster_BlackHoleSun"/>
                      <event_object_changed_cluster object="$HQ"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="typeof event.param == datatype.list ">
                      <do_if value="event.param.{1} == 'ModulesGroup'" comment="make sure the signal came from CheckStation_BuildModule">
                        <add_to_group groupname="$WharfModules" group="event.param.{2}"/>
                      </do_if>
                    </do_if>
                    <reset_cue cue="Terraforming_BlackHoleSun_Init_ObjectiveManager"/>
                  </actions>
                </cue>

                <cue name="Terraforming_BlackHoleSun_Trigger_BuildModule_Objective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Terraforming_BlackHoleSun_BuildModule" ref="AdditionalObjective_BuildModule">
                      <!-- Required to Signal the Update Cue when Building is finished -->
                      <param name="UpdateCue" value="Terraforming_BlackHoleSun_ObjectiveUpdate"/>
                      <param name="Station" value="$HQ"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <!--Objective cues-->

            <cue name="Terraforming_BlackHoleSun_Milestone_1">
              <conditions>
                <event_terraforming_project_succeeded cluster="$Cluster_BlackHoleSun"/>
              </conditions>
              <cues>
                <!--TODO: either use a different cutscene or change how the call happens-->
                <cue name="Terraforming_BlackHoleSun_Contact_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Argon_Computer"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterArgon']"/>
                  <param name="Lines"             value="[[30507002]]"/>
                  <param name="MissionCue"        value="Terraforming_BlackHoleSun_CreateMission"/>
                </cue>

                <cue name="Terraforming_BlackHoleSun_Contact_1_SpeakFinished" instantiate="true">
                  <conditions>
                    <event_speak_finished actor="$Argon_Computer" line="30507002"/>
                  </conditions>
                  <actions>
                    <substitute_text text="$message" source="{1015,8}">
                      <replace string="'$MONEY$'" with="(0Cr).formatted.default" />
                      <replace string="'$MONEY2$'" with="player.money.formatted.default" />
                    </substitute_text>
                    <show_notification text="$message" sound="ui_mon_eve_money_up" />
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_BlackHoleSun_Milestone_2">
              <conditions>
                <event_terraforming_stat_changed cluster="$Cluster_BlackHoleSun"/>
                <check_value value="$Cluster_BlackHoleSun.terraforming.habitable"/>
              </conditions>
              <cues>
                <cue name="Terraforming_BlackHoleSun_Contact_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Argon_Contact_1"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30507001]]"/>
                  <param name="MissionCue"        value="Terraforming_BlackHoleSun_CreateMission"/>
                </cue>

                <cue name="Terraforming_BlackHoleSun_Contact_2_SpeakFinished">
                  <conditions>
                    <event_speak_finished actor="$Argon_Contact_1" line="30507001"/>
                  </conditions>
                  <delay exact="1min"/>
                  <actions>
                    <write_incoming_message source="{30507,101}" title="{30507,4003}" text="{30507,4001}"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_BlackHoleSun_MissionComplete" version="5">
              <conditions>
                <check_any>
                  <event_terraforming_stat_changed cluster="$Cluster_BlackHoleSun" stat="'population'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_BlackHoleSun" project="'agr_fields_wheat'"/>
                </check_any>
                <check_value value="$Cluster_BlackHoleSun.terraforming.stat.population.value ge $Terraforming_BlackHoleSun_HousingTargetAmount"/>
                <check_value value="$Cluster_BlackHoleSun.terraforming.project.agr_fields_wheat.complete"/>
              </conditions>
              <actions>
                <cancel_cue cue="Terraforming_BlackHoleSun_ObjectiveUpdate"/>
                <add_faction_relation faction="faction.argon" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.1"/>
                <write_incoming_message source="{30507,102}" title="{30507,4004}" text="{30507,4002}"/>
                <!--make Menika Giorno a player employee and put her somewhere on the HQ-->
                <find_npc_slot name="$NPC_Slot" object="$HQ"/>
                <add_actor_to_room actor="$Argon_Contact_1" slot="$NPC_Slot"/>
                <set_entity_traits entity="$Argon_Contact_1" missionactor="true"/>
                <set_owner object="$Argon_Contact_1" faction="faction.player"/>
                <remove_from_list name="$OfferCues" exact="Terraforming_BlackHoleSun_CreateOffer"/>
                <remove_value name="$AbortMissionCue"/>
                <remove_mission cue="Terraforming_BlackHoleSun_CreateMission" type="completed"/>
                <set_world_settlements cluster="$Cluster_BlackHoleSun" partname="'planet001b'" page="1042" line="16041" comment="Multiple Cities"/>
                <set_value name="$Cluster_BlackHoleSun_Completed"/>
                <set_terraforming_mission_completed cluster="$Cluster_BlackHoleSun"/>
                <unlock_achievement name="TERRAFORMING_MISSION"/>
                <set_value name="stat.terraforming_missions_completed" operation="add"/>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_black_hole_sun"/>
              </actions>
              <patch sinceversion="2">
                <remove_from_list name="$OfferCues" exact="Terraforming_BlackHoleSun_CreateOffer" multiple="false" />
              </patch>
              <patch sinceversion="3">
                <set_terraforming_mission_completed cluster="$Cluster_BlackHoleSun"/>
              </patch>
              <patch sinceversion="4">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_black_hole_sun"/>
              </patch>
              <patch sinceversion="5" state="complete">
                <set_world_settlements cluster="$Cluster_BlackHoleSun" partname="'planet001b'" page="1042" line="16041" comment="Multiple Cities"/>
              </patch>
              <cues>
                <cue name="Terraforming_BlackHoleSun_VideoEmail">
                  <actions>
                    <substitute_text text="$EmailTitle" source="{30500,11001}">
                      <replace string="'$CLUSTERNAME$'" with="$Cluster_BlackHoleSun.knownname"/>
                    </substitute_text>

                    <write_incoming_message title="$EmailTitle" text="{30500,11002}" source="if player.target then player.target else player.entity.container" highpriority="true" comment="Black Hole Sun Terraforming Wrap Email">
                      <cutscene key="'terraforming_black_hole_sun'"/>
                    </write_incoming_message>
                  </actions>
                </cue>

                <!--TODO: either use a different cutscene or change how the call happens-->
                <cue name="Terraforming_BlackHoleSun_Report_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Argon_Computer"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterArgon']"/>
                  <param name="Lines"             value="[[30507003]]"/>
                  <param name="MissionCue"        value="Terraforming_BlackHoleSun_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="DEBUG_Terraforming_BlackHoleSun" onfail="cancel">
              <conditions>
                <check_value value="$DebugWarpCues?"/>
              </conditions>
              <delay exact="1ms"/>
              <actions>
                <append_to_list name="$DebugWarpCues" exact="DEBUG_Terraforming_BlackHoleSun_WarpPlayerShip"/>
                <append_to_list name="$DebugSetStatsCues" exact="DEBUG_Terraforming_BlackHoleSun_SetEndStats"/>
              </actions>
              <cues>
                <cue name="DEBUG_Terraforming_BlackHoleSun_WarpPlayerShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="DEBUG_Terraforming_WarpPlayerShip">
                      <param name="Cluster" value="$Cluster_BlackHoleSun"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="DEBUG_Terraforming_BlackHoleSun_SetEndStats">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_terraforming_stat cluster="$Cluster_BlackHoleSun" id="'oxygen'" value="9"/>
                    <set_terraforming_stat cluster="$Cluster_BlackHoleSun" id="'methane'" value="0"/>
                    <set_terraforming_stat cluster="$Cluster_BlackHoleSun" id="'humidity'" value="4"/>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_GetsuFune" version="1">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="not $Cluster_GetsuFune_Completed?">
              <find_cluster name="$Cluster_GetsuFune" macro="macro.cluster_48_macro"/>
              <add_to_group groupname="$TerraformingClusters" object="$Cluster_GetsuFune"/>
              <append_to_list name="$OfferCues" exact="Terraforming_GetsuFune_CreateOffer"/>
              <signal_cue cue="Refresh_Offers" check="false"/>
              <initialise_terraforming cluster="$Cluster_GetsuFune" partname="'planet001c'"/>
              <!--Set initial stats-->
              <set_terraforming_stat cluster="$Cluster_GetsuFune" id="'oxygen'" value="6"/>
              <set_terraforming_stat cluster="$Cluster_GetsuFune" id="'toxicity'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_GetsuFune" id="'population'" value="0"/>
              <set_value name="$AddedAtmoPressureTable.{$Cluster_GetsuFune}" exact="1" comment="6 oxygen / 4"/>
              <!--Set up projects-->
              <run_actions ref="SetupGeneralProjects">
                <param name="Cluster" value="$Cluster_GetsuFune"/>
                <param name="Biosphere" value="false"/>
              </run_actions>
              <add_terraforming_project cluster="$Cluster_GetsuFune" id="'bio_toxicfruit_genemod'"/>
              <add_terraforming_project cluster="$Cluster_GetsuFune" id="'bio_toxicfruit_cull'"/>
              <add_terraforming_project cluster="$Cluster_GetsuFune" id="'ame_zoo'"/>
              <add_terraforming_project cluster="$Cluster_GetsuFune" id="'agr_vineyards'">
                <predecessors any="true">
                  <predecessor id="'bio_toxicfruit_genemod'"/>
                  <predecessor id="'bio_toxicfruit_cull'"/>
                </predecessors>
              </add_terraforming_project>
              <set_value name="$Terraforming_GetsuFune_HousingTargetAmount" exact="250000000"/>
              <!--Create mission character-->
              <signal_cue cue="Terraforming_Create_Antigone_Reporter" check="false"/>
            </do_if>
          </actions>
          <patch sinceversion="1">
            <do_if value="$Cluster_GetsuFune.terraforming.stat.airpressure.exists">
              <remove_terraforming_stat cluster="$Cluster_GetsuFune" id="'airpressure'"/>
              <debug_text text="'Removed airpressure from $Cluster_GetsuFune - test: ' + $Cluster_GetsuFune.terraforming.stat.airpressure.exists"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Terraforming_GetsuFune_CreateOffer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating offer for cue Terraforming_GetsuFune_CreateMission'" chance="$DebugChance"/>
                <do_if value="$HQ.hasbeenrenamed">
                  <set_value name="$HQName" exact="$HQ.knownname"/>
                </do_if>
                <do_else>
                  <set_value name="$HQName" exact="{20102,2011}"/>
                </do_else>
                <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                  <replace string="'$STATION$'" with="$HQName"/>
                  <replace string="'$LOCATION$'" with="$Cluster_GetsuFune.knownname"/>
                </substitute_text>
                <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                  <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_GetsuFune_HousingTargetAmount]"/>
                </substitute_text>
                <create_offer cue="Terraforming_GetsuFune_CreateMission" type="missiontype.think" actor="$BosoTa" difficulty="level.hard" faction="faction.antigone" group="missiongroup.terraforming" name="{30504,1000}" description="{30504,1001}" rewardtext="{30504,1003}">
                  <briefing>
                    <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_GetsuFune"/>
                    <objective step="2" action="objective.neutralize" text="terraforming.stat.toxicity.name"/>
                    <objective step="3" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name"/>
                    <objective step="4" action="objective.build_housing" text="$HousingObjectiveText"/>
                    <objective step="5" action="objective.build_project" text="terraforming.project.agr_vineyards.name"/>
                    <objective step="6" action="objective.build_project" text="terraforming.project.ame_finedining.name"/>
                  </briefing>
                </create_offer>
                <remove_value name="$RelocateObjectiveText"/>
                <remove_value name="$HousingObjectiveText"/>
              </actions>
            </cue>

            <cue name="Terraforming_GetsuFune_CreateMission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating mission for cue Terraforming_GetsuFune_CreateMissionoffer'" chance="$DebugChance"/>
                <create_mission cue="Terraforming_GetsuFune_CreateMission" offercue="Terraforming_GetsuFune_CreateMission"/>
                <set_terraforming_mission_activated cluster="$Cluster_GetsuFune" missioncue="Terraforming_GetsuFune_CreateMission"/>
                <!--TODO: check current state, mark objectives as complete when appropriate-->
                <remove_offer cue="Terraforming_GetsuFune_CreateMission"/>
                <set_value name="$AcceptedOfferCue" exact="Terraforming_GetsuFune_CreateOffer"/>
                <do_if value="@$AbortMissionCue">
                  <signal_cue cue="$AbortMissionCue"/>
                </do_if>
                <set_value name="$AbortMissionCue" exact="Terraforming_GetsuFune_AbortMission"/>
                <set_value name="$OptionalSteps" exact="0"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1049}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <cues>
                <cue name="Terraforming_GetsuFune_Intro_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterAntigone']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[if @$AntigoneTerraformed then 30500002 else 30500001],[30504001]]"/>
                  <param name="MissionCue"        value="Terraforming_GetsuFune_CreateMission"/>
                </cue>

                <cue name="Terraforming_GetsuFune_AbortMission">
                  <conditions>
                    <check_any>
                      <event_mission_aborted cue="Terraforming_GetsuFune_CreateMission"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Removing mission for cue Terraforming_GetsuFune_CreateMission'" chance="$DebugChance"/>
                    <remove_mission cue="Terraforming_GetsuFune_CreateMission"/>
                    <remove_value name="$AcceptedOfferCue"/>
                    <remove_value name="$AbortMissionCue"/>
                    <set_terraforming_mission_deactivated cluster="$Cluster_GetsuFune"/>
                    <reset_cue cue="Terraforming_GetsuFune_CreateMission"/>
                    <reset_cue cue="Terraforming_GetsuFune_CreateOffer"/>
                    <signal_cue cue="Refresh_Offers"/>
                  </actions>
                </cue>

                <cue name="Terraforming_GetsuFune_Init_ObjectiveManager" version="4">
                  <actions>
                    <do_if value="not $Cluster_GetsuFune_Completed?">

                      <do_if value="$HQ.cluster != $Cluster_GetsuFune">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="1"/>
                        </do_if>
                        <set_value name="$RelocateComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$RelocateComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_GetsuFune.terraforming.stat.toxicity.state != 0">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="2"/>
                        </do_if>
                        <set_value name="$ToxicityComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$ToxicityComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_GetsuFune.terraforming.project.agr_fields_wheat.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="3"/>
                        </do_if>
                        <set_value name="$FieldsComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$FieldsComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_GetsuFune.terraforming.stat.population.value lt $Terraforming_GetsuFune_HousingTargetAmount">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="4"/>
                        </do_if>
                        <set_value name="$PopulationComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$PopulationComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_GetsuFune.terraforming.project.agr_vineyards.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="5"/>
                        </do_if>
                        <set_value name="$VineyardsComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$VineyardsComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_GetsuFune.terraforming.project.ame_finedining.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="6"/>
                        </do_if>
                        <set_value name="$FineDiningComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$FineDiningComplete" exact="true"/>
                      </do_else>

                      <do_if value="$HQ.hasbeenrenamed">
                        <set_value name="$HQName" exact="$HQ.knownname"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HQName" exact="{20102,2011}"/>
                      </do_else>
                      <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                        <replace string="'$STATION$'" with="$HQName"/>
                        <replace string="'$LOCATION$'" with="$Cluster_GetsuFune.knownname"/>
                      </substitute_text>
                      <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                        <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_GetsuFune_HousingTargetAmount]"/>
                      </substitute_text>

                      <do_if value="not $HQ.canbuildclass.{class.ship_s}">
                        <update_mission cue="Terraforming_GetsuFune_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.build_module" object="$HQ" text="{20104,61301}" comment="Build S/M Ship Fabrication Module"/>
                            <objective step="2" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_GetsuFune" completed="$RelocateComplete"/>
                            <objective step="3" action="objective.neutralize" text="terraforming.stat.toxicity.name" completed="$ToxicityComplete"/>
                            <objective step="4" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name" completed="$FieldsComplete"/>
                            <objective step="5" action="objective.build_housing" text="$HousingObjectiveText" completed="$PopulationComplete"/>
                            <objective step="6" action="objective.build_project" text="terraforming.project.agr_vineyards.name" completed="$VineyardsComplete"/>
                            <objective step="7" action="objective.build_project" text="terraforming.project.ame_finedining.name" completed="$FineDiningComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="not $BuildObjective?">
                          <set_value name="$OptionalSteps" operation="add" exact="1"/>
                          <set_value name="$BuildObjective"/>
                          <signal_cue cue="Terraforming_GetsuFune_Trigger_BuildModule_Objective"/>
                        </do_if>
                        <set_objective_from_briefing cue="Terraforming_GetsuFune_CreateMission" step="1"/>
                      </do_if>
                      <do_else>
                        <do_if value="$BuildObjective?">
                          <set_value name="$OptionalSteps" operation="subtract" exact="1"/>
                          <remove_value name="$BuildObjective"/>
                        </do_if>
                        <update_mission cue="Terraforming_GetsuFune_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_GetsuFune" completed="$RelocateComplete"/>
                            <objective step="2" action="objective.neutralize" text="terraforming.stat.toxicity.name" completed="$ToxicityComplete"/>
                            <objective step="3" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name" completed="$FieldsComplete"/>
                            <objective step="4" action="objective.build_housing" text="$HousingObjectiveText" completed="$PopulationComplete"/>
                            <objective step="5" action="objective.build_project" text="terraforming.project.agr_vineyards.name" completed="$VineyardsComplete"/>
                            <objective step="6" action="objective.build_project" text="terraforming.project.ame_finedining.name" completed="$FineDiningComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="$OptionalSteps ge 1">
                          <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        </do_if>
                        <do_else>
                          <set_value name="$OptionalSteps" exact="0"/>
                        </do_else>
                        <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        <set_objective_from_briefing cue="Terraforming_GetsuFune_CreateMission" step="$ProjectStep"/>
                      </do_else>

                      <remove_value name="$ProjectStep"/>
                      <remove_value name="$RelocateObjectiveText"/>
                      <remove_value name="$HousingObjectiveText"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$OptionalSteps" exact="0"/>
                    <reset_cue cue="Terraforming_GetsuFune_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="3">
                    <reset_cue cue="Terraforming_GetsuFune_Trigger_BuildModule_Objective"/>
                    <reset_cue cue="Terraforming_GetsuFune_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="4">
                    <reset_cue cue="Terraforming_GetsuFune_Init_ObjectiveManager"/>
                  </patch>
                </cue>

                <cue name="Terraforming_GetsuFune_BuildModule_Check">
                  <actions>
                    <find_object_component groupname="$WharfModules" object="$HQ" class="class.buildmodule">
                      <match_any>
                        <match canbuildclass="class.ship_m"/>
                        <match canbuildclass="class.ship_s"/>
                      </match_any>
                    </find_object_component>
                  </actions>
                  <cues>
                    <cue name="Terraforming_GetsuFune_BuildModuleDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$WharfModules"/>
                        <check_value value="$WharfModules.count == 1" comment="trigger another check when the last build module is destroyed"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Terraforming_GetsuFune_ObjectiveUpdate" param="['RequestBuildModule']"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Terraforming_GetsuFune_ObjectiveUpdate" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_terraforming_stat_changed cluster="$Cluster_GetsuFune"/>
                      <event_terraforming_project_succeeded cluster="$Cluster_GetsuFune"/>
                      <event_object_changed_cluster object="$HQ"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="typeof event.param == datatype.list ">
                      <do_if value="event.param.{1} == 'ModulesGroup'" comment="make sure the signal came from CheckStation_BuildModule">
                        <add_to_group groupname="$WharfModules" group="event.param.{2}"/>
                      </do_if>
                    </do_if>
                    <reset_cue cue="Terraforming_GetsuFune_Init_ObjectiveManager"/>
                  </actions>
                </cue>

                <cue name="Terraforming_GetsuFune_Trigger_BuildModule_Objective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Terraforming_GetsuFune_BuildModule" ref="AdditionalObjective_BuildModule">
                      <!-- Required to Signal the Update Cue when Building is finished -->
                      <param name="UpdateCue" value="Terraforming_GetsuFune_ObjectiveUpdate"/>
                      <param name="Station" value="$HQ"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <!--Objective cues-->

            <cue name="Terraforming_GetsuFune_Milestone_1">
              <conditions>
                <check_any>
                  <event_terraforming_project_completed cluster="$Cluster_GetsuFune" project="'bio_toxicfruit_genemod'"/>
                  <event_terraforming_project_completed cluster="$Cluster_GetsuFune" project="'bio_toxicfruit_cull'"/>
                </check_any>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.antigone" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.01"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1049}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <cues>
                <cue name="Terraforming_GetsuFune_Contact_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterAntigone']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[30504002]]"/>
                  <param name="MissionCue"        value="Terraforming_GetsuFune_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_GetsuFune_Milestone_2">
              <conditions>
                <event_terraforming_stat_changed cluster="$Cluster_GetsuFune" stat="'population'"/>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.antigone" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.02"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1049}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <cues>
                <cue name="Terraforming_GetsuFune_Contact_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterAntigone']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[30504003]]"/>
                  <param name="MissionCue"        value="Terraforming_GetsuFune_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_GetsuFune_MissionComplete" version="5">
              <conditions>
                <check_any>
                  <event_terraforming_stat_changed cluster="$Cluster_GetsuFune"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_GetsuFune"/>
                </check_any>
                <check_value value="$Cluster_GetsuFune.terraforming.stat.population.value ge $Terraforming_GetsuFune_HousingTargetAmount"/>
                <check_value value="$Cluster_GetsuFune.terraforming.stat.toxicity.state == 0"/>
                <check_value value="$Cluster_GetsuFune.terraforming.project.agr_fields_wheat.complete"/>
                <check_value value="$Cluster_GetsuFune.terraforming.project.agr_vineyards.complete"/>
                <check_value value="$Cluster_GetsuFune.terraforming.project.ame_finedining.complete"/>
              </conditions>
              <actions>
                <cancel_cue cue="Terraforming_GetsuFune_ObjectiveUpdate"/>
                <set_value name="$AntigoneTerraformed" exact="true"/>
                <add_faction_relation faction="faction.antigone" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.1"/>
                <remove_from_list name="$OfferCues" exact="Terraforming_GetsuFune_CreateOffer"/>
                <remove_value name="$AbortMissionCue"/>
                <remove_mission cue="Terraforming_GetsuFune_CreateMission" type="completed"/>
                <set_value name="$Cluster_GetsuFune_Completed"/>
                <set_terraforming_mission_completed cluster="$Cluster_GetsuFune"/>
                <unlock_achievement name="TERRAFORMING_MISSION"/>
                <set_value name="stat.terraforming_missions_completed" operation="add"/>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_getsu_fune"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1060}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <patch sinceversion="2">
                <remove_from_list name="$OfferCues" exact="Terraforming_GetsuFune_CreateOffer" multiple="false" />
              </patch>
              <patch sinceversion="3">
                <set_terraforming_mission_completed cluster="$Cluster_GetsuFune"/>
              </patch>
              <patch sinceversion="4">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_getsu_fune"/>
              </patch>
              <patch sinceversion="5" state="complete">
                <set_world_settlements cluster="$Cluster_GetsuFune" partname="'planet001c'" page="1042" line="16041" comment="Multiple Cities"/>
              </patch>
              <cues>
                <cue name="Terraforming_GetsuFune_VideoEmail">
                  <actions>
                    <substitute_text text="$EmailTitle" source="{30500,11001}">
                      <replace string="'$CLUSTERNAME$'" with="$Cluster_GetsuFune.knownname"/>
                    </substitute_text>

                    <write_incoming_message title="$EmailTitle" text="{30500,11002}" source="if player.target then player.target else player.entity.container" highpriority="true" comment="Getsu Fune Terraforming Wrap Email">
                      <cutscene key="'terraforming_getsu_fune'"/>
                    </write_incoming_message>
                  </actions>
                </cue>

                <cue name="Terraforming_GetsuFune_Report_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterShiokaze']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[30504004]]"/>
                  <param name="MissionCue"        value="Terraforming_GetsuFune_CreateMission"/>
                </cue>

                <cue name="Terraforming_GetsuFune_Antigone_ActivateJobs">
                  <actions>
                    <debug_text text="'Enable New Patrol Job in Getsu Fune'"/>
                    <set_job_active job="'antigone_destroyer_patrol_l_getsu_fune'" activate="true" comment="Have Antigone create an additional Patrol exclusive to Getsu Fune"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="DEBUG_Terraforming_GetsuFune" onfail="cancel">
              <conditions>
                <check_value value="$DebugWarpCues?"/>
              </conditions>
              <delay exact="1ms"/>
              <actions>
                <append_to_list name="$DebugWarpCues" exact="DEBUG_Terraforming_GetsuFune_WarpPlayerShip"/>
                <append_to_list name="$DebugSetStatsCues" exact="DEBUG_Terraforming_GetsuFune_SetEndStats"/>
              </actions>
              <cues>
                <cue name="DEBUG_Terraforming_GetsuFune_WarpPlayerShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="DEBUG_Terraforming_WarpPlayerShip">
                      <param name="Cluster" value="$Cluster_GetsuFune"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="DEBUG_Terraforming_GetsuFune_SetEndStats">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_terraforming_stat cluster="$Cluster_GetsuFune" id="'oxygen'" value="9"/>
                    <set_terraforming_stat cluster="$Cluster_GetsuFune" id="'toxicity'" value="0"/>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_FrontierEdge">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="not $Cluster_FrontierEdge_Completed?">
              <find_cluster name="$Cluster_FrontierEdge" macro="macro.cluster_49_macro"/>
              <add_to_group groupname="$TerraformingClusters" object="$Cluster_FrontierEdge"/>
              <append_to_list name="$OfferCues" exact="Terraforming_FrontierEdge_CreateOffer"/>
              <signal_cue cue="Refresh_Offers" check="false"/>
              <initialise_terraforming cluster="$Cluster_FrontierEdge" partname="'planet001c'"/>
              <!--Set initial stats-->
              <set_terraforming_stat cluster="$Cluster_FrontierEdge" id="'temperature'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_FrontierEdge" id="'airpressure'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_FrontierEdge" id="'oxygen'" value="2"/>
              <set_terraforming_stat cluster="$Cluster_FrontierEdge" id="'seismicactivity'" value="1"/>
              <set_terraforming_stat cluster="$Cluster_FrontierEdge" id="'population'" value="0"/>
              <set_value name="$GlobalWarmingLimitTable.{$Cluster_FrontierEdge}" exact="4"/>
              <set_value name="$AddedAtmoPressureTable.{$Cluster_FrontierEdge}" exact="0" comment="2 oxygen / 4"/>
              <!--Set up projects-->
              <run_actions ref="SetupGeneralProjects">
                <param name="Cluster" value="$Cluster_FrontierEdge"/>
                <param name="GlobalWarmingLimit" value="4"/>
              </run_actions>
              <add_terraforming_project cluster="$Cluster_FrontierEdge" id="'ame_resort_winter'"/>
              <set_value name="$Terraforming_FrontierEdge_HousingTargetAmount" exact="250000000"/>
              <add_terraforming_event cluster="$Cluster_FrontierEdge" id="'evt_quake_mild'"/>
              <add_terraforming_event cluster="$Cluster_FrontierEdge" id="'evt_quake_moderate'"/>
              <add_terraforming_event cluster="$Cluster_FrontierEdge" id="'evt_quake_severe'"/>
              <add_terraforming_event cluster="$Cluster_FrontierEdge" id="'evt_icemelt'"/>
              <!--Create mission character-->
              <signal_cue cue="Terraforming_Create_Antigone_Reporter" check="false"/>
            </do_if>
          </actions>
          <cues>
            <cue name="Terraforming_FrontierEdge_CreateOffer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating offer for cue Terraforming_FrontierEdge_CreateMission'" chance="$DebugChance"/>
                <do_if value="$HQ.hasbeenrenamed">
                  <set_value name="$HQName" exact="$HQ.knownname"/>
                </do_if>
                <do_else>
                  <set_value name="$HQName" exact="{20102,2011}"/>
                </do_else>
                <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                  <replace string="'$STATION$'" with="$HQName"/>
                  <replace string="'$LOCATION$'" with="$Cluster_FrontierEdge.knownname"/>
                </substitute_text>
                <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                  <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_FrontierEdge_HousingTargetAmount]"/>
                </substitute_text>
                <create_offer cue="Terraforming_FrontierEdge_CreateMission" type="missiontype.think" actor="$BosoTa" difficulty="level.veryhard" faction="faction.antigone" group="missiongroup.terraforming" name="{30505,1000}" description="{30505,1001}" rewardtext="{30505,1003}">
                  <briefing>
                    <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_FrontierEdge"/>
                    <objective step="2" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name"/>
                    <objective step="3" action="objective.build_housing" text="$HousingObjectiveText"/>
                    <objective step="4" action="objective.build_project" text="terraforming.project.ame_resort_winter.name"/>
                  </briefing>
                </create_offer>
                <remove_value name="$RelocateObjectiveText"/>
                <remove_value name="$HousingObjectiveText"/>
              </actions>
            </cue>

            <cue name="Terraforming_FrontierEdge_CreateMission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating mission for cue Terraforming_FrontierEdge_CreateMission'" chance="$DebugChance"/>
                <create_mission cue="Terraforming_FrontierEdge_CreateMission" offercue="Terraforming_FrontierEdge_CreateMission"/>
                <set_terraforming_mission_activated cluster="$Cluster_FrontierEdge" missioncue="Terraforming_FrontierEdge_CreateMission"/>
                <!--TODO: check current state, mark objectives as complete when appropriate-->
                <remove_offer cue="Terraforming_FrontierEdge_CreateMission"/>
                <set_value name="$AcceptedOfferCue" exact="Terraforming_FrontierEdge_CreateOffer"/>
                <do_if value="@$AbortMissionCue">
                  <signal_cue cue="$AbortMissionCue"/>
                </do_if>
                <set_value name="$AbortMissionCue" exact="Terraforming_FrontierEdge_AbortMission"/>
                <set_value name="$OptionalSteps" exact="0"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1049}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <cues>
                <cue name="Terraforming_FrontierEdge_Intro_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterAntigone']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[if @$AntigoneTerraformed then 30500002 else 30500001],[30505001]]"/>
                  <param name="MissionCue"        value="Terraforming_FrontierEdge_CreateMission"/>
                </cue>

                <cue name="Terraforming_FrontierEdge_AbortMission">
                  <conditions>
                    <check_any>
                      <event_mission_aborted cue="Terraforming_FrontierEdge_CreateMission"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Removing mission for cue Terraforming_FrontierEdge_CreateMission'" chance="$DebugChance"/>
                    <remove_mission cue="Terraforming_FrontierEdge_CreateMission"/>
                    <remove_value name="$AcceptedOfferCue"/>
                    <remove_value name="$AbortMissionCue"/>
                    <set_terraforming_mission_deactivated cluster="$Cluster_FrontierEdge"/>
                    <reset_cue cue="Terraforming_FrontierEdge_CreateMission"/>
                    <reset_cue cue="Terraforming_FrontierEdge_CreateOffer"/>
                    <signal_cue cue="Refresh_Offers"/>
                  </actions>
                </cue>

                <cue name="Terraforming_FrontierEdge_Init_ObjectiveManager" version="4">
                  <actions>
                    <do_if value="not $Cluster_FrontierEdge_Completed?">

                      <do_if value="$HQ.cluster != $Cluster_FrontierEdge">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="1"/>
                        </do_if>
                        <set_value name="$RelocateComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$RelocateComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_FrontierEdge.terraforming.project.agr_fields_wheat.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="2"/>
                        </do_if>
                        <set_value name="$WheatFieldsComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$WheatFieldsComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_FrontierEdge.terraforming.stat.population.value lt $Terraforming_FrontierEdge_HousingTargetAmount">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="3"/>
                        </do_if>
                        <set_value name="$HousingComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HousingComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_FrontierEdge.terraforming.project.ame_resort_winter.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="4"/>
                        </do_if>
                        <set_value name="$WinterResortComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$WinterResortComplete" exact="true"/>
                      </do_else>

                      <do_if value="$HQ.hasbeenrenamed">
                        <set_value name="$HQName" exact="$HQ.knownname"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HQName" exact="{20102,2011}"/>
                      </do_else>
                      <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                        <replace string="'$STATION$'" with="$HQName"/>
                        <replace string="'$LOCATION$'" with="$Cluster_FrontierEdge.knownname"/>
                      </substitute_text>
                      <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                        <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_FrontierEdge_HousingTargetAmount]"/>
                      </substitute_text>

                      <do_if value="not $HQ.canbuildclass.{class.ship_s}">
                        <update_mission cue="Terraforming_FrontierEdge_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.build_module" object="$HQ" text="{20104,61301}" comment="Build S/M Ship Fabrication Module"/>
                            <objective step="2" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_FrontierEdge" completed="$RelocateComplete"/>
                            <objective step="3" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name" completed="$WheatFieldsComplete"/>
                            <objective step="4" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                            <objective step="5" action="objective.build_project" text="terraforming.project.ame_resort_winter.name" completed="$WinterResortComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="not $BuildObjective?">
                          <set_value name="$OptionalSteps" operation="add" exact="1"/>
                          <set_value name="$BuildObjective"/>
                          <signal_cue cue="Terraforming_FrontierEdge_Trigger_BuildModule_Objective"/>
                        </do_if>
                        <set_objective_from_briefing cue="Terraforming_FrontierEdge_CreateMission" step="1"/>
                      </do_if>
                      <do_else>
                        <do_if value="$BuildObjective?">
                          <set_value name="$OptionalSteps" operation="subtract" exact="1"/>
                          <remove_value name="$BuildObjective"/>
                        </do_if>
                        <update_mission cue="Terraforming_FrontierEdge_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_FrontierEdge" completed="$RelocateComplete"/>
                            <objective step="2" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name" completed="$WheatFieldsComplete"/>
                            <objective step="3" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                            <objective step="4" action="objective.build_project" text="terraforming.project.ame_resort_winter.name" completed="$WinterResortComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="$OptionalSteps ge 1">
                          <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        </do_if>
                        <do_else>
                          <set_value name="$OptionalSteps" exact="0"/>
                        </do_else>
                        <set_objective_from_briefing cue="Terraforming_FrontierEdge_CreateMission" step="$ProjectStep"/>
                      </do_else>

                      <remove_value name="$ProjectStep"/>
                      <remove_value name="$RelocateObjectiveText"/>
                      <remove_value name="$HousingObjectiveText"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$OptionalSteps" exact="0"/>
                    <reset_cue cue="Terraforming_FrontierEdge_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="3">
                    <reset_cue cue="Terraforming_FrontierEdge_Trigger_BuildModule_Objective"/>
                    <reset_cue cue="Terraforming_FrontierEdge_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="4">
                    <reset_cue cue="Terraforming_FrontierEdge_Init_ObjectiveManager"/>
                  </patch>
                </cue>

                <cue name="Terraforming_FrontierEdge_BuildModule_Check">
                  <actions>
                    <find_object_component groupname="$WharfModules" object="$HQ" class="class.buildmodule">
                      <match_any>
                        <match canbuildclass="class.ship_m"/>
                        <match canbuildclass="class.ship_s"/>
                      </match_any>
                    </find_object_component>
                  </actions>
                  <cues>
                    <cue name="Terraforming_FrontierEdge_BuildModuleDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$WharfModules"/>
                        <check_value value="$WharfModules.count == 1" comment="trigger another check when the last build module is destroyed"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Terraforming_FrontierEdge_ObjectiveUpdate" param="['RequestBuildModule']"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Terraforming_FrontierEdge_ObjectiveUpdate" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_terraforming_stat_changed cluster="$Cluster_FrontierEdge"/>
                      <event_terraforming_project_succeeded cluster="$Cluster_FrontierEdge"/>
                      <event_object_changed_cluster object="$HQ"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="typeof event.param == datatype.list ">
                      <do_if value="event.param.{1} == 'ModulesGroup'" comment="make sure the signal came from CheckStation_BuildModule">
                        <add_to_group groupname="$WharfModules" group="event.param.{2}"/>
                      </do_if>
                    </do_if>
                    <reset_cue cue="Terraforming_FrontierEdge_Init_ObjectiveManager"/>
                  </actions>
                </cue>

                <cue name="Terraforming_FrontierEdge_Trigger_BuildModule_Objective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Terraforming_FrontierEdge_BuildModule" ref="AdditionalObjective_BuildModule">
                      <!-- Required to Signal the Update Cue when Building is finished -->
                      <param name="UpdateCue" value="Terraforming_FrontierEdge_ObjectiveUpdate"/>
                      <param name="Station" value="$HQ"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <!--Objective cues-->

            <cue name="Terraforming_FrontierEdge_Milestone_1">
              <conditions>
                <event_terraforming_stat_changed cluster="$Cluster_FrontierEdge" stat="'temperature'"/>
                <check_value value="$Cluster_FrontierEdge.terraforming.stat.temperature.state gt 0"/>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.antigone" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.01"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1049}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <cues>
                <cue name="Terraforming_FrontierEdge_Contact_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterAntigone']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[30505002]]"/>
                  <param name="MissionCue"        value="Terraforming_FrontierEdge_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_FrontierEdge_Milestone_2">
              <conditions>
                <event_terraforming_stat_changed cluster="$Cluster_FrontierEdge" stat="'population'"/>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.antigone" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.02"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1049}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <cues>
                <cue name="Terraforming_FrontierEdge_Contact_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterAntigone']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[30505003]]"/>
                  <param name="MissionCue"        value="Terraforming_FrontierEdge_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_FrontierEdge_MissionComplete" version="5">
              <conditions>
                <check_any>
                  <event_terraforming_stat_changed cluster="$Cluster_FrontierEdge" stat="'population'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_FrontierEdge"/>
                </check_any>
                <check_value value="$Cluster_FrontierEdge.terraforming.stat.population.value ge $Terraforming_FrontierEdge_HousingTargetAmount"/>
                <check_value value="$Cluster_FrontierEdge.terraforming.project.agr_fields_wheat.complete"/>
                <check_value value="$Cluster_FrontierEdge.terraforming.project.ame_resort_winter.complete"/>
              </conditions>
              <actions>
                <cancel_cue cue="Terraforming_FrontierEdge_ObjectiveUpdate"/>
                <set_value name="$AntigoneTerraformed" exact="true"/>
                <add_faction_relation faction="faction.antigone" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.1"/>
                <set_world_settlements cluster="$Cluster_FrontierEdge" partname="'planet001c'" page="1042" line="16041" comment="Multiple Cities"/>
                <remove_value name="$AbortMissionCue"/>
                <remove_from_list name="$OfferCues" exact="Terraforming_FrontierEdge_CreateOffer"/>
                <remove_mission cue="Terraforming_FrontierEdge_CreateMission" type="completed"/>
                <set_value name="$Cluster_FrontierEdge_Completed"/>
                <set_terraforming_mission_completed cluster="$Cluster_FrontierEdge"/>
                <unlock_achievement name="TERRAFORMING_MISSION"/>
                <set_value name="stat.terraforming_missions_completed" operation="add"/>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_frontier_edge"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1058}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <patch sinceversion="2">
                <remove_from_list name="$OfferCues" exact="Terraforming_FrontierEdge_CreateOffer" multiple="false" />
              </patch>
              <patch sinceversion="3">
                <set_terraforming_mission_completed cluster="$Cluster_FrontierEdge"/>
              </patch>
              <patch sinceversion="4">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_frontier_edge"/>
              </patch>
              <patch sinceversion="5" state="complete">
                <set_world_settlements cluster="$Cluster_FrontierEdge" partname="'planet001c'" page="1042" line="16041" comment="Multiple Cities"/>
              </patch>
              <cues>
                <cue name="Terraforming_FrontierEdge_VideoEmail">
                  <actions>
                    <substitute_text text="$EmailTitle" source="{30500,11001}">
                      <replace string="'$CLUSTERNAME$'" with="$Cluster_FrontierEdge.knownname"/>
                    </substitute_text>

                    <write_incoming_message title="$EmailTitle" text="{30500,11002}" source="if player.target then player.target else player.entity.container" highpriority="true" comment="Frontier Edge Terraforming Wrap Email">
                      <cutscene key="'terraforming_frontier_edge'"/>
                    </write_incoming_message>
                  </actions>
                </cue>

                <cue name="Terraforming_FrontierEdge_Report_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterMessner']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[30505004]]"/>
                  <param name="MissionCue"        value="Terraforming_FrontierEdge_CreateMission"/>
                </cue>

                <cue name="Terraforming_FrontierEdge_Antigone_ActivateJobs">
                  <actions>
                    <debug_text text="'Enable New Patrol Job in Getsu Fune'"/>
                    <set_job_active job="'antigone_destroyer_patrol_l_frontier_edge'" activate="true" comment="Have Antigone create an additional Patrol exclusive to Getsu Fune"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="DEBUG_Terraforming_FrontierEdge" onfail="cancel">
              <conditions>
                <check_value value="$DebugWarpCues?"/>
              </conditions>
              <delay exact="1ms"/>
              <actions>
                <append_to_list name="$DebugWarpCues" exact="DEBUG_Terraforming_FrontierEdge_WarpPlayerShip"/>
                <append_to_list name="$DebugSetStatsCues" exact="DEBUG_Terraforming_FrontierEdge_SetEndStats"/>
              </actions>
              <cues>
                <cue name="DEBUG_Terraforming_FrontierEdge_WarpPlayerShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="DEBUG_Terraforming_WarpPlayerShip">
                      <param name="Cluster" value="$Cluster_FrontierEdge"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="DEBUG_Terraforming_FrontierEdge_SetEndStats">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_terraforming_stat cluster="$Cluster_FrontierEdge" id="'temperature'" value="4"/>
                    <set_terraforming_stat cluster="$Cluster_FrontierEdge" id="'airpressure'" value="6"/>
                    <set_terraforming_stat cluster="$Cluster_FrontierEdge" id="'oxygen'" value="9"/>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_AtiyasMisfortune" version="1">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="not $Cluster_AtiyasMisfortune_Completed?">
              <find_cluster name="$Cluster_AtiyasMisfortune" macro="macro.cluster_26_macro"/>
              <add_to_group groupname="$TerraformingClusters" object="$Cluster_AtiyasMisfortune"/>
              <append_to_list name="$OfferCues" exact="Terraforming_Atiya_CreateOffer"/>
              <signal_cue cue="Refresh_Offers" check="false"/>
              <initialise_terraforming cluster="$Cluster_AtiyasMisfortune" partname="'planet001b'"/>
              <!--Set initial stats-->
              <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'temperature'" value="9"/>
              <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'oxygen'" value="0"/>
              <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'methane'" value="2"/>
              <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'humidity'" value="0"/>
              <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'seismicactivity'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'population'" value="0"/>
              <set_value name="$AddedAtmoPressureTable.{$Cluster_AtiyasMisfortune}" exact="0" comment="2 methane / 4"/>
              <!--Set up projects-->
              <run_actions ref="SetupGeneralProjects">
                <param name="Cluster" value="$Cluster_AtiyasMisfortune"/>
                <param name="EnergyProject" value="'pwr_geothermal'"/>
              </run_actions>
              <add_terraforming_project cluster="$Cluster_AtiyasMisfortune" id="'ter_volcanocaps'"/>
              <add_terraforming_project cluster="$Cluster_AtiyasMisfortune" id="'ame_resort_tropical'"/>
              <set_value name="$Terraforming_Atiya_HousingTargetAmount" exact="250000000"/>
              <add_terraforming_event cluster="$Cluster_AtiyasMisfortune" id="'evt_quake_mild'"/>
              <add_terraforming_event cluster="$Cluster_AtiyasMisfortune" id="'evt_quake_moderate'"/>
              <add_terraforming_event cluster="$Cluster_AtiyasMisfortune" id="'evt_quake_severe'"/>
              <!--Create mission character-->
              <signal_cue cue="Terraforming_Create_Antigone_Reporter" check="false"/>
            </do_if>
          </actions>
          <patch sinceversion="1">
            <do_if value="$Cluster_AtiyasMisfortune.terraforming.stat.airpressure.exists">
              <remove_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'airpressure'"/>
              <debug_text text="'Removed airpressure from $Cluster_AtiyasMisfortune - test: ' + $Cluster_AtiyasMisfortune.terraforming.stat.airpressure.exists"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Terraforming_Atiya_CreateOffer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating offer for cue Terraforming_Atiya_CreateMission'" chance="$DebugChance"/>

                <do_if value="$HQ.hasbeenrenamed">
                  <set_value name="$HQName" exact="$HQ.knownname"/>
                </do_if>
                <do_else>
                  <set_value name="$HQName" exact="{20102,2011}"/>
                </do_else>
                <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                  <replace string="'$STATION$'" with="$HQName"/>
                  <replace string="'$LOCATION$'" with="$Cluster_AtiyasMisfortune.knownname"/>
                </substitute_text>
                <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                  <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_Atiya_HousingTargetAmount]"/>
                </substitute_text>
                <create_offer cue="Terraforming_Atiya_CreateMission" type="missiontype.think" actor="$BosoTa" difficulty="level.impossible" faction="faction.antigone" group="missiongroup.terraforming" name="{30506,1000}" description="{30506,1001}" rewardtext="{30506,1003}">
                  <briefing>
                    <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_AtiyasMisfortune"/>
                    <objective step="2" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name"/>
                    <objective step="3" action="objective.build_housing" text="$HousingObjectiveText"/>
                    <objective step="4" action="objective.build_project" text="terraforming.project.ame_resort_tropical.name"/>
                  </briefing>
                </create_offer>
                <remove_value name="$RelocateObjectiveText"/>
                <remove_value name="$HousingObjectiveText"/>
              </actions>
            </cue>

            <cue name="Terraforming_Atiya_CreateMission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating mission for cue Terraforming_Atiya_CreateMission'" chance="$DebugChance"/>
                <create_mission cue="Terraforming_Atiya_CreateMission" offercue="Terraforming_Atiya_CreateMission"/>
                <set_terraforming_mission_activated cluster="$Cluster_AtiyasMisfortune" missioncue="Terraforming_Atiya_CreateMission"/>
                <!--TODO: check current state, mark objectives as complete when appropriate-->
                <remove_offer cue="Terraforming_Atiya_CreateMission"/>
                <set_value name="$AcceptedOfferCue" exact="Terraforming_Atiya_CreateOffer"/>
                <do_if value="@$AbortMissionCue">
                  <signal_cue cue="$AbortMissionCue"/>
                </do_if>
                <set_value name="$AbortMissionCue" exact="Terraforming_Atiya_AbortMission"/>
                <set_value name="$OptionalSteps" exact="0"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1049}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <cues>
                <cue name="Terraforming_Atiya_Intro_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterAntigone']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[if @$AntigoneTerraformed then 30500002 else 30500001],[30506001]]"/>
                  <param name="MissionCue"        value="Terraforming_Atiya_CreateMission"/>
                </cue>

                <cue name="Terraforming_Atiya_AbortMission">
                  <conditions>
                    <check_any>
                      <event_mission_aborted cue="Terraforming_Atiya_CreateMission"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Removing mission for cue Terraforming_Atiya_CreateMission'" chance="$DebugChance"/>
                    <remove_mission cue="Terraforming_Atiya_CreateMission"/>
                    <remove_value name="$AcceptedOfferCue"/>
                    <remove_value name="$AbortMissionCue"/>
                    <set_terraforming_mission_deactivated cluster="$Cluster_AtiyasMisfortune"/>
                    <reset_cue cue="Terraforming_Atiya_CreateMission"/>
                    <reset_cue cue="Terraforming_Atiya_CreateOffer"/>
                    <signal_cue cue="Refresh_Offers"/>
                  </actions>
                </cue>

                <cue name="Terraforming_Atiya_Init_ObjectiveManager" version="4">
                  <actions>
                    <do_if value="not $Cluster_Atiya_Completed?">

                      <do_if value="$HQ.cluster != $Cluster_AtiyasMisfortune">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="1"/>
                        </do_if>
                        <set_value name="$RelocateComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$RelocateComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_AtiyasMisfortune.terraforming.project.agr_fields_wheat.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="2"/>
                        </do_if>
                        <set_value name="$WheatFieldsComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$WheatFieldsComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_AtiyasMisfortune.terraforming.stat.population.value lt $Terraforming_Atiya_HousingTargetAmount">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="3"/>
                        </do_if>
                        <set_value name="$HousingComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HousingComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_AtiyasMisfortune.terraforming.project.ame_resort_tropical.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="4"/>
                        </do_if>
                        <set_value name="$TropicalResortComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$TropicalResortComplete" exact="true"/>
                      </do_else>

                      <do_if value="$HQ.hasbeenrenamed">
                        <set_value name="$HQName" exact="$HQ.knownname"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HQName" exact="{20102,2011}"/>
                      </do_else>
                      <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                        <replace string="'$STATION$'" with="$HQName"/>
                        <replace string="'$LOCATION$'" with="$Cluster_AtiyasMisfortune.knownname"/>
                      </substitute_text>
                      <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                        <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_Atiya_HousingTargetAmount]"/>
                      </substitute_text>

                      <do_if value="not $HQ.canbuildclass.{class.ship_s}">
                        <update_mission cue="Terraforming_Atiya_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.build_module" object="$HQ" text="{20104,61301}" comment="Build S/M Ship Fabrication Module"/>
                            <objective step="2" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_AtiyasMisfortune" completed="$RelocateComplete"/>
                            <objective step="3" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name" completed="$WheatFieldsComplete"/>
                            <objective step="4" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                            <objective step="5" action="objective.build_project" text="terraforming.project.ame_resort_tropical.name" completed="$TropicalResortComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="not $BuildObjective?">
                          <set_value name="$OptionalSteps" operation="add" exact="1"/>
                          <set_value name="$BuildObjective"/>
                          <signal_cue cue="Terraforming_Atiya_Trigger_BuildModule_Objective"/>
                        </do_if>
                        <set_objective_from_briefing cue="Terraforming_Atiya_CreateMission" step="1"/>
                      </do_if>
                      <do_else>
                        <do_if value="$BuildObjective?">
                          <set_value name="$OptionalSteps" operation="subtract" exact="1"/>
                          <remove_value name="$BuildObjective"/>
                        </do_if>
                        <update_mission cue="Terraforming_Atiya_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_AtiyasMisfortune" completed="$RelocateComplete"/>
                            <objective step="2" action="objective.build_project" text="terraforming.project.agr_fields_wheat.name" completed="$WheatFieldsComplete"/>
                            <objective step="3" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                            <objective step="4" action="objective.build_project" text="terraforming.project.ame_resort_tropical.name" completed="$TropicalResortComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="$OptionalSteps ge 1">
                          <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        </do_if>
                        <do_else>
                          <set_value name="$OptionalSteps" exact="0"/>
                        </do_else>
                        <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        <set_objective_from_briefing cue="Terraforming_Atiya_CreateMission" step="$ProjectStep"/>
                      </do_else>

                      <remove_value name="$ProjectStep"/>
                      <remove_value name="$RelocateObjectiveText"/>
                      <remove_value name="$HousingObjectiveText"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$OptionalSteps" exact="0"/>
                    <reset_cue cue="Terraforming_Atiya_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="3">
                    <reset_cue cue="Terraforming_Atiya_Trigger_BuildModule_Objective"/>
                    <reset_cue cue="Terraforming_Atiya_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="4">
                    <reset_cue cue="Terraforming_Atiya_Init_ObjectiveManager"/>
                  </patch>
                </cue>

                <cue name="Terraforming_Atiya_BuildModule_Check">
                  <actions>
                    <find_object_component groupname="$WharfModules" object="$HQ" class="class.buildmodule">
                      <match_any>
                        <match canbuildclass="class.ship_m"/>
                        <match canbuildclass="class.ship_s"/>
                      </match_any>
                    </find_object_component>
                  </actions>
                  <cues>
                    <cue name="Terraforming_Atiya_BuildModuleDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$WharfModules"/>
                        <check_value value="$WharfModules.count == 1" comment="trigger another check when the last build module is destroyed"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Terraforming_Atiya_ObjectiveUpdate" param="['RequestBuildModule']"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Terraforming_Atiya_ObjectiveUpdate" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_terraforming_stat_changed cluster="$Cluster_AtiyasMisfortune"/>
                      <event_terraforming_project_succeeded cluster="$Cluster_AtiyasMisfortune"/>
                      <event_object_changed_cluster object="$HQ"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="typeof event.param == datatype.list ">
                      <do_if value="event.param.{1} == 'ModulesGroup'" comment="make sure the signal came from CheckStation_BuildModule">
                        <add_to_group groupname="$WharfModules" group="event.param.{2}"/>
                      </do_if>
                    </do_if>
                    <reset_cue cue="Terraforming_Atiya_Init_ObjectiveManager"/>
                  </actions>
                </cue>

                <cue name="Terraforming_Atiya_Trigger_BuildModule_Objective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Terraforming_Atiya_BuildModule" ref="AdditionalObjective_BuildModule">
                      <!-- Required to Signal the Update Cue when Building is finished -->
                      <param name="UpdateCue" value="Terraforming_Atiya_ObjectiveUpdate"/>
                      <param name="Station" value="$HQ"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <!--Objective cues-->

            <cue name="Terraforming_Atiya_Milestone_1">
              <conditions>
                <check_any>
                  <event_terraforming_project_succeeded cluster="$Cluster_AtiyasMisfortune" project="'ter_volcanocaps'"/>
                </check_any>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.antigone" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.1"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1049}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <cues>
                <cue name="Terraforming_Atiya_Report_1_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$Antigone_Reporter,$BosoTa]"/>
                  <param name="CutsceneKey"       value="[table[$key = 'ShowCharacterAntigone'],table[$key = 'ShowCharacterBoron']]"/>
                  <param name="CutsceneCaption"   value="[true, $CutsceneCaption]"/>
                  <param name="Lines"             value="[[[30506002]],[[30506001]]]"/>
                  <param name="MissionCue"        value="Terraforming_Atiya_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_Atiya_Milestone_2">
              <conditions>
                <event_terraforming_stat_changed cluster="$Cluster_AtiyasMisfortune"/>
                <check_value value="$Cluster_AtiyasMisfortune.terraforming.stat.temperature.value le 3"/>
                <check_value value="$Cluster_AtiyasMisfortune.terraforming.stat.humidity.value ge 1"/>
                <check_value value="$Cluster_AtiyasMisfortune.terraforming.stat.airpressure.value ge 1"/>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.antigone" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.1"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1049}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <cues>
                <cue name="Terraforming_Atiya_Report_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterAntigone']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[30506003]]"/>
                  <param name="MissionCue"        value="Terraforming_Atiya_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_Atiya_MissionComplete" version="6">
              <conditions>
                <check_any>
                  <event_terraforming_stat_changed cluster="$Cluster_AtiyasMisfortune" stat="'population'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_AtiyasMisfortune" project="'agr_fields_wheat'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_AtiyasMisfortune" project="'ame_resort_tropical'"/>
                </check_any>
                <check_value value="$Cluster_AtiyasMisfortune.terraforming.stat.population.value ge $Terraforming_Atiya_HousingTargetAmount"/>
                <check_value value="$Cluster_AtiyasMisfortune.terraforming.project.agr_fields_wheat.complete"/>
                <check_value value="$Cluster_AtiyasMisfortune.terraforming.project.ame_resort_tropical.complete"/>
              </conditions>
              <actions>
                <cancel_cue cue="Terraforming_Atiya_ObjectiveUpdate"/>
                <add_faction_relation faction="faction.antigone" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.5"/>
                <set_world_name cluster="$Cluster_AtiyasMisfortune" partname="'planet001b'" page="20005" line="1056" comment="Cinder"/>
                <set_world_name cluster="$Cluster_AtiyasMisfortune" partname="'sphere001'" page="20005" line="1057" comment="Ash"/>
                <set_world_settlements cluster="$Cluster_AtiyasMisfortune" partname="'planet001b'" page="1042" line="16041" comment="Multiple Cities"/>
                <set_value name="$AntigoneTerraformed" exact="true"/>
                <remove_from_list name="$OfferCues" exact="Terraforming_Atiya_CreateOffer"/>
                <remove_value name="$AbortMissionCue"/>
                <remove_mission cue="Terraforming_Atiya_CreateMission" type="completed"/>
                <set_value name="$Cluster_AtiyasMisfortune_Completed"/>
                <set_terraforming_mission_completed cluster="$Cluster_AtiyasMisfortune"/>
                <unlock_achievement name="TERRAFORMING_MISSION"/>
                <unlock_achievement name="TERRAFORMING_IMPOSSIBLE"/>
                <set_value name="stat.terraforming_missions_completed" operation="add"/>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_atiyas_misfortune"/>
                <substitute_text text="$CutsceneCaption" source="{1015,191}">
                  <replace string="'$LOCATION$'" with="{20005,1056}"/>
                  <replace string="'$PERSON$'" with="$Antigone_Reporter.knownname"/>
                </substitute_text>
              </actions>
              <patch sinceversion="2">
                <remove_from_list name="$OfferCues" exact="Terraforming_Atiya_CreateOffer" multiple="false" />
              </patch>
              <patch sinceversion="3">
                <set_terraforming_mission_completed cluster="$Cluster_AtiyasMisfortune"/>
              </patch>
              <patch sinceversion="4">
                <set_world_name cluster="$Cluster_AtiyasMisfortune" partname="'planet001b'" page="20005" line="1056" comment="Cinder"/>
                <set_world_name cluster="$Cluster_AtiyasMisfortune" partname="'sphere001'" page="20005" line="1057" comment="Ash"/>
              </patch>
              <patch sinceversion="5">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_atiyas_misfortune"/>
              </patch>
              <patch sinceversion="6" state="complete">
                <set_world_settlements cluster="$Cluster_AtiyasMisfortune" partname="'planet001b'" page="1042" line="16041" comment="Multiple Cities"/>
              </patch>
              <cues>
                <cue name="Terraforming_Atiya_VideoEmail">
                  <actions>
                    <substitute_text text="$EmailTitle" source="{30500,11001}">
                      <replace string="'$CLUSTERNAME$'" with="$Cluster_AtiyasMisfortune.knownname"/>
                    </substitute_text>

                    <write_incoming_message title="$EmailTitle" text="{30500,11002}" source="if player.target then player.target else player.entity.container" highpriority="true" comment="Atiyas Misfortune Terraforming Wrap Email">
                      <cutscene key="'terraforming_atiyas_misfortune'"/>
                    </write_incoming_message>
                  </actions>
                </cue>

                <cue name="Terraforming_Atiya_Report_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Antigone_Reporter"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacterCinder']"/>
                  <param name="CutsceneCaption"   value="$CutsceneCaption"/>
                  <param name="Lines"             value="[[30506004]]"/>
                  <param name="MissionCue"        value="Terraforming_Atiya_CreateMission"/>
                </cue>

                <cue name="Terraforming_Atiya_Antigone_ActivateJobs">
                  <actions>
                    <debug_text text="'Enable New Patrol Job in Atiyas Misfortune'"/>
                    <set_job_active job="'antigone_destroyer_patrol_l_atiyas_misfortune'" activate="true" comment="Have Antigone create an additional Patrol exclusive to Getsu Fune"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="DEBUG_Terraforming_Atiya" onfail="cancel">
              <conditions>
                <check_value value="$DebugWarpCues?"/>
              </conditions>
              <delay exact="1ms"/>
              <actions>
                <append_to_list name="$DebugWarpCues" exact="DEBUG_Terraforming_Atiya_WarpPlayerShip"/>
                <append_to_list name="$DebugSetStatsCues" exact="DEBUG_Terraforming_Atiya_SetEndStats"/>
              </actions>
              <cues>
                <cue name="DEBUG_Terraforming_Atiya_WarpPlayerShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="DEBUG_Terraforming_WarpPlayerShip">
                      <param name="Cluster" value="$Cluster_AtiyasMisfortune"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="DEBUG_Terraforming_Atiya_SetEndStats">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'temperature'" value="6"/>
                    <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'oxygen'" value="9"/>
                    <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'methane'" value="0"/>
                    <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'humidity'" value="4"/>
                    <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'seismicactivity'" value="1"/>
                  </actions>
                </cue>

                <cue name="DEBUG_Terraforming_Atiya_SetPopulation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_terraforming_stat cluster="$Cluster_AtiyasMisfortune" id="'population'" value="10000000000L"/>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_18Billion">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="not $Cluster_18Billion_Completed?">
              <find_cluster name="$Cluster_18Billion" macro="macro.cluster_02_macro"/>
              <add_to_group groupname="$TerraformingClusters" object="$Cluster_18Billion"/>
              <append_to_list name="$OfferCues" exact="Terraforming_18Billion_CreateOffer"/>
              <signal_cue cue="Refresh_Offers" check="false"/>
              <initialise_terraforming cluster="$Cluster_18Billion" partname="'planet'"/>
              <!--Set initial stats-->
              <set_terraforming_stat cluster="$Cluster_18Billion" id="'airpressure'" value="4"/>
              <set_terraforming_stat cluster="$Cluster_18Billion" id="'oxygen'" value="0"/>
              <set_terraforming_stat cluster="$Cluster_18Billion" id="'methane'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_18Billion" id="'humidity'" value="1"/>
              <set_terraforming_stat cluster="$Cluster_18Billion" id="'population'" value="0"/>
              <set_value name="$GlobalWarmingLimitTable.{$Cluster_18Billion}" exact="5"/>
              <set_value name="$AddedAtmoPressureTable.{$Cluster_18Billion}" exact="0" comment="3 methane / 4"/>
              <!--Set up projects-->
              <run_actions ref="SetupGeneralProjects">
                <param name="Cluster" value="$Cluster_18Billion"/>
                <param name="GlobalWarmingLimit" value="5"/>
              </run_actions>
              <add_terraforming_project cluster="$Cluster_18Billion" id="'ame_art_college'"/>
              <set_value name="$Terraforming_18Billion_HousingTargetAmount" exact="100000000"/>
              <!--Create mission character-->
              <create_cue_actor name="$Teladi_Communist_Contact" cue="namespace" macro="character_teladi_female_terraforming_communist_macro">
                <page exact="10552"/>
                <owner exact="faction.teladi"/>
                <skills>
                  <skill type="management"  exact="3"/>
                  <skill type="morale"      exact="9"/>
                  <skill type="piloting"    exact="9"/>
                  <skill type="engineering" exact="6"/>
                  <skill type="boarding"    exact="1"/>
                </skills>
              </create_cue_actor>
              <set_entity_traits entity="$Teladi_Communist_Contact" missionactor="true"/>
            </do_if>
          </actions>
          <cues>
            <cue name="Terraforming_18Billion_CreateOffer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating offer for cue Terraforming_18Billion_CreateMission'" chance="$DebugChance"/>
                <do_if value="$HQ.hasbeenrenamed">
                  <set_value name="$HQName" exact="$HQ.knownname"/>
                </do_if>
                <do_else>
                  <set_value name="$HQName" exact="{20102,2011}"/>
                </do_else>
                <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                  <replace string="'$STATION$'" with="$HQName"/>
                  <replace string="'$LOCATION$'" with="$Cluster_18Billion.knownname"/>
                </substitute_text>
                <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                  <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_18Billion_HousingTargetAmount]"/>
                </substitute_text>
                <create_offer cue="Terraforming_18Billion_CreateMission" type="missiontype.think" actor="$BosoTa" difficulty="level.veryhard" faction="faction.teladi" group="missiongroup.terraforming" name="{30508,1000}" description="{30508,1001}" rewardtext="{30508,1002}">
                  <briefing>
                    <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_18Billion"/>
                    <objective step="2" action="objective.build_project" text="terraforming.project.agr_fields_sunrise.name"/>
                    <objective step="3" action="objective.build_housing" text="$HousingObjectiveText"/>
                    <objective step="4" action="objective.build_project" text="terraforming.project.ame_art_college.name"/>
                  </briefing>
                </create_offer>
                <remove_value name="$RelocateObjectiveText"/>
                <remove_value name="$HousingObjectiveText"/>
              </actions>
            </cue>

            <cue name="Terraforming_18Billion_CreateMission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating mission for cue Terraforming_18Billion_CreateMission'" chance="$DebugChance"/>
                <create_mission cue="Terraforming_18Billion_CreateMission" offercue="Terraforming_18Billion_CreateMission"/>
                <set_terraforming_mission_activated cluster="$Cluster_18Billion" missioncue="Terraforming_18Billion_CreateMission"/>

                <remove_offer cue="Terraforming_18Billion_CreateMission"/>
                <set_value name="$AcceptedOfferCue" exact="Terraforming_18Billion_CreateOffer"/>
                <do_if value="@$AbortMissionCue">
                  <signal_cue cue="$AbortMissionCue"/>
                </do_if>
                <set_value name="$AbortMissionCue" exact="Terraforming_18Billion_AbortMission"/>
                <set_value name="$OptionalSteps" exact="0"/>
              </actions>
              <cues>
                <cue name="Terraforming_18Billion_Intro_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Teladi_Communist_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30508001]]"/>
                  <param name="MissionCue"        value="Terraforming_18Billion_CreateMission"/>
                </cue>

                <cue name="Terraforming_18Billion_AbortMission">
                  <conditions>
                    <check_any>
                      <event_mission_aborted cue="Terraforming_18Billion_CreateMission"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Removing mission for cue Terraforming_18Billion_CreateMission'" chance="$DebugChance"/>
                    <remove_mission cue="Terraforming_18Billion_CreateMission"/>
                    <remove_value name="$AcceptedOfferCue"/>
                    <remove_value name="$AbortMissionCue"/>
                    <set_terraforming_mission_deactivated cluster="$Cluster_18Billion"/>
                    <reset_cue cue="Terraforming_18Billion_CreateMission"/>
                    <reset_cue cue="Terraforming_18Billion_CreateOffer"/>
                    <signal_cue cue="Refresh_Offers"/>
                  </actions>
                </cue>

                <cue name="Terraforming_18Billion_Init_ObjectiveManager" version="4">
                  <actions>
                    <do_if value="not $Cluster_18Billion_Completed?">

                      <do_if value="$HQ.cluster != $Cluster_18Billion">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="1"/>
                        </do_if>
                        <set_value name="$RelocateComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$RelocateComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_18Billion.terraforming.project.agr_fields_sunrise.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="2"/>
                        </do_if>
                        <set_value name="$SunriseFieldsComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$SunriseFieldsComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_18Billion.terraforming.stat.population.value lt $Terraforming_18Billion_HousingTargetAmount">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="3"/>
                        </do_if>
                        <set_value name="$HousingComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HousingComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_18Billion.terraforming.project.ame_art_college.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="4"/>
                        </do_if>
                        <set_value name="$ArtCollegeComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$ArtCollegeComplete" exact="true"/>
                      </do_else>

                      <do_if value="$HQ.hasbeenrenamed">
                        <set_value name="$HQName" exact="$HQ.knownname"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HQName" exact="{20102,2011}"/>
                      </do_else>
                      <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                        <replace string="'$STATION$'" with="$HQName"/>
                        <replace string="'$LOCATION$'" with="$Cluster_18Billion.knownname"/>
                      </substitute_text>
                      <substitute_text text="$HousingObjectiveText" source="{1004,1090}">
                        <replace string="'$AMOUNT$'" with="'%,s'.[$Terraforming_18Billion_HousingTargetAmount]"/>
                      </substitute_text>

                      <do_if value="not $HQ.canbuildclass.{class.ship_s}">
                        <update_mission cue="Terraforming_18Billion_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.build_module" object="$HQ" text="{20104,61301}" comment="Build S/M Ship Fabrication Module"/>
                            <objective step="2" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_18Billion" completed="$RelocateComplete"/>
                            <objective step="3" action="objective.build_project" text="terraforming.project.agr_fields_sunrise.name" completed="$SunriseFieldsComplete"/>
                            <objective step="4" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                            <objective step="5" action="objective.build_project" text="terraforming.project.ame_art_college.name" completed="$ArtCollegeComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="not $BuildObjective?">
                          <set_value name="$OptionalSteps" operation="add" exact="1"/>
                          <set_value name="$BuildObjective"/>
                          <signal_cue cue="Terraforming_18Billion_Trigger_BuildModule_Objective"/>
                        </do_if>
                        <set_objective_from_briefing cue="Terraforming_18Billion_CreateMission" step="1"/>
                      </do_if>
                      <do_else>
                        <do_if value="$BuildObjective?">
                          <set_value name="$OptionalSteps" operation="subtract" exact="1"/>
                          <remove_value name="$BuildObjective"/>
                        </do_if>
                        <update_mission cue="Terraforming_18Billion_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_18Billion" completed="$RelocateComplete"/>
                            <objective step="2" action="objective.build_project" text="terraforming.project.agr_fields_sunrise.name" completed="$SunriseFieldsComplete"/>
                            <objective step="3" action="objective.build_housing" text="$HousingObjectiveText" completed="$HousingComplete"/>
                            <objective step="4" action="objective.build_project" text="terraforming.project.ame_art_college.name" completed="$ArtCollegeComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="$OptionalSteps ge 1">
                          <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        </do_if>
                        <do_else>
                          <set_value name="$OptionalSteps" exact="0"/>
                        </do_else>
                        <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        <set_objective_from_briefing cue="Terraforming_18Billion_CreateMission" step="$ProjectStep"/>
                      </do_else>

                      <remove_value name="$ProjectStep"/>
                      <remove_value name="$RelocateObjectiveText"/>
                      <remove_value name="$HousingObjectiveText"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$OptionalSteps" exact="0"/>
                    <reset_cue cue="Terraforming_18Billion_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="3">
                    <reset_cue cue="Terraforming_18Billion_Trigger_BuildModule_Objective"/>
                    <reset_cue cue="Terraforming_18Billion_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="4">
                    <reset_cue cue="Terraforming_18Billion_Init_ObjectiveManager"/>
                  </patch>
                </cue>

                <cue name="Terraforming_18Billion_BuildModule_Check">
                  <actions>
                    <find_object_component groupname="$WharfModules" object="$HQ" class="class.buildmodule">
                      <match_any>
                        <match canbuildclass="class.ship_m"/>
                        <match canbuildclass="class.ship_s"/>
                      </match_any>
                    </find_object_component>
                  </actions>
                  <cues>
                    <cue name="Terraforming_18Billion_BuildModuleDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$WharfModules"/>
                        <check_value value="$WharfModules.count == 1" comment="trigger another check when the last build module is destroyed"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Terraforming_18Billion_ObjectiveUpdate" param="['RequestBuildModule']"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Terraforming_18Billion_ObjectiveUpdate" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_terraforming_stat_changed cluster="$Cluster_18Billion"/>
                      <event_terraforming_project_succeeded cluster="$Cluster_18Billion"/>
                      <event_object_changed_cluster object="$HQ"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="typeof event.param == datatype.list ">
                      <do_if value="event.param.{1} == 'ModulesGroup'" comment="make sure the signal came from CheckStation_BuildModule">
                        <add_to_group groupname="$WharfModules" group="event.param.{2}"/>
                      </do_if>
                    </do_if>
                    <debug_text text="'Sunflower Project Finished: ' + $Cluster_18Billion.terraforming.project.agr_fields_sunrise.complete"/>
                    <reset_cue cue="Terraforming_18Billion_Init_ObjectiveManager"/>
                  </actions>
                </cue>

                <cue name="Terraforming_18Billion_Trigger_BuildModule_Objective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Terraforming_18Billion_BuildModule" ref="AdditionalObjective_BuildModule">
                      <!-- Required to Signal the Update Cue when Building is finished -->
                      <param name="UpdateCue" value="Terraforming_18Billion_ObjectiveUpdate"/>
                      <param name="Station" value="$HQ"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <!--Objective cues-->

            <cue name="Terraforming_18Billion_Milestone_1">
              <conditions>
                <event_terraforming_stat_changed cluster="$Cluster_18Billion"/>
                <check_value value="$Cluster_18Billion.terraforming.habitable"/>
              </conditions>
              <cues>
                <cue name="Terraforming_18Billion_Contact_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Teladi_Communist_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30508002]]"/>
                  <param name="MissionCue"        value="Terraforming_18Billion_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_18Billion_Milestone_2">
              <conditions>
                <event_terraforming_stat_changed cluster="$Cluster_18Billion" stat="'population'"/>
              </conditions>
              <cues>
                <cue name="Terraforming_18Billion_Contact_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Teladi_Communist_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30508003]]"/>
                  <param name="MissionCue"        value="Terraforming_18Billion_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_18Billion_MissionComplete" version="6">
              <conditions>
                <check_any>
                  <event_terraforming_stat_changed cluster="$Cluster_18Billion" stat="'population'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_18Billion"/>
                </check_any>
                <check_value value="$Cluster_18Billion.terraforming.stat.population.value ge $Terraforming_18Billion_HousingTargetAmount"/>
                <check_value value="$Cluster_18Billion.terraforming.project.agr_fields_sunrise.complete"/>
                <check_value value="$Cluster_18Billion.terraforming.project.ame_art_college.complete"/>
              </conditions>
              <actions>
                <cancel_cue cue="Terraforming_18Billion_ObjectiveUpdate"/>
                <set_world_name cluster="$Cluster_18Billion" partname="'planet'" page="20005" line="6053" comment="Benefaction"/>
                <set_world_settlements cluster="$Cluster_18Billion" partname="'planet'" page="1042" line="16041" comment="Multiple Cities"/>
                <remove_value name="$AbortMissionCue"/>
                <remove_from_list name="$OfferCues" exact="Terraforming_18Billion_CreateOffer"/>
                <remove_mission cue="Terraforming_18Billion_CreateMission" type="completed"/>
                <set_value name="$Cluster_18Billion_Completed"/>
                <set_terraforming_mission_completed cluster="$Cluster_18Billion"/>
                <unlock_achievement name="TERRAFORMING_MISSION"/>
                <set_value name="stat.terraforming_missions_completed" operation="add"/>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_eighteen_billion"/>
              </actions>
              <patch sinceversion="2">
                <remove_from_list name="$OfferCues" exact="Terraforming_18Billion_CreateOffer" multiple="false" />
              </patch>
              <patch sinceversion="3">
                <set_terraforming_mission_completed cluster="$Cluster_18Billion"/>
              </patch>
              <patch sinceversion="4">
                <set_world_name cluster="$Cluster_18Billion" partname="'planet'" page="20005" line="6053" comment="Benefaction"/>
              </patch>
              <patch sinceversion="5">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_eighteen_billion"/>
              </patch>
              <patch sinceversion="6" state="complete">
                <set_world_settlements cluster="$Cluster_18Billion" partname="'planet'" page="1042" line="16041" comment="Multiple Cities"/>
              </patch>
              <cues>
                <cue name="Terraforming_18Billion_VideoEmail">
                  <actions>
                    <substitute_text text="$EmailTitle" source="{30500,11001}">
                      <replace string="'$CLUSTERNAME$'" with="$Cluster_18Billion.knownname"/>
                    </substitute_text>

                    <write_incoming_message title="$EmailTitle" text="{30500,11002}" source="if player.target then player.target else player.entity.container" highpriority="true" comment="18Billion Terraforming Wrap Email">
                      <cutscene key="'terraforming_18billion'"/>
                    </write_incoming_message>
                  </actions>
                </cue>

                <cue name="Terraforming_18Billion_Report_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Teladi_Communist_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30508004]]"/>
                  <param name="MissionCue"        value="Terraforming_18Billion_CreateMission"/>
                </cue>

                <cue name="Terraforming_18Billion_Report_3_Done">
                  <conditions>
                    <event_speak_line_finished actor="$Teladi_Communist_Contact" line="30508004"/>
                  </conditions>
                  <actions>
                    <set_value name="$DonationAmount" min="1Cr" max="50000Cr"/>
                    <reward_player money="$DonationAmount"/>
                    <remove_value name="$DonationAmount"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="DEBUG_Terraforming_18Billion" onfail="cancel">
              <conditions>
                <check_value value="$DebugWarpCues?"/>
              </conditions>
              <delay exact="1ms"/>
              <actions>
                <append_to_list name="$DebugWarpCues" exact="DEBUG_Terraforming_18Billion_WarpPlayerShip"/>
                <append_to_list name="$DebugSetStatsCues" exact="DEBUG_Terraforming_18Billion_SetEndStats"/>
              </actions>
              <cues>
                <cue name="DEBUG_Terraforming_18Billion_WarpPlayerShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="DEBUG_Terraforming_WarpPlayerShip">
                      <param name="Cluster" value="$Cluster_18Billion"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="DEBUG_Terraforming_18Billion_SetEndStats">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_terraforming_stat cluster="$Cluster_18Billion" id="'airpressure'" value="6"/>
                    <set_terraforming_stat cluster="$Cluster_18Billion" id="'oxygen'" value="9"/>
                    <set_terraforming_stat cluster="$Cluster_18Billion" id="'methane'" value="0"/>
                    <set_terraforming_stat cluster="$Cluster_18Billion" id="'humidity'" value="4"/>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_MemoryOfProfit" version="1">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="not $Cluster_MemoryOfProfit_Completed?">
              <find_cluster name="$Cluster_MemoryOfProfit" macro="macro.cluster_03_macro"/>
              <add_to_group groupname="$TerraformingClusters" object="$Cluster_MemoryOfProfit"/>
              <append_to_list name="$OfferCues" exact="Terraforming_MemoryOfProfit_CreateOffer"/>
              <signal_cue cue="Refresh_Offers" check="false"/>
              <initialise_terraforming cluster="$Cluster_MemoryOfProfit" partname="'planet'"/>
              <!--Set initial stats-->
              <set_terraforming_stat cluster="$Cluster_MemoryOfProfit" id="'temperature'" value="6"/>
              <set_terraforming_stat cluster="$Cluster_MemoryOfProfit" id="'oxygen'" value="0"/>
              <set_terraforming_stat cluster="$Cluster_MemoryOfProfit" id="'methane'" value="3"/>
              <set_terraforming_stat cluster="$Cluster_MemoryOfProfit" id="'humidity'" value="2"/>
              <set_terraforming_stat cluster="$Cluster_MemoryOfProfit" id="'population'" value="0"/>
              <set_value name="$AddedAtmoPressureTable.{$Cluster_MemoryOfProfit}" exact="0" comment="3 methane / 4"/>
              <!--Set up projects-->
              <run_actions ref="SetupGeneralProjects">
                <param name="Cluster" value="$Cluster_MemoryOfProfit"/>
              </run_actions>
              <add_terraforming_project cluster="$Cluster_MemoryOfProfit" id="'eco_nividium'"/>
              <add_terraforming_project cluster="$Cluster_MemoryOfProfit" id="'eco_nividium_supply'">
                <predecessors>
                  <predecessor id="'eco_nividium'"/>
                </predecessors>
              </add_terraforming_project>
              <!--Create mission character-->
              <create_cue_actor name="$Teladi_Capitalist_Contact" cue="namespace" macro="character_teladi_female_terraforming_capitalist_macro">
                <page exact="10553"/>
                <owner exact="faction.teladi"/>
                <skills>
                  <skill type="management"  exact="11"/>
                  <skill type="morale"      exact="7"/>
                  <skill type="piloting"    exact="6"/>
                  <skill type="engineering" exact="2"/>
                  <skill type="boarding"    exact="0"/>
                </skills>
              </create_cue_actor>
              <set_entity_traits entity="$Teladi_Capitalist_Contact" missionactor="true"/>
            </do_if>
          </actions>
          <patch sinceversion="1">
            <do_if value="$Cluster_MemoryOfProfit.terraforming.stat.airpressure.exists">
              <remove_terraforming_stat cluster="$Cluster_MemoryOfProfit" id="'airpressure'"/>
              <debug_text text="'Removed airpressure from $Cluster_MemoryOfProfit - test: ' + $Cluster_MemoryOfProfit.terraforming.stat.airpressure.exists"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Terraforming_MemoryOfProfit_CreateOffer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating offer for cue Terraforming_MemoryOfProfit_CreateMission'" chance="$DebugChance"/>
                <find_sector name="$Sector_MemoryOfProfit" space="$Cluster_MemoryOfProfit"/>
                <do_if value="$HQ.hasbeenrenamed">
                  <set_value name="$HQName" exact="$HQ.knownname"/>
                </do_if>
                <do_else>
                  <set_value name="$HQName" exact="{20102,2011}"/>
                </do_else>
                <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                  <replace string="'$STATION$'" with="$HQName"/>
                  <replace string="'$LOCATION$'" with="$Sector_MemoryOfProfit.knownname"/>
                </substitute_text>
                <create_offer cue="Terraforming_MemoryOfProfit_CreateMission" type="missiontype.think" actor="$BosoTa" difficulty="level.hard" faction="faction.teladi" group="missiongroup.terraforming" name="{30509,1000}" description="{30509,1001}" rewardtext="{30509,1002}">
                  <briefing>
                    <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_MemoryOfProfit"/>
                    <objective step="2" action="objective.build_project" text="terraforming.project.eco_nividium.name"/>
                  </briefing>
                </create_offer>
              </actions>
            </cue>

            <cue name="Terraforming_MemoryOfProfit_CreateMission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating mission for cue Terraforming_MemoryOfProfit_CreateMission'" chance="$DebugChance"/>
                <create_mission cue="Terraforming_MemoryOfProfit_CreateMission" offercue="Terraforming_MemoryOfProfit_CreateMission"/>
                <set_terraforming_mission_activated cluster="$Cluster_MemoryOfProfit" missioncue="Terraforming_MemoryOfProfit_CreateMission"/>
                <!--TODO: check current state, mark objectives as complete when appropriate-->
                <remove_offer cue="Terraforming_MemoryOfProfit_CreateMission"/>
                <set_value name="$AcceptedOfferCue" exact="Terraforming_MemoryOfProfit_CreateOffer"/>
                <do_if value="@$AbortMissionCue">
                  <signal_cue cue="$AbortMissionCue"/>
                </do_if>
                <set_value name="$AbortMissionCue" exact="Terraforming_MemoryOfProfit_AbortMission"/>
                <set_value name="$OptionalSteps" exact="0"/>
              </actions>
              <cues>
                <cue name="Terraforming_MemoryOfProfit_Intro_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Teladi_Capitalist_Contact"/>
                  <param name="DelayInitial"      value="2s"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30509001]]"/>
                  <param name="MissionCue"        value="Terraforming_MemoryOfProfit_CreateMission"/>
                </cue>

                <cue name="Terraforming_MemoryOfProfit_AbortMission">
                  <conditions>
                    <check_any>
                      <event_mission_aborted cue="Terraforming_MemoryOfProfit_CreateMission"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Removing mission for cue Terraforming_MemoryOfProfit_CreateMission'" chance="$DebugChance"/>
                    <remove_mission cue="Terraforming_MemoryOfProfit_CreateMission"/>
                    <remove_value name="$AcceptedOfferCue"/>
                    <remove_value name="$AbortMissionCue"/>
                    <set_terraforming_mission_deactivated cluster="$Cluster_MemoryOfProfit"/>
                    <reset_cue cue="Terraforming_MemoryOfProfit_CreateMission"/>
                    <reset_cue cue="Terraforming_MemoryOfProfit_CreateOffer"/>
                    <signal_cue cue="Refresh_Offers"/>
                  </actions>
                </cue>

                <cue name="Terraforming_MemoryOfProfit_Init_ObjectiveManager" version="4">
                  <actions>
                    <do_if value="not $Cluster_MemoryOfProfit_Completed?">

                      <do_if value="$HQ.cluster != $Cluster_MemoryOfProfit">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="1"/>
                        </do_if>
                        <set_value name="$RelocateComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$RelocateComplete" exact="true"/>
                      </do_else>

                      <do_if value="$Cluster_MemoryOfProfit.terraforming.project.eco_nividium.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="2"/>
                        </do_if>
                        <set_value name="$NividiumComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$NividiumComplete" exact="true"/>
                      </do_else>

                      <do_if value="$HQ.hasbeenrenamed">
                        <set_value name="$HQName" exact="$HQ.knownname"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HQName" exact="{20102,2011}"/>
                      </do_else>
                      <find_sector name="$Sector_MemoryOfProfit" space="$Cluster_MemoryOfProfit"/>
                      <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                        <replace string="'$STATION$'" with="$HQName"/>
                        <replace string="'$LOCATION$'" with="$Sector_MemoryOfProfit.knownname"/>
                      </substitute_text>

                      <do_if value="not $HQ.canbuildclass.{class.ship_s}">
                        <update_mission cue="Terraforming_MemoryOfProfit_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.build_module" object="$HQ" text="{20104,61301}" comment="Build S/M Ship Fabrication Module"/>
                            <objective step="2" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_MemoryOfProfit" completed="$RelocateComplete"/>
                            <objective step="3" action="objective.build_project" text="terraforming.project.eco_nividium.name" completed="$NividiumComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="not $BuildObjective?">
                          <set_value name="$OptionalSteps" operation="add" exact="1"/>
                          <set_value name="$BuildObjective"/>
                          <signal_cue cue="Terraforming_MemoryOfProfit_Trigger_BuildModule_Objective"/>
                        </do_if>
                        <set_objective_from_briefing cue="Terraforming_MemoryOfProfit_CreateMission" step="1"/>
                      </do_if>
                      <do_else>
                        <do_if value="$BuildObjective?">
                          <set_value name="$OptionalSteps" operation="subtract" exact="1"/>
                          <remove_value name="$BuildObjective"/>
                        </do_if>
                        <update_mission cue="Terraforming_MemoryOfProfit_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_MemoryOfProfit" completed="$RelocateComplete"/>
                            <objective step="2" action="objective.build_project" text="terraforming.project.eco_nividium.name" completed="$NividiumComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="$OptionalSteps ge 1">
                          <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        </do_if>
                        <do_else>
                          <set_value name="$OptionalSteps" exact="0"/>
                        </do_else>
                        <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        <set_objective_from_briefing cue="Terraforming_MemoryOfProfit_CreateMission" step="$ProjectStep"/>
                      </do_else>
                      <remove_value name="$ProjectStep"/>
                      <remove_value name="$RelocateObjectiveText"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$OptionalSteps" exact="0"/>
                    <reset_cue cue="Terraforming_MemoryOfProfit_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="3">
                    <reset_cue cue="Terraforming_MemoryOfProfit_Trigger_BuildModule_Objective"/>
                    <reset_cue cue="Terraforming_MemoryOfProfit_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="4">
                    <reset_cue cue="Terraforming_MemoryOfProfit_Init_ObjectiveManager"/>
                  </patch>
                </cue>

                <cue name="Terraforming_MemoryOfProfit_BuildModule_Check">
                  <actions>
                    <find_object_component groupname="$WharfModules" object="$HQ" class="class.buildmodule">
                      <match_any>
                        <match canbuildclass="class.ship_m"/>
                        <match canbuildclass="class.ship_s"/>
                      </match_any>
                    </find_object_component>
                  </actions>
                  <cues>
                    <cue name="Terraforming_MemoryOfProfit_BuildModuleDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$WharfModules"/>
                        <check_value value="$WharfModules.count == 1" comment="trigger another check when the last build module is destroyed"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Terraforming_MemoryOfProfit_ObjectiveUpdate" param="['RequestBuildModule']"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Terraforming_MemoryOfProfit_ObjectiveUpdate" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_terraforming_stat_changed cluster="$Cluster_MemoryOfProfit"/>
                      <event_terraforming_project_succeeded cluster="$Cluster_MemoryOfProfit"/>
                      <event_object_changed_cluster object="$HQ"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="typeof event.param == datatype.list ">
                      <do_if value="event.param.{1} == 'ModulesGroup'" comment="make sure the signal came from CheckStation_BuildModule">
                        <add_to_group groupname="$WharfModules" group="event.param.{2}"/>
                      </do_if>
                    </do_if>
                    <reset_cue cue="Terraforming_MemoryOfProfit_Init_ObjectiveManager"/>
                  </actions>
                </cue>

                <cue name="Terraforming_MemoryOfProfit_Trigger_BuildModule_Objective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Terraforming_MemoryOfProfit_BuildModule" ref="AdditionalObjective_BuildModule">
                      <!-- Required to Signal the Update Cue when Building is finished -->
                      <param name="UpdateCue" value="Terraforming_MemoryOfProfit_ObjectiveUpdate"/>
                      <param name="Station" value="$HQ"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <!--Objective cues-->

            <cue name="Terraforming_MemoryOfProfit_Milestone_1">
              <conditions>
                <event_terraforming_project_succeeded cluster="$Cluster_MemoryOfProfit"/>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.teladi" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.01"/>
              </actions>
              <cues>
                <cue name="Terraforming_MemoryOfProfit_Contact_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Teladi_Capitalist_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30509002]]"/>
                  <param name="MissionCue"        value="Terraforming_MemoryOfProfit_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_MemoryOfProfit_Milestone_2">
              <conditions>
                <event_terraforming_stat_changed cluster="$Cluster_MemoryOfProfit" stat="'population'"/>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.teladi" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.02"/>
              </actions>
              <cues>
                <cue name="Terraforming_MemoryOfProfit_Contact_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Teladi_Capitalist_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30509003]]"/>
                  <param name="MissionCue"        value="Terraforming_MemoryOfProfit_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_MemoryOfProfit_MissionComplete" version="6">
              <conditions>
                <event_terraforming_project_succeeded cluster="$Cluster_MemoryOfProfit" project="'eco_nividium'"/>
              </conditions>
              <actions>
                <add_faction_relation faction="faction.teladi" otherfaction="faction.player" reason="relationchangereason.missioncompleted" value="0.1"/>
                <set_world_name cluster="$Cluster_MemoryOfProfit" partname="'planet'" page="20005" line="6050" comment="PTNI Headquarters"/>
                <set_world_settlements cluster="$Cluster_MemoryOfProfit" partname="'planet'" page="1042" line="16021" comment="Mining Colonies"/>
                <remove_value name="$AbortMissionCue"/>
                <remove_from_list name="$OfferCues" exact="Terraforming_MemoryOfProfit_CreateOffer" multiple="false" />
                <remove_mission cue="Terraforming_MemoryOfProfit_CreateMission" type="completed"/>
                <set_value name="$Cluster_MemoryOfProfit_Completed"/>
                <set_terraforming_mission_completed cluster="$Cluster_MemoryOfProfit"/>
                <unlock_achievement name="TERRAFORMING_MISSION"/>
                <set_value name="stat.terraforming_missions_completed" operation="add"/>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_memory_of_profit"/>
              </actions>
              <patch sinceversion="2">
                <remove_from_list name="$OfferCues" exact="Terraforming_MemoryOfProfit_CreateOffer" multiple="false" />
              </patch>
              <patch sinceversion="3">
                <set_terraforming_mission_completed cluster="$Cluster_MemoryOfProfit"/>
              </patch>
              <patch sinceversion="4">
                <set_world_name cluster="$Cluster_MemoryOfProfit" partname="'planet'" page="20005" line="6050" comment="PTNI Headquarters"/>
              </patch>
              <patch sinceversion="5">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_terraforming_memory_of_profit"/>
              </patch>
              <patch sinceversion="6" state="complete">
                <set_world_settlements cluster="$Cluster_MemoryOfProfit" partname="'planet'" page="1042" line="16021" comment="Mining Colonies"/>
              </patch>
              <cues>
                <cue name="Terraforming_MemoryOfProfit_VideoEmail">
                  <actions>
                    <substitute_text text="$EmailTitle" source="{30500,11001}">
                      <replace string="'$CLUSTERNAME$'" with="$Cluster_MemoryOfProfit.knownname"/>
                    </substitute_text>

                    <write_incoming_message title="$EmailTitle" text="{30500,11002}" source="if player.target then player.target else player.entity.container" highpriority="true" comment="Memory Of Profit Terraforming Wrap Email">
                      <cutscene key="'terraforming_memory_of_profit'"/>
                    </write_incoming_message>
                  </actions>
                </cue>

                <cue name="Terraforming_MemoryOfProfit_Report_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Teladi_Capitalist_Contact"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30509004]]"/>
                  <param name="MissionCue"        value="Terraforming_MemoryOfProfit_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="DEBUG_Terraforming_MemoryOfProfit" onfail="cancel">
              <conditions>
                <check_value value="$DebugWarpCues?"/>
              </conditions>
              <delay exact="1ms"/>
              <actions>
                <append_to_list name="$DebugWarpCues" exact="DEBUG_Terraforming_MemoryOfProfit_WarpPlayerShip"/>
                <append_to_list name="$DebugSetStatsCues" exact="DEBUG_Terraforming_MemoryOfProfit_SetEndStats"/>
              </actions>
              <cues>
                <cue name="DEBUG_Terraforming_MemoryOfProfit_WarpPlayerShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="DEBUG_Terraforming_WarpPlayerShip">
                      <param name="Cluster" value="$Cluster_MemoryOfProfit"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="DEBUG_Terraforming_MemoryOfProfit_SetEndStats">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_terraforming_stat cluster="$Cluster_MemoryOfProfit" id="'oxygen'" value="9"/>
                    <set_terraforming_stat cluster="$Cluster_MemoryOfProfit" id="'methane'" value="0"/>
                    <set_terraforming_stat cluster="$Cluster_MemoryOfProfit" id="'humidity'" value="4"/>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Terraforming_Xenon_TharkasCascade">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="not $Cluster_Xenon_TharkasCascade_Completed?">
              <find_cluster name="$Cluster_TharkasCascade" macro="macro.cluster_32_macro"/>
              <add_to_group groupname="$TerraformingClusters" object="$Cluster_TharkasCascade"/>
              <add_to_group groupname="$XenonTerraformingClusters" object="$Cluster_TharkasCascade"/>
              <append_to_list name="$OfferCues" exact="Terraforming_Xenon_TharkasCascade_CreateOffer"/>
              <signal_cue cue="Refresh_Offers" check="false"/>
              <initialise_terraforming cluster="$Cluster_TharkasCascade" partname="'planet001c'"/>
              <!--Set initial stats-->
              <set_terraforming_stat cluster="$Cluster_TharkasCascade" id="'xenon_alertness'" value="0"/>
              <set_terraforming_stat cluster="$Cluster_TharkasCascade" id="'xenon_production'" value="0"/>
              <!--Set up projects-->
              <do_all exact="3" counter="$Index">
                <run_actions ref="AddXenonDistricts">
                  <param name="Cluster" value="$Cluster_TharkasCascade"/>
                  <param name="Index" value="'_' + $Index"/>
                </run_actions>
              </do_all>
            </do_if>
          </actions>
          <cues>
            <cue name="Terraforming_Xenon_TharkasCascade_CreateOffer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating offer for cue Terraforming_Xenon_TharkasCascade_CreateMission'" chance="$DebugChance"/>
                <do_if value="$HQ.hasbeenrenamed">
                  <set_value name="$HQName" exact="$HQ.knownname"/>
                </do_if>
                <do_else>
                  <set_value name="$HQName" exact="{20102,2011}"/>
                </do_else>
                <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                  <replace string="'$STATION$'" with="$HQName"/>
                  <replace string="'$LOCATION$'" with="$Cluster_TharkasCascade.knownname"/>
                </substitute_text>
                <create_offer cue="Terraforming_Xenon_TharkasCascade_CreateMission" type="missiontype.think" actor="$BosoTa" difficulty="level.impossible" faction="faction.player" group="missiongroup.terraforming" name="{30501,1000}" description="{30501,1001}" rewardtext="{30501,1002}">
                  <briefing>
                    <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_TharkasCascade"/>
                    <objective step="2" action="objective.destroy" text="{30501,2001}"/>
                  </briefing>
                </create_offer>
              </actions>
            </cue>

            <cue name="Terraforming_Xenon_TharkasCascade_CreateMission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Creating mission for cue Terraforming_Xenon_TharkasCascade_CreateMission'" chance="$DebugChance"/>
                <create_mission cue="Terraforming_Xenon_TharkasCascade_CreateMission" offercue="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                <set_terraforming_mission_activated cluster="$Cluster_TharkasCascade" missioncue="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                <!--TODO: check current state, mark objectives as complete when appropriate-->
                <remove_offer cue="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                <set_value name="$AcceptedOfferCue" exact="Terraforming_Xenon_TharkasCascade_CreateOffer"/>
                <do_if value="@$AbortMissionCue">
                  <signal_cue cue="$AbortMissionCue"/>
                </do_if>
                <set_value name="$AbortMissionCue" exact="Terraforming_Xenon_TharkasCascade_AbortMission"/>
                <set_value name="$OptionalSteps" exact="0"/>
              </actions>
              <cues>
                <cue name="Terraforming_TharkasCascade_Intro_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30501001]]"/>
                  <param name="MissionCue"        value="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                </cue>

                <cue name="Terraforming_Xenon_TharkasCascade_AbortMission">
                  <conditions>
                    <check_any>
                      <event_mission_aborted cue="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Removing mission for cue Terraforming_Xenon_TharkasCascade_CreateMission'" chance="$DebugChance"/>
                    <remove_mission cue="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                    <remove_value name="$AcceptedOfferCue"/>
                    <remove_value name="$AbortMissionCue"/>
                    <set_terraforming_mission_deactivated cluster="$Cluster_TharkasCascade"/>
                    <reset_cue cue="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                    <reset_cue cue="Terraforming_Xenon_TharkasCascade_CreateOffer"/>
                    <signal_cue cue="Refresh_Offers"/>
                  </actions>
                </cue>

                <cue name="Terraforming_Xenon_TharkasCascade_Init_ObjectiveManager" version="4">
                  <actions>
                    <do_if value="not $Cluster_TharkasCascade_Completed?">

                      <do_if value="$HQ.cluster != $Cluster_TharkasCascade">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="1"/>
                        </do_if>
                        <set_value name="$RelocateComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$RelocateComplete" exact="true"/>
                      </do_else>


                      <do_if value="$Cluster_TharkasCascade.terraforming.project.xen_reactor_detonate_1.complete == false">
                        <do_if value="not $ProjectStep?">
                          <set_value name="$ProjectStep" exact="2"/>
                        </do_if>
                        <set_value name="$ReactorComplete" exact="false"/>
                      </do_if>
                      <do_else>
                        <set_value name="$ReactorComplete" exact="true"/>
                      </do_else>

                      <do_if value="$HQ.hasbeenrenamed">
                        <set_value name="$HQName" exact="$HQ.knownname"/>
                      </do_if>
                      <do_else>
                        <set_value name="$HQName" exact="{20102,2011}"/>
                      </do_else>
                      <substitute_text text="$RelocateObjectiveText" source="{1004,1091}">
                        <replace string="'$STATION$'" with="$HQName"/>
                        <replace string="'$LOCATION$'" with="$Cluster_TharkasCascade.knownname"/>
                      </substitute_text>

                      <do_if value="not $HQ.canbuildclass.{class.ship_s}">
                        <update_mission cue="Terraforming_Xenon_TharkasCascade_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.build_module" object="$HQ" text="{20104,61301}" comment="Build S/M Ship Fabrication Module"/>
                            <objective step="2" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_TharkasCascade" completed="$RelocateComplete"/>
                            <objective step="3" action="objective.destroy" text="{30501,2001}" completed="$ReactorComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="not $BuildObjective?">
                          <set_value name="$OptionalSteps" operation="add" exact="1"/>
                          <set_value name="$BuildObjective"/>
                          <signal_cue cue="Terraforming_Xenon_TharkasCascade_Trigger_BuildModule_Objective"/>
                        </do_if>
                        <set_objective_from_briefing cue="Terraforming_Xenon_TharkasCascade_CreateMission" step="1"/>
                      </do_if>
                      <do_else>
                        <do_if value="$BuildObjective?">
                          <set_value name="$OptionalSteps" operation="subtract" exact="1"/>
                          <remove_value name="$BuildObjective"/>
                        </do_if>
                        <update_mission cue="Terraforming_Xenon_TharkasCascade_CreateMission">
                          <briefing replace="true">
                            <objective step="1" action="objective.relocate" text="$RelocateObjectiveText" encyclopedia="$Cluster_TharkasCascade" completed="$RelocateComplete"/>
                            <objective step="2" action="objective.destroy" text="{30501,2001}" completed="$ReactorComplete"/>
                          </briefing>
                        </update_mission>
                        <do_if value="$OptionalSteps ge 1">
                          <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        </do_if>
                        <do_else>
                          <set_value name="$OptionalSteps" exact="0"/>
                        </do_else>
                        <set_value name="$ProjectStep" operation="add" exact="$OptionalSteps"/>
                        <set_objective_from_briefing cue="Terraforming_Xenon_TharkasCascade_CreateMission" step="$ProjectStep"/>
                      </do_else>

                      <remove_value name="$ProjectStep"/>
                      <remove_value name="$RelocateObjectiveText"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$OptionalSteps" exact="0"/>
                    <reset_cue cue="Terraforming_Xenon_TharkasCascade_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="3">
                    <reset_cue cue="Terraforming_Xenon_TharkasCascade_Trigger_BuildModule_Objective"/>
                    <reset_cue cue="Terraforming_Xenon_TharkasCascade_Init_ObjectiveManager"/>
                  </patch>
                  <patch sinceversion="4">
                    <reset_cue cue="Terraforming_Xenon_TharkasCascade_Init_ObjectiveManager"/>
                  </patch>
                </cue>

                <cue name="Terraforming_Xenon_TharkasCascade_BuildModule_Check">
                  <actions>
                    <find_object_component groupname="$WharfModules" object="$HQ" class="class.buildmodule">
                      <match_any>
                        <match canbuildclass="class.ship_m"/>
                        <match canbuildclass="class.ship_s"/>
                      </match_any>
                    </find_object_component>
                  </actions>
                  <cues>
                    <cue name="Terraforming_Xenon_TharkasCascade_BuildModuleDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$WharfModules"/>
                        <check_value value="$WharfModules.count == 1" comment="trigger another check when the last build module is destroyed"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Terraforming_Xenon_TharkasCascade_ObjectiveUpdate" param="['RequestBuildModule']"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Terraforming_Xenon_TharkasCascade_ObjectiveUpdate" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_terraforming_stat_changed cluster="$Cluster_TharkasCascade"/>
                      <event_terraforming_project_succeeded cluster="$Cluster_TharkasCascade"/>
                      <event_object_changed_cluster object="$HQ"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="typeof event.param == datatype.list ">
                      <do_if value="event.param.{1} == 'ModulesGroup'" comment="make sure the signal came from CheckStation_BuildModule">
                        <add_to_group groupname="$WharfModules" group="event.param.{2}"/>
                      </do_if>
                    </do_if>
                    <reset_cue cue="Terraforming_Xenon_TharkasCascade_Init_ObjectiveManager"/>
                  </actions>
                </cue>

                <cue name="Terraforming_Xenon_TharkasCascade_Trigger_BuildModule_Objective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Terraforming_Xenon_TharkasCascade_BuildModule" ref="AdditionalObjective_BuildModule">
                      <!-- Required to Signal the Update Cue when Building is finished -->
                      <param name="UpdateCue" value="Terraforming_Xenon_TharkasCascade_ObjectiveUpdate"/>
                      <param name="Station" value="$HQ"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <!--Objective cues-->

            <cue name="Terraforming_Xenon_TharkasCascade_Milestone_1">
              <conditions>
                <check_any>
                  <event_terraforming_project_succeeded cluster="$Cluster_TharkasCascade" project="'xen_core_subvert_1'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_TharkasCascade" project="'xen_reactor_detonate_1'"/>
                </check_any>
              </conditions>
              <cues>
                <cue name="Terraforming_Xenon_TharkasCascade_Contact_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30503001]]"/>
                  <param name="MissionCue"        value="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_Xenon_TharkasCascade_Milestone_2">
              <conditions>
                <check_any>
                  <event_terraforming_project_succeeded cluster="$Cluster_TharkasCascade" project="'xen_core_subvert_2'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_TharkasCascade" project="'xen_reactor_detonate_2'"/>
                </check_any>
              </conditions>
              <cues>
                <cue name="Terraforming_Xenon_TharkasCascade_Contact_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30503002]]"/>
                  <param name="MissionCue"        value="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                </cue>
              </cues>
            </cue>

            <cue name="Terraforming_Xenon_TharkasCascade_MissionComplete">
              <conditions>
                <check_any>
                  <event_terraforming_project_succeeded cluster="$Cluster_TharkasCascade" project="'xen_core_subvert_3'"/>
                  <event_terraforming_project_succeeded cluster="$Cluster_TharkasCascade" project="'xen_reactor_detonate_3'"/>
                </check_any>
              </conditions>
              <actions>
                <cancel_cue cue="Terraforming_Xenon_TharkasCascade_ObjectiveUpdate"/>
                <!--TODO: give a very big relation boost with all factions where it makes sense-->
                <set_world_name cluster="$Cluster_TharkasCascade" partname="'planet001c'" page="20005" line="9055" comment="Deliverance"/>
                <set_world_name cluster="$Cluster_TharkasCascade" partname="'sphere002'" page="20005" line="9056" comment="Pebble"/>
                <remove_value name="$AbortMissionCue"/>
                <remove_from_list name="$OfferCues" exact="Terraforming_Xenon_TharkasCascade_CreateOffer"/>
                <remove_mission cue="Terraforming_Xenon_TharkasCascade_CreateMission" type="completed"/>
                <set_value name="$Cluster_TharkasCascade_Completed"/>
                <set_terraforming_mission_completed cluster="$Cluster_TharkasCascade"/>
                <unlock_achievement name="TERRAFORMING_MISSION"/>
                <unlock_achievement name="TERRAFORMING_IMPOSSIBLE"/>
                <set_value name="stat.terraforming_missions_completed" operation="add"/>
              </actions>
              <cues>
                <cue name="Terraforming_Xenon_TharkasCascade_VideoEmail">
                  <actions>
                    <substitute_text text="$EmailTitle" source="{30500,11001}">
                      <replace string="'$CLUSTERNAME$'" with="$Cluster_TharkasCascade.knownname"/>
                    </substitute_text>

                    <write_incoming_message title="$EmailTitle" text="{30500,11002}" source="if player.target then player.target else player.entity.container" highpriority="true" comment="Tharkas Cascade Terraforming Wrap Email">
                      <cutscene key="'terraforming_tharkas_cascade'"/>
                    </write_incoming_message>
                  </actions>
                </cue>

                <cue name="Terraforming_Xenon_TharkasCascade_Report_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="table[ $key = 'ShowCharacter']"/>
                  <param name="Lines"             value="[[30506004]]"/>
                  <param name="MissionCue"        value="Terraforming_Xenon_TharkasCascade_CreateMission"/>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

      </cues>
    </cue>
  </cues>
</mdscript>
