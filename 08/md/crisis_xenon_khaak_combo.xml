<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Crisis_Xenon_Khaak_Combo" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <cue name="StaticData" namespace="this" version="2">
      <actions>
        <set_value name="$ShipStrengthTable" exact="table[]"/>

        <!--Xenon / Terraformers-->
        <set_value name="$ShipStrengthTable.{macro.ship_xen_xl_carrier_01_a_macro}"     exact="60000" comment="Xenon I"/>
        <set_value name="$ShipStrengthTable.{macro.ship_xen_xl_destroyer_01_a_macro}"   exact="40000" comment="Xenon K"/>
        <set_value name="$ShipStrengthTable.{macro.ship_xen_l_terraformer_01_a_macro}"  exact="40000" comment="Terraformer L Capship"/>
        <set_value name="$ShipStrengthTable.{macro.ship_xen_m_corvette_01_a_macro}"     exact="5000"  comment=""/>
        <!--<set_value name="$ShipStrengthTable.{macro.ship_xen_m_corvette_01_b_macro}"     exact="5000"  comment=""/>-->
        <set_value name="$ShipStrengthTable.{macro.ship_xen_m_fighter_01_a_macro}"      exact="4000"  comment=""/>
        <set_value name="$ShipStrengthTable.{macro.ship_xen_s_fighter_01_a_macro}"      exact="600"   comment=""/>
        <set_value name="$ShipStrengthTable.{macro.ship_xen_s_fighter_02_a_macro}"      exact="500"   comment=""/>
        <set_value name="$ShipStrengthTable.{macro.ship_xen_s_heavyfighter_01_a_macro}" exact="500"   comment=""/>
        <!--<set_value name="$ShipStrengthTable.{macro.ship_xen_s_heavyfighter_01_b_macro}" exact="500"   comment=""/>-->
        <set_value name="$ShipStrengthTable.{macro.ship_xen_s_scout_01_a_macro}"        exact="500"   comment=""/>

        <!--Kha'ak-->
        <set_value name="$ShipStrengthTable.{macro.ship_kha_l_destroyer_01_a_macro}"    exact="50000"/>
        <set_value name="$ShipStrengthTable.{macro.ship_kha_m_fighter_01_a_macro}"      exact="4000"  comment=""/>
        <set_value name="$ShipStrengthTable.{macro.ship_kha_m_fighter_02_a_macro}"      exact="4000"  comment=""/>
        <set_value name="$ShipStrengthTable.{macro.ship_kha_s_fighter_01_a_macro}"      exact="500"   comment=""/>
        <set_value name="$ShipStrengthTable.{macro.ship_kha_s_fighter_02_a_macro}"      exact="500"   comment=""/>



        <!--Table of wave definitions used to create the Xenon, set up suborinates and orders-->
        <set_value name="$XenonDefinitions" exact="table[]"/>

        <!---->
        <set_value name="$XenonDefinitions.$xen_I_with_K_escorts_1" exact="table[
                   $ship = 'xenon_carrier_xl',
                   $subordinates =
                        [
                          '$xen_K_with_SizeM_escorts_1',
                          '$xen_K_with_SizeM_escorts_1',
                          '$xen_K_with_SizeM_escorts_1'
                        ]
                   ]"/>

        <set_value name="$XenonDefinitions.$xen_I_with_K_escorts_2" exact="table[
                   $ship = 'xenon_carrier_xl',
                   $subordinates =
                        [
                          '$xen_K_with_SizeM_escorts_1',
                        ]
                   ]"/>

        <set_value name="$XenonDefinitions.$xen_K_with_SizeM_escorts_1" exact="table[
                   $ship = 'xenon_destroyer_xl',
                   $subordinates =
                        [
                          '$xen_SizeM_with_SizeS_escorts_1',
                          '$xen_SizeM_with_SizeS_escorts_1',
                          '$xen_SizeM_with_SizeS_escorts_1'
                        ]
                   ]"/>

        <set_value name="$XenonDefinitions.$xen_SizeM_with_SizeS_escorts_1" exact="table[
                   $ship = 'xenon_corvette_m',
                   $subordinatesoptional = true,
                   $subordinates =
                        [
                          'xenon_fighter_s',
                          'xenon_fighter_s',
                          'xenon_fighter_s'
                        ]
                   ]"/>

        <set_value name="$LeadXenonSpawnDefinitions" exact="['$xen_I_with_K_escorts_1']"/>

        <set_value name="$KhaakDefinitions" exact="table[]"/>

        <set_value name="$KhaakDefinitions.$kha_capship_with_SizeM_escorts_1" exact="table[
                   $ship = 'khaak_destroyer_l',
                   $subordinates =
                        [
                          '$kha_SizeM_with_SizeS_escorts_1',
                          '$kha_SizeM_with_SizeS_escorts_1',
                          '$kha_SizeM_with_SizeS_escorts_1'
                        ]
                   ]"/>

        <set_value name="$KhaakDefinitions.$kha_capship_with_SizeM_escorts_2" exact="table[
                   $ship = 'khaak_destroyer_l',
                   $subordinates =
                        [
                          'khaak_fighter_m',
                          'khaak_fighter_m',
                          'khaak_fighter_m',
                          'khaak_fighter_m'
                        ]
                   ]"/>

        <set_value name="$KhaakDefinitions.$kha_SizeM_with_SizeM_escorts_1" exact="table[
                   $ship = 'khaak_fighter_m',
                   $subordinates =
                        [
                          '$kha_SizeM_with_SizeS_escorts_1',
                          '$kha_SizeM_with_SizeS_escorts_1',
                          '$kha_SizeM_with_SizeS_escorts_1'
                        ]
                   ]"/>

        <set_value name="$KhaakDefinitions.$kha_SizeM_with_SizeS_escorts_1" exact="table[
                   $ship = 'khaak_fighter_m',
                   $subordinates =
                        [
                          'khaak_fighter_s_escort',
                          'khaak_fighter_s_escort',
                          'khaak_fighter_s_escort'
                        ]
                   ]"/>

        <set_value name="$KhaakDefinitions.$kha_SizeS_with_SizeS_escorts_1" exact="table[
                   $ship = 'khaak_fighter_s_leader',
                   $subordinates =
                        [
                          'khaak_fighter_s_escort',
                          'khaak_fighter_s_escort',
                          'khaak_fighter_s_escort'
                        ]
                   ]"/>

        <set_value name="$KhaakSpawnEffects" exact="table[
                   {class.ship_s} = 'jump_jumpin_khaak',
                   {class.ship_m} = 'jump_jumpin_khaak',
                   {class.ship_l} = 'jump_jumpin_capship',
                   {class.ship_xl} = 'jump_jumpin_capship',]"/>
      </actions>
      <patch sinceversion="2">
        <reset_cue cue="this"/>
      </patch>
      <cues>
        <cue name="StaticData_KeepAlive">
          <conditions>
            <event_cue_signalled/>
          </conditions>
        </cue>
      </cues>
    </cue>

    <library name="Start" namespace="this" version="5">
      <params>
        <param name="ThreatenPlayer"            default="true"          comment="Send a threat to the player. Otherwise trigger automatically"/>
        <param name="ThreatDuration"            default="30min"         comment="How long does to the player have to react to the threat to avoid the triggering of the crisis"/>
        <param name="PostponeDuration"          default="20h"           comment="How long after postponing the crisis until called about the threat again?"/>
        <param name="CeilingTotalValue"         default="3000000000Cr"  comment="The player asset value used with $MinTotalValue to scale the length of the crisis"/>
        <param name="MinTotalValue"             default="600000000Cr"   comment="Minimum total value (set to negative to not check)"/>
        <param name="MinTotalMilitaryValue"     default="400000000Cr"   comment="Minimum total military value"/>
        <param name="MinMilitaryShipValue"      default="-1Cr"          comment="Minimum military ship value"/>
        <param name="MinMilitaryStationValue"   default="-1Cr"          comment="Minimum military station value"/>
        <param name="ResearchTriggerFactor"     default="0.75"          comment="Factor of player value params at which to trigger the crisis research"/>

        <param name="MinNumInvasions"           default="16"            comment="Minimum number of invasions the crisis can have before the final phase, scaled to player empire value"/>
        <param name="MaxNumInvasions"           default="20"            comment="Maximum number of invasions the crisis can have before the final phase, scaled to player empire value"/>
        <param name="MinSectorPoints"           default="400000"/>
        <param name="MaxSectorPoints"           default="3000000"/>
        <param name="SingularInvasionChance"    default="60"            comment="Percentage chance of a new invasion triggering while there is no current invasion. See Invasion_Ticker"/>
        <!--TODO @Owen increase the chance of concurrent invasions in the later stages-->
        <param name="ConcurrentInvasionChance"  default="5"            comment="Percentage chance of a new invasion triggering while another is already active. See Invasion_Ticker"/>
        <param name="MaxConcurrentInvasions"    default="4"             comment="Maximum number of sectors that can be invaded at the same time."/>
        <param name="FleeingXenonTargetSecValue" default="10000000Cr"   comment="The minimum property value the player has in a nearby sector for the fleeing Xenon ships to target. If none exists, the sector is selected randomly."/>
        <param name="CrisisPointsFactor"        default="0.5"           comment=""/>
        <param name="DebugChance"               default="0"/>
        <param name="QuickMode"                 default="false"/>
      </params>
      <actions>
        <set_value name="$FacXenon" exact="faction.xenon"/>
        <set_value name="$FacKha" exact="faction.khaak"/>

        <set_value name="$CPU_Macro" exact="macro.ship_tfm_xl_carrier_01_a_macro"/>
        <!--Basegame sectors. Extensions can append to the list.-->
        <set_value name="$PotentialCPUSectorMacros" exact="[]"/>
        <append_to_list name="$PotentialCPUSectorMacros" exact="macro.cluster_709_Sector001_macro" comment="Cardinal's Domain"/>
        <append_to_list name="$PotentialCPUSectorMacros" exact="macro.cluster_710_Sector001_macro" comment="Moo-Kye's Revenge"/>
        <append_to_list name="$PotentialCPUSectorMacros" exact="macro.cluster_711_Sector001_macro" comment="Mi Ton's Refuge"/>
        <append_to_list name="$PotentialCPUSectorMacros" exact="macro.cluster_712_Sector001_macro" comment="Loomanckstrat's Legacy"/>

        <set_value name="$CPU_Ship_Name_Table" exact="table[
                   {macro.ship_tfm_xl_carrier_01_a_macro} = [20101,75201],
                   {macro.ship_xen_m_corvette_01_a_macro} = [30236,3001],
                   {macro.ship_xen_s_heavyfighter_01_a_macro} = [30236,3002],
                   ]"/>

        <set_value name="$CrisisThreatCallCount" exact="0"/>
        <set_value name="$MasterHistoryList" exact="[]"/>
        <set_value name="$FeedbackCounterTable" exact="table[]"/>
        <set_value name="$LastUpdateEmailID" exact="0"/>

      </actions>
      <patch sinceversion="2">
        <set_value name="$PostponeDuration" exact="20h"/>
        <do_if value="TriggerThreat_BosoCalls.state == cuestate.waiting">
          <set_value name="$CrisisThreatCallCount" exact="0"/>
        </do_if>
        <do_else>
          <set_value name="$CrisisThreatCallCount" exact="1"/>
        </do_else>
        <set_value name="$CeilingTotalValue" exact="1200000000Cr"/>
        <set_value name="$MinNumInvasions" exact="16"/>
        <set_value name="$MaxNumInvasions" exact="20"/>
        <set_value name="$ConcurrentInvasionChance" exact="5"/>

        <do_if value="TriggerCrisis.state == cuestate.complete">
          <run_actions ref="md.Player_Evaluator.GetTotalValue" result="$CrisisPlayerValue"/>
          <interpolate_value result="$TargetInvasionCount" value="$CrisisPlayerValue">
            <linear mininput="$MinTotalValue" maxinput="$CeilingTotalValue" minoutput="$MinNumInvasions" maxoutput="$MaxNumInvasions"/>
          </interpolate_value>
          <debug_text text="'Patching running crisis. Current empire value is ' + $CrisisPlayerValue.formatted.default + ' and the crisis will cap at ' + $TargetInvasionCount + ' sector invasions'" filter="savegame"/>
        </do_if>
      </patch>
      <patch sinceversion="3">
        <do_if value="TriggerThreat.state != cuestate.waiting">
          <add_encyclopedia_entry type="researchables" item="'research_xenon_crisis_01'"/>
          <add_research ware="ware.research_xenon_crisis_01"/>
        </do_if>
      </patch>
      <patch sinceversion="4">
        <do_if value="Research_01_Done.state != cuestate.complete and ware.research_xenon_crisis_01.research.unlocked">
          <debug_text text="'Removing research ' + ware.research_xenon_crisis_01 + ' which was unlocked too early'" filter="savegame"/>
          <remove_research ware="ware.research_xenon_crisis_01"/>
        </do_if>
        <do_if value="Research_01_Add.state == cuestate.waiting">
          <remove_encyclopedia_entry type="researchables" item="'research_xenon_crisis_01'"/>
        </do_if>
        <remove_research ware="ware.research_xenon_crisis_02"/>
        <remove_encyclopedia_entry type="researchables" item="'research_xenon_crisis_02'"/>
      </patch>
      <patch sinceversion="5">
        <set_value name="$MinSectorPoints" exact="400000"/>
        <set_value name="$ResearchTriggerFactor" exact="0.75"/>
        <set_value name="$MasterHistoryList" exact="[]"/>
        <set_value name="$FeedbackCounterTable" exact="table[]"/>
        <do_if value="@$InvasionHistory.count">
          <!--<set_value name="$FeedbackCounterTable.$observed_khaak_captive" operation="add"/>-->
        </do_if>
        <set_value name="$LastUpdateEmailID" exact="0"/>
      </patch>

      <cues>
        <cue name="CheckConditions" version="2">
          <delay min="60s" max="80s"/>
          <actions>
            <set_value name="this.$FactionLogic" exact="global.$FactionManagers.{$FacXenon}"/>
            <run_actions result="$CanRequestCrisis" ref="md.Crisis_Manager.CanRequestCrisis"/>

            <do_if value="not this.$FactionLogic or not $FacXenon.isactive">
              <cancel_cue cue="CleanUp"/>
            </do_if>
            <do_elseif value="not $CanRequestCrisis">
              <reset_cue cue="this"/>
            </do_elseif>
            <do_elseif value="md.X4Ep1_Mentor_Subscriptions.UnlockResearch.state != cuestate.complete or not @md.$PersistentCharacters.$BosoTa.hascontext.{player.headquarters}">
              <!--Story not at correct state-->
              <reset_cue cue="this"/>
            </do_elseif>
            <do_elseif value="Research_01_Add.state != cuestate.waiting and (not ware.research_xenon_crisis_01.research.unlocked or player.age lt $MinTriggerTime)">
              <!--Waiting for research completion-->
              <reset_cue cue="this"/>
            </do_elseif>
            <do_else>
              <set_value name="$PassesCriteria" exact="true"/>
              <set_value name="$IsResearch" exact="Research_01_Add.state == cuestate.waiting"/>
              <set_value name="$ValueFactor" exact="if $IsResearch then $ResearchTriggerFactor else 1.0"/>

              <set_value name="$WantedTotalValue" exact="($MinTotalValue * ($ValueFactor * 100)i) / 100"/>
              <set_value name="$WantedMilitaryValue" exact="-1Cr"/>
              <do_if value="$MinTotalMilitaryValue gt 0 and ($MinTotalMilitaryValue lt $WantedMilitaryValue or $WantedMilitaryValue lt 0)">
                <set_value name="$WantedMilitaryValue" exact="($MinTotalMilitaryValue * ($ValueFactor * 100)i) / 100"/>
              </do_if>
              <do_if value="$MinMilitaryShipValue gt 0 and ($MinMilitaryShipValue lt $WantedMilitaryValue or $WantedMilitaryValue lt 0)">
                <set_value name="$WantedMilitaryValue" exact="($MinMilitaryShipValue * ($ValueFactor * 100)i) / 100"/>
              </do_if>
              <do_if value="$MinMilitaryStationValue gt 0 and ($MinMilitaryStationValue lt $WantedMilitaryValue or $WantedMilitaryValue lt 0)">
                <set_value name="$WantedMilitaryValue" exact="($MinMilitaryStationValue * ($ValueFactor * 100)i) / 100"/>
              </do_if>

              <run_actions ref="md.Player_Evaluator.GetTotalValue" result="$PlayerTotalValue"/>
              <run_actions ref="md.Player_Evaluator.GetMilitaryValue" result="$PlayerTotalMilitaryValue"/>

              <debug_text text="'current military ' + $PlayerTotalMilitaryValue.formatted.default + ' wanted ' + $WantedMilitaryValue.formatted.default" chance="$DebugChance"/>
              <debug_text text="'current total ' + $PlayerTotalValue.formatted.default + ' wanted ' + $WantedTotalValue.formatted.default" chance="$DebugChance"/>
              <do_if value="$PlayerTotalMilitaryValue lt $WantedMilitaryValue">
                <!--Early out: Player doesn't have enough value to meet the military criteria-->
                <set_value name="$PassesCriteria" exact="false"/>
              </do_if>
              <do_elseif value="$MinTotalValue gt 0 and ($PlayerTotalValue lt $WantedTotalValue)">
                <!--Early out: Player doesn't have enough value to meet the criteria-->
                <set_value name="$PassesCriteria" exact="false"/>
              </do_elseif>
              <do_else>
                <remove_value name="$WantedTotalValue"/>
                <remove_value name="$WantedMilitaryValue"/>
                <!--Check player totals-->
                <do_if value="$MinTotalMilitaryValue gt 0">
                  <do_if value="$PlayerTotalMilitaryValue lt ($MinTotalMilitaryValue * ($ValueFactor * 100)i) / 100">
                    <set_value name="$PassesCriteria" exact="false"/>
                  </do_if>
                </do_if>

                <do_if value="$PassesCriteria and $MinMilitaryShipValue gt 0">
                  <run_actions ref="md.Player_Evaluator.GetMilitaryValue" result="$ResultStrength">
                    <param name="IncludeShips" value="true"/>
                    <param name="IncludeStations" value="false"/>
                  </run_actions>
                  <do_if value="$ResultStrength lt ($MinMilitaryShipValue * ($ValueFactor * 100)i) / 100">
                    <set_value name="$PassesCriteria" exact="false"/>
                  </do_if>
                </do_if>

                <do_if value="$PassesCriteria and $MinMilitaryStationValue gt 0">
                  <run_actions ref="md.Player_Evaluator.GetMilitaryValue" result="$ResultStrength">
                    <param name="IncludeShips" value="false"/>
                    <param name="IncludeStations" value="true"/>
                  </run_actions>
                  <do_if value="$ResultStrength lt ($MinMilitaryStationValue * ($ValueFactor * 100)i) / 100">
                    <set_value name="$PassesCriteria" exact="false"/>
                  </do_if>
                </do_if>
              </do_else>

              <do_if value="$PassesCriteria">
                <do_if value="$IsResearch">
                  <signal_cue cue="Research_01_Add"/>
                  <reset_cue cue="this"/>
                </do_if>
                <do_else>
                  <signal_cue cue="Activate_CPU_Ship"/>
                  <do_if value="$ThreatenPlayer">
                    <signal_cue cue="TriggerThreat"/>
                  </do_if>
                  <do_else>
                    <signal_cue cue="TriggerCrisis"/>
                  </do_else>
                </do_else>
              </do_if>
              <do_else>
                <reset_cue cue="this"/>
              </do_else>
            </do_else>
          </actions>
          <patch sinceversion="2" state="complete">
            <!--If this cue is complete but the Research_01_Add cue is still waiting then just give the research-->
            <do_if value="Research_01_Add.state == cuestate.waiting">
              <add_encyclopedia_entry type="researchables" item="'research_xenon_crisis_01'"/>
              <add_research ware="ware.research_xenon_crisis_01"/>
            </do_if>
          </patch>
        </cue>

        <cue name="Patch_Research_01_Achievement">
          <delay exact="1s"/>
          <actions>
            <do_if value="ware.research_xenon_crisis_01.research.unlocked">
              <unlock_achievement name="CRISIS_RESEARCH_VIEWED"/>
              <unlock_achievement name="CRISIS_RESEARCH_DONE"/>
            </do_if>
          </actions>
        </cue>

        <cue name="Research_01_Entry_Selected">
          <conditions>
            <event_ui_triggered screen="'ResearchMenu'"/>
            <check_value value="event.param2 == 'research_selected' and ware.{event.param3} == ware.research_xenon_crisis_01"/>
          </conditions>
          <actions>
            <unlock_achievement name="CRISIS_RESEARCH_VIEWED"/>
          </actions>
        </cue>

        <cue name="Research_01_Add" namespace="this">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <add_encyclopedia_entry type="researchables" item="'research_xenon_crisis_01'"/>
            <set_value name="$MissionCue" exact="this"/>
            <set_value name="$DebugChance" exact="Start.$DebugChance"/>
            <set_value name="$MissionActors" exact="table[]"/>
            <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
            <set_value name="$MissionActors.$BosoTa" exact="table[
                                  $entity = $BosoTa,
                                  $monitor = table[
                                    $cutscenekey = 'ShowCharacterBoron',
                                    $caption = true
                                  ]
                                ]"/>
            <write_incoming_message title="{30236,1612}" text="{30236,1523}" source="$BosoTa.knownname" highpriority="true"/>
          </actions>
          <cues>
            <cue name="Research_01_Done">
              <conditions>
                <event_player_research_unlocked ware="ware.research_xenon_crisis_01"/>
              </conditions>
              <actions>
                <unlock_achievement name="CRISIS_RESEARCH_DONE"/>
                <set_value name="Start.$MinTriggerTime" min="player.age + 2h" max="player.age + 3h" comment="Unlikely to happen unless the player is already beyond the trigger threshold"/>
              </actions>
              <cues>
                <cue name="Research_01_Create_Mission">
                  <delay min="40s" max="60s"/>
                  <actions>
                    <do_if value="CPU_Ship_Manager.$CPUShip.cluster.isnormalcluster">
                      <set_value name="$Mission_Variant" exact="'cpu'"/>
                    </do_if>
                    <do_else>
                      <set_value name="$Mission_Variant" exact="'wrecks'"/>
                    </do_else>
                    <create_group groupname="$CreatedObjects"/>

                    <do_if value="$Mission_Variant == 'cpu'">
                      <set_value name="$NameID" exact="1002"/>
                      <set_value name="$DescriptionID" exact="1150"/>
                      <set_value name="$MissionSector" exact="CPU_Ship_Manager.$CPUShip.sector"/>
                      <create_position name="$MissionPos" object="CPU_Ship_Manager.$CPUShip" space="$MissionSector"/>
                      <set_value name="$MissionRadius" exact="25km"/>
                    </do_if>
                    <do_else>
                      <set_value name="$NameID" exact="1003"/>
                      <set_value name="$DescriptionID" exact="1151"/>
                      <find_sector name="$MissionSector" macro="Start.$PotentialCPUSectorMacros.random"/>
                      <run_actions ref="md.LIB_Generic.Create_Position_On_Plane" result="$MissionPos">
                        <param name="AnchorPos" value="$MissionSector.coreposition"/>
                        <param name="Distance" value="[$MissionSector.coresize * 1.3, $MissionSector.coresize * 1.5].randominrange"/>
                      </run_actions>
                      <set_value name="$MissionRadius" exact="15km"/>
                      <create_ship groupname="$CreatedObjects" ref="'xenon_terraformer_l'" sector="$MissionSector" state="componentstate.wreck">
                        <owner exact="faction.xenon"/>
                        <safepos value="$MissionPos" min="2km" max="10km"/>
                        <rotation yaw="[0deg, 360deg].randominrange" pitch="[-45deg, 45deg].randominrange" roll="[-45deg, 45deg].randominrange"/>
                      </create_ship>
                      <do_all exact="10">
                        <do_any>
                          <set_value name="$ShipRef" exact="'xenon_fighter_s'" weight="10"/>
                          <set_value name="$ShipRef" exact="'xenon_gunboat_m'" weight="2"/>
                          <set_value name="$ShipRef" exact="'xenon_corvette_m'" weight="1"/>
                        </do_any>

                        <create_ship groupname="$CreatedObjects" ref="$ShipRef" sector="$MissionSector" state="componentstate.wreck">
                          <owner exact="faction.xenon"/>
                          <safepos value="$MissionPos" max="8km"/>
                          <rotation yaw="[0deg, 360deg].randominrange" pitch="[-45deg, 45deg].randominrange" roll="[-45deg, 45deg].randominrange"/>
                        </create_ship>
                      </do_all>
                      <create_ship groupname="$CreatedObjects" ref="'khaak_destroyer_l'" sector="$MissionSector" state="componentstate.wreck">
                        <owner exact="faction.khaak"/>
                        <safepos value="$MissionPos" min="2km" max="10km"/>
                        <rotation yaw="[0deg, 360deg].randominrange" pitch="[-45deg, 45deg].randominrange" roll="[-45deg, 45deg].randominrange"/>
                      </create_ship>
                      <do_all exact="12">
                        <do_any>
                          <set_value name="$ShipRef" exact="'khaak_fighter_s_leader'" weight="10"/>
                          <set_value name="$ShipRef" exact="'khaak_fighter_m'" weight="3"/>
                        </do_any>

                        <create_ship groupname="$CreatedObjects" ref="$ShipRef" sector="$MissionSector" state="componentstate.wreck">
                          <owner exact="faction.khaak"/>
                          <safepos value="$MissionPos" max="8km"/>
                          <rotation yaw="[0deg, 360deg].randominrange" pitch="[-45deg, 45deg].randominrange" roll="[-45deg, 45deg].randominrange"/>
                        </create_ship>
                      </do_all>

                    </do_else>

                    <!--Create a ship to be claimed-->
                    <create_ship name="$ClaimableShip" macro="macro.ship_xen_m_corvette_02_a_macro" sector="$MissionSector">
                      <owner exact="faction.ownerless"/>
                      <safepos value="$MissionPos" max="8km"/>
                      <rotation yaw="[0deg, 360deg].randominrange" pitch="[-45deg, 45deg].randominrange" roll="[-45deg, 45deg].randominrange"/>
                    </create_ship>
                    <do_if value="$Mission_Variant == 'wrecks'">
                      <set_object_hull object="$ClaimableShip" exact="36"/>
                    </do_if>

                    <create_mission cue="$MissionCue" name="readtext.{30236}.{$NameID}" description="readtext.{30236}.{$DescriptionID}" type="missiontype.plot"
                                    faction="faction.player" abortable="false">
                      <briefing>
                        <objective step="1" action="objective.investigate" object="$MissionSector" offset="$MissionPos" text="{30004,1907}" radius="$MissionRadius"/>
                      </briefing>
                    </create_mission>
                    <set_objective_from_briefing cue="$MissionCue" step="1"/>
                  </actions>
                  <cues>
                    <cue name="Research_01_Mission_Created">
                      <conditions>
                        <event_cue_completed cue="Research_01_Create_Mission"/>
                      </conditions>
                      <cues>
                        <cue name="Research_01_CPU_Variant" onfail="cancel">
                          <conditions>
                            <check_value value="$Mission_Variant == 'cpu'"/>
                          </conditions>
                          <cues>
                            <cue name="Research_01_CPU_Ship_Left">
                              <conditions>
                                <event_object_changed_sector object="CPU_Ship_Manager.$CPUShip"/>
                              </conditions>
                              <actions>

                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Research_01_Check_Location">
                          <delay exact="5s"/>
                          <actions>
                            <find_ship_by_true_owner name="$NearbyPlayerShip" faction="faction.player" space="$MissionSector">
                              <match_distance space="$MissionSector" value="$MissionPos" max="$MissionRadius"/>
                            </find_ship_by_true_owner>
                            <do_if value="$NearbyPlayerShip">
                              <signal_cue cue="Research_01_At_Location"/>
                            </do_if>
                            <do_else>
                              <reset_cue cue="Research_01_Check_Location"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Research_01_At_Location">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="Start.$MinTriggerTime" min="player.age + 2h" max="player.age + 3h"/>
                          </actions>
                          <cues>
                            <cue name="Research_01_At_Location_CPU" onfail="cancel">
                              <conditions>
                                <check_value value="$Mission_Variant == 'cpu'"/>
                              </conditions>
                              <actions>
                                <set_value name="$CPU_Present" exact="Research_01_CPU_Ship_Left.state == cuestate.waiting"/>
                              </actions>
                              <!--CPU ship handler deals with that dialogue-->
                              <delay exact="15s"/>
                              <actions>
                                <remove_mission cue="$MissionCue" type="completed"/>
                              </actions>
                              <delay exact="60s"/>
                              <actions>
                                <do_if value="$CPU_Present">
                                  <write_incoming_message title="{30236,1610}" text="{30236,1520}" source="$BosoTa" highpriority="true"/>
                                </do_if>
                                <do_else>
                                  <write_incoming_message title="{30236,1613}" text="{30236,1524}" source="$BosoTa" highpriority="true"/>
                                </do_else>
                              </actions>
                            </cue>

                            <cue name="Research_01_At_Location_Wrecks" onfail="cancel">
                              <conditions>
                                <check_value value="$Mission_Variant == 'wrecks'"/>
                              </conditions>
                              <delay exact="5s"/>
                              <actions>
                                <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                                  $caller = this, $preset = '$plot', $actors = $MissionActors, $debugchance = $DebugChance,
                                  $script = [
                                            table[ $actor = '$BosoTa', $speak = 302360401, $recipient = 'player', $monitor = true, $comment = ''],
                                            2s,
                                            table[ $actor = '$BosoTa', $speak = 302360402, $recipient = 'player', $monitor = true, $comment = '' ],
                                            ],
                                 ]" />
                              </actions>
                              <delay exact="15s"/>
                              <actions>
                                <remove_mission cue="$MissionCue" type="completed"/>
                              </actions>
                              <delay exact="20s"/>
                              <actions>
                                <do_all exact="5">
                                  <do_any>
                                    <set_value name="$ShipRef" exact="'khaak_fighter_s_leader'" weight="10"/>
                                    <set_value name="$ShipRef" exact="'khaak_fighter_m'" weight="3"/>
                                  </do_any>

                                  <create_ship ref="$ShipRef" sector="$MissionSector">
                                    <owner exact="faction.khaak"/>
                                    <safepos value="$MissionPos" max="8km"/>
                                    <rotation yaw="[0deg, 360deg].randominrange" pitch="[-45deg, 45deg].randominrange" roll="[-45deg, 45deg].randominrange"/>
                                  </create_ship>
                                </do_all>
                              </actions>
                              <delay exact="2s"/>
                              <actions>
                                <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                                    $caller = this, $preset = '$plot', $actors = $MissionActors, $debugchance = $DebugChance,
                                    $script = [
                                              table[ $actor = '$BosoTa', $speak = 302360344, $recipient = 'player', $monitor = true, $comment = ''],
                                              ],
                                   ]" />
                              </actions>
                              <cues>
                                <cue name="Research_01_At_Location_Wrecks_Mail" checkinterval="10s">
                                  <conditions>
                                    <cue_is_complete cue="Research_01_At_Location_Wrecks"/>
                                    <check_value value="player.sector"/>
                                    <count_ships exact="0" space="player.sector" owner="faction.khaak">
                                      <match_distance object="player.entity" max="10km"/>
                                    </count_ships>
                                  </conditions>
                                  <actions>
                                    <write_incoming_message title="{30236,1611}" text="{30236,1521}" source="$BosoTa.knownname" highpriority="true"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <!--Set up the CPU ship manager for the crisis-->
        <cue name="Activate_CPU_Ship">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue_instantly cue="Request_CPU_Ship_State" param="'awake'"/>
          </actions>
          <delay exact="5s"/>
          <actions>
            <signal_cue_instantly cue="Request_CPU_Ship_State" param="'escaping'"/>
          </actions>
        </cue>

        <cue name="TriggerThreat">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>

            <run_actions result="$ThreatSuccess" ref="md.Crisis_Manager.ThreatenCrisis">
              <param name="Cue" value="namespace"/>
              <param name="Faction" value="$FacXenon"/>
            </run_actions>

            <do_if value="$ThreatSuccess">
              <debug_text text="'Player has been threatened with crisis ' + namespace + ' by ' + $FacXenon" chance="$DebugChance"/>

              <!--Store some strength data at the time of the trigger-->
              <run_actions ref="md.Player_Evaluator.GetTotalValue" result="$TriggerPlayerValue"/>

              <set_value name="$MissionActors" exact="table[]"/>
              <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
              <set_value name="$MissionActors.$BosoTa" exact="table[
                                  $entity = $BosoTa,
                                  $monitor = table[
                                    $cutscenekey = 'ShowCharacterBoron',
                                    $caption = true
                                  ]
                                ]"/>
            </do_if>
            <do_else>
              <debug_text text="'Unable to threaten player with crisis ' + namespace + ' by ' + $FacXenon" filter="error"/>
              <signal_cue cue="CleanUp"/>
              <cancel_cue cue="this"/>
            </do_else>
          </actions>
          <cues>
            <cue name="TriggerThreat_InitialInvasion_Find_Sector">
              <delay exact="30s"/>
              <actions>
                <set_value name="$TempExcluded" exact="md.$XenonCrisisIgnoredSectors.list"/>
                <append_to_list name="$TempExcluded" exact="player.sector"/>
                <run_actions ref="md.Player_Evaluator.GetSectorAtPlottedValueFactor" result="$FirstSector">
                  <param name="Factor" value="[0.3f, 0.6f].randominrange"/>
                  <param name="IgnoreList" value="$TempExcluded"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>
                <remove_value name="$TempExcluded"/>
                <do_if value="$FirstSector">
                  <signal_cue cue="TriggerThreat_InitialInvasion"/>
                </do_if>
                <do_else>
                  <reset_cue cue="this"/>
                </do_else>
              </actions>
            </cue>

            <cue name="TriggerThreat_InitialInvasion">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_group groupname="$InitialXenonFleet"/>

                <!--Spawn the Xenon somewhere within the core of the sector-->
                <set_value name="$CorePosition" exact="$FirstSector.coreposition"/>
                <set_value name="$CoreSize" exact="$FirstSector.coresize"/>
                <get_safe_pos result="$SecSpawnPos" sector="$FirstSector" radius="4km"
                              x="$CorePosition.x + [-$CoreSize * 0.3f, $CoreSize * 0.3f].randominrange"
                              y="$CorePosition.y + [-2km, 2km].randominrange"
                              z="$CorePosition.z + [-$CoreSize * 0.3f, $CoreSize * 0.3f].randominrange"/>
                <set_value name="$CreatedShips" exact="[]"/>
                <run_actions ref="md.LIB_Create_Ships.SpawnShipsByDefinition" result="$SpawnResultList">
                  <param name="DefinitionID" value="'$xen_I_with_K_escorts_2'"/>
                  <param name="DefinitionTable" value="md.Crisis_Xenon_Khaak_Combo.StaticData.$XenonDefinitions"/>
                  <param name="Sector" value="$FirstSector"/>
                  <param name="Position" value="$SecSpawnPos"/>
                  <param name="Rotation" value="rotation.[[0deg, 360deg].randominrange, 0deg, 0deg]"/>
                  <param name="Owner" value="faction.xenon"/>
                  <param name="ResultList" value="$CreatedShips"/>
                </run_actions>

                <do_if value="$CreatedShips.count">
                  <add_to_group groupname="$InitialXenonFleet" list="$CreatedShips"/>
                  <remove_value name="$CreatedShips"/>
                </do_if>
                <do_else>
                  <assert value="$CreatedShips.count" text="'Xenon ships not created for initial invasion [Owen]'"/>
                </do_else>
                <do_if value="$QuickMode">
                  <set_value name="$InitialKhaakWait" exact="2s"/>
                  <set_value name="$LocalForcesMentionTime" exact="player.age + 15s" comment="Time for Boso to mention how the locals are doing"/>
                  <set_value name="$WindingDownMentionTime" exact="player.age + 25s" comment="Time for Boso to mention that the Xenon are leaving the sector"/>
                </do_if>
                <do_else>
                  <set_value name="$InitialKhaakWait" min="1min" max="2min"/>
                  <set_value name="$LocalForcesMentionTime" exact="player.age + 7min" comment="Time for Boso to mention how the locals are doing"/>
                  <set_value name="$WindingDownMentionTime" exact="player.age + 12min" comment="Time for Boso to mention that the Xenon are leaving the sector"/>
                </do_else>
              </actions>
              <delay exact="5min"/>
              <actions>
                <!--After a while, have the Xenon leave the sector and cause trouble elsewhere-->
                <do_if value="$InitialXenonFleet.count">
                  <find_gate name="$EscapeGate" space="$FirstSector"/>
                  <do_if value="$EscapeGate">
                    <create_order id="'Patrol'" object="$InitialXenonFleet.{1}.toplevelcommander" default="true">
                      <param name="space" value="$EscapeGate.destination.sector"/>
                    </create_order>
                  </do_if>
                </do_if>
              </actions>
              <cues>
                <cue name="TriggerThreat_InitialInvasion_Khaak">
                  <delay exact="$InitialKhaakWait"/>
                  <actions>
                    <!--Create some Kha'ak forces-->
                    <set_value name="$LeadKhaak" exact="null"/>
                    <do_all exact="10" counter="$i">
                      <do_if value="$i == 1">
                        <set_value name="$KhaakDef" exact="'$kha_capship_with_SizeM_escorts_1'"/>
                      </do_if>
                      <do_else>
                        <set_value name="$KhaakDef" exact="'$kha_SizeM_with_SizeM_escorts_1'"/>
                      </do_else>
                      <get_safe_pos result="$SecSpawnPos" sector="$FirstSector" radius="4km"
                                x="$CorePosition.x + [-$CoreSize * 0.3f, $CoreSize * 0.3f].randominrange"
                                y="$CorePosition.y + [-2km, 2km].randominrange"
                                z="$CorePosition.z + [-$CoreSize * 0.3f, $CoreSize * 0.3f].randominrange"/>
                      <run_actions ref="md.LIB_Create_Ships.SpawnShipsByDefinition" result="$SpawnResultList">
                        <param name="DefinitionID" value="$KhaakDef"/>
                        <param name="DefinitionTable" value="md.Crisis_Xenon_Khaak_Combo.StaticData.$KhaakDefinitions"/>
                        <param name="Sector" value="$FirstSector"/>
                        <param name="Position" value="$SecSpawnPos"/>
                        <param name="Rotation" value="rotation.[[0deg, 360deg].randominrange, 0deg, 0deg]"/>
                        <param name="Owner" value="faction.khaak"/>
                      </run_actions>
                      <do_if value="$i == 1">
                        <set_value name="$LeadKhaak" exact="$SpawnResultList.{1}"/>
                      </do_if>
                    </do_all>
                    <remove_value name="$SpawnResultList"/>
                  </actions>
                  <delay exact="if $QuickMode then 1s else 1min"/>
                  <actions>
                    <signal_cue cue="TriggerThreat_InitialInvasion_KhaakMention" check="false"/>
                  </actions>
                </cue>
                <cue name="TriggerThreat_InitialInvasion_Boso_1">
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                      $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                      $script = [
                                table[ $actor = '$BosoTa', $speak = 302360101, $recipient = 'player', $monitor = true, $comment = ''],
                                1s,
                                table[ $actor = '$BosoTa', $speak = 302360102, $recipient = 'player', $monitor = true, $comment = '' ],
                                1s,
                                table[ $actor = '$BosoTa', $speak = 302360103, $recipient = 'player', $monitor = true, $comment = '' ],
                                1.5s,
                                table[ $actor = '$BosoTa', $speak = 302360105, $recipient = 'player', $monitor = true, $comment = '' ],
                                ],
                     $callbackcue = TriggerThreat_InitialInvasion_Mission,
                     $abortcallbackcue = TriggerThreat_InitialInvasion_Mission
                     ]" />
                  </actions>
                </cue>
                <cue name="TriggerThreat_InitialInvasion_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <substitute_text text="$DescriptionText_1" source="{30236,1106}">
                      <replace string="'$SECTOR_NAME$'" with="$FirstSector.knownname"/>
                    </substitute_text>
                    <create_mission cue="Start" name="{30236,1001}" type="missiontype.crisis" faction="faction.player" abortable="false"
                                    description="$DescriptionText_1 + '\n\n' + {30236,1101} + ' ' + {30236,1103} + '\n\n' + {30236,1104}">
                      <objective step="1" action="objective.investigate" text="{30236,1010}" object="$FirstSector"/>
                    </create_mission>
                  </actions>
                  <cues>
                    <cue name="TriggerThreat_InitialInvasion_InSector" checkinterval="1s">
                      <conditions>
                        <check_value value="player.sector == $FirstSector"/>
                      </conditions>
                      <delay exact="10s"/>
                      <actions>
                        <do_if value="TriggerThreat_InitialInvasion_Khaak.state == cuestate.complete">
                          <signal_cue cue="TriggerThreat_InitialInvasion_KhaakMention" check="false"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="TriggerThreat_InitialInvasion_KhaakMention">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="TriggerThreat_InitialInvasion_LocalForcesMention.state == cuestate.waiting">
                          <!--Delay the local forces mention-->
                          <set_value name="$LocalForcesMentionTime" exact="[player.age + 30s, $LocalForcesMentionTime].max"/>
                        </do_if>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                           $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                           $script = [
                                      table[ $actor = '$BosoTa', $speak = 302360104, $recipient = 'player', $monitor = false, $comment = ''],
                                      ],
                           ]" />
                      </actions>
                      <cues>
                        <cue name="TriggerThreat_InitialInvasion_KhaakCapshipMention" checkinterval="1s">
                          <conditions>
                            <check_age min="TriggerThreat_InitialInvasion_KhaakMention.time + 30s"/>
                            <check_value value="TriggerThreat_InitialInvasion_LocalForcesMention.state == cuestate.waiting or player.age + 30s gt TriggerThreat_InitialInvasion_LocalForcesMention.time"/>
                            <check_value value="$LeadKhaak.exists and $LeadKhaak.isrealclass.[class.ship_l, class.ship_xl] and player.sector == $LeadKhaak.sector and player.entity.distanceto.{$LeadKhaak} lt 6km"/>
                          </conditions>
                          <actions>
                            <do_if value="TriggerThreat_InitialInvasion_LocalForcesMention.state == cuestate.waiting">
                              <!--Delay the local forces mention-->
                              <set_value name="$LocalForcesMentionTime" exact="[player.age + 30s, $LocalForcesMentionTime].max"/>
                            </do_if>
                            <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                               $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                               $script = [
                                          table[ $actor = '$BosoTa', $speak = 302360108, $recipient = 'player', $monitor = false, $comment = ''],
                                          ],
                               ]" />
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="TriggerThreat_InitialInvasion_LocalForcesMention" checkinterval="1s">
                      <conditions>
                        <check_age min="$LocalForcesMentionTime"/>
                      </conditions>
                      <actions>
                        <!--TODO @Owen evaluate how they're doing-->
                        <set_value name="$DoingGood" exact="[true, false].random"/>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                           $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                           $script = [
                                      table[ $actor = '$BosoTa', $speak = if $DoingGood then 302360107 else 302360106, $recipient = 'player', $monitor = false, $comment = ''],
                                      ],
                           ]" />
                      </actions>
                    </cue>

                    <!--TODO @Owen occasional Kha'ak jumping in and Boso comments on it happening and stopping-->

                    <cue name="TriggerThreat_InitialInvasion_WindingDown" checkinterval="1s">
                      <conditions>
                        <check_age min="$WindingDownMentionTime"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="TriggerThreat_InitialInvasion_LocalForcesMention"/>

                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                            $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                            $script = [
                                      table[ $actor = '$BosoTa', $speak = 302360110, $recipient = 'player', $monitor = true, $comment = ''],
                                      1s,
                                      table[ $actor = '$BosoTa', $speak = 302360111, $recipient = 'player', $monitor = true, $comment = '' ],
                                      1s,
                                      table[ $actor = '$BosoTa', $speak = 302360112, $recipient = 'player', $monitor = true, $comment = '' ],
                                      ],
                           ]" />
                        <remove_mission cue="Start"/>
                        <do_if value="$QuickMode">
                          <set_value name="$CrisisThreatCallDelay" exact="15s"/>
                        </do_if>
                        <do_else>
                          <set_value name="$CrisisThreatCallDelay" min="9min" max="11min"/>
                        </do_else>
                      </actions>
                      <delay exact="$CrisisThreatCallDelay"/>
                      <actions>
                        <signal_cue cue="TriggerThreat_BosoCalls"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="TriggerThreat_Postponed" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="$PostponeDuration"/>
              <actions>
                <signal_cue cue="TriggerThreat_BosoCalls"/>
              </actions>
            </cue>

            <cue name="TriggerThreat_BosoCalls" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$FirstBosoConv" exact="true"/>
                <set_value name="$CrisisThreatCallCount" operation="add"/>
                <set_value name="md.X4Ep1_Mentor_Subscriptions.Start.$SuppressBosoConversation" exact="true"/>
                <do_if value="$QuickMode">
                  <set_value name="$ThreatEndtime" exact="player.age + 2min"/>
                </do_if>
                <do_else>
                  <set_value name="$ThreatEndtime" exact="player.age + $ThreatDuration"/>
                </do_else>
                <set_value name="$ThreatReminderInterval_1" exact="$ThreatDuration * 0.2" comment="20% through the threat duration. On screen timer activates."/>
                <set_value name="$ThreatReminderInterval_2" exact="$ThreatDuration * 0.4" comment="60% through the threat duration."/>

                <set_value name="$AvoidCrisisCreditCost" exact="500000000Cr"/>
                <set_value name="$PostponeCrisisCreditCost" exact="10000000Cr"/>
                <set_value name="$HasPostponeOption" exact="false"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$PostponeCrisisCreditCost" exact="10000000Cr"/>
                <set_value name="$HasPostponeOption" exact="false"/>
              </patch>
              <cues>
                <cue name="TriggerThreat_TimeExpired" checkinterval="1s">
                  <conditions>
                    <!--yes, could be done with a delay but this helps with debugging-->
                    <check_age min="$ThreatEndtime"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="TriggerCrisis"/>
                    <update_mission cue="Start">
                      <briefing>
                        <objective step="2" action="objective.await" text="{30236,1011}"/>
                      </briefing>
                    </update_mission>
                    <set_objective_from_briefing cue="Start" step="2"/>
                  </actions>
                  <cues>
                    <!--Looks better if zero time remains for a few seconds-->
                    <cue name="TriggerThreat_TimeExpired_Remove_Timer">
                      <delay exact="5s"/>
                      <actions>
                        <update_mission cue="Start" endtime="0s"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="TriggerThreat_BosoCall_1">
                  <actions>
                    <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                      $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                      $script = [
                                table[ $actor = '$BosoTa', $speak = 302360201, $recipient = 'player', $monitor = true, $comment = ''],
                                1s,
                                table[ $actor = '$BosoTa', $speak = 302360202, $recipient = 'player', $monitor = true, $comment = '' ],
                                ],
                     $callbackcue = TriggerThreat_BosoCall_Mission,
                     $abortcallbackcue = TriggerThreat_BosoCall_Mission
                     ]" />
                  </actions>
                </cue>
                <cue name="TriggerThreat_BosoCall_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_mission cue="Start" name="{30236,1001}" type="missiontype.crisis" faction="faction.player" endtime="$ThreatEndtime" abortable="false">
                      <objective step="1" action="objective.talkto" object="$BosoTa"/>
                    </create_mission>
                  </actions>
                </cue>
                <cue name="TriggerThreat_BosoCall_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="$ThreatReminderInterval_1"/>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                      $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                      $script = [
                                table[ $actor = '$BosoTa', $speak = 302360203, $recipient = 'player', $monitor = true, $comment = ''],
                                1s,
                                table[ $actor = '$BosoTa', $speak = 302360204, $recipient = 'player', $monitor = true, $comment = '' ],
                                1s,
                                table[ $actor = '$BosoTa', $speak = 302360205, $recipient = 'player', $monitor = true, $comment = '' ],
                                ],
                     $callbackcue = TriggerThreat_BosoCall_3,
                     $abortcallbackcue = TriggerThreat_BosoCall_3
                     ]" />
                  </actions>
                </cue>
                <cue name="TriggerThreat_BosoCall_3">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="$ThreatReminderInterval_2"/>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                      $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                      $script = [
                                table[ $actor = '$BosoTa', $speak = 302360205, $recipient = 'player', $monitor = true, $comment = ''],
                                1s,
                                table[ $actor = '$BosoTa', $speak = 302360206, $recipient = 'player', $monitor = true, $comment = '' ],
                                ],
                     ]" />
                  </actions>
                </cue>

                <cue name="TriggerThreat_In_Boso_Room">
                  <conditions>
                    <!--TODO @Owen would be better if it happens as the door opens even if the player isn't in the room-->
                    <event_object_changed_attention object="$BosoTa" attention="attention.inroom"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                      $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                      $script = [
                                table[ $actor = '$BosoTa', $speak = 302360209, $recipient = 'player', $monitor = false, $comment = ''],
                                ],
                     ]" />
                  </actions>
                </cue>

                <library name="TriggerThreat_Boso_Choices">
                  <actions>
                    <!--Avoid crisis choice - credit cost-->
                    <substitute_text source="{30236,2002}" text="$PreventCrisisText">
                      <replace string="'$CREDITS$'" with="$AvoidCrisisCreditCost.formatted.default"/>
                    </substitute_text>
                    <add_player_choice text="$PreventCrisisText" section="avoid_crisis" selectable="player.money ge $AvoidCrisisCreditCost"/>

                    <do_if value="$HasPostponeOption">
                      <!--Postpone crisis choice - credit cost-->
                      <substitute_text source="{30236,2008}" text="$PostponeCrisisText">
                        <replace string="'$CREDITS$'" with="$PostponeCrisisCreditCost.formatted.default"/>
                      </substitute_text>

                      <add_player_choice text="$PostponeCrisisText" section="postpone_crisis" selectable="player.money ge $PostponeCrisisCreditCost"/>
                    </do_if>
                    <do_else>
                      <add_player_choice text="{30236,2007}" section="ask_postpone"/>
                    </do_else>

                    <add_player_choice text="{30236,2003}" section="accept_crisis"/>
                  </actions>
                </library>

                <cue name="TriggerThreat_Boso_Conv_Started" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$BosoTa" conversation="default"/>
                    <check_value value="TriggerThreat_TimeExpired.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <do_if value="$FirstBosoConv">
                      <!--TODO @Owen this should probably be a counter as it's used by multiple scripts-->
                      <remove_value name="md.X4Ep1_Mentor_Subscriptions.Start.$SuppressBosoConversation"/>
                    </do_if>

                    <do_if value="$FirstBosoConv">
                      <add_npc_line speaker="$BosoTa" line="[302360211, 302360212, 302360213, 302360214]" hidechoices="true"/>
                    </do_if>
                    <do_else>
                      <add_npc_line speaker="$BosoTa" line="302360216" hidechoices="false"/>
                    </do_else>
                    <include_actions ref="TriggerThreat_Boso_Choices"/>
                  </actions>
                  <cues>
                    <cue name="TriggerThreat_Boso_Conv_Next_Section" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$BosoTa"/>
                      </conditions>
                      <actions>
                        <do_if value="event.param == 'ask_postpone'">
                          <set_value name="$HasPostponeOption" exact="true"/>
                          <add_npc_line speaker="$BosoTa" line="2101" hidechoices="true"/>
                          <add_npc_line speaker="$BosoTa" line="30201129" hidechoices="true"/>
                          <add_npc_line speaker="$BosoTa" line="30220406" hidechoices="false"/>
                          <include_actions ref="TriggerThreat_Boso_Choices"/>
                        </do_if>
                        <do_elseif value="event.param == 'avoid_crisis'">
                          <add_npc_line speaker="$BosoTa" line="[302360217, 302360218].random" hidechoices="false"/>
                          <add_player_choice text="{30236,2005}" section="avoid_crisis_confirm"/>
                          <add_player_choice text="{30236,2006}" section="avoid_crisis_cancel"/>
                        </do_elseif>
                        <do_elseif value="event.param == 'accept_crisis'">
                          <add_npc_line speaker="$BosoTa" line="[302360217, 302360218].random" hidechoices="false"/>
                          <add_player_choice text="{30236,2005}" section="accept_crisis_confirm"/>
                          <add_player_choice text="{30236,2006}" section="accept_crisis_cancel"/>
                        </do_elseif>
                        <do_elseif value="event.param == 'postpone_crisis'">
                          <add_npc_line speaker="$BosoTa" line="[302360217, 302360218].random" hidechoices="false"/>
                          <add_player_choice text="{30236,2005}" section="postpone_crisis_confirm"/>
                          <add_player_choice text="{30236,2006}" section="postpone_crisis_cancel"/>
                        </do_elseif>

                        <do_elseif value="event.param == 'avoid_crisis_cancel' or event.param == 'accept_crisis_cancel' or event.param == 'postpone_crisis_cancel'">
                          <add_npc_line speaker="$BosoTa" line="302360215" hidechoices="false"/>
                          <include_actions ref="TriggerThreat_Boso_Choices"/>
                        </do_elseif>
                      </actions>
                    </cue>
                    <cue name="TriggerThreat_Boso_Conv_Finished">
                      <conditions>
                        <event_conversation_finished actor="$BosoTa"/>
                      </conditions>
                      <actions>
                        <set_value name="$FirstBosoConv" exact="false"/>

                        <do_if value="TriggerThreat_TimeExpired.state == cuestate.complete">
                          <debug_text text="'Crisis has already started'" chance="$DebugChance"/>
                          <!--Crisis has already started, do nothing.-->
                          <cancel_cue cue="TriggerThreat_Boso_Conv_Started.static"/>
                        </do_if>
                        <do_else>
                          <do_if value="event.param == 'avoid_crisis_confirm'">
                            <do_if value="player.money ge $AvoidCrisisCreditCost">
                              <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                                $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                                $script = [
                                        table[ $actor = '$BosoTa', $speak = 302360220, $recipient = 'player', $monitor = false, $comment = ''],
                                        1s,
                                        table[ $actor = '$BosoTa', $speak = 302360221, $recipient = 'player', $monitor = false, $comment = '' ],
                                        ],
                              ]" />
                              <remove_mission cue="Start"/>
                              <reward_player money="-$AvoidCrisisCreditCost"/>
                              <cancel_cue cue="TriggerThreat_TimeExpired"/>
                              <cancel_cue cue="TriggerThreat_Boso_Conv_Started.static"/>
                            </do_if>
                            <do_else>
                              <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                                $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                                $script = [
                                        table[ $actor = '$BosoTa', $speak = 302360222, $recipient = 'player', $monitor = false, $comment = ''],
                                        ],
                              ]" />
                            </do_else>
                          </do_if>
                          <do_elseif value="event.param == 'accept_crisis_confirm'">
                            <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                              $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                              $script = [
                                      table[ $actor = '$BosoTa', $speak = 302360225, $recipient = 'player', $monitor = false, $comment = ''],
                                      1s,
                                      table[ $actor = '$BosoTa', $speak = 302360226, $recipient = 'player', $monitor = false, $comment = '' ],
                                      1s,
                                      table[ $actor = '$BosoTa', $speak = if @md.Story_Terran_Core.Start.exists then 302360228 else 302360227, $recipient = 'player', $monitor = false, $comment = '' ],
                                      1s,
                                      table[ $actor = '$BosoTa', $speak = 302360229, $recipient = 'player', $monitor = false, $comment = '' ],
                                      ],
                            ]" />
                            <update_mission cue="Start">
                              <briefing>
                                <objective step="2" action="objective.await" text="{30236,1011}"/>
                              </briefing>
                            </update_mission>
                            <set_objective_from_briefing cue="Start" step="2"/>
                            <cancel_cue cue="TriggerThreat_Boso_Conv_Started.static"/>
                            <cancel_cue cue="TriggerThreat_BosoCall_2"/>
                            <cancel_cue cue="TriggerThreat_BosoCall_3"/>
                          </do_elseif>
                          <do_elseif value="event.param == 'postpone_crisis_confirm'">
                            <do_if value="player.money ge $PostponeCrisisCreditCost">
                              <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                                $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                                $script = [
                                        table[ $actor = '$BosoTa', $speak = 302360220, $recipient = 'player', $monitor = false, $comment = ''],
                                        1s,
                                        table[ $actor = '$BosoTa', $speak = 302360221, $recipient = 'player', $monitor = false, $comment = '' ],
                                        ],
                              ]" />
                              <remove_mission cue="Start"/>
                              <reward_player money="-$PostponeCrisisCreditCost"/>
                              <set_value name="$ThreatDuration" exact="[$ThreatDuration, 1h].max" comment="Give the player more time to react to a postponed threat"/>
                              <signal_cue cue="TriggerThreat_Postponed"/>
                              <reset_cue cue="TriggerThreat_BosoCalls"/>
                            </do_if>
                            <do_else>
                              <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                                $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                                $script = [
                                        table[ $actor = '$BosoTa', $speak = 302360222, $recipient = 'player', $monitor = false, $comment = ''],
                                        ],
                              ]" />
                            </do_else>
                          </do_elseif>
                        </do_else>
                        <!--Cancel the instance-->
                        <cancel_cue cue="TriggerThreat_Boso_Conv_Started"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="TriggerCrisis">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <run_actions result="$TriggerSuccess" ref="md.Crisis_Manager.TriggerCrisis">
              <param name="Cue" value="namespace"/>
              <param name="Faction" value="$FacXenon"/>
            </run_actions>

            <do_if value="not $TriggerSuccess">
              <debug_text text="'Unable to trigger crisis ' + namespace + ' by ' + $FacXenon" filter="error"/>
              <signal_cue cue="CleanUp"/>
            </do_if>
            <do_else>
              <debug_text text="'Crisis ' + namespace + ' by ' + $FacXenon + ' has been successfully triggered'" chance="$DebugChance"/>

              <run_actions result="$CrisisTriggerCount" ref="md.Crisis_Manager.GetCrisisTriggerCount">
                <param name="StaticCue" value="namespace.staticbase"/>
              </run_actions>

              <!--Aim to target sectors up to a certain percentage of the player's total worth-->
              <run_actions ref="md.Player_Evaluator.GetTotalValue" result="$CrisisPlayerValue"/>
              <interpolate_value result="$TargetInvasionCount" value="$CrisisPlayerValue">
                <linear mininput="$MinTotalValue" maxinput="$CeilingTotalValue" minoutput="$MinNumInvasions" maxoutput="$MaxNumInvasions"/>
              </interpolate_value>
              <debug_text text="'Player empire value is ' + $CrisisPlayerValue.formatted.default + ' and the crisis will result in ' + $TargetInvasionCount + ' sector invasions'" chance="$DebugChance"/>

              <set_value name="$InvadedSectors" exact="[]"/>
              <do_if value="@$InvasionHistory">
                <append_to_list name="$MasterHistoryList" exact="$InvasionHistory"/>
              </do_if>
              <set_value name="$InvasionHistory" exact="[]"/>
              <set_value name="$EndInvasionEntry" exact="null"/>

              <do_if value="$QuickMode">
                <set_value name="$CrisisInitTime" exact="4s"/>
              </do_if>
              <do_else>
                <set_value name="$CrisisInitTime" min="1min" max="2min"/>
              </do_else>
            </do_else>
          </actions>
          <cues>
            <cue name="Crisis_Init">
              <delay exact="$CrisisInitTime"/>
              <actions>
                <!--First crisis-->
                <signal_cue cue="SelectInvasionSector"/>
              </actions>
            </cue>

            <cue name="Invasion_Ticker" checkinterval="1s">
              <conditions>
                <check_value value="Crisis_Init.state == cuestate.complete"/>
                <check_value value="not $EndInvasionEntry"/>
                <check_any>
                  <check_all>
                    <check_value value="$QuickMode"/>
                    <set_value name="$NextTickerTime" exact="4s"/>
                  </check_all>
                  <check_all>
                    <check_value value="not $QuickMode"/>
                    <set_value name="$NextTickerTime" min="10min" max="15min"/>
                  </check_all>
                </check_any>
              </conditions>
              <delay exact="$NextTickerTime"/>
              <actions>
                <run_actions ref="Get_Num_Active_Invasions" result="$CurrentInvasionCount">
                  <param name="InvasionHistoryList" value="$InvasionHistory"/>
                </run_actions>

                <do_if value="$CurrentInvasionCount == 0">
                  <signal_cue cue="SelectInvasionSector" chance="$SingularInvasionChance"/>
                </do_if>
                <do_elseif value="$CurrentInvasionCount lt $MaxConcurrentInvasions">
                  <signal_cue cue="SelectInvasionSector" chance="$ConcurrentInvasionChance"/>
                </do_elseif>

                <reset_cue cue="this"/>
              </actions>
            </cue>

            <library name="Get_Num_Active_Invasions" purpose="run_actions">
              <params>
                <param name="InvasionHistoryList" comment="we have to pass this in as a reference as the library has its own namespace and it's easier than navigating to the crisis instance"/>
                <param name="CheckStarted" default="false"/>
              </params>
              <actions>
                <set_value name="$Count" exact="0"/>
                <do_for_each name="$Entry" in="$InvasionHistoryList">
                  <do_if value="@$Entry.$cue.exists">
                    <do_if value="not $CheckStarted or $Entry.$starttime ge player.age">
                      <set_value name="$Count" operation="add"/>
                    </do_if>
                  </do_if>
                  <do_else>
                    <!--Clean up dead instance references-->
                    <remove_value name="$Entry.$cue"/>
                  </do_else>
                </do_for_each>
                <return value="$Count"/>
              </actions>
            </library>

            <library name="Get_Num_Completed_Invasions" purpose="run_actions">
              <params>
                <param name="InvasionHistoryList" comment="we have to pass this in as a reference as the library has its own namespace and it's easier than navigating to the crisis instance"/>
              </params>
              <actions>
                <set_value name="$Count" exact="0"/>
                <do_for_each name="$Entry" in="$InvasionHistoryList">
                  <do_if value="player.age ge $Entry.$starttime and not @$Entry.$cue.exists">
                    <set_value name="$Count" operation="add"/>
                  </do_if>
                </do_for_each>
                <return value="$Count"/>
              </actions>
            </library>

            <!--An 'invasion' is Xenon and Kha'ak action in a single sector. This cue will trigger an instance, or potentially multiple in a cluster, and set up their initial strength and durations.-->
            <cue name="SelectInvasionSector" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$TempExcluded" exact="md.$XenonCrisisIgnoredSectors.list"/>
                <append_list_elements name="$TempExcluded" other="$InvadedSectors"/>
                <run_actions ref="md.Player_Evaluator.GetSectorAtPlottedValueFactor" result="$SelectedSector">
                  <param name="Factor" value="[0.5f, 0.9f].randominrange"/>
                  <param name="IgnoreList" value="$TempExcluded"/>
                  <param name="AllowFallback" value="true"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>

                <do_if value="not $SelectedSector">
                  <!--Previous call may have failed due to suitable sectors being invaded before. Try again with less worth sectors.-->
                  <run_actions ref="md.Player_Evaluator.GetSectorAtPlottedValueFactor" result="$SelectedSector">
                    <param name="Factor" value="[0.0f, 0.6f].randominrange"/>
                    <param name="IgnoreList" value="$TempExcluded"/>
                    <param name="AllowFallback" value="true"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>
                </do_if>

                <do_if value="not $SelectedSector">
                  <assert value="false" text="'Unable to select a player sector to invade [Owen]'"/>
                  <find_sector name="$SelectedSector" excluded="$TempExcluded"/>
                </do_if>
                <remove_value name="$TempExcluded"/>

                <do_if value="$SelectedSector">

                  <do_if value="$QuickMode">
                    <set_value name="this.$StartTime" exact="player.age + 5s"/>
                  </do_if>
                  <do_else>
                    <set_value name="this.$StartTime" min="player.age + 30s" max="player.age + 60s"/>
                  </do_else>
                  <interpolate_value result="this.$InvasionStrength" value="$InvasionHistory.count + 1">
                    <linear mininput="$MinNumInvasions" maxinput="$MaxNumInvasions" minoutput="$MinSectorPoints" maxoutput="$MaxSectorPoints"/>
                  </interpolate_value>
                  <append_to_list name="$InvadedSectors" exact="$SelectedSector"/>
                  <signal_cue_instantly cue="Invasion_Instance" param="table[
                                          $sector = $SelectedSector,
                                          $starttime = this.$StartTime,
                                          $strength = this.$InvasionStrength,
                                          $feedbackcue = Invasion_Instance_Feedback_Cue,
                                          $endsignalcue = InvasionConcluded,
                                          $debugchance = $DebugChance,
                                          $quickmode = $QuickMode,
                                          $isend = ($InvasionHistory.count + 1 ge $TargetInvasionCount)
                                          ]"/>
                </do_if>
              </actions>
            </cue>

            <!--event.param.{1} = Invasion instance cue, event.param.{2} = feedback ID, event.param.{>=3} = additional params for the feedback-->
            <cue name="Invasion_Instance_Feedback_Cue" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="this.$Invasion" exact="event.param.{1}"/>
                <set_value name="this.$FeedbackID" exact="event.param.{2}"/>
              </actions>
              <cues>
                <cue name="Invasion_Instance_Feedback_Cue_Actions">
                  <actions>
                    <set_value name="$QueuedUsecase" exact="false"/>
                    <do_if value="parent.$FeedbackID == 'instance_created'">
                      <append_to_list name="$InvasionHistory" exact="table[
                                      $starttime = parent.$Invasion.$StartTime,
                                      $sector = parent.$Invasion.$Sector,
                                      $cue = parent.$Invasion,
                                      $wasend = parent.$Invasion.$IsEnd]"/>
                      <do_if value="parent.$Invasion.$IsEnd">
                        <set_value name="$EndInvasionEntry" exact="$InvasionHistory.last"/>
                      </do_if>
                    </do_if>
                    <do_elseif value="parent.$FeedbackID == 'xenon_enroute'">
                      <do_if value="parent.$Invasion.$CompletedFeedbackIDs.indexof.{parent.$FeedbackID} == 0">
                        <set_value name="$QueuedUsecase" exact="true"/>
                        <!--If the player hasn't observed the captured khaak yet hint that they should get close with 302360302-->
                        <do_if value="@$FeedbackCounterTable.$observed_khaak_captive">
                          <do_if value="$InvasionHistory.count gt $TargetInvasionCount / 2">
                            <set_value name="this.$thescript" exact="[table[$actor = '$BosoTa', $speak = 302360316, $recipient = 'player', $monitor = false, $comment = ''] ]"/>
                          </do_if>
                          <do_else>
                            <set_value name="this.$thescript" exact="[table[$actor = '$BosoTa', $speak = [302360301, 302360315].random, $recipient = 'player', $monitor = false, $comment = ''] ]"/>
                          </do_else>
                        </do_if>
                        <do_else>
                          <set_value name="this.$thescript" exact="[
                                    table[ $actor = '$BosoTa', $speak = 302360301, $recipient = 'player', $monitor = false, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360302, $recipient = 'player', $monitor = false, $comment = ''],
                                    ]"/>
                        </do_else>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance, 
                          $script = this.$thescript,
                          $callbackcue = Invasion_Instance_Feedback_Complete,
                          $abortcallbackcue = Invasion_Instance_Feedback_Complete
                         ]" />
                      </do_if>
                    </do_elseif>
                    <do_elseif value="parent.$FeedbackID == 'xenon_spotted'">
                      <do_if value="parent.$Invasion.$CompletedFeedbackIDs.indexof.{parent.$FeedbackID} == 0">
                        <!--TODO @Owen this breaks other usecases when the pilot is killed so disabled for now-->
                        <!--<set_value name="$MissionActors.$SpotterPilot" exact="table[
                                  $entity = event.param.{3},
                                  $monitor = table[
                                    $cutscenekey = 'ShowNPCFace',
                                    $caption = true
                                  ]
                                ]"/>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                                $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                                $script = [
                                          table[ $actor = '$SpotterPilot', $speak = 10052, $broadcast = true, $monitor = false, $comment = ''],
                                          ],
                                ]" />-->
                      </do_if>
                    </do_elseif>
                    <do_elseif value="parent.$FeedbackID == 'observed_khaak_captive'">
                      <do_if value="parent.$Invasion.$CompletedFeedbackIDs.indexof.{parent.$FeedbackID} == 0">
                        <set_value name="$QueuedUsecase" exact="true"/>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360303, $recipient = 'player', $monitor = false, $comment = ''],
                                    ],
                          $callbackcue = Invasion_Instance_Feedback_Complete,
                          $abortcallbackcue = Invasion_Instance_Feedback_Complete
                         ]" />
                      </do_if>
                    </do_elseif>
                    <do_elseif value="parent.$FeedbackID == 'observed_khaak_captive_escaped'">
                      <do_if value="parent.$Invasion.$CompletedFeedbackIDs.indexof.{parent.$FeedbackID} == 0">
                        <set_value name="$QueuedUsecase" exact="true"/>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360304, $recipient = 'player', $monitor = false, $comment = ''],
                                    ],
                          $callbackcue = Invasion_Instance_Feedback_Complete,
                          $abortcallbackcue = Invasion_Instance_Feedback_Complete
                         ]" />
                      </do_if>
                    </do_elseif>
                    <do_elseif value="parent.$FeedbackID == 'khaak_waves_init'">
                      <do_if value="parent.$Invasion.$CompletedFeedbackIDs.indexof.{parent.$FeedbackID} == 0">
                        <set_value name="$QueuedUsecase" exact="true"/>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360305, $recipient = 'player', $monitor = true, $comment = ''],
                                    ],
                          $callbackcue = Invasion_Instance_Feedback_Complete,
                          $abortcallbackcue = Invasion_Instance_Feedback_Complete
                         ]" />
                      </do_if>
                    </do_elseif>
                    <do_elseif value="parent.$FeedbackID == 'khaak_wave_spawned'">
                      <do_if value="parent.$Invasion.$CompletedFeedbackIDs.indexof.{parent.$FeedbackID} == 0">
                        <set_value name="$QueuedUsecase" exact="true"/>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360344, $recipient = 'player', $monitor = false, $comment = ''],
                                    ],
                          $callbackcue = Invasion_Instance_Feedback_Complete,
                          $abortcallbackcue = Invasion_Instance_Feedback_Complete
                         ]" />
                      </do_if>
                    </do_elseif>
                    <do_elseif value="parent.$FeedbackID == 'invasion_winding_down'">
                      <do_if value="parent.$Invasion.$CompletedFeedbackIDs.indexof.{parent.$FeedbackID} == 0">
                        <set_value name="$QueuedUsecase" exact="true"/>
                        <do_if value="@$FeedbackCounterTable.$invasion_winding_down">
                          <set_value name="this.$thescript" exact="[table[$actor = '$BosoTa', $speak = 302360313, $recipient = 'player', $monitor = true, $comment = ''] ]"/>
                        </do_if>
                        <do_else>
                          <set_value name="this.$thescript" exact="[
                                    table[ $actor = '$BosoTa', $speak = 302360313, $recipient = 'player', $monitor = true, $comment = ''],
                                    2s,
                                    table[ $actor = '$BosoTa', $speak = 302360314, $recipient = 'player', $monitor = true, $comment = ''],
                                    ]"/>
                        </do_else>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = this.$thescript,
                          $callbackcue = Invasion_Instance_Feedback_Complete,
                          $abortcallbackcue = Invasion_Instance_Feedback_Complete
                         ]" />
                      </do_if>
                    </do_elseif>
                    <do_if value="not $QueuedUsecase">
                      <signal_cue cue="Invasion_Instance_Feedback_Complete"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Invasion_Instance_Feedback_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--Pre-Signal actions-->

                    <!--Signal the invasion that we've acted on the feedback-->
                    <do_if value="parent.$Invasion.exists">
                      <signal_cue_instantly cue="parent.$Invasion" param="['feedback_complete', parent.$FeedbackID]" check="false"/>
                    </do_if>

                    <!--Post-Signal actions-->
                    <do_if value="parent.$FeedbackID == 'xenon_enroute'">
                      <do_if value="not Start.hasmission">
                        <!--Do not activate as the sector invasion mission should be active instead-->
                        <create_mission cue="Start" name="{30236,1001}" type="missiontype.crisis" faction="faction.player" activate="false" abortable="false">
                          <objective step="1" action="objective.talkto" object="$BosoTa"/>
                        </create_mission>
                      </do_if>
                      <update_mission cue="Start" endtime="0s">
                        <briefing>
                          <objective step="2" action="objective.investigate" text="{30236,1012}"/>
                        </briefing>
                      </update_mission>
                      <set_objective_from_briefing cue="Start" step="2"/>
                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="InvasionConcluded" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!--Update the history with some data before the instance is canceled-->
                <set_value name="this.$FoundEntry" exact="false"/>
                <do_for_each name="$Entry" in="$InvasionHistory">
                  <do_if value="event.param.$cue == @$Entry.$cue">
                    <set_value name="this.$FoundEntry" exact="true"/>
                    <set_value name="$Entry.$num_player_kills" exact="event.param.$cue.$NumPlayerKills"/>
                    <set_value name="$Entry.$num_player_owned_kills" exact="event.param.$cue.$NumPlayerOwnedKills"/>

                    <do_if value="$Entry.$num_player_kills">
                      <unlock_achievement name="CRISIS_EVENT" />
                    </do_if>
                    <remove_value name="$Entry.$cue"/>
                    <break/>
                  </do_if>
                </do_for_each>
                <assert value="this.$FoundEntry" text="'Unable to find crisis invasion for cue ' + event.param.$cue + ' sector: ' + event.param.$cue.$Sector + ' in history [Owen]'"/>
                <do_if value="End_Game.state == cuestate.waiting">
                  <do_if value="event.param.$cue.$IsEnd">
                    <signal_cue cue="End_Game"/>
                  </do_if>
                  <do_else>
                    <do_if value="event.param.$cue.hasguidance">
                      <set_value name="this.$ActivateOtherMission" exact="true"/>
                    </do_if>
                  </do_else>
                </do_if>
              </actions>
              <cues>
                <cue name="InvasionConcluded_Activate_Other_Mission" onfail="cancel">
                  <conditions>
                    <check_value value="@parent.$ActivateOtherMission"/>
                  </conditions>
                  <delay exact="5s"/>
                  <actions>
                    <!--Don't override the active mission if the player's activated something else-->
                    <do_if value="not player.hasactivemission">
                      <set_value name="this.$ActiveInvasion" exact="null"/>
                      <do_for_each name="$Entry" in="$InvasionHistory">
                        <do_if value="@$Entry.$cue.exists and $Entry.$starttime ge player.age and $Entry.$cue.hasmission">
                          <set_value name="this.$ActiveInvasion" exact="$Entry.$cue"/>
                          <break/>
                        </do_if>
                      </do_for_each>
                      <do_if value="this.$ActiveInvasion">
                        <activate_mission cue="this.$ActiveInvasion"/>
                      </do_if>
                      <do_else>
                        <activate_mission cue="Start"/>
                      </do_else>
                    </do_if>
                  </actions>
                </cue>
                <cue name="InvasionConcluded_Send_Email">
                  <delay exact="if $QuickMode then [10s, 20s].randominrange else [3min, 4min].randominrange"/>
                  <actions>
                    <do_if value="$MasterHistoryList.count == 0">
                      <run_actions ref="Get_Num_Completed_Invasions" result="$CompletedInvasionCount">
                        <param name="InvasionHistoryList" value="$InvasionHistory"/>
                      </run_actions>
                      <debug_text text="'$CompletedInvasionCount ' + $CompletedInvasionCount"/>
                      <do_if value="not $LastUpdateEmailID and $CompletedInvasionCount le $TargetInvasionCount - 2 and $CompletedInvasionCount gt $TargetInvasionCount * 0.35">
                        <set_value name="$LastUpdateEmailID" exact="1501"/>
                        <write_incoming_message title="{30236,1601}" text="{30236,1501} + '\n\n' + {30236,1511}" source="$BosoTa" highpriority="true"/>
                      </do_if>
                      <do_elseif value="$LastUpdateEmailID lt 1502 and $CompletedInvasionCount le $TargetInvasionCount - 1 and $CompletedInvasionCount gt $TargetInvasionCount * 0.65">
                        <set_value name="$LastUpdateEmailID" exact="1502"/>
                        <write_incoming_message title="{30236,1601} + ' ' + {30236,1602}" text="{30236,1502} + '\n\n' + {30236,1510}" source="$BosoTa" highpriority="true"/>
                      </do_elseif>
                      <do_elseif value="$LastUpdateEmailID lt 1503 and $CompletedInvasionCount le $TargetInvasionCount and $CompletedInvasionCount gt $TargetInvasionCount * 0.90">
                        <set_value name="$LastUpdateEmailID" exact="1503"/>
                        <write_incoming_message title="{30236,1601} + ' ' + {30236,1603}" text="{30236,1503}" source="$BosoTa" highpriority="true"/>
                      </do_elseif>
                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>

            <!--event.param = table[
              $sector = target sector,
              $starttime = gametime of the invasion starting,
              $strength = strength points available for the invasion force, split among multiple Xenon and Kha'ak waves
              $endsignalcue = InvasionConcluded cue for the crisis to report the result of the sector invasion
              $debugchance = (optional)
              $quickmode = (optional) accelerate the invasion spawns and conclusion
              ]-->
            <cue name="Invasion_Instance" instantiate="true" namespace="this">
              <conditions>
                <event_cue_signalled/>
                <check_value value="typeof event.param == datatype.table"/>
              </conditions>
              <actions>
                <set_value name="$Crisis" exact="parent.namespace"/>
                <set_value name="$Sector" exact="event.param.$sector"/>
                <set_value name="$StartTime" exact="event.param.$starttime"/>
                <set_value name="$StartStrength" exact="event.param.$strength"/>
                <set_value name="$RemainingStrength" exact="$StartStrength"/>
                <set_value name="$FeedbackSignalCue" exact="@event.param.$feedbackcue"/>
                <set_value name="$EndSignalCue" exact="@event.param.$endsignalcue"/>
                <set_value name="$DebugChance" exact="@event.param.$debugchance"/>
                <set_value name="$DebugChance2" exact="@event.param.$debugchance2"/>
                <set_value name="$QuickMode" exact="@event.param.$quickmode"/>
                <set_value name="$IsEnd" exact="@event.param.$isend"/>

                <debug_text text="'Prepare for invading ' + $Sector + ' ' + $Sector.knownname + ' for strength ' + $StartStrength + ' Is end invasion: ' + $IsEnd" chance="$DebugChance"/>

                <set_value name="$XenonWavesSpawned" exact="0"/>
                <set_value name="$KhaakWavesSpawned" exact="0"/>
                <set_value name="$NumPlayerKills" exact="0"/>
                <set_value name="$NumPlayerOwnedKills" exact="0"/>

                <create_group groupname="$XenonShips"/>
                <create_group groupname="$KhaakShips"/>

                <set_value name="$InitialKhaakPosition" exact="null"/>
                <!--key: gametime, value: string identifier of type of activity e.g. attack_miners-->
                <set_value name="$KhaakHistory" exact="table[]"/>
                <set_value name="$CompletedFeedbackIDs" exact="[]"/>

                <signal_cue_instantly cue="$FeedbackSignalCue" param="[Invasion_Instance, 'instance_created']"/>
              </actions>
              <cues>
                <!--event.param.{2} == feedbackID-->
                <cue name="Feedback_Completed" instantiate="true">
                  <conditions>
                    <event_cue_signalled cue="parent" comment="Invasion instance cue could be signalled directly by the external Invasion_Instance_Feedback_Complete cue"/>
                    <check_value value="@event.param.{1} == 'feedback_complete'"/>
                  </conditions>
                  <actions>
                    <set_value name="$Crisis.$FeedbackCounterTable.{'$' + event.param.{2}}" operation="add"/>
                    <append_to_list name="$CompletedFeedbackIDs" exact="event.param.{2}"/>
                    <debug_text text="'completed feedback for ' + event.param.{2}" chance="$DebugChance"/>
                    <do_if value="event.param.{2} == 'xenon_enroute'">
                      <create_mission cue="Invasion_Instance" name="{30236,1001} + ': ' + $Sector.knownname" type="missiontype.crisis" faction="faction.player" activate="$Crisis.hasguidance" abortable="false" opposingfaction="faction.xenon"
                                      description="readtext.{30236}.{[1110, 1111, 1112].random} + ' ' + readtext.{30236}.{[1115, 1116, 1117].random}">
                        <briefing>
                          <objective step="1" action="objective.defend" object="$Sector"/>
                        </briefing>
                      </create_mission>
                      <set_objective_from_briefing cue="Invasion_Instance" step="1"/>
                    </do_if>
                    <do_elseif value="event.param.{2} == 'khaak_waves_init'">
                      <do_if value="$Crisis.$InvasionHistory.count lt $Crisis.$TargetInvasionCount / 4">
                        <set_value name="$MissionDesc" exact="readtext.{30236}.{[1120, 1121].random} + '\n' + {30236,1130}"/>
                      </do_if>
                      <do_else>
                        <set_value name="$MissionDesc" exact="readtext.{30236}.{[1120, 1121].random} + '\n' + {30236,1140}"/>
                      </do_else>
                      <update_mission cue="Invasion_Instance" description="$MissionDesc"/>
                    </do_elseif>
                    <do_elseif value="event.param.{2} == 'observed_khaak_captive'">
                      <do_if value="$ReleasedKhaak">
                        <set_value name="$ObservedKhaak" exact="true"/>
                        <update_mission cue="Invasion_Instance">
                          <briefing>
                            <objective step="1" action="objective.flyto" object="$Sector"/>
                            <objective step="2" action="objective.observe" object="$ReleasedKhaak" text="$ReleasedKhaak.knownname"/>
                            <objective step="3" action="objective.defend" object="$Sector"/>
                          </briefing>
                        </update_mission>
                        <set_objective_from_briefing cue="Invasion_Instance" step="2"/>
                      </do_if>
                    </do_elseif>
                    <do_elseif value="event.param.{2} == 'observed_khaak_captive_escaped'">
                      <do_if value="not $ObservedKhaak">
                        <update_mission cue="Invasion_Instance">
                          <briefing>
                            <objective step="1" action="objective.flyto" object="$Sector"/>
                            <objective step="2" action="objective.observe" text="macro.ship_kha_s_fighter_02_a_macro.name"/>
                            <objective step="3" action="objective.defend" object="$Sector"/>
                          </briefing>
                        </update_mission>
                      </do_if>
                      <set_objective_from_briefing cue="Invasion_Instance" step="3"/>
                    </do_elseif>
                  </actions>
                </cue>

                <!--TODO @Owen different counters per enemy?-->
                <cue name="Xenon_Killed" instantiate="true">
                  <conditions>
                    <event_object_destroyed group="$XenonShips"/>
                  </conditions>
                  <actions>
                    <do_if value="global.$PlayerControlledGroup.indexof.{event.param}">
                      <set_value name="$NumPlayerKills" operation="add"/>
                    </do_if>
                    <do_elseif value="@event.param.isplayerowned">
                      <set_value name="$NumPlayerOwnedKills" operation="add"/>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Khaak_Killed" instantiate="true">
                  <conditions>
                    <event_object_destroyed group="$KhaakShips"/>
                  </conditions>
                  <actions>
                    <do_if value="global.$PlayerControlledGroup.indexof.{event.param}">
                      <set_value name="$NumPlayerKills" operation="add"/>
                    </do_if>
                    <do_elseif value="@event.param.isplayerowned">
                      <set_value name="$NumPlayerOwnedKills" operation="add"/>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Create_Xenon_Invaders" checktime="$StartTime">
                  <actions>
                    <!--Grab the definition keys from the crisis' static data-->
                    <set_value name="$XenDefKeys" exact="md.Crisis_Xenon_Khaak_Combo.StaticData.$LeadXenonSpawnDefinitions"/>
                    <!--Shuffle for definitions with the same priority-->
                    <shuffle_list list="$XenDefKeys"/>

                    <set_value name="$SelectedDefinition" exact="null"/>
                    <do_for_each name="$XenDefID" in="$XenDefKeys">
                      <run_actions ref="md.LIB_Create_Ships.GetDefinitionCost" result="$ResultList">
                        <param name="DefinitionID" value="$XenDefID"/>
                        <param name="DefinitionTable" value="md.Crisis_Xenon_Khaak_Combo.StaticData.$XenonDefinitions"/>
                        <param name="ShipStrengthTable" value="md.Crisis_Xenon_Khaak_Combo.StaticData.$ShipStrengthTable"/>
                        <param name="DebugChance" value="$DebugChance"/>
                      </run_actions>
                      <do_if value="$ResultList.{1} and $ResultList.{1} lt $RemainingStrength">
                        <set_value name="$SelectedDefinition" exact="$XenDefID"/>
                        <break/>
                      </do_if>
                    </do_for_each>

                    <do_if value="$SelectedDefinition">
                      <!--Spawn the Xenon group in the outskirts of the sector-->
                      <set_value name="$SectorCentre" exact="$Sector.coreposition"/>
                      <set_value name="$SectorCoreSize" exact="$Sector.coresize" comment="Diameter"/>
                      <do_if value="$QuickMode">
                        <set_value name="$SectorSpawnDist" exact="$SectorCoreSize * 0.6f"/>
                      </do_if>
                      <do_else>
                        <set_value name="$SectorSpawnDist" exact="($SectorCoreSize * 0.9f) + 300km"/>
                      </do_else>
                      <run_actions ref="md.LIB_Generic.Create_Position_On_Plane" result="$SecSpawnPos">
                        <param name="AnchorPos" value="$SectorCentre"/>
                        <param name="Distance" value="$SectorSpawnDist"/>
                      </run_actions>

                      <set_value name="$Yaw" min="0deg" max="360deg"/>
                      <!--Get the position the Xenon will head towards within the core of the sector-->
                      <run_actions ref="md.LIB_Generic.Create_Position_On_Plane" result="$SecDeployPos">
                        <param name="AnchorPos" value="$SectorCentre"/>
                        <param name="Distance" value="[$SectorCoreSize * 0.2f, $SectorCoreSize * 0.35f].randominrange"/>
                        <param name="Yaw" value="$Yaw"/>
                      </run_actions>


                      <!--If there is a next sector, the Xenon will escape into deep space. Otherwise they will leave via a gate-->
                      <!--TODO @Owen get an escape position which would seem to lead to the next sector-->
                      <set_value name="$SecEscPos" exact="null"/>
                      <!--<do_if value="$NextSector">
                        <create_position name="$SecEscPos" x="$SecDeployPos.x + sin($Yaw + 180deg) * $SectorSpawnDist" y="$SecDeployPos.y" z="$SecDeployPos.z + cos($Yaw + 180deg) * 4000km"/>
                      </do_if>-->

                      <set_value name="$CreatedShips" exact="[]"/>
                      <run_actions ref="md.LIB_Create_Ships.SpawnShipsByDefinition" result="$SpawnResultList">
                        <param name="DefinitionID" value="$SelectedDefinition"/>
                        <param name="DefinitionTable" value="md.Crisis_Xenon_Khaak_Combo.StaticData.$XenonDefinitions"/>
                        <param name="ShipStrengthTable" value="md.Crisis_Xenon_Khaak_Combo.StaticData.$ShipStrengthTable"/>
                        <param name="AvailablePoints" value="$RemainingStrength"/>
                        <param name="Sector" value="$Sector"/>
                        <param name="Position" value="$SecSpawnPos"/>
                        <param name="Rotation" value="rotation.[$Yaw + 180deg, 0deg, 0deg]"/>
                        <param name="Owner" value="faction.xenon"/>
                        <param name="ResultList" value="$CreatedShips"/>
                        <param name="DebugChance" value="$DebugChance2"/>
                      </run_actions>

                      <do_if value="$CreatedShips.count">
                        <add_to_group groupname="$XenonShips" list="$CreatedShips"/>
                        <set_value name="$RemainingStrength" operation="subtract" exact="$SpawnResultList.{2}"/>
                        <do_all chance="$DebugChance">
                          <debug_text text="'### Created Initial Xenon Wave ### Sector: ' + $Sector.knownname + ' Definition: ' + $SelectedDefinition"/>
                          <debug_text text="'Time: ' + player.age + ' - ' + $CreatedShips.count + ' ships created with ' + $SpawnResultList.{2} + ' points.'"/>
                          <debug_text text="$RemainingStrength + ' points remain'"/>
                        </do_all>
                        <remove_value name="$CreatedShips"/>

                        <set_value name="$LeadShip" exact="$SpawnResultList.{1}"/>
                        <set_value name="$XenonWavesSpawned" operation="add"/>
                        <create_order id="'MoveGeneric'" name="$InitialXenonMoveOrder" object="$LeadShip">
                          <param name="destination" value="$Sector"/>
                          <param name="position" value="$SecDeployPos"/>
                          <param name="pursuetargets" value="false"/>
                          <param name="debugchance" value="$DebugChance"/>
                        </create_order>
                      </do_if>
                      <do_else>
                        <signal_cue_instantly cue="$EndSignalCue" param="table[$result = 'error', $cue = Invasion_Instance]"/>
                        <cancel_cue cue="Invasion_Instance"/>
                      </do_else>
                    </do_if>
                  </actions>
                  <cues>
                    <cue name="Create_Xenon_Invaders_Comment">
                      <delay exact="20s"/>
                      <actions>
                        <signal_cue_instantly cue="$FeedbackSignalCue" param="[Invasion_Instance, 'xenon_enroute']"/>
                      </actions>
                    </cue>
                    <cue name="Xenon_Spotted_Comment">
                      <conditions>
                        <event_object_enemy_found object="$LeadShip"/>
                        <check_value value="event.param.owner.iseconomic"/>
                        <check_value value="$LeadShip.distanceto.[$Sector, $Sector.coreposition] lt $Sector.coresize * 0.6f"/>
                        <check_any>
                          <check_value value="event.param.isclass.ship and not event.param.isunit and @event.param.aipilot.isclass.npc"/>
                          <check_value value="event.param.isclass.station and @event.param.tradenpc.isclass.npc"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="player.sector == $Sector">
                          <set_value name="this.$Actor" exact="if event.param.isclass.ship then event.param.aipilot else event.param.tradenpc"/>
                          <do_if value="readtext.{this.$Actor.page}.{10052}?">
                            <signal_cue_instantly cue="$FeedbackSignalCue" param="[Invasion_Instance, 'xenon_spotted', this.$Actor]"/>
                          </do_if>
                        </do_if>
                      </actions>
                    </cue>
                    <cue name="Lead_Xenon_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$LeadShip"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Send_Xenon_To_Nearby_Sector"/>
                        <signal_cue cue="InvasionWindingDown"/>
                        <cancel_cue cue="Deploy_Initial_Khaak"/>
                      </actions>
                    </cue>
                    <cue name="Lead_Xenon_Order_Finished">
                      <conditions>
                        <event_object_order_finished object="$LeadShip" order="$InitialXenonMoveOrder"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <do_if value="$LeadShip.isoperational">
                          <!--<assert value="false" text="'Xenon order to move into sector ended prematurely [Owen]'"/>-->
                          <set_value name="$ForceKhaakDeployment" exact="true"/>
                        </do_if>
                      </actions>
                    </cue>
                    <cue name="Deploy_Initial_Khaak" checkinterval="2s">
                      <conditions>
                        <check_value value="$LeadShip.isoperational and $LeadShip.sector == $Sector"/>
                        <check_any>
                          <check_value value="$LeadShip.distanceto.[$Sector, $Sector.coreposition] lt $Sector.coresize * 0.25f"/>
                          <check_value value="$LeadShip.distanceto.[$Sector, $SecDeployPos] lt 15km"/>
                          <check_value value="$LeadShip.hullpercentage le 69" comment="Lead ship is getting damaged and may not make it to the intended destination. Release the Kha'ak now."/>
                          <check_value value="@$ForceKhaakDeployment"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Lead_Xenon_Destroyed"/>
                        <do_if value="Lead_Xenon_Order_Finished.state == cuestate.waiting">
                          <cancel_cue cue="Lead_Xenon_Order_Finished"/>
                        </do_if>

                        <!--Make the Xenon not want to target the Kha'ak ships. They should still defend themselves if attacked.-->
                        <do_for_each name="$XenonShip" in="$XenonShips">
                          <set_relation_boost object="$XenonShip" faction="faction.khaak" value="1.0f" decay="0.1f" delay="10min"/>
                        </do_for_each>

                        <create_ship name="$ReleasedKhaak" macro="macro.ship_kha_s_fighter_02_a_macro" sector="$Sector">
                          <owner exact="faction.khaak"/>
                          <pilot>
                            <select faction="faction.khaak" tags="tag.fighterpilot"/>
                          </pilot>
                          <safepos object="$LeadShip"/>
                          <rotation yaw="[0deg, 360deg].randominrange" pitch="[0deg, 360deg].randominrange"/>
                        </create_ship>
                        <do_if value="not $Crisis.$FeedbackCounterTable.$observed_khaak_captive?">
                          <set_object_min_hull object="$ReleasedKhaak" exact="15"/>
                        </do_if>
                        <set_relation_boost object="$ReleasedKhaak" faction="faction.xenon" value="1.0f" decay="0.1f" delay="10min"/>
                        <get_safe_pos result="$KhaakEscapePos" object="$ReleasedKhaak" x="100km" sector="$Sector"/>
                        <create_order object="$ReleasedKhaak" id="'MoveWait'"  immediate="true" name="$moveorder">
                          <param name="destination" value="[$Sector, $KhaakEscapePos]" />
                          <param name="timeout" value="0s" comment="with 0s this will be infinite" />
                          <param name="noboost" value="true"/>
                        </create_order>

                        <do_if value="$SecEscPos">
                          <!--TODO @Owen have them keep going into deep space until they are no longer observed-->
                          <create_order id="'MoveGeneric'" name="$MoveOrder" object="$LeadShip">
                            <param name="destination" value="$Sector"/>
                            <param name="position" value="$SecEscPos"/>
                            <param name="pursuetargets" value="false"/>
                            <param name="debugchance" value="$DebugChance"/>
                          </create_order>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Send_Xenon_To_Nearby_Sector"/>
                        </do_else>
                      </actions>
                      <cues>
                        <cue name="Khaak_Escaping_Boso_Comment" checkinterval="1s">
                          <conditions>
                            <check_value value="not $Crisis.$FeedbackCounterTable.$observed_khaak_captive? and $ReleasedKhaak.isoperational and $ReleasedKhaak.sector == player.sector and player.entity.distanceto.{$ReleasedKhaak} lt 45km"/>
                          </conditions>
                          <actions>
                            <signal_cue_instantly cue="$FeedbackSignalCue" param="[Invasion_Instance, 'observed_khaak_captive', $ReleasedKhaak]"/>
                          </actions>
                        </cue>

                        <cue name="Khaak_Escaping_Fire_Weapon" onfail="cancel">
                          <conditions>
                            <check_value value="$ReleasedKhaak.isoperational"/>
                          </conditions>
                          <actions>
                            <do_if value="$ReleasedKhaak.attention ge attention.visible">
                              <shoot object="$ReleasedKhaak" primary="true" secondary="false"/>
                            </do_if>
                          </actions>
                          <delay min="2s" max="3s"/>
                          <actions>
                            <reset_cue cue="this"/>
                          </actions>
                        </cue>

                        <cue name="Khaak_Escaped">
                          <delay exact="20s"/>
                          <actions>
                            <set_value name="$PlayerClose" exact="player.sector == $ReleasedKhaak.sector and player.entity.distanceto.{$ReleasedKhaak}"/>
                            <add_effect object="$ReleasedKhaak.zone" effect="if $PlayerClose lt 10km then 'jump_jumpin_khaak' else 'jump_jumpin_capship'">
                              <position object="$ReleasedKhaak"/>
                            </add_effect>
                            <cancel_cue cue="Escaping_Khaak_Killed"/>
                          </actions>
                          <delay exact="0.5s"/>
                          <actions>
                            <destroy_object object="$ReleasedKhaak" explosion="false"/>
                            <do_if value="$QuickMode">
                              <set_value name="$KhaakSpawnDelay" exact="5s"/>
                            </do_if>
                            <do_else>
                              <set_value name="$KhaakSpawnDelay" min="30s" max="40s"/>
                            </do_else>
                            <signal_cue cue="Start_Khaak_Waves"/>
                          </actions>
                          <delay exact="4s"/>
                          <actions>
                            <do_if value="not $Crisis.$FeedbackCounterTable.$observed_khaak_captive_escaped? and Khaak_Escaping_Boso_Comment.state == cuestate.complete">
                              <signal_cue_instantly cue="$FeedbackSignalCue" param="[Invasion_Instance, 'observed_khaak_captive_escaped']"/>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Escaping_Khaak_Killed">
                          <conditions>
                            <event_object_destroyed object="$ReleasedKhaak"/>
                          </conditions>
                          <actions>
                            <set_value name="$KhaakSpawnDelay" min="30s" max="40s"/>
                            <cancel_cue cue="Khaak_Escaped"/>
                            <signal_cue cue="Start_Khaak_Waves"/>
                          </actions>
                        </cue>

                        <cue name="Start_Khaak_Waves">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="$KhaakSpawnDelay / 2"/>
                          <actions>
                            <signal_cue_instantly cue="$FeedbackSignalCue" param="[Invasion_Instance, 'khaak_waves_init']"/>
                            <set_value name="$InitialKhaakWaves" min="1" max="3"/>
                          </actions>
                          <cues>
                            <cue name="Khaak_Spawn_Ticker">
                              <delay exact="$KhaakSpawnDelay"/>
                              <actions>
                                <do_if value="InvasionWindingDown.state != cuestate.complete">
                                  <!--Spawn_Khaak_Wave will attempt to spawn the Kha'ak and trigger the end if none can be created-->
                                  <signal_cue cue="Spawn_Khaak_Wave"/>
                                  <do_if value="$KhaakWavesSpawned lt $InitialKhaakWaves">
                                    <!--Spawn several waves in quick succession at the start-->
                                    <set_value name="$KhaakSpawnDelay" min="6s" max="8s"/>
                                  </do_if>
                                  <do_elseif value="$QuickMode">
                                    <set_value name="$KhaakSpawnDelay" exact="2s"/>
                                  </do_elseif>
                                  <do_else>
                                    <set_value name="$KhaakSpawnDelay" min="4min" max="6min"/>
                                  </do_else>
                                  <reset_cue cue="this"/>
                                </do_if>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Spawn_Khaak_Wave" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="this.$KhaakShipSpawned" exact="false"/>
                            <set_value name="$SelectedAction" exact="null"/>
                            <set_value name="$ActionTarget" exact="null"/>
                            <do_if value="$RemainingStrength gt 0">
                              <set_value name="$PossibleKhaakActions" exact="[
                                'attack_player_miners_light',
                                'attack_player_miners_heavy',
                                'attack_station_light',
                                'attack_station_heavy',
                                'generic_medium',
                                'generic_heavy',
                                ]"/>
                              <!--Remove the last few performed action so there are less repeats-->
                              <set_value name="$i" exact="0"/>

                              <do_for_each valuename="$PreviousAction" in="$KhaakHistory">
                                <do_if value="$PreviousAction != 'generic_medium' and $PreviousAction != 'generic_heavy'">
                                  <set_value name="$i" operation="add"/>
                                  <remove_from_list name="$PossibleKhaakActions" exact="$PreviousAction"/>
                                  <do_if value="$i ge 2">
                                    <break/>
                                  </do_if>
                                </do_if>
                              </do_for_each>

                              <shuffle_list list="$PossibleKhaakActions"/>

                              <do_for_each name="$PossibleKhaakAction" in="$PossibleKhaakActions">
                                <do_if value="$PossibleKhaakAction == 'attack_player_miners_light' or $PossibleKhaakAction == 'attack_player_miners_heavy'">
                                  <!--TODO @Owen have a cue track which player ships are actually mining in the sector and select from those-->
                                  <find_ship_by_true_owner name="$PlayerMiningShip" faction="faction.player" shiptype="shiptype.miner" docked="false" space="$Sector"/>
                                  <do_if value="$PlayerMiningShip">
                                    <set_value name="$SelectedAction" exact="$PossibleKhaakAction"/>
                                    <set_value name="$ActionTarget" exact="$PlayerMiningShip"/>
                                    <break/>
                                  </do_if>
                                </do_if>
                                <do_elseif value="$PossibleKhaakAction == 'attack_station_light' or $PossibleKhaakAction == 'attack_station_heavy'">
                                  <find_station_by_true_owner name="$PlayerStation" faction="faction.player" space="$Sector"/>
                                  <do_if value="$PlayerStation">
                                    <set_value name="$SelectedAction" exact="$PossibleKhaakAction"/>
                                    <set_value name="$ActionTarget" exact="$PlayerStation"/>
                                    <break/>
                                  </do_if>
                                </do_elseif>
                                <do_elseif value="$PossibleKhaakAction == 'generic_medium'">
                                  <find_ship name="$PotentialStation" space="$Sector">
                                    <match_relation_to faction="faction.khaak" relation="kill"/>
                                  </find_ship>
                                  <do_if value="$PotentialStation">
                                    <set_value name="$SelectedAction" exact="$PossibleKhaakAction"/>
                                    <set_value name="$ActionTarget" exact="$PotentialStation"/>
                                    <break/>
                                  </do_if>
                                </do_elseif>
                                <do_elseif value="$PossibleKhaakAction == 'generic_heavy'">
                                  <find_object name="$PotentialTarget" class="[class.ship, class.station]" space="$Sector">
                                    <match_relation_to faction="faction.khaak" relation="kill"/>
                                  </find_object>
                                  <do_if value="$PotentialTarget">
                                    <set_value name="$SelectedAction" exact="$PossibleKhaakAction"/>
                                    <set_value name="$ActionTarget" exact="$PotentialTarget"/>
                                    <break/>
                                  </do_if>
                                </do_elseif>
                                <do_if value="$SelectedAction and $ActionTarget">
                                  <break/>
                                </do_if>
                              </do_for_each>

                              <do_if value="$SelectedAction and $ActionTarget">
                                <debug_text text="'SelectedAction ' + $SelectedAction + ' target ' + $ActionTarget + ' ' + $ActionTarget.knownname" chance="$DebugChance"/>
                                <set_value name="$KhaakDefinitionList" exact="[]"/>
                                <do_if value="$SelectedAction == 'attack_player_miners_light'">
                                  <do_all min="2" max="5">
                                    <do_any>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeM_escorts_1'" weight="30"/>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeS_escorts_1'" weight="100"/>
                                    </do_any>
                                  </do_all>
                                </do_if>
                                <do_elseif value="$SelectedAction == 'attack_player_miners_heavy'">
                                  <append_to_list name="$KhaakDefinitionList" exact="'$kha_capship_with_SizeM_escorts_2'"/>
                                  <do_all min="3" max="6">
                                    <do_any>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeM_escorts_1'" weight="30"/>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeS_escorts_1'" weight="100"/>
                                    </do_any>
                                  </do_all>
                                </do_elseif>
                                <do_elseif value="$SelectedAction == 'attack_station_light'">
                                  <append_to_list name="$KhaakDefinitionList" exact="'$kha_capship_with_SizeM_escorts_2'"/>
                                  <do_all min="2" max="3">
                                    <do_any>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeM_escorts_1'" weight="30"/>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeS_escorts_1'" weight="100"/>
                                    </do_any>
                                  </do_all>
                                </do_elseif>
                                <do_elseif value="$SelectedAction == 'attack_station_heavy'">
                                  <append_to_list name="$KhaakDefinitionList" exact="'$kha_capship_with_SizeM_escorts_2'"/>
                                  <append_to_list name="$KhaakDefinitionList" exact="'$kha_capship_with_SizeM_escorts_2'" chance="20"/>
                                  <do_all min="3" max="8">
                                    <do_any>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeM_escorts_1'" weight="30"/>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeS_escorts_1'" weight="100"/>
                                    </do_any>
                                  </do_all>
                                </do_elseif>
                                <do_elseif value="$SelectedAction == 'generic_medium'">
                                  <do_all min="3" max="8">
                                    <do_any>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeM_escorts_1'" weight="30"/>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeS_escorts_1'" weight="100"/>
                                    </do_any>
                                  </do_all>
                                </do_elseif>
                                <do_elseif value="$SelectedAction == 'generic_heavy'">
                                  <append_to_list name="$KhaakDefinitionList" exact="'$kha_capship_with_SizeM_escorts_2'"/>
                                  <append_to_list name="$KhaakDefinitionList" exact="'$kha_capship_with_SizeM_escorts_2'" chance="20"/>
                                  <do_all min="3" max="8">
                                    <do_any>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeM_escorts_1'" weight="30"/>
                                      <append_to_list name="$KhaakDefinitionList" exact="'$kha_SizeM_with_SizeS_escorts_1'" weight="100"/>
                                    </do_any>
                                  </do_all>
                                </do_elseif>

                                <do_for_each name="$KhaakDefinition" in="$KhaakDefinitionList">
                                  <create_position name="$InitialKhaakPosition" object="$ActionTarget" min="7km" max="10km" space="$Sector"/>
                                  <set_value name="$Yaw" min="-180deg" max="180deg"/>
                                  <set_value name="$Pitch" min="-30deg" max="30deg"/>
                                  <set_value name="$CreatedShips" exact="[]"/>
                                  <run_actions ref="md.LIB_Create_Ships.SpawnShipsByDefinition" result="$SpawnResultList">
                                    <param name="DefinitionID" value="$KhaakDefinition"/>
                                    <param name="DefinitionTable" value="md.Crisis_Xenon_Khaak_Combo.StaticData.$KhaakDefinitions"/>
                                    <param name="ShipStrengthTable" value="md.Crisis_Xenon_Khaak_Combo.StaticData.$ShipStrengthTable"/>
                                    <param name="AvailablePoints" value="$RemainingStrength"/>
                                    <param name="Sector" value="$Sector"/>
                                    <param name="Position" value="$InitialKhaakPosition"/>
                                    <param name="Rotation" value="rotation.[$Yaw, $Pitch, 0deg]"/>
                                    <param name="Owner" value="faction.khaak"/>
                                    <param name="ResultList" value="$CreatedShips"/>
                                    <param name="EffectTable" value="md.Crisis_Xenon_Khaak_Combo.StaticData.$KhaakSpawnEffects"/>
                                    <param name="DebugChance" value="$DebugChance2"/>
                                  </run_actions>

                                  <do_if value="$CreatedShips.count">
                                    <set_value name="this.$KhaakShipSpawned" exact="true"/>
                                    <add_to_group groupname="$KhaakShips" list="$CreatedShips"/>
                                    <set_value name="$RemainingStrength" operation="subtract" exact="$SpawnResultList.{2}"/>
                                    <do_all chance="$DebugChance">
                                      <debug_text text="'### Spawned Khaak Wave ### Sector: ' + $Sector.knownname + ' Definition: ' + $KhaakDefinition"/>
                                      <debug_text text="'Time: ' + player.age + ' - ' + $CreatedShips + ' ships created with ' + $SpawnResultList.{2} + ' points.'"/>
                                      <debug_text text="$RemainingStrength + ' points remain'"/>
                                    </do_all>
                                    <remove_value name="$CreatedShips"/>

                                    <!--TODO @Owen check if there are better orders for each action-->
                                    <create_order id="'Patrol'" object="$SpawnResultList.{1}" default="true">
                                      <param name="space" value="$Sector"/>
                                    </create_order>
                                  </do_if>
                                </do_for_each>
                                <do_if value="this.$KhaakShipSpawned">
                                  <set_value name="$KhaakWavesSpawned" operation="add"/>
                                  <debug_text text="'Khaak have spawned. RemainingStrength: ' + $RemainingStrength" chance="$DebugChance"/>
                                  <set_value name="$KhaakHistory.{player.age}" exact="$SelectedAction"/>
                                  <do_if value="$KhaakHistory.keys.count gt 100">
                                    <remove_value name="$KhaakHistory.{$KhaakHistory.keys.list.{1}}"/>
                                  </do_if>
                                  <signal_cue_instantly cue="$FeedbackSignalCue" param="[Invasion_Instance, 'khaak_wave_spawned']"/>
                                </do_if>
                              </do_if>
                            </do_if>
                            <do_if value="not this.$KhaakShipSpawned">
                              <debug_text text="'Unable to spawn Khaak. $RemainingStrength ' + $RemainingStrength + ' $SelectedAction: ' + $SelectedAction + ' $ActionTarget: ' + @$ActionTarget.debugname" chance="$DebugChance"/>
                              <signal_cue cue="InvasionWindingDown" check="false"/>
                            </do_if>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Send_Xenon_To_Nearby_Sector">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="$XenonShips.count">
                          <set_value name="this.$LeadShip" exact="if $LeadShip.isoperational then $LeadShip else $XenonShips.{1}.toplevelcommander"/>
                          <!--Find another nearby sector to send the Xenon to cause trouble so they don't get in the way of the Kha'ak-->
                          <!--TODO @Owen exclude story sectors-->
                          <set_value name="$FollowupSector" exact="null"/>
                          <set_value name="$PlayerSectors" exact="md.Player_Evaluator.ValueManager.$TotalValueBySector.keys.list"/>
                          <remove_from_list name="$PlayerSectors" exact="$Sector"/>
                          <find_sector_in_range name="$NearbySectors" excluded="md.$XenonCrisisIgnoredSectors" object="$Sector" maxdistance="2" multiple="true"/>
                          <do_if value="$NearbySectors">
                            <do_for_each name="$NearbySector" in="$NearbySectors">
                              <do_if value="@md.Player_Evaluator.ValueManager.$TotalValueBySector.{$NearbySector} ge $Crisis.$FleeingXenonTargetSecValue">
                                <set_value name="$FollowupSector" exact="$NearbySector"/>
                                <break/>
                              </do_if>
                            </do_for_each>
                            <do_if value="not $FollowupSector">
                              <set_value name="$FollowupSector" exact="$NearbySectors.random"/>
                            </do_if>
                            <do_if value="$FollowupSector">
                              <create_order id="'Patrol'" object="$LeadShip" default="true">
                                <param name="space" value="$FollowupSector"/>
                              </create_order>
                            </do_if>
                          </do_if>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="InvasionWindingDown">
                      <conditions>
                        <event_cue_signalled/>
                        <check_any>
                          <check_all>
                            <check_value value="$QuickMode"/>
                            <set_value name="$WindDownTime" exact="4s"/>
                          </check_all>
                          <check_all>
                            <check_value value="not $QuickMode"/>
                            <set_value name="$WindDownTime" min="7min" max="8min"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <delay exact="$WindDownTime"/>
                      <actions>
                        <signal_cue_instantly cue="$FeedbackSignalCue" param="[Invasion_Instance, 'invasion_winding_down']"/>
                      </actions>
                      <cues>
                        <cue name="InvasionFinishing">
                          <conditions>
                            <event_cue_completed cue="InvasionWindingDown"/>
                          </conditions>
                          <actions>
                            <shuffle_group group="$KhaakShips"/>
                          </actions>
                          <cues>
                            <cue name="Warp_Khaak_To_Destruction">
                              <delay min="1s" max="2s"/>
                              <actions>
                                <do_if value="$KhaakShips.count">
                                  <set_value name="this.$Ship" exact="$KhaakShips.{1}"/>
                                  <debug_text text="'killing khaak ' + this.$Ship.debugname + ' via warp effect'" chance="$DebugChance"/>
                                  <do_if value="player.sector and player.sector == this.$Ship.sector">
                                    <add_effect object="this.$Ship.zone" effect="'jump_jumpin_capship'">
                                      <position value="this.$Ship.position"/>
                                      <rotation value="this.$Ship.rotation"/>
                                    </add_effect>
                                    <add_effect object="this.$Ship" effect="'warpteleport'"/>
                                  </do_if>
                                </do_if>
                                <do_else>
                                  <cancel_cue cue="this"/>
                                </do_else>
                              </actions>
                              <delay exact="1s"/>
                              <actions>
                                <destroy_object object="this.$Ship" explosion="false"/>
                                <reset_cue cue="this"/>
                              </actions>
                            </cue>

                            <cue name="InvasionEnded" checkinterval="1s">
                              <conditions>
                                <check_any>
                                  <check_value value="player.age gt parent.time + 5min"/>
                                  <check_value value="player.age gt parent.time + 1min and $KhaakShips.count == 0"/>
                                  <check_value value="player.age gt parent.time + 20s and $QuickMode"/>
                                </check_any>
                              </conditions>
                              <actions>
                                <signal_cue_instantly cue="$EndSignalCue" param="table[$result = 'finished', $cue = Invasion_Instance]"/>
                                <do_if value="$NumPlayerKills or $NumPlayerOwnedKills">
                                  <remove_mission cue="Invasion_Instance" type="completed"/>
                                </do_if>
                                <do_else>
                                  <remove_mission cue="Invasion_Instance" type="failed"/>
                                </do_else>
                                <cancel_cue cue="Invasion_Instance"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>

            </cue>

            <cue name="End_Game" version="3">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!--todo remove-->
              </actions>
              <delay exact="30s"/>
              <actions>
                <debug_text text="'Endgame started after ' + (player.age - Start.time)" chance="$DebugChance"/>

                <!--Set up the CPU ship manager for the endgame-->
                <set_value name="CPU_Ship_Manager.$MinVulnerableHull" exact="30"/>
                <set_value name="CPU_Ship_Manager.$MinHiddenDuration" exact="20min"/>
                <set_value name="CPU_Ship_Manager.$MaxHiddenDuration" exact="40min"/>
                <set_value name="CPU_Ship_Manager.$HiddenEndState" exact="'awake'"/>
                <signal_cue_instantly cue="Request_CPU_Ship_State" param="'awake'"/>
                <set_value name="this.$FirstGuidance" exact="true"/>
                <set_value name="md.$Enable_CPU_Ship_Boso_Encounter_Comment" exact="false"/>
              </actions>
              <patch sinceversion="3">
                <set_value name="md.$Enable_CPU_Ship_Boso_Encounter_Comment" exact="false"/>
                <set_object_name object="CPU_Ship_Manager.$CPUShip" page="20101" line="75201"/>
              </patch>
              <cues>
                <cue name="End_Game_CPU_Ship_In_Universe" onfail="cancel">
                  <conditions>
                    <check_value value="CPU_Ship_Manager.$CPUShip.cluster.isnormalcluster"/>
                    <check_value value="End_Game_CPU_In_Safemode.state == cuestate.waiting" comment="savegame compatibility"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="End_Game_Set_CPU_Guidance_V2" check="false"/>
                  </actions>
                </cue>

                <cue name="End_Game_CPU_Ship_Entered_Universe" instantiate="true">
                  <conditions>
                    <event_object_changed_cluster object="CPU_Ship_Manager.$CPUShip"/>
                    <check_value value="event.param.isnormalcluster"/>
                  </conditions>
                  <actions>
                    <do_if value="parent.$FirstGuidance">
                      <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360320, $recipient = 'player', $monitor = true, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360321, $recipient = 'player', $monitor = true, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360322, $recipient = 'player', $monitor = true, $comment = ''],
                                    ],
                          $callbackcue = End_Game_Set_CPU_Guidance_V2,
                          $abortcallbackcue = End_Game_Set_CPU_Guidance_V2
                         ]" />
                    </do_if>
                    <do_else>
                      <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360330, $recipient = 'player', $monitor = true, $comment = ''],
                                    ],
                          $callbackcue = End_Game_Set_CPU_Guidance_V2,
                          $abortcallbackcue = End_Game_Set_CPU_Guidance_V2
                         ]" />
                    </do_else>
                  </actions>
                </cue>

                <cue name="End_Game_Set_CPU_Guidance_V2" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="parent.$FirstGuidance">
                      <update_mission cue="Start">
                        <briefing>
                          <objective step="3" action="objective.destroy" object="CPU_Ship_Manager.$CPUShip" text="{20109,5101}"/>
                        </briefing>
                      </update_mission>
                    </do_if>
                    <do_else>
                      <update_mission cue="Start">
                        <briefing>
                          <objective step="3" action="objective.destroy" object="CPU_Ship_Manager.$CPUShip"/>
                        </briefing>
                      </update_mission>
                    </do_else>
                    <set_objective_from_briefing cue="Start" step="3"/>
                    <reset_cue cue="End_Game_Approach_CPU_Ship"/>
                    <reset_cue cue="End_Game_CPU_Ship_Discovered"/>
                  </actions>
                </cue>

                <cue name="End_Game_CPU_Ship_Left_Universe" instantiate="true">
                  <conditions>
                    <event_object_changed_cluster object="CPU_Ship_Manager.$CPUShip"/>
                    <check_value value="event.param.ispresentation"/>
                  </conditions>
                  <actions>
                    <do_if value="End_Game_CPU_Ship_Discovered.state == cuestate.waiting">
                      <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360323, $recipient = 'player', $monitor = true, $comment = ''],
                                    ],
                          $callbackcue = End_Game_Clear_CPU_Guidance,
                          $abortcallbackcue = End_Game_Clear_CPU_Guidance
                         ]" />
                    </do_if>
                    <do_else>
                      <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360329, $recipient = 'player', $monitor = true, $comment = ''],
                                    ],
                          $callbackcue = End_Game_Clear_CPU_Guidance,
                          $abortcallbackcue = End_Game_Clear_CPU_Guidance
                         ]" />
                    </do_else>
                  </actions>
                </cue>

                <cue name="End_Game_Clear_CPU_Guidance" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <update_mission cue="Start">
                      <briefing>
                        <objective step="2" action="objective.await" text="{30236,1011}"/>
                      </briefing>
                    </update_mission>
                    <set_objective_from_briefing cue="Start" step="2"/>
                    <set_value name="End_Game.$FirstGuidance" exact="false"/>
                  </actions>
                </cue>

                <cue name="End_Game_Approach_CPU_Ship" checkinterval="5s">
                  <conditions>
                    <check_value value="player.sector == CPU_Ship_Manager.$CPUShip.sector and player.entity.distanceto.{CPU_Ship_Manager.$CPUShip} lt 25km"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="End_Game_CPU_Ship_Discovered" check="false"/>
                  </actions>
                </cue>

                <cue name="End_Game_CPU_Ship_Discovered">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <check_all>
                        <event_object_attacked object="CPU_Ship_Manager.$CPUShip"/>
                        <check_value value="event.param.isplayerowned"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <cancel_cue cue="End_Game_Approach_CPU_Ship"/>
                    <do_if value="End_Game.$FirstGuidance">
                      <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360324, $recipient = 'player', $monitor = true, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360325, $recipient = 'player', $monitor = true, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360326, $recipient = 'player', $monitor = true, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360327, $recipient = 'player', $monitor = true, $comment = ''],
                                    ],
                         ]" />
                    </do_if>
                    <do_else>
                      <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360331, $recipient = 'player', $monitor = true, $comment = ''],
                                    ],
                         ]" />
                    </do_else>
                  </actions>
                </cue>

                <cue name="End_Game_CPU_Ship_Charging_Jumpdrive" instantiate="true">
                  <conditions>
                    <event_object_signalled object="CPU_Ship_Manager.$CPUShip" param="'cpu_charging_jumpdrive'"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360328, $recipient = 'player', $monitor = true, $comment = ''],
                                    ],
                         ]" />
                  </actions>
                </cue>

                <cue name="End_Game_CPU_In_Safemode" checkinterval="5s">
                  <conditions>
                    <check_value value="CPU_Ship_Manager.$CPUState == 'safemode'"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[
                          $caller = this, $preset = '$plot', $actors = $MissionActors, $nofullscreenmenu = false, $debugchance = $DebugChance,
                          $script = [
                                    table[ $actor = '$BosoTa', $speak = 302360332, $recipient = 'player', $monitor = true, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360333, $recipient = 'player', $monitor = true, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360334, $recipient = 'player', $monitor = true, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360335, $recipient = 'player', $monitor = true, $comment = ''],
                                    1s,
                                    table[ $actor = '$BosoTa', $speak = 302360336, $recipient = 'player', $monitor = true, $comment = ''],
                                    ],
                          $callbackcue = End_Game_Remove_Mission,
                          $abortcallbackcue = End_Game_Remove_Mission
                         ]" />
                  </actions>
                </cue>

                <cue name="End_Game_Remove_Mission" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <unlock_achievement name="RESOLVE_XENON_CRISIS" />
                    <remove_mission cue="Start" type="completed"/>
                    <cancel_cue cue="End_Game_CPU_Ship_Entered_Universe"/>
                    <cancel_cue cue="End_Game_CPU_Ship_Left_Universe"/>
                    <cancel_cue cue="End_Game_Approach_CPU_Ship"/>

                    <!--Remove the second research so it can be researched again later-->
                    <remove_research ware="ware.research_xenon_crisis_02"/>
                    <remove_encyclopedia_entry type="researchables" item="'research_xenon_crisis_02'"/>
                  </actions>
                  <patch sinceversion="2">
                    <cancel_cue cue="End_Game_CPU_Ship_Entered_Universe"/>
                    <cancel_cue cue="End_Game_CPU_Ship_Left_Universe"/>
                    <cancel_cue cue="End_Game_Approach_CPU_Ship"/>
                  </patch>
                  <cues>
                    <cue name="End_Game_Restart_Crisis" version="2">
                      <actions>
                        <set_value name="CPU_Ship_Manager.$MinHiddenDuration" exact="-1s"/>
                        <set_value name="CPU_Ship_Manager.$MaxHiddenDuration" exact="-1s"/>
                        <set_value name="CPU_Ship_Manager.$MinVulnerableHull" exact="-1" comment="reset CPU ship to not go into safemode again until the next end phase"/>
                        <run_actions result="$TriggerSuccess" ref="md.Crisis_Manager.EndCrisis">
                          <param name="Cue" value="namespace"/>
                        </run_actions>
                        <set_value name="$RestartOfferTime" min="End_Game_Remove_Mission.time + 120h" max="End_Game_Remove_Mission.time + 121h"/>
                      </actions>
                      <patch sinceversion="2">
                        <set_value name="CPU_Ship_Manager.$MinHiddenDuration" exact="-1s"/>
                        <set_value name="CPU_Ship_Manager.$MaxHiddenDuration" exact="-1s"/>
                      </patch>
                      <cues>
                        <cue name="End_Game_Restart_Crisis_Wait" checkinterval="5s">
                          <conditions>
                            <check_value value="player.age gt $RestartOfferTime"/>
                          </conditions>
                          <actions>
                            <add_encyclopedia_entry type="researchables" item="'research_xenon_crisis_01'"/>
                            <add_research ware="ware.research_xenon_crisis_01"/>
                            <add_encyclopedia_entry type="researchables" item="'research_xenon_crisis_02'"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Research_02_Done" instantiate="true">
          <conditions>
            <event_player_research_unlocked ware="ware.research_xenon_crisis_02"/>
            <cue_is_complete cue="End_Game_Restart_Crisis_Wait"/>
          </conditions>
          <actions>
            <reset_cue cue="TriggerCrisis"/>
          </actions>
          <delay exact="10s"/>
          <actions>
            <signal_cue_instantly cue="Request_CPU_Ship_State" param="'sleeping'"/>
            <signal_cue cue="TriggerCrisis"/>
          </actions>
        </cue>

        <cue name="CleanUp">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <cancel_cue cue="Start"/>
          </actions>
        </cue>

        <cue name="StartWasSignalled" instantiate="true">
          <conditions>
            <event_cue_signalled cue="Start"/>
          </conditions>
          <actions>
            <debug_text text="'param:  ' + event.param" chance="$DebugChance"/>
          </actions>
        </cue>

        <!--event.param = state string-->
        <cue name="Request_CPU_Ship_State" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
        </cue>

        <cue name="CPU_Ship_Signal_Cue" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
        </cue>

        <!--Set up the CPU ship encounter and behaviour-->
        <cue name="CPU_Ship_Manager" ref="md.CPU_Ship_Manager.Manager" namespace="this">
          <param name="CPU_Macro" value="$CPU_Macro"/>
          <param name="Macro_Name_Table" value="$CPU_Ship_Name_Table"/>
          <param name="PotentialSectorMacros" value="$PotentialCPUSectorMacros"/>
          <param name="SignalCue" value="CPU_Ship_Signal_Cue"/>
          <param name="RequestStateSignalCue" value="Request_CPU_Ship_State"/>
          <param name="DebugChance" value="$DebugChance"/>
        </cue>
      </cues>
    </library>

  </cues>
</mdscript>