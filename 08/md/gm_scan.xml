<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GM_Scan" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <!--Base Mission information-->
    <!--
      Generic Mission name:    Board ship - intended for Master Missions
      Primary 'missiontype':   missiontype.intelligence
      Page: 30140
      Note: This GM is for boarding both a specified ship (GM_Scan) and non-specified ship (HL_BoardRare)
    -->

    <!-- Variant Table -->
    <cue name="TextOffsets" namespace="this">
      <actions>
        <set_value name="$Cue" exact="md.GM_Scan.GenerateGenericMission"/>
        <append_to_list name="md.GenericMissions.Manager.$StaticGMCues" exact="$Cue" create="true" unique="true"/>
        <set_value name="$Cue.$TextOffsets" exact="table[]" comment="$Cue.$TextOffsets.{$Page}.{$TextOffset}"/>
        <set_value name="$Cue.$TextOffsets.{30140}"
                   exact="table[ {10000} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {10100} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {10200} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {10300} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {10400} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {10500} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {20000} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {20100} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {20200} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {20300} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {20400} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {20500} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {20600} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {30000} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {30100} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {30200} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {30300} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {40000} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {40100} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {40200} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {40300} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {40400} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {50000} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {60000} = table[$lastoffertime = 0s, $offercounter = 0],
                                 {70000} = table[$lastoffertime = 0s, $offercounter = 0]]"/>
      </actions>
    </cue>

    <!--
      The Feedback Manager contains a table of feedback values related to this Generic Mission. 
		  This table is 'const' during the mission (the table itself doesn't change anymore after inialization)
	    There are several maintypes of feedback:
        event:    Something which happens during a mission but does not cause it to end e.g. the mission being accepted
        removed:  The mission offer was removed before acceptance
        success:  The mission was successfully completed by the player
        failure:  The player failed the mission
        error:    Something went wrong with the mission set-up or during the mission
    -->
    <cue name="FeedbackValueManager" namespace="this" version="5">
      <actions>
        <set_value name="$FeedbackValues" exact="table[
                   $MISSION_GENERATED       = table[$type = 'event',    $text = 'Mission variation generated successfully'],
                   $MISSION_ACCEPTED        = table[$type = 'event',    $text = 'Mission accepted'],
                   $MISSION_NO_VARIANT      = table[$type = 'event',    $text = 'No mission variant currently possible'],
                   $MISSION_NO_NPC_SCENE    = table[$type = 'event',    $text = 'No mission NPC scene could be set up'],
                   
                   $OFFER_REMOVED           = table[$type = 'removed',  $text = 'Offer removed'],
                   $DECLINED_OFFER          = table[$type = 'removed',  $text = 'Player declined Event Offer'],
                   $EVENT_OFFER_TIMEOUT     = table[$type = 'removed',  $text = 'Event Offer timeout'],
                   $SIGNAL_LEAK_REMOVED     = table[$type = 'removed',  $text = 'Signal leak offer removed'],
                   $TARGET_KILLED_EARLY     = table[$type = 'removed',  $text = 'Object was destroyed during the offer'],
                   
                   $MISSION_SUCCEEDED       = table[$type = 'success',  $text = 'Mission succeeded'],
                   
                   $MISSION_ABORTED         = table[$type = 'failure',  $text = 'Mission aborted by player'],
                   $FORCED_CLEANUP          = table[$type = 'failure',  $text = 'Forced to end from outside'],
                   $MISSION_TIMEOUT         = table[$type = 'failure',  $text = 'Mission timeout'],
                   $RML_FAILED              = table[$type = 'failure',  $text = 'RML failure'],
                   $FACTION_RELATIONS_CHANGED = table[$type = 'failure',  $text = 'Relation between the two involved factions changed'],
                   
                   $NO_VALID_CLIENT_OWNER   = table[$type = 'error',    $text = 'No valid ClientOwner parameter provided'],
                   $INVALID_OFFER_TYPE      = table[$type = 'error',    $text = 'No offer parameters were valid'],
                   $NO_TEXT_OFFSET          = table[$type = 'error',    $text = 'No TextOffset set'],
                   $INVALID_FORCE_CLEANUP   = table[$type = 'error',    $text = 'ForceCleanup cue invalid'],
                   $RML_ERROR               = table[$type = 'error',    $text = 'RML error']
                   ]"/>
      </actions>
      <patch sinceversion="5">
        <!--To patch new feedback values, increment 'version' and 'sinceversion' number-->
        <force_cue cue="FeedbackValueManager"/>
      </patch>
    </cue>

    <!--Required variables: $Page & $TextOffset (and any below substitute_text values)
    If text is to be substituted for a new text variant, people should feel free to add the substitution below. Alternatively, pass in an overriding text in the $TextTable param-->
    <library name="GenerateTextTable">
      <actions>
        <!-- Register unknown TextOffsets to the TextOffsets table -->
        <run_actions ref="md.GenericMissions.RegisterMissionVariant">
          <param name="StaticGMCue" value="md.GM_Scan.GenerateGenericMission"/>
          <param name="Page"        value="$Page"/>
          <param name="TextOffset"  value="$TextOffset"/>
        </run_actions>

        <!--Text page indexes $TextOffset + #
        1 = $TextTable.$missionname
        2 = $TextTable.$description
        3 = $TextTable.$objective-->
        <set_value name="$TextTable.$missionname" exact="readtext.{$Page}.{$TextOffset + 1}" chance="if $TextTable.$missionname? then 0 else 100"/>

        <do_if value="not $TextTable.$description?">
          <do_if value="$TargetShip or $TargetStation">
            <substitute_text text="$TextTable.$description" source="readtext.{$Page}.{$TextOffset + 2}">
              <replace string="'$PERCENT$'"     with="{30140,1} + $ScanPercentage + '%'"/>
            </substitute_text>
          </do_if>
          <do_elseif value="$TargetModule">
            <!-- Special handling for text offsets 30100, 30200 and 30300 which have their mission description and objective text line IDs switched in the TextDB. -->
            <substitute_text text="$TextTable.$description" source="if [30100, 30200, 30300].indexof.{$TextOffset} then readtext.{$Page}.{$TextOffset + 3} else readtext.{$Page}.{$TextOffset + 2}">
              <replace string="'$MODULE$'"          with="$TargetModule.name"/>
              <replace string="'$TARGETSPACE$'"     with="@$TargetSpace.name"/>
            </substitute_text>
          </do_elseif>
          <do_elseif value="$TargetWare">
            <substitute_text text="$TextTable.$description" source="readtext.{$Page}.{$TextOffset + 2}">
              <replace string="'$WARE$'"            with="'\n'+$TargetWare.name"/>
              <replace string="'$TARGETSPACE$'"     with="@$TargetSpace.name"/>
            </substitute_text>
          </do_elseif>
          <do_elseif value="$TargetItem">
            <substitute_text text="$TextTable.$description" source="readtext.{$Page}.{$TextOffset + 2}">
              <replace string="'$ITEM$'"            with="'\n'+$TargetItem.name"/>
              <replace string="'$TARGETSPACE$'"     with="@$TargetSpace.name"/>
            </substitute_text>
          </do_elseif>
          <do_elseif value="$TargetPersonName">
            <substitute_text text="$TextTable.$description" source="readtext.{$Page}.{$TextOffset + 2}">
              <replace string="'$PERSONNAME$'"      with="'\n'+$TargetPersonName"/>
              <replace string="'$TARGETSPACE$'"     with="@$TargetSpace.name"/>
            </substitute_text>
          </do_elseif>
          <do_elseif value="$TargetIDCode">
            <substitute_text text="$TextTable.$description" source="readtext.{$Page}.{$TextOffset + 2}">
              <replace string="'$IDCODE$'"          with="$TargetIDCode"/>
              <replace string="'$TARGETSPACE$'"     with="@$TargetSpace.name"/>
            </substitute_text>
          </do_elseif>
          <do_else>
            <set_value name="$TextTable.$description" exact="readtext.{$Page}.{$TextOffset + 2}"/>
          </do_else>
        </do_if>

        <do_if value="$TargetShip.exists or $TargetStation.exists or $TargetSpace.exists" comment="some scan variations might be completely independent of a sector/location">
          <run_actions ref="md.LIB_Generic.GenerateTextTable_BriefingWarning_Call" result="$TextTable.$description">
            <param name="BriefingText" value="$TextTable.$description"/>
            <param name="TargetSpace" value="if $TargetShip.exists then $TargetShip.sector else if $TargetStation.exists then $TargetStation.sector else if $TargetSpace.exists then $TargetSpace else null"/>
          </run_actions>
        </do_if>

        <do_if value="not $TextTable.$objective?">
          <do_if value="$TargetWare">
            <substitute_text text="$TextTable.$objective" source="readtext.{$Page}.{$TextOffset + 3}">
              <replace string="'$WARE$'"     with="$TargetWare.name"/>
            </substitute_text>
          </do_if>
          <do_elseif value="$TargetItem">
            <substitute_text text="$TextTable.$objective" source="readtext.{$Page}.{$TextOffset + 3}">
              <replace string="'$ITEM$'"     with="$TargetItem.name"/>
            </substitute_text>
          </do_elseif>
          <do_elseif value="$TargetPersonName">
            <substitute_text text="$TextTable.$objective" source="readtext.{$Page}.{$TextOffset + 3}">
              <replace string="'$PERSONNAME$'" with="$TargetPersonName"/>
            </substitute_text>
          </do_elseif>
          <do_elseif value="$TargetIDCode">
            <substitute_text text="$TextTable.$objective" source="readtext.{$Page}.{$TextOffset + 3}">
              <replace string="'$IDCODE$'"    with="$TargetIDCode"/>
            </substitute_text>
          </do_elseif>
          <do_else>
            <!-- Special handling for text offsets 30100, 30200 and 30300 which have their mission description and objective text line IDs switched in the TextDB. -->
            <set_value name="$TextTable.$objective"   exact="if [30100, 30200, 30300].indexof.{$TextOffset} then readtext.{$Page}.{$TextOffset + 2} else readtext.{$Page}.{$TextOffset + 3}"/>
          </do_else>
        </do_if>

      </actions>
    </library>

    <library name="GenerateVoiceTable">
      <actions>
        <run_actions ref="md.LIB_Generic.GenerateGenericVoiceTable" result="$VoiceTable">
          <param name="VoiceTable" value="$VoiceTable"/>
        </run_actions>
      </actions>
    </library>

    <library name="Start" version="3">
      <params>
        <!-- required parameters -->
        <param name="OfferObject"             default="null" comment="The object on which this mission is based e.g. A Ship / Station / Signal Leak. Only needed for missions with a physical location."/>
        <param name="Client"                  default="null" comment="Pre-existing client"/>
        <param name="ClientOwner"             default="null" comment="Overriding owner for reward calculation or creation of $Client if not provided. Defaults to $OfferObject owner if able"/>
        <param name="MissionCue"              default="null" comment="Cue the mission is attached to. Defaults to Start (this)."/>
        <param name="MissionThread"           default="null" comment="Mission thread for the offer and mission"/>
        <param name="GenerateReward"          default="true" comment="If RewardCr or RewardNotoriety are invalid, generate them?"/>
        <param name="RewardCr"                default="null" comment="If the reward for this mission is credits, the number of credits should be set to this variable." />
        <param name="RewardObj"               default="null" comment="If the reward for this mission is not credits, and is an object, it should be set to this variable." />
        <param name="RewardNotoriety"         default="null"/>
        <param name="RewardText"              default="null"  comment="Any text needed to define the reward for this mission - may be used in conjunction with $RewardCr and $RewardObj." />
        <param name="MissionDuration"         default="null"/>
        <param name="MissionType"             default="missiontype.intelligence" comment="Variations can override mission type if required"/>
        <param name="MissionLevel"/>
        <param name="Difficulty"/>

        <!--Offer location and conversation-->
        <param name="WithoutOffer"            default="false" comment="Do not create a mission offer. Either run immediatly or wait for WithoutOfferWaitCue"/>
        <param name="WithoutOfferWaitCue"     default="null" comment="Do not create a mission offer but wait for this cue to be completed before running the mission"/>
        <param name="DeclineButton"           default="true" comment="Have a decline button instead of a back button in the offer conversation"/>
        <param name="EventOffer"              default="false" comment="Is the mission offered directly to the player with an interactive event"/>
        <param name="ConversationOffer"       default="false" comment="When $EventOffer is false, should this offer be through a conversation with the $Client. Otherwise, offer at mission location"/>
        <param name="ConversationTriggerCue"  default="null" comment="If provided, when this cue is signalled, start the mission offer conversation."/>
        <param name="OfferMaxDistance"        default="null"/>
        <param name="HideFromBBS"             default="false" comment="Hide this offer from the BBS? Show only through locations or special conversation handling."/>
        <param name="RemoveOnSectorChange"    default="true"/>
        <param name="OfferDistance"           default="50km" comment="Distance to the offer location before it becomes visible on the map or BBS (unless otherwise hidden)"/>

        <!--BBS only params-->
        <param name="BBSObject"     default="null"/>
        <param name="BBSDistance"   default="null"/>
        <param name="BBSTimeoutMin" default="null"/>
        <param name="BBSTimeoutMax" default="null"/>
        <param name="BBSSpace" default="null"/>

        <!--Mission text-->
        <param name="Page"          comment="Allows a different text page to be used instead of the generic one. Text IDs must be mapped similarly."/>
        <param name="TextOffset"    comment="The text offset for this variant's text on the page. Each variant starts at a different offset, but the entries[] within that offset have to match for all variants."/>
        <param name="TextTable"     default="table[]" comment="Table, usually populated by the mission, to store the texts by an identifier key e.g. $missionname = 'Kill Bala Gi' Check library 'GenerateTextTable' for identifier keys. Pass in a table with such an entry to override the text usually generated from the $Page and $TextOffset"/>
        <param name="VoiceTable"    default="table[]" comment="Table, usually populated by the mission, keys can have a value of 0 (=stay silent)"/>
        
        <!--Mission specific params-->
        <param name="TargetShip"        default="null"  comment="Specific ship to deep-scan'"/>
        <param name="TargetStation"     default="null"  comment="Station to scan for 'knowledge'"/>
        <param name="TargetModule"      default="null"  comment="Module to scan for blueprint"/>
        <!--TODO @Owen need more target parameters e.g. only finding a ware only in Xenon ships-->
        <param name="TargetWare"        default="null"  comment="Deep-scan ships to find specied ware"/>
        <param name="TargetItem"        default="null"  comment="Deep-scan ships to find specified item"/>
        <param name="TargetPersonName"  default="null"  comment="Deep-scan ships to find specified person"/>
        <param name="TargetSpace"       default="null"  comment="Target has to be in a specified space"/>
        <param name="TargetIDCode"      default="null"  comment="Fly close to ship with specified id-code (which can be followed up with a deep-scan the ship you found)"/>
        <param name="ScanType"          default="null"  comment="0=proximity-scan, 1=explicit scan/deep-scan (combines with the above TargetXxx)"/>
        <param name="ScanPercentage"    default="null"  comment="For ship/station scanning: percentage to which we need to scan"/>
        <param name="ScanShip"          default="null"  comment="Ship target (only relevant for the $TargetPersonName and $TargetIDCode-case)"/>
        <param name="EnemyFaction"      default="null" comment="The faction to which enemies belong if they spawn."/>

        <param name="ReportSignalCue" default="null" comment="Cue to be signalled when something happens which could be of interest to the calling cue. Saves values to ReportSignalCue.$FeedbackValue and ReportSignalCue.$EndFeedbackValue"/>
        <param name="CancelOfferCue"  default="null" comment="Cue which when completed will force this missions offer to be removed and cleaned up. No effect if mission has been accepted."/>
        <param name="ForceCleanup"    default="null" comment="Cue to force a cleanup from outside when completed"/>
        <param name="DebugChance"     default="0"/>
      </params>
      <actions>
        <!--Feedback value setup-->
        <set_value name="$Feedback" exact="null"/>
        <set_value name="$FeedbackManager" exact="md.GM_Scan.FeedbackValueManager"/>

        <assert value="$WithoutOffer or not $MissionCue or (not $MissionCue.hasmission and not $MissionCue.hasmissionoffer)"
                text="'Mission is set to create an offer but provided MissionCue: ' + $MissionCue + ' already has an offer or is a running mission [Owen]'"/>

        <!--Param validation-->
        <do_if value="not $WithoutOffer">
          <!--Optional variables (at least one should exist): $OfferObject, (bool)$HideFromBBS, (bool)$ConversationOffer, (bool)$EventOffer
          Result variables:
          $OfferType = 'signalleak' OR 'objectbased' OR 'eventoffer' OR 'conversationoffer'
          $AllowOfferEvent = Will an event offering this event be also fired immediatly?-->
          <include_actions ref="md.GenericMissions.GetOfferType"/>
          <do_if value="not $OfferType">
            <set_value name="$Feedback" exact="'$INVALID_OFFER_TYPE'"/>
          </do_if>
        </do_if>

        <do_if value="not $Feedback">
          <do_if value="not $TextOffset">
            <set_value name="$Feedback" exact="'$NO_TEXT_OFFSET'"/>
          </do_if>
          <do_else>
            <do_if value="$Client">
              <set_value name="$PreexistingClient"/>
            </do_if>
            <do_if value="not $ClientOwner">
              <set_value name="$ClientOwner" exact="if $Client then $Client.owner else @$OfferObject.owner"/>
              <assert value="$ClientOwner" text="'No valid $ClientOwner [Owen]'"/>
            </do_if>

            <do_if value="not $ClientOwner">
              <set_value name="$Feedback" exact="'$NO_VALID_CLIENT_OWNER'"/>
            </do_if>
            <do_else>
              <!--Mission specific param checks-->
              <!--do_if value="not $PlotLocation.isclass.space">
              <set_value name="$Feedback" exact="'$INVALID_PLOTLOCATION_PARAM'"/>
            </do_if>
            <do_elseif value="$PlotSize lt 100m">
              <set_value name="$Feedback" exact="'$INVALID_PLOTSIZE_PARAM'"/>
            </do_elseif-->
            </do_else>
          </do_else>

          <do_if value="($ScanType == 1) or ($ScanType == 0 and $TargetStation)">
            <set_value name="$ScanObjective" exact="objective.scan" comment="player explicitely triggering the scanner on the target"/>
          </do_if>
          <do_else>
            <set_value name="$ScanObjective" exact="objective.find" comment="auto-proximity 'scanner' to discover info"/>
          </do_else>
        </do_if>

        <assert value="($TargetSpace and not $TargetShip and not $TargetStation) or not $TargetSpace" text="'TargetSpace does not support TargetShip and/or TargetStation entries, all compete for RML_FlyTo.'"/>
      </actions>
      <patch sinceversion="1">
        <set_value name="$TargetSpace" exact="null"/>
      </patch>
      <patch sinceversion="2">
        <set_value name="$VoiceTable" exact="table[]"/>
      </patch>
      <patch sinceversion="3">
        <run_actions ref="md.LIB_Generic.GenerateGenericVoiceTable" result="$VoiceTable">
          <param name="VoiceTable" value="$VoiceTable"/>
        </run_actions>
      </patch>
      <cues>
        <cue name="Do_Not_Start_Mission" onfail="cancel">
          <conditions>
            <check_value value="$Feedback"/>
          </conditions>
          <actions>
            <signal_cue cue="CleanUp"/>
          </actions>
        </cue>

        <cue name="Do_Start_Mission" onfail="cancel">
          <conditions>
            <check_value value="not $Feedback"/>
          </conditions>
          <actions>
            <do_if value="not $MissionCue">
              <set_value name="$MissionCue" exact="Start"/>
            </do_if>

            <do_if value="not $PreexistingClient?">
              <!-- No pre-existing client, create a temporary client for this mission -->
              <!-- This auto-assigns a 'matching' text-page using the metadata (id=0) specified in the text-files. Speak commands for this actor will then refer to the selected text-page-->
              <!-- Possibly we'll need to add additional filters (in case some topics aren't supported by all generic text-pages) -->
              <create_cue_actor cue="Start" name="$Client" comment="temporary cue-actor will be cleaned up in the Cleanup-cue, see destroy_object on $Client">
                <select faction="$ClientOwner" tags="tag.crew"/>
                <owner exact="$ClientOwner"/>
              </create_cue_actor>
            </do_if>

            <!-- Determine the reward (credits/object/notoriety) -->
            <do_if value="$GenerateReward">
              <include_actions ref="md.LIB_Reward_Balancing.Allocate_RewardWeight" comment="input: $Difficulty, $ClientOwner; output: $RewardCreditsWeight, $RewardModWeight, $RewardSeminarWeight"/>
              <do_if value="not $RewardCr" weight="$RewardCreditsWeight">
                <signal_cue_instantly cue="md.LIB_Reward_Balancing.Reward_Money" param="[Start, $Difficulty, $MissionLevel, $ClientOwner]"/>
                <include_actions ref="md.LIB_Reward_Balancing.Apply_RewardMultiplier" comment="signal leak and mission thread bonus"/>
                <set_value name="$RewardCr" exact="$Reward_Money__Result_Multiplied"/>
              </do_if>
              <do_if value="not $RewardObj">
                <run_actions ref="md.LIB_Reward_Balancing.DetermineAdditionalReward" result="$AdditionalReward">
                  <param name="RewardModWeight" value="$RewardModWeight"/>
                  <param name="RewardSeminarWeight" value="$RewardSeminarWeight"/>
                </run_actions>
                <do_if value="$AdditionalReward != null">
                  <set_value name="$RewardObj" exact="$AdditionalReward"/>
                  <set_value name="$RewardText" exact="$RewardObj.name"/>
                </do_if>
              </do_if>

              <do_if value="not $RewardNotoriety">
                <signal_cue_instantly cue="md.LIB_Reward_Balancing.Reward_Notoriety" param="[Start, $Difficulty, $MissionLevel, $ClientOwner]"/>
                <set_value name="$RewardNotoriety" exact="$Reward_Notoriety__Result"/>
              </do_if>
            </do_if>

            <include_actions ref="GenerateTextTable"/>
            <include_actions ref="GenerateVoiceTable"/>

            <do_if value="$ReportSignalCue">
              <!--Signal the $ReportSignalCue that the mission has been successfully generated-->
              <set_value name="$FeedbackData" exact="$FeedbackManager.$FeedbackValues.$MISSION_GENERATED.clone"/>
              <set_value name="$FeedbackData.$ID" exact="'$MISSION_GENERATED'"/>
              <set_value name="$ReportSignalCue.$FeedbackValue" exact="$FeedbackData.clone" comment="Mission variation generated successfully"/>
              <signal_cue_instantly cue="$ReportSignalCue" param="table[$Name = $TextTable.$missionname, $Cue = $MissionCue, $Reward = $RewardCr, $RewardText = $RewardText]"/>
            </do_if>
          </actions>
          <cues>

            <!--***MISSION OFFER***-->
            <cue name="With_Offer" onfail="cancel">
              <conditions>
                <check_value value="$WithoutOffer" exact="false"/>
              </conditions>
              <cues>
                <!--Cue which creates the offer, when signalled. To be signalled from the GenericMissions.OfferMission library, referenced below-->
                <cue name="CreateOffer" instantiate="true" comment="instanced to prevent cleanup">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="not @$OfferCreated"/>
                  </conditions>
                  <actions>
                    <do_if value="not @$OfferCreated">
                      <!-- Briefing details -->
                      <create_offer cue="$MissionCue" location="$OfferObject" distance="$OfferDistance" name="$TextTable.$missionname" description="$TextTable.$description" difficulty="$Difficulty" actor="$Client"
                                  faction="$ClientOwner" opposingfaction="$EnemyFaction" type="$MissionType" reward="$RewardCr" rewardtext="$RewardText" duration="$MissionDuration" hidden="$HideFromBBS" space="$BBSSpace">
                        <briefing>
                          <!--TODO @Owen @Roger more suitable action?-->
                          <objective step="1" action="$ScanObjective" text="$TextTable.$objective"/>
                        </briefing>
                      </create_offer>
                      <!-- Offers might be outside the $OfferDistance (default 50km) and not seen by players but still count up -->
                      <run_actions ref="md.GenericMissions.UpdateTextOffsetsTable">
                        <param name="StaticGMCue" value="md.GM_Scan.GenerateGenericMission"/>
                        <param name="Page"        value="$Page"/>
                        <param name="TextOffset"  value="$TextOffset"/>
                      </run_actions>
                    </do_if>
                    <set_value name="$OfferCreated" exact="true"/>
                  </actions>
                </cue>

                <!--The majority of the offer logic is within this library. The parameters we pass down below, specify in which way this mission is going to be offered to the player (i.e. BBS, Signal-Leak, ...)
                Some of the mission specific handling is still contained in this file but triggered via the library via a signal e.g. setting up the briefing details via the 'CreateOffer' cue above.-->
                <cue name="Offer_Management" ref="md.GenericMissions.OfferMission">
                  <param name="OfferType"     value="$OfferType"/>
                  <param name="OfferCue"      value="$MissionCue"/>
                  <param name="CleanupCue"    value="Offer_End"/>
                  <param name="BriefingSetupCue" value="CreateOffer"/>
                  <param name="MissionName"   value="$TextTable.$missionname"/>
                  <param name="CancelOfferCue" value="$CancelOfferCue"/>

                  <!--Object based params (offered by Station/Ship/Signal-leak)-->
                  <param name="TimeoutMin"  value="8min" comment="Minimum time the offer remains valid"/>
                  <param name="TimeoutMax"  value="12min"/>
                  <param name="MaxDistance" value="$OfferMaxDistance"/>
                  <param name="RemoveOnSectorChange" value="$RemoveOnSectorChange"/>

                  <!--Object and Signal Leak based params-->
                  <param name="OfferObject" value="$OfferObject"/>

                  <!--BBS based offers-->
                  <param name="BBSObject"     value="@$BBSObject"/>
                  <param name="BBSDistance"   value="@$BBSDistance"/>
                  <param name="BBSTimeoutMin" value="@$BBSTimeoutMin"/>
                  <param name="BBSTimeoutMax" value="@$BBSTimeoutMax"/>

                  <!--Conversation event offers-->
                  <param name="AllowOfferEvent" value="$AllowOfferEvent"/>
                  <param name="ConversationTriggerCue" value="$ConversationTriggerCue"/>

                  <!--Client-->
                  <param name="Client"                 value="$Client"/>
                  <param name="VoiceTable"             value="$VoiceTable"/>

                  <param name="DebugChance" value="$DebugChance"/>
                </cue>

                <!--Cue signalled when the offer library is finished-->
                <cue name="Offer_End">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="this.$Feedback.$ID == '$accepted_offer'">
                      <signal_cue cue="MissionAccepted"/>
                    </do_if>
                    <do_elseif value="this.$Feedback.$ID == '$DECLINED_OFFER'">
                      <set_value name="$Feedback" exact="'$DECLINED_OFFER'"/>
                      <signal_cue cue="CleanUp" />
                    </do_elseif>
                    <do_elseif value="this.$Feedback.$ID == '$OFFER_REMOVED'">
                      <set_value name="$Feedback" exact="'$OFFER_REMOVED'"/>
                      <signal_cue cue="CleanUp" />
                    </do_elseif>
                    <do_elseif value="this.$Feedback.$ID == '$SIGNAL_LEAK_REMOVED'">
                      <set_value name="$Feedback" exact="'$SIGNAL_LEAK_REMOVED'"/>
                      <signal_cue cue="CleanUp" />
                    </do_elseif>
                    <do_elseif value="this.$Feedback.$ID == '$EVENT_OFFER_TIMEOUT'">
                      <set_value name="$Feedback" exact="'$EVENT_OFFER_TIMEOUT'"/>
                      <signal_cue cue="CleanUp" />
                    </do_elseif>
                  </actions>
                </cue>
              </cues>
            </cue>

            <!--These cues handle the cases where a mission is automatically accepted on creation-->
            <cue name="Without_Offer" onfail="cancel">
              <conditions>
                <check_value value="$WithoutOffer"/>
                <check_value value="not $WithoutOfferWaitCue"/>
              </conditions>
              <actions>
                <signal_cue cue="MissionAccepted" />
              </actions>
            </cue>

            <cue name="Without_Offer_Wait_Cue" onfail="cancel">
              <conditions>
                <check_value value="$WithoutOffer"/>
                <check_value value="$WithoutOfferWaitCue"/>
              </conditions>
              <cues>
                <cue name="Without_Offer_Wait_Cue_Completed">
                  <conditions>
                    <check_any>
                      <event_cue_completed cue="$WithoutOfferWaitCue"/>
                      <check_all>
                        <event_cue_signalled cue="$WithoutOfferWaitCue"/>
                        <check_value value="event.param == $MissionCue"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="MissionAccepted" />
                  </actions>
                </cue>
              </cues>
            </cue>

            <!--These cues handle the briefing presentations e.g. Holomap or cutscene render targets (depending on the mission)-->
            <cue name="BriefingStarted">
              <conditions>
                <check_any>
                  <event_briefing_started cue="$MissionCue"/>
                  <event_briefing_submission_selected cue="$MissionCue"/>
                </check_any>
              </conditions>
              <actions>
                <set_value name="$RenderTarget" exact="event.param.{1}"/>
                <set_value name="$StartBriefingCutscene"/>
                <set_value name="$stationindex" exact="1"/>
                <debug_text text="'Briefing started'" chance="$DebugChance"/>
              </actions>
              <cues>
                <cue name="DisplayCutscene" onfail="cancel">
                  <conditions>
                    <check_value value="$StartBriefingCutscene?"/>
                  </conditions>
                  <actions>

                    <do_if value="$TargetShip">
                      <set_value name="$CutsceneObject" exact="$TargetShip" />
                    </do_if>
                    <do_elseif value="$TargetStation">
                      <set_value name="$CutsceneObject" exact="$TargetStation" />
                    </do_elseif>
                    <do_elseif value="$ScanShip">
                      <set_value name="$CutsceneObject" exact="$ScanShip" />
                    </do_elseif>
                    <do_else>
                      <set_value name="$CutsceneObject" exact="player.container" />
                    </do_else>

                    <do_if value="@$CutsceneObject">
                      <set_value name="$BriefingCutsceneStarted"/>
                      <set_value name="$CutsceneKey" exact="'OrbitIndefinitely'"/>
                      <play_cutscene key="$CutsceneKey" rendertarget="$RenderTarget">
                        <param name="targetobject" object="$CutsceneObject"/>
                      </play_cutscene>
                    </do_if>
                  </actions>
                </cue>

                <cue name="BriefingStopped">
                  <conditions>
                    <check_any>
                      <event_briefing_cancelled cue="$MissionCue"/>
                      <event_briefing_submission_unselected cue="$MissionCue"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="$BriefingCutsceneStarted?">
                      <!--Temp value. This is used to identify if a cutscene for this mission is still playing.-->
                      <remove_value name="$BriefingCutsceneStarted"/>
                      <stop_cutscene key="$CutsceneKey"/>
                    </do_if>

                    <do_if value="$HoloMap?">
                      <remove_holomap />
                      <remove_value name="$HoloMap"/>
                    </do_if>

                    <debug_text text="'Briefing canceled'" chance="$DebugChance"/>
                    <reset_cue cue="BriefingStarted"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="TargetDestroyedPrematurely" instantiate="true">
              <conditions>
                <check_any>
                  <event_object_destroyed object="$TargetShip" check="false"/>
                  <event_object_destroyed object="$TargetStation" check="false"/>
                  <event_object_destroyed object="$ScanShip" check="false"/>
                </check_any>
              </conditions>
              <actions>
                <do_if value="MissionAccepted.state == cuestate.complete">
                  <signal_cue_instantly cue="md.GenericMissions.GenericFailLogbookEntry" param="[$TextTable.$missionname, $Client, {30004,6027}]"/>
                </do_if>
                <set_value name="$Feedback" exact="'$TARGET_KILLED_EARLY'"/>
                <signal_cue cue="CleanUp"/>
              </actions>
            </cue>
            
            <cue name="FactionRelations_ChangedPrematurely">
              <conditions>
                <event_faction_relation_changed faction="$ClientOwner" otherfaction="$EnemyFaction"/>
                <check_value value="$ClientOwner != faction.criminal and $ClientOwner != faction.civilian
                                and $EnemyFaction != faction.criminal and $EnemyFaction != faction.civilian"/>
                <check_value value="not $ClientOwner.hasrelation.enemy.{$EnemyFaction}"/>
              </conditions>
              <actions>
                <do_if value="MissionAccepted.state == cuestate.complete">
                  <signal_cue_instantly cue="md.GenericMissions.GenericFailLogbookEntry" param="[$TextTable.$missionname, $Client, {30004,6052}]"/>
                </do_if>
                <set_value name="$Feedback" exact="'$FACTION_RELATIONS_CHANGED'"/>
                <signal_cue cue="CleanUp"/>
              </actions>
            </cue>

            <!--This cue creates the mission itself, either from scratch or via an existing mission offer-->
            <cue name="MissionAccepted">
              <conditions>
                <event_cue_signalled />
              </conditions>
              <actions>
                <debug_text text="'Mission accepted!'" chance="$DebugChance"/>
                <set_value name="stat.missions_accepted" operation="add"/>

                <do_if value="$WithoutOffer">
                  <!--$MissionCue may already be a mission cue passed in as a parameter-->
                  <do_if value="not $MissionCue.hasmission">
                    <do_if value="$MissionThread">
                      <create_mission cue="$MissionCue" missionthread="$MissionThread" name="$TextTable.$missionname" description="$TextTable.$description" difficulty="$Difficulty" faction="$ClientOwner" opposingfaction="$EnemyFaction" type="$MissionType" reward="$RewardCr" rewardtext="$RewardText"/>
                    </do_if>
                    <do_else>
                      <create_mission cue="$MissionCue" name="$TextTable.$missionname" description="$TextTable.$description" difficulty="$Difficulty" faction="$ClientOwner" opposingfaction="$EnemyFaction" type="$MissionType" reward="$RewardCr" rewardtext="$RewardText"/>
                    </do_else>
                  </do_if>

                  <update_mission cue="$MissionCue">
                    <briefing>
                      <objective step="1" action="$ScanObjective" text="$TextTable.$objective"/>
                    </briefing>
                  </update_mission>
                </do_if>
                <do_else>
                  <!--Copy data from the offer, then remove it-->
                  <do_if value="$MissionThread">
                    <create_mission cue="$MissionCue" offercue="$MissionCue" missionthread="$MissionThread"/>
                  </do_if>
                  <do_else>
                    <create_mission cue="$MissionCue" offercue="$MissionCue"/>
                  </do_else>
                  <remove_offer cue="$MissionCue"/>
                  <cancel_cue cue="With_Offer"/>
                </do_else>

                <do_if value="$ReportSignalCue">
                  <set_value name="$FeedbackData" exact="$FeedbackManager.$FeedbackValues.$MISSION_ACCEPTED.clone"/>
                  <set_value name="$FeedbackData.$ID" exact="'$MISSION_ACCEPTED'"/>
                  <set_value name="$ReportSignalCue.$FeedbackValue" exact="$FeedbackData.clone" comment="Mission accepted"/>
                  <signal_cue_instantly cue="$ReportSignalCue"/>
                </do_if>

                <signal_cue_instantly cue="md.GenericMissions.GenericAcceptLogbookEntry" param="[$TextTable.$missionname, $Client, $ClientOwner]"/>
              </actions>
              <cues>
                <cue name="ActivateImmediately" onfail="cancel">
                  <conditions>
                    <check_value value="not $MissionThread"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="ActivateMission"/>
                  </actions>
                </cue>

                <cue name="ActivateOnCondition" onfail="cancel">
                  <conditions>
                    <check_value value="$MissionThread"/>
                  </conditions>
                  <actions>
                    <do_if value="$MissionThread.canactivatesubmission.{$MissionCue}">
                      <signal_cue cue="ActivateMission"/>
                      <cancel_cue cue="ActivateOnCondition"/>
                    </do_if>
                  </actions>
                  <cues>
                    <!--TODO @Owen add an event for when a submission has been removed from the thread-->
                    <cue name="CheckMissionThreadState" checkinterval="1s">
                      <conditions>
                        <check_value value="$MissionThread.canactivatesubmission.{$MissionCue}"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="ActivateMission"/>
                        <cancel_cue cue="ActivateOnCondition"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="ActivateMission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="TargetDestroyedPrematurely"/>
                    <cancel_cue cue="FactionRelations_ChangedPrematurely"/>
                    <set_value name="$StartStep" exact="1"/>
                    <do_if value="$MissionDuration">
                      <update_mission cue="$MissionCue" endtime="player.age + $MissionDuration"/>
                    </do_if>
                  </actions>
                  <cues>

                    <cue name="ActivateMission_SpecificTarget" onfail="cancel" version="2">
                      <conditions>
                        <check_any>
                          <check_value value="$TargetShip"/>
                          <check_value value="$TargetStation"/>
                          <check_value value="$TargetSpace"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="$TargetShip">
                          <set_value name="$FlyToTarget" exact="$TargetShip"/>
                        </do_if>
                        <do_elseif value="$TargetStation">
                          <set_value name="$FlyToTarget" exact="$TargetStation"/>
                        </do_elseif>
                        <do_elseif value="$TargetSpace">
                          <set_value name="$FlyToTarget" exact="$TargetSpace"/>
                        </do_elseif>
                      </actions>
                      <patch sinceversion="2">
                        <set_value name="FlyTo_Ref.$LeftTargetSignalCue" exact="LeftLocation"/>
                        <reset_cue cue="ReachedLocation"/>
                        <reset_cue cue="FlyTo_Ref"/>
                      </patch>
                      <cues>
                        <cue name="FlyTo_Ref" ref="md.RML_FlyTo.FlyTo">
                          <param name="MissionCue" value="$MissionCue" />
                          <param name="StartStep" value="$StartStep" comment="Briefing step to start the mission on"/>
                          <param name="Target" value="$FlyToTarget" />
                          <param name="Distance" value="15km" comment="trigger when near target"/>
                          <param name="EndOnCompletion" value="false" />
                          <param name="ReachedTargetSignalCue" value="ReachedLocation" />
                          <param name="LeftTargetSignalCue" value="LeftLocation" />
                          <param name="DebugChance" value="$DebugChance" />
                        </cue>
                      </cues>
                    </cue>

                    <cue name="ActivateMission_NoSpecificTarget" onfail="cancel">
                      <conditions>
                        <check_value value="not $TargetShip and not $TargetStation and not $TargetSpace"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="ReachedLocation"/>
                      </actions>
                    </cue>

                    <cue name="Aborted_V2">
                      <conditions>
                        <event_mission_aborted cue="$MissionCue"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="md.GenericMissions.GenericAbortLogbookEntry" param="[$TextTable.$missionname, $Client]"/>

                        <set_value name="$Feedback" exact="'$MISSION_ABORTED'"/>
                        <remove_mission cue="$MissionCue" type="aborted"/>
                        <signal_cue cue="CleanUp" />
                      </actions>
                    </cue>
                    <cue name="LeftLocation" instantiate="true">
                       <conditions>
                        <event_cue_signalled />
                      </conditions>
                      <actions>
                        <reset_cue cue="ReachedLocation"/>
                      </actions>
                    </cue>

                    <cue name="ReachedLocation" instantiate="true">
                      <conditions>
                        <event_cue_signalled />
                      </conditions>
                      <actions>
                        <do_if value="$TargetShip or $TargetStation">
                          <set_value name="$StartStep" exact="2"/>
                        </do_if>
                      </actions>
                      <cues>
                        <!-- Trigger the RML, which will check the win/lose conditions and report back -->
                        <cue name="Scan_Ref" ref="md.RML_Scan.Scan">
                          <!-- always pass these -->
                          <param name="EndSignalCue"      value="MissionEnded"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="StartStep"         value="$StartStep" comment="Briefing step to start the mission on"/>
                          <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                          <param name="DebugChance"       value="$DebugChance"/>
                          <param name="ObjectiveText"     value="$TextTable.$objective"/>
                          <param name="ScanObjective"     value="$ScanObjective"/>
                          <!-- mission-related parameters -->
                          <param name="TargetShip"        value="$TargetShip"/>
                          <param name="TargetStation"     value="$TargetStation"/>
                          <param name="TargetModule"      value="$TargetModule"/>
                          <param name="TargetWare"        value="$TargetWare"/>
                          <param name="TargetItem"        value="$TargetItem"/>
                          <param name="TargetPersonName"  value="$TargetPersonName"/>
                          <param name="TargetSpace"       value="$TargetSpace"/>
                          <param name="TargetIDCode"      value="$TargetIDCode"/>
                          <param name="ScanType"          value="$ScanType"/>
                          <param name="ScanPercentage"    value="$ScanPercentage"/>
                          <param name="ScanShip"          value="$ScanShip"/>
                          <param name="EnemyFaction"      value="$EnemyFaction"/>
                        </cue>

                        <cue name="MissionTimeout" onfail="cancel">
                          <conditions>
                            <check_value value="typeof $MissionDuration == datatype.time"/>
                            <check_value value="$MissionDuration" min="1s"/>
                          </conditions>
                          <delay exact="$MissionDuration"/>
                          <actions>
                            <signal_cue_instantly cue="md.GenericMissions.GenericTimeoutLogbookEntry" param="[$TextTable.$missionname, $Client]"/>

                            <remove_mission cue="$MissionCue" type="failed"/>
                            <set_value name="$Feedback" exact="'$MISSION_TIMEOUT'"/>
                            <signal_cue_instantly cue="CleanUp" />
                          </actions>
                        </cue>

                        <cue name="OneTime_FactionRelationCheck" onfail="cancel">
                          <conditions>
                            <check_value value="$ClientOwner != faction.criminal and $ClientOwner != faction.civilian
                                            and $EnemyFaction != faction.criminal and $EnemyFaction != faction.civilian"/>
                            <check_value value="not $ClientOwner.hasrelation.enemy.{$EnemyFaction}"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="FactionRelations_Changed"/>
                          </actions>
                        </cue>

                        <cue name="FactionRelations_Changed">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <check_all>
                                <event_faction_relation_changed faction="$ClientOwner" otherfaction="$EnemyFaction"/>
                                <check_value value="$ClientOwner != faction.criminal and $ClientOwner != faction.civilian
                                                and $EnemyFaction != faction.criminal and $EnemyFaction != faction.civilian"/>
                                <check_value value="not $ClientOwner.hasrelation.enemy.{$EnemyFaction}"/>
                              </check_all>
                            </check_any>
                          </conditions>
                          <actions>
                            <set_value name="$Feedback" exact="'$FACTION_RELATIONS_CHANGED'"/>
                            <set_value name="MissionEnded.$EndFeedbackValue" exact="-2"/>
                            <set_value name="MissionEnded.$EndFeedbackText" exact="{30004,6052}"/>
                            <signal_cue cue="MissionEnded"/>
                          </actions>
                        </cue>

                        <cue name="MissionEnded">
                          <!-- Handle the end-feedback (usually originating from the RML used above) -->
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- Failure case -->
                            <do_if value="MissionEnded.$EndFeedbackValue" max="0">
                              <debug_text text="'This mission has failed. RML Feedback: ' + MissionEnded.$EndFeedbackValue" chance="$DebugChance"/>
                              <set_value name="$Feedback" exact="'$RML_FAILED'"/>
                              <speak actor="$Client" line="$VoiceTable.$MissionFailed" comment="(failed mission)" chance="if $VoiceTable.$MissionFailed == 0 then 0 else 100" />
                              <signal_cue_instantly cue="md.GenericMissions.GenericFailLogbookEntry" param="[$TextTable.$missionname, $Client, @MissionEnded.$EndFeedbackText]"/>

                              <remove_mission cue="$MissionCue" type="failed" reason="@MissionEnded.$EndFeedbackText"/>
                            </do_if>

                            <!-- Success case -->
                            <do_else>
                              <!--TODO: Partial success-->
                              <debug_text text="'This mission has ended. RML Feedback: ' + MissionEnded.$EndFeedbackValue" chance="$DebugChance"/>
                              <do_if value="$RewardNotoriety and $ClientOwner">
                                <debug_text text="'Relation was: ' + player.entity.relationto.{$ClientOwner}" chance="$DebugChance"/>
                                <add_faction_relation faction="faction.player" otherfaction="$ClientOwner" value="$RewardNotoriety" reason="relationchangereason.missioncompleted" />
                                <debug_text text="'Relation is now: ' + player.entity.relationto.{$ClientOwner}" chance="$DebugChance"/>
                              </do_if>

                              <do_if value="$RewardCr">
                                <reward_player money="$RewardCr" />
                              </do_if>
                              <do_if value="$RewardObj">
                                <do_if value="$RewardObj.isinventory">
                                  <add_inventory entity="player.entity" ware="$RewardObj" />
                                  <show_notification text="[{1015,100}, '', $RewardText]" sound="notification_achievement" comment="Item received" />
                                </do_if>
                              </do_if>
                              <set_value name="stat.missions_completed" operation="add"/>
                              <set_value name="$Feedback" exact="'$MISSION_SUCCEEDED'"/>
                              <speak actor="$Client" line="$VoiceTable.$MissionSuccess" comment="(successful mission)" chance="if $VoiceTable.$MissionSuccess == 0 then 0 else 100" />
                              <signal_cue_instantly cue="md.GenericMissions.GenericCompleteLogbookEntry" param="[$TextTable.$missionname, $Client, null, $RewardCr]"/>

                              <run_actions ref="md.GenericMissions.UpdateTextOffsetsTable_completedcounter">
                                <param name="StaticGMCue" value="md.GM_Scan.GenerateGenericMission"/>
                                <param name="Page"        value="$Page"/>
                                <param name="TextOffset"  value="$TextOffset"/>
                              </run_actions>

                              <remove_mission cue="$MissionCue" type="completed" activate="next" />
                            </do_else>
                            <signal_cue cue="CleanUp" />
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="ForceCleanup" onfail="cancel">
          <conditions>
            <check_value value="$ForceCleanup"/>
          </conditions>
          <actions>
            <do_if value="not $ForceCleanup.exists">
              <set_value name="$Feedback" exact="'$INVALID_FORCE_CLEANUP'"/>
              <signal_cue_instantly cue="CleanUp"/>
            </do_if>
          </actions>
          <cues>
            <cue name="ForceCleanup_Wait">
              <conditions>
                <check_any>
                  <event_cue_completed cue="$ForceCleanup"/>
                  <check_all>
                    <event_cue_signalled cue="$ForceCleanup"/>
                    <check_value value="event.param == $MissionCue"/>
                  </check_all>
                </check_any>
              </conditions>
              <actions>
                <set_value name="$Feedback" exact="'$FORCED_CLEANUP'"/>
                <signal_cue_instantly cue="CleanUp"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="CleanUp">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!--Temp value. This is used to identify if a cutscene for this mission is still playing.-->
            <do_if value="$BriefingCutsceneStarted?">
              <remove_value name="$BriefingCutsceneStarted"/>
              <stop_cutscene key="$CutsceneKey"/>
            </do_if>
            <do_if value="$HoloMap?">
              <remove_holomap />
              <remove_value name="$HoloMap"/>
            </do_if>


            <!--***Cleanup objects***-->

            <!--No .exists check here as $Client may not be connected to gamegraph-->
            <do_if value="$Client.isclass.npc and (not $PreexistingClient?)">
              <destroy_object object="$Client" comment="cleanup the client we created with create_cue_actor"/>
            </do_if>

            <!--***Evaluate result***-->

            <do_if value="$DebugChance or $ReportSignalCue">
              <set_value name="$FeedbackData" exact="$FeedbackManager.$FeedbackValues.{$Feedback}.clone"/>
              <do_if value="$FeedbackData">
                <set_value name="$FeedbackData.$ID" exact="$Feedback"/>
                <debug_text text="'Mission ended with reason: ' + $FeedbackData.$type + ' - ' + $FeedbackData.$text" chance="$DebugChance"/>
              </do_if>
              <do_else>
                <set_value name="$FeedbackData" exact="table[$ID = 'error_unknown', $type = 'error', $text = 'This is an unknown error']" comment="feedback = id, type and error-text from the above FeedbackValues-table"/>
                <assert value="false" text="'Mission ended with unknown case: ' + $Feedback + ' [Owen]'" break="1"/>
              </do_else>

              <do_if value="$ReportSignalCue" comment ="The cue which called us">
                <set_value name="$ReportSignalCue.$EndFeedbackValue" exact="$FeedbackData" comment="return feedback-data to calling cue"/>
                <signal_cue cue="$ReportSignalCue"/>
              </do_if>
            </do_if>

            <cancel_cue cue="Start"/>
          </actions>
        </cue>
      </cues>
    </library>

    <!-- MISSION SETUP HELPERS -->
    <!--TODO @Owen the source object probably shouldn't be player.entity but a parameter object-->

    <!-- Input: $EnemyFaction, output: $TargetShip, $ScanPercentage, $ScanType, ($Difficulty) -->
    <library name="Scan__High_Security_Enemy_Ship">
      <actions>
        <debug_text text="'Scan__High_Security_Enemy_Ship'" chance="$DebugChance"/>
        <find_cluster_in_range name="$LocalClusters" object="player.entity" maxdistance="2" multiple="true"/>
        <shuffle_list list="$LocalClusters"/>
        <do_all exact="$LocalClusters.count" counter="$cluster_i">
          <find_ship name="$TargetShip" primarypurpose="purpose.fight" space="$LocalClusters.{$cluster_i}" owner="$EnemyFaction" unit="false" multiple="false">
            <match shiptype="shiptype.lasertower" negate="true"/>
            <match_secrecy_level exact="2"/>
            <match_revealed_percentage max="50"/>
          </find_ship>
          <do_if value="$TargetShip">
            <set_value name="$ScanPercentage" exact="[97,98,99].random"/>
            <set_value name="$ScanType" exact="[0,1].random" comment="proximity-scan or deep-scan"/>
            <break/>
          </do_if>
        </do_all>

        <do_if value="not @$TargetShip" chance="$DebugChance">
          <debug_text text="'No matching '+ $EnemyFaction + '-ship found'"/>
        </do_if>
        <do_elseif value="$EnemyFaction.hasrelation.killmilitary.{faction.player}">
          <set_value name="$Difficulty" exact="level.medium"/>
        </do_elseif>
      </actions>
    </library>

    <!-- Input: $EnemyFaction, output: $TargetStation, $ScanPercentage, $ScanType, ($Difficulty and $MissionLevel) -->
    <library name="Scan__High_Security_Enemy_Station">
      <actions>
        <debug_text text="'Scan__High_Security_Enemy_Station'" chance="$DebugChance"/>
        <find_cluster_in_range name="$LocalClusters" object="player.entity" maxdistance="2" multiple="true"/>
        <shuffle_list list="$LocalClusters"/>
        <do_all exact="$LocalClusters.count" counter="$cluster_i">
          <find_station_by_true_owner name="$TargetStation" space="$LocalClusters.{$cluster_i}" faction="$EnemyFaction" multiple="false">
            <match_child class="class.module" checkoperational="true">
              <match_secrecy_level exact="3"/>
            </match_child>
            <match_revealed_percentage max="5"/>
          </find_station_by_true_owner>
          <do_if value="$TargetStation">
            <set_value name="$ScanPercentage" exact="[24,25,26].random"/>
            <set_value name="$ScanType" exact="0"/>
            <break/>
          </do_if>
        </do_all>

        <do_if value="not @$TargetStation" chance="$DebugChance">
          <debug_text text="'No matching ' + $EnemyFaction + '-station found'"/>
        </do_if>
        <do_elseif value="$EnemyFaction.hasrelation.killmilitary.{faction.player}">
          <set_value name="$Difficulty" exact="level.medium"/>
          <set_value name="$MissionLevel" exact="3" operation="add" comment="Scanning a station to 25% takes longer than scanning a single module or ship."/>
        </do_elseif>
      </actions>
    </library>

    <!-- input: $EnemyFaction, output: $TargetModuleStation, $TargetModule, $ScanType, ($Difficulty and $MissionLevel) -->
    <library name="Scan__High_Security_Enemy_Module">
      <actions>
        <debug_text text="'Scan__High_Security_Enemy_Module'" chance="$DebugChance"/>
        <find_cluster_in_range name="$LocalClusters" object="player.entity" maxdistance="2" multiple="true"/>
        <shuffle_list list="$LocalClusters"/>
        <do_all exact="$LocalClusters.count" counter="$cluster_i">
          <find_station_by_true_owner name="$TargetModuleStation" space="$LocalClusters.{$cluster_i}" faction="$EnemyFaction" multiple="false">
            <match_child class="class.module" checkoperational="true">
              <match_secrecy_level exact="3"/>
              <match_revealed_percentage max="5"/>
            </match_child>
          </find_station_by_true_owner>
          <do_if value="$TargetModuleStation">
            <find_object_component name="$TargetModule" object="$TargetModuleStation" class="class.module">
              <match_secrecy_level exact="3"/>
              <match_revealed_percentage max="5"/>
            </find_object_component>
            <do_if value="$TargetModule">
              <set_value name="$ScanType" exact="0"/>
            </do_if>
            <break/>
          </do_if>
        </do_all>
        <do_if value="($EnemyFaction.hasrelation.killmilitary.{faction.player}) and $TargetModule">
          <set_value name="$Difficulty" exact="level.medium"/>
          <do_if value="$EnemyFaction == faction.xenon">
            <set_value name="$MissionLevel" exact="3" operation="add" comment="Scanning anything on a Xenon station deserves an extra reward."/>
          </do_if>
        </do_if>
      </actions>
    </library>

    <!-- input: -, output: $ScanShip, $TargetPersonName, $Difficulty, $ScanType -->
    <!--Owen: Not sure if this variant is worth doing tbh.-->
    <!--Roger: Might be more interesting with some special setup (criminal trying to escape sector, player needing to 'guard the exitgate') -->
    <library name="Scan__Random_NPC">
      <actions>
        <debug_text text="'Scan__Random_NPC'" chance="$DebugChance"/>
        <find_cluster_in_range name="$LocalClusters" object="player.entity" maxdistance="2" multiple="true"/>
        <shuffle_list list="$LocalClusters"/>
        <do_all exact="$LocalClusters.count" counter="$cluster_i">
          <find_ship name="$ScanShip" class="class.ship_xl" space="$LocalClusters.{$cluster_i}" multiple="false">
            <!-- owner="faction.xenon"  -->
            <match_content class="class.npc"/>
            <match owner="faction.player" negate="true" comment="nonplayer-ship"/>
          </find_ship>
          <do_if value="$ScanShip">
            <find_object_component name="$TargetPerson" class="class.npc" object="$ScanShip" multiple="false"/>
            <do_if value="$TargetPerson">
              <set_value name="$TargetPersonName" exact="$TargetPerson.name"/>
              <set_value name="$ScanType" exact="1"/>
              <do_if value="$ScanShip.trueowner.hasrelation.killmilitary.{faction.player}">
                <set_value name="$Difficulty" exact="level.medium"/>
              </do_if>
              <do_else>
                <set_value name="$Difficulty" exact="level.veryeasy"/>
              </do_else>
            </do_if>
            <break/>
          </do_if>
        </do_all>
      </actions>
    </library>

    <!-- input: $EnemyFaction, output: $ScanShip, $TargetIDCode, $ScanType, ($Difficulty) -->
    <!--Owen: Not sure if this variant is worth doing tbh.-->
    <!--Roger: Might be more interesting with some special setup (criminal trying to escape sector, player needing to 'guard the exitgate') -->
    <library name="Scan__Enemy_Ship_ID_Code">
      <actions>
        <debug_text text="'Scan__Enemy_Ship_ID_Code'" chance="$DebugChance"/>
        <find_cluster_in_range name="$LocalClusters" object="player.entity" maxdistance="2" multiple="true"/>
        <shuffle_list list="$LocalClusters"/>
        <do_all exact="$LocalClusters.count" counter="$cluster_i">
          <find_ship name="$ScanShip" class="class.ship_l" space="$LocalClusters.{$cluster_i}" owner="$EnemyFaction" multiple="false"/>
          <do_if value="$ScanShip">
            <break/>
          </do_if>
        </do_all>
        <do_if value="not $ScanShip">
          <find_ship name="$ScanShip" class="class.ship_xl" space="player.galaxy" owner="$EnemyFaction" multiple="false" reachablefrom="player.zone"/>
        </do_if>

        <do_if value="$ScanShip">
          <set_value name="$TargetIDCode" exact="$ScanShip.idcode"/>
          <set_value name="$ScanType" exact="[1].random" comment="proximity-scan or deep-scan"/>
        </do_if>

        <do_if value="$EnemyFaction.hasrelation.killmilitary.{faction.player}">
          <set_value name="$Difficulty" exact="level.medium"/>
        </do_if>
      </actions>
    </library>


    <!--GENERIC MISSION VARIANTS-->

    <cue name="Force_Generic_Var_1" instantiate="true">
      <conditions>
        <event_cue_signalled />
      </conditions>
      <actions>
        <signal_cue cue="md.GenericMissions.RemoveAllOffers" />
        <do_all exact="30">
          <signal_cue_instantly cue="GenerateGenericMission" param="table[$Sector = player.sector, $MissionVariant = 1, $DebugChance = 100]"/>
        </do_all>
      </actions>
      <force name="GM_Scan_Var_1" />
    </cue>

    <!--event.param = table[
    $Sector,
    $ReportSignalCue (Optional. Cue to be signalled when something happens which could be of interest to the calling cue. Saves values to ReportSignalCue.$FeedbackValue and ReportSignalCue.$EndFeedbackValue)
    $MissionVariant (Optional),
    $RemoveOnSectorChange (Optional, defaults to true)
    $DebugChance (Optional)]-->
    <cue name="GenerateGenericMission" instantiate="true" namespace="this" version="2">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$Sector"           exact="event.param.$Sector"/>
        <set_value name="$ReportSignalCue"  exact="@event.param.$ReportSignalCue"/>
        <set_value name="$MissionVariant"   exact="@event.param.$MissionVariant"/>
        <do_if value="event.param.$RemoveOnSectorChange?">
          <set_value name="$RemoveOnSectorChange" exact="event.param.$RemoveOnSectorChange"/>
        </do_if>
        <do_else>
          <set_value name="$RemoveOnSectorChange" exact="true"/>
        </do_else>

        <set_value name="$DebugChance"      exact="@event.param.$DebugChance"/>
        <set_value name="$ReportSignalCue.$GM_Wrapper" exact="this"/>

        <set_value name="$FeedbackManager" exact="FeedbackValueManager"/>
        <assert value="$FeedbackManager.$FeedbackValues.$MISSION_NO_VARIANT?" text="'Required error code does not exist. Was the FeedbackValueManager not updated for stand-alone missions? [Owen/Roger]'"/>

        <debug_text text="'Attempting to generate a generic mission'" chance="$DebugChance"/>
      </actions>
      <patch sinceversion="2" state="complete">
        <do_if value="$ReportSignalCue.exists">
          <set_value name="$ReportSignalCue.$GM_Wrapper" exact="this"/>
        </do_if>
        <do_else>
          <debug_text text="'cancelling dead GM instance'" filter="savegame"/>
          <cancel_cue cue="this"/>
        </do_else>
      </patch>
      <cues>
        <cue name="GenerateGenericMission_SelectVariant">
          <actions>
            <set_value name="$ValidVariants" exact="[]"/>
            <!--Set up some common variables first so that the variants don't have to do things multiple times-->

            <!--Find potential offer stations in the sector-->
            <find_station name="$PotentialOfferStations" excluded="md.GenericMissions.Manager.$ExcludedOfferObjects" space="$Sector" multiple="true">
              <match owner="md.GenericMissions.Manager.$DefaultExcludedOfferFactions" negate="true"/>
              <match_relation_to object="player.entity" comparison="not" relation="killmilitary" />
            </find_station>

            <do_if value="$PotentialOfferStations.count">
              <do_if value="$MissionVariant">
                <!--A specific MissionVariant ID was requested-->
                <debug_text text="'Checking if requested ' + $MissionVariant + ' can be spawned'" chance="$DebugChance"/>
                <do_if value="$MissionVariant == 1">
                  <signal_cue_instantly cue="GenerateGenericMission_Variant_1"/>
                </do_if>
                <do_else>
                  <assert value="false" text="'Unknown $MissionVariant ID ' + $MissionVariant + ' [Owen]'"/>
                </do_else>
              </do_if>
              <do_else>
                <!--Attempt to a mission variant at random-->

                <signal_cue_instantly cue="GenerateGenericMission_Variant_1"/>
              </do_else>
            </do_if>

            <do_if value="$ValidVariants.count">
              <signal_cue cue="$ValidVariants.random"/>
            </do_if>
            <do_else>
              <do_if value="$ReportSignalCue">
                <set_value name="$FeedbackData" exact="$FeedbackManager.$FeedbackValues.$MISSION_NO_VARIANT.clone"/>
                <set_value name="$FeedbackData.$ID" exact="'$MISSION_NO_VARIANT'"/>
                <set_value name="$ReportSignalCue.$FeedbackValue" exact="$FeedbackData.clone" comment="No mission variant possible"/>
                <signal_cue_instantly cue="$ReportSignalCue"/>
              </do_if>
              <cancel_cue cue="GenerateGenericMission"/>
            </do_else>
          </actions>
        </cue>

        <cue name="GenerateGenericMission_Variant_1" namespace="this">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!--this uses its own namespace so grab the shared data from GenerateGenericMission-->
            <set_value name="$Sector" exact="GenerateGenericMission.$Sector"/>
            <set_value name="$DebugChance" exact="GenerateGenericMission.$DebugChance"/>
            <set_value name="$OfferStations" exact="GenerateGenericMission.$PotentialOfferStations.clone"/>
            <set_value name="$Valid" exact="false"/>
            <set_value name="$Station" exact="$OfferStations.random"/>
            <set_value name="$Sector" exact="player.sector"/>
            <set_value name="$MissionLevel" exact="1"/>
            <set_value name="$Difficulty" exact="level.veryeasy" comment="May be overwritten by the Scan_Xxx setup cues"/>
            <set_value name="$TargetShip" exact="null"/>
            <set_value name="$TargetStation" exact="null"/>
            <set_value name="$TargetModule" exact="null"/>
            <set_value name="$TargetWare" exact="null"/>
            <set_value name="$TargetItem" exact="null"/>
            <set_value name="$TargetPerson" exact="null"/>
            <set_value name="$TargetPersonName" exact="null"/>
            <set_value name="$TargetSpace" exact="null"/>
            <set_value name="$TargetIDCode" exact="null"/>
            <set_value name="$ScanPercentage" exact="null"/>
            <set_value name="$ScanShip" exact="null"/>
            <set_value name="$Faction" exact="$Station.owner"/>
            <run_actions ref="md.LIB_Generic.DetermineEnemyFaction" result="$EnemyFaction">
              <param name="Faction" value="$Faction"/>
            </run_actions>
            <debug_text text="'$Faction[%s] EnemyFaction[%s]'.[$Faction,  $EnemyFaction]" chance="$DebugChance"/>

            <set_value name="$ValidOffsets" exact="[]"/>
            <!-- GM_Scan1 (specified ship) -->
            <append_list_elements name="$ValidOffsets" other="[10000, 10100, 10300]"/>
            <do_if value="$EnemyFaction != faction.xenon" comment="Text mentions a competitor, so not Xenon.">
              <append_list_elements name="$ValidOffsets" other="[10200]"/>
            </do_if>
            <do_if value="md.$SplitFactions.indexof.{$Faction}">
              <append_list_elements name="$ValidOffsets" other="[10400]" comment="scan Split rivals/enemies"/>
            </do_if>
            <do_if value="md.$TerranEarthFactions.indexof.{$Faction}">
              <append_list_elements name="$ValidOffsets" other="[10500]" comment="scan Split rivals/enemies"/>
            </do_if>
            <!-- GM_Scan2 (specified station) -->
            <append_list_elements name="$ValidOffsets" other="[20100, 20300]" comment="scan some station / safety inspection of own station"/>
            <do_if value="$EnemyFaction != faction.xenon">
              <append_list_elements name="$ValidOffsets" other="[20000]" comment="Text mentions a competitor who steals customers, so not Xenon."/>
            </do_if>
            <do_if value="md.$SplitPatriarchyFactions.indexof.{$Faction}">
              <append_list_elements name="$ValidOffsets" other="[20400]" comment="scan Split rivals/enemies"/>
            </do_if>
            <do_if value="md.$SplitFactions.indexof.{$Faction}">
              <append_list_elements name="$ValidOffsets" other="[20500]" comment="scan Split rivals/enemies"/>
            </do_if>
            <do_if value="md.$TerranEarthFactions.indexof.{$Faction}">
              <append_list_elements name="$ValidOffsets" other="[20600]" comment="scan station, terran variant"/>
            </do_if>
            <do_if value="not md.$TerranEarthFactions.indexof.{$Faction}">
              <append_list_elements name="$ValidOffsets" other="[20100, 20200]" comment="scan some station"/>
            </do_if>
            <!-- GM_Scan3 (specified module) -->
            <do_if value="$EnemyFaction != faction.xenon">
              <append_list_elements name="$ValidOffsets" other="[30000, 30100, 30200]" comment="Text mentions companies and organisations, so not Xenon."/>
            </do_if>
            <!-- GM_Scan4 (deepscan ships for specified ware) -->
            <append_list_elements name="$ValidOffsets" other="[40100]" comment="global scan allowed"/>

            <find_ship name="$ShipWithWare_Ore" space="$Station.sector" multiple="false">
              <match_any_cargo wares="ware.ore"/>
            </find_ship>
            <find_ship name="$ShipWithWare_Silicon" space="$Station.sector" multiple="false">
              <match_any_cargo wares="ware.silicon"/>
            </find_ship>
            <find_ship name="$ShipWithWare_Water" space="$Station.sector" multiple="false">
              <match_any_cargo wares="ware.water"/>
            </find_ship>
            <do_if value="$ShipWithWare_Ore.exists">
              <append_list_elements name="$ValidOffsets" other="[40200]" comment="global scan allowed"/>
            </do_if>
            <do_if value="$ShipWithWare_Silicon.exists and ($EnemyFaction != faction.xenon)">
              <append_list_elements name="$ValidOffsets" other="[40300]" comment="global scan allowed"/>
            </do_if>
            <do_if value="$ShipWithWare_Water.exists and (not md.$TerranFactions.indexof.{$Faction})">
              <append_list_elements name="$ValidOffsets" other="[40400]" comment="global scan allowed"/>
            </do_if>
            

            <!-- SelectMissionVariant library (weighted choice and $lastoffertime tracking) -->
            <run_actions ref="md.GenericMissions.SelectMissionVariant" result="$TextOffset_Table">
              <param name="StaticGMCue"    value="md.GM_Scan.GenerateGenericMission"/>
              <param name="ValidOffsets"   value="table[{30140} = $ValidOffsets]"/>
            </run_actions>
            <remove_value name="$ValidOffsets" comment="prevent accidental usage to select a different offset"/>
            <set_value name="$Page"         exact="$TextOffset_Table.keys.last"/>
            <set_value name="$TextOffset"   exact="$TextOffset_Table.{$Page}"/>

            <!-- GM_Scan1 (specified ship) -->
            <do_if value="[10000, 10100, 10200, 10300, 10400, 10500].indexof.{$TextOffset}">
              <include_actions ref="Scan__High_Security_Enemy_Ship"/>
              <set_value name="$MissionLevel" exact="3" operation="add" comment="Ship has probably already flown away, takes a bit to catch up."/>
            </do_if>
            <!-- GM_Scan2 (specified station) -->
            <do_elseif value="[20000, 20100].indexof.{$TextOffset}">
              <include_actions ref="Scan__High_Security_Enemy_Station"/>
            </do_elseif>
            <do_elseif value="[20400, 20500].indexof.{$TextOffset}">
              <include_actions ref="Scan__High_Security_Enemy_Station" comment="Input: $EnemyFaction, output: $TargetStation, $ScanPercentage, $ScanType"/>
            </do_elseif>
            <do_elseif value="[20600].indexof.{$TextOffset}">
              <!-- override the default $EnemyFaction which was set by DetermineEnemyFaction, for some specific cases -->
              <do_any>
                <set_value name="$EnemyFaction" exact="[faction.argon, faction.antigone].random"/>
                <set_value name="$EnemyFaction" exact="md.$TerranOtherFactions.random"/>
              </do_any>
              <include_actions ref="Scan__High_Security_Enemy_Station" comment="Input: $EnemyFaction, output: $TargetStation, $ScanPercentage, $ScanType"/>
            </do_elseif>
            <do_elseif value="[20100, 20200].indexof.{$TextOffset}">
              <set_value name="$FactionAgainst" exact="table[
                    { faction.teladi      } = [ faction.ministry],
                    { faction.ministry    } = [ faction.teladi],
                    { faction.paranid     } = [ faction.holyorder],
                    { faction.holyorder   } = [ faction.paranid],
                    ]" comment="Focus on specific faction in the above cases"/>
              <do_if value="$FactionAgainst.{$Faction}?">
                <set_value name="$EnemyFaction" exact="$FactionAgainst.{$Faction}.random"/>
              </do_if>
              <include_actions ref="Scan__High_Security_Enemy_Station" comment="Input: $EnemyFaction, output: $TargetStation, $ScanPercentage, $ScanType"/>
            </do_elseif>
            <do_elseif value="[20300].indexof.{$TextOffset}" comment="safety inspection of own station">
              <set_value name="$EnemyFaction" exact="$Faction"/>
              <include_actions ref="Scan__High_Security_Enemy_Station"/>
              <set_value name="$EnemyFaction" exact="null"/>
            </do_elseif>
            <!-- GM_Scan3 (specified module) -->
            <do_elseif value="[30000, 30100, 30200].indexof.{$TextOffset}">
              <include_actions ref="Scan__High_Security_Enemy_Module"/>
            </do_elseif>
            <!-- GM_Scan4 (deepscan ships for specified ware) -->
            <do_elseif value="[40100].indexof.{$TextOffset}">
              <!-- we assume that in the entire universe there is at least 1 ship with energycells -->
              <set_value name="$TargetWare" exact="ware.energycells"/>
              <set_value name="$ScanType" exact="1"/>
              <set_value name="$EnemyFaction" exact="null" comment="ANY faction"/>
              <set_value name="$MissionLevel" exact="7" operation="add" comment="Player has to find a suitable ship first."/>
            </do_elseif>
            <!-- See if anything matches, if so the ship might fly away, but at least it's plausible that over time another ship matching the requirements will be available again -->
            <do_elseif value="[40200].indexof.{$TextOffset}">
              <set_value name="$TargetWare" exact="ware.ore"/>
              <set_value name="$ScanType" exact="1"/>
              <set_value name="$EnemyFaction" exact="null" comment="ANY faction"/>
              <set_value name="$TargetSpace" exact="$Station.sector"/>
              <set_value name="$MissionLevel" exact="7" operation="add" comment="Player has to find a suitable ship first."/>
            </do_elseif>
            <do_elseif value="[40300].indexof.{$TextOffset}">
              <set_value name="$TargetWare" exact="ware.silicon"/>
              <set_value name="$ScanType" exact="1"/>
              <set_value name="$EnemyFaction" exact="null" comment="ANY faction"/>
              <set_value name="$TargetSpace" exact="$Station.sector"/>
              <set_value name="$MissionLevel" exact="7" operation="add" comment="Player has to find a suitable ship first."/>
            </do_elseif>
            <do_elseif value="[40400].indexof.{$TextOffset}">
              <set_value name="$TargetWare" exact="ware.water"/>
              <set_value name="$ScanType" exact="1"/>
              <set_value name="$EnemyFaction" exact="null" comment="ANY faction"/>
              <set_value name="$TargetSpace" exact="$Station.sector"/>
              <set_value name="$MissionLevel" exact="7" operation="add" comment="Player has to find a suitable ship first."/>
            </do_elseif>

            <debug_text text="'TargetShip ' + $TargetShip + ', Targetstation ' + $TargetStation + ', TargetModule ' + $TargetModule + ', TargetPerson ' + $TargetStation + ', ScanShip ' + $TargetStation + ', TargetItem ' + $TargetItem + ', TargetWare ' + $TargetWare + ', TargetSpace.name ' + @$TargetSpace.name" chance="$DebugChance"/>
            <do_if value="$TargetShip or $TargetStation or $TargetModule or $TargetPerson or $ScanShip or $TargetItem or $TargetWare">
              <set_value name="$Valid" exact="true"/>

              <do_if value="not $TargetWare">
                <run_actions ref="md.LIB_Generic.SectorDifficultyBalance" result="$Difficulty">
                  <param name="MissionTargetSector" value="if $TargetShip then $TargetShip.sector else if $TargetStation then $TargetStation.sector else if $TargetModule then $TargetModule.sector else if $TargetPerson then $TargetPerson.sector else if $ScanShip then $ScanShip.sector else if $TargetItem then $TargetItem.sector"/>
                  <param name="Difficulty" value="$Difficulty"/>
                </run_actions>
              </do_if>
            </do_if>

            <do_if value="$Valid">
              <append_to_list name="GenerateGenericMission.$ValidVariants" exact="this"/>
            </do_if>
            <do_else>
              <cancel_cue cue="this"/>
            </do_else>
          </actions>
          <cues>
            <cue name="GenerateGenericMission_Variant_1_Trigger">
              <conditions>
                <event_cue_signalled cue="parent"/>
              </conditions>
              <cues>
                <cue name="GenerateGenericMission_Variant_1_Ref" ref="Start">
                  <param name="OfferObject"   value="$Station"/>
                  <param name="MissionLevel"  value="$MissionLevel"/>
                  <param name="Difficulty"    value="$Difficulty"/>
                  <!--param name="Faction"       value="$Faction"/-->

                  <!--Mission offer-->
                  <param name="RemoveOnSectorChange" value="@GenerateGenericMission.$RemoveOnSectorChange"/>
                  <!--param name="BBSSpace" value="$Sector"/-->

                  <!--Mission text-->
                  <param name="Page"          value="$Page"/>
                  <param name="TextOffset"    value="$TextOffset"/>

                  <!-- see GenerateGenericMission_Variant_1_PostInit -->
                  <param name="TargetShip"        value="$TargetShip"/>
                  <param name="TargetStation"     value="$TargetStation"/>
                  <param name="TargetModule"      value="$TargetModule"/>
                  <param name="TargetWare"        value="$TargetWare"/>
                  <param name="TargetItem"        value="$TargetItem"/>
                  <param name="TargetPersonName"  value="$TargetPersonName"/>
                  <param name="TargetSpace"       value="$TargetSpace"/>
                  <param name="TargetIDCode"      value="$TargetIDCode"/>
                  <param name="ScanType"          value="$ScanType"/>
                  <param name="ScanPercentage"    value="$ScanPercentage"/>
                  <param name="ScanShip"          value="$ScanShip"/>
                  <param name="EnemyFaction"      value="$EnemyFaction"/>

                  <param name="ReportSignalCue"   value="@GenerateGenericMission.$ReportSignalCue"/>
                  <param name="DebugChance"       value="@GenerateGenericMission.$DebugChance"/>
                </cue>

              </cues>
            </cue>
          </cues>
        </cue>
      </cues>
    </cue>

    <!--event.param = table[
    $Location,
    $ReportSignalCue (Optional. Cue to be signalled when something happens which could be of interest to the calling cue. Saves values to ReportSignalCue.$FeedbackValue and ReportSignalCue.$EndFeedbackValue)
    $MissionVariant (Optional),
    $RemoveOnDespawn (Optional, defaults to true. Remove the mission when the object has changed to low attention and NPCs are usually cleaned up)
    $DebugChance (Optional)]-->
    <cue name="GenerateNPCMission" instantiate="true" namespace="this">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$Location"           exact="event.param.$Location"/>
        <set_value name="$ReportSignalCue"    exact="@event.param.$ReportSignalCue"/>
        <set_value name="$MissionVariant"     exact="@event.param.$MissionVariant"/>

        <do_if value="event.param.$RemoveOnDespawn?">
          <set_value name="$RemoveOnDespawn"  exact="event.param.$RemoveOnDespawn"/>
        </do_if>
        <do_else>
          <set_value name="$RemoveOnDespawn"  exact="true"/>
        </do_else>

        <set_value name="$DebugChance"        exact="@event.param.$DebugChance"/>
        <set_value name="$ReportSignalCue.$GM_Wrapper" exact="this"/>

        <signal_cue_instantly cue="md.GenericMissions.Validate_NPC_Mission_GM_Feedback_Table" param="FeedbackValueManager"/>

        <debug_text text="'Attempting to generate a generic NPC mission'" chance="$DebugChance"/>
      </actions>
      <cues>
        <cue name="GenerateNPCMission_SelectVariant">
          <actions>
            <set_value name="$ValidVariants" exact="[]"/>

            <!--Set up some common variables first so that the variants don't have to do things multiple times-->

            <set_value name="$LocationOwner" exact="$Location.owner"/>

            <do_if value="$MissionVariant">
              <!--A specific MissionVariant ID was requested-->
              <debug_text text="'Checking if requested ' + $MissionVariant + ' can be spawned'" chance="$DebugChance"/>
              <do_if value="$MissionVariant == 1">
                <signal_cue_instantly cue="GenerateNPCMission_Variant_1"/>
              </do_if>
              <do_else>
                <assert value="false" text="'Unknown $MissionVariant ID ' + $MissionVariant + ' [Owen]'"/>
              </do_else>
            </do_if>
            <do_else>
              <!--Attempt to a mission variant at random-->

              <signal_cue_instantly cue="GenerateNPCMission_Variant_1"/>
            </do_else>

            <do_if value="$ValidVariants.count">
              <signal_cue cue="$ValidVariants.random"/>
            </do_if>
            <do_else>
              <do_if value="$ReportSignalCue">
                <set_value name="$FeedbackData" exact="FeedbackValueManager.$FeedbackValues.$MISSION_NO_VARIANT.clone"/>
                <set_value name="$FeedbackData.$ID" exact="'$MISSION_NO_VARIANT'"/>
                <set_value name="$ReportSignalCue.$FeedbackValue" exact="$FeedbackData.clone" comment="No mission variant possible"/>
                <signal_cue_instantly cue="$ReportSignalCue"/>
              </do_if>
              <cancel_cue cue="GenerateNPCMission"/>
            </do_else>
          </actions>
        </cue>

        <cue name="GenerateNPCMission_Variant_1" namespace="this" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!--this uses its own namespace so grab the shared data from GenerateNPCMission-->
            <set_value name="$Location" exact="GenerateNPCMission.$Location"/>
            <set_value name="$DebugChance" exact="GenerateNPCMission.$DebugChance"/>

            <set_value name="$Difficulty" exact="level.veryeasy" comment="May be overwritten by the Scan_Xxx setup cues"/>
            <set_value name="$Station" exact="$Location"/>
            <set_value name="$Faction" exact="$Station.owner"/>
            <set_value name="$Cluster" exact="$Station.cluster"/>
            <set_value name="$Sector" exact="$Station.sector"/>

            <set_value name="$TargetShip" exact="null"/>
            <set_value name="$TargetStation" exact="null"/>
            <set_value name="$TargetModule" exact="null"/>
            <set_value name="$TargetWare" exact="null"/>
            <set_value name="$TargetItem" exact="null"/>
            <set_value name="$TargetPerson" exact="null"/>
            <set_value name="$TargetPersonName" exact="null"/>
            <set_value name="$TargetSpace" exact="null"/>
            <set_value name="$TargetIDCode" exact="null"/>
            <set_value name="$ScanPercentage" exact="null"/>
            <set_value name="$ScanShip" exact="null"/>
            <run_actions ref="md.LIB_Generic.DetermineEnemyFaction" result="$EnemyFaction">
              <param name="Faction" value="$Faction"/>
            </run_actions>


            <debug_text text="'Faction: ' + $Faction + ' EnemyFaction: ' + $EnemyFaction" chance="$DebugChance"/>
            <set_value name="$Valid" exact="false"/>
            <create_group groupname="$TargetObjects"/>

            <do_if value="(not $Location.isplayerowned) and ($EnemyFaction != null)">
              <!--TODO @Owen this is just a test variant-->

              <set_value name="$ValidOffsets" exact="[20000, 20100, 20300]"/>

              <!-- SelectMissionVariant library (weighted choice and $lastoffertime tracking) -->
              <run_actions ref="md.GenericMissions.SelectMissionVariant" result="$TextOffset_Table">
                <param name="StaticGMCue"    value="md.GM_Scan.GenerateGenericMission"/>
                <param name="ValidOffsets"   value="table[{30140} = $ValidOffsets]"/>
              </run_actions>
              <remove_value name="$ValidOffsets" comment="prevent accidental usage to select a different offset"/>
              <set_value name="$Page"         exact="$TextOffset_Table.keys.last"/>
              <set_value name="$TextOffset"   exact="$TextOffset_Table.{$Page}"/>

              <do_if value="$TextOffset == 20000">
                <include_actions ref="Scan__High_Security_Enemy_Station" comment="Input: $EnemyFaction, output: $TargetStation, $ScanPercentage, $ScanType"/>
              </do_if>
              <do_elseif value="$TextOffset == 20100" comment="scan some station">
                <include_actions ref="Scan__High_Security_Enemy_Station" comment="Input: $EnemyFaction, output: $TargetStation, $ScanPercentage, $ScanType"/>
              </do_elseif>
              <do_elseif value="$TextOffset == 20300" comment="safety inspection of own station">
                <set_value name="$EnemyFaction" exact="$Faction"/>
                <include_actions ref="Scan__High_Security_Enemy_Station" comment="Input: $EnemyFaction, output: $TargetStation, $ScanPercentage, $ScanType"/>
                <set_value name="$EnemyFaction" exact="null"/>
              </do_elseif>

            </do_if>

            <set_value name="$MissionLevel"   exact="10"/>

            <debug_text text="'TargetShip ' + $TargetShip + ', Targetstation ' + $TargetStation + ', TargetModule ' + $TargetModule + ', TargetPerson ' + $TargetStation + ', ScanShip ' + $TargetStation + ', TargetItem ' + $TargetItem + ', TargetWare ' + $TargetWare + ', TargetSpace.name ' + @$TargetSpace.name" chance="$DebugChance"/>
            <do_if value="$TargetShip or $TargetStation or $TargetModule or $TargetPerson or $ScanShip or $TargetItem or $TargetWare">
              <set_value name="$Valid" exact="true"/>

              <do_if value="not $TargetWare">
                <run_actions ref="md.LIB_Generic.SectorDifficultyBalance" result="$Difficulty">
                  <param name="MissionTargetSector" value="if $TargetShip then $TargetShip.sector else if $TargetStation then $TargetStation.sector else if $TargetModule then $TargetModule.sector else if $TargetPerson then $TargetPerson.sector else if $ScanShip then $ScanShip.sector else if $TargetItem then $TargetItem.sector"/>
                  <param name="Difficulty" value="$Difficulty"/>
                </run_actions>
              </do_if>
            </do_if>

            <do_if value="$Valid">
              <append_to_list name="GenerateNPCMission.$ValidVariants" exact="this"/>
            </do_if>
            <do_else>
              <cancel_cue cue="this"/>
            </do_else>
          </actions>
          <patches>
            <patch sinceversion="2">
              <do_if value="not $Client.exists">
                <debug_text text="'Client no longer exists. Aborting mission.'" filter="savegame"/>
                <set_value name="GenerateNPCMission.$ReportSignalCue.$EndFeedbackValue" exact="'CLIENT_KILLED'"/>
                <signal_cue_instantly cue="GenerateNPCMission.$ReportSignalCue"/>
              </do_if>
            </patch>
          </patches>
          <cues>
            <cue name="GenerateNPCMission_Variant_1_Selected">
              <conditions>
                <event_cue_signalled cue="parent"/>
              </conditions>
              <actions>
                <set_value name="$Client" exact="null"/>
                <set_value name="$SceneInstance" exact="null"/>
              </actions>
              <cues>
                <cue name="GenerateNPCMission_Variant_1_Select_Scene">
                  <actions>
                    <!--Attempt to create the NPC scene-->
                    <!--TODO @Owen selection of scene-->
                    <set_value name="$Scenes" exact="[md.NPC_Missions.Scene__Friendly_Client_Via_Comm_1]"/>
                    <shuffle_list list="$Scenes"/>

                    <do_all exact="$Scenes.count" counter="$i">
                      <do_if value="$Scenes.{$i} == md.NPC_Missions.Scene__Friendly_Client_Via_Comm_1">
                        <set_value name="$Scene_Definition" exact="table[
                                              $CallerCue = namespace,
                                              $Location = $Location,
                                              $Client = $Client,
                                              $ClientOwner = $Location.owner,
                                              $CallerEventCue = GenerateNPCMission_Variant_1_GM_Signal]"/>

                        <signal_cue_instantly cue="$Scenes.{$i}" param="$Scene_Definition"/>

                        <do_if value="@$Scene_Definition.$Result == 'SUCCESS'">
                          <set_value name="$SceneInstance" exact="$Scene_Definition.$SceneInstance"/>
                          <set_value name="$Client" exact="$Scene_Definition.$Client"/>
                          <set_entity_role entity="$Client" role="entityrole.service"/>
                          <set_entity_role_object entity="$Client" object="$Location"/>
                          <signal_cue cue="GenerateNPCMission_Variant_1_Trigger"/>
                          <break/>
                        </do_if>
                      </do_if>
                    </do_all>
                    <debug_text text="'Client is: ' + $Client + ' SceneInstance is: ' + $SceneInstance" chance="$DebugChance"/>
                    <do_if value="not $Client or not $SceneInstance">
                      <set_value name="$FeedbackData" exact="FeedbackValueManager.$FeedbackValues.$MISSION_NO_NPC_SCENE.clone"/>
                      <set_value name="$FeedbackData.$ID" exact="'$MISSION_NO_NPC_SCENE'"/>
                      <set_value name="GenerateNPCMission.$ReportSignalCue.$FeedbackValue" exact="$FeedbackData" comment="Can't set up NPC scene"/>
                      <signal_cue_instantly cue="GenerateNPCMission.$ReportSignalCue"/>
                      <cancel_cue cue="this"/>
                    </do_if>
                  </actions>
                  <cues>
                    <cue name="GenerateNPCMission_Variant_1_Scene_Ended">
                      <conditions>
                        <event_cue_cancelled cue="$SceneInstance"/>
                      </conditions>
                      <actions>
                        <do_if value="@$MissionAccepted">
                          <debug_text text="'Scene ended due to mission being accepted'" chance="$DebugChance"/>
                        </do_if>
                        <do_else>
                          <set_value name="$FeedbackData" exact="FeedbackValueManager.$FeedbackValues.$OFFER_REMOVED.clone"/>
                          <set_value name="$FeedbackData.$ID" exact="'$OFFER_REMOVED'"/>
                          <set_value name="GenerateNPCMission.$ReportSignalCue.$FeedbackValue" exact="$FeedbackData"/>
                          <signal_cue_instantly cue="GenerateNPCMission.$ReportSignalCue"/>
                        </do_else>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <!--Cue which the scene is listening to. There are several standard -->
                <!--This cue is to be signalled by the GM when certain events happen e.g. mission accepted / mission failed / error
                A feedback table is saved to either:
                static.$FeedbackValue
                or 
                static.$EndFeedbackValue (in the event that the GM will end)
                This cue will pass the feedback table onto the caller of the GM (GenerateNPCMission.$ReportSignalCue), so the GM can be managed
                The scene can also listen to this cue to react to certain events e.g. mission accepted-->
                <cue name="GenerateNPCMission_Variant_1_GM_Signal" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="@static.$EndFeedbackValue" comment="Evaluate return-value of GM (success/failure)">
                      <debug_text text="'Mission ended. feedback' + static.$EndFeedbackValue" chance="$DebugChance"/>

                      <do_if value="$Client.isclass.npc">
                        <do_if value="$Client.parent">
                          <!--Set entity to temporary so they are cleaned up-->
                          <set_entity_traits entity="$Client" temporary="true"/>
                          <set_value name="$Client.$MissionOfferState" exact="'ended'"/>
                          <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $Client, namespace]"/>
                        </do_if>
                        <do_else>
                          <destroy_object object="$Client"/>
                        </do_else>
                      </do_if>

                      <!--This will cause this instance to end-->
                      <set_value name="GenerateNPCMission.$ReportSignalCue.$EndFeedbackValue" exact="static.$EndFeedbackValue"/>
                      <signal_cue_instantly cue="GenerateNPCMission.$ReportSignalCue" param="@event.param"/>
                    </do_if>
                    <do_elseif value="@static.$FeedbackValue">
                      <debug_text text="'Mission signalled with feedback' + static.$FeedbackValue" chance="$DebugChance"/>
                      <set_value name="GenerateNPCMission.$ReportSignalCue.$FeedbackValue" exact="static.$FeedbackValue"/>
                      <signal_cue_instantly cue="GenerateNPCMission.$ReportSignalCue" param="@event.param"/>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="GenerateNPCMission_Variant_1_Trigger">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>

                    <set_value name="$SpokeToClient" exact="false"/>
                    <set_value name="$Client.$MissionOfferState" exact="'offering'"/>
                  </actions>
                  <cues>
                    <cue name="GenerateNPCMission_Variant_1_Ref" ref="Start">
                      <param name="Client"        value="$Client"/>
                      <param name="MissionLevel"  value="$MissionLevel"/>
                      <param name="Difficulty"    value="$Difficulty"/>


                      <!--Mission offer-->
                      <param name="ConversationOffer"       value="true"/>
                      <param name="ConversationTriggerCue"  value="GenerateNPCMission_Variant_1_Show_Briefing"/>
                      <param name="HideFromBBS"             value="true"/>
                      <param name="OfferDistance"           value="null"/>

                      <!--Mission text-->
                      <param name="Page"              value="$Page"/>
                      <param name="TextOffset"        value="$TextOffset"/>
                      <param name="TargetStation"     value="$TargetStation"/>
                      <param name="ScanType"          value="$ScanType"/>
                      <param name="ScanPercentage"    value="$ScanPercentage"/>
                      <param name="EnemyFaction"      value="$EnemyFaction"/>


                      <!--Mission specific params-->

                      <param name="ReportSignalCue"     value="GenerateNPCMission_Variant_1_GM_Signal"/>
                      <param name="DebugChance"         value="@GenerateNPCMission.$DebugChance"/>
                    </cue>

                    <cue name="GenerateNPCMission_Variant_1_Debug_Guidance" onfail="cancel">
                      <conditions>
                        <check_value value="$DebugChance == 100"/>
                      </conditions>
                      <actions>
                        <create_mission cue="this" name="'Guidance to mission'" description="'Helper guidance to mission NPC'" difficulty="level.trivial" faction="faction.player" type="missiontype.destroy">
                          <briefing>
                            <objective step="1" action="objective.talkto" object="$Client"/>
                          </briefing>
                          <objective step="1" action="objective.talkto" object="$Client"/>
                        </create_mission>
                      </actions>
                      <cues>
                        <cue name="GenerateNPCMission_Variant_1_Debug_Guidance_Abort">
                          <conditions>
                            <event_mission_aborted cue="parent"/>
                          </conditions>
                          <actions>
                            <remove_mission cue="parent"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <!--Conversation handlers-->
                    <cue name="GenerateNPCMission_Variant_1_Next_Section" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$Client" section="g_askformission"/>
                      </conditions>
                      <actions>
                        <set_conversation_return_section section="g_goodbye" />
                        <signal_cue_instantly cue="GenerateNPCMission_Variant_1_Show_Briefing"/>
                      </actions>
                    </cue>

                    <cue name="GenerateNPCMission_Variant_1_Show_Briefing" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Updating TextOffset Counter + $lastoffered, but repeatable (unreliable) -->
                        <run_actions ref="md.GenericMissions.UpdateTextOffsetsTable">
                          <param name="StaticGMCue" value="md.GM_Scan.GenerateGenericMission"/>
                          <param name="Page"        value="$Page"/>
                          <param name="TextOffset"  value="$TextOffset"/>
                        </run_actions>
                      </actions>
                    </cue>

                    <!--We need this cue here reacting to this event to set the blackboard variable as soon as possible-->
                    <cue name="GenerateNPCMission_Variant_1_Mission_Accepted">
                      <conditions>
                        <event_object_signalled object="$Client" param="'accept'" />
                      </conditions>
                      <actions>
                        <set_value name="$Client.$MissionOfferState" exact="'accepted'"/>
                      </actions>
                    </cue>

                    <!--This cue will trigger slightly later than the one setting the $Client.$MissionOfferState blackboard variable to 'accepted'-->
                    <cue name="GenerateNPCMission_Variant_1_Mission_Accepted_2">
                      <conditions>
                        <event_cue_signalled cue="GenerateNPCMission_Variant_1_GM_Signal"/>
                        <check_value value="@GenerateNPCMission_Variant_1_GM_Signal.$FeedbackValue.$ID == '$MISSION_ACCEPTED'"/>
                      </conditions>
                      <actions>
                        <assert value="$Client.$MissionOfferState == 'accepted'" text="'The mission offer state of the client is not - accepted -. State: ' + $Client.$MissionOfferState"/>
                        <set_value name="$MissionAccepted" exact="true"/>
                        <!--Set actor to not-temporary so that it will not automatically be destroyed in low attention-->
                        <set_entity_traits entity="$Client" missionactor="true" temporary="false"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>
      </cues>
    </cue>

  </cues>
</mdscript>
