<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Story_Yaki" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="Start" namespace="this" mapeditor="false" version="7">
      <conditions>
        <check_any>
          <event_cue_signalled/>
          <check_all>
            <event_cue_signalled cue="md.Setup.Start"/>
            <check_value value="player.galaxy.macro.ismacro.{macro.xu_ep2_universe_macro}" comment="only in main-galaxy"/>
            <!--<check_value value="false" comment="prevent savegame compatibility issues during development"/>-->
          </check_all>
        </check_any>
      </conditions>
      <actions>
        <set_value name="$DebugChance"                exact="0"/>
        <set_value name="$DeepDebugChance"            exact="0"     comment="for AI scripts and similar external code"/>
        <set_value name="$MissionCue"                 exact="this"/>
        <set_value name="$TerranPage"                 exact="30225"/>
        <set_value name="$YakiPage"                   exact="30226"/>

        <set_value name="$RelationThreshold"          exact="faction.terran.relation.dock.min"/>

        <!--Custom gamestart flags-->
        <set_value name="$story_yaki_complete" exact="gamestart.storystate.story_yaki_complete"/>
        <set_value name="$HasCustomGamestartSkip" exact="$story_yaki_complete"/>

        <debug_text text="'Initializing Yaki Story'" chance="$DebugChance"/>
      </actions>
      <patch sinceversion="2">
        <set_value name="$HasCustomGamestartSkip" exact="false"/>
      </patch>
      <patch sinceversion="3">
        <do_if value="Ch23_Yaki_Trade.state == cuestate.cancelled">
          <debug_text text="'Setting yaki story state to complete as it may not have been set after failing the final task'" filter="savegame"/>
          <set_userdata storystate="'story_yaki_complete'" value="1"/>
        </do_if>
      </patch>
      <patch sinceversion="4">
        <!-- This patch code can run at basically any point during the plot. -->
        <do_if value="@$WingmateShip.exists and not $WingmateActor.exists and (Wingmate_Station_Store_Ship.state != cuestate.active)" comment="The delay in Wingmate_Station_Store_Ship is the one moment where we don't want to mess with the placement.">
          <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $WingmateActor, $MissionCue]" comment="Remove all potentially conflicting placement requests."/>
          <do_if value="not $WingmateShip.pilot.exists">
            <assign_control_entity object="$WingmateShip" actor="$WingmateActor" post="controlpost.aipilot" transfer="true"/>
          </do_if>
          <do_else comment="This can only happen after Wingmate_Transfer has run.">
            <set_entity_role entity="$WingmateActor" role="entityrole.passenger"/>
            <find_room name="$PersonalOfficeRoom" object="player.headquarters" macro="macro.room_gen_playeroffice_01_macro"/>
            <add_actor_to_room actor="$WingmateActor" object="$PersonalOfficeRoom">
              <position x="0.64m" y="0m" z="-10m"/>
              <rotation yaw="-5.522282deg" pitch="0deg" roll="0deg"/>
            </add_actor_to_room>
          </do_else>
        </do_if>
      </patch>
      <patch sinceversion="5">
        <set_value name="$story_yaki_complete" exact="$HasCustomGamestartSkip"/>
      </patch>
      <patch sinceversion="6">
        <set_value name="$RelationThreshold" exact="faction.terran.relation.dock.min"/>
      </patch>
      <patch sinceversion="7">
        <!-- Add story group to all mission cues and threads called $MissionCue -->
        <do_if value="$MissionCue.hasmission">
          <do_if value="@$MissionCue.canactivatesubmission.{@$SubMissionCue_A} or @$MissionCue.canactivatesubmission.{@$SubMissionCue_B} or @$MissionCue.canactivatesubmission.{@$SubMissionCue_C}
                     or @$MissionCue.canactivatesubmission.{@$SubMissionCue_D} or @$MissionCue.canactivatesubmission.{@$SubMissionCue_E} or @$MissionCue.canactivatesubmission.{@$SubMissionCue_F}
                     or @$MissionCue.canactivatesubmission.{@$SubMissionCue_G}">
            <update_mission_thread cue="$MissionCue" group="missiongroup.story_yaki"/>
          </do_if>
          <do_elseif value="Ch10_Yaki_Investigation_Intro.state != cuestate.waiting">
            <update_mission cue="$MissionCue" group="missiongroup.story_yaki"/>
          </do_elseif>
          <do_else>
            <update_mission cue="$MissionCue" group="missiongroup.story_yaki_solborn"/>
          </do_else>
        </do_if>

        <!-- Add story group to mission cues with other names -->
        <do_if value="@$SubMissionCue_A.hasmission">
          <update_mission cue="$SubMissionCue_A" group="missiongroup.story_yaki"/>
        </do_if>
        <do_if value="@$SubMissionCue_B.hasmission">
          <update_mission cue="$SubMissionCue_B" group="missiongroup.story_yaki"/>
        </do_if>
        <do_if value="@$SubMissionCue_C.hasmission">
          <update_mission cue="$SubMissionCue_C" group="missiongroup.story_yaki"/>
        </do_if>
        <do_if value="@$SubMissionCue_D.hasmission">
          <update_mission cue="$SubMissionCue_D" group="missiongroup.story_yaki"/>
        </do_if>
        <do_if value="@$SubMissionCue_E.hasmission">
          <update_mission cue="$SubMissionCue_E" group="missiongroup.story_yaki"/>
        </do_if>
        <do_if value="@$SubMissionCue_F.hasmission">
          <update_mission cue="$SubMissionCue_F" group="missiongroup.story_yaki"/>
        </do_if>
        <do_if value="@$SubMissionCue_G.hasmission">
          <update_mission cue="$SubMissionCue_G" group="missiongroup.story_yaki"/>
        </do_if>
      </patch>
      <cues>

        <cue name="Setup">
          <cues>

            <cue name="Setup_Actors" version="7">
              <actions>
                <!-- Mission Command: Delilah Shiratori -->
                <create_cue_actor name="$SecretServiceActor" cue="namespace" macro="character_terran_female_plot_secret_service_contact_macro">
                  <page exact="10157"/>
                  <owner exact="faction.terran"/>
                  <skills>
                    <skill type="management"  exact="15"/>
                    <skill type="morale"      exact="12"/>
                    <skill type="piloting"    exact="6"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="3"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$SecretServiceActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_value name="$SecretServiceCutsceneKey" exact="table[$key = 'ShowLogoTerran']"/>
                <set_value name="md.$PersistentCharacters.$SecretServiceActor" exact="$SecretServiceActor"/>
                <set_object_name object="$SecretServiceActor" page="30225" line="108" comment="(Delilah Shiratori)Mission Command"/>
                <set_entity_overrides entity="$SecretServiceActor" icon="'manager'"/>
                <set_value name="$SecretServiceActor.$MissionCue" exact="$MissionCue"/>

                <!-- Wingmate: Haile Shinamon -->
                <create_cue_actor name="$WingmateActor" cue="namespace" macro="character_terran_male_plot_wingmate_macro">
                  <page exact="10101"/>
                  <owner exact="faction.terran"/>
                  <skills>
                    <skill type="management"  exact="0"/>
                    <skill type="morale"      exact="12"/>
                    <skill type="piloting"    exact="15"/>
                    <skill type="engineering" exact="6"/>
                    <skill type="boarding"    exact="3"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$WingmateActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_value name="$WingmateCutsceneKey" exact="table[$key = 'ShowCharacter']" comment="Failsafe so the cutscene doesn't break if he says something before he gets placed."/>
                <set_entity_overrides entity="$WingmateActor" icon="'pilot'"/>
                <set_value name="$WingmateActor.$MissionCue" exact="$MissionCue"/>

                <!-- Ship Computer Voice: Nellie -->
                <create_cue_actor name="$NellieActor" cue="$MissionCue">
                  <select race="race.drone"/>
                  <owner exact="faction.ownerless"/>
                  <page exact="10002"/>
                  <name name="'{30225,107}'"/>
                </create_cue_actor>
                <set_entity_traits entity="$NellieActor" missionactor="true" customhandler="true" subtitlename="true"/>

                <!-- Transport Captain: Nowak Lee -->
                <create_cue_actor name="$TransportCaptainActor" cue="namespace" macro="character_terran_male_plot_transport_captain_macro">
                  <page exact="10166"/>
                  <owner exact="faction.terran"/>
                  <skills>
                    <skill type="management"  exact="9"/>
                    <skill type="morale"      exact="12"/>
                    <skill type="piloting"    exact="9"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$TransportCaptainActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_value name="$TransportCaptainCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>
                <set_value name="$TransportCaptainActor.$MissionCue" exact="$MissionCue"/>

                <!-- Angry Miner: Derek Mayor -->
                <create_cue_actor name="$AngryMinerActor" cue="namespace" macro="character_terran_male_plot_angry_miner_macro">
                  <page exact="10167"/>
                  <owner exact="faction.antigone"/>
                  <skills>
                    <skill type="management"  exact="3"/>
                    <skill type="morale"      exact="9"/>
                    <skill type="piloting"    exact="9"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$AngryMinerActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_value name="$AngryMinerCutsceneKey" exact="table[$key = 'ShowCharacter']" comment="Character doesn't get placed."/>
                <set_value name="$AngryMinerActor.$MissionCue" exact="$MissionCue"/>

                <create_cue_actor name="$AngryMinerSubstituteActor" cue="namespace" macro="character_terran_male_plot_angry_miner_macro" comment="Make the actual pilot look the same, so that the difference isn't immediately obvious.">
                  <owner exact="faction.antigone"/>
                  <skills>
                    <skill type="management"  exact="3"/>
                    <skill type="morale"      exact="9"/>
                    <skill type="piloting"    exact="9"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>

                <!-- Yaki Renegade: Obelisk Ikegami -->
                <create_cue_actor name="$YakiRenegadeActor" cue="namespace" macro="character_yaki_male_plot_yaki_renegade_macro">
                  <page exact="10160"/>
                  <owner exact="faction.yaki"/>
                  <skills>
                    <skill type="management"  exact="0"/>
                    <skill type="morale"      exact="15"/>
                    <skill type="piloting"    exact="15"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="6"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$YakiRenegadeActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_value name="$YakiRenegadeCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>
                <set_value name="$YakiRenegadeActor.$MissionCue" exact="$MissionCue"/>

                <!-- Yaki Leader: Kendai Orcanic -->
                <create_cue_actor name="$YakiLeaderActor" cue="namespace" macro="character_yaki_female_plot_yaki_leader_macro">
                  <page exact="10165"/>
                  <owner exact="faction.yaki"/>
                  <skills>
                    <skill type="management"  exact="9"/>
                    <skill type="morale"      exact="15"/>
                    <skill type="piloting"    exact="12"/>
                    <skill type="engineering" exact="6"/>
                    <skill type="boarding"    exact="3"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$YakiLeaderActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_value name="$YakiLeaderCutsceneKey" exact="table[$key = 'ShowLogoYaki']" comment="Initial key. Actor gets placed later."/>
                <set_entity_overrides entity="$YakiLeaderActor" icon="'captain'"/>

                <!-- Pioneers Mining Leader: Teagan Atriedes -->
                <create_cue_actor name="$MiningLeaderActor" cue="namespace" macro="character_terran_male_plot_mining_leader_macro">
                  <page exact="10169"/>
                  <owner exact="faction.pioneers"/>
                  <skills>
                    <skill type="management"  exact="3"/>
                    <skill type="morale"      exact="6"/>
                    <skill type="piloting"    exact="6"/>
                    <skill type="engineering" exact="9"/>
                    <skill type="boarding"    exact="3"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$MiningLeaderActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_value name="$MiningLeaderCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>
                <set_entity_overrides entity="$MiningLeaderActor" icon="'junkdealer'"/>

                <!-- Pioneers Mining Subordinate: Kasee Reuven -->
                <create_cue_actor name="$MiningSubordinateActor" cue="$MissionCue" macro="character_terran_female_plot_mining_subordinate_macro">
                  <page exact="10170"/>
                  <owner exact="faction.pioneers"/>
                  <skills>
                    <skill type="management"  exact="6"/>
                    <skill type="morale"      exact="9"/>
                    <skill type="piloting"    exact="9"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="6"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$MiningSubordinateActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_value name="$MiningSubordinateCutsceneKey" exact="table[$key = 'ShowCharacter']" comment="Failsafe. Actor doesn't speak via cutscenes."/>
                <set_entity_overrides entity="$MiningSubordinateActor" icon="'armsdealer'"/>

                <!-- Yaki Civilian: Tamatha Shani -->
                <create_cue_actor name="$YakiCivilianActor" cue="namespace" macro="character_yaki_female_plot_yaki_civilian_macro">
                  <page exact="10161"/>
                  <owner exact="faction.pioneers"/>
                  <skills>
                    <skill type="management"  exact="9"/>
                    <skill type="morale"      exact="12"/>
                    <skill type="piloting"    exact="6"/>
                    <skill type="engineering" exact="0"/>
                    <skill type="boarding"    exact="3"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$YakiCivilianActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_value name="$YakiCivilianCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>
                <set_entity_overrides entity="$YakiCivilianActor" icon="'manager'"/>

                <!-- Pioneers Civilian 1: Ratekmanckten -->
                <create_cue_actor name="$PioneersCivilianActor_1" cue="namespace" macro="character_paranid_plot_pioneers_civilian_macro">
                  <page exact="10354"/>
                  <owner exact="faction.pioneers"/>
                  <skills>
                    <skill type="management"  exact="6"/>
                    <skill type="morale"      exact="15"/>
                    <skill type="piloting"    exact="0"/>
                    <skill type="engineering" exact="0"/>
                    <skill type="boarding"    exact="3"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$PioneersCivilianActor_1" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$PioneersCivilianActor_1" icon="'specialist'"/>

                <!-- Pioneers Civilian 2: Hanirases Astopanos Uguras II -->
                <create_cue_actor name="$PioneersCivilianActor_2" cue="namespace" macro="character_teladi_male_plot_pioneers_civilian_macro">
                  <page exact="10554"/>
                  <owner exact="faction.pioneers"/>
                  <skills>
                    <skill type="management"  exact="12"/>
                    <skill type="morale"      exact="9"/>
                    <skill type="piloting"    exact="3"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$PioneersCivilianActor_2" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$PioneersCivilianActor_2" icon="'licencebroker'"/>

                <set_value name="$AddStoryMentors"/>
              </actions>

              <patch sinceversion="3">
                <!-- Bug in X4 v4.00: When a cue actor was not connected to the gamegraph and assigned as MD cue actor to multiple cues, import from savegame was incorrect. -->
                <!-- This could happen when an unconnected plot actor was involved in a plot dialog via the NPC usecase system. -->
                <!-- As a result, the actor referenced by variable may be different from the cue actor, and the import was incomplete for one of them. -->

                <!-- Case 1: Actor referenced in variable is invalid (it got deleted when the dialog usecase was completed), or the import was incomplete (indicated by missing missionactor flag) -->
                <!-- (NOTE: The actor may still be assigned as cue actor, but it may have been imported incorrectly, so we should not use that one anymore.) -->
                <do_if value="not $SecretServiceActor.isclass.npc or not $SecretServiceActor.ismissionactor">
                  <!-- Mission Command: Delilah Shiratori -->
                  <debug_text text="'Patch: Have to replace $SecretServiceActor %s (name=\'%s\', macro=%s)'.[$SecretServiceActor, @$SecretServiceActor.knownname, @$SecretServiceActor.macro]" filter="savegame" />
                  <set_value name="$SecretServiceActor" exact="null" />
                  <!-- [Optional] Find old cue actor (identify by macro), but note that the actor may have been imported incorrectly (identify by missing ismissionactor flag) -->
                  <do_for_each name="$patch_actor" in="namespace.actors">
                    <do_if value="$patch_actor.macro == macro.character_terran_female_plot_secret_service_contact_macro">
                      <do_if value="$patch_actor.ismissionactor">
                        <!-- Data seems to be correct -->
                        <debug_text text="'  Found valid cue actor for $SecretServiceActor: %s'.[$patch_actor]" filter="savegame" />
                        <set_value name="$SecretServiceActor" exact="$patch_actor" />
                      </do_if>
                      <do_else>
                        <debug_text text="'  Removing invalid cue actor: %s (name=\'%s\', macro=%s)'.[$patch_actor, $patch_actor.knownname, $patch_actor.macro]" filter="savegame" />
                        <remove_cue_actor cue="namespace" actor="$patch_actor" />
                      </do_else>
                      <break />
                    </do_if>
                  </do_for_each>
                  <do_if value="not $SecretServiceActor">
                    <!-- Create and set up new actor -->
                    <create_cue_actor name="$SecretServiceActor" cue="namespace" macro="character_terran_female_plot_secret_service_contact_macro">
                      <page exact="10157"/>
                      <owner exact="faction.terran"/>
                      <skills>
                        <skill type="management"  exact="15"/>
                        <skill type="morale"      exact="12"/>
                        <skill type="piloting"    exact="6"/>
                        <skill type="engineering" exact="3"/>
                        <skill type="boarding"    exact="3"/>
                      </skills>
                    </create_cue_actor>
                    <set_entity_traits entity="$SecretServiceActor" missionactor="true" customhandler="true" subtitlename="true"/>
                    <set_object_name object="$SecretServiceActor" page="30225" line="108" comment="(Delilah Shiratori)Mission Command"/>
                    <set_entity_overrides entity="$SecretServiceActor" icon="'manager'"/>
                    <debug_text text="'  Created new cue actor: %s (name=\'%s\', macro=%s)'.[$SecretServiceActor, $SecretServiceActor.knownname, $SecretServiceActor.macro]" filter="savegame" />
                  </do_if>
                </do_if>
                <!-- Case 2: Actor referenced in variable is valid, but it does not match the usecase actor -->
                <do_elseif value="not namespace.actors.indexof.{$SecretServiceActor}">
                  <!-- [Optional] Find and remove old cue actor (identify by macro) -->
                  <debug_text text="'Patch: $SecretServiceActor %s (name=\'%s\', macro=%s) is not assigned as cue actor, re-assigning'.[$SecretServiceActor, $SecretServiceActor.knownname, $SecretServiceActor.macro]" filter="savegame" />
                  <do_for_each name="$patch_actor" in="namespace.actors">
                    <do_if value="$patch_actor.macro == macro.character_terran_female_plot_secret_service_contact_macro">
                      <debug_text text="'  Removing invalid cue actor: %s (name=\'%s\', macro=%s)'.[$patch_actor, $patch_actor.knownname, $patch_actor.macro]" filter="savegame" />
                      <remove_cue_actor cue="namespace" actor="$patch_actor" />
                      <break />
                    </do_if>
                  </do_for_each>
                  <!-- Add correctly imported actor as new cue actor -->
                  <create_cue_actor cue="namespace" actor="$SecretServiceActor" />
                </do_elseif>
                <!-- Update md.$PersistentCharacters in case of a mismatch or update -->
                <do_if value="md.$PersistentCharacters.$SecretServiceActor" exact="$SecretServiceActor" negate="true">
                  <debug_text text="'Patch: Updating md.$PersistentCharacters.$SecretServiceActor %s (name=\'%s\', macro=%s) to $SecretServiceActor %s (name=\'%s\', macro=%s)'.[md.$PersistentCharacters.$SecretServiceActor, @md.$PersistentCharacters.$SecretServiceActor.knownname, @md.$PersistentCharacters.$SecretServiceActor.macro, $SecretServiceActor, $SecretServiceActor.knownname, $SecretServiceActor.macro]" filter="savegame" />
                  <set_value name="md.$PersistentCharacters.$SecretServiceActor" exact="$SecretServiceActor"/>
                </do_if>

                <!-- Repair possibly broken dialogs -->
                <do_if value="(Ch8_8_Debriefing_Dialog.state == cuestate.waiting) and ((Ch8_8_Mission_Failed_Dialog.state == cuestate.complete) or (Ch8_8_Mission_Successful_Dialog.state == cuestate.complete))">
                  <do_if value="$TerranOutpost.isoperational">
                    <force_cue cue="Ch8_8_Mission_Successful_Dialog"/>
                  </do_if>
                  <do_else>
                    <force_cue cue="Ch8_8_Mission_Failed_Dialog"/>
                  </do_else>
                </do_if>

                <do_if value="(Ch8_3_Dialog_7.state == cuestate.complete) and (Ch8_3_Dialog_Finished.state == cuestate.waiting)">
                  <speak actor="$SecretServiceActor" priority="100">
                    <text line="30225116" comment="(as if interrupted by static)... enemy movement ..."/>
                    <text line="30225117" delay="0.5s" comment="(as if interrupted by static)... all squads, return to base immediately!"/>
                    <text line="30225119" delay="0.5s" comment="The entire sector is descending on us!"/>
                  </speak>
                </do_if>
              </patch>
              <patch sinceversion="4">
                <do_if value="(Ch4_1_Commotion_Dialog_2.state == cuestate.complete) and (Ch4_1_Commotion_Dialog_3.state == cuestate.waiting)">
                  <speak actor="$SecretServiceActor" recipient="$AngryMinerActor" broadcast="true" priority="100">
                    <text line="30225030" comment="(warningly)Stand down, citizen."/>
                    <text line="30225031" comment="(lecturing)This sector is vital to the defence of Sol, and the entire Jump Gate network."/>
                    <text line="30225032" comment="(reassuringly)Given time, the Antigone Republic will certainly see the benefits of our protection."/>
                  </speak>
                </do_if>
                <do_if value="(Ch4_1_Commotion_Dialog_7.state == cuestate.complete) and (Ch4_1_Commotion_Dialog_8.state == cuestate.waiting)">
                  <speak actor="$SecretServiceActor" backgroundcomm="true" broadcast="true" priority="100">
                    <text line="30225038" comment="(towards someone in her office)And get me the Chief Secretary on the line, pronto!"/>
                  </speak>
                </do_if>
              </patch>
              <patch sinceversion="6">
                <set_value name="$AddStoryMentors"/>
              </patch>
              <patch sinceversion="7">
                <do_if value="(Ch9_Secret_Service.state != cuestate.cancelled) and (Ch10_Yaki_Investigation_Intro.state == cuestate.waiting)">
                  <set_value name="$SecretServiceActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$WingmateActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$YakiRenegadeActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$TransportCaptainActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$AngryMinerActor.$MissionCue" exact="$MissionCue"/>
                </do_if>
                <do_elseif value="(Ch10_Yaki_Investigation_Intro.state != cuestate.waiting) and $MissionCue.hasmission">
                  <set_value name="$SecretServiceActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$WingmateActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$YakiRenegadeActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$YakiLeaderActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$YakiCivilianActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$MiningLeaderActor.$MissionCue" exact="$MissionCue"/>
                  <set_value name="$MiningSubordinateActor.$MissionCue" exact="$MissionCue"/>
                </do_elseif>
              </patch>
              <cues>
                <cue name="PATCH_AddStoryMentors" onfail="cancel">
                  <conditions>
                    <check_value value="$AddStoryMentors?"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$SecretServiceActor]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$WingmateActor]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$TransportCaptainActor]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$AngryMinerActor]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$YakiRenegadeActor]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$YakiLeaderActor]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$MiningLeaderActor]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$MiningSubordinateActor]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$YakiCivilianActor]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$PioneersCivilianActor_1]"/>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$PioneersCivilianActor_2]"/>
                  </actions>
                </cue>
              </cues>

            </cue>

            <cue name="Setup_Locations">
              <actions>
                <find_sector name="$TerranOutpostSector" macro="macro.cluster_48_sector001_macro" comment="Getsu Fune"/>
                <create_position name="$TerranOutpostPosition" space="$TerranOutpostSector" x="-45km" y="0" z="87km" comment="Nice view, but with an asteroid field between it and the Xenon, which makes them arrive at a snail's pace."/>
                <!--<create_position name="$TerranOutpostPosition" space="$TerranOutpostSector" x="9km" y="0" z="40km" comment="Seemingly a etter position, because the way through the asteroids is shorter, but the attackers still slow down at 25km distance."/>-->
                <!--<create_position name="$TerranOutpostPosition" space="$TerranOutpostSector" x="12km" y="0" z="112km" comment="Test position to check whether it's really the asteroids that slow down movement."/>-->
                <find_sector name="$TerranBorderSector" macro="macro.cluster_100_sector001_macro" comment="Asteroid Belt"/>
                <find_sector name="$YakiExitSector" macro="macro.cluster_112_sector002_macro" comment="Savage Spur II"/>
                <find_sector name="$SecretServiceSector" macro="macro.cluster_101_sector001_macro" comment="Mars"/>
                <find_sector name="$TrackYakiSector1" macro="macro.cluster_100_sector001_macro" comment="Asteroid Belt"/>
                <find_sector name="$TrackYakiSector2" macro="macro.cluster_107_sector001_macro" comment="Jupiter"/>
                <find_sector name="$AmbushWreckSector" macro="macro.cluster_108_sector001_macro" comment="Saturn"/>
                <find_sector name="$DamagedTraderSector" macro="macro.cluster_109_sector001_macro" comment="Uranus"/>
                <find_sector name="$MiningFleetSector" macro="macro.cluster_110_sector001_macro" comment="Neptune"/>
                <find_sector name="$ConversationPuzzleSector" macro="macro.cluster_115_sector001_macro" comment="Brennan's Triumph"/>
                <find_sector name="$YakiHomeSector" macro="macro.cluster_112_sector001_macro" comment="Savage Spur I"/>
                <find_sector name="$XenonSectorNextToYaki" macro="macro.cluster_33_sector001_macro" comment="Matrix #79B"/>
                <find_sector name="$TharkasCascadeXV" macro="macro.cluster_32_sector001_macro" comment="Tharka's Cascade XV"/>
                <find_sector name="$TharkasCascadeXVII" macro="macro.cluster_32_sector002_macro" comment="Tharka's Cascade XVII"/>
              </actions>
            </cue>

            <cue name="Setup_Wingmate_Loadout">
              <actions>
                <create_loadout result="$WingmateLoadout">
                  <macros>
                    <engine macro="engine_ter_s_combat_01_mk2_macro" path="../con_engine_02"/>
                    <engine macro="engine_ter_s_combat_01_mk2_macro" path="../con_engine_01"/>
                    <weapon macro="weapon_ter_s_laser_01_mk1_macro" path="../con_weapon_03"/>
                    <weapon macro="weapon_ter_s_laser_01_mk1_macro" path="../con_weapon_04"/>
                    <weapon macro="weapon_ter_s_laser_01_mk1_macro" path="../con_weapon_01"/>
                    <weapon macro="weapon_ter_s_laser_01_mk1_macro" path="../con_weapon_02"/>
                    <shield macro="shield_ter_s_standard_01_mk2_macro" path="../con_shield_01"/>
                  </macros>
                  <ammunition>
                    <ammunition macro="countermeasure_flares_01_macro" exact="2"/>
                  </ammunition>
                  <software>
                    <software ware="software_dockmk1"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk1"/>
                    <software ware="software_scannerobjectmk1"/>
                    <software ware="software_targetmk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_s_combat_01_mk2_macro"/>
                  </virtualmacros>
                </create_loadout>
              </actions>
            </cue>

            <cue name="Setup_Yaki_Renegade_Loadout">
              <actions>
                <create_loadout result="$YakiRenegadeLoadout">
                  <macros>
                    <engine macro="engine_arg_m_combat_01_mk3_macro" path="../con_engine_01"/>
                    <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_05"/>
                    <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_04"/>
                    <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_03"/>
                    <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_02"/>
                    <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_01"/>
                    <shield macro="shield_par_m_standard_01_mk2_macro" path="../con_shield_front_r"/>
                    <shield macro="shield_par_m_standard_01_mk2_macro" path="../con_shield_front_l"/>
                    <turret macro="turret_arg_m_laser_01_mk1_macro" path="../con_turret_l01"/>
                    <turret macro="turret_arg_m_laser_01_mk1_macro" path="../con_turret_r01"/>
                  </macros>
                  <ammunition>
                    <ammunition macro="countermeasure_flares_01_macro" exact="8"/>
                    <ammunition macro="ship_gen_xs_lasertower_01_a_macro" exact="20"/>
                  </ammunition>
                  <software>
                    <software ware="software_dockmk2"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk2"/>
                    <software ware="software_scannerobjectmk2"/>
                    <software ware="software_targetmk1"/>
                    <software ware="software_trademk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_m_combat_01_mk3_macro"/>
                  </virtualmacros>
                </create_loadout>
              </actions>
            </cue>

            <cue name="Setup_Globals">
              <actions>
                <create_list name="md.$TerranWingmateDND" comment="The wingmate will only join you on sector or relation change when this is empty. He'll still join you for plot missions regardless."/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Setup_Terran_Outpost doesn't have a suitable parent cue, so we cant't just reset it to make it automatically run again. -->
        <cue name="Setup_Terran_Outpost_Respawn" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <reset_cue cue="Setup_Terran_Outpost"/>
          </actions>
          <delay exact="0.1s"/>
          <actions>
            <signal_cue cue="Setup_Terran_Outpost"/>
          </actions>
        </cue>

        <cue name="Setup_Terran_Outpost" version="4">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$TerranOutpost" exact="null"/>
            <do_if value="$TerranOutpostSecondTimeSetup?">
              <find_station name="$TerranOutpost" owner="faction.terran" space="$TerranOutpostSector">
                <match_content canclaimownership="true"/>
              </find_station>
            </do_if>
            <do_if value="not $TerranOutpost">
              <create_station name="$TerranOutpost" macro="macro.station_gen_factory_base_01_macro" sector="$TerranOutpostSector" state="componentstate.operational" owner="faction.terran" constructionplan="'story_terran_outpost'">
                <safepos value="$TerranOutpostPosition"/>
              </create_station>
              <signal_objects object="player.galaxy" param="'init station'" param2="$TerranOutpost" param3="false" comment="Add control entities."/>
            </do_if>
            <!-- Always keep the current outpost position updated for mission objectives and AI orders, but remember the original position as well in case we have to respawn the station. -->
            <create_position name="$CurrentTerranOutpostPosition" space="$TerranOutpostSector" object="$TerranOutpost"/>

            <set_object_name object="$TerranOutpost" page="30225" line="1012"/>

            <!-- Update running orders that target $TerranOutpost -->
            <do_if value="(Ch1_2_Transport_Orders.state == cuestate.complete) and (Ch1_2_Gate_Approach_Announcement.state == cuestate.waiting)">
              <reset_cue cue="Ch1_2_Transport_Orders"/>
            </do_if>
            <do_if value="Ch1_4_Transport_Orders.state == cuestate.complete">
              <reset_cue cue="Ch1_4_Transport_Orders"/>
            </do_if>
            <do_if value="Ch1_4_Escort_Squad_Orders.state == cuestate.complete">
              <reset_cue cue="Ch1_4_Escort_Squad_Orders"/>
            </do_if>

            <!-- Update running approach handlers that involve $TerranOutpost -->
            <!--<do_if value="(Ch3_2_Setup_Strange_Beacon.state == cuestate.complete) and (Ch3_3_Investigate_Strange_Beacon.state == cuestate.waiting) and not $StrangeBeacon.exists">
              <reset_cue cue="Ch3_2_Setup_Strange_Beacon"/>
            </do_if>-->
            <do_if value="((Ch1_5_Approach_TerranOutpost_Ref.state == cuestate.complete) or (Ch1_5_Approach_TerranOutpost_Ref.state == cuestate.cancelled)) and (Ch1_5_Wingmate_Outpost_Comment.state == cuestate.waiting)">
              <reset_cue cue="Ch1_5_Approach_TerranOutpost_Ref"/>
              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" object="$TerranOutpost" text="{30225,1012}" updatebriefing="true"/>
            </do_if>
            <do_if value="((Ch3_1_Approach_TerranOutpost_Ref.state == cuestate.complete) or (Ch3_1_Approach_TerranOutpost_Ref.state == cuestate.cancelled)) and (Ch3_1_Instructions_1.state == cuestate.waiting)">
              <reset_cue cue="Ch3_1_Approach_TerranOutpost_Ref"/>
              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,1020}" object="$TerranOutpostSector" offset="$CurrentTerranOutpostPosition" radius="2km" updatebriefing="true"/>
            </do_if>
            <do_if value="((Ch6_1_Approach_TerranOutpost_Ref.state == cuestate.complete) or (Ch6_1_Approach_TerranOutpost_Ref.state == cuestate.cancelled)) and (Ch6_1_Briefing_Dialog.state == cuestate.waiting)">
              <reset_cue cue="Ch6_1_Approach_TerranOutpost_Ref"/>
              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,2013}" offset="$CurrentTerranOutpostPosition" object="$TerranOutpostSector" radius="10km" updatebriefing="true"/>
            </do_if>
          </actions>
          <patch sinceversion="2" state="complete">
            <create_position name="$CurrentTerranOutpostPosition" space="$TerranOutpostSector" object="$TerranOutpost"/>
          </patch>
          <patch sinceversion="2" state="cancelled">
            <set_value name="$CurrentTerranOutpostPosition" exact="$TerranOutpostPosition"/>
          </patch>
          <patch sinceversion="3">
            <do_if value="(Ch1_5_Approach_TerranOutpost_Ref.state == cuestate.complete) and (Ch1_5_Wingmate_Outpost_Comment.state == cuestate.waiting)">
              <reset_cue cue="Ch1_5_Approach_TerranOutpost_Ref"/>
              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" object="$TerranOutpost" text="{30225,1012}" updatebriefing="true"/>
            </do_if>
            <do_if value="(Ch3_1_Approach_TerranOutpost_Ref.state == cuestate.complete) and (Ch3_1_Instructions_1.state == cuestate.waiting)">
              <reset_cue cue="Ch3_1_Approach_TerranOutpost_Ref"/>
              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,1020}" object="$TerranOutpostSector" offset="$CurrentTerranOutpostPosition" radius="2km" updatebriefing="true"/>
            </do_if>
            <do_if value="(Ch6_1_Approach_TerranOutpost_Ref.state == cuestate.complete) and (Ch6_1_Briefing_Dialog.state == cuestate.waiting)">
              <reset_cue cue="Ch6_1_Approach_TerranOutpost_Ref"/>
              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,2013}" offset="$CurrentTerranOutpostPosition" object="$TerranOutpostSector" radius="10km" updatebriefing="true"/>
            </do_if>
          </patch>
          <patch sinceversion="4">
            <do_if value="(Ch1_5_Approach_TerranOutpost_Ref.state == cuestate.cancelled) and (Ch1_5_Wingmate_Outpost_Comment.state == cuestate.waiting)">
              <reset_cue cue="Ch1_5_Approach_TerranOutpost_Ref"/>
              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" object="$TerranOutpost" text="{30225,1012}" updatebriefing="true"/>
            </do_if>
            <do_if value="(Ch3_1_Approach_TerranOutpost_Ref.state == cuestate.cancelled) and (Ch3_1_Instructions_1.state == cuestate.waiting)">
              <reset_cue cue="Ch3_1_Approach_TerranOutpost_Ref"/>
              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,1020}" object="$TerranOutpostSector" offset="$CurrentTerranOutpostPosition" radius="2km" updatebriefing="true"/>
            </do_if>
            <do_if value="(Ch6_1_Approach_TerranOutpost_Ref.state == cuestate.cancelled) and (Ch6_1_Briefing_Dialog.state == cuestate.waiting)">
              <reset_cue cue="Ch6_1_Approach_TerranOutpost_Ref"/>
              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,2013}" offset="$CurrentTerranOutpostPosition" object="$TerranOutpostSector" radius="10km" updatebriefing="true"/>
            </do_if>
          </patch>
          <cues>

            <cue name="Terran_Outpost_Friendly_Fire_Protection" ref="md.LIB_Generic.Friendly_Fire_Protection">
              <param name="Object" value="$TerranOutpost"/>
              <param name="CancelCue" value="Terran_Outpost_Destroyed"/>
            </cue>

            <cue name="Terran_Outpost_Destroyed">
              <conditions>
                <event_object_destroyed object="$TerranOutpost"/>
              </conditions>
              <actions>
                <set_value name="$TerranOutpostSecondTimeSetup"/>
                <signal_cue cue="Setup_Terran_Outpost_Respawn"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- This will trigger Setup_Terran_Outpost again if the outpost got destroyed before the Setup_Terran_Outpost_Respawn cue existed. -->
        <cue name="Setup_Terran_Outpost_Patch_Helper" onfail="cancel">
          <conditions>
            <check_value value="Setup_Terran_Outpost.state == cuestate.waiting"/>
            <check_value value="$TerranOutpostSecondTimeSetup?"/>
          </conditions>
          <actions>
            <signal_cue cue="Setup_Terran_Outpost_Respawn"/>
          </actions>
        </cue>

        <cue name="Setup_Secret_Service_Contact">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Setup_Secret_Service_Station" version="2">
              <actions>
                <!-- Set fallback actor cutscene key in case they end up not getting placed. -->
                <set_value name="$SecretServiceCutsceneKey" exact="table[$key = 'ShowLogoTerran']"/>

                <!-- Find suitable station. -->
                <find_station_by_true_owner name="$SecretServiceStation" canclaimownership="true" faction="faction.terran" space="$SecretServiceSector">
                  <match_dock walkable="true"/>
                </find_station_by_true_owner>
                <do_if value="not $SecretServiceStation">
                  <!-- Broader search: No claim module. -->
                  <find_station_by_true_owner name="$SecretServiceStation" faction="faction.terran" space="$SecretServiceSector">
                    <match_dock walkable="true"/>
                  </find_station_by_true_owner>
                </do_if>
                <do_if value="not $SecretServiceStation">
                  <!-- Broader search: Different sector. -->
                  <find_station_by_true_owner name="$SecretServiceStation" faction="faction.terran" space="player.galaxy" sortbygatedistanceto="$SecretServiceSector">
                    <match_dock walkable="true"/>
                  </find_station_by_true_owner>
                </do_if>
                <do_if value="not $SecretServiceStation">
                  <!-- Broader search: No terran stations (edge case). -->
                  <find_station name="$SecretServiceStation" space="player.galaxy" sortbygatedistanceto="$SecretServiceSector">
                    <match_relation_to faction="faction.player" relation="dock"/>
                    <match_dock walkable="true"/>
                  </find_station>
                </do_if>

                <!-- If a station has been found, continue. -->
                <do_if value="$SecretServiceStation">
                  <!-- Update sector. -->
                  <set_value name="$SecretServiceSector" exact="$SecretServiceStation.sector"/>

                  <!-- Update current position. -->
                  <create_position name="$SecretServiceStationPosition" space="$SecretServiceSector" object="$SecretServiceStation"/>

                  <!-- Remember docks. -->
                  <find_dockingbay groupname="$SecretServiceStationDockingAreas" object="$SecretServiceStation" checkoperational="true" multiple="true">
                    <match_dock size="tag.dock_s"/>
                  </find_dockingbay>

                  <!-- Determine interior macros and names. -->
                  <get_room_definition macro="$SecretServiceCorridorMacro" doors="$SecretServiceDoors" race="$SecretServiceStation.owner.primaryrace" tags="tag.corridor"/>
                  <set_value name="$SecretServiceInteriorName" exact="readtext.{20007}.{3041}" comment="Secret Service Bureau"/>

                  <!-- Create persistent interior. -->
                  <create_dynamic_interior roomname="$SecretServiceRoom" object="$SecretServiceStation" name="$SecretServiceInteriorName" corridor="$SecretServiceCorridorMacro" room="macro.room_gen_intelligenceoffice_01_macro" corridorname="$SecretServiceCorridor" interiorname="$SecretServiceInterior" persistent="true"/>

                  <!-- Find specific slot to place actor on. -->
                  <find_npc_slot name="$PotentialSlots" excludefilled="false" object="$SecretServiceRoom" multiple="true"/>
                  <do_for_each in="$PotentialSlots" name="$Slot">
                    <do_if value="$Slot.name == 'con_control01'">
                      <set_value name="$SecretServiceSlot" exact="$Slot"/>
                    </do_if>
                  </do_for_each>
                  <!-- Slot failsafe. -->
                  <do_if value="not $SecretServiceSlot?">
                    <set_value name="$SecretServiceSlot" exact="$PotentialSlots.random"/>
                  </do_if>

                  <!-- Place actor. -->
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SecretServiceActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $SecretServiceSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                  <!-- Update actor cutscene key. -->
                  <set_value name="$SecretServiceCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>
                </do_if>
              </actions>
              <delay exact="1min"/>
              <actions>
                <!-- If no station could be found, e.g. because all docks were currently inoperable, try again after a delay. -->
                <do_if value="not $SecretServiceStation">
                  <reset_cue cue="this"/>
                </do_if>
              </actions>
              <patch sinceversion="2" comment="Update position for existing story tester saves.">
                <do_if value="$SecretServiceStation.isoperational">
                  <create_position name="$SecretServiceStationPosition" space="$SecretServiceSector" object="$SecretServiceStation"/>
                </do_if>
              </patch>
              <cues>

                <cue name="Secret_Service_Station_Dock_Destroyed">
                  <conditions>
                    <event_object_destroyed group="$SecretServiceStationDockingAreas"/>
                  </conditions>
                  <actions>
                    <find_dockingbay groupname="$SecretServiceStationDockingAreas" object="$SecretServiceStation" checkoperational="true" multiple="true">
                      <match_dock size="tag.dock_s"/>
                    </find_dockingbay>
                    <do_if value="not $SecretServiceStationDockingAreas.operational.count">
                      <reset_cue cue="parent"/>
                    </do_if>
                    <do_else>
                      <reset_cue cue="this"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Secret_Service_Station_Destroyed">
                  <conditions>
                    <event_object_destroyed object="$SecretServiceStation" check="false"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="parent"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Secret_Service_Contact_Conversation_Greeting_Handler">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Secret_Service_Contact_Conversation_Greeting" instantiate="true">
              <conditions>
                <event_conversation_started actor="$SecretServiceActor"/>
                <check_value value="$SecretServiceStation? and $SecretServiceActor.hascontext.{$SecretServiceStation} and player.entity.hascontext.{$SecretServiceStation}"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="[30225237,30225238].random" comment="(variant 1)Good to see you, operative. / (variant 2)Welcome back, operative."/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Setup_Conversation_Puzzle_Station">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Initialise variables. -->
            <set_value name="$ConversationPuzzleSectorGate" exact="null"/>
            <set_value name="$ConversationPuzzleStation" exact="null"/>

            <!-- Start searching for a suitable station, with lowered requirements whenever it fails. -->
            <debug_text text="'Attempting to find a suitable station for the conversation puzzle, starting by finding the sector gate that leads to the previous mission sector.'" chance="$DebugChance"/>
            <get_global_path multiple="true" component="$PathComponents" uselocalhighways="false">
              <start object="$MiningFleetSector"/>
              <end object="$ConversationPuzzleSector"/>
            </get_global_path>
            <do_for_each in="$PathComponents" name="$CurrentComponent" reverse="true">
              <do_if value="$CurrentComponent.isclass.{class.gate} or $CurrentComponent.isclass.{class.highwayentrygate}">
                <debug_text text="'Gate found.'" chance="$DebugChance"/>
                <set_value name="$ConversationPuzzleSectorGate" exact="$CurrentComponent"/>
                <break/>
              </do_if>
            </do_for_each>
            <do_if value="$ConversationPuzzleSectorGate">
              <debug_text text="'Attempting to find the station that\'s closest to the gate we just found.'" chance="$DebugChance"/>
              <find_station_by_true_owner name="$ConversationPuzzleStation" faction="faction.pioneers" space="$ConversationPuzzleSector" sortbydistanceto="$ConversationPuzzleSectorGate">
                <match_dock size="tag.dock_s"/>
              </find_station_by_true_owner>
            </do_if>
            <do_if value="not $ConversationPuzzleStation">
              <debug_text text="'No matching station found. Attempting to find a station without referencing the sector gate.'" chance="$DebugChance"/>
              <find_station_by_true_owner name="$ConversationPuzzleStation" faction="faction.pioneers" space="$ConversationPuzzleSector">
                <match_dock size="tag.dock_s"/>
              </find_station_by_true_owner>
            </do_if>
            <do_if value="not $ConversationPuzzleStation">
              <debug_text text="'No matching station found. Attempting to find a prominent station outside of the designated sector.'" chance="$DebugChance"/>
              <find_station_by_true_owner name="$ConversationPuzzleStation" faction="faction.pioneers" canclaimownership="true" space="player.galaxy" sortbygatedistanceto="$ConversationPuzzleSector">
                <match_dock size="tag.dock_s"/>
              </find_station_by_true_owner>
            </do_if>
            <do_if value="not $ConversationPuzzleStation">
              <debug_text text="'No matching station found. Attempting to find a station outside of the designated sector, and without claim modules.'" chance="$DebugChance"/>
              <find_station_by_true_owner name="$ConversationPuzzleStation" faction="faction.pioneers" space="player.galaxy" sortbygatedistanceto="$ConversationPuzzleSector">
                <match_dock size="tag.dock_s"/>
              </find_station_by_true_owner>
            </do_if>
            <do_if value="not $ConversationPuzzleStation">
              <debug_text text="'No matching station found. Attempting to find any station the player can dock at.'" chance="$DebugChance"/>
              <find_station name="$ConversationPuzzleStation" space="player.galaxy" sortbygatedistanceto="$ConversationPuzzleSector">
                <match_relation_to faction="faction.player" relation="dock"/>
                <match_dock size="tag.dock_s"/>
              </find_station>
            </do_if>

            <debug_text text="'Conversation puzzle station is now: ' + $ConversationPuzzleStation.knownname" chance="$DebugChance"/>
            <!-- In case the station isn't in Brennan's triumph, we have to change the sector for the next part of the mission. -->
            <set_value name="$ConversationPuzzleSector" exact="$ConversationPuzzleStation.sector"/>
            <debug_text text="'Conversation puzzle sector adjusted to: ' + $ConversationPuzzleSector.knownname" chance="$DebugChance"/>

            <set_object_min_hull object="$ConversationPuzzleStation" exact="100"/>
          </actions>
        </cue>

        <cue name="Setup_Yaki_Leader" comment="Listen to this cue being cancelled to catch the moment the Yaki are considered wiped out.">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Setup_Yaki_Headquarters" version="4">
              <actions>
                <!-- Set fallback actor cutscene key in case they end up not getting placed. -->
                <set_value name="$YakiLeaderCutsceneKey" exact="table[$key = 'ShowLogoYaki']"/>

                <!-- Find suitable station. -->
                <find_station_by_true_owner name="$YakiHeadquarters" faction="faction.yaki" space="$YakiHomeSector">
                  <match_dock walkable="true"/>
                </find_station_by_true_owner>
                <do_if value="not $YakiHeadquarters">
                  <do_if value="not $StopYakiHeadquartersSpawn?" comment="The first time around, we're spawning a fallback station. At some point, this fallback won't happen anymore.">
                    <create_station name="$YakiHeadquarters" macro="macro.station_yak_piratebase_base_01_macro" sector="$YakiHomeSector" state="componentstate.operational" owner="faction.yaki" rawname="'{20102,3211}'" constructionplan="'story_yaki_emergency_station'">
                      <safepos value="$YakiHeadquartersPosition"/>
                    </create_station>
                    <signal_objects object="player.galaxy" param="'init station'" param2="$YakiHeadquarters" param3="false" comment="Add control entities."/>
                  </do_if>
                  <do_else>
                    <!-- After the point where the failsafe gets deactivated, we're just trying to find any Yaki station that's left. -->
                    <find_station_by_true_owner name="$YakiHeadquarters" faction="faction.yaki" space="player.galaxy">
                      <match_dock walkable="true"/>
                    </find_station_by_true_owner>
                    <do_if value="not $YakiHeadquarters">
                      <find_station_by_true_owner name="$YakiHeadquarters" faction="faction.yaki" space="player.galaxy"/>
                    </do_if>
                    <do_if value="not $YakiHeadquarters">
                      <debug_text text="'No Yaki station left.'" chance="$DebugChance"/>
                      <cancel_cue cue="parent"/>
                    </do_if>
                  </do_else>
                </do_if>

                <!-- Remember docks. -->
                <find_object_component groupname="$YakiHeadquartersDockingAreas" object="$YakiHeadquarters" checkoperational="true" multiple="true">
                  <match_dock walkable="true"/>
                </find_object_component>

                <!-- Determine interior macros and names. -->
                <get_room_definition macro="$YakiOfficeCorridorMacro" doors="$YakiOfficeDoors" race="$YakiHeadquarters.owner.primaryrace" tags="tag.corridor"/>
                <set_value name="$YakiOfficeRoomMacro" exact="macro.room_gen_managersoffice_01_macro"/>
                <set_value name="$YakiOfficeInteriorName" exact="readtext.{20007}.{3071}" comment="Contingency Suite"/>

                <!-- Create persistent interior. -->
                <create_dynamic_interior roomname="$YakiOfficeRoom" object="$YakiHeadquarters" name="$YakiOfficeInteriorName" corridor="$YakiOfficeCorridorMacro" room="$YakiOfficeRoomMacro" corridorname="$YakiOfficeCorridor" interiorname="$YakiOfficeInterior" persistent="true"/>

                <!-- Find specific slot to place actor on. -->
                <find_npc_slot name="$PotentialSlots" excludefilled="false" object="$YakiOfficeRoom" multiple="true"/>
                <do_for_each in="$PotentialSlots" name="$Slot">
                  <do_if value="$Slot.name == 'con_control01'">
                    <set_value name="$YakiLeaderSlot" exact="$Slot"/>
                  </do_if>
                </do_for_each>
                <!-- Slot failsafe. -->
                <do_if value="not $YakiLeaderSlot?">
                  <set_value name="$YakiLeaderSlot" exact="$PotentialSlots.random"/>
                </do_if>

                <!-- Place actor. -->
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $YakiLeaderActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $YakiLeaderSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                <!-- Update actor cutscene key. -->
                <set_value name="$YakiLeaderCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>

                <!-- Place $WingmateActor if this happens during specific part of the plot. -->
                <do_if value="(Ch20_3_Wingmate_Conversation.state == cuestate.complete) and (Ch20_Disconnect_Wingmate_From_Office.state == cuestate.waiting)">
                  <signal_cue cue="Ch20_Setup_Wingmate_In_Office_v2"/>
                </do_if>
              </actions>
              <patch sinceversion="2">
                <do_if value="not $YakiLeaderActor.exists">
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $YakiLeaderActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $YakiLeaderSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                </do_if>
                <do_if value="(Ch20_3_Wingmate_Conversation.state == cuestate.complete) and (Ch20_Disconnect_Wingmate_From_Office.state == cuestate.waiting) and not $WingmateActor.exists">
                  <set_value name="$YakiOfficeWingmateActorPatch"/>
                  <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$WingmateActor" silent="true" updatebriefing="true"/>
                </do_if>
              </patch>
              <patch sinceversion="3">
                <!-- Spawned emergency headquarters construction plan was missing a storage module -> no medical supplies / food -> no crew for hire -->
                <do_if value="$YakiHeadquarters.isoperational and not $YakiHeadquarters.isgodobject">
                  <create_construction_sequence macros="[macro.storage_arg_l_container_01_macro]" station="$YakiHeadquarters" base="$YakiHeadquarters.plannedconstruction.sequence">
                    <immediate result="this.$sequence"/>
                  </create_construction_sequence>
                  <apply_construction_sequence station="$YakiHeadquarters" sequence="this.$sequence"/>
                </do_if>
              </patch>
              <patch sinceversion="4">
                <do_if value="($YakiOfficeRoomMacro != macro.room_gen_managersoffice_01_macro)">

                  <!-- save old office values -->
                  <set_value name="$YakiOfficeRoom_OLD"       exact="$YakiOfficeRoom"/>
                  <set_value name="$YakiOfficeRoomMacro_OLD"  exact="$YakiOfficeRoomMacro"/>
                  <set_value name="$YakiOfficeInterior_OLD"   exact="$YakiOfficeInterior"/>
                  <set_value name="$YakiLeaderSlot_OLD" exact="$YakiLeaderSlot"/>
                  <remove_value name="$YakiLeaderSlot"/>

                  <!-- create new office -->
                  <set_value name="$YakiOfficeRoomMacro" exact="macro.room_gen_managersoffice_01_macro"/>
                  <create_dynamic_interior roomname="$YakiOfficeRoom" object="$YakiHeadquarters" name="$YakiOfficeInteriorName" corridor="$YakiOfficeCorridorMacro" room="$YakiOfficeRoomMacro" corridorname="$YakiOfficeCorridor" interiorname="$YakiOfficeInterior" persistent="true"/>

                  <!-- reset office listeners -->
                  <do_if value="cuestate.waiting == Ch20_2_Entered_Office.state">
                    <reset_cue cue="Ch20_2_Entered_Office"/>
                  </do_if>

                  <!-- cleanup old office -->
                  <run_actions ref="md.LIB_Generic.Cleanup_Mission_Interior_Call">
                    <param name="Object"      value="$YakiHeadquarters"/>
                    <param name="Interior"    value="$YakiOfficeInterior_OLD"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>

                  <!-- Find specific slot to place actor on. -->
                  <find_npc_slot name="$PotentialSlots" excludefilled="false" object="$YakiOfficeRoom" multiple="true"/>
                  <do_for_each in="$PotentialSlots" name="$Slot">
                    <do_if value="$Slot.name == 'con_control01'">
                      <set_value name="$YakiLeaderSlot" exact="$Slot"/>
                    </do_if>
                  </do_for_each>
                  <!-- Slot failsafe. -->
                  <do_if value="not $YakiLeaderSlot?">
                    <set_value name="$YakiLeaderSlot" exact="$PotentialSlots.random"/>
                  </do_if>

                  <!-- Place actor. -->
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $YakiLeaderActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $YakiLeaderSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                  <do_if value="$YakiOfficeRoom_OLD == $WingmateActor.room">
                    <create_position name="$WingmatePosition" x="-2.5" y="0" z="-4.0"/>
                    <create_rotation name="$WingmateRotation" yaw="138deg" />
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $WingmateActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $YakiOfficeRoom,
                                                                                                                                      $rotation = $WingmateRotation,
                                                                                                                                      $position = $WingmatePosition,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </do_if>

                </do_if>
              </patch>
              <cues>

                <cue name="Yaki_Headquarters_Destroyed">
                  <conditions>
                    <event_object_destroyed object="$YakiHeadquarters" check="false"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <reset_cue cue="parent"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Deactivate_Yaki_Pirate_Jobs" version="2">
          <conditions>
            <event_cue_cancelled cue="Setup_Yaki_Leader" comment="This happens when the Yaki get wiped out completely, which can only happen after the player explicitly orders it."/>
            <check_value value="$ToldTerransAboutYaki?"/>
          </conditions>
          <actions>
            <set_job_active job="'yaki_raider_m_sector'" activate="false"/>
            <set_faction_active faction="faction.yaki" active="false"/>
          </actions>
          <patch sinceversion="2">
            <do_if value="not $ToldTerransAboutYaki?">
              <set_job_active job="'yaki_raider_m_sector'" activate="true"/>
              <set_faction_active faction="faction.yaki" active="true"/>
            </do_if>
          </patch>
        </cue>

        <cue name="DEBUG_Setup_Yaki_Story">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue cue="Setup_Secret_Service_Contact"/>
            <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors" param="true"/>
            <signal_cue cue="md.Story_Diplomacy_Intro.Dal_DeskClean"/>
          </actions>
          <delay exact="3s"/>
          <actions>
            <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
            <signal_cue cue="Setup_Yaki_Story_Character_Changes"/>
          </actions>
        </cue>

        <cue name="DEBUG_Setup_Dal" comment="The story works with or without him. If he exists, he'll offer extra advice, and an optional mission at the end.">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $DalBusta,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = $BosoTa.room,
                                                                                                  $position = position.[-3.17m, 0.05m, -5.0m],
                                                                                                  $rotation = rotation.[90deg, 0deg, 0deg],
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DeepDebugChance == 100 then this else null]
                                                                                                  ]"/>
            <set_entity_traits entity="$DalBusta" missionactor="true" customhandler="true" subtitlename="true"/>
            <do_if value="not md.Story_Diplomacy_Intro.Start.$HQ?">
              <set_value name="md.Story_Diplomacy_Intro.Start.$HQ" exact="$HQ"/>
            </do_if>
            <signal_cue cue="md.Story_Diplomacy_Intro.Dal_DeskClean"/>
          </actions>
        </cue>

        <cue name="Debug_Skipper" onfail="cancel">
          <conditions>
            <check_value value="player.debug" comment="skipper only in debug builds"/>
          </conditions>
          <cues>
            <cue name="Debug_SkipperShip">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.Setup.Debug_Setup_SkipperShip_Create"/>
              </actions>
            </cue>

            <cue name="Debug_SkipperShip_Completed">
              <conditions>
                <event_cue_completed cue="md.Setup.Debug_Setup_SkipperShip_Create_Completed"/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="Debug_Skipper_CreateActor"/>
                <signal_cue cue="Debug_Skipper_Spawn"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_CreateActor">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_cue_actor name="$SkipperActor" cue="$MissionCue" group="yaki.manager.female">
                  <owner exact="faction.civilian"/>
                  <name name="'Yaki Story Skipper'"/>
                </create_cue_actor>
                <set_entity_type entity="$SkipperActor" type="entitytype.crowd"/>
                <set_entity_traits entity="$SkipperActor" missionactor="true" customhandler="true"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Spawn" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_position name="$SkipperPos" x="11" y="-2.8m" z="2"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = md.Setup.Debug_Setup_SkipperShip.$SkipperShip.controlroom,
                                                                                                                                      $position = $SkipperPos,
                                                                                                                                      $rotation = rotation.[210deg, 0deg, 0deg],
                                                                                                                                      $debugchance = 0,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Disconnect" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Conversation">
              <conditions>
                <event_cue_completed cue="Debug_Skipper_CreateActor"/>
              </conditions>
              <cues>

                <cue name="Debug_Skipper_Conversation_Start" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$SkipperActor"/>
                  </conditions>
                  <actions>
                    <add_player_choice highlighted="true" section="skipper_main" text="'PLEASE SAVE YOUR GAME'"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$SkipperActor" section="skipper_main"/>
                      <event_conversation_returned_to_section actor="$SkipperActor" section="skipper_main"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <add_player_choice_sub section="skipper_chapter" text="'Skip to mission'"/>
                    <add_player_choice_sub section="skipper_reputation" text="'Cheat terran reputation'"/>
                    <add_player_choice_sub section="skipper_setup_hq" choiceparam="'boso'" text="'Cheat HQ with just Boso'"/>
                    <add_player_choice_sub section="skipper_setup_hq" choiceparam="'dal'" text="'Cheat Dal - optional dialog'"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Chapter_Options" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_chapter"/>
                  </conditions>
                  <actions>
                    <do_if value="Ch1_Escort.state == cuestate.waiting">
                      <add_player_choice section="skipper_chapter_selected" choiceparam="'ter_1'" text="'Defenders of Sol'"/>
                    </do_if>
                    <do_if value="Ch10_Yaki_Investigation_Intro.state == cuestate.waiting">
                      <add_player_choice section="skipper_chapter_selected" choiceparam="'yak_1'" text="'A Pirate\'s Trail'"/>
                    </do_if>

                    <add_player_choice_return text="'Back'"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Chapter_Selected" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_chapter_selected"/>
                  </conditions>
                  <actions>
                    <do_if value="event.param2 == 'ter_1'">
                      <force_cue cue="Ch1_Escort"/>
                    </do_if>
                    <do_elseif value="event.param2 == 'yak_1'">
                      <force_cue cue="Ch10_Yaki_Investigation_Intro"/>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_HQ" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_setup_hq"/>
                  </conditions>
                  <actions>
                    <do_if value="event.param2 == 'boso'">
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors" param="false"/>
                    </do_if>
                    <do_elseif value="event.param2 == 'dal'">
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors" param="true"/>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Reputation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$SkipperActor" section="skipper_reputation"/>
                      <event_conversation_returned_to_section actor="$SkipperActor" section="skipper_reputation"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <add_player_choice_sub section="skipper_reputation_selected" choiceparam="'5'" text="'Terran rep 5'"/>
                    <add_player_choice_sub section="skipper_reputation_selected" choiceparam="'10'" text="'Terran rep 10'"/>

                    <add_player_choice_return text="'Back'"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Reputation_Selected" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_reputation_selected"/>
                  </conditions>
                  <actions>
                    <do_if value="event.param2 == '5'">
                      <set_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.0032"/>
                    </do_if>
                    <do_elseif value="event.param2 == '10'">
                      <set_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.01"/>
                    </do_elseif>

                    <add_player_choice_return text="'Back'"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Setup_Yaki_Story_Character_Changes">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
            <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>

            <set_value name="$BosoCutsceneKey"    exact="table[ $key = 'ShowCharacterBoron']"/>
            <set_value name="$DalCutsceneKey"     exact="table[ $key = 'ShowCharacterDal']"/>

            <do_if value="md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete">
              <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
            </do_if>
            <do_else>
              <signal_cue cue="Setup_Wait_For_Dal_Busta"/>
            </do_else>

            <!-- Should have already happened in the terran story, but do it again for debugging. -->
            <set_object_name object="$SecretServiceActor" page="30225" line="102" comment="Delilah Shiratori"/>

            <signal_cue cue="Setup_Yaki_Wingmate"/>

            <set_value name="$WingmateOrdersAvailable" comment="Set it again here in case the cue got signalled manually for debugging."/>
          </actions>
        </cue>

        <cue name="Setup_Wait_For_Dal_Busta">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Check_For_Diplomatic_Mentor_Plot_Ending">
              <conditions>
                <event_cue_completed cue="md.Story_Diplomacy_Intro.Pt11_End"/>
              </conditions>
              <actions>
                <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Setup_Yaki_Wingmate" comment="Switch faction, background, loadout, etc. for the Wingmate character.">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- New macro with Yaki face implants. -->
            <create_cue_actor name="$WingmateActor" cue="$MissionCue" macro="character_yaki_male_plot_wingmate_macro">
              <page exact="10101"/>
              <owner exact="faction.yaki"/>
              <skills>
                <skill type="management"  exact="0"/>
                <skill type="morale"      exact="12"/>
                <skill type="piloting"    exact="15"/>
                <skill type="engineering" exact="6"/>
                <skill type="boarding"    exact="3"/>
              </skills>
            </create_cue_actor>
            <set_entity_traits entity="$WingmateActor" missionactor="true" customhandler="true" subtitlename="true"/>
            <set_entity_overrides entity="$WingmateActor" icon="'pilot'"/>
            <set_value name="$WingmateActor.$MissionCue" exact="$MissionCue"/>

            <create_loadout result="$WingmateYakiLoadout">
              <macros>
                <engine macro="engine_arg_m_combat_01_mk3_macro" path="../con_engine_01"/>
                <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_05"/>
                <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_04"/>
                <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_03"/>
                <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_02"/>
                <weapon macro="weapon_gen_m_laser_01_mk2_macro" path="../con_primaryweapon_01"/>
                <shield macro="shield_par_m_standard_01_mk2_macro" path="../con_shield_front_r"/>
                <shield macro="shield_par_m_standard_01_mk2_macro" path="../con_shield_front_l"/>
                <turret macro="turret_arg_m_laser_01_mk1_macro" path="../con_turret_l01"/>
                <turret macro="turret_arg_m_laser_01_mk1_macro" path="../con_turret_r01"/>
              </macros>
              <ammunition>
                <ammunition macro="countermeasure_flares_01_macro" exact="8"/>
                <ammunition macro="ship_gen_xs_lasertower_01_a_macro" exact="20"/>
              </ammunition>
              <software>
                <software ware="software_dockmk2"/>
                <software ware="software_flightassistmk1"/>
                <software ware="software_scannerlongrangemk2"/>
                <software ware="software_scannerobjectmk2"/>
                <software ware="software_targetmk1"/>
                <software ware="software_trademk1"/>
              </software>
              <virtualmacros>
                <thruster macro="thruster_gen_m_combat_01_mk3_macro"/>
              </virtualmacros>
              <crew>
                <crew role="marine" exact="0"/>
                <crew role="service" exact="9"/>
              </crew>
            </create_loadout>
          </actions>
        </cue>

        <library name="Spawn_Attack_Wave" purpose="run_actions">
          <params>
            <param name="AttackTarget"/>
            <param name="AdditionalTargetGroup" default="null" comment="If this is supplied, the attackers will spread out evenly and not just focus the AttackTarget."/>
            <param name="Faction"/>
            <param name="MissionCue"/>
            <param name="Sector"/>
            <param name="ShipMacros"/>
            <param name="SpawnPosition"/>
            <param name="AllowOtherTargets" default="true"/>
          </params>
          <actions>
            <!-- Example of a list:
                        [ [ macro.ship_xen_s_fighter_01_a_macro, 2 ],
                          [ macro.ship_xen_s_fighter_02_a_macro, 1 ] ] -->
            <do_all exact="$ShipMacros.count" counter="$m">
              <do_all exact="$ShipMacros.{$m}.{2}" counter="$a">
                <create_ship name="$CurrentShip" macro="$ShipMacros.{$m}.{1}" commandeerable="false" capturable="false" missioncue="$MissionCue" sector="$Sector">
                  <owner exact="faction.xenon" overridenpc="true"/>
                  <pilot>
                    <select faction="faction.xenon" tags="tag.fighterpilot"/>
                  </pilot>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <drop ref="ship_small_xenon"/>
                  <safepos value="$SpawnPosition"/>
                </create_ship>

                <create_order id="'Wait'" object="$CurrentShip" default="true"/>

                <do_if value="$m == 1 and $a == 1" comment="First ship in the list becomes commander.">
                  <set_value name="$WaveCommander" exact="$CurrentShip"/>
                  <create_position name="$AttackTargetPosition" space="$Sector" object="$AttackTarget"/>
                  <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                    <param name="destination" value="[$Sector, $AttackTargetPosition]"/>
                  </create_order>
                  <create_order id="'Attack'" object="$CurrentShip">
                    <param name="primarytarget" value="$AttackTarget"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                    <param name="allowothertargets" value="$AllowOtherTargets"/>
                  </create_order>
                </do_if>
                <do_elseif value="@$AdditionalTargetGroup.count" comment="If this is supplied, spread out.">
                  <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                    <param name="destination" value="[$Sector, $AttackTargetPosition]"/>
                  </create_order>
                  <create_order id="'Attack'" object="$CurrentShip">
                    <param name="primarytarget" value="$AdditionalTargetGroup.random"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                    <param name="allowothertargets" value="$AllowOtherTargets"/>
                  </create_order>
                </do_elseif>
                <do_else comment="Otherwise, assist the commander.">
                  <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                    <param name="commander" value="$WaveCommander"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>
                </do_else>

                <add_to_group groupname="$AttackWave" object="$CurrentShip"/>
              </do_all>
            </do_all>
            <return value="$AttackWave"/>
          </actions>
        </library>

        <!-- Patch cue that gives the cover ability back to the player if they already completed the plot before the cover button feature was added. -->
        <cue name="Patch_Return_Cover_Ability" onfail="cancel">
          <conditions>
            <!-- Depending on the path the player took through the plot, one of two ships could have originally had the cover ability, but they're both going to be $CoverShip. -->
            <check_value value="@$CoverShip.isoperational and $CoverShip.isplayerowned"/>
            <check_any>
              <!-- Before the cover button was added, the cover ability used to be taken away in either of the following two cues. -->
              <check_value value="Ch22_C_1_Player_Attacked_Station.state == cuestate.complete"/>
              <check_value value="Ch22_C_Clean_Up_Mission.state == cuestate.cancelled"/>
            </check_any>
          </conditions>
          <actions>
            <signal_cue_instantly cue="Cover_Handler_v2" param="table[$CoverShip = $CoverShip,
                                                                      $CoverFaction = faction.yaki ]"/>
          </actions>
        </cue>

        <cue name="Patch_Transition_To_New_Cover_Handler" onfail="cancel" version="2">
          <conditions>
            <check_value value="$PatchCoverHandler?"/>
          </conditions>
          <actions>
            <signal_cue_instantly cue="Cover_Handler_v2" param="table[$CoverShip = $CoverShip,
                                                                      $CoverFaction = faction.yaki ]"/>
            <remove_value name="$PatchCoverHandler"/>
          </actions>
          <patch sinceversion="2" comment="The old cover handler restricted NPC assignment, but that is no longer necessary">
            <do_if value="$CoverShip.isoperational">
              <set_object_npc_assignment_restricted object="$CoverShip" restricted="false"/>
            </do_if>
          </patch>
        </cue>

        <cue name="DEBUG_Old_Cover">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue_instantly cue="Cover_Handler" param="table[$CoverShip = player.ship,
                                                                   $CoverFaction = faction.yaki,
                                                                   $TriggerFactionList = [faction.yaki, faction.xenon]
                                                                   ]"/>
          </actions>
        </cue>

        <cue name="DEBUG_New_Cover_Ability">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue_instantly cue="Cover_Handler_v2" param="table[$CoverShip = player.ship,
                                                                      $CoverFaction = faction.yaki ]"/>
          </actions>
        </cue>

        <cue name="Cover_Handler_v2" comment="New version with cover activation button in the ship menu.">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$CoverShip"          exact="event.param.$CoverShip"/>
            <set_value name="$CoverFaction"       exact="event.param.$CoverFaction"/>

            <create_list name="$TriggerShips"/>

            <!-- No need to restrict npc assignment in this new version of the cover handler, because only the player as pilot can activate the cover anyway. -->

            <!--event.param = [$Object, $Faction, $HasCooldown(optional)]-->
            <signal_cue_instantly cue="md.Cover.RegisterCoverAbility" param="[$CoverShip, $CoverFaction]"/>
            <debug_text text="$CoverShip.knownname + ' gained ability to engage cover via ship menu button.'" chance="$DebugChance"/>

            <!-- If we just transitioned from the old cover handler to this version, and cover is currently active, we don't want the player to suddenly lose it. -->
            <do_if value="$PatchCoverActive?">
              <signal_cue_instantly cue="md.Cover.TriggerCover" param="[$CoverShip, $CoverFaction]"/>
              <remove_value name="$PatchCoverActive"/>
            </do_if>

            <do_if value="Ch19_1_Boso_Speak_XenonCover.state != cuestate.waiting">
              <cancel_cue cue="Cover_Handler_v2_Proximity_Dialog" comment="Prevents the unneccessary proximity check"/>
            </do_if>
          </actions>
          <cues>

            <cue name="Cover_Handler_v2_Proximity_Dialog" checkinterval="3s" instantiate="true">
              <conditions>
                <check_value value="$CoverShip.sector != null"/>
                <check_value value="$CoverShip.pilot == player.entity"/>
                <check_value value="(not $CoverTutorialRepeated?) or ($CoverShip.coverowner == $CoverFaction)"/>
                <check_any>
                  <count_stations result="$TriggerStations"
                                trueowner="faction.xenon"
                                space="$CoverShip.sector"
                                checkoperational="true" min="1">
                    <match_distance max="$CoverShip.maxradarrange * 0.8" object="$CoverShip"/>
                  </count_stations>
                  <count_ships result="$TriggerShips"
                               trueowner="faction.xenon"
                               space="$CoverShip.sector" masstraffic="false"
                               checkoperational="true" min="2" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]"
                               comment="min = 2 should filter out scouts and stray ships">
                    <match_distance max="$CoverShip.maxradarrange * 0.8" object="$CoverShip"/>
                    <match excluded="$CoverShip"/>
                  </count_ships>
                </check_any>
              </conditions>
              <actions>
                <debug_text text="$CoverShip.knownname + ' has nearby $TriggerShips: ' + @$TriggerShips + ' or $TriggerStations: ' + @$TriggerStations" chance="$DebugChance"/>

                <!-- If Boso hasn't commented yet and cover is active, let him do it and complete the cue. -->
                <do_if value="$CoverShip.coverowner == $CoverFaction">
                  <debug_text text="'Cover is active, playing dialog.'" chance="$DebugChance"/>
                  <signal_cue cue="Ch19_1_Boso_Speak_XenonCover" check="false"/>
                  <cancel_cue cue="static" comment="We don't want the check to keep running when Boso has spoken"/>
                </do_if>

                <!-- Else, repeat the cover tutorial, unless it already has been repeated or is still running. -->
                <do_elseif value="not $CoverTutorialRepeated?">
                  <debug_text text="'Cover is not active, repeating cover tutorial.'" chance="$DebugChance"/>
                  <signal_cue_instantly cue="md.Tutorial_global.UseCoverAbility" param="$CoverShip" check="false" comment="Will automatically fail if cover tutorial is still running, which is good."/>
                  <set_value name="$CoverTutorialRepeated"/>
                </do_elseif>
              </actions>
            </cue>

            <cue name="Disable_Current_Cover_Handler_v2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.Cover.UnregisterCoverAbility" param="$CoverShip"/>
                <reset_cue cue="Cover_Handler_v2"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Signal e.g. like this: <signal_cue_instantly cue="Cover_Handler" param="table[$CoverShip = $OldYakiShip,
                                                                                           $CoverFaction = faction.yaki,
                                                                                           $TriggerFactionList = [faction.yaki, faction.xenon] ]"/>-->
        <cue name="Cover_Handler" comment="Only one ship is allowed to have the Yaki cover at any given time." version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$CoverShip"          exact="event.param.$CoverShip"/>
            <set_value name="$CoverFaction"       exact="event.param.$CoverFaction"/>
            <set_value name="$TriggerFactionList" exact="event.param.$TriggerFactionList"/>

            <create_list name="$TriggerShips"/>

            <set_object_npc_assignment_restricted object="$CoverShip" restricted="true"/>
          </actions>
          <patch sinceversion="2">
            <!-- If cover is currently active, keep it active as we transition to the new cover handler-->
            <do_if value="(Deactivate_Cover.state == cuestate.waiting) and (Cover_Timeout.state == cuestate.waiting)">
              <set_value name="$PatchCoverActive"/>
            </do_if>
            <set_value name="$PatchCoverHandler"/>
            <reset_cue cue="Cover_Handler"/>
          </patch>
          <cues>

            <cue name="Cover_Handler_Parent">
              <cues>

                <cue name="Cover_Activation_Proximity_Check" checkinterval="3s">
                  <conditions>
                    <check_value value="$CoverShip.sector != null"/>
                    <check_any>
                      <count_stations result="$TriggerStations"
                                    trueowner="$TriggerFactionList"
                                    space="$CoverShip.sector"
                                    checkoperational="true" min="1">
                        <match_distance max="$CoverShip.maxradarrange * 0.8" object="$CoverShip"/>
                      </count_stations>
                      <count_ships result="$TriggerShips"
                                   trueowner="$TriggerFactionList"
                                   space="$CoverShip.sector" masstraffic="false"
                                   checkoperational="true" min="1" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
                        <match_distance max="$CoverShip.maxradarrange * 0.8" object="$CoverShip"/>
                        <match excluded="$CoverShip"/>
                      </count_ships>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="$CoverShip.knownname + ' has nearby $TriggerShips: ' + $TriggerShips + ' or $TriggerStations ' + $TriggerStations" chance="$DebugChance"/>
                    <signal_cue cue="Activate_Cover"/>
                  </actions>
                </cue>

                <!--<cue name="Cover_Activation_Sector_Check">
                  <conditions>
                    <event_object_changed_sector object="$CoverShip"/>
                    <check_value value="$TriggerFactionList.indexof.{event.param.owner}"/>
                    <check_value value="not $TriggerFactionList.indexof.{event.param2.owner}"/>
                  </conditions>
                  <actions>
                    <debug_text text="$CoverShip.knownname + ' entered sector owned by $TriggerFactionList.'" chance="$DebugChance"/>
                    <signal_cue cue="Activate_Cover"/>
                  </actions>
                </cue>-->

                <cue name="Activate_Cover">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--event.param = [$object, $faction]-->
                    <signal_cue_instantly cue="md.Cover.TriggerCover" param="[$CoverShip, $CoverFaction]"/>
                    <debug_text text="$CoverShip.knownname + ' gained cover.'" chance="$DebugChance"/>

                    <do_if value="player.entity.hascontext.{$CoverShip}">
                      <do_if value="($CoverShip.sector.owner == faction.xenon)">
                        <signal_cue cue="Ch19_1_Boso_Speak_XenonCover" check="false"/>
                      </do_if>
                      <do_else>
                        <do_for_each in="$TriggerShips" name="$CurrentTriggerShip">
                          <do_if value="($CurrentTriggerShip.owner == faction.xenon)">
                            <signal_cue cue="Ch19_1_Boso_Speak_XenonCover" check="false"/>
                            <break/>
                          </do_if>
                        </do_for_each>
                      </do_else>
                    </do_if>

                    <!--TODO @Owen #cover Should Ch19_1_Boso_Speak_XenonCover be triggered when the player enters the ship and gains cover for the first time. Currently only if inside at that moment-->

                    <!-- Clear $TriggerShips for next proximity check. -->
                    <!--<create_list name="$TriggerShips"/>-->

                    <!-- TODO: Is there a more elegant way to have an event and an interval check condition at the same time? -->
                    <cancel_cue cue="Cover_Activation_Proximity_Check"/>
                    <!--<cancel_cue cue="Cover_Activation_Sector_Check"/>-->
                  </actions>
                  <cues>

                    <cue name="Cover_Deactivation_Proximity_Check" checkinterval="3s">
                      <conditions>
                        <check_value value="$CoverShip.sector != null"/>
                        <!--<check_value value="not $TriggerFactionList.indexof.{$CoverShip.sector.owner}"/>-->
                        <count_stations result="$TriggerStations"
                                        trueowner="$TriggerFactionList"
                                        space="$CoverShip.sector"
                                        checkoperational="true" exact="0">
                          <match_distance max="$CoverShip.maxradarrange" object="$CoverShip"/>
                        </count_stations>
                        <count_ships result="$TriggerShips"
                                     trueowner="$TriggerFactionList"
                                     space="$CoverShip.sector" masstraffic="false"
                                     checkoperational="true" exact="0" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
                          <match_distance max="$CoverShip.maxradarrange" object="$CoverShip"/>
                          <match excluded="$CoverShip"/>
                        </count_ships>
                      </conditions>
                      <actions>
                        <!-- Clear $TriggerShips for next proximity check. -->
                        <!--<create_list name="$TriggerShips"/>-->

                        <debug_text text="$CoverShip.knownname + ' has no nearby $TriggerShips: ' + $TriggerShips + ' or $TriggerStations ' + $TriggerStations" chance="$DebugChance"/>
                        <!--<debug_text text="$CoverShip.knownname + ' has no nearby $TriggerShips: ' + $TriggerShips + ', and is not in a sector owned by $TriggerFactionList.'" chance="$DebugChance"/>-->
                        <signal_cue cue="Deactivate_Cover"/>
                      </actions>
                    </cue>

                    <!--<cue name="Cover_Deactivation_Sector_Check">
                      <conditions>
                        <event_object_changed_sector object="$CoverShip"/>
                        <check_value value="not $TriggerFactionList.indexof.{event.param.owner}"/>
                      </conditions>
                      <actions>
                        <debug_text text="$CoverShip.knownname + ' left sector owned by ' + $TriggerFactionList" chance="$DebugChance"/>
                        <signal_cue cue="Deactivate_Cover"/>
                      </actions>
                    </cue>-->

                    <cue name="Cover_Deactivation_Attack_Check">
                      <conditions>
                        <event_object_attacked_object object="$CoverShip"/>
                        <check_value value="$TriggerFactionList.indexof.{event.param.owner}"/>
                      </conditions>
                      <actions>
                        <debug_text text="$CoverShip.knownname + ' attacked object owned by ' + $TriggerFactionList" chance="$DebugChance"/>
                        <signal_cue cue="Cover_Timeout"/>
                      </actions>
                    </cue>

                    <cue name="Deactivate_Cover">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_objects object="$CoverShip" param="'LoseCover'"/>
                        <debug_text text="$CoverShip.knownname + ' lost cover.'" chance="$DebugChance"/>
                      </actions>
                      <delay exact="5s" comment="To prevent infinite loops."/>
                      <actions>
                        <reset_cue cue="Cover_Handler_Parent"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Cover_Timeout">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Cover_Timeout signalled. Disabling cover and starting timer.'" chance="$DebugChance"/>
                <signal_objects object="$CoverShip" param="'LoseCover'"/>
                <cancel_cue cue="Cover_Handler_Parent"/>
              </actions>
              <cues>

                <cue name="Cover_Timeout_Delay">
                  <delay exact="1min"/>
                  <actions>
                    <reset_cue cue="Cover_Handler_Parent"/>
                    <reset_cue cue="parent"/>
                  </actions>
                </cue>

                <cue name="Cover_Timeout_Attack_Check">
                  <conditions>
                    <event_object_attacked_object object="$CoverShip"/>
                    <check_value value="$TriggerFactionList.indexof.{event.param.owner}"/>
                  </conditions>
                  <actions>
                    <debug_text text="$CoverShip.knownname + ' attacked object owned by ' + $TriggerFactionList + '. Resetting timeout duration.'" chance="$DebugChance"/>
                    <reset_cue cue="Cover_Timeout_Delay"/>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <reset_cue cue="this"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Disable_Current_Cover_Handler">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_object_destroyed object="$CoverShip"/>
                </check_any>
              </conditions>
              <actions>
                <set_object_npc_assignment_restricted object="$CoverShip" restricted="false"/>

                <signal_objects object="$CoverShip" param="'LoseCover'"/>
                <debug_text text="$CoverShip.knownname + ' lost cover. Cover handler about to be reset.'" chance="$DebugChance"/>

                <reset_cue cue="parent"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="DEBUG_Create_Old_Yaki_Ship">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_ship name="$OldYakiShip" macro="macro.ship_yak_s_fighter_01_a_macro" sector="player.sector" missioncue="namespace" capturable="true">
              <owner exact="faction.player"/>
              <loadout>
                <level exact="0.4"/>
              </loadout>
              <safepos object="player.ship"/>
            </create_ship>
          </actions>
          <cues>

            <cue name="DEBUG_Activate_Cover" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="Cover_Handler" param="table[$CoverShip = $OldYakiShip,
                                                                                    $CoverFaction = faction.yaki,
                                                                                    $TriggerFactionList = [faction.yaki, faction.xenon] ]"/>
              </actions>
            </cue>

            <cue name="DEBUG_Deactivate_Cover" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Disable_Current_Cover_Handler"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- *** STORY MANAGER INTERACTION *** -->

        <cue name="Story_Activation_Manager">
          <cues>

            <!-- Cues checking preconditions, if any -->

            <cue name="Check_For_Terran_Cadet_Gamestart_Ending">
              <conditions>
                <event_cue_signalled cue="md.GS_Terran1.Ch2_Clean_Up_Terran_Cadet_Gamestart_Mission"/>
                <check_value value="not $HasCustomGamestartSkip"/>
              </conditions>
              <actions>
                <debug_text text="'Yaki story activates because the Terran Cadet GS mission is finished.'" chance="$DebugChance"/>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <cue name="Check_For_Friendly_Relations">
              <conditions>
                <event_player_relation_changed faction="faction.terran"/>
                <check_value value="event.param2.{1} ge $RelationThreshold"/>
                <check_value value="player.module != 'x4ep1_gamestart_terran1'" comment="Only if the player is NOT the Terran Cadet."/>
                <check_value value="not $HasCustomGamestartSkip"/>
              </conditions>
              <actions>
                <debug_text text="'Yaki story activates because of relation change.'" chance="$DebugChance"/>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <cue name="Check_For_Friendly_Initial_Relations" onfail="cancel" version="2">
              <conditions>
                <check_value value="faction.terran.relationto.{faction.player} ge $RelationThreshold"/>
                <check_value value="player.module != 'x4ep1_gamestart_terran1'" comment="Only if the player is NOT the Terran Cadet."/>
                <check_value value="not $HasCustomGamestartSkip"/>
              </conditions>
              <actions>
                <debug_text text="'Yaki story activates because the player started the game with high enough relations.'" chance="$DebugChance"/>
                <signal_cue cue="Activate_Story"/>
              </actions>
              <patch sinceversion="2" state="cancelled" comment="$RelationThreshold was lowered, so we want to check if the requirements are met when the game loads">
                <do_if value="Activate_Story.state == cuestate.waiting">
                  <reset_cue cue="this"/>
                </do_if>
              </patch>
            </cue>

            <cue name="Handle_Custom_Gamestart_Skip" onfail="cancel">
              <conditions>
                <check_value value="$HasCustomGamestartSkip"/>
              </conditions>
              <cues>
                <cue name="Handle_Custom_Gamestart_Skip_Activate" checkinterval="50ms" version="2">
                  <conditions>
                    <check_value value="@md.$PersistentCharacters.$DalBusta.exists"/>
                  </conditions>
                  <actions>

                    <!--Story completed states-->
                    <do_if value="$story_yaki_complete">
                      <signal_cue cue="Setup_Secret_Service_Contact"/>

                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_yaki_gladius"/>
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_yaki_amplifier"/>

                      <set_faction_relation_locked faction="faction.yaki" locked="false"/>
                      <set_faction_relation faction="faction.yaki" otherfaction="faction.argon" value="faction.yaki.relation.neutral.mid"/>
                      <set_faction_relation faction="faction.yaki" otherfaction="faction.antigone" value="faction.yaki.relation.neutral.mid"/>
                      <set_faction_relation faction="faction.yaki" otherfaction="faction.teladi" value="faction.yaki.relation.neutral.mid"/>
                      <set_faction_relation faction="faction.yaki" otherfaction="faction.ministry" value="faction.yaki.relation.neutral.mid"/>

                      <do_if value="md.$SplitFactions?">
                        <do_for_each in="md.$SplitFactions" name="$CurrentFaction">
                          <set_faction_relation faction="faction.yaki" otherfaction="$CurrentFaction" value="faction.yaki.relation.neutral.mid"/>
                        </do_for_each>
                      </do_if>

                      <!-- Activate the Yaki Diplomat -->
                      <run_actions ref="md.Diplomacy.Diplomacy_ActivateFactionLibrary">
                        <param name="Faction" value="faction.yaki"/>
                        <param name="DiplomatCapable" value="true"/>
                        <param name="EventCapable" value="false"/>
                      </run_actions>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <run_actions ref="md.Diplomacy.Diplomacy_ActivateFactionLibrary">
                      <param name="Faction" value="faction.yaki"/>
                      <param name="DiplomatCapable" value="true"/>
                      <param name="EventCapable" value="false"/>
                    </run_actions>
                  </patch>
                </cue>
              </cues>
            </cue>

            <!-- Cue which activates the story (all preconditions met) -->

            <cue name="Activate_Story">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$WingmateOrdersAvailable" comment="Enables giving orders to the wingmate via comms. Currently necessary to prevent the player from sending the wingmate away during the Terran Cadet gamestart mission."/>

                <signal_cue cue="Offer_Management"/>
                <cancel_cue cue="Story_Activation_Manager"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- *** WINGMATE *** -->

        <cue name="DEBUG_Setup_Wingmate" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <include_actions ref="Setup_Wingmate"/>
          </actions>
        </cue>

        <library name="Setup_Wingmate">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Setup_Wingmate signalled.'" chance="$DebugChance"/>
            <do_if value="not @$WingmateShip.exists">
              <!-- Before creating the ship with the wingmate as pilot, despawn the NPC if he exists. Relevant for when he was placed on a station, and the ship gets spawned the non-conversation way. -->
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $WingmateActor, $MissionCue]"/>

              <do_if value="$WingmateActor.owner == faction.terran">
                <create_ship name="$WingmateShip" macro="macro.ship_ter_s_heavyfighter_01_a_macro" sector="player.sector" missioncue="namespace" capturable="false">
                  <owner exact="faction.terran" overridenpc="true" />
                  <pilot actor="$WingmateActor"/>
                  <loadout loadout="md.Story_Yaki.Start.$WingmateLoadout"/>
                  <!-- Paint mod: Solset Dapple (Terran Camo 1) -->
                  <paint ware="ware.paintmod_0118"/>
                  <safepos object="player.container" x="100m" z="-250m" y="100m"/>
                </create_ship>
                <set_object_name object="$WingmateShip" page="30225" line="201" comment="Velvet Thunder"/>
              </do_if>
              <do_else>
                <create_ship name="$WingmateShip" macro="macro.ship_yak_m_corvette_01_a_macro" sector="player.sector" missioncue="namespace" capturable="false">
                  <owner exact="faction.yaki" overridenpc="true" />
                  <pilot actor="$WingmateActor"/>
                  <loadout loadout="$WingmateYakiLoadout"/>
                  <equipmentmods>
                    <engine ware="ware.mod_engine_rotationthrust_01_mk3"/>
                    <shield ware="ware.mod_shield_capacity_02_mk3"/>
                    <ship ware="ware.mod_ship_mass_01_mk3"/>
                  </equipmentmods>
                  <!-- Paint mod: Solset Canopy (Terran Camo 2) -->
                  <paint ware="ware.paintmod_0119"/>
                  <safepos object="player.container" x="100m" z="-250m" y="100m"/>
                </create_ship>
                <set_object_name object="$WingmateShip" page="30226" line="204" comment="Gumption's Gambit"/>
              </do_else>
              <!--<signal_objects object="$WingmateActor" param="'npc_state_reinit'"/>-->
            </do_if>
            <do_else>
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $WingmateActor, $MissionCue]" comment="Remove all potentially conflicting placement requests."/>
              <do_if value="$WingmateShip.pilot != $WingmateActor">
                <assign_control_entity object="$WingmateShip" actor="$WingmateActor" post="controlpost.aipilot" transfer="true"/>
              </do_if>
              <do_if value="@$WingmateShip.sector != @player.ship.sector">
                <warp object="$WingmateShip" sector="player.ship.sector">
                  <safepos object="player.ship" x="100m" z="-250m" y="100m"/>
                </warp>
              </do_if>
            </do_else>

            <!-- Switch cutscene key. The actor is now placed in the world. Update both story_yaki and the current script. -->
            <set_value name="md.Story_Yaki.Start.$WingmateCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>
            <set_value name="$WingmateCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>

            <!-- TODO: Find a way to give the player 100% info on this ship. set_object_scanned only works up to the level of the player's scanner and triggers the visual scan effect. -->
            <!--<set_object_scanned object="$WingmateShip"/>-->
            <set_object_min_hull object="$WingmateShip" exact="10"/>

            <set_object_relation_behaviour object="$WingmateShip" disable="false"/>

            <cancel_all_orders object="$WingmateShip"/>
            <create_order id="'Wait'" object="$WingmateShip" default="true"/>
            <do_if value="player.ship">
              <debug_text text="'Player ship detected. Wingmate moves in to protect.'" chance="$DebugChance"/>
              <set_value name="$CurrentPlayerShip" exact="player.ship"/>
              <create_order id="'ProtectShip'" object="$WingmateShip" immediate="true">
                <param name="target" value="$CurrentPlayerShip"/>
              </create_order>
            </do_if>

            <!-- If there's a mail pointing the player to the wingmate's position on a station, remove it. -->
            <do_if value="@$WingmateRecoveryMail">
              <!-- TODO: If the mail ends up having to stay high priority, pending discussion, find correct action to remove mail. -->
            </do_if>

            <!--  This library also gets signalled from gs_terran1, so we need to be specific. -->
            <set_value name="md.Story_Yaki.Start.$WingmateShip" exact="$WingmateShip" comment="To guarantee a smooth handover from gs_terran1 to story_yaki."/>

            <do_if value="md.Story_Yaki.Activate_Wingmate_Handlers.state == cuestate.waiting">
              <signal_cue cue="md.Story_Yaki.Activate_Wingmate_Handlers"/>
            </do_if>
            <reset_cue cue="md.Story_Yaki.Wingmate_Handlers"/>
          </actions>
        </library>

        <cue name="Activate_Wingmate_Handlers">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Wingmate_Handlers activated.'" chance="$DebugChance"/>
          </actions>
          <cues>

            <cue name="Wingmate_Handlers">
              <cues>

                <cue name="Wingmate_Leave_Player">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <!-- Terran Wingmate -->
                      <check_all>
                        <event_object_changed_sector object="player.entity"/>
                        <check_value value="event.param != null" comment="sector is null if the player is on a superhighway"/>
                        <check_value value="event.param != $TerranOutpostSector"/>
                        <check_value value="event.param != $YakiExitSector"/>
                        <check_value value="event.param.owner != faction.terran"/>
                        <check_value value="$WingmateActor.owner == faction.terran"/>
                      </check_all>
                      <check_all>
                        <event_player_relation_changed faction="faction.terran"/>
                        <check_value value="(event.param2.{1} le faction.terran.relation.killmilitary.max)" comment="We only care about the new relation being below the threshold.
                                                                                                       Sometimes the mission might force the Wingmate to join the player despite the relation already being below the threshold,
                                                                                                       and in that case we want the Wingmate to stay until the player does something bad again."/>
                        <check_value value="$WingmateActor.owner == faction.terran"/>
                      </check_all>
                      <!-- Yaki Wingmate -->
                      <check_all>
                        <event_object_changed_sector object="player.entity"/>
                        <check_value value="event.param != null" comment="sector is null if the player is on a superhighway"/>
                        <check_value value="event.param != $YakiHomeSector"/>
                        <check_value value="$WingmateActor.owner == faction.yaki"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="$WingmateShip.exists">
                      <debug_text text="'Wingmate leaves player.'" chance="$DebugChance"/>

                      <do_if value="event.name == 'event_object_changed_sector'">
                        <do_if value="$WingmateActor.owner == faction.terran">
                          <signal_cue cue="Wingmate_Leave_Player_Speak"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Yaki_Wingmate_Leave_Player_Speak"/>
                        </do_else>
                      </do_if>
                      <do_elseif value="event.name == 'event_player_relation_changed'">
                        <signal_cue cue="Wingmate_Player_Declared_War_Speak"/>
                      </do_elseif>

                      <set_value name="$WingmateCutsceneKey" exact="table[$key = 'ShowCharacter']" comment="Fallback for when he's not placed anywhere."/>

                      <cancel_all_orders object="$WingmateShip"/>
                      <set_object_min_hull object="$WingmateShip" exact="0" comment="We don't want the ship to infinitely stall enemy fleets when its order is interrupted."/>

                      <run_actions ref="Find_Despawn_Station" result="$WingmateDespawnStation">
                        <param name="Ship" value="$WingmateShip"/>
                        <param name="IdealSector" value="if ($WingmateActor.owner == faction.terran) then $SecretServiceSector else $YakiHomeSector"/>
                      </run_actions>

                      <do_if value="$WingmateDespawnStation">
                        <debug_text text="'$WingmateDespawnStation: ' + $WingmateDespawnStation.knownname + ' in sector ' + $WingmateDespawnStation.sector.knownname" chance="$DebugChance"/>

                        <create_order id="'Wait'" object="$WingmateShip" default="true"/>
                        <create_order id="'DockAndWait'" object="$WingmateShip">
                          <param name="destination" value="$WingmateDespawnStation"/>
                        </create_order>
                        <create_order id="'MoveToObject'" object="$WingmateShip" immediate="true">
                          <param name="destination" value="$WingmateDespawnStation"/>
                          <param name="noattackresponse" value="true"/>
                        </create_order>

                        <find_object_component name="$WingmateDespawnStationDock" object="$WingmateDespawnStation" checkoperational="true" class="class.walkablemodule" haswalkableroom="true"/>
                      </do_if>
                      <do_else comment="This case shouldn't be possible, but keep it to be sure.">
                        <debug_text text="'No despawn station found. This is somewhat troubling.'" chance="$DebugChance"/>
                        <create_order id="'Wait'" object="$WingmateShip" default="true"/>
                      </do_else>
                    </do_if>
                    <do_else>
                      <debug_text text="'Wingmate would leave the player, but does not exist.'" chance="$DebugChance"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Wingmate_Join_Player">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <!-- Terran Wingmate -->
                          <check_all>
                            <event_object_changed_sector object="player.entity"/>
                            <check_value value="event.param != null" comment="sector is null if the player is on a superhighway"/>
                            <check_value value="(event.param == $TerranOutpostSector) or (event.param == $YakiExitSector) or (event.param.owner == faction.terran)"/>
                            <check_value value="$WingmateActor.owner == faction.terran"/>
                            <check_value value="not md.$TerranWingmateDND.count"/>
                          </check_all>
                          <check_all>
                            <event_player_relation_changed faction="faction.terran"/>
                            <check_value value="event.param2.{1} gt faction.terran.relation.killmilitary.max" comment="new relation"/>
                            <check_value value="event.param2.{2} le faction.terran.relation.killmilitary.max" comment="old relation"/>
                            <check_value value="$WingmateActor.owner == faction.terran"/>
                            <check_value value="not md.$TerranWingmateDND.count"/>
                          </check_all>
                          <!-- Yaki Wingmate -->
                          <check_all>
                            <event_object_changed_sector object="player.entity"/>
                            <check_value value="event.param != null" comment="sector is null if the player is on a superhighway"/>
                            <check_value value="event.param == $YakiHomeSector"/>
                            <check_value value="$WingmateActor.owner == faction.yaki"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="event.name == 'event_object_changed_sector'">
                          <signal_cue cue="Wingmate_Join_Player_Speak"/>
                        </do_if>
                        <do_elseif value="event.name == 'event_player_relation_changed'">
                          <signal_cue cue="Wingmate_Player_Ended_War_Speak"/>
                        </do_elseif>

                        <do_if value="$WingmateShip.exists">
                          <debug_text text="'Wingmate survived and rejoins player.'" chance="$DebugChance"/>
                          <include_actions ref="Setup_Wingmate" comment="Automatically resets Wingmate_Handlers, so no need to do it here."/>
                        </do_if>
                        <do_else>
                          <debug_text text="'Wingmate was destroyed or despawned before being able to rejoin the player, so he is now being respawned.'" chance="$DebugChance"/>
                          <include_actions ref="Setup_Wingmate" comment="Automatically resets Wingmate_Handlers, so no need to do it here."/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Wingmate_Station_Store_Ship">
                      <conditions>
                        <event_object_order_finished object="$WingmateShip"/>
                        <check_value value="$WingmateShip.hascontext.{$WingmateDespawnStation}"/>
                      </conditions>
                      <actions>
                        <!-- Get rid of critical dock order to prevent interference with actor's assignment. -->
                        <cancel_all_orders object="$WingmateShip"/>
                        <!-- Disconnect actor from the ship to allow NPC instantiation to properly take over his placement on the dock. -->
                        <dismiss_control_entity object="$WingmateShip" actor="$WingmateActor"/>
                        <remove_actor_from_room actor="$WingmateActor"/>
                        <!-- Store the ship so that we can destroy it out of sight. -->
                        <request_store_ship object="$WingmateShip.station" refobject="$WingmateShip" ship="$WingmateShip"/>
                      </actions>
                      <delay exact="15s"/>
                      <actions>
                        <destroy_object object="$WingmateShip" explosion="false"/>
                      </actions>
                    </cue>

                    <cue name="Wingmate_Station_Dock_Destroyed" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_destroyed object="$WingmateDespawnStationDock"/>
                          <event_object_hull_below_function_threshold object="$WingmateDespawnStationDock"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Wingmate despawn station dock destroyed. Searching for new station.'" chance="$DebugChance"/>

                        <run_actions ref="Find_Despawn_Station" result="$WingmateDespawnStation">
                          <param name="Ship" value="$WingmateShip"/>
                          <param name="IdealSector" value="if ($WingmateActor.owner == faction.terran) then $SecretServiceSector else $YakiHomeSector"/>
                        </run_actions>

                        <find_object_component name="$WingmateDespawnStationDock" object="$WingmateDespawnStation" checkoperational="true" class="class.walkablemodule" haswalkableroom="true"/>

                        <!-- Wingmate still in ship. -->
                        <do_if value="$WingmateShip.exists">
                          <reset_cue cue="Wingmate_Station_Store_Ship" comment="Refresh 'dock' attribute, because old dock doesn't exist anymore."/>
                          <cancel_all_orders object="$WingmateShip"/>
                          <create_order id="'MoveDie'" object="$WingmateShip">
                            <param name="atstation" value="$WingmateDespawnStation"/>
                          </create_order>
                        </do_if>
                        <!-- Wingmate already standing on station. -->
                        <do_elseif value="Wingmate_Station_Guidance.state == cuestate.complete">
                          <set_value name="$WingmateRelocationCount" operation="add"/>
                          <reset_cue cue="Wingmate_Station_Guidance"/>
                        </do_elseif>
                      </actions>
                    </cue>

                    <cue name="Wingmate_Setup_On_Station">
                      <conditions>
                        <event_object_destroyed object="$WingmateShip" comment="MoveDie destroys the ship once it's docked at the $WingmateDespawnStation."/>
                      </conditions>
                      <actions>
                        <set_value name="$WingmateRelocationCount" exact="0"/>
                      </actions>
                      <cues>

                        <cue name="Wingmate_Station_Guidance">
                          <delay exact="1s"/>
                          <actions>
                            <debug_text text="'Spawning wingmate on dock.'" chance="$DebugChance"/>
                            <find_npc_slot name="$WingmateDespawnStationSlot" excludeblocked="false" excludefilled="false" object="$WingmateDespawnStationDock" tags="tag.stand"/>
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $WingmateActor,
                                                                                                  table[
                                                                                                  $requestercue = $MissionCue,
                                                                                                  $location = $WingmateDespawnStationSlot,
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <do_if value="$WingmateRelocationCount == 0">
                              <write_incoming_message result="$WingmateRecoveryMail" source="{30225,101}" highpriority="true" object="$WingmateDespawnStationSlot.component" interaction="guidance" title="{30225,1040}" text="{30225,1041}" comment="Original guidance mail."/>
                            </do_if>
                            <do_elseif value="$WingmateRelocationCount == 1">
                              <write_incoming_message result="$WingmateRecoveryMail" source="{30225,101}" highpriority="true" object="$WingmateDespawnStationSlot.component" interaction="guidance" title="{30225,1040}" text="{30225,1042}" comment="Guidance mail after relocation 1."/>
                            </do_elseif>
                            <do_elseif value="$WingmateRelocationCount == 2">
                              <write_incoming_message result="$WingmateRecoveryMail" source="{30225,101}" highpriority="true" object="$WingmateDespawnStationSlot.component" interaction="guidance" title="{30225,1040}" text="{30225,1043}" comment="Guidance mail after relocation 2."/>
                            </do_elseif>
                            <do_elseif value="$WingmateRelocationCount ge 3">
                              <write_incoming_message result="$WingmateRecoveryMail" source="{30225,101}" highpriority="true" object="$WingmateDespawnStationSlot.component" interaction="guidance" title="{30225,1040}" text="{30225,1044}" comment="Guidance mail after relocation 3+."/>
                            </do_elseif>
                          </actions>
                          <cues>

                            <cue name="Wingmate_Station_Conversation_Section_Main" instantiate="true">
                              <conditions>
                                <check_any>
                                  <event_conversation_started actor="$WingmateActor"/>
                                  <event_conversation_next_section actor="$WingmateActor" section="wingmate_station"/>
                                  <event_conversation_returned_to_section actor="$WingmateActor" section="wingmate_station"/>
                                </check_any>
                                <check_value value="Wingmate_Station_Conversation_Section_Follow.state == cuestate.waiting"/>
                              </conditions>
                              <actions>
                                <allow_conversation_escape enabled="true"/>

                                <do_if value="event.name == 'event_conversation_started'">
                                  <do_any>
                                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226401" comment="(serious, as if avoiding eye contact)hey."/>
                                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30284121" comment="(Variant 1)How did it go?"/>
                                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30284123" comment="(Variant 2)Good to have you back."/>
                                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30284124" comment="(Variant 3)My wingmate's back!"/>
                                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30225107" comment="All set?"/>
                                  </do_any>
                                </do_if>

                                <do_elseif value="event.param2 == 'powers'">
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226417" comment="Powers? I got none. I've shown off my 'superior manoeuvres' from time to time and just got lucky that no Xenon decided to turn me into scrap."/>
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226418" comment="All these cybernetics do for me is make me look like a damn outlaw. No chance Earth is going to take me back."/>
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226419" comment="At least these Yaki aren't going to kill us as long as you have access to Sol, and as long as I act like some Xenon whisperer prodigy."/>
                                </do_elseif>

                                <do_elseif value="event.param2 == 'orcanic'">
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226420" comment="That woman? Despite appearances, she's not the Yaki leader, and it shows."/>
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226421" comment="They don't trust anyone with power. But someone's gotta keep them away from each other's throats, and that's how she got to where she is now."/>
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226422" comment="Helped me out a great deal, but that doesn't excuse what they did to us, to the outpost, and to Sol."/>
                                </do_elseif>

                                <do_elseif value="event.param2 == 'disappear'">
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226423" comment="Obelisk knocking me out is why I disappeared, that much is true."/>
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226424" comment="But these people didn't save me out of the goodness of their hearts."/>
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226425" comment="They spied on me, on us, observed us like lab rats, and when they thought they'd found a candidate for their twisted augmentations, they snatched me away."/>
                                  <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226426" comment="(sighs)OK, not all of them are like that; just the hard-liners. But those are gaining in influence by the minute."/>
                                </do_elseif>

                                <do_if value="$WingmateActor.owner == faction.yaki">
                                  <add_player_choice text="{30226,4038}" section="wingmate_in_flight" choiceparam="'powers'" position="top_left"/>
                                  <add_player_choice text="{30226,4039}" section="wingmate_in_flight" choiceparam="'orcanic'" position="left"/>
                                  <add_player_choice text="{30226,4040}" section="wingmate_in_flight" choiceparam="'disappear'" position="bottom_left"/>
                                </do_if>

                                <add_player_choice text="{30225,1034}" section="wingmate_follow" position="top_left" comment="Wait for me outside."/>
                                <add_player_choice text="{1002,21}" section="g_cancel" position="bottom_right" comment="\(Close\)"/>
                              </actions>
                            </cue>

                            <cue name="Wingmate_Station_Conversation_Section_Follow">
                              <conditions>
                                <event_conversation_next_section actor="$WingmateActor" section="wingmate_follow"/>
                              </conditions>
                              <actions>
                                <speak actor="$WingmateActor" line="30284144" priority="100" comment="I'm on my way."/>

                                <!-- These variables are needed by event_entity_left. -->
                                <set_value name="$WingmateSpace" exact="$WingmateActor.station"/>

                                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $WingmateActor, table[
                                                                                                                                  $requestercue = $MissionCue,
                                                                                                                                  $priority = 100,
                                                                                                                                  $location = 'disconnect',
                                                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                              </actions>
                              <cues>

                                <cue name="Wingmate_Station_Despawn_v2">
                                  <conditions>
                                    <event_object_changed_attention object="$WingmateActor" attention="attention.unknown"/>
                                  </conditions>
                                  <actions>
                                    <debug_text text="'Wingmate despawned.'" chance="$DebugChance"/>
                                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $WingmateActor, $MissionCue]" comment="Necessary or actor won't appear in the pilot seat."/>
                                  </actions>
                                  <delay exact="0.1s"/>
                                  <actions>
                                    <include_actions ref="Setup_Wingmate"/>
                                  </actions>
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Wingmate_Repair">
                  <conditions>
                    <event_object_attacked object="$WingmateShip" check="false"/>
                    <check_value value="$WingmateShip.hullpercentage le 33"/>
                    <check_value value="Wingmate_Leave_Player.state == cuestate.waiting" comment="Only if the Wingmate is supposed to escort the player."/>
                  </conditions>
                  <actions>
                    <debug_text text="'Wingmate attempts to go for repairs.'" chance="$DebugChance"/>

                    <run_actions ref="Find_Repair_Station" result="$RepairStation">
                      <param name="Ship" value="$WingmateShip"/>
                    </run_actions>

                    <do_if value="$RepairStation" comment="If no faction stations exist, there's nowhere for the Wingmate to get repairs.">
                      <find_dockingbay groupname="$RepairStationDockModules" multiple="true" object="$RepairStation" state="componentstate.operational">
                        <match_dock size="tag.dock_s"/>
                      </find_dockingbay>

                      <signal_cue cue="Wingmate_Repair_Speak" check="false" comment="The dialog cue resets itself after a while, to prevent spamming."/>

                      <cancel_all_orders object="$WingmateShip"/>
                      <create_order id="'Wait'" object="$WingmateShip" default="true"/>
                      <create_order id="'DockAndWait'" name="$WingmateRepair" object="$WingmateShip">
                        <param name="destination" value="$RepairStation"/>
                      </create_order>

                      <set_object_relation_behaviour object="$WingmateShip" disable="true"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Wingmate_Repair_Failsafe_Cooldown" comment="This means that the faction is in bad shape. Try again after a while."/>
                    </do_else>
                  </actions>
                  <cues>

                    <!-- If the order gets cancelled because the dock gets destroyed or the ship gets stopped along the way, repeat the process.-->
                    <cue name="Wingmate_Repair_Order_Cancelled_v2">
                      <conditions>
                        <check_any>
                          <event_object_order_finished object="$WingmateShip" order="$WingmateRepair"/>
                          <event_object_order_cancelled object="$WingmateShip" order="$WingmateRepair"/>
                          <event_object_docked object="$WingmateShip"/>
                        </check_any>
                        <check_value value="Wingmate_Leave_Player.state == cuestate.waiting" comment="Only if the Wingmate is supposed to escort the player."/>
                      </conditions>
                      <actions>
                        <do_if value="event.name == 'event_object_order_finished'">
                          <debug_text text="'Wingmate order to dock at repair station finished.'" chance="$DebugChance"/>
                        </do_if>
                        <do_elseif value="event.name == 'event_object_order_cancelled'">
                          <debug_text text="'Wingmate order to dock at repair station was cancelled.'" chance="$DebugChance"/>
                        </do_elseif>
                        <do_elseif value="event.name == 'event_object_docked'">
                          <debug_text text="'Wingmate successfully docked at repair station.'" chance="$DebugChance"/>
                          <signal_cue cue="Wingmate_Repair_Finished_Speak"/>
                        </do_elseif>

                        <include_actions ref="Setup_Wingmate"/>
                      </actions>
                      <delay exact="10s"/>
                      <actions>
                        <reset_cue cue="Wingmate_Repair"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Wingmate_Repair_Failsafe_Cooldown">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Wingmate_Repair"/>
                  </actions>
                  <delay exact="30min"/>
                  <actions>
                    <reset_cue cue="Wingmate_Repair"/>
                    <reset_cue cue="this"/>
                  </actions>
                </cue>

                <cue name="Wingmate_Docked" instantiate="true">
                  <conditions>
                    <event_object_docked object="$WingmateShip" check="false" comment="Might stop existing when destroyed in internal dock by script."/>
                  </conditions>
                  <actions>
                    <!-- Always repair the wingmate when he docks, even if he didn't specifically dock to repair. -->
                    <set_object_hull object="$WingmateShip" exact="100"/>

                    <debug_text text="'Wingmate docked somewhere and repaired.'" chance="$DebugChance"/>
                  </actions>
                </cue>

                <cue name="Wingmate_Attacked_By_Player">
                  <conditions>
                    <event_object_attacked object="$WingmateShip" check="false" comment="Might stop existing when destroyed in internal dock by script."/>
                    <check_value value="event.param.trueowner == faction.player"/>
                  </conditions>
                  <actions>
                    <set_object_relation_behaviour object="$WingmateShip" disable="true"/>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <set_object_relation_behaviour object="$WingmateShip" disable="false"/>
                    <reset_cue cue="this"/>
                  </actions>
                </cue>

                <cue name="Wingmate_Destroyed">
                  <conditions>
                    <event_object_destroyed object="$WingmateShip"/>
                  </conditions>
                  <actions>
                    <set_value name="$WingmateCutsceneKey" exact="table[$key = 'ShowCharacter']" comment="Fallback for when he's not placed anywhere."/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Wingmate_In_Flight_Conversation">
              <cues>

                <cue name="Wingmate_In_Flight_Conversation_Section_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$WingmateActor"/>
                      <event_conversation_next_section actor="$WingmateActor" section="wingmate_in_flight"/>
                      <event_conversation_returned_to_section actor="$WingmateActor" section="wingmate_in_flight"/>
                    </check_any>
                    <check_value value="Wingmate_Setup_On_Station.state != cuestate.complete"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="true"/>

                    <do_if value="event.name == 'event_conversation_started'">
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226401" comment="(serious, as if avoiding eye contact)hey."/>
                    </do_if>

                    <do_elseif value="event.param2 == 'powers'">
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226417" comment="Powers? I got none. I've shown off my 'superior manoeuvres' from time to time and just got lucky that no Xenon decided to turn me into scrap."/>
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226418" comment="All these cybernetics do for me is make me look like a damn outlaw. No chance Earth is going to take me back."/>
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226419" comment="At least these Yaki aren't going to kill us as long as you have access to Sol, and as long as I act like some Xenon whisperer prodigy."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'orcanic'">
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226420" comment="That woman? Despite appearances, she's not the Yaki leader, and it shows."/>
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226421" comment="They don't trust anyone with power. But someone's gotta keep them away from each other's throats, and that's how she got to where she is now."/>
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226422" comment="Helped me out a great deal, but that doesn't excuse what they did to us, to the outpost, and to Sol."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'disappear'">
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226423" comment="Obelisk knocking me out is why I disappeared, that much is true."/>
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226424" comment="But these people didn't save me out of the goodness of their hearts."/>
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226425" comment="They spied on me, on us, observed us like lab rats, and when they thought they'd found a candidate for their twisted augmentations, they snatched me away."/>
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226426" comment="(sighs)OK, not all of them are like that; just the hard-liners. But those are gaining in influence by the minute."/>
                    </do_elseif>

                    <do_if value="$WingmateActor.owner == faction.yaki">
                      <add_player_choice text="{30226,4038}" section="wingmate_in_flight" choiceparam="'powers'" position="top_left"/>
                      <add_player_choice text="{30226,4039}" section="wingmate_in_flight" choiceparam="'orcanic'" position="left"/>
                      <add_player_choice text="{30226,4040}" section="wingmate_in_flight" choiceparam="'disappear'" position="bottom_left"/>
                    </do_if>

                    <add_player_choice_sub text="{30225,1030}" section="wingmate_order_1" position="top_right"/>
                    <add_player_choice text="{1002,21}" section="g_cancel" position="bottom_right" comment="\(Close\)"/>
                  </actions>
                </cue>

                <cue name="Wingmate_In_Flight_Conversation_Section_Choose_Order" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$WingmateActor" section="wingmate_order_1"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="true"/>

                    <do_if value="(player.module == 'x4ep1_gamestart_terran1') and not $WingmateOrdersAvailable?">
                      <add_npc_line speaker="$WingmateActor" hidechoices="true" line="5027" comment="Sorry, I'm busy right now."/>
                    </do_if>
                    <do_else>
                      <!--<add_player_choice text="{30225,1031}" section="wingmate_order_2" choiceparam="'wait'" position="top_right" selectable="(Wingmate_Leave_Player.state == cuestate.waiting) and ($WingmateShip.order.state != orderstate.critical)"/>-->
                      <add_player_choice text="{30225,1032}" section="wingmate_order_2" choiceparam="'leave'" position="bottom_left" selectable="(Wingmate_Leave_Player.state == cuestate.waiting) and ($WingmateShip.order.state != orderstate.critical)"/>
                      <add_player_choice text="{30225,1033}" section="wingmate_order_2" choiceparam="'follow'" position="top_left" selectable="$WingmateShip.order.state != orderstate.critical"/>

                      <add_player_choice_return text="{1002,20}" position="bottom_right" comment="(Back)"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Wingmate_In_Flight_Conversation_Section_Order_Selected" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$WingmateActor" section="wingmate_order_2"/>
                  </conditions>
                  <actions>
                    <!-- TODO: Option commented out because having the wingmate wait is tricky.
                               If he stays invulnerable, he'll soak up attacks and stall wars. -->
                    <do_if value="event.param2 == 'wait'">
                      <cancel_all_orders object="$WingmateShip"/>
                      <create_order id="'Wait'" object="$WingmateShip" default="true"/>
                      <reset_cue cue="Activate_Wingmate_Handlers"/>
                      <!-- TODO: Generic voice line -->
                    </do_if>

                    <do_elseif value="event.param2 == 'leave'">
                      <do_any>
                        <speak actor="$WingmateActor" line="30284132" priority="100" comment="(Variant 1)Hope you can handle things without me!"/>
                        <speak actor="$WingmateActor" line="30284133" priority="100" comment="(Variant 2)Don't try anything crazier than usual!"/>
                      </do_any>
                      <signal_cue cue="Wingmate_Leave_Player" check="false" comment="Wingmate may have left for other reasons while player was considering the conversation options."/>
                    </do_elseif>

                    <!-- Necessary to allow the player to tether the wingmate to a new ship. -->
                    <do_elseif value="event.param2 == 'follow'">
                      <do_any>
                        <speak actor="$WingmateActor" line="30284027" priority="100" comment="(cheering)Finally some action!"/>
                        <speak actor="$WingmateActor" line="30284040" priority="100" comment="I'll stick with you."/>
                        <speak actor="$WingmateActor" line="30225011" priority="100" comment="I was waiting for this!"/>
                      </do_any>
                      <include_actions ref="Setup_Wingmate"/>
                    </do_elseif>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Note that this is used for the WingMate, does not support L/XL ships currently) -->
        <library name="Find_Repair_Station" purpose="run_actions">
          <params>
            <param name="Ship"/>
          </params>
          <actions>
            <find_station_by_true_owner name="$RepairEquipmentDock" equipmentdock="true" faction="$Ship.owner" space="player.galaxy" sortbygatedistanceto="$Ship">
              <match_dock size="tag.dock_s"/>
            </find_station_by_true_owner>
            <find_station_by_true_owner name="$RepairWharf" wharf="true" faction="$Ship.owner" space="player.galaxy" sortbygatedistanceto="$Ship">
              <match_dock size="tag.dock_s"/>
            </find_station_by_true_owner>

            <do_if value="$RepairEquipmentDock and $RepairWharf">
              <!-- Handle .gatedistance returning -1 in case of disconnected sector (which should not happen with the wingmate) -->
              <do_if value="$RepairWharf.gatedistance.{$Ship} lt 0">
                <set_value name="$RepairStation" exact="$RepairEquipmentDock"/>
              </do_if>
              <do_elseif value="$RepairEquipmentDock.gatedistance.{$Ship} lt 0">
                <set_value name="$RepairStation" exact="$RepairWharf"/>
              </do_elseif>
              <do_elseif value="$RepairWharf.gatedistance.{$Ship} lt $RepairEquipmentDock.gatedistance.{$Ship}">
                <set_value name="$RepairStation" exact="$RepairWharf"/>
              </do_elseif>
              <do_else>
                <set_value name="$RepairStation" exact="$RepairEquipmentDock"/>
              </do_else>
            </do_if>
            <do_elseif value="$RepairEquipmentDock">
              <set_value name="$RepairStation" exact="$RepairEquipmentDock"/>
            </do_elseif>
            <do_elseif value="$RepairWharf">
              <set_value name="$RepairStation" exact="$RepairWharf"/>
            </do_elseif>
            <do_else>
              <find_station_by_true_owner name="$RepairStation" faction="$Ship.owner" space="player.galaxy" sortbygatedistanceto="$Ship">
                <match_dock size="tag.dock_s"/>
              </find_station_by_true_owner>
            </do_else>

            <return value="$RepairStation"/>
          </actions>
        </library>

        <library name="Find_Despawn_Station" purpose="run_actions">
          <params>
            <param name="Ship"/>
            <param name="IdealSector"/>
            <param name="DebugChance" default="100"/>
          </params>
          <actions>
            <!-- Check whether the ideal sector can be reached. -->
            <do_if value="(not $IdealSector.accesslicence) or ($IdealSector.accesslicence and faction.player.haslicence.{$IdealSector.accesslicence}.{$IdealSector.owner})">
              <!-- Ownership claiming station in ideal sector. -->
              <debug_text text="'Searching for ownership claiming despawn station in ' + $IdealSector.knownname" chance="$DebugChance"/>
              <find_station_by_true_owner name="$DespawnStation" faction="$Ship.owner" canclaimownership="true" space="$IdealSector">
                <match_dock size="tag.dock_s"/>
              </find_station_by_true_owner>
              <do_if value="not $DespawnStation">
                <debug_text text="'Searching for any despawn station in ' + $IdealSector.knownname" chance="$DebugChance"/>
                <find_station_by_true_owner name="$DespawnStation" faction="$Ship.owner" space="$IdealSector">
                  <match_dock size="tag.dock_s"/>
                </find_station_by_true_owner>
              </do_if>
            </do_if>
            <!-- If the ideal sector can't be reached, filter out all inaccessible sectors and do a broader search. -->
            <do_else>
              <find_sector name="$AccessibleSectors" accessgrantedto="faction.player" multiple="true"/>

              <!-- Ownership claiming station in non-accesslicence space close to the ideal sector. -->
              <debug_text text="'Searching for ownership claiming despawn station close to ' + $IdealSector.knownname" chance="$DebugChance"/>
              <find_station_by_true_owner name="$DespawnStation" faction="$Ship.owner" canclaimownership="true" space="$AccessibleSectors" sortbygatedistanceto="$IdealSector" >
                <match_dock size="tag.dock_s"/>
              </find_station_by_true_owner>
            </do_else>
            <do_if value="not $DespawnStation">
              <!-- Any station in non-accesslicence space close to the ideal sector. -->
              <debug_text text="'Searching for any ' + $Ship.owner + ' despawn station close to ' + $IdealSector.knownname" chance="$DebugChance"/>
              <find_station_by_true_owner name="$DespawnStation" faction="$Ship.owner" space="$AccessibleSectors" sortbygatedistanceto="$IdealSector">
                <match_dock size="tag.dock_s"/>
              </find_station_by_true_owner>
            </do_if>
            <do_if value="not $DespawnStation">
              <!-- Any other faction station in non-accesslicence space close to the ideal sector. -->
              <debug_text text="'Searching for any despawn station close to ' + $IdealSector.knownname" chance="$DebugChance"/>
              <find_station name="$DespawnStation" space="$AccessibleSectors" sortbygatedistanceto="$IdealSector">
                <match_relation_to faction="faction.player" relation="dock"/>
                <match_relation_to faction="$Ship.owner" relation="dock"/>
                <match_dock size="tag.dock_s"/>
              </find_station>
            </do_if>
            <return value="$DespawnStation"/>
          </actions>
        </library>

        <cue name="Activate_Yaki_Escort_Handlers">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Yaki_Escort_Leaves_Player">
              <conditions>
                <event_object_changed_sector object="player.entity"/>
                <check_value value="event.param != null" comment="sector is null if the player is on a superhighway"/>
                <check_value value="event.param != $YakiHomeSector"/>
              </conditions>
              <actions>
                <do_for_each in="$YakiEscort" name="$CurrentShip">
                  <cancel_all_orders object="$CurrentShip"/>
                  <create_order id="'Patrol'" object="$CurrentShip" default="true">
                    <param name="space" value="$YakiHomeSector"/>
                  </create_order>
                  <set_object_relation_behaviour object="$CurrentShip" disable="false"/>
                </do_for_each>
              </actions>
              <cues>

                <cue name="Yaki_Escort_Joins_Player">
                  <conditions>
                    <event_object_changed_sector object="player.entity"/>
                    <check_value value="event.param != null" comment="sector is null if the player is on a superhighway"/>
                    <check_value value="event.param == $YakiHomeSector"/>
                  </conditions>
                  <actions>
                    <do_if value="not $YakiEscort.count">
                      <debug_text text="'$YakiEscort would like to join the player, but they\'re all dead.'" chance="$DebugChance"/>
                    </do_if>
                    <do_else>
                      <debug_text text="'$YakiEscort joins the player. ' + $YakiEscort.count + ' ships remaining.'" chance="$DebugChance"/>
                    </do_else>

                    <do_if value="player.ship">
                      <set_value name="$CurrentPlayerShip" exact="player.ship"/>
                      <do_for_each in="$YakiEscort" name="$CurrentShip">
                        <cancel_all_orders object="$CurrentShip"/>
                        <create_order id="'Patrol'" object="$CurrentShip" default="true">
                          <param name="space" value="$YakiHomeSector"/>
                        </create_order>
                        <create_order id="'ProtectShip'" object="$CurrentShip" immediate="true">
                          <param name="target" value="$CurrentPlayerShip"/>
                        </create_order>
                        <set_object_relation_behaviour object="$CurrentShip" disable="true"/>
                      </do_for_each>
                    </do_if>

                    <reset_cue cue="parent"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Yaki_Escort_Attacks_Friendly">
              <conditions>
                <event_object_attacked_object object="$CurrentPlayerShip"/>
                <check_value value="Yaki_Escort_Leaves_Player.state == cuestate.waiting"/>
                <check_value value="event.object.relationto.{event.param} le faction.yaki.relation.killmilitary.max" comment="Only once the attacked object has received a negative relation boost and is attacking back."/>
                <check_value value="event.param.owner != faction.yaki" comment="They won't attack other Yaki."/>
                <check_value value="event.param.owner.relationto.{faction.yaki} gt faction.yaki.relation.enemy.max" comment="ProtectShip order usually prevents the protector from attacking non-enemy targets."/>
              </conditions>
              <actions>
                <!-- Temporary sick'em! -->
                <set_value name="$CurrentEnemy" exact="event.param"/>
                <set_object_relation_behaviour object="$CurrentEnemy" disable="true"/>
                <debug_text text="'Yaki Escort attacks friendly: ' + $CurrentEnemy" chance="$DebugChance"/>
                <create_list name="$AttackOrders"/>
                <do_for_each in="$YakiEscort" name="$CurrentShip">
                  <!--<set_object_relation_behaviour object="$CurrentShip" disable="true"/>-->
                  <create_order id="'Attack'" name="$AttackOrder" object="$CurrentShip" immediate="true">
                    <param name="primarytarget" value="$CurrentEnemy"/>
                    <param name="pursuetargets" value="false"/>
                    <param name="checkrelation" value="false"/>
                    <param name="allowothertargets" value="false"/>
                  </create_order>
                  <append_to_list name="$AttackOrders" exact="$AttackOrder"/>
                  <debug_text text="'Created attack order ' + $AttackOrder" chance="$DebugChance"/>
                </do_for_each>
              </actions>
              <delay exact="15s"/>
              <actions>
                <do_if value="$AttackOrders.count">
                  <do_for_each in="$AttackOrders" name="$AttackOrder">
                    <debug_text text="'Cancelling order ' + $AttackOrder" chance="$DebugChance"/>
                    <cancel_order order="$AttackOrder"/>
                  </do_for_each>
                </do_if>
                <do_if value="$CurrentEnemy.isoperational">
                  <set_object_relation_behaviour object="$CurrentEnemy" disable="false"/>
                </do_if>
                <!--<do_for_each in="$YakiEscort" name="$CurrentShip">
                  <set_object_relation_behaviour object="$CurrentShip" disable="false"/>
                </do_for_each>-->
                <reset_cue cue="this"/>
              </actions>
              <cues>

                <!-- TODO: This cue was supposed to reset the parent cue when the attack orders expired naturally (e.g. when the target was destroyed), but the events don't fire for some reason. -->
                <!--<cue name="Attack_Orders_Expired" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_object_order_finished group="$YakiEscort"/>
                      <event_object_order_cancelled group="$YakiEscort"/>
                    </check_any>
                    <check_value value="not $AttackOrders.count"/>
                  </conditions>
                  <actions>
                    <debug_text text="'No attack orders left: ' + $AttackOrders + '. Reactivating relation behaviour.'" chance="$DebugChance"/>
                    <do_if value="$CurrentEnemy.isoperational">
                      <set_object_relation_behaviour object="$CurrentEnemy" disable="false"/>
                    </do_if>
                    <reset_cue cue="parent"/>
                  </actions>
                </cue>-->

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Wingmate_Leave_Player_Speak" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Wingmate_Leave_Player_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="IsInMission"       value="$MissionCue.hasmission"/>
              <param name="Actor"             value="$WingmateActor"/>
              <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
              <param name="DelayInitial"      value="6s"/>
              <param name="Lines"             value="[[[30284111,30284112,30284113,30284114].random],[30284115]]"/>
              <param name="EndSignalCue"      value="null"/>
              <!--
                      Wingmate:
                        <t id="30284111">(Variant 1)Seems like you're going on an adventure!</t>
                        <t id="30284112">(Variant 2)Did you get some sort of scouting mission I didn't?</t>
                        <t id="30284113">(Variant 3)I'd love to explore the universe with you once I've proven myself to the Protectorate.</t>
                        <t id="30284114">(Variant 4)Go on ahead, I still have a few things to take care of at home.</t>
                        <t id="30284115">I'll join you again when you come back.</t>
                      -->
            </cue>

          </cues>
        </cue>

        <cue name="Yaki_Wingmate_Leave_Player_Speak" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Yaki_Wingmate_Leave_Player_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="IsInMission"       value="$MissionCue.hasmission"/>
              <param name="Actor"             value="$WingmateActor"/>
              <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
              <param name="DelayInitial"      value="6s"/>
              <param name="Lines"             value="[[30226001]]"/>
              <param name="EndSignalCue"      value="null"/>
              <!--
                      Wingmate:
                        (regretfully)Sorry, friend, I'm afraid I'll have to lay low. With these cybernetics and this ship, any Terran we come across would shoot me on sight.
                      -->
            </cue>

          </cues>
        </cue>

        <cue name="Wingmate_Join_Player_Speak" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Wingmate_Join_Player_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="IsInMission"       value="$MissionCue.hasmission"/>
              <param name="Actor"             value="$WingmateActor"/>
              <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
              <param name="DelayInitial"      value="6s"/>
              <param name="Lines"             value="[[[30284121,30284122,30284123,30284124].random],[30284125]]"/>
              <param name="EndSignalCue"      value="null"/>
              <!--
                      Wingmate:
                        <t id="30284121">(Variant 1)How did it go?</t>
                        <t id="30284122">(Variant 2)Good to have you back.</t>
                        <t id="30284123">(Variant 3)My wingmate's back!</t>
                        <t id="30284124">(Variant 4)All sorted out?</t>
                        <t id="30284125">I'll make my way over to you.</t>
                      -->
            </cue>

          </cues>
        </cue>

        <cue name="Wingmate_Player_Declared_War_Speak" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Wingmate_Player_Declared_War_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="IsInMission"       value="$MissionCue.hasmission"/>
              <param name="Actor"             value="$WingmateActor"/>
              <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
              <param name="DelayInitial"      value="3s"/>
              <param name="Lines"             value="[[30284151],[30284152]]"/>
              <param name="EndSignalCue"      value="null"/>
              <!--
                      Wingmate:
                        <t id="30284151">\033M(solemn)I'm sure you have your reasons, but I can't follow you down that path.</t>
                        <t id="30284152">\033M(solemn)I'm truly sorry.</t>
                      -->
            </cue>

          </cues>
        </cue>

        <cue name="Wingmate_Player_Ended_War_Speak" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Wingmate_Player_Ended_War_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="IsInMission"       value="$MissionCue.hasmission"/>
              <param name="Actor"             value="$WingmateActor"/>
              <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
              <param name="DelayInitial"      value="3s"/>
              <param name="Lines"             value="[[30284122],[30284125]]"/>
              <param name="EndSignalCue"      value="null"/>
              <!--
                      Wingmate:
                        <t id="30284122">(Variant 2)Good to have you back.</t>
                        <t id="30284125">I'll make my way over to you.</t>
                      -->
            </cue>

          </cues>
        </cue>

        <cue name="Wingmate_Repair_Speak">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="1min"/>
          <actions>
            <reset_cue cue="this"/>
          </actions>
          <cues>

            <cue name="Wingmate_Repair_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="IsInMission"       value="$MissionCue.hasmission"/>
              <param name="Actor"             value="$WingmateActor"/>
              <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
              <param name="DelayInitial"      value="3s"/>
              <param name="Lines"             value="[[30284131],[[30284132,30284133,30284134].random]]"/>
              <param name="EndSignalCue"      value="null"/>
              <!--
                      Wingmate:
                        <t id="30284131">I have to go for repairs or I'm done for!</t>
                        <t id="30284132">(Variant 1)Hope you can handle without me!</t>
                        <t id="30284133">(Variant 2)Don't try anything crazier than usual!</t>
                        <t id="30284134">(Variant 3)Don't worry, I'll be back in no time</t>
                      -->
            </cue>

          </cues>
        </cue>

        <cue name="Wingmate_Repair_Finished_Speak" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Wingmate_Repair_Finished_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="IsInMission"       value="$MissionCue.hasmission"/>
              <param name="Actor"             value="$WingmateActor"/>
              <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
              <param name="DelayInitial"      value="3s"/>
              <param name="Lines"             value="[[[30284141,30284142,30284143].random],[30284144]]"/>
              <param name="EndSignalCue"      value="null"/>
              <!--
                      Wingmate:
                        <t id="30284141">(Variant 1)There, that should hold for a while.</t>
                        <t id="30284142">(Variant 2)All patched up.</t>
                        <t id="30284143">(Variant 3)Repairs are finished.</t>
                        <t id="30284144">I'm on my way back.</t>
                      -->
            </cue>

          </cues>
        </cue>

        <!-- *** OFFER MANAGEMENT *** -->

        <cue name="Offer_Management">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!--<find_sector name="$MissionOfferSectorList" multiple="true" trueowner="faction.terran"/>
            <append_to_list name="$MissionOfferSectorList" exact="$TerranOutpostSector"/>-->

            <create_cue_actor cue="$MissionCue" name="$MissionOfferActor">
              <select faction="faction.terran" tags="tag.crew"/>
            </create_cue_actor>
          </actions>
          <cues>

            <cue name="Mission_Offer_Terran_Cadet_Shortcut" onfail="cancel">
              <conditions>
                <check_value value="player.module == 'x4ep1_gamestart_terran1'"/>
                <check_value value="Create_Mission_Offer.state == cuestate.waiting"/>
                <check_value value="((@player.sector == $TerranOutpostSector) or (@player.sector.owner == faction.terran)) and (faction.terran.relationto.{faction.player} ge $RelationThreshold)"/>
                <check_value value="(not @player.sector.accesslicence) or (@player.sector.accesslicence and faction.player.haslicence.{@player.sector.accesslicence}.{faction.terran})"/>
              </conditions>
              <delay exact="10min"/>
              <actions>
                <do_if value="((@player.sector == $TerranOutpostSector) or (@player.sector.owner == faction.terran)) and (faction.terran.relationto.{faction.player} ge $RelationThreshold)
                          and ((not @player.sector.accesslicence) or (@player.sector.accesslicence and faction.player.haslicence.{@player.sector.accesslicence}.{faction.terran}))">
                  <signal_cue cue="Create_Mission_Offer" check="false"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Create_Mission_Offer">
              <conditions>
                <check_any>
                  <check_all>
                    <!-- When the player enters a Terran sector or the outpost sector while above the relation threshold. -->
                    <event_object_changed_sector object="player.entity"/>
                    <check_value value="event.param != null" comment="sector is null if the player is on a superhighway"/>
                    <check_value value="((event.param == $TerranOutpostSector) or (@event.param.owner == faction.terran)) and (faction.terran.relationto.{faction.player} ge $RelationThreshold)"/>
                    <check_value value="(not event.param.accesslicence) or (event.param.accesslicence and faction.player.haslicence.{event.param.accesslicence}.{faction.terran})"/>
                  </check_all>
                  <check_all>
                    <!-- When the player reaches the relation threshold while in a Terran sector or the outpost sector. -->
                    <event_player_relation_changed faction="faction.terran"/>
                    <check_value value="(event.param2.{1} ge $RelationThreshold) and ((@player.sector == $TerranOutpostSector) or (@player.sector.owner == faction.terran))"/>
                    <check_value value="(not @player.sector.accesslicence) or (@player.sector.accesslicence and faction.player.haslicence.{@player.sector.accesslicence}.{faction.terran})"/>
                  </check_all>
                  <event_cue_signalled/>
                </check_any>
              </conditions>
              <actions>
                <set_value name="$TerranMissionRewardCr_1" exact="125000Cr"/>

                <create_offer cue="$MissionCue" actor="$MissionOfferActor" name="{30225,1001}" description="{30225,1002}" reward="$TerranMissionRewardCr_1" rewardtext="{30225,1003}" type="missiontype.plot" group="missiongroup.story_yaki_solborn" faction="faction.terran" difficulty="level.medium" abortable="false">
                  <briefing>
                    <objective step="1" action="objective.escort" text="{30225,1010}"/>
                    <objective step="2" action="objective.deploy" text="{30225,1011}"/>
                    <objective step="3" action="objective.patrol" text="{30225,1012}"/>
                  </briefing>
                </create_offer>
              </actions>
              <delay exact="5s"/>
              <actions>
                <do_if value="Mission_Offer_Wingmate_Hint.state == cuestate.waiting">
                  <signal_cue cue="Mission_Offer_Wingmate_Hint"/>
                </do_if>
              </actions>
              <cues>

                <cue name="Mission_Accepted">
                  <conditions>
                    <event_object_signalled object="$MissionOfferActor" param="'accept'"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch1_Escort"/>
                  </actions>
                </cue>

                <cue name="Remove_Mission_Offer">
                  <conditions>
                    <!-- Mission offer only gets removed if the relation drops below the threshold. It doesn't get removed if the player flies away. -->
                    <event_player_relation_changed faction="faction.terran"/>
                    <check_value value="(event.param2.{1} ge $RelationThreshold) and (event.param2.{2} lt $RelationThreshold)"/>
                  </conditions>
                  <actions>
                    <remove_offer cue="$MissionCue"/>
                    <reset_cue cue="Create_Mission_Offer"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Mission_Offer_Wingmate_Hint">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Mission_Offer_Wingmate_Hint_DND" checkinterval="1s">
                  <conditions>
                    <check_value value="not md.$MissionDND.count"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Mission DND list should be empty: ' + md.$MissionDND" chance="$DebugChance"/>

                    <!-- Wingmate calls you to inform you about the mission offer, with different lines depending on whether you already know him or not. -->
                    <do_if value="player.module == 'x4ep1_gamestart_terran1'">
                      <signal_cue cue="Mission_Offer_Wingmate_Known_Speak" check="false"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Mission_Offer_Wingmate_Unknown_Speak" check="false"/>
                    </do_else>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Mission_Offer_Wingmate_Known_Speak">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Mission_Offer_Wingmate_Known_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="IsInMission"       value="false"/>
              <param name="Actor"             value="$WingmateActor"/>
              <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
              <param name="DelayInitial"      value="5s"/>
              <param name="Lines"             value="[[30284046],[30284047]]"/>
              <param name="EndSignalCue"      value="Mission_Offer_Display_Hint"/>
              <!--
                      Wingmate:
                        <t id="30284046">Oh, looks like we're still on Mission Command's good side.</t>
                        <t id="30284047">They just sent us a posting for a border assignment!</t>
                      -->
            </cue>

          </cues>
        </cue>

        <cue name="Mission_Offer_Wingmate_Unknown_Speak">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Mission_Offer_Wingmate_Unknown_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="IsInMission"       value="false"/>
              <param name="Actor"             value="$SecretServiceActor"/>
              <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
              <param name="DelayInitial"      value="5s"/>
              <param name="Lines"             value="[[30225001],[30225002],[30225003],[30225004],[30225005],[30225006]]"/>
              <param name="EndSignalCue"      value="Mission_Offer_Display_Hint"/>
              <!--
                      Delilah:
                        <t id="30225001">Welcome, visitor, to pure and radiant Sol, bastion of peace and prosperity.</t>
                        <t id="30225002">If you too want to protect this utopia and the stars beyond, then do not hesitate.</t>
                        <t id="30225003">The Solborn Militia welcomes any and all merited volunteers to join the...</t>
                        <t id="30225004">(same tone, but recorded separately)... foreign auxiliaries ...</t>
                        <t id="30225005">... and contribute their prowess for the safety of the Jump Gate network.</t>
                        <t id="30225006">Remember: we are the shield wall of civilisation, and together, we shall overcome.</t>
                      -->
            </cue>

          </cues>
        </cue>

        <cue name="Mission_Offer_Display_Hint">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="player.module == 'x4ep1_gamestart_terran1'">
              <show_help_multi allowclose="true" position="1" force="true">
                <text line="833" comment="A new story mission is now available in the MISSION OFFERS tab of your map menu."/>
                <text line="836" comment="If you find yourself struggling against the challenge, consider taking on other missions to earn rewards and upgrade your ship."/>
                <text line="831" comment="Try the '{30190,5}'(Mission Management) tutorial to find MISSION OFFERS."/>
              </show_help_multi>
            </do_if>
            <do_else comment="If the player isn't the Terran Cadet, they had to increase their reputation to get here, so chances are high that they already know how mission offers work.">
              <show_help line="833" position="1" force="true" comment="A new story mission is now available in the MISSION OFFERS tab of your map menu." allowclose="true"/>
            </do_else>
          </actions>
        </cue>

        <!-- Cutscene opening handling -->

        <!--These cues handle the briefing presentations e.g. Holomap or cutscene render targets (depending on the mission)
                note: play_cutscene action should not be in the actions of the cue with a event_briefing_submission_selected condition. It must be delayed-->
        <cue name="BriefingStarted">
          <conditions>
            <check_any>
              <event_briefing_started cue="$MissionCue"/>
              <event_briefing_submission_selected cue="$MissionCue"/>
            </check_any>
          </conditions>
          <actions>
            <set_value name="$RenderTarget" exact="event.param.{1}"/>
            <set_value name="$StartBriefingCutscene"/>
            <debug_text text="'Briefing started'" chance="$DebugChance"/>
          </actions>
          <cues>
            <cue name="DisplayCutscene" onfail="cancel">
              <conditions>
                <check_value value="$StartBriefingCutscene?"/>
              </conditions>
              <actions>
                <set_value name="$BriefingCutsceneStarted"/>
                <set_value name="$CutsceneKey" exact="'ShowLogoTerran'"/>
                <play_cutscene key="$CutsceneKey" rendertarget="$RenderTarget">
                  <param name="npcref" object="$SecretServiceActor"/>
                </play_cutscene>
              </actions>
            </cue>

            <cue name="BriefingStopped">
              <conditions>
                <check_any>
                  <event_briefing_cancelled cue="$MissionCue"/>
                  <event_briefing_submission_unselected cue="$MissionCue"/>
                </check_any>
              </conditions>
              <actions>
                <do_if value="$BriefingCutsceneStarted?">
                  <!--Temp value. This is used to identify if a cutscene for this mission is still playing.-->
                  <remove_value name="$BriefingCutsceneStarted"/>
                  <stop_cutscene key="$CutsceneKey"/>
                </do_if>

                <do_if value="$HoloMap?">
                  <remove_holomap />
                  <remove_value name="$HoloMap"/>
                </do_if>

                <debug_text text="'Briefing canceled'" chance="$DebugChance"/>
                <reset_cue cue="BriefingStarted"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- *** STORY CHAPTERS *** -->

        <!-- MISSION 1 (Terran Mission 1) -->

        <cue name="Ch1_Escort">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <cancel_cue cue="Offer_Management" comment="Cancel the mission offer management."/>
            <remove_offer cue="$MissionCue"/>

            <set_value name="$WingmateOrdersAvailable" comment="Set it again here in case the cue got signalled manually for debugging."/>

            <!-- TODO: Can the offer simply turn into the actual mission? -->
            <create_mission cue="$MissionCue" name="{30225,1001}" description="{30225,1002}" rewardtext="{30225,1003}" type="missiontype.plot" group="missiongroup.story_yaki_solborn" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'faction_terran'" iconcaption="{30225,108}">
              <briefing>
                <objective step="1" action="objective.escort" text="{30225,1010}"/>
                <objective step="2" action="objective.deploy" text="{30225,1011}"/>
                <objective step="3" action="objective.patrol" text="{30225,1012}"/>
              </briefing>
            </create_mission>
          </actions>
          <force>
            <do_if value="faction.terran.relationto.{faction.player} lt 0.0032">
              <set_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.0032"/>
            </do_if>
          </force>
          <cues>

            <cue name="Ch1_Setup_Terran_Outpost">
              <actions>
                <signal_cue cue="Setup_Terran_Outpost"/>
              </actions>
            </cue>

            <cue name="Ch1_Setup_Escort_Ship" version="2">
              <actions>
                <find_gate name="$TerranGate" space="$TerranBorderSector" destination="$TerranOutpostSector"/>

                <do_if value="not $EscortShipDockStation? or not $EscortShipDockStation.isoperational">
                  <find_station_by_true_owner name="$EscortShipDockStation" space="$TerranBorderSector" faction="faction.terran" sortbydistanceto="$TerranGate">
                    <match_dock size="tag.dock_l"/>
                  </find_station_by_true_owner>

                  <create_position name="$EscortShipSpawnPosition" object="$EscortShipDockStation" space="$EscortShipDockStation.sector"/>
                </do_if>

                <do_if value="not $EscortShip? or not $EscortShip.isoperational">
                  <create_ship name="$EscortShip" macro="ship_ter_l_trans_container_01_a_macro" sector="$TerranBorderSector" missioncue="$MissionCue" capturable="false">
                    <owner exact="faction.terran" overridenpc="true" />
                    <pilot>
                      <select faction="faction.terran" tags="tag.fighterpilot"/>
                    </pilot>
                    <people ref="terran_elite_military_crew"/>
                    <loadout>
                      <level exact="1.0"/>
                    </loadout>
                    <safepos value="if $EscortShipDockStation? and $EscortShipDockStation then $EscortShipSpawnPosition else position.[0,0,0]"/>
                  </create_ship>

                  <set_object_name object="$EscortShip" page="30225" line="202" comment="Silverback"/>
                </do_if>

                <create_order id="'Wait'" object="$EscortShip" default="true"/>
                <do_if value="$EscortShipDockStation">
                  <create_order id="'DockAndWait'" object="$EscortShip">
                    <param name="destination" value="$EscortShipDockStation"/>
                  </create_order>
                </do_if>

                <do_if value="Ch1_1_Select_Dialog.state == cuestate.waiting">
                  <reset_cue cue="Ch1_1_Approach_WarSupportTransport_Ref"/>
                  <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" object="$EscortShip" text="{30225,1010}" silent="true" updatebriefing="true"/>
                </do_if>
              </actions>
              <patch sinceversion="2">
                <do_if value="(Ch1_1_Approach_WarSupportTransport_Ref.state == cuestate.cancelled) and (Ch1_1_Select_Dialog.state == cuestate.waiting)">
                  <reset_cue cue="Ch1_1_Approach_WarSupportTransport_Ref"/>
                  <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" object="$EscortShip" text="{30225,1010}" silent="true" updatebriefing="true"/>
                </do_if>
              </patch>
              <cues>

                <cue name="Ch1_Silverback_Friendly_Fire_Protection" ref="md.LIB_Generic.Friendly_Fire_Protection">
                  <param name="Object" value="$EscortShip"/>
                  <param name="CancelCue" value="Ch1_5_Approach_Station"/>
                </cue>

                <cue name="Ch1_Escort_Ship_Or_Station_Destroyed_Before_Departure">
                  <conditions>
                    <check_any>
                      <event_object_destroyed object="$EscortShipDockStation"/>
                      <event_object_destroyed object="$EscortShip"/>
                    </check_any>
                    <check_value value="Ch1_2_Escort_Departure.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="parent"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Setup_Transport_Captain_On_Bridge">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $TransportCaptainActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $EscortShip.controlroom,
                                                                                                                                      $position = position.[-2.8m, 0.0m, -3.24m],
                                                                                                                                      $rotation = rotation.[150deg, 0deg, 0deg],
                                                                                                                                      $debugchance = 0,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Ch1_0_Welcome">
              <cues>

                <cue name="Ch1_0_Select_Dialog">
                  <actions>
                    <do_if value="player.module == 'x4ep1_gamestart_terran1'">
                      <signal_cue cue="Ch1_0_Terran_Cadet_Dialog"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch1_0_Foreign_Recruit_Dialog"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_0_Terran_Cadet_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_0_Secret_Service_Wingmate_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$SecretServiceActor, $WingmateActor]"/>
                      <param name="CutsceneKey"       value="[$SecretServiceCutsceneKey, $WingmateCutsceneKey]"/>
                      <param name="Lines"             value="[  [[30225011],[30225012]],
                                                            [[30225001]]
                                                                                      ]"/>
                      <param name="EndSignalCue"      value="[null, Ch1_1_Meetup]"/>
                      <!--         
                      Delilah:
                        I figured you two would jump at his opportunity.
                        (stress "not")Do not disappoint me.
                      Wingmate:
                        Ma'am! Understood!
                          -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_0_Foreign_Recruit_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_0_Secret_Service_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30225007],[30225008],[30225009],[30225010]]"/>
                      <param name="EndSignalCue"      value="Ch1_1_Meetup"/>
                      <!--
                      Delilah:
                        Ah, another foreign recruit for the defence effort.
                        I'm assigning you as auxiliary to cadet Shinamon.
                        From now on, you act under the mandate of Earth.
                        Follow orders and High Command will look upon you favourably.
                      -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_1_Meetup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="1"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" object="$EscortShip" text="{30225,1010}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch1_1_Approach_WarSupportTransport_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$EscortShip"/>
                  <param name="ApproachDistance"  value="5km"/>
                  <param name="SuccessSignalCue"  value="Ch1_1_Select_Dialog"/>
                </cue>

                <cue name="Ch1_1_Select_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <append_to_list name="md.$TerranGateDND" exact="Start"/>

                    <!-- From now on, we don't want to lose the ship or the instantiated actor. -->
                    <set_object_min_hull object="$EscortShip" exact="10"/>
                    <signal_cue cue="Ch1_Setup_Transport_Captain_On_Bridge"/>

                    <do_if value="player.module == 'x4ep1_gamestart_terran1'">
                      <signal_cue cue="Ch1_1_Terran_Cadet_Dialog"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch1_1_Foreign_Recruit_Dialog"/>
                    </do_else>

                    <include_actions ref="Setup_Wingmate"/>
                  </actions>
                </cue>

                <cue name="Ch1_1_Terran_Cadet_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_1_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225007],[30225008],[30225009],[30225010]]"/>
                      <param name="EndSignalCue"      value="Ch1_1_Official_Welcome_Speech"/>
                      <!--
                      Wingmate:
                        So this is that whole "Solborn Militia" business that's been all over the news
                        Some say it's because of increased Xenon activity, others say it's some sort of publicity stunt, or even a political power play against the Intervention Corps.
                        Well, I for a change am not one to complain.
                        Whatever gets us on High Command's good side.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_1_Foreign_Recruit_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_1_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225002],[30225003],[30225004],[30225005],[30225006]]"/>
                      <param name="EndSignalCue"      value="Ch1_1_Official_Welcome_Speech"/>
                      <!--
                      Wingmate:
                        Aha, looks like I'm not the only new recruit after all!
                        My old wingmate got called in for some special assignment down in Pioneers territory.
                        Eh, I'm sure it's not until doomsday.
                        (sighs)Hope you don't mind me following you around.
                        Orders are orders.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_1_Official_Welcome_Speech">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30284,1014}" insert="true" updatebriefing="true"/>
                    <include_actions ref="Setup_Wingmate"/>
                  </actions>
                  <cues>

                    <cue name="Ch1_1_Secret_Service_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30225013],[30225014],[30225015],[30225016],[30225017],[30225018]]"/>
                      <param name="EndSignalCue"      value="Ch1_1_Captain_Introduction"/>
                      <!--
                      Delilah:
                        All militia squadrons and foreign auxiliaries.
                        Those of you who were not lucky enough to be born on Terran soil, let me hereby welcome you formally into the ranks of the first and last defenders of the Jump Gate network.
                        And to those who are Solborn, or even Earthborn ...
                        ... to resist the temptation of heroism and put the defence of our sanctuary first is a sign of providence and true courage.
                        By coming here, you have already made Earth proud.
                        Captain, the ball is in your court.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_1_Captain_Introduction">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_1_Transport_Captain_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$TransportCaptainActor"/>
                      <param name="CutsceneKey"       value="$TransportCaptainCutsceneKey"/>
                      <param name="Lines"             value="[[30225001],[30225002],[30225003],[30225004]]"/>
                      <param name="EndSignalCue"      value="Ch1_2_Escort_Departure"/>
                      <!--
                      Captain Lee:
                        Much obliged.
                        This is captain Nowak Lee of the Military Supply Transport Silverback.
                        Another welcome from me and my crew, and glad to see the Militia is keeping its promises.
                        All squadrons, prepare for lift-off.
                      -->
                    </cue>

                  </cues>
                </cue>


              </cues>
            </cue>

            <cue name="Ch1_2_Escort_Departure">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="1" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.escort" object="$EscortShip" text="{30225,1010}" updatebriefing="true" comment="Overwrite the original Escort step."/>
              </actions>
              <cues>

                <cue name="Ch1_2_Setup_Escort_Squad">
                  <actions>
                    <!-- Find closest Terran station with operational S dock in the sector. If no station could be found, the squad will spawn somewhere nearby in space to improve pacing. -->
                    <find_station_by_true_owner name="$EscortSquadStation" faction="faction.terran" sortbydistanceto="$EscortShip" space="$EscortShip.sector">
                      <match_dock size="tag.dock_s" walkable="true"/>
                    </find_station_by_true_owner>

                    <!-- Find internal dock. -->
                    <do_if value="$EscortSquadStation">
                      <find_dockingbay name="$EscortSquadStationInternalDock" object="$EscortSquadStation" checkoperational="true" multiple="false">
                        <match_dock storage="true" size="macro.ship_ter_s_fighter_01_a_macro.docksize"/>
                      </find_dockingbay>
                    </do_if>

                    <set_value name="$EscortSquadComposition" exact="[
                            [ macro.ship_ter_s_heavyfighter_01_a_macro, 1 ],
                            [ macro.ship_ter_s_fighter_01_a_macro,      6 ]
                            ]" />

                    <do_all exact="$EscortSquadComposition.count" counter="$m">
                      <do_all exact="$EscortSquadComposition.{$m}.{2}" counter="$a">
                        <do_if value="$EscortSquadStationInternalDock?">
                          <create_ship name="$CurrentShip" macro="$EscortSquadComposition.{$m}.{1}" capturable="false" missioncue="$MissionCue" dock="$EscortSquadStationInternalDock">
                            <owner exact="faction.terran" overridenpc="true"/>
                            <pilot>
                              <select faction="faction.terran" tags="tag.fighterpilot"/>
                            </pilot>
                            <loadout>
                              <level exact="1.0"/>
                            </loadout>
                          </create_ship>
                        </do_if>
                        <do_else>
                          <create_ship name="$CurrentShip" macro="$EscortSquadComposition.{$m}.{1}" capturable="false" missioncue="$MissionCue" sector="$EscortShip.sector">
                            <owner exact="faction.terran" overridenpc="true"/>
                            <pilot>
                              <select faction="faction.terran" tags="tag.fighterpilot"/>
                            </pilot>
                            <loadout>
                              <level exact="1.0"/>
                            </loadout>
                            <safepos object="$EscortShip" z="-30km"/>
                          </create_ship>
                        </do_else>

                        <create_order id="'Patrol'" object="$CurrentShip" default="true">
                          <param name="space" value="$TerranBorderSector"/>
                        </create_order>

                        <do_if value="$m == 1">
                          <set_value name="$EscortSquadCommander" exact="$CurrentShip"/>
                          <set_object_name object="$CurrentShip" page="30225" line="301" comment="Slipstream Flight Leader"/>
                          <create_order id="'ProtectShip'" object="$CurrentShip" immediate="true">
                            <param name="target" value="$EscortShip"/>
                          </create_order>
                        </do_if>
                        <do_else>
                          <set_object_name object="$CurrentShip" name="'{30225,302}' + ($a + 1)" comment="Slipstream (followed by number)"/>
                          <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                            <param name="commander" value="$EscortSquadCommander"/>
                            <param name="assignment" value="assignment.defence"/>
                            <param name="cancelorders" value="true"/>
                          </create_order>
                        </do_else>

                        <add_to_group groupname="$EscortSquad" object="$CurrentShip"/>
                      </do_all>
                    </do_all>
                  </actions>
                  <cues>

                    <cue name="Escort_Squad_Commander_Changed" instantiate="true">
                      <conditions>
                        <event_object_commander_set group="$EscortSquad"/>
                      </conditions>
                      <actions>
                        <set_value name="$EscortSquadCommander" exact="event.param"/>
                      </actions>
                    </cue>

                    <cue name="Escort_Squad_Destroyed">
                      <conditions>
                        <event_object_destroyed group="$EscortSquad"/>
                        <check_value value="$EscortSquad.count == 1"/>
                        <check_value value="Ch1_5_Approach_Station.state == cuestate.waiting"/>
                      </conditions>
                      <cues>

                        <cue name="Ch1_2_Wingmate_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225013],[30225014]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                               Wingmate:
                                 Damn! That other squad got blown out of the sky!
                                 It's all on us now!
                               -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_2_Transport_Orders">
                  <actions>
                    <cancel_all_orders object="$EscortShip"/>
                    <create_order id="'MoveToObject'" object="$EscortShip">
                      <param name="destination" value="$TerranOutpost"/>
                      <param name="noattackresponse" value="true"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch1_2_Approach_TerranGate_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="$EscortShip"/>
                  <param name="ApproachTarget"    value="$TerranGate"/>
                  <param name="ApproachDistance"  value="20km"/>
                  <param name="SuccessSignalCue"  value="Ch1_2_Gate_Approach_Announcement"/>
                </cue>

                <cue name="Ch1_2_Gate_Approach_Announcement">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_2_Transport_Captain_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$TransportCaptainActor"/>
                      <param name="CutsceneKey"       value="$TransportCaptainCutsceneKey"/>
                      <param name="Lines"             value="[[30225005],[30225006],[30225007]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                      Captain Lee:
                        This is your captain speaking.
                        We're commencing our approach towards the Sol gate.
                        Please keep an eye out for resistance.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_2_Gate_Traversed">
                  <conditions>
                    <event_object_changed_sector object="$EscortShip" sector="$TerranOutpostSector"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch1_3_Defend"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_3_Defend">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch1_3_Setup_Xenon_Attack">
                  <actions>
                    <set_value name="$XenonAttackComposition" exact="[
                            [ macro.ship_xen_s_fighter_01_a_macro, 6 ],
                            [ macro.ship_xen_s_fighter_02_a_macro, 3 ]
                            ]" />

                    <do_all exact="$XenonAttackComposition.count" counter="$m">
                      <do_all exact="$XenonAttackComposition.{$m}.{2}" counter="$a">
                        <create_ship name="$CurrentShip" macro="$XenonAttackComposition.{$m}.{1}" commandeerable="false" capturable="false" missioncue="$MissionCue" sector="$TerranOutpostSector">
                          <owner exact="faction.xenon" overridenpc="true"/>
                          <pilot>
                            <select faction="faction.xenon" tags="tag.fighterpilot"/>
                          </pilot>
                          <loadout>
                            <level exact="1.0"/>
                          </loadout>
                          <drop ref="ship_small_xenon"/>
                          <safepos object="$EscortShip" x="10km"/>
                        </create_ship>

                        <create_order id="'Patrol'" object="$CurrentShip" default="true">
                          <param name="space" value="$TerranOutpostSector"/>
                        </create_order>
                        <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                          <param name="primarytarget" value="$EscortShip"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>

                        <add_to_group groupname="$XenonAttackGroup" object="$CurrentShip"/>
                      </do_all>
                    </do_all>

                    <signal_cue cue="Ch1_3_Update_Objective"/>
                  </actions>
                </cue>

                <cue name="Ch1_3_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defend" group="$XenonAttackGroup" text="{30225,1010}" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch1_3_Transport_Orders">
                      <actions>
                        <create_position name="$EscortShipDefencePosition" space="$EscortShip.sector" object="$EscortShip" x="5km"/>

                        <cancel_all_orders object="$EscortShip"/>
                        <create_order id="'ProtectPosition'" object="$EscortShip" immediate="true">
                          <param name="destination" value="[$TerranOutpostSector, $EscortShipDefencePosition]"/>
                        </create_order>
                        <create_order id="'Attack'" object="$EscortShip" immediate="true">
                          <param name="primarytarget" value="$XenonAttackGroup.random"/>
                          <param name="secondarytargets" value="[$XenonAttackGroup]"/>
                          <param name="pursuetargets" value="false"/>
                          <param name="checkrelation" value="false"/>
                          <param name="allowothertargets" value="false"/>
                        </create_order>

                        <do_if value="$EscortSquadCommander.isoperational">
                          <cancel_all_orders object="$EscortSquadCommander"/>
                          <create_order id="'ProtectPosition'" object="$EscortSquadCommander" immediate="true">
                            <param name="destination" value="[$TerranOutpostSector, $EscortShipDefencePosition]"/>
                          </create_order>
                          <create_order id="'Attack'" object="$EscortSquadCommander" immediate="true">
                            <param name="primarytarget" value="$XenonAttackGroup.random"/>
                            <param name="secondarytargets" value="[$XenonAttackGroup]"/>
                            <param name="pursuetargets" value="true"/>
                            <param name="checkrelation" value="false"/>
                            <param name="allowothertargets" value="false"/>
                          </create_order>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch1_3_Transport_Captain_Wingmate_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$TransportCaptainActor, $WingmateActor]"/>
                      <param name="CutsceneKey"       value="[$TransportCaptainCutsceneKey, $WingmateCutsceneKey]"/>
                      <param name="Lines"             value="[  [[30225008],[30225009]],
                                                                    [[30225011],[30225012]]
                                                                                              ]"/>
                      <param name="EndSignalCue"      value="[null, null]"/>
                      <!--         
                                Lee:
                                  Xenon on fast approach.
                                  Engage while we prepare countermeasures.
                                Wingmate:
                                  I was waiting for this!
                                  Time for a real fight!
                          -->
                    </cue>

                    <cue name="Ch1_3_Xenon_Left_Sector" instantiate="true">
                      <conditions>
                        <event_object_changed_sector group="$XenonAttackGroup"/>
                      </conditions>
                      <actions>
                        <remove_from_group group="$XenonAttackGroup" object="event.object"/>
                        <do_if value="not $XenonAttackGroup.count">
                          <signal_cue cue="Ch1_3_Xenon_Destroyed"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch1_3_Xenon_Destroyed">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <check_all>
                            <event_object_destroyed group="$XenonAttackGroup"/>
                            <check_value value="$XenonAttackGroup.count == 1"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch1_4_Escort_Arrival"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_4_Escort_Arrival">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <include_actions ref="Setup_Wingmate"/>

                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.escort" object="$EscortShip" text="{30225,1010}" insert="false" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch1_4_Transport_Orders">
                  <actions>
                    <cancel_all_orders object="$EscortShip"/>
                    <create_order id="'ProtectPosition'" object="$EscortShip" default="true">
                      <param name="destination" value="[$TerranOutpostSector, $CurrentTerranOutpostPosition]"/>
                    </create_order>
                    <create_order id="'DockAndWait'" object="$EscortShip">
                      <param name="destination" value="$TerranOutpost"/>
                    </create_order>
                    <create_order id="'MoveToObject'" object="$EscortShip" immediate="true">
                      <param name="destination" value="$TerranOutpost"/>
                      <param name="noattackresponse" value="true"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch1_4_Escort_Squad_Orders">
                  <actions>
                    <do_if value="$EscortSquadCommander.isoperational">
                      <cancel_all_orders object="$EscortSquadCommander"/>
                      <create_order id="'Patrol'" object="$EscortSquadCommander" default="true">
                        <param name="space" value="$TerranBorderSector"/>
                      </create_order>
                      <do_if value="$EscortShip.isoperational">
                        <create_order id="'ProtectShip'" object="$EscortSquadCommander" immediate="true">
                          <param name="target" value="$EscortShip"/>
                        </create_order>
                      </do_if>
                      <do_else>
                        <create_order id="'AssignCommander'" object="$EscortSquadCommander" immediate="true">
                          <param name="commander" value="$TerranOutpost"/>
                          <param name="assignment" value="assignment.defence"/>
                        </create_order>
                      </do_else>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch1_4_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30225015]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Wingmate:
                        Phew, made it through that one.
                      -->
                </cue>

                <cue name="Ch1_4_Approach_TerranOutpost_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="$EscortShip"/>
                  <param name="ApproachTarget"    value="$TerranOutpost"/>
                  <param name="ApproachDistance"  value="65km"/>
                  <param name="SuccessSignalCue"  value="Ch1_4_Escort_Complete_Dialog"/>
                </cue>

                <cue name="Ch1_4_Escort_Complete_Failsafe">
                  <delay exact="1min"/>
                  <actions>
                    <do_if value="Ch1_4_Escort_Complete_Dialog.state == cuestate.waiting">
                      <cancel_cue cue="Ch1_4_Approach_TerranOutpost_Ref"/>
                      <signal_cue cue="Ch1_4_Escort_Complete_Dialog"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch1_4_Escort_Complete_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_4_Transport_Captain_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$TransportCaptainActor"/>
                      <param name="CutsceneKey"       value="$TransportCaptainCutsceneKey"/>
                      <param name="Lines"             value="[[30225005],[30225010],[30225011]]"/>
                      <param name="EndSignalCue"      value="Ch1_4_Escort_Ship_Arrived"/>
                      <!--
                      Captain Lee:
                        This is your captain speaking.
                        On behalf of the crew of the Silverback, I would like to thank you for your continued support during this set of turbulences.
                        We should be able to manage the last leg of our route without further interruptions.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_4_Escort_Ship_Arrived">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_object_min_hull object="$EscortShip" exact="0"/>
                  </actions>
                  <cues>

                    <cue name="Ch1_4_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="DelayInitial"      value="3s"/>
                      <param name="Lines"             value="[[30225016]]"/>
                      <param name="EndSignalCue"      value="Ch1_5_Approach_Station"/>
                      <!--
                            Wingmate:
                              Piece of cake! Let's see what Mission Command has in store for us next.
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_5_Approach_Station">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" object="$TerranOutpost" text="{30225,1012}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch1_5_Approach_TerranOutpost_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$TerranOutpost"/>
                  <param name="ApproachDistance"  value="5km"/>
                  <param name="SuccessSignalCue"  value="Ch1_5_Wingmate_Outpost_Comment"/>
                </cue>

                <cue name="Ch1_5_Wingmate_Outpost_Comment">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_5_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225049],[30225050],[30225051],[30225052]]"/>
                      <param name="EndSignalCue"      value="Ch1_Clean_Up"/>
                      <!--
                      Wingmate:
                        (impressed)Now would you look at that station!
                        (pride turning into doubt)We're really putting our foot down, aren't we?
                        (doubtful)Wonder what the rest of the network has to say about that.
                        (turning his attention back to the matter at hand; stretch 'iiiiiiis')Anyway, following protocol, I'm guessing that the next logical step is...
                      -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_from_list name="md.$TerranGateDND" exact="Start"/>

                <do_if value="$EscortShip.isoperational">
                  <cancel_all_orders object="$EscortShip"/>
                  <create_order id="'Patrol'" object="$EscortShip" default="true">
                    <param name="space" value="$TerranBorderSector"/>
                  </create_order>
                  <create_order id="'MoveDie'" object="$EscortShip">
                    <param name="atstation" value="$TerranOutpost"/>
                  </create_order>
                </do_if>

                <do_if value="$EscortSquadCommander.isoperational">
                  <cancel_all_orders object="$EscortSquadCommander"/>
                  <create_order id="'Patrol'" object="$EscortSquadCommander" default="true">
                    <param name="space" value="$TerranBorderSector"/>
                  </create_order>
                  <create_order id="'AssignCommander'" object="$EscortSquadCommander" immediate="true">
                    <param name="commander" value="$TerranOutpost"/>
                    <param name="assignment" value="assignment.defence"/>
                  </create_order>
                </do_if>

                <signal_cue cue="Ch2_Mines"/>
                <cancel_cue cue="Ch1_Escort"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch2_Mines">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <update_mission cue="$MissionCue" comment="Collapse objective steps.">
              <briefing replace="true">
                <objective step="1" action="objective.escort" text="{30225,1010}"/>
                <objective step="2" action="objective.deploy" text="{30225,1011}"/>
                <objective step="3" action="objective.patrol" text="{30225,1012}"/>
              </briefing>
            </update_mission>

            <set_value name="$CurrentStep" exact="2"/>

            <include_actions ref="Setup_Wingmate"/>
          </actions>
          <cues>

            <cue name="DEBUG_Print_Player_Position_Relative_To_Outpost" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_position name="$pos" object="player.ship" space="$TerranOutpost"/>
                <debug_text text="$pos"/>
              </actions>
            </cue>

            <cue name="Ch2_Setup_Locations">
              <actions>
                <create_position name="$DeployMinesOffset" x="$CurrentTerranOutpostPosition.x + 5km" y="$CurrentTerranOutpostPosition.y" z="$CurrentTerranOutpostPosition.z - 8km"/>
                <set_value name="$DeployMinesRadius" exact="4km"/>

                <find_dockingbay groupname="$TerranOutpostDockModules" multiple="true" object="$TerranOutpost" state="componentstate.operational">
                  <match_dock size="tag.dock_s"/>
                </find_dockingbay>

                <set_value name="$MineWare" exact="ware.weapon_gen_mine_03"/>
                <set_value name="$MineMacro" exact="macro.weapon_gen_mine_03_macro"/>
                <set_value name="$MineCount" exact="5"/>
                <set_value name="$MineDropCount" exact="3"/>

                <signal_cue cue="Ch2_1_Collect_Mines"/>
              </actions>
            </cue>

            <cue name="Ch2_Setup_Construction_Ship">
              <actions>
                <create_ship name="$BuilderShip" macro="macro.ship_ter_xl_builder_01_a_macro" sector="$TerranOutpostSector">
                  <owner exact="faction.terran" overridenpc="true" />
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <pilot>
                    <select faction="faction.terran" tags="tag.fighterpilot"/>
                  </pilot>
                  <people ref="terran_elite_military_crew"/>
                  <safepos object="$TerranOutpost" z="-5km"/>
                </create_ship>

                <create_order object="$BuilderShip" id="'DeployToStation'">
                  <param name="station" value="$TerranOutpost"/>
                  <param name="waitduration" value="-1"/>
                  <param name="abandonbuildtime" value="-1"/>
                </create_order>

                <signal_cue cue="Ch2_Setup_Construction_Sequence"/>
              </actions>
            </cue>

            <cue name="Ch2_Setup_Construction_Sequence">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_object_component name="$TerranOutpostAdminModule" object="$TerranOutpost" canclaimownership="true"/>
                <do_if value="not $TerranOutpostAdminModule">
                  <debug_text text="'Outpost has no admin module, so we will build one.'" chance="$DebugChance"/>
                  <create_construction_sequence macros="[macro.defence_ter_claim_01_macro]" station="$TerranOutpost" base="$TerranOutpost.plannedconstruction.sequence"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Ch2_Setup_Construction_Sequence_Created">
              <conditions>
                <event_object_construction_sequence_created object="$TerranOutpost"/>
              </conditions>
              <actions>
                <set_value name="$ConstructionSequence" exact="event.param"/>
                <do_if value="$ConstructionSequence">
                  <debug_text text="'Construction sequence created.'" chance="$DebugChance"/>

                  <set_value name="$BuildTask" exact="null"/>
                  <add_build_to_expand_station object="$TerranOutpost.buildstorage" buildobject="$TerranOutpost" constructionplan="$ConstructionSequence" result="$BuildTask"/>

                  <signal_cue cue="Ch2_Setup_Buildstorage"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Ch2_Setup_Buildstorage">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="0.1s" comment="Essential delay. Without it, the build task won't be ready and we won't know which wares we need."/>
              <actions>
                <!-- fill buildstorage with needed wares -->
                <debug_text text="'filling storage'" chance="$DebugChance"/>
                <set_value name="$BuildProcessor" exact="$TerranOutpost.buildstorage.buildprocessor"/>
                <set_value name="$BuildWares" exact="$BuildProcessor.neededsequenceresources.list"/>
                <do_all exact="$BuildWares.count" counter="$k">
                  <debug_text text="'- ' + $BuildWares.{$k}.name + ' amount=' + $BuildProcessor.neededsequenceresources.{$BuildWares.{$k}}.count" chance="$DebugChance"/>
                  <add_cargo object="$TerranOutpost.buildstorage" ware="$BuildWares.{$k}" exact="$BuildProcessor.neededsequenceresources.{$BuildWares.{$k}}.count"/>
                </do_all>
              </actions>
            </cue>

            <cue name="Ch2_1_Collect_Mines">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch2_1_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="DelayInitial"      value="3s"/>
                  <param name="Lines"             value="[[30225017],[30225018],[30225019]]"/>
                  <param name="EndSignalCue"      value="Ch2_1_Hint"/>
                  <!--
                      Wingmate:
                        (deadpan)Mines. Of course.
                        Can't have a military outpost without a mine field.
                        I just hope they give us the ones with proper friend/foe detection.
                      -->
                </cue>

                <cue name="Ch2_1_Hint">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch2_1_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="DelayInitial"      value="3s"/>
                      <param name="Lines"             value="[[30225020],[30225021],[30225053]]"/>
                      <param name="EndSignalCue"      value="Ch2_1_Hint_Complete"/>
                      <!--
                            Wingmate:
                              I see they're still ejecting the same old multi-purpose lockboxes in the hopes that someone will pick them up eventually.
                              A miracle they didn't get hijacked by Newton's vengeful spirit.
                              See if you can spot them with your Long Range Scan.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_1_Hint_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch2_1_Armour_Comment">
                      <conditions>
                        <event_object_attacked group="$TargetObjects"/>
                      </conditions>
                      <cues>

                        <cue name="Ch2_1_Wingmate_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225022],[30225023]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Wingmate:
                              (surprised)Armoured!
                              (impressed)That's smart.
                            -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_1_Setup_Lockboxes" version="2">
                  <actions>
                    <set_value name="$TargetSector" exact="$TerranOutpostSector"/>
                    <create_position name="$TargetOffset" space="$TerranOutpostSector" object="$TerranOutpost" value="position.[-89.394844m, -2200m, 313.873901m]"/>
                    <set_value name="$TargetRadius" exact="800m"/>
                    <!-- If we add cargo the normal way, with add_cargo, drop lists will be ignored (and we need the drop lists, because you can only add mine ammo that way).
                         So we have to leave the individual crate lists in $CrateContent emtpy and define a drop definition in drops.xml for each lockbox that contains all items we want to add.-->
                    <set_value name="$CrateContent" exact="[[], [], [], [], []]" comment="Lockbox group -> Lockbox' crate group -> Crate"/>
                    <set_value name="$LockboxMacro" exact="macro.sm_gen_lockbox_common_01_macro"/>
                    <create_group groupname="$DroppedObjects" comment="Gets filled in the RML."/>
                    <!--Use GM library to spawn crates. Output: $TargetObjects-->
                    <include_actions ref="md.GM_FindObject.Setup_SpawnCrates"/>
                    <do_for_each in="$TargetObjects" name="$CurrentCrate" counter="$i">
                      <set_object_min_hull object="$CurrentCrate" exact="20" comment="We don't want to deal with this one getting destroyed."/>
                      <set_drop_object object="$CurrentCrate" drop="['drops_yakistory_minelockbox_1',
                                                                     'drops_yakistory_minelockbox_2',
                                                                     'drops_yakistory_minelockbox_3',
                                                                     'drops_yakistory_minelockbox_4',
                                                                     'drops_yakistory_minelockbox_5'].{$i}"/>
                    </do_for_each>
                    <signal_cue cue="Ch2_1_Find_Object"/>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="Ch2_1_Find_Object_Complete.state == cuestate.waiting">
                      <do_for_each in="$TargetObjects" name="$CurrentCrate" counter="$i">
                        <do_for_each in="$CurrentCrate.wares.list" name="$CurrentWare">
                          <remove_cargo object="$CurrentCrate" ware="$CurrentWare" exact="$CurrentCrate.wares.{$CurrentWare}.count"/>
                        </do_for_each>
                        <set_drop_object object="$CurrentCrate" drop="['drops_yakistory_minelockbox_1',
                                                                       'drops_yakistory_minelockbox_2',
                                                                       'drops_yakistory_minelockbox_3',
                                                                       'drops_yakistory_minelockbox_4',
                                                                       'drops_yakistory_minelockbox_5'].{$i}"/>
                      </do_for_each>
                      <!-- If player has opened most of the lockboxes already, and hasn't collected the contents,
                         they may not get enough mines in the new version of the mission unless we add another lockbox. -->
                      <create_lockbox name="$ExtraLockbox" macro="macro.sm_gen_lockbox_common_01_macro" sector="$TerranOutpostSector">
                        <safepos value="$TargetOffset"/>
                      </create_lockbox>
                      <set_object_min_hull object="$ExtraLockbox" exact="20"/>
                      <set_drop_object object="$ExtraLockbox" drop="'drops_yakistory_minelockbox_extra'"/>
                      <add_to_group groupname="Ch2_1_FindObject_Ref.$TargetObjects" object="$ExtraLockbox"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch2_1_Find_Object">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch2_1_FindObject_Ref" ref="md.RML_FindObject.FindObject">
                      <!--always pass these-->
                      <param name="EndSignalCue"      value="Ch2_1_Find_Object_Failsafe"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="StartStep"         value="$CurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="$DebugChance"/>
                      <param name="Text_Objective_Find"   value="{30225,1018}"/>
                      <param name="Text_Objective_Pickup" value="{30225,1019}"/>
                      <!--mission-related parameters-->
                      <param name="TargetSector"      value="$TargetSector"/>
                      <param name="TargetOffset"      value="$TargetOffset"/>
                      <param name="TargetRadius"      value="$TargetRadius"/>
                      <param name="TargetObjects"     value="$TargetObjects"/>
                      <param name="DroppedObjects"    value="$DroppedObjects"/>
                      <param name="SignalCue_ObjectsDropped" value="Ch2_1_Find_Object_Crates_Dropped"/>
                      <param name="SignalCue_ObjectCollected" value="Ch2_1_Find_Object_Crates_Collected"/>
                    </cue>

                    <cue name="Ch2_1_Find_Object_Crates_Dropped" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Dropped objects: ' + $DroppedObjects" chance="$DebugChance"/>
                        <do_for_each in="$DroppedObjects" name="$CurrentCrate">
                          <debug_text text="'Dropped crate: ' + $CurrentCrate + ' made invincible.'" chance="$DebugChance"/>
                          <set_object_min_hull object="$CurrentCrate" exact="100" comment="Players could theoretically destroy the dropped crates and get stuck."/>
                        </do_for_each>
                        <!-- If the player opens a crate and already has enough mine ammo, complete the objective.
                             This could happen right at the start, if the player has a full deployables storage.
                             We accept any mine ammo here, because we really don't want players to feel like they're stuck. -->
                        <do_if value="@player.ship.ammostorage.{deployablecategory.mine}.count ge $MineCount">
                          <signal_cue cue="Ch2_1_Find_Object_Complete"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch2_1_Find_Object_Crates_Collected" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Remnant of original cue structure, in case we need it for a later improvement -->
                      </actions>
                    </cue>

                    <!-- Complete the objective if the player collects enough mines for the next objective. The player is free to keep opening the remaining lockboxes, but they aren't forced to. -->
                    <cue name="Ch2_1_Find_Object_Mines_Collected" instantiate="true">
                      <conditions>
                        <event_player_collected_ammo macro="$MineMacro"/>
                        <check_value value="@player.sector == $TerranOutpostSector" comment="To make it less likely that this triggers when the player collects something elsewhere"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch2_1_Mines_Collected_Comment" check="false"/>
                        <do_if value="@player.ship.ammostorage.{$MineMacro}.count ge $MineCount">
                          <signal_cue cue="Ch2_1_Find_Object_Complete"/>
                        </do_if>
                      </actions>
                    </cue>

                    <!-- Complete the objective if the RML completes before the player has collected enough mines (should be impossible) -->
                    <cue name="Ch2_1_Find_Object_Failsafe">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch2_1_Find_Object_Complete"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_1_Mines_Collected_Comment">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch2_1_Wingmate_Speak_4_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225024],[30225025]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Wingmate:
                              Those are friend/foe mines alright.
                              Once you've collected enough of them, we should move on to the deployment zone.
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_1_Find_Object_Complete" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch2_2_Deploy_Mines"/>
                    <cancel_cue cue="Ch2_1_Find_Object"/>
                  </actions>
                  <patch sinceversion="2">
                    <cancel_cue cue="Ch2_1_Find_Object"/>
                  </patch>
                </cue>

              </cues>
            </cue>

            <cue name="Ch2_2_Deploy_Mines">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch2_Deploy_Defences_Ref" ref="md.RML_DeployInPlace.DeployInPlace">
                  <param name="EndSignalCue"                  value="Ch2_2_Create_Minefield"/>
                  <param name="MissionCue"                    value="$MissionCue"/>
                  <param name="StartStep"                     value="$CurrentStep" comment="Briefing step to start the mission on"/>
                  <param name="DebugChance"                   value="$DebugChance" />

                  <param name="ObjectiveText"                 value="{30136,120}"/>
                  <param name="ObjectiveText_InRange"         value="{30136,121}"/>
                  <param name="ObjectiveText_Plural"          value="{30136,122}"/>
                  <param name="ObjectiveText_InRange_Plural"  value="{30136,123}"/>
                  <param name="TargetSector"                  value="$TerranOutpostSector"/>
                  <param name="TargetOffset"                  value="$DeployMinesOffset"/>
                  <param name="TargetRadius"                  value="$DeployMinesRadius"/>
                  <param name="TargetCount"                   value="$MineCount"/>
                  <param name="DeployableCategory"            value="deployablecategory.mine"/>
                  <param name="Faction"                       value="faction.terran"/>
                </cue>

                <cue name="Ch2_2_Approach_DeployMinesOffset_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                  <param name="ApproachSector"    value="$TerranOutpostSector"/>
                  <param name="ApproachOffset"    value="$DeployMinesOffset"/>
                  <param name="ApproachDistance"  value="$DeployMinesRadius"/>
                  <param name="SuccessSignalCue"  value="Ch2_2_Mines_Close_To_Outpost_Comment"/>
                </cue>

                <cue name="Ch2_2_Mines_Close_To_Outpost_Comment">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch2_2_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225026]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Wingmate:
                              Seems a bit dangerous, placing them so closely to the outpost, but who are we to judge?
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_2_Create_Minefield">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- RML objective doesn't update when the RML is done, so it's stuck at one below max. Update manually. -->
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,1020}" object="$TerranOutpostSector" offset="$CurrentTerranOutpostPosition" radius="2km" insert="true" updatebriefing="true"/>

                    <!-- Use the distraction to deploy the rest of the mines. The other pilots did their jobs, too. -->
                    <run_actions ref="md.LIB_Generic.PlaceMinefield" result="$Explosives">
                      <param name="SelectedTarget" value="$TerranOutpost"/>
                      <param name="MinSpawn"       value="100"/>
                      <param name="MaxSpawn"       value="100"/>
                      <param name="ExplosiveOwner" value="faction.terran"/>
                    </run_actions>
                    <debug_text text="'Mines spawned: ' + $Explosives.count" chance="$DebugChance"/>

                    <signal_cue cue="Ch2_2_Minefield_Comment"/>
                  </actions>
                </cue>

                <cue name="Ch2_2_Minefield_Comment">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch2_2_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225027, 2s],[30225028]]"/>
                      <param name="EndSignalCue"      value="Ch2_Clean_Up"/>
                      <!--
                            Wingmate:
                              Let's see how our fellow defenders have handled their part of the assignment...
                              Oh boy.
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch2_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Ch3_Patrol"/>
                <cancel_cue cue="Ch2_Mines"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch3_Patrol">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <update_mission cue="$MissionCue" comment="Collapse objective steps.">
              <briefing replace="true">
                <objective step="1" action="objective.escort" text="{30225,1010}"/>
                <objective step="2" action="objective.deploy" text="{30225,1011}"/>
                <objective step="3" action="objective.patrol" text="{30225,1012}"/>
              </briefing>
            </update_mission>

            <set_value name="$CurrentStep" exact="3"/>

            <include_actions ref="Setup_Wingmate"/>
          </actions>
          <cues>

            <cue name="Ch3_Setup_Actors">
              <actions>
                <create_cue_actor name="$CheeringPilotActor1" cue="$MissionCue">
                  <select race="race.argon" faction="faction.argon"/>
                  <page exact="10103"/>
                </create_cue_actor>
                <create_cue_actor name="$CheeringPilotActor2" cue="$MissionCue">
                  <select race="race.argon" faction="faction.argon"/>
                  <page exact="10104"/>
                </create_cue_actor>
                <create_cue_actor name="$CheeringPilotActor3" cue="$MissionCue">
                  <select race="race.argon" faction="faction.argon"/>
                  <page exact="10108"/>
                </create_cue_actor>
                <create_cue_actor name="$CheeringPilotActor4" cue="$MissionCue">
                  <select race="race.argon" faction="faction.argon"/>
                  <page exact="10109"/>
                </create_cue_actor>
              </actions>
            </cue>

            <cue name="Ch3_1_Report_For_Duty">
              <actions>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,1020}" object="$TerranOutpostSector" offset="$CurrentTerranOutpostPosition" radius="2km" insert="true" silent="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch3_1_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="DelayInitial"      value="3s"/>
                  <param name="Lines"             value="[[30225029],[30225030],[30225031]]"/>
                  <param name="EndSignalCue"      value="Ch3_1_Activate_Approach_Check"/>
                  <!--
                            Wingmate:
                              (stretch word to "aaaaaanyway")Anyway, that's our task list almost done.
                              Just one standard patrol left.
                              Those are easy, you just circle around the station for a few minutes and tell them that everything's clear.
                            -->
                </cue>

                <cue name="Ch3_1_Activate_Approach_Check">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch3_1_Approach_TerranOutpost_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$TerranOutpost"/>
                      <param name="ApproachDistance"  value="2km"/>
                      <param name="SuccessSignalCue"  value="Ch3_1_Instructions_1"/>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_1_Launch_Yaki_Interloper">
                  <conditions>
                    <event_cue_signalled cue="Ch3_1_Instructions_1"/>
                  </conditions>
                  <actions>
                    <!-- Find internal dock. -->
                    <do_if value="$TerranOutpost.isoperational">
                      <find_dockingbay name="$TerranOutpostInternalDock" object="$TerranOutpost" checkoperational="true" multiple="false">
                        <match_dock storage="true" size="tag.dock_s"/>
                      </find_dockingbay>
                    </do_if>

                    <do_if value="@$TerranOutpostInternalDock">
                      <create_ship name="$YakiInterloperShip" macro="macro.ship_yak_s_fighter_01_a_macro" capturable="false" missioncue="$MissionCue" dock="$TerranOutpostInternalDock">
                        <owner exact="faction.terran" overridenpc="true"/>
                        <pilot>
                          <select faction="faction.terran" tags="tag.fighterpilot"/>
                        </pilot>
                        <!-- Paint mod: Violaceous (standard Yaki paint)-->
                        <paint ware="ware.paintmod_0123"/>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                      </create_ship>

                      <create_order id="'MoveWait'" object="$YakiInterloperShip" default="true">
                        <param name="destination" value="[$YakiExitSector, position.[0,0,0]]"/>
                        <param name="noattackresponse" value="true"/>
                      </create_order>
                    </do_if>
                  </actions>
                  <cues>

                    <cue name="Ch3_1_Despawn_Yaki_Interloper">
                      <conditions>
                        <event_object_changed_sector object="$YakiInterloperShip"/>
                      </conditions>
                      <actions>
                        <warp object="$YakiInterloperShip" sector="$YakiHomeSector">
                          <safepos value="position.[0,0,0]"/>
                        </warp>
                        <destroy_object object="$YakiInterloperShip" explosion="false"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_1_Instructions_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$NellieActor" recipient="$WingmateActor" broadcast="true" priority="100">
                      <text line="30225001" comment="Encrypted connection established."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch3_1_Instructions_2">
                  <conditions>
                    <event_speak_finished actor="$NellieActor" line="30225001"/>
                  </conditions>
                  <actions>
                    <speak actor="$WingmateActor" recipient="$NellieActor" broadcast="true" priority="100">
                      <text line="30225032" comment="What's up, Nellie?"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch3_1_Instructions_3">
                  <conditions>
                    <event_speak_finished actor="$WingmateActor" line="30225032"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>
                  </actions>
                  <cues>

                    <cue name="Ch3_1_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30225019],[30225020],[30225021],[30225022]]"/>
                      <param name="EndSignalCue"      value="Ch3_2_Approach_Strange_Beacon"/>
                      <!--
                            Delilah:
                              (deadpan)What is up indeed, Cadet.
                              There appears to be a nav beacon suspiciously close our outpost.
                              A nav beacon with no apparent owner and purpose.
                              Investigate, but keep quiet about it.
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_2_Approach_Strange_Beacon">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch3_2_Setup_Strange_Beacon">
                  <actions>
                    <create_object name="$StrangeBeacon" macro="macro.env_deco_nav_beacon_t1_mission_macro" owner="faction.ownerless" sector="$TerranOutpostSector">
                      <safepos object="$TerranOutpost"/>
                    </create_object>

                    <set_object_min_hull object="$StrangeBeacon" exact="100"/>

                    <signal_cue cue="Ch3_2_Update_Objective"/>
                  </actions>
                </cue>

                <cue name="Ch3_2_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" text="{30225,1021}" object="$StrangeBeacon" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch3_2_Approach_StrangeBeacon_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$StrangeBeacon"/>
                      <param name="ApproachDistance"  value="500m"/>
                      <param name="SuccessSignalCue"  value="Ch3_3_Investigate_Strange_Beacon"/>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_3_Investigate_Strange_Beacon">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.investigate" text="{30225,1021}" object="$StrangeBeacon" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch3_3_Switch_Beacon_Owner">
                  <actions>
                    <set_owner object="$StrangeBeacon" faction="faction.yaki"/>
                    <set_object_relation_behaviour object="$StrangeBeacon" disable="true"/>
                    <set_object_min_hull object="$StrangeBeacon" exact="0"/>
                  </actions>
                </cue>

                <cue name="Ch3_3_Wingmate_Secret_Service_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$WingmateActor, $SecretServiceActor]"/>
                  <param name="CutsceneKey"       value="[$WingmateCutsceneKey, $SecretServiceCutsceneKey]"/>
                  <param name="DelayInitial"      value="[6s, 0s]"/>
                  <param name="Lines"             value="[  [[30225033],[30225034, 2s],[30225035]],
                                                            [[30225023],[30225024],[30225025]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[Ch3_3_Switch_Back_Beacon_Owner, Ch3_4_Patrol_Station]"/>
                  <!--         
                      Wingmate:
                        ("Yaki" as if it was someone's last name)Who on Earth is Yaki?
                        Never heard of that guy.
                        Strange, I could have sworn there was some sort of signal at first...
                      Delilah:
                        I'm afraid we will have to postpone your secret mission.
                        Our scanners have picked up an approaching Xenon vessel.
                        Saddle up and join the defences.
                          -->
                </cue>

                <cue name="Ch3_3_Switch_Back_Beacon_Owner">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$StrangeBeacon.exists">
                      <set_owner object="$StrangeBeacon" faction="faction.ownerless"/>
                      <set_object_relation_behaviour object="$StrangeBeacon" disable="false"/>
                    </do_if>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_4_Patrol_Station">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch3_4_Setup">
                  <actions>
                    <create_position name="$Wave1Position" space="$TerranOutpostSector" object="$TerranOutpost" z="+20km"/>
                    <create_position name="$Wave2Position" space="$TerranOutpostSector" object="$TerranOutpost" x="+20km"/>
                    <create_group groupname="$AttackWave" comment="Init group here so that future checks don't fail if the attackers aren't created yet."/>

                    <signal_cue cue="Ch3_4_Wave_1"/>
                  </actions>
                </cue>

                <cue name="Ch3_4_Update_Objective_Patrol" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.patrol" text="{30225,1012}" object="$TerranOutpost" radius="5km" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch3_4_Update_Objective_Defeat" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" text="{30225,1022}" group="$OutpostAttackWave_1" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch3_4_Update_Objective_Defend" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--<find_ship_by_true_owner groupname="$CloseXenonShips" faction="faction.xenon" class="class.ship" primarypurpose="purpose.fight" space="$TerranOutpostSector" multiple="true"/>

                    <do_for_each in="$CloseXenonShips" name="$CurrentShip" reverse="true">
                      <do_if value="$CurrentShip.distanceto.{$TerranOutpost} gt 15km">
                        <remove_from_group group="$CloseXenonShips" object="$CurrentShip"/>
                      </do_if>
                    </do_for_each>

                    <add_to_group groupname="$AttackWave" group="$CloseXenonShips"/>-->

                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defend" text="{30225,1012}" group="$OutpostAttackWave_2" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch3_4_Wave_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="Spawn_Attack_Wave" result="$OutpostAttackWave_1">
                      <param name="AttackTarget"  value="$TerranOutpost"/>
                      <param name="Faction"       value="faction.xenon"/>
                      <param name="MissionCue"    value="$MissionCue"/>
                      <param name="Sector"        value="$TerranOutpostSector"/>
                      <param name="ShipMacros"    value="[ [ macro.ship_xen_s_scout_01_a_macro, 1 ] ]"/>
                      <param name="SpawnPosition" value="$Wave1Position"/>
                      <param name="AllowOtherTargets" value="false"/>
                    </run_actions>

                    <signal_cue cue="Ch3_4_Update_Objective_Patrol"/>
                  </actions>
                  <cues>

                    <cue name="Ch3_4_Wave_1_Objective_Failsafe">
                      <delay exact="40s"/>
                      <actions>
                        <do_if value="Ch3_4_Wave_1_Fight_Start.state == cuestate.waiting">
                          <signal_cue cue="Ch3_4_Wave_1_Fight_Start"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch3_4_Wave_1_Fight_Start">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_object_attacked group="$OutpostAttackWave_1"/>
                          <check_all>
                            <event_object_attacked object="$TerranOutpost"/>
                            <check_value value="$OutpostAttackWave_1.indexof.{event.param}"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_4_Update_Objective_Defeat"/>

                        <do_for_each in="$OutpostAttackWave_1" name="$CurrentShip">
                          <cancel_all_orders object="$CurrentShip"/>
                          <create_order id="'MoveWait'" object="$CurrentShip" default="true">
                            <param name="destination" value="[$TerranOutpostSector, $Wave2Position]"/>
                            <param name="noattackresponse" value="true"/>
                          </create_order>
                        </do_for_each>
                      </actions>
                      <delay exact="3s" comment="After the scout has hopefully turned away from the station, let it boost away."/>
                      <actions>
                        <do_for_each in="$OutpostAttackWave_1" name="$CurrentShip">
                          <create_order id="'Flee'" object="$CurrentShip" immediate="true">
                            <param name="method" value="'boost'"/>
                            <param name="attacker" value="$TerranOutpost"/>
                            <param name="donotdrop" value="true"/>
                            <param name="deploydistraction" value="false"/>
                            <param name="log" value="false"/>
                            <param name="debugchance" value="0"/>
                          </create_order>
                        </do_for_each>
                      </actions>
                      <delay exact="20s" comment="After a while, give the scout a normal order."/>
                      <actions>
                        <do_for_each in="$OutpostAttackWave_1" name="$CurrentShip">
                          <cancel_all_orders object="$CurrentShip"/>
                          <create_order id="'Patrol'" object="$CurrentShip" default="true">
                            <param name="space" value="$TerranOutpostSector"/>
                          </create_order>
                        </do_for_each>
                      </actions>
                      <cues>

                        <cue name="Ch3_4_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225036],[30225037, 1s],[30225038]]"/>
                          <param name="EndSignalCue"      value="Ch3_4_Wave_1_Defeated"/>
                          <!--
                            Wingmate:
                              Wait that's a scout!
                              We have to take it out before...
                              (stretch "aaaaaand")...and it's gone.
                            -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_4_Wave_1_Defeated">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <check_all>
                            <event_object_destroyed group="$OutpostAttackWave_1"/>
                            <check_value value="$OutpostAttackWave_1.count == 1"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_4_Wave_2"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_4_Wave_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="Spawn_Attack_Wave" result="$OutpostAttackWave_2">
                      <param name="AttackTarget"  value="$TerranOutpost"/>
                      <param name="Faction"       value="faction.xenon"/>
                      <param name="MissionCue"    value="$MissionCue"/>
                      <param name="Sector"        value="$TerranOutpostSector"/>
                      <param name="ShipMacros"    value="[ [ macro.ship_xen_m_corvette_02_a_macro, 1 ],
                                                           [ macro.ship_xen_s_fighter_02_a_macro, 2 ],
                                                           [ macro.ship_xen_s_fighter_01_a_macro, 4 ]]"/>
                      <param name="SpawnPosition" value="$Wave2Position"/>
                      <param name="AllowOtherTargets" value="true"/>
                    </run_actions>

                    <signal_cue cue="Ch3_4_Update_Objective_Patrol"/>
                  </actions>
                  <cues>

                    <cue name="Ch3_4_Secret_Service_Wingmate_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$SecretServiceActor, $WingmateActor]"/>
                      <param name="CutsceneKey"       value="[$SecretServiceCutsceneKey, $WingmateCutsceneKey]"/>
                      <param name="Lines"             value="[  [[30225026],[30225027],[30225028],[30225029]],
                                                                [[30225039]]
                                                                                              ]"/>
                      <param name="EndSignalCue"      value="[null, null]"/>
                      <!--         
                                Delilah:
                                  All squadrons, prepare to launch.
                                  We have an incoming Xenon strike force.
                                  Engage when ready.
                                  Mission Command signing off.
                                Wingmate:
                                  By the sun, what could be more important than this?!
                          -->
                    </cue>

                    <cue name="Ch3_4_Wave_2_Fight_Start">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_object_attacked group="$OutpostAttackWave_2"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_4_Update_Objective_Defend"/>
                      </actions>
                      <delay exact="3min"/>
                      <actions>
                        <do_if value="Ch3_4_Wave_2_Defeated.state == cuestate.waiting">
                          <signal_cue cue="Ch3_4_Wave_2_Defeated"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch3_4_Wave_2_Objective_Failsafe">
                      <delay exact="30s"/>
                      <actions>
                        <do_if value="Ch3_4_Wave_2_Fight_Start.state == cuestate.waiting">
                          <signal_cue cue="Ch3_4_Wave_2_Fight_Start"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch3_4_Wave_2_Defeated">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <check_all>
                            <event_object_destroyed group="$OutpostAttackWave_2"/>
                            <check_value value="$OutpostAttackWave_2.count == 1"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_4_Wave_2_Victory_Cheer"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_4_Wave_2_Victory_Cheer">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>

                        <speak actor="$CheeringPilotActor1" line="1010" priority="100" backgroundcomm="true" broadcast="true"/>
                        <speak actor="$CheeringPilotActor2" line="1010" priority="100" backgroundcomm="true" broadcast="true" delay="0.2s"/>
                        <speak actor="$CheeringPilotActor3" line="1010" priority="100" backgroundcomm="true" broadcast="true" delay="0.4s"/>
                        <speak actor="$CheeringPilotActor4" line="1010" priority="100" backgroundcomm="true" broadcast="true" delay="0.6s"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_4_Wave_2_Victory_Cheer_Finished">
                      <conditions>
                        <event_speak_finished actor="$CheeringPilotActor4" line="1010"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>
                      </actions>
                      <cues>

                        <cue name="Ch3_4_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225040]]"/>
                          <param name="EndSignalCue"      value="Ch3_Clean_Up"/>
                          <!--
                            Wingmate:
                              Uh, guys, not trying to curb your enthusiasm here, but there seems to be a commotion.
                            -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_4_Launch_Defence_Squad">
                      <actions>
                        <!-- Find internal dock. -->
                        <do_if value="$TerranOutpost.isoperational">
                          <find_dockingbay name="$TerranOutpostInternalDock" object="$TerranOutpost" checkoperational="true" multiple="false">
                            <match_dock storage="true" size="tag.dock_s"/>
                          </find_dockingbay>
                        </do_if>

                        <set_value name="$FleetComposition" exact="[
                            [ macro.ship_ter_s_heavyfighter_01_a_macro, 1 ],
                            [ macro.ship_ter_s_fighter_01_a_macro,      4 ]
                            ]" />

                        <do_all exact="$FleetComposition.count" counter="$m">
                          <do_all exact="$FleetComposition.{$m}.{2}" counter="$a">
                            <do_if value="$TerranOutpostInternalDock">
                              <create_ship name="$CurrentShip" macro="$FleetComposition.{$m}.{1}" capturable="false" missioncue="$MissionCue" dock="$TerranOutpostInternalDock">
                                <owner exact="faction.terran" overridenpc="true"/>
                                <pilot>
                                  <select faction="faction.terran" tags="tag.fighterpilot"/>
                                </pilot>
                                <loadout>
                                  <level exact="1.0"/>
                                </loadout>
                              </create_ship>
                            </do_if>
                            <do_else>
                              <create_ship name="$CurrentShip" macro="$FleetComposition.{$m}.{1}" capturable="false" missioncue="$MissionCue" sector="$TerranOutpostSector">
                                <owner exact="faction.terran" overridenpc="true"/>
                                <pilot>
                                  <select faction="faction.terran" tags="tag.fighterpilot"/>
                                </pilot>
                                <loadout>
                                  <level exact="1.0"/>
                                </loadout>
                                <safepos object="$TerranOutpost" x="-3km"/>
                              </create_ship>
                            </do_else>

                            <create_order id="'Patrol'" object="$CurrentShip" default="true">
                              <param name="space" value="$TerranOutpostSector"/>
                            </create_order>

                            <do_if value="$m == 1 and $a == 1">
                              <set_object_name object="$CurrentShip" page="30225" line="305" comment="Cobalt Flight Leader"/>
                              <set_value name="$SquadCommander" exact="$CurrentShip"/>
                              <create_order id="'ProtectStation'" object="$CurrentShip" immediate="true">
                                <param name="station" value="$TerranOutpost"/>
                              </create_order>
                            </do_if>
                            <do_else>
                              <set_object_name object="$CurrentShip" name="'{30225,306}' + ($a + 1)" comment="Cobalt (followed by number)"/>
                              <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                                <param name="commander" value="$SquadCommander"/>
                                <param name="assignment" value="assignment.defence"/>
                                <param name="cancelorders" value="true"/>
                              </create_order>
                            </do_else>

                            <add_to_group groupname="$DefenceSquad" object="$CurrentShip"/>
                          </do_all>
                        </do_all>
                      </actions>
                      <cues>

                        <cue name="Ch3_4_Defence_Squad_Destroyed">
                          <conditions>
                            <event_object_destroyed group="$DefenceSquad"/>
                            <check_value value="$DefenceSquad.count == 1"/>
                          </conditions>
                          <actions>
                            <reset_cue cue="parent"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <do_if value="$YakiInterloperShip.isoperational">
                  <warp object="$YakiInterloperShip" sector="$YakiHomeSector">
                    <safepos value="position.[0,0,0]"/>
                  </warp>
                  <destroy_object object="$YakiInterloperShip" explosion="false"/>
                </do_if>

                <do_if value="$OutpostAttackWave_2.count">
                  <do_for_each in="$OutpostAttackWave_2" name="$CurrentShip">
                    <cancel_all_orders object="$CurrentShip"/>
                    <create_order id="'Patrol'" object="$CurrentShip" default="true">
                      <param name="space" value="$YakiExitSector"/>
                    </create_order>
                    <create_order id="'Flee'" object="$CurrentShip" immediate="true">
                      <param name="method" value="'boost'"/>
                      <param name="attacker" value="$TerranOutpost"/>
                      <param name="donotdrop" value="true"/>
                      <param name="deploydistraction" value="false"/>
                      <param name="log" value="false"/>
                    </create_order>
                  </do_for_each>
                </do_if>

                <do_if value="$DefenceSquad.count">
                  <do_for_each in="$DefenceSquad" name="$CurrentShip">
                    <cancel_all_orders object="$CurrentShip"/>
                    <create_order id="'MoveDie'" object="$CurrentShip">
                      <param name="atstation" value="$TerranOutpost"/>
                    </create_order>
                  </do_for_each>
                </do_if>

                <signal_cue cue="Ch4_Erratic_Miner"/>
                <cancel_cue cue="Ch3_Patrol"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch4_Erratic_Miner">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <update_mission cue="$MissionCue" comment="Collapse objective steps.">
              <briefing replace="true">
                <objective step="1" action="objective.escort" text="{30225,1010}"/>
                <objective step="2" action="objective.deploy" text="{30225,1011}"/>
                <objective step="3" action="objective.patrol" text="{30225,1012}"/>
              </briefing>
            </update_mission>

            <include_actions ref="Setup_Wingmate"/>
          </actions>
          <cues>

            <cue name="Ch4_Setup_Antigone_Miner">
              <actions>
                <create_loadout result="$AntigoneMinerLoadout">
                  <macros>
                    <engine macro="engine_arg_l_travel_01_mk1_macro" path="../con_engine_02"/>
                    <engine macro="engine_arg_l_travel_01_mk1_macro" path="../con_engine_01"/>
                    <shield macro="shield_arg_l_standard_01_mk1_macro" path="../con_shieldgen_l_02"/>
                    <shield macro="shield_arg_l_standard_01_mk1_macro" path="../con_shieldgen_l_01"/>
                  </macros>
                  <groups>
                    <shields macro="shield_arg_m_standard_02_mk1_macro" path=".." group="group_back_up_mid"/>
                    <shields macro="shield_arg_m_standard_02_mk1_macro" path=".." group="group_front_mid_mid"/>
                    <shields macro="shield_arg_m_standard_02_mk1_macro" path=".." group="group_front_down_mid" exact="2"/>
                    <shields macro="shield_arg_m_standard_02_mk1_macro" path=".." group="group_back_mid"/>
                    <shields macro="shield_arg_m_standard_02_mk1_macro" path=".." group="group_front_left_mid" exact="2"/>
                    <turrets macro="turret_arg_l_mining_01_mk1_macro" path=".." group="group_front_down_mid"/>
                    <turrets macro="turret_arg_m_plasma_02_mk1_macro" path=".." group="group_mid_up_mid"/>
                  </groups>
                  <ammunition>
                    <unit macro="ship_gen_xs_repairdrone_01_a_macro" exact="10"/>
                  </ammunition>
                  <software>
                    <software ware="software_dockmk2"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk2"/>
                    <software ware="software_scannerobjectmk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_l_allround_01_mk1_macro"/>
                  </virtualmacros>
                </create_loadout>

                <create_ship name="$AntigoneMiner" macro="macro.ship_arg_l_miner_solid_01_b_macro" sector="$TerranOutpostSector" missioncue="$MissionCue" capturable="false">
                  <owner exact="faction.antigone" overridenpc="true" />
                  <pilot actor="$AngryMinerSubstituteActor"/>
                  <loadout loadout="$AntigoneMinerLoadout"/>
                  <safepos x="$CurrentTerranOutpostPosition.x" y="$CurrentTerranOutpostPosition.y" z="$CurrentTerranOutpostPosition.z - 30km"/>
                </create_ship>

                <set_object_min_hull object="$AntigoneMiner" exact="80" comment="Give the illusion of vulnerability, but don't allow it to be destroyed just yet."/>

                <set_object_relation_behaviour object="$AntigoneMiner" disable="true"/>

                <create_order id="'Wait'" object="$AntigoneMiner" default="true">
                  <param name="noattackresponse" value="true"/>
                </create_order>

                <find_object_component groupname="$AntigoneMinerEngines" object="$AntigoneMiner" multiple="true" class="class.engine"/>
                <find_object_component groupname="$AntigoneMinerShields" object="$AntigoneMiner" multiple="true" class="class.shieldgenerator"/>

                <signal_cue cue="Ch4_1_Approach"/>
              </actions>
              <cues>

                <cue name="Ch4_Antigone_Miner_Damaged">
                  <conditions>
                    <event_object_attacked object="$AntigoneMiner"/>
                    <check_value value="$AntigoneMiner.hullpercentage le 15"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch4_3_Debriefing"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch4_1_Approach">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="4"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" object="$AntigoneMiner" text="{30225,1013}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch4_1_Commotion_Dialog_1">
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$AngryMinerActor" recipient="$SecretServiceActor" broadcast="true" priority="100">
                      <text line="30225001" comment="(outraged)This is outrageous!"/>
                      <text line="30225002" comment="(outraged)The Republic will not stand for this!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch4_1_Commotion_Dialog_2">
                  <conditions>
                    <event_speak_finished actor="$AngryMinerActor" line="30225001"/>
                  </conditions>
                  <actions>
                    <speak actor="$SecretServiceActor" recipient="$AngryMinerActor" broadcast="true" priority="100">
                      <text line="30225030" comment="(warningly)Stand down, citizen."/>
                      <text line="30225031" comment="(lecturing)This sector is vital to the defence of Sol, and the entire Jump Gate network."/>
                      <text line="30225032" comment="(reassuringly)Given time, the Antigone Republic will certainly see the benefits of our protection."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch4_1_Commotion_Dialog_3">
                  <conditions>
                    <event_speak_finished actor="$SecretServiceActor" line="30225030"/>
                  </conditions>
                  <actions>
                    <speak actor="$AngryMinerActor" recipient="$SecretServiceActor" broadcast="true" priority="100">
                      <text line="30225003" comment="(outraged)Nonsense!"/>
                      <text line="30225004" comment="(outraged)This is a military occupation of neutral grounds!"/>
                      <text line="30225006" comment="(furious)Damage my ship, hurt my crew, and everyone will see you as the oppressors you really are!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch4_1_Antigone_Miner_Orders">
                  <conditions>
                    <event_speak_finished actor="$AngryMinerActor" line="30225003"/>
                  </conditions>
                  <actions>
                    <create_order id="'Wait'" object="$AntigoneMiner" default="true"/>
                    <create_order id="'MoveGeneric'" object="$AntigoneMiner" name="$AntigoneMinerMoveOrder" immediate="true">
                      <param name="destination" value="$TerranOutpost"/>
                      <param name="noboost" value="true"/>
                    </create_order>
                    <!--<create_order id="'MoveToObject'" object="$AntigoneMiner" name="$AntigoneMinerMoveOrder" immediate="true">
                      <param name="destination" value="$TerranOutpost"/>
                      <param name="noattackresponse" value="true"/>
                    </create_order>-->
                  </actions>
                  <cues>

                    <cue name="Ch4_1_Antigone_Miner_Orders_2">
                      <conditions>
                        <event_object_order_finished object="$AntigoneMiner" order="$AntigoneMinerMoveOrder"/>
                        <check_value value="Ch4_3_Debriefing.state == cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <create_order id="'Attack'" object="$AntigoneMiner" immediate="true">
                          <param name="primarytarget" value="$TerranOutpost"/>
                          <param name="checkrelation" value="false"/>
                          <param name="allowothertargets" value="false"/>
                        </create_order>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <!--<cue name="Ch4_1_Commotion_Dialog_4">
                  <conditions>
                    <event_speak_finished actor="$AngryMinerActor" line="30225003"/>
                  </conditions>
                  <actions>
                    <speak actor="$SecretServiceActor" recipient="$AngryMinerActor" priority="100">
                      <text line="30225033" comment="Move aside, citizen, or my pilots will have to apply controlled force." comment="Don't use. Line got overridden because of a duplicate ID./>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch4_1_Commotion_Dialog_5">
                  <conditions>
                    <event_speak_finished actor="$SecretServiceActor" line="30225033"/>
                  </conditions>
                  <actions>
                    <speak actor="$AngryMinerActor" recipient="$SecretServiceActor" priority="100">
                      <text line="30225005" comment="(sarcastic scoff)Controlled force!" comment="Line doesn't make sense without the previous demand."/>
                      <text line="30225006" comment="(furious)Damage my ship, hurt my crew, and everyone will see you as the oppressors you really are!"/>
                    </speak>
                  </actions>
                </cue>-->

                <cue name="Ch4_1_Commotion_Dialog_6">
                  <conditions>
                    <event_speak_finished actor="$AngryMinerActor" line="30225003"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>
                  </actions>
                  <cues>

                    <cue name="Ch4_1_Secret_Service_Wingmate_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$SecretServiceActor, $WingmateActor, $SecretServiceActor]"/>
                      <param name="CutsceneKey"       value="[$SecretServiceCutsceneKey, $WingmateCutsceneKey, $SecretServiceCutsceneKey]"/>
                      <param name="Lines"             value="[  [[30225033],[30225034]],
                                                                [[30225041]],
                                                                [[30225035],[30225036],[30225037]]
                                                                                                    ]"/>
                      <param name="EndSignalCue"      value="[null, null, Ch4_1_Commotion_Dialog_7]"/>
                      <!--         
                                Delilah:
                                  (showing cracks in her composure)Chikisho, that bumbling buffoon is about to waltz right into our mine field.
                                  Any squads in the vicinity?
                                Wingmate:
                                  Yes, Ma'am!
                                Delilah:
                                  That's a relief!
                                  (stress 'without')Quickly, slow down that ship without injuring its crew.
                                  (stress 'cannot')We cannot have another diplomatic meltdown this soon.
                          -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_1_Commotion_Dialog_7">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$SecretServiceActor" backgroundcomm="true" broadcast="true" priority="100">
                      <text line="30225038" comment="(towards someone in her office)And get me the Chief Secretary on the line, pronto!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch4_1_Commotion_Dialog_8">
                  <conditions>
                    <event_speak_finished actor="$SecretServiceActor" line="30225038"/>
                  </conditions>
                  <cues>

                    <cue name="Ch4_1_Wingmate_Speak_1_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="DelayInitial"      value="1.5s"/>
                      <param name="Lines"             value="[[30225042],[30225043, 0.7s],[30225044]]"/>
                      <param name="EndSignalCue"      value="Ch4_1_Activate_Approach_Check"/>
                      <!--
                            Wingmate:
                              (hesitant)You heard the commander.
                              (hesitant)I'll follow your lead.
                              (to himself, worried)This isn't gonna be pretty.
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_1_Activate_Approach_Check">
                  <conditions>
                    <event_speak_finished actor="$SecretServiceActor" line="30225038"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>
                  </actions>
                  <cues>

                    <cue name="Ch4_1_Approach_AntigoneMiner_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$AntigoneMiner"/>
                      <param name="ApproachDistance"  value="5km"/>
                      <param name="SuccessSignalCue"  value="Ch4_2_Destroy_Engines"/>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch4_2_Destroy_Engines">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,1016}" object="$AntigoneMiner" insert="true" updatebriefing="true"/>
                <find_object_component groupname="$AntigoneMinerEngines" object="$AntigoneMiner" multiple="true" class="class.engine"/>

                <do_if value="$AntigoneMinerEngines.count == 0" comment="engines already destroyed">
                  <signal_cue cue="Ch4_3_Debriefing "/>
                </do_if>

                <play_music music="'music_dlc_terran_story_som_1'"/>
              </actions>
              <cues>

                <cue name="Ch4_2_Update_Objective">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <check_all>
                        <event_object_attacked group="$AntigoneMinerEngines"/>
                        <check_value value="event.param.trueowner == faction.player"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.destroy" group="$AntigoneMinerEngines" text="{30225,1014}" insert="true" updatebriefing="true"/>

                    <do_if value="Ch4_2_Wingmate_Hint.state == cuestate.waiting">
                      <signal_cue cue="Ch4_2_Wingmate_Applause"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch4_2_Update_Obkective_Failsafe">
                  <delay exact="15s"/>
                  <actions>
                    <do_if value="Ch4_2_Update_Objective.state == cuestate.waiting">
                      <signal_cue cue="Ch4_2_Wingmate_Hint"/>
                      <signal_cue cue="Ch4_2_Update_Objective"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch4_2_Wingmate_Applause">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch4_2_Wingmate_Applause_Speak" checkinterval="1s">
                      <conditions>
                        <check_value value="not $MinerCurrentlySpeaking?"/>
                      </conditions>
                      <actions>
                        <set_value name="$WingmateCurrentlySpeaking"/>
                      </actions>
                      <cues>

                        <cue name="Ch4_2_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225045]]"/>
                          <param name="EndSignalCue"      value="Ch4_2_Wingmate_Applause_Finished"/>
                          <!--
                            Wingmate:
                              (applauding)Good call, but stay out of that turret's line of sight!
                            -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch4_2_Wingmate_Applause_Finished">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_value name="$WingmateCurrentlySpeaking"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_2_Wingmate_Hint">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch4_2_Wingmate_Hint_Speak" checkinterval="1s">
                      <conditions>
                        <check_value value="not $MinerCurrentlySpeaking?"/>
                      </conditions>
                      <actions>
                        <set_value name="$WingmateCurrentlySpeaking"/>
                      </actions>
                      <cues>

                        <cue name="Ch4_2_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225046],[30225047]]"/>
                          <param name="EndSignalCue"      value="Ch4_2_Wingmate_Hint_Finished"/>
                          <!--
                            Wingmate:
                              (has an epiphany)Oh, I got it, destroying those engines might slow them down!
                              (worried)Let's be careful to stay out of that turret's line of sight though.
                            -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch4_2_Wingmate_Hint_Finished">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_value name="$WingmateCurrentlySpeaking"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_2_Antigone_Miner_Orders">
                  <actions>
                    <set_object_min_hull object="$AntigoneMiner" exact="10"/>
                    <set_relation_boost object="$AntigoneMiner" faction="faction.terran" value="-1" decay="0"/>
                  </actions>
                </cue>

                <cue name="Ch4_2_Antigone_Miner_Attacked">
                  <conditions>
                    <event_object_attacked object="$AntigoneMiner"/>
                    <check_value value="event.param.trueowner == faction.player"/>
                  </conditions>
                  <actions>
                    <set_relation_boost object="$AntigoneMiner" value="-1" faction="faction.player" decay="0"/>

                    <signal_objects object="$AntigoneMiner.defencenpc" param="'attack'" param2="event.param" param3="[event.param, true, false, [], null, [], event.param]"/>

                    <signal_cue cue="Ch4_2_Miner_Outrage"/>
                  </actions>
                </cue>

                <cue name="Ch4_2_Miner_Outrage">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch4_2_Miner_Outrage_Dialog_1" checkinterval="1s">
                      <conditions>
                        <check_value value="not $WingmateCurrentlySpeaking?"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>

                        <set_value name="$MinerCurrentlySpeaking"/>

                        <speak actor="$AngryMinerActor" recipient="$WingmateActor" broadcast="true" priority="100">
                          <text line="30225007" comment="(furious, fuming at the mouth)I knew it! Terran scum!"/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Ch4_2_Miner_Outrage_Dialog_2">
                      <conditions>
                        <event_speak_finished actor="$AngryMinerActor" line="30225007"/>
                      </conditions>
                      <actions>
                        <speak actor="$WingmateActor" recipient="$AngryMinerActor" broadcast="true" priority="100">
                          <text line="30225048" comment="(stressed)Shut up! We're saving you from yourselves!"/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Ch4_2_Miner_Outrage_Finished">
                      <conditions>
                        <event_speak_finished actor="$WingmateActor" line="30225048"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>

                        <remove_value name="$MinerCurrentlySpeaking"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_2_Collateral_Damange">
                  <delay exact="20s"/>
                  <actions>
                    <do_if value="$AntigoneMiner.exists and $AntigoneMiner.hullpercentage ge 15">
                      <create_object name="$Mine" macro="macro.weapon_gen_mine_01_a_macro" owner="faction.terran" sector="$TerranOutpostSector">
                        <position object="$AntigoneMiner" z="500m"/>
                      </create_object>
                      <do_if value="Ch4_3_Debriefing.state == cuestate.waiting">
                        <reset_cue cue="this"/>
                      </do_if>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch4_2_Engines_Destroyed">
                  <conditions>
                    <event_object_destroyed group="$AntigoneMinerEngines"/>
                    <check_value value="$AntigoneMinerEngines.count == 1"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch4_3_Debriefing"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch4_3_Debriefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,1015}" insert="true" updatebriefing="true"/>

                <play_music music="'music_dlc_terran_story_som_2'"/>
              </actions>
              <cues>

                <cue name="Ch4_4_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30225039],[30225040],[30225041],[30225042],[30225043, 0.7s],[30225044]]"/>
                  <param name="EndSignalCue"      value="Ch4_4_Wingmate_Dialog"/>
                  <!--
                            Delilah:
                              Job well done, squad.
                              Let me be absolutely clear, in case that trespasser's speech got to you: 
                              You are not troublemakers, you are problem solvers.
                              Our neighbours might not see it that way, but the network depends on people like you ...
                              ... people like us, who won't hesitate to do what's necessary.
                              Now, I need you two on stand-by while I sort out this diplomatic mess.
                            -->
                </cue>

                <cue name="Ch4_4_Wingmate_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch4_4_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="DelayInitial"      value="4s"/>
                      <param name="Lines"             value="[[30225054],[30225055],[30225056]]"/>
                      <param name="EndSignalCue"      value="Ch4_Clean_Up_Terran_War_Intro_Mission_1"/>
                      <!--
                            Wingmate:
                              (exhales audibly)A situation like that can even crack a shell as tough as Mission Command's.
                              At least it seems like we did well in her eyes this time.
                              (pleasantly surprised)And we even got a nice sum for our troubles.
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_4_Reset_Antigone_Miner">
                  <actions>
                    <do_if value="$AntigoneMiner.isoperational">
                      <cease_fire object="$AntigoneMiner"/>
                      <cease_fire object="$TerranOutpost"/>
                      <cease_fire object="$WingmateShip"/>
                      <include_actions ref="Setup_Wingmate"/>

                      <reset_relation_boost object="$AntigoneMiner" faction="faction.player"/>
                      <reset_relation_boost object="$AntigoneMiner" faction="faction.terran"/>

                      <do_all exact="$AntigoneMiner.subordinates.count" counter="$sub">
                        <reset_relation_boost object="$AntigoneMiner.subordinates.{$sub}" faction="faction.player" comment="Resetting a relation boost for a ship doesn't automatically affect the ship's turrets."/>
                        <reset_relation_boost object="$AntigoneMiner.subordinates.{$sub}" faction="faction.terran" comment="Resetting a relation boost for a ship doesn't automatically affect the ship's turrets."/>
                      </do_all>

                      <set_object_relation_behaviour object="$AntigoneMiner" disable="false"/>

                      <find_station_by_true_owner name="$AntigoneStation" faction="faction.antigone" sortbygatedistanceto="$AntigoneMiner" space="player.galaxy">
                        <match_dock size="tag.dock_xl"/>
                      </find_station_by_true_owner>

                      <cancel_all_orders object="$AntigoneMiner"/>
                      <create_order id="'Wait'" object="$AntigoneMiner" default="true"/>
                      <create_order id="'MoveDie'" object="$AntigoneMiner">
                        <param name="atstation" value="$AntigoneStation"/>
                      </create_order>

                      <signal_cue cue="Antigone_Miner_Handler"/>
                    </do_if>
                  </actions>
                </cue>

              </cues>
            </cue>

            <!-- This cue is supposed to keep running even when the chapter with the miner gets reset. -->
            <cue name="Antigone_Miner_Handler">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="1min"/>
              <actions>
                <set_object_min_hull object="$AntigoneMiner" exact="0"/>
              </actions>
            </cue>

            <cue name="Ch4_Clean_Up_Terran_War_Intro_Mission_1">
              <conditions>
                <event_cue_signalled />
              </conditions>
              <actions>
                <debug_text text="'Cleaning up Terran War Support Mission 1.'" chance="$DebugChance"/>

                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.terran" title="{30225,1001}" text="{30225,1004}"/>

                <reward_player money="$TerranMissionRewardCr_1"/>

                <do_if value="faction.terran.relationto.{faction.player} le faction.terran.relation.neutral.mid">
                  <set_faction_relation faction="faction.terran" otherfaction="faction.player" value="faction.terran.relation.friend.min"/>
                </do_if>
                <do_else>
                  <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.01" reason="relationchangereason.missioncompleted"/>
                </do_else>

                <signal_cue cue="Ch5_Upgrade"/>
                <cancel_cue cue="Ch4_Erratic_Miner"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- MISSION 2 (Terran Mission 2) -->

        <cue name="Ch5_Upgrade">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_mission cue="$MissionCue" name="{30225,4001}" description="{30225,4002}" type="missiontype.plot" group="missiongroup.story_yaki_solborn" faction="faction.terran" difficulty="level.veryeasy" abortable="true" icon="'briefing_haile_shinamon_01'" iconcaption="$WingmateActor.name">
              <briefing>
                <objective step="1" action="objective.custom" customaction="{30225,4010}"/>
              </briefing>
            </create_mission>

            <set_value name="$CurrentStep"/>

            <include_actions ref="Setup_Wingmate"/>
          </actions>
          <cues>

            <cue name="Ch5_Setup_Equipment_Dock">
              <actions>
                <find_station_by_true_owner name="$TerranEquipmentDock" equipmentdock="true" faction="faction.terran" space="player.galaxy" sortbygatedistanceto="$TerranOutpostSector">
                  <match_dock size="tag.dock_s" walkable="true"/>
                </find_station_by_true_owner>

                <do_if value="not $TerranEquipmentDock">
                  <find_station_by_true_owner name="$TerranEquipmentDock" wharf="true" faction="faction.terran" space="player.galaxy" sortbygatedistanceto="$TerranOutpostSector">
                    <match_dock size="tag.dock_s" walkable="true"/>
                  </find_station_by_true_owner>
                </do_if>

                <do_if value="$TerranEquipmentDock">
                  <find_dockingbay groupname="$TerranEquipmentDockDockingAreas" object="$TerranEquipmentDock" checkoperational="true" multiple="true">
                    <match_dock size="tag.dock_s" walkable="true"/>
                  </find_dockingbay>
                  <signal_cue cue="Ch5_1_Upgrade_Engines"/>
                  <signal_cue cue="Ch5_Side_Mission_Explanation"/>
                </do_if>
                <do_else>
                  <debug_text text="'No Terran equipment dock or wharf with S docks found.'" chance="$DebugChance"/>
                  <signal_cue_instantly cue="Ch5_Clean_Up"/>
                </do_else>
              </actions>
              <cues>

                <cue name="Ch5_Equipment_Dock_Destroyed" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_object_destroyed object="$TerranEquipmentDock"/>
                      <check_all>
                        <event_object_destroyed group="$TerranEquipmentDockDockingAreas"/>
                        <check_value value="$TerranEquipmentDockDockingAreas.count == 1"/>
                      </check_all>
                    </check_any>
                    <check_value value="Ch5_Clean_Up.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <do_if value="Ch5_2_Undock.state == cuestate.waiting">
                      <reset_cue cue="parent"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch5_Clean_Up"/>
                    </do_else>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch5_Side_Mission_Explanation" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch5_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="DelayInitial"      value="4s"/>
                  <param name="Lines"             value="[[30225101],[30225102],[30225103]]"/>
                  <param name="EndSignalCue"      value="Ch5_Side_Mission_Hint"/>
                  <!--
                            Wingmate:
                              This might be a good opportunity to buy a few upgrades for our ships.
                              I've taken the liberty to mark the nearest station for you.
                              If you think you're already set, just let me know.
                            -->
                </cue>

                <cue name="Ch5_Side_Mission_Hint">
                  <actions>
                    <show_help line="834" position="2" force="true" comment="This is an optional side mission. You can abort it in the MISSION MANAGER tab of your map menu." allowclose="true" timeout="true" duration="20s"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch5_1_Upgrade_Engines" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,4010}" object="$TerranEquipmentDock" showunknownpath="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch5_1_Approach_EquipmentDock_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$TerranEquipmentDock"/>
                  <param name="ApproachDistance"  value="3km"/>
                  <param name="SuccessSignalCue"  value="Ch5_1_Equipment_Dock_Approached"/>
                </cue>

                <cue name="Ch5_1_Equipment_Dock_Approached">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch5_1_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225104],[30225105],[30225106]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Wingmate:
                              Keeping up with those Xenon was tough, so I recommend bumping your engines up a tier.
                              And you can never go wrong with better weapons, either.
                              Don't forget to stock up on deployables: Satellites, Nav Beacons, Mines, you never know.
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch5_1_Player_Docked">
                  <conditions>
                    <event_object_docked_at container="$TerranEquipmentDock"/>
                    <check_value value="event.param == player.ship"/>
                  </conditions>
                  <actions>
                    <show_help line="837" position="4" force="true" comment="Your wingmate recommends that you buy a standard satellite, if you don't have any." allowclose="true" timeout="false"/>

                    <signal_cue cue="Ch5_2_Undock"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch5_2_Undock">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,4011}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch5_2_Player_Undocked">
                  <conditions>
                    <event_object_undocked group="global.$PlayerContainerGroup"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch5_Clean_Up"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch5_Clean_Up">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_mission_aborted cue="$MissionCue"/>
                </check_any>
              </conditions>
              <actions>
                <do_if value="event.name == 'event_mission_aborted'">
                  <remove_mission cue="$MissionCue" type="aborted"/>
                </do_if>
                <do_else>
                  <remove_mission cue="$MissionCue" type="completed"/>
                  <write_to_logbook category="missions" faction="faction.terran" title="{30225,4001}" text="{30225,4004}"/>
                </do_else>

                <signal_cue cue="Ch6_Scout"/>
                <cancel_cue cue="Ch5_Upgrade"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch6_Scout">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$TerranMissionRewardCr_2" exact="175000Cr"/>

            <create_mission cue="$MissionCue" name="{30225,2001}" description="{30225,2002}" reward="$TerranMissionRewardCr_2" rewardtext="{30225,2003}" type="missiontype.plot" group="missiongroup.story_yaki_solborn" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'faction_terran'" iconcaption="{30225,108}">
              <briefing>
                <objective step="1" action="objective.custom" customaction="{30225,2010}"/>
                <objective step="2" action="objective.destroy" text="{30225,2012}"/>
              </briefing>
            </create_mission>

            <set_value name="$CurrentStep"/>

            <write_incoming_message title="{30225,2001}" text="{30225,2005}" source="{30225,101}" highpriority="false" comment="Neutral Wrap Email"/>

            <include_actions ref="Setup_Wingmate"/>
          </actions>
          <cues>

            <cue name="Ch6_Setup_Locations">
              <actions>
                <create_position name="$InitialObjectivePosition" space="$TerranOutpostSector" x="60km" y="0" z="115km"/>
                <!--<create_position name="$SatellitePosition" space="$TerranOutpostSector" x="15km" y="0" z="115km" comment="Right in the C nook."/>-->
                <create_position name="$SatellitePosition" space="$TerranOutpostSector" x="45km" y="0" z="135km" comment="New position because outpost shifted to the right."/>
                <create_position name="$XenonScoutSpawnPosition" space="$TerranOutpostSector" x="$SatellitePosition.x + 40km" y="$SatellitePosition.y" z="$SatellitePosition.z - 10km"/>
                <create_position name="$XenonScoutMovePosition" space="$TerranOutpostSector" x="$SatellitePosition.x - 30km" y="$SatellitePosition.y" z="$SatellitePosition.z + 5km"/>

                <signal_cue cue="Ch6_1_Deploy_Satellite"/>
              </actions>
            </cue>

            <cue name="Ch6_1_Deploy_Satellite">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch6_1_Report_For_Duty">
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,2013}" offset="$CurrentTerranOutpostPosition" object="$TerranOutpostSector" radius="10km" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_1_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225107],[30225108]]"/>
                      <param name="EndSignalCue"      value="Ch6_1_Activate_Outpost_Approach_Check"/>
                      <!--
                            Wingmate:
                              All set?
                              Then let's pay the outpost another visit and see what Mission Command has in store for us.
                            -->
                    </cue>

                    <cue name="Ch6_1_Activate_Outpost_Approach_Check">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch6_1_Approach_TerranOutpost_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                          <param name="ApproachTarget"    value="$TerranOutpost"/>
                          <param name="ApproachDistance"  value="10km"/>
                          <param name="SuccessSignalCue"  value="Ch6_1_Briefing_Dialog"/>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_1_Briefing_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch6_1_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30225101],[30225102],[30225103],[30225104],[30225105],[30225106],[30225107],[30225108],[30225109],[30225110]]"/>
                      <param name="EndSignalCue"      value="Ch6_1_Update_Objective_Approach"/>
                      <!--
                            Delilah:
                              Well then, recruits.
                              As a reward for your commitment, let me paint you a bigger picture.
                              High Command might not like it, but if we continue to face the Xenon head-on, scouring the network with imposing fleets, heroically putting out fires wherever they flare up, we are bound to lose this war.
                              (stress every word)Do not misunderstand.
                              The Intervention Corps is indispensable, as long arm of the Protectorate and winged saviour alike.
                              However, this eternal grinder of clashing fleets cannot be a permanent solution.
                              To truly beat the Xenon in a war of attrition, it is paramount that we instead thwart their economy wherever possible.
                              Those parasites are lurking at the edges of our sectors, avoiding our defences and siphoning off our resources.
                              I am putting you on scouting duty.
                              Report any sightings of Xenon infrastructure units directly to me.
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_1_Update_Objective_Approach">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,2010}" object="$TerranOutpostSector" offset="$InitialObjectivePosition" radius="80km" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_1_Wingmate_Secret_Service_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$WingmateActor, $SecretServiceActor, $WingmateActor]"/>
                      <param name="CutsceneKey"       value="[$WingmateCutsceneKey, $SecretServiceCutsceneKey, $WingmateCutsceneKey]"/>
                      <param name="Lines"             value="[  [[30225109],[30225110],[30225111],[30225112],[30225113]],
                                                                [[30225111],[30225112],[30225113],[30225114],[30225115]],
                                                                [[30225041]]
                                                                                                    ]"/>
                      <param name="EndSignalCue"      value="[null, null, Ch6_1_Update_Objective_Satellite]"/>
                      <!--         
                                Wingmate:
                                  She does have a very good point, which gives me an idea...
                                  See, the Xenon might appear as an unstoppable and unknowable tide at first glance, but the way they wage war isn't so different from ours.
                                  Like us, they rely on their scouts to gauge their enemy’s strength, and send an appropriate force to deal with them. 
                                  But unlike us, they’re simple minded machines. It's all action, reaction.
                                  So, if we attack a scout somewhere in no man’s land...
                                Delilah:
                                  … we can divert their forces, potentially leaving their infrastructure units unprotected.
                                  Yes, my staff is always listening in.
                                  You may go ahead with your plan, but be warned.
                                  The Xenon are not just simple machines. They’re erratic, unpredictable, deadly.
                                  (intense)Stay alert at all times.
                                Wingmate:
                                  Yes, Ma'am!
                          -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_1_Update_Objective_Satellite">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch6_1_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225114],[30225115]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Wingmate:
                              I've picked out a nice spot for our operation; not too far from the outpost, but still close enough to the Xenon-infested outskirts of the sector.
                              A satellite might serve as bait, and help us spot incoming scouts at a distance.
                            -->
                    </cue>

                    <cue name="Ch6_1_DeployInPlace_Ref" ref="md.RML_DeployInPlace.DeployInPlace">
                      <!-- always pass these -->
                      <param name="EndSignalCue"                  value="Ch6_1_DeployInPlace_Finished"/>
                      <param name="MissionCue"                    value="$MissionCue"/>
                      <param name="StartStep"                     value="$CurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"                value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"                   value="$DebugChance"/>
                      <param name="ObjectiveText"                 value="{30136,130}"/>
                      <param name="ObjectiveText_Plural"          value="{30136,131}"/>
                      <param name="ObjectiveText_InRange"         value="{30136,132}"/>
                      <param name="ObjectiveText_InRange_Plural"  value="{30136,133}"/>

                      <!-- mission-related parameters -->
                      <param name="TargetSector"        value="$TerranOutpostSector"/>
                      <param name="TargetOffset"        value="$SatellitePosition"/>
                      <param name="TargetRadius"        value="3km"/>
                      <param name="TargetCount"         value="1"/>
                      <param name="DeployableCategory"  value="deployablecategory.satellite"/>
                      <param name="Faction"             value="faction.player"/>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_1_DeployInPlace_Finished">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_object name="$ScoutSatellite" owner="faction.player" space="$TerranOutpostSector" sortbydistanceto="player.ship"/>
                    <signal_cue cue="Ch6_2_Approach_Scout"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_2_Approach_Scout">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30225,2011}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch6_2_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30225116],[30225117]]"/>
                  <param name="EndSignalCue"      value="Ch6_2_Setup_Xenon_Scout"/>
                  <!--
                            Wingmate:
                              You've already seen how fast these things are.
                              As soon as one appears, try to shoot it out of its travel drive.
                            -->
                </cue>

                <cue name="Ch6_2_Setup_Xenon_Scout">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_ship name="$XenonScout" macro="macro.ship_xen_s_scout_01_a_macro" commandeerable="false" capturable="false" missioncue="$MissionCue" sector="$TerranOutpostSector">
                      <owner exact="faction.xenon" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.xenon" tags="tag.fighterpilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <drop ref="ship_small_xenon"/>
                      <safepos value="$XenonScoutSpawnPosition"/>
                    </create_ship>

                    <set_object_min_hull object="$XenonScout" exact="10"/>

                    <set_drop_object object="$XenonScout" drop="'drops_yakistory_xenonscoutdrop_1'"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_2_Approach_Satellite_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="$XenonScout"/>
                      <param name="ApproachTarget"    value="$ScoutSatellite"/>
                      <param name="ApproachDistance"  value="30km"/>
                      <param name="SuccessSignalCue"  value="Ch6_2_Satellite_Approached"/>
                    </cue>

                    <cue name="Ch6_2_Satellite_Approached">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="Ch6_2_Update_Objective.state == cuestate.waiting">
                          <signal_cue cue="Ch6_2_Update_Objective"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch6_2_Xenon_Scout_Loop">
                      <cues>

                        <cue name="Ch6_2_Xenon_Scout_Loop_Orders">
                          <actions>
                            <cancel_all_orders object="$XenonScout"/>
                            <create_order id="'MoveWait'" name="$XenonScoutMoveOrder" object="$XenonScout" default="true">
                              <param name="destination" value="[$TerranOutpostSector, $XenonScoutMovePosition]"/>
                              <param name="noattackresponse" value="true"/>
                            </create_order>
                          </actions>
                        </cue>

                        <cue name="Ch6_2_Order_Loop_Position_Reached" checkinterval="1s">
                          <conditions>
                            <check_value value="@$XenonScout.distanceto.[$TerranOutpostSector, $XenonScoutMovePosition]" max="10km"/>
                          </conditions>
                          <actions>
                            <cancel_all_orders object="$XenonScout"/>
                            <create_order id="'MoveWait'" object="$XenonScout" default="true">
                              <param name="destination" value="[$YakiExitSector, position.[0,0,0]]"/>
                              <param name="noattackresponse" value="true"/>
                            </create_order>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch6_2_Failsafe">
                      <delay exact="10s"/>
                      <actions>
                        <do_if value="Ch6_2_Update_Objective.state == cuestate.waiting">
                          <signal_cue cue="Ch6_2_Update_Objective"/>
                        </do_if>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_2_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,2014}" object="$XenonScout" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_2_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225118]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Wingmate:
                              There!
                            -->
                    </cue>

                    <cue name="Ch6_2_Scout_Got_Away" checkinterval="1s">
                      <conditions>
                        <check_value value="$XenonScout.distanceto.{$CurrentPlayerShip} ge 50km"/>
                      </conditions>
                      <actions>
                        <set_object_min_hull object="$XenonScout" exact="0"/>
                      </actions>
                      <cues>

                        <cue name="Ch6_2_Wingmate_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225119],[30225120]]"/>
                          <param name="EndSignalCue"      value="Ch6_Clean_Up"/>
                          <!--
                            Wingmate:
                              Bastu!
                              I really hope it still reported us as a threat.
                            -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch6_2_Xenon_Scout_Hit">
                      <conditions>
                        <event_object_attacked object="$XenonScout"/>
                        <check_value value="event.param.trueowner == faction.player"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch6_2_Scout_Got_Away"/>
                        <signal_cue cue="Ch6_3_Disable_Scout"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_3_Disable_Scout">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentPlayerShip" exact="player.ship"/>

                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,2015}" object="$XenonScout" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch6_3_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30225121]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                            Wingmate:
                              Give it something to think about!
                            -->
                </cue>

                <cue name="Ch6_3_Xenon_Scout_Orders">
                  <actions>
                    <cancel_cue cue="Ch6_2_Xenon_Scout_Loop"/>
                    <cancel_all_orders object="$XenonScout"/>
                    <create_order id="'Wait'" object="$XenonScout" default="true"/>
                    <create_order id="'Attack'" object="$XenonScout" immediate="true">
                      <param name="primarytarget" value="player.ship"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch6_3_Xenon_Scout_Disabled">
                  <conditions>
                    <!-- Xenon T is very difficult to catch, so dropping its shields is okay. -->
                    <event_object_attacked object="$XenonScout"/>
                    <check_value value="$XenonScout.hullpercentage lt 100"/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,2016}" updatebriefing="true"/>

                    <cancel_all_orders object="$XenonScout"/>
                    <create_order id="'Wait'" object="$XenonScout" default="true">
                      <param name="noattackresponse" value="true"/>
                    </create_order>
                    <set_relation_boost object="$XenonScout" faction="faction.player" value="0.1" decay="0"/>
                    <set_relation_boost object="$XenonScout" otherobject="$WingmateShip" value="0.1" decay="0"/>
                    <set_owner object="$XenonScout" faction="faction.ownerless" overridenpc="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_3_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225122],[30225123],[30225124]]"/>
                      <param name="EndSignalCue"      value="Ch6_4_Scan_Scout"/>
                      <!--
                            Wingmate:
                              Stop, stop!
                              (nervous)Don’t destroy it just yet.
                              (nervous)I… just want a closer look while we got the chance.
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_4_Scan_Scout">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" object="$XenonScout" customaction="{30225,2017}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch6_4_Dialog_1">
                  <delay exact="5s"/>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$NellieActor" recipient="$WingmateActor" broadcast="true" priority="100">
                      <text line="30225101" comment="Unauthorised data stream detected."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch6_4_Dialog_2">
                  <conditions>
                    <event_speak_finished actor="$NellieActor" line="30225101"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>
                  </actions>
                  <cues>

                    <cue name="Ch6_4_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225125],[30225126]]"/>
                      <param name="EndSignalCue"      value="Ch6_5_Destroy_Scout"/>
                      <!--
                            Wingmate:
                              (nervous)Okay, okay, I know, we're not supposed to...
                              (nervous)Let's just blow it up, alright?
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_4_Wingmate_Orders">
                  <actions>
                    <cancel_all_orders object="$WingmateShip"/>
                    <create_order id="'Wait'" object="$WingmateShip" default="true"/>
                    <create_order id="'MoveToObject'" object="$WingmateShip" immediate="true">
                      <param name="destination" value="$XenonScout"/>
                    </create_order>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_5_Destroy_Scout">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.destroy" object="$XenonScout" text="{30225,2011}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch6_5_Make_Scout_Vulnerable">
                  <actions>
                    <set_object_min_hull object="$XenonScout" exact="0"/>
                    <set_owner object="$XenonScout" faction="faction.xenon" overridenpc="true"/>
                    <reset_relation_boost object="$XenonScout" faction="faction.player"/>
                    <reset_relation_boost object="$XenonScout" otherobject="$WingmateShip"/>
                  </actions>
                  <delay exact="10s"/>
                  <actions>
                    <do_if value="$XenonScout.isoperational">
                      <destroy_object object="$XenonScout" explosion="true" comment="Failsafe."/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch6_5_Wingmate_Orders">
                  <actions>
                    <cancel_all_orders object="$WingmateShip"/>
                    <create_order id="'Wait'" object="$WingmateShip" default="true"/>
                    <create_order id="'Attack'" object="$WingmateShip" immediate="true">
                      <param name="primarytarget" value="$XenonScout"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                      <param name="allowothertargets" value="false"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch6_5_Xenon_Scout_Destroyed">
                  <conditions>
                    <event_object_destroyed object="$XenonScout"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_5_Dialog"/>
                  </actions>
                </cue>

                <cue name="Ch6_5_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch6_5_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225127]]"/>
                      <param name="EndSignalCue"      value="Ch6_Clean_Up"/>
                      <!--
                            Wingmate:
                              (clears throat)Please don't tell anyone about that.
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_Clean_Up" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <do_if value="$XenonScout.isoperational">
                  <set_object_min_hull object="$XenonScout" exact="0"/>
                  <cancel_all_orders object="$XenonScout"/>
                  <create_order id="'Recon'" object="$XenonScout" default="true">
                    <param name="targetspace" value="$YakiExitSector"/>
                    <param name="exploreupdate" value="true"/>
                  </create_order>
                </do_if>

                <signal_cue cue="Ch7_Infrastructure"/>
                <cancel_cue cue="Ch6_Scout"/>
              </actions>
              <patch sinceversion="2" state="cancelled">
                <do_if value="$XenonScout.exists">
                  <set_object_min_hull object="$XenonScout" exact="0"/>
                </do_if>
              </patch>
            </cue>

          </cues>
        </cue>

        <cue name="Ch7_Infrastructure">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <update_mission cue="$MissionCue" comment="Collapse objective steps.">
              <briefing replace="true">
                <objective step="1" action="objective.custom" customaction="{30225,2010}"/>
                <objective step="2" action="objective.destroy" text="{30225,2012}"/>
              </briefing>
            </update_mission>

            <set_value name="$CurrentStep" exact="2"/>

            <include_actions ref="Setup_Wingmate"/>
          </actions>
          <cues>

            <cue name="Ch7_Setup_Locations">
              <actions>
                <create_position name="$InfrastructureSpawnPosition" space="$TerranOutpostSector" x="135km" y="0km" z="120km" comment="In an asteroid field close to the Xenon gate."/>
              </actions>
            </cue>

            <cue name="Ch7_Setup_Xenon_Squad">
              <actions>
                <!-- Xenon squad that checks the scout's position -->
                <set_value name="$XenonEscortComposition" exact="[
                   [ macro.ship_xen_m_corvette_02_a_macro, 1 ],
                   [ macro.ship_xen_s_fighter_02_a_macro, 6 ]
                   ]" />
                <do_all exact="$XenonEscortComposition.count" counter="$m">
                  <do_all exact="$XenonEscortComposition.{$m}.{2}" counter="$a">
                    <create_ship name="$CurrentShip" macro="$XenonEscortComposition.{$m}.{1}" commandeerable="false" capturable="false" missioncue="$MissionCue" sector="$TerranOutpostSector">
                      <owner exact="faction.xenon" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.xenon" tags="tag.fighterpilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <drop ref="ship_small_xenon"/>
                      <safepos value="$InfrastructureSpawnPosition"/>
                    </create_ship>
                    <create_order id="'Wait'" object="$CurrentShip" default="true"/>
                    <do_if value="$m == 1 and $a == 1" comment="First ship in the list becomes commander.">
                      <set_value name="$XenonEscortCommander" exact="$CurrentShip"/>
                      <create_order id="'MoveWait'" object="$CurrentShip">
                        <param name="destination" value="[$TerranOutpostSector, $SatellitePosition]"/>
                      </create_order>
                    </do_if>
                    <do_else>
                      <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                        <param name="commander" value="$XenonEscortCommander"/>
                        <param name="assignment" value="assignment.defence"/>
                        <param name="cancelorders" value="true"/>
                      </create_order>
                    </do_else>
                    <add_to_group groupname="$XenonEscortGroup" object="$CurrentShip"/>
                  </do_all>
                </do_all>

                <signal_cue cue="Ch7_1_Diversion"/>
              </actions>
            </cue>

            <cue name="Ch7_1_Diversion">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" group="$XenonEscortGroup" customaction="{30225,2018}" insert="true" updatebriefing="true"/>

                <play_music music="'music_dlc_terran_story_som_3'"/>
              </actions>
              <cues>

                <cue name="Ch7_1_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30225128],[30225129],[30225130]]"/>
                  <param name="EndSignalCue"      value="Ch7_2_Destroy"/>
                  <!--
                            Wingmate:
                              Here they come, and not a second too soon!
                              Let's hurry past them before their stupid machine brains have time to react.
                              These fools don't even realise they're pointing us right at out target.
                            -->
                </cue>

              </cues>
            </cue>

            <cue name="Ch7_2_Destroy">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch7_2_Setup_Xenon_Infrastructure">
                  <actions>
                    <!-- Mission targets: Xenon infrastructure units -->
                    <set_value name="$XenonInfrastructureComposition" exact="[
                                      [ macro.ship_xen_m_miner_01_a_macro, 2 ]
                                      ]" />
                    <do_all exact="$XenonInfrastructureComposition.count" counter="$m">
                      <do_all exact="$XenonInfrastructureComposition.{$m}.{2}" counter="$a">
                        <create_ship name="$CurrentShip" macro="$XenonInfrastructureComposition.{$m}.{1}" commandeerable="false" capturable="false" missioncue="$MissionCue" sector="$TerranOutpostSector">
                          <owner exact="faction.xenon" overridenpc="true"/>
                          <pilot>
                            <select faction="faction.xenon" tags="tag.fighterpilot"/>
                          </pilot>
                          <loadout>
                            <level exact="0.1"/>
                          </loadout>
                          <drop ref="ship_small_xenon"/>
                          <safepos value="$InfrastructureSpawnPosition"/>
                        </create_ship>
                        <create_order id="'Wait'" object="$CurrentShip" default="true"/>
                        <add_to_group groupname="$XenonInfrastructureGroup" object="$CurrentShip"/>
                      </do_all>
                    </do_all>

                    <signal_cue cue="Ch7_2_Update_Objective_Find"/>
                  </actions>
                  <cues>

                    <cue name="Ch7_2_Xenon_Infrastructure_Loop">
                      <cues>

                        <cue name="Ch7_2_Xenon_Infrastructure_Loop_Orders">
                          <actions>
                            <do_if value="$XenonInfrastructureGroup.count">
                              <set_value name="$PositionX" min="$InfrastructureSpawnPosition.x -2km" max="$InfrastructureSpawnPosition.x +2km" scale="3" profile="inversebell"/>
                              <set_value name="$PositionZ" min="$InfrastructureSpawnPosition.z -2km" max="$InfrastructureSpawnPosition.z +2km" scale="3" profile="inversebell"/>
                              <create_position name="$XenonInfrastructureMovePosition" space="$YakiExitSector" x="$PositionX" y="0km" z="$PositionZ"/>

                              <do_for_each in="$XenonInfrastructureGroup" name="$CurrentShip">
                                <cancel_all_orders object="$CurrentShip"/>
                                <create_order id="'Wait'" object="$CurrentShip" default="true"/>
                                <create_order id="'MoveWait'" name="$XenonInfrastructureMoveOrder" object="$CurrentShip" immediate="true">
                                  <param name="destination" value="[$TerranOutpostSector, $XenonInfrastructureMovePosition]"/>
                                </create_order>
                              </do_for_each>
                            </do_if>
                            <do_else>
                              <cancel_cue cue="Ch7_2_Xenon_Infrastructure_Loop"/>
                            </do_else>
                          </actions>
                          <delay exact="20s"/>
                          <actions>
                            <reset_cue cue="this"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch7_2_Update_Objective_Find">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.find" object="$TerranOutpostSector" offset="$InfrastructureSpawnPosition" radius="10km" text="{30225,2012}" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch7_2_Approach_Infrastructure_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$XenonInfrastructureGroup.random"/>
                      <param name="ApproachDistance"  value="3km"/>
                      <param name="SuccessSignalCue"  value="Ch7_2_Update_Objective_Destroy"/>
                    </cue>

                    <cue name="Ch7_2_Update_Objective_Destroy">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_long_range_scan_ping group="$XenonInfrastructureGroup"/>
                          <check_all>
                            <event_object_attacked group="$XenonInfrastructureGroup"/>
                            <check_value value="event.param.trueowner == faction.player"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <include_actions ref="Setup_Wingmate"/>

                        <signal_cue cue="Ch7_2_Wingmate_Hint"/>

                        <cancel_cue cue="Ch7_2_Approach_Infrastructure_Ref"/>

                        <set_value name="$CurrentStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.destroy" group="$XenonInfrastructureGroup" text="{30225,2012}" updatebriefing="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch7_2_Wingmate_Hint">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch7_2_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225131]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Wingmate:
                              Infrastructure units, and undefended!
                            -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch7_2_Infrastructure_Attacked_Hint">
                      <conditions>
                        <event_object_attacked group="$XenonInfrastructureGroup"/>
                        <check_value value="event.param.trueowner == faction.player"/>
                      </conditions>
                      <cues>

                        <cue name="Ch7_2_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225132],[30225133]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Wingmate:
                              Like sitting ducks!
                              Hide under their bellies, that way their turrets can't hit you!
                            -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch7_2_Infrastructure_Destroyed">
                      <conditions>
                        <event_object_destroyed group="$XenonInfrastructureGroup"/>
                        <check_value value="$XenonInfrastructureGroup.count == 1"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch7_3_Beacon"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch7_3_Beacon">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch7_3_Setup_Another_Strange_Beacon">
                  <actions>
                    <create_object name="$AnotherStrangeBeacon" macro="macro.env_deco_nav_beacon_t1_mission_macro" owner="faction.yaki" sector="$TerranOutpostSector">
                      <safepos value="$InfrastructureSpawnPosition"/>
                    </create_object>

                    <signal_cue cue="Ch7_3_Update_Objective"/>
                  </actions>
                </cue>

                <cue name="Ch7_3_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.investigate" text="{30225,1021}" object="$AnotherStrangeBeacon" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch7_3_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225134],[30225135]]"/>
                      <param name="EndSignalCue"      value="Ch7_3_Dialog_1"/>
                      <!--
                            Wingmate:
                              Perfect! Now, let's return to the outpost and...
                              Wait, is that another one of those nav beacons?!
                            -->
                    </cue>

                    <cue name="Ch7_3_Wingmate_Orders">
                      <actions>
                        <cancel_all_orders object="$WingmateShip"/>
                        <create_order id="'Wait'" object="$WingmateShip" default="true"/>
                        <create_order id="'MoveToObject'" object="$WingmateShip" immediate="true">
                          <param name="destination" value="$AnotherStrangeBeacon"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch7_3_Dialog_1">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>

                        <speak actor="$WingmateActor" recipient="$NellieActor" broadcast="true" priority="100">
                          <text line="30284035" comment="Nellie? Analysis"/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Ch7_3_Dialog_2">
                      <conditions>
                        <event_speak_finished actor="$WingmateActor" line="30284035"/>
                      </conditions>
                      <actions>
                        <speak actor="$NellieActor" recipient="$WingmateActor" broadcast="true" priority="100">
                          <text line="30225102" comment="Unknown signal source triangulated."/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Ch7_3_Dialog_3">
                      <conditions>
                        <event_speak_finished actor="$NellieActor" line="30225102"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>
                      </actions>
                      <cues>

                        <cue name="Ch7_3_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$WingmateActor"/>
                          <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                          <param name="Lines"             value="[[30225136],[30225137]]"/>
                          <param name="EndSignalCue"      value="Ch7_Clean_Up"/>
                          <!--
                            Wingmate:
                              It's that same signal as before!
                              They're not getting away this time!
                            -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch7_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <signal_cue cue="Ch8_Investigate_Signal"/>
                <cancel_cue cue="Ch7_Infrastructure"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch8_Investigate_Signal">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <include_actions ref="Setup_Wingmate"/>
          </actions>
          <cues>

            <cue name="Ch8_Setup_Beacons">
              <actions>
                <find_gate name="$YakiExitGateTerranSide" space="$TerranOutpostSector" destination="$YakiExitSector"/>
                <create_position name="$YakiExitGateTerranSidePosition" space="$TerranOutpostSector" object="$YakiExitGateTerranSide"/>

                <find_gate name="$YakiExitGateXenonSide" space="$YakiExitSector" destination="$TerranOutpostSector"/>
                <create_position name="$YakiExitGateXenonSidePosition" space="$YakiExitSector" object="$YakiExitGateXenonSide"/>

                <create_position name="$YakiBeaconPosition_1" space="$TerranOutpostSector" x="$YakiExitGateTerranSidePosition.x - 12km" y="$YakiExitGateTerranSidePosition.y" z="$YakiExitGateTerranSidePosition.z"/>
                <create_position name="$YakiBeaconPosition_1_SearchOffset" space="$TerranOutpostSector" x="$YakiBeaconPosition_1.x + 1km" y="$YakiBeaconPosition_1.y" z="$YakiBeaconPosition_1.z - 2km"/>

                <create_position name="$YakiBeaconPosition_2" space="$YakiExitSector" x="-60km" z="20km"/>

                <create_position name="$YakiBeaconPosition_3" space="$YakiExitSector" x="-50km" z="150km"/>

                <create_object name="$YakiBeacon_1" macro="macro.env_deco_nav_beacon_t1_macro" owner="faction.yaki" sector="$TerranOutpostSector">
                  <safepos value="$YakiBeaconPosition_1"/>
                </create_object>

                <create_object name="$YakiBeacon_2" macro="macro.env_deco_nav_beacon_t1_macro" owner="faction.yaki" sector="$YakiExitSector">
                  <safepos value="$YakiBeaconPosition_2"/>
                </create_object>

                <create_object name="$YakiBeacon_3" macro="macro.env_deco_nav_beacon_t1_macro" owner="faction.yaki" sector="$YakiExitSector">
                  <safepos value="$YakiBeaconPosition_3"/>
                </create_object>

                <signal_cue cue="Ch8_1_Find_Beacon"/>
              </actions>
            </cue>

            <cue name="Ch8_1_Find_Beacon">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,2019}" object="$TerranOutpostSector" offset="$YakiBeaconPosition_1_SearchOffset" radius="7km" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch8_1_Approach_Yaki_Beacon_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$YakiBeacon_1"/>
                  <param name="ApproachDistance"  value="4km"/>
                  <param name="SuccessSignalCue"  value="Ch8_1_Yaki_Beacon_Reached"/>
                </cue>

                <cue name="Ch8_1_Yaki_Beacon_Reached">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="Ch8_2_Investigate_Beacon.state == cuestate.waiting">
                      <signal_cue cue="Ch8_2_Investigate_Beacon"/>
                      <cancel_cue cue="Ch8_1_Yaki_Beacon_Long_Range_Scanned"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch8_1_Yaki_Beacon_Long_Range_Scanned">
                  <conditions>
                    <event_long_range_scan_ping object="$YakiBeacon_1"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch8_2_Investigate_Beacon"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch8_2_Investigate_Beacon">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.investigate" object="$YakiBeacon_1" text="{30225,1021}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch8_2_Approach_Yaki_Beacon_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$YakiBeacon_1"/>
                  <param name="ApproachDistance"  value="2km"/>
                  <param name="SuccessSignalCue"  value="Ch8_2_Wingmate_Dialog"/>
                </cue>

                <cue name="Ch8_2_Wingmate_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch8_2_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$WingmateActor"/>
                      <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                      <param name="Lines"             value="[[30225138],[30225139],[30225140]]"/>
                      <param name="EndSignalCue"      value="Ch8_3_Follow_Trail"/>
                      <!--
                            Wingmate:
                              (feels validated)Another one!
                              (determined)I knew something was brewing!
                              (determined, commanding)Come on, we're about to bust this mystery wide open!
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch8_3_Follow_Trail">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <reset_cue cue="Activate_Wingmate_Handlers" comment="Stops player from interfering with the Wingmate's movement."/>

                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.follow" object="$YakiBeacon_2" text="{30225,2020}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch8_3_Wingmate_Orders">
                  <actions>
                    <cancel_all_orders object="$WingmateShip"/>
                    <create_order id="'MoveWait'" object="$WingmateShip" default="true">
                      <param name="destination" value="[$YakiExitSector, $YakiBeaconPosition_2]"/>
                      <param name="noattackresponse" value="true"/>
                    </create_order>
                  </actions>
                </cue>

                <!-- These cues are just there to give the player something to do while they listen to the dialog. -->
                <cue name="Ch8_3_Yaki_Beacon_Long_Range_Scanned">
                  <conditions>
                    <event_long_range_scan_ping object="$YakiBeacon_2"/>
                  </conditions>
                  <actions>
                    <do_if value="(Ch8_4_Flee.state == cuestate.waiting) and (Ch8_3_Yaki_Beacon_Approached.state == cuestate.waiting)">
                      <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.follow" object="$YakiBeacon_2" text="{30225,2020}" updatebriefing="true"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch8_3_Approach_YakiBeacon_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$YakiBeacon_2"/>
                  <param name="ApproachDistance"  value="3km"/>
                  <param name="SuccessSignalCue"  value="Ch8_3_Yaki_Beacon_Approached"/>
                </cue>

                <cue name="Ch8_3_Yaki_Beacon_Approached">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="Ch8_4_Flee.state == cuestate.waiting">
                      <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.follow" object="$YakiBeacon_3" text="{30225,2020}" updatebriefing="true"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch8_3_Already_In_Sector">
                  <actions>
                    <do_if value="player.sector == $YakiExitSector">
                      <signal_cue cue="Ch8_3_Player_Entered_Sector"/>
                    </do_if>
                    <do_elseif value="$WingmateShip.sector == $YakiExitSector">
                      <signal_cue cue="Ch8_3_Wingmate_Entered_Sector"/>
                    </do_elseif>
                  </actions>
                </cue>

                <!-- These are the cues that are actually relevant. -->
                <cue name="Ch8_3_Player_Entered_Sector">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_changed_sector object="player.entity" sector="$YakiExitSector"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <play_music music="'music_dlc_terran_story_som_4'"/>

                    <signal_cue cue="Ch8_3_Dialog_1"/>
                    <signal_cue cue="Ch8_3_Yaki_Fly_By"/>
                  </actions>
                </cue>

                <cue name="Ch8_3_Wingmate_Entered_Sector">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_cue_completed cue="Ch8_3_Player_Entered_Sector"/>
                      <event_object_changed_sector object="$WingmateShip" sector="$YakiExitSector"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <reset_cue cue="Activate_Wingmate_Handlers"/>

                    <warp object="$WingmateShip" sector="$YakiHomeSector">
                      <safepos value="position.[0,0,0]"/>
                    </warp>
                    <destroy_object object="$WingmateShip" explosion="false"/>
                  </actions>
                </cue>

                <cue name="Ch8_3_Dialog_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="7s"/>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$WingmateActor" priority="100">
                      <text line="30225141" comment="(energetic)More beacons, and they form a trail!"/>
                      <text line="30225142" delay="1s" comment="(pushy)Onward, I'm right behind you!"/>
                      <text line="30225143" delay="2s" comment="(make it sound like the line before, but cut shorter)I'm right behind you!"/>
                      <text line="30225144" delay="2s" comment="(make it sound like the line before, but cut shorter)... right behind you!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch8_3_Dialog_2_Visual">
                  <conditions>
                    <event_speak_finished actor="$WingmateActor" line="30225141"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>
                  </actions>
                  <cues>

                    <cue name="Ch8_3_Obelisk_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiRenegadeActor"/>
                      <param name="CutsceneKey"       value="$YakiRenegadeCutsceneKey"/>
                      <param name="DelayInitial"      value="2s"/>
                      <param name="Lines"             value="[[30225101],[30225102, 0.7s]]"/>
                      <param name="EndSignalCue"      value="Ch8_3_Dialog_3"/>
                      <!--
                            Obelisk:
                              (menacing)Right behind you.
                              ***evil laughter***
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch8_3_Dialog_2_Laughter" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Keep old cue in case a story beta tester / content creator managed to save while this or Ch8_3_Obelisk_Speak_1_Ref was active. -->
                    <signal_cue cue="Ch8_3_Dialog_3"/>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="Ch8_3_Dialog_3.state == cuestate.waiting">
                      <signal_cue cue="Ch8_3_Dialog_3"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch8_3_Dialog_3">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1.5s"/>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$YakiLeaderActor" priority="100">
                      <text line="30225101" comment="(shouting, a bit uneasy)Obelisk! Obelisk, what are you doing?!"/>
                      <text line="30225102" delay="0.5s" comment="(shouting, commanding)By Moo-Kye's stinking breath, leave them in peace!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch8_3_Dialog_4">
                  <conditions>
                    <event_speak_finished actor="$YakiLeaderActor" line="30225101"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <speak actor="$YakiRenegadeActor" priority="100">
                      <text line="30225103" comment="(unhinged, close to screaming)Never!"/>
                      <text line="30225104" delay="0.5s" comment="(unhinged, close to screaming)I've seen you and your little puppets cower in fear long enough!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch8_3_Dialog_5">
                  <conditions>
                    <event_speak_finished actor="$YakiRenegadeActor" line="30225103"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <speak actor="$YakiLeaderActor" priority="100">
                      <text line="30225103" comment="(shouting, commanding)No! Stop right this instant!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch8_3_Dialog_6">
                  <conditions>
                    <event_speak_finished actor="$YakiLeaderActor" line="30225103"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <speak actor="$YakiRenegadeActor" priority="100">
                      <text line="30225105" comment="(unhinged, close to screaming)Curse you, Kendai!"/>
                      <text line="30225106" delay="0.5s" comment="(unhinged, close to screaming)Your chains will not shackle me any longer!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch8_3_Dialog_7">
                  <conditions>
                    <event_speak_finished actor="$YakiRenegadeActor" line="30225105"/>
                  </conditions>
                  <actions>
                    <warp object="$YakiShip" sector="$YakiHomeSector">
                      <safepos value="position.[0,0,0]"/>
                    </warp>
                    <destroy_object object="$YakiShip" explosion="false"/>

                    <play_sound sound="'yaki_xenon_call'" object="player.entity"/>
                  </actions>
                  <delay exact="6s"/>
                  <actions>
                    <play_music music="'music_dlc_terran_story_som_5'"/>

                    <speak actor="$SecretServiceActor" priority="100">
                      <text line="30225116" comment="(as if interrupted by static)... enemy movement ..."/>
                      <text line="30225117" delay="0.5s" comment="(as if interrupted by static)... all squads, return to base immediately!"/>
                      <text line="30225119" delay="0.5s" comment="The entire sector is descending on us!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch8_3_Dialog_Finished">
                  <conditions>
                    <event_speak_finished actor="$SecretServiceActor" line="30225116"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <signal_cue cue="Ch8_4_Flee"/>
                  </actions>
                </cue>

                <cue name="Ch8_3_Yaki_Fly_By">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_ship name="$YakiShip" macro="ship_yak_m_corvette_01_a_macro" sector="$YakiExitSector" missioncue="$MissionCue" capturable="false">
                      <owner exact="faction.yaki" overridenpc="true" />
                      <pilot actor="$YakiRenegadeActor"/>
                      <loadout loadout="$YakiRenegadeLoadout"/>
                      <!-- Paint mod: Violaceous Xenomask (Yaki Camo 2)-->
                      <paint ware="ware.paintmod_0125"/>
                      <safepos object="$YakiBeacon_2"/>
                      <rotation yaw="-150deg"/>
                    </create_ship>

                    <set_object_name object="$YakiShip" page="30226" line="208" comment="Wolfish Heart"/>

                    <set_object_min_hull object="$YakiShip" exact="10"/>

                    <create_order id="'Wait'" object="$YakiShip" default="true">
                      <param name="noattackresponse" value="true"/>
                    </create_order>

                    <create_order id="'MoveWait'" object="$YakiShip" immediate="true">
                      <param name="destination" value="[$TerranOutpostSector, $YakiBeaconPosition_1]"/>
                      <param name="noattackresponse" value="true"/>
                    </create_order>
                  </actions>
                  <cues>

                    <!-- Legacy cue, originally triggered by $YakiShip gate traversal, in case we need it for patching. -->
                    <cue name="Ch8_3_Yaki_Fly_By_Complete">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch8_4_Flee">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$DefenceStart" exact="player.age"/>
                <set_value name="$DefenceDuration" exact="10min"/>
                <cancel_cue cue="Setup_Terran_Outpost" comment="From here on, if it gets destroyed, it's gone for good."/>

                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" object="$TerranOutpost" customaction="{30225,2021}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <library name="Ch8_4_Collect_Nearby_Xenon">
                  <actions>
                    <find_ship_by_true_owner groupname="$NearbyXenon" faction="faction.xenon" class="class.ship" primarypurpose="purpose.fight" excluded="$XenonHorde" space="$TerranOutpostSector" multiple="true">
                      <match_distance object="$TerranOutpost" max="40km" comment="Radar range."/>
                    </find_ship_by_true_owner>

                    <debug_text text="$NearbyXenon.count + ' additional nearby Xenon found.'"/>
                    <do_for_each in="$NearbyXenon" name="$CurrentShip" counter="$i">
                      <debug_text text="'Ship ' + $i + ': ' + $CurrentShip.knownname + ' forced to attack $TerranOutpost.'" chance="$DebugChance"/>
                      <cancel_all_orders object="$CurrentShip"/>
                      <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                        <param name="destination" value="[$TerranOutpostSector, $CurrentTerranOutpostPosition]"/>
                      </create_order>
                      <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                        <param name="primarytarget" value="$TerranOutpost"/>
                        <param name="allowothertargets" value="false" comment="The param will get switched by Ch8_4_Xenon_Horde_Arrived once the first shot lands."/>
                        <param name="checkrelation" value="false"/>
                      </create_order>
                    </do_for_each>

                    <add_to_group groupname="$XenonHorde" group="$NearbyXenon"/>
                  </actions>
                </library>

                <cue name="Ch8_4_Xenon_Horde">
                  <actions>
                    <create_position name="$FallbackXenonSpawnPosition" space="$YakiExitSector" value="position.[-249728.828125m, 0.000000m, -145131.390625m]"/>

                    <do_if value="player.ship and [shiptype.heavyfighter].indexof.{player.ship.type}">
                      <set_value name="$XenonShipCount" exact="70"/>
                      <set_value name="$CapitalShipCount" exact="1"/>
                    </do_if>
                    <do_elseif value="[shiptype.frigate, shiptype.gunboat, shiptype.corvette].indexof.{player.ship.type}">
                      <set_value name="$XenonShipCount" exact="90"/>
                      <set_value name="$CapitalShipCount" exact="1"/>
                    </do_elseif>
                    <do_elseif value="[shiptype.destroyer, shiptype.carrier, shiptype.battleship].indexof.{player.ship.type}">
                      <set_value name="$XenonShipCount" exact="120"/>
                      <set_value name="$CapitalShipCount" exact="3"/>
                    </do_elseif>
                    <do_else>
                      <set_value name="$XenonShipCount" exact="60"/>
                      <set_value name="$CapitalShipCount" exact="1"/>
                    </do_else>

                    <run_actions ref="Xenon_Horde" result="$XenonHorde">
                      <param name="SectorList"          value="[$TerranOutpostSector, $YakiExitSector, $YakiHomeSector]"/>
                      <param name="Target"              value="$TerranOutpost"/>
                      <param name="ShipCount"           value="$XenonShipCount"/>
                      <param name="AllowOtherTargets"   value="false"/>
                      <param name="CapitalShipCount"    value="$CapitalShipCount"/>
                      <param name="DefaultProtectTargetPosition" value="true"/>
                    </run_actions>

                    <!-- How many capital ships are we missing? -->
                    <do_for_each in="$XenonHorde" name="$CurrentShip">
                      <do_if value="[shiptype.destroyer, shiptype.carrier, shiptype.battleship].indexof.{$CurrentShip.type}">
                        <set_value name="$CapitalShipCount" operation="subtract"/>
                      </do_if>
                      <do_if value="$CapitalShipCount == 0">
                        <break/>
                      </do_if>
                    </do_for_each>

                    <create_group groupname="$ExtraXenonHorde"/>

                    <do_all exact="$CapitalShipCount" counter="$i">
                      <create_ship groupname="$ExtraXenonHorde" macro="macro.ship_xen_xl_destroyer_01_a_macro" sector="$YakiExitSector" missioncue="namespace" capturable="false">
                        <owner exact="faction.xenon" overridenpc="true" />
                        <pilot>
                          <select faction="faction.xenon" tags="tag.fighterpilot"/>
                        </pilot>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                        <drop ref="ship_large_xenon"/>
                        <safepos value="$FallbackXenonSpawnPosition"/>
                        <rotation yaw="45deg"/>
                      </create_ship>
                    </do_all>

                    <!-- Fill remaining slots with smaller ships. -->
                    <do_all exact="$XenonShipCount - $XenonHorde.count" counter="$i">
                      <do_if value="($i - 1) % 7 == 0">
                        <create_ship groupname="$ExtraXenonHorde" macro="macro.ship_xen_m_corvette_02_a_macro" sector="$YakiExitSector" missioncue="namespace" capturable="false">
                          <owner exact="faction.xenon" overridenpc="true" />
                          <pilot>
                            <select faction="faction.xenon" tags="tag.fighterpilot"/>
                          </pilot>
                          <loadout>
                            <level exact="1.0"/>
                          </loadout>
                          <!--<drop ref="ship_small_xenon"/>-->
                          <safepos value="$FallbackXenonSpawnPosition"/>
                          <rotation yaw="45deg"/>
                        </create_ship>
                      </do_if>
                      <do_else>
                        <create_ship groupname="$ExtraXenonHorde" macro="macro.ship_xen_s_fighter_02_a_macro" sector="$YakiExitSector" missioncue="namespace" capturable="false">
                          <owner exact="faction.xenon" overridenpc="true" />
                          <pilot>
                            <select faction="faction.xenon" tags="tag.fighterpilot"/>
                          </pilot>
                          <loadout>
                            <level exact="1.0"/>
                          </loadout>
                          <!--<drop ref="ship_small_xenon"/>-->
                          <safepos value="$FallbackXenonSpawnPosition"/>
                          <rotation yaw="45deg"/>
                        </create_ship>
                      </do_else>
                    </do_all>

                    <!-- Give order and add to original $XenonHorde. -->
                    <do_for_each in="$ExtraXenonHorde" name="$CurrentShip">
                      <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                        <param name="destination" value="[$TerranOutpostSector, $CurrentTerranOutpostPosition]"/>
                      </create_order>
                      <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                        <param name="primarytarget" value="$TerranOutpost"/>
                        <param name="pursuetargets" value="true"/>
                        <param name="allowothertargets" value="false"/>
                        <param name="checkrelation" value="false"/>
                      </create_order>
                      <add_to_group groupname="$XenonHorde" object="$CurrentShip"/>
                    </do_for_each>

                    <!-- Create group for Xenon ships that have already adjusted their attack order. -->
                    <create_group groupname="$ArrivedXenonShips"/>
                  </actions>
                  <cues>

                    <cue name="Ch8_4_Xenon_Horde_Arrived" instantiate="true">
                      <conditions>
                        <event_object_attacked_object group="$XenonHorde" attacked="$TerranOutpost"/>
                        <check_value value="not $ArrivedXenonShips.indexof.{event.object}"/>
                      </conditions>
                      <actions>
                        <!-- Once any given Xenon attacker has shot at the outpost once, they're allowed to fight as normal. Makes sure that they get to the outpost ASAP. -->
                        <do_if value="event.object.order.id == 'Attack'">
                          <edit_order_param order="event.object.order" param="'allowothertargets'" value="true"/>
                        </do_if>

                        <add_to_group groupname="$ArrivedXenonShips" object="event.object"/>
                      </actions>
                    </cue>

                    <cue name="Ch8_4_Xenon_Ship_Left_Mission_Area" instantiate="true" version="2">
                      <conditions>
                        <check_any>
                          <event_object_changed_sector previous="$YakiHomeSector" sector="$XenonSectorNextToYaki" group="$XenonHorde" comment="In case an attacker wants to go off in the wrong direction."/>
                          <event_object_changed_sector previous="$TerranOutpostSector" group="$XenonHorde"/>
                        </check_any>
                        <check_value value="Ch8_8_Debriefing.state == cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <debug_text text="event.object.knownname + ' left the sector ' + event.param2.knownname + ', heading for ' + event.param.knownname + ' and counts as defeated.'" chance="$DebugChance"/>
                        <remove_from_group group="$XenonHorde" object="event.object"/>
                        <do_if value="not $XenonHorde.count">
                          <signal_cue cue="Ch8_4_Xenon_Horde_Defeated_Check"/>
                        </do_if>
                        <do_elseif value="Ch8_7_Defend_Final.state == cuestate.complete" comment="If the objective is already pointing towards the individual ships, we have to set it again to use the updated group.">
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$XenonHorde" text="{30225,1022}" silent="true" updatebriefing="true"/>
                        </do_elseif>
                      </actions>
                      <patch sinceversion="2" state="waiting">
                        <do_if value="(Ch8_8_Debriefing.state == cuestate.waiting) and not $XenonHorde.count">
                          <signal_cue cue="Ch8_4_Xenon_Horde_Defeated_Check"/>
                        </do_if>
                      </patch>
                    </cue>

                    <cue name="Ch8_4_Xenon_Ship_Destroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$XenonHorde"/>
                        <check_value value="$XenonHorde.count == 1"/>
                        <check_value value="Ch8_8_Debriefing.state == cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <debug_text text="event.object.knownname + ' got destroyed and it was the last one in the group.'" chance="$DebugChance"/>

                        <signal_cue cue="Ch8_4_Xenon_Horde_Defeated_Check"/>
                      </actions>
                    </cue>

                    <cue name="Ch8_4_Xenon_Horde_Defeated_Check">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Ch8_4_Xenon_Horde_Defeated_Check signalled. Checking whether there really are no Xenon left in the area.'" chance="$DebugChance"/>
                        <include_actions ref="Ch8_4_Collect_Nearby_Xenon" comment="Adds nearby Xenon to $XenonHorde."/>

                        <do_if value="not $XenonHorde.count">
                          <debug_text text="'Xenon are indeed defeated. Signalling Ch8_8_Debriefing.'" chance="$DebugChance"/>
                          <signal_cue cue="Ch8_8_Debriefing"/>
                        </do_if>
                        <do_else>
                          <debug_text text="'There are still ' + $XenonHorde.count + ' Xenon nearby. Resetting Ch8_4_Xenon_Horde_Defeated_Check.'" chance="$DebugChance"/>
                          <do_if value="Ch8_7_Defend_Final.state == cuestate.complete" comment="If the objective is already pointing towards the individual ships, we have to set it again to use the updated group.">
                            <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$XenonHorde" text="{30225,1022}" silent="true" updatebriefing="true"/>
                          </do_if>
                          <reset_cue cue="this"/>
                        </do_else>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch8_4_Player_Already_In_Sector" onfail="cancel">
                  <conditions>
                    <check_value value="player.sector == $TerranOutpostSector"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch8_5_Defend_Approach" check="false"/>
                    <cancel_cue cue="Ch8_4_Gate_Entered"/>
                  </actions>
                </cue>

                <!-- Once the player returns to the outpost sector, trigger a more detailed objective. -->
                <cue name="Ch8_4_Gate_Entered">
                  <conditions>
                    <event_object_changed_sector object="player.entity" previous="$YakiExitSector"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch8_5_Defend_Approach"/>
                  </actions>
                </cue>

                <cue name="Ch8_4_Spawn_Ownerless_Ship" version="2">
                  <actions>
                    <create_position name="$AbandonedWingmateShipSpawnPosition" space="$TerranOutpostSector" x="$YakiExitGateTerranSidePosition.x + 2km" y="$YakiExitGateTerranSidePosition.y" z="$YakiExitGateTerranSidePosition.z + 2km"/>

                    <create_ship name="$AbandonedWingmateShip" macro="macro.ship_ter_s_heavyfighter_01_a_macro" sector="$TerranOutpostSector">
                      <owner exact="faction.ownerless" overridenpc="true" />
                      <loadout loadout="$WingmateLoadout"/>
                      <!-- Paint mod: Solset Dapple (Terran Camo 1)-->
                      <paint ware="ware.paintmod_0118"/>
                      <safepos value="$AbandonedWingmateShipSpawnPosition"/>
                      <rotation yaw="45deg" pitch="-15deg" roll="25deg"/>
                    </create_ship>

                    <set_object_name object="$AbandonedWingmateShip" page="30225" line="201" comment="Velvet Thunder"/>

                    <add_to_group groupname="global.$IgnoredAbandonedShips" object="$AbandonedWingmateShip"/>

                    <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_yaki_gladius"/>
                  </actions>
                  <patch sinceversion="2" state="complete">
                    <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_yaki_gladius"/>
                  </patch>
                  <patch sinceversion="2" state="cancelled">
                    <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_yaki_gladius"/>
                  </patch>
                </cue>

                <cue name="Ch8_4_Trigger_Help">
                  <delay exact="$DefenceDuration"/>
                  <actions>
                    <do_if value="Ch8_8_Debriefing.state == cuestate.waiting">
                      <include_actions ref="Ch8_4_Collect_Nearby_Xenon" comment="Adds nearby Xenon to $XenonHorde."/>

                      <do_for_each in="$XenonHorde" name="$CurrentShip" reverse="true">
                        <!-- Sometimes, some Xenon get lost along the way. Remove them from the group of mission targets. -->
                        <debug_text text="'Checking whether ' + $CurrentShip.knownname + ' is still in the sector and close to the outpost.'" chance="$DebugChance"/>
                        <do_if value="(@$CurrentShip.sector != $TerranOutpostSector) or ($CurrentShip.distanceto.{$TerranOutpost} gt 40km)">
                          <debug_text text="$CurrentShip.knownname + ' is not in the sector or too far away. Removing from group.'" chance="$DebugChance"/>
                          <remove_from_group group="$XenonHorde" object="$CurrentShip"/>
                        </do_if>

                        <!-- Remember whether there's still big Xenon ships left. -->
                        <do_elseif value="[shiptype.destroyer, shiptype.carrier, shiptype.battleship].indexof.{$CurrentShip.type}">
                          <debug_text text="$CurrentShip.knownname + ' is a big ship.'" chance="$DebugChance"/>
                          <set_value name="$BigXenonShipsRemaining"/>
                        </do_elseif>
                      </do_for_each>

                      <!-- If there's only a handful of Xenon ships left, and neither of them is too large, consider the defence successful. -->
                      <debug_text text="$XenonHorde.count + ' enemies left, and $BigXenonShipsRemaining? is ' + $BigXenonShipsRemaining?" chance="$DebugChance"/>
                      <do_if value="($XenonHorde.count le 10) and (not $BigXenonShipsRemaining?)">
                        <signal_cue cue="Ch8_8_Debriefing"/>
                      </do_if>

                      <!-- If there are too many ships left in total, or if at least one big ship remains, help arrives. -->
                      <do_else>
                        <signal_cue cue="Ch8_7_Defend_Final"/>
                      </do_else>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch8_4_Station_Destroyed">
                  <conditions>
                    <event_object_destroyed object="$TerranOutpost"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch8_8_Debriefing"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <!-- Optional objective if the player returns to the outpost sector before the fight ends. -->
            <cue name="Ch8_5_Defend_Approach">
              <conditions>
                <event_cue_signalled/>
                <check_value value="Ch8_7_Defend_Final.state == cuestate.waiting"/>
                <check_value value="Ch8_8_Debriefing.state == cuestate.waiting"/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defend" object="$TerranOutpost" radius="10km" text="{30225,1012}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch8_5_Secret_Service_Speak_1_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="DelayInitial"      value="7s" comment="To give Betty enough time to announce the sector name."/>
                  <param name="Lines"             value="[[30225118]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                       Delilah:
                         Recruit, where on Earth have you been, and where is your squad mate?!
                       -->
                </cue>

                <cue name="Ch8_5_Approach_TerranOutpost_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$TerranOutpost"/>
                  <param name="ApproachDistance"  value="50km"/>
                  <param name="SuccessSignalCue"  value="Ch8_6_Defend_Timed"/>
                </cue>

              </cues>
            </cue>

            <!-- Optional objective if the player approaches the outpost before the fight ends. -->
            <cue name="Ch8_6_Defend_Timed">
              <conditions>
                <event_cue_signalled/>
                <check_value value="Ch8_7_Defend_Final.state == cuestate.waiting"/>
                <check_value value="Ch8_8_Debriefing.state == cuestate.waiting"/>
              </conditions>
              <actions>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" object="$TerranOutpost" radius="10km" customaction="{30225,2022}" endtime="$DefenceStart + $DefenceDuration" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch8_6_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30225120],[30225121]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                       Delilah:
                         Do what you must, use the station as cover, draw them into our turrets' lines of fire.
                         No matter what's coming at us, we will not budge!
                       -->
                </cue>

                <cue name="Ch8_6_Setup_Defence_Fleet">
                  <actions>
                    <!-- Find internal dock. -->
                    <do_if value="$TerranOutpost">
                      <find_dockingbay name="$TerranOutpostInternalDock" object="$TerranOutpost" checkoperational="true" multiple="false">
                        <match_dock storage="true" size="tag.dock_s"/>
                      </find_dockingbay>
                    </do_if>

                    <set_value name="$FleetComposition" exact="[
                            [ macro.ship_ter_s_heavyfighter_01_a_macro, 1 ],
                            [ macro.ship_ter_s_fighter_01_a_macro,      4 ]
                            ]" />

                    <do_all exact="2" comment="We want two squads." counter="$i">
                      <do_all exact="$FleetComposition.count" counter="$m">
                        <do_all exact="$FleetComposition.{$m}.{2}" counter="$a">
                          <do_if value="$TerranOutpostInternalDock?">
                            <create_ship name="$CurrentShip" macro="$FleetComposition.{$m}.{1}" capturable="false" missioncue="$MissionCue" dock="$TerranOutpostInternalDock">
                              <owner exact="faction.terran" overridenpc="true"/>
                              <pilot>
                                <select faction="faction.terran" tags="tag.fighterpilot"/>
                              </pilot>
                              <loadout>
                                <level exact="1.0"/>
                              </loadout>
                            </create_ship>
                          </do_if>
                          <do_elseif value="$TerranOutpost">
                            <create_ship name="$CurrentShip" macro="$FleetComposition.{$m}.{1}" capturable="false" missioncue="$MissionCue" sector="$TerranOutpostSector">
                              <owner exact="faction.terran" overridenpc="true"/>
                              <pilot>
                                <select faction="faction.terran" tags="tag.fighterpilot"/>
                              </pilot>
                              <loadout>
                                <level exact="1.0"/>
                              </loadout>
                              <safepos object="$TerranOutpost" z="-3km"/>
                            </create_ship>
                          </do_elseif>
                          <do_else>
                            <create_ship name="$CurrentShip" macro="$FleetComposition.{$m}.{1}" capturable="false" missioncue="$MissionCue" sector="$TerranOutpostSector">
                              <owner exact="faction.terran" overridenpc="true"/>
                              <pilot>
                                <select faction="faction.terran" tags="tag.fighterpilot"/>
                              </pilot>
                              <loadout>
                                <level exact="1.0"/>
                              </loadout>
                              <safepos x="$CurrentTerranOutpostPosition.x" y="$CurrentTerranOutpostPosition.y" z="$CurrentTerranOutpostPosition.z - 3km"/>
                            </create_ship>
                          </do_else>

                          <create_order id="'Patrol'" object="$CurrentShip" default="true">
                            <param name="space" value="$TerranOutpostSector"/>
                          </create_order>

                          <do_if value="$m == 1 and $a == 1">
                            <do_if value="$i == 1">
                              <set_object_name object="$CurrentShip" page="30225" line="305" comment="Cobalt Flight Leader"/>
                            </do_if>
                            <do_else>
                              <set_object_name object="$CurrentShip" page="30225" line="303" comment="Kobold Flight Leader"/>
                            </do_else>
                            <set_value name="$SquadCommander" exact="$CurrentShip"/>
                            <do_if value="$TerranOutpost">
                              <create_order id="'ProtectStation'" object="$CurrentShip" immediate="true">
                                <param name="station" value="$TerranOutpost"/>
                              </create_order>
                            </do_if>
                            <do_else>
                              <create_order id="'ProtectPosition'" object="$CurrentShip" immediate="true">
                                <param name="destination" value="[$TerranOutpostSector, $CurrentTerranOutpostPosition]"/>
                              </create_order>
                            </do_else>
                          </do_if>
                          <do_else>
                            <do_if value="$i == 1">
                              <set_object_name object="$CurrentShip" name="'{30225,306}' + ($a + 1)" comment="Cobalt (followed by number)"/>
                            </do_if>
                            <do_else>
                              <set_object_name object="$CurrentShip" name="'{30225,304}' + ($a + 1)" comment="Kobold (followed by number)"/>
                            </do_else>
                            <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                              <param name="commander" value="$SquadCommander"/>
                              <param name="assignment" value="assignment.defence"/>
                              <param name="cancelorders" value="true"/>
                            </create_order>
                          </do_else>

                          <add_to_group groupname="$DefenceFleet" object="$CurrentShip"/>
                        </do_all>
                      </do_all>
                    </do_all>
                  </actions>
                  <cues>

                    <cue name="Ch8_6_Defence_Fleet_Destroyed">
                      <conditions>
                        <event_object_destroyed group="$DefenceFleet"/>
                        <check_value value="$DefenceFleet.count == 1"/>
                      </conditions>
                      <actions>
                        <do_if value="Ch8_7_Defend_Final.state == cuestate.waiting">
                          <reset_cue cue="parent"/>
                        </do_if>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch8_6_Replenish_Xenon">
                  <actions>
                    <!-- Depending on how long the player took to arrive, the first wave of Xenon may have already been defeated. Spawn more to create some action. -->
                    <create_group groupname="$ReplenishedXenonHorde"/>

                    <create_position name="$ReplenishXenonSpawnPosition" space="$TerranOutpostSector" object="$TerranOutpost" z="150km"/>

                    <debug_text text="$XenonShipCount - $XenonHorde.count + ' Xenon attackers got destroyed before the player arrived at the outpost. Replenish them.'" chance="$DebugChance"/>

                    <do_all exact="$XenonShipCount - $XenonHorde.count" counter="$i">
                      <do_if value="($i - 1) % 7 == 0">
                        <create_ship groupname="$ReplenishedXenonHorde" macro="macro.ship_xen_m_corvette_02_a_macro" sector="$TerranOutpostSector" missioncue="namespace" capturable="false">
                          <owner exact="faction.xenon" overridenpc="true" />
                          <pilot>
                            <select faction="faction.xenon" tags="tag.fighterpilot"/>
                          </pilot>
                          <loadout>
                            <level exact="1.0"/>
                          </loadout>
                          <!--<drop ref="ship_small_xenon"/>-->
                          <safepos value="$ReplenishXenonSpawnPosition"/>
                          <rotation yaw="180deg"/>
                        </create_ship>
                      </do_if>
                      <do_else>
                        <create_ship groupname="$ReplenishedXenonHorde" macro="macro.ship_xen_s_fighter_02_a_macro" sector="$TerranOutpostSector" missioncue="namespace" capturable="false">
                          <owner exact="faction.xenon" overridenpc="true" />
                          <pilot>
                            <select faction="faction.xenon" tags="tag.fighterpilot"/>
                          </pilot>
                          <loadout>
                            <level exact="1.0"/>
                          </loadout>
                          <!--<drop ref="ship_small_xenon"/>-->
                          <safepos value="$ReplenishXenonSpawnPosition"/>
                          <rotation yaw="180deg"/>
                        </create_ship>
                      </do_else>
                    </do_all>

                    <!-- Give order and add to original $XenonHorde. -->
                    <do_for_each in="$ReplenishedXenonHorde" name="$CurrentShip">
                      <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                        <param name="destination" value="[$TerranOutpostSector, $CurrentTerranOutpostPosition]"/>
                      </create_order>
                      <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                        <param name="primarytarget" value="$TerranOutpost"/>
                        <param name="pursuetargets" value="true"/>
                        <param name="allowothertargets" value="false"/>
                        <param name="checkrelation" value="false"/>
                      </create_order>
                      <add_to_group groupname="$XenonHorde" object="$CurrentShip"/>
                    </do_for_each>
                  </actions>
                </cue>

              </cues>
            </cue>

            <!-- Optional objective if the Xenon weren't defeated before the timer ran out. -->
            <cue name="Ch8_7_Defend_Final">
              <conditions>
                <event_cue_signalled/>
                <check_value value="Ch8_8_Debriefing.state == cuestate.waiting"/>
              </conditions>
              <actions>
                <set_value name="$DefenceNeededHelp"/>

                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$XenonHorde" text="{30225,1022}" updatebriefing="true"/>

                <play_music music="'music_dlc_terran_story_som_6'"/>
              </actions>
              <cues>

                <cue name="Ch8_7_Transport_Captain_Dialog">
                  <conditions>
                    <event_cue_signalled comment="Has to wait until the actor is placed."/>
                  </conditions>
                  <cues>

                    <cue name="Ch8_7_Transport_Captain_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$TransportCaptainActor"/>
                      <param name="CutsceneKey"       value="$TransportCaptainCutsceneKey"/>
                      <param name="Lines"             value="[[30225101],[30225102],[30225103],[30225104]]"/>
                      <param name="EndSignalCue"      value="Ch8_7_Secret_Service_Contact_Dialog"/>
                      <!--
                            Commander Lee:
                              This is commander Lee of the Terran Intervention Corps.
                              It appears that your little experiment has failed, Delilah.
                              We will take over from here.
                              Long may the sun shine.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch8_7_Secret_Service_Contact_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch8_7_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="DelayInitial"      value="5s"/>
                      <param name="Lines"             value="[[30225122],[30225123],[30225124]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Delilah:
                              (angry; stops herself from using an insult; stress 'doesn't')That pompous...! He can go where the sun doesn't shine!
                              (angry, with pathos)All squadrons, recruits, defenders of Sol!
                              (energetic, angry; 'Intervention' is shorthand for 'Intervention Corps')Show Intervention what we're capable of and eliminate those Xenon stragglers!
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch8_7_Setup_Intervention_Fleet">
                  <actions>
                    <set_value name="$FleetComposition" exact="[
                                  [ macro.ship_ter_l_destroyer_01_a_macro,    3  ],
                                  [ macro.ship_ter_m_corvette_01_a_macro,     6  ],
                                  [ macro.ship_ter_s_heavyfighter_01_a_macro, 12 ],
                                  [ macro.ship_ter_s_fighter_01_a_macro,      18 ]
                                  ]" />
                    <do_all exact="$FleetComposition.count" counter="$m">
                      <do_all exact="$FleetComposition.{$m}.{2}" counter="$a">
                        <create_ship name="$CurrentShip" macro="$FleetComposition.{$m}.{1}" commandeerable="false" capturable="false" missioncue="$MissionCue" sector="$TerranOutpostSector">
                          <owner exact="faction.terran" overridenpc="true"/>
                          <pilot>
                            <select faction="faction.terran" tags="tag.fighterpilot"/>
                          </pilot>
                          <people ref="terran_elite_military_crew"/>
                          <loadout>
                            <level exact="1.0"/>
                          </loadout>
                          <safepos object="$TerranOutpost" x="-15km"/>
                          <rotation yaw="90deg"/>
                        </create_ship>
                        <create_order id="'Patrol'" object="$CurrentShip" default="true">
                          <param name="space" value="$TerranOutpostSector"/>
                        </create_order>
                        <do_if value="$m == 1 and $a == 1" comment="First ship in the list becomes commander.">
                          <set_object_name object="$CurrentShip" page="30225" line="204" comment="First Light of the Fifth Day"/>
                          <set_value name="$InterventionFleetCommander" exact="$CurrentShip"/>
                          <do_for_each in="$XenonHorde" name="$CurrentEnemy">
                            <do_if value="[shiptype.destroyer, shiptype.carrier, shiptype.battleship].indexof.{$CurrentEnemy.type}">
                              <set_value name="$IdealTarget" exact="$CurrentEnemy"/>
                              <break/>
                            </do_if>
                          </do_for_each>
                          <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                            <param name="primarytarget" value="if $IdealTarget? then $IdealTarget else $XenonHorde.random"/>
                            <param name="secondarytargets" value="$XenonHorde"/>
                            <param name="pursuetargets" value="true"/>
                            <param name="checkrelation" value="false"/>
                            <param name="allowothertargets" value="false"/>
                          </create_order>
                        </do_if>
                        <do_else>
                          <do_if value="$m == 1 and $a == 2" comment="Other destroyers get special names, too.">
                            <set_object_name object="$CurrentShip" page="30225" line="205" comment="Goldenback"/>
                          </do_if>
                          <do_elseif value="$m == 1 and $a == 3">
                            <set_object_name object="$CurrentShip" page="30225" line="207" comment="Utmost Weapon"/>
                          </do_elseif>
                          <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                            <param name="commander" value="$InterventionFleetCommander"/>
                            <param name="assignment" value="assignment.attack"/>
                            <param name="cancelorders" value="true"/>
                          </create_order>
                        </do_else>
                        <add_to_group groupname="$InterventionFleet" object="$CurrentShip"/>
                      </do_all>
                    </do_all>

                    <signal_cue cue="Ch8_7_Setup_Transport_Captain_On_Bridge"/>
                    <signal_cue cue="Ch8_7_Transport_Captain_Dialog" comment="We can signal the dialog, now that the actor is placed."/>

                    <signal_cue cue="Ch8_7_Xenon_Orders"/>
                  </actions>
                  <cues>

                    <cue name="Ch8_7_Intervention_Fleet_Commander_Changed" instantiate="true">
                      <conditions>
                        <event_object_commander_set group="$InterventionFleet" previous="$InterventionFleetCommander"/>
                      </conditions>
                      <actions>
                        <set_value name="$InterventionFleetCommander" exact="event.param"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch8_7_Xenon_Orders">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Select a random capital ship as the fleet commander. -->
                    <do_for_each in="$XenonHorde" name="$CurrentShip">
                      <do_if value="[shiptype.destroyer, shiptype.battleship, shiptype.carrier].indexof.{$CurrentShip.type}">
                        <debug_text text="$CurrentShip.knownname + ' becomes the Xenon fleet commander and attacks the incoming terran support.'" chance="$DebugChance"/>
                        <set_value name="$XenonHordeCommander" exact="$CurrentShip"/>
                        <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                          <param name="primarytarget" value="$InterventionFleetCommander"/>
                          <param name="secondarytargets" value="$InterventionFleet"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                        <break/>
                      </do_if>
                    </do_for_each>

                    <!-- If a ship was set as the commander, assign the rest as subordinates. -->
                    <do_if value="$XenonHordeCommander?">
                      <do_for_each in="$XenonHorde" name="$CurrentShip">
                        <do_if value="$CurrentShip != $XenonHordeCommander">
                          <debug_text text="$CurrentShip.knownname + ' gets assigned as subordinate.'" chance="$DebugChance"/>
                          <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                            <param name="commander" value="$XenonHordeCommander"/>
                            <param name="assignment" value="assignment.interception"/>
                            <param name="cancelorders" value="true"/>
                          </create_order>
                        </do_if>
                      </do_for_each>
                    </do_if>

                    <!-- Otherwise, give all of them individual orders. -->
                    <do_else>
                      <do_for_each in="$XenonHorde" name="$CurrentShip">
                        <debug_text text="$CurrentShip.knownname + ' gets an individual attack order because we don\'t have a Xenon fleet commander.'" chance="$DebugChance"/>
                        <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                          <param name="primarytarget" value="$InterventionFleet.random"/>
                          <param name="secondarytargets" value="$InterventionFleet"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                      </do_for_each>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch8_7_Setup_Transport_Captain_On_Bridge">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $TransportCaptainActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $InterventionFleetCommander.controlroom,
                                                                                                                                      $position = position.[-2.8m, 0.0m, -3.24m],
                                                                                                                                      $rotation = rotation.[150deg, 0deg, 0deg],
                                                                                                                                      $debugchance = 0,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch8_8_Debriefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30225,1015}" updatebriefing="true"/>
              </actions>
              <delay exact="3s"/>
              <actions>
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <do_if value="$TerranOutpost.isoperational">
                  <signal_cue cue="Ch8_8_Mission_Successful_Dialog"/>
                </do_if>
                <do_else>
                  <signal_cue cue="Ch8_8_Mission_Failed_Dialog"/>
                </do_else>
              </actions>
              <cues>

                <cue name="Ch8_8_Mission_Successful_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <speak actor="$SecretServiceActor" priority="100">
                      <text line="30225125" comment="(proud)Congratulations, squads, you handled yourselves admirably!"/>
                      <text line="30225126" comment="(a bit more somber)... even though this was considerably more than you initially signed up for."/>
                      <text line="30225127" comment="I'll be contacting you individually to discuss our next steps once the dust has settled."/>
                      <text line="30225128" comment="Until then, you will want to take some time off. Consider this an order."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch8_8_Mission_Failed_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <speak actor="$SecretServiceActor" priority="100">
                      <text line="30225129" comment="(panicking slightly)Fall back! Fall back!"/>
                      <text line="30225130" comment="(getting her bearings)All squadrons, regroup at the Sol Gate!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch8_8_Debriefing_Dialog">
                  <conditions>
                    <check_any>
                      <event_speak_finished actor="$SecretServiceActor" line="30225125"/>
                      <event_speak_finished actor="$SecretServiceActor" line="30225129"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>
                  </actions>
                  <cues>

                    <cue name="Ch8_8_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30225131],[30225132],[30225133]]"/>
                      <param name="EndSignalCue"      value="Ch8_Clean_Up_Terran_War_Intro_Mission_2"/>
                      <!--
                            Delilah:
                              (intense)Except for you, recruit.
                              (intense)I'm adding you to the admissions to my headquarters.
                              (intense)We have a few things to talk about.
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch8_Clean_Up_Terran_War_Intro_Mission_2">
              <conditions>
                <event_cue_signalled />
              </conditions>
              <actions>
                <debug_text text="'Cleaning up Terran War intro mission 2.'" chance="$DebugChance"/>

                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <!-- If the outpost was destroyed, give $XenonHorde new orders. -->
                <do_if value="@$XenonHordeCommander.isoperational">
                  <create_order id="'Patrol'" object="$XenonHordeCommander" default="true">
                    <param name="space" value="$TerranOutpostSector"/>
                  </create_order>
                </do_if>
                <do_else>
                  <do_for_each in="$XenonHorde" name="$CurrentShip">
                    <create_order id="'Patrol'" object="$CurrentShip" default="true">
                      <param name="space" value="$TerranOutpostSector"/>
                    </create_order>
                  </do_for_each>
                </do_else>

                <!-- If support arrived in time, give them a patrol order. -->
                <do_if value="@$InterventionFleetCommander.isoperational">
                  <create_order id="'Patrol'" object="$InterventionFleetCommander" default="true">
                    <param name="space" value="$TerranOutpostSector"/>
                  </create_order>
                </do_if>

                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.terran" title="{30225,2001}" text="{30225,2004}"/>

                <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.015" reason="relationchangereason.missioncompleted"/>
                <!-- If for whatever reason the player isn't friendly with the Terrans after this reputation increase, set them to friendly. The player needs the outer core access licence to proceed. -->
                <do_if value="faction.terran.relationto.{faction.player} lt faction.terran.relation.friend.min">
                  <set_faction_relation faction="faction.terran" otherfaction="faction.player" value="faction.terran.relation.friend.min" reason="relationchangereason.missioncompleted"/>
                </do_if>

                <reward_player money="$TerranMissionRewardCr_2"/>

                <unlock_achievement name="COH_PLOT_TERRAN_WAR"/>

                <signal_cue cue="Ch9_Secret_Service"/>
                <cancel_cue cue="Ch8_Investigate_Signal"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- MISSION 3 (Secret Service Setup Mission) -->

        <cue name="Ch9_Secret_Service">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue cue="Setup_Secret_Service_Contact"/>
          </actions>
          <cues>

            <cue name="Ch9_1_Contact">
              <actions>
                <create_mission cue="$MissionCue" name="{30225,3001}" description="{30225,3002}" type="missiontype.plot" group="missiongroup.story_yaki_solborn" faction="faction.terran" difficulty="level.trivial" abortable="false" icon="'faction_terran'" iconcaption="{30225,108}">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$SecretServiceActor" text="{30225,108}"/>
                  </briefing>
                </create_mission>

                <set_value name="$CurrentStep" exact="1"/>
                <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep"/>
              </actions>
              <cues>

                <cue name="Ch9_1_Conversation_Start">
                  <conditions>
                    <event_conversation_started actor="$SecretServiceActor"/>
                  </conditions>
                  <actions>
                    <!-- Change name of Secret Service Contact. Up until this point, she's only appeared as "Mission Command" -->
                    <set_object_name object="$SecretServiceActor" page="30225" line="102" comment="Delilah Shiratori"/>

                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225201" comment="Recruit! It's good to see you're still in one piece."/>
                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225202" comment="Apologies for the harsh welcome earlier."/>
                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225203" comment="(stress 'cannot')Communications cut off as soon as you engaged those Xenon infrastructure units, and I cannot stand having no vision on my subordinates."/>

                    <add_player_choice text="{30225,3030}" section="section_main" choiceparam="'report'" position="right" highlighted="true"/>
                  </actions>
                </cue>

                <cue name="Ch9_1_Conversation_Section_Main" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SecretServiceActor" section="section_main"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="event.param2 == 'report'">
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225204" comment="There's no need for a detailed report, recruit."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225205" comment="My staff has already extracted your ship logs the moment you arrived."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225206" comment="It is beyond dispute that what you have witnessed is of the utmost concern to the Protectorate, but that is only half of the reason why I called you here personally."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225207" comment="You have displayed unquestioning obedience and clarity of mind in the most stressful of situations, and distinguished yourself as a defender of Sol in even the darkest hours of our operation."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225208" comment="(gets a bit intense)I hereby raise you to the rank of special operative, and no, refusal is not an option."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225209" comment="(more lenient, reveals that she was tongue-in-cheek)But I might deign to answer some of your questions, if you have any. No classified subjects though."/>
                    </do_if>

                    <do_elseif value="event.param2 == 'militia'">
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225210" comment="A cutting-edge operation to strengthen societal cohesion, or, if you believe Intervention, just another failed experiment."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225211" comment="When I originally pitched the idea, I was mostly concerned with creating a common cause for the disenfranchised of Sol, though drawing in foreign attention-seekers turned out to be a welcome side-efffect."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225212" comment="After all, why would you care, stand up and fight for our beautiful system if you felt like a second-class citizen, or worse, an alien?"/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225213" comment="I suppose there are a few parallels to the Pioneers Initiative. Another campaign that defied expectations in its own way."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225214" comment="Call it a hunch, but I'm sure that you'll be able to see that for yourself very soon."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'intervention'">
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225215" comment="(deliberating)I suppose I do owe you an explanation."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225216" comment="('glorious' is meant sarcastically)Yes, I suspected that the glorious Intervention Corps would have an eye on us from the start, and I did recognise the captain of that transport ship immediately."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225217" comment="I do understand his perspective: a ragtag bunch of barely-citizens, would-be heroes and foreigners, defending Sol?"/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225218" comment="That sounds like a recipe for failure."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225219" comment="Still, I did not expect commander Lee to degrade himself and pry around right under our noses, only to then spit on our efforts when he saw us stumble."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225220" comment="My department might not have much power in the grand scheme of things, but this will have consequences, believe me."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'wingmate'">
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225221" comment="My analysts are not entirely sure about the exact order of events; for that, we would have to interrogate Shinamon himself, and he remains MIA."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225222" comment="Judging from your report alone, he might have been abducted, but that was only the tip of the iceberg."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225223" comment="I really should have read the signs beforehand; after all, predicting the movements of ally and enemy alike is core to my job here."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225224" comment="For some reason, Shinamon must have tried desperately to make a name for himself, to be inquisitive and proactive in every situation."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225225" comment="He also seemed to have an eery aptitude for the Xenon; I suppose that growing up with stories about the glorious Terran war against the machine scourge played a certain role."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225226" comment="(a bit somber)Trying to understand that which cannot be understood might have been his downfall."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'antigone'">
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225227" comment="(sighs)That was an unfortunate confrontation to say the least."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225228" comment="We came close to a debacle, but I was ultimately able to smooth things over with the Secretary of the Antigone Republic."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225229" comment="When interacting with the rest of the Gate network, we will always attempt to show ourselves from our best angle, but make no mistake."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225230" comment="(intense)Earth will not allow herself to be abused, or threatened, ever again."/>
                    </do_elseif>

                    <add_player_choice text="{30225,3031}"        section="section_main"  position="left"         choiceparam="'militia'"/>
                    <do_if value="$DefenceNeededHelp?">
                      <add_player_choice text="{30225,3032}"         section="section_main"  position="bottom_right"  choiceparam="'intervention'"/>
                    </do_if>
                    <add_player_choice text="{30225,3033}"       section="section_main"  position="top_left"     choiceparam="'wingmate'"/>
                    <add_player_choice text="{30225,3034}" section="section_main"  position="bottom_left" choiceparam="'antigone'"/>

                    <do_if value="player.module == 'x4ep1_gamestart_terran1'">
                      <add_player_choice text="{30225,3035}"          section="section_hq_intro" position="top_right"    highlighted="true"/>
                    </do_if>
                    <do_else>
                      <add_player_choice text="{30225,3035}"          section="section_outro" position="top_right"    highlighted="true"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch9_1_Conversation_Outro">
                  <conditions>
                    <event_conversation_next_section actor="$SecretServiceActor" section="section_outro"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225233" comment="(unusually warm)For now, you leave through that door, and you recover."/>
                    <do_if value="md.X4Ep1_Mentor_Subscriptions.UnlockResearch.state == cuestate.complete">
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225234" comment="(a bit more firmly)Once you feel ready, come talk to me again."/>
                    </do_if>
                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225235" comment="Surely there will be ample opportunity to apply your very particular set of skills."/>
                  </actions>
                </cue>

                <cue name="Ch9_1_Conversation_HQ_Mission_Intro" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$SecretServiceActor" section="section_hq_intro"/>
                      <check_all>
                        <event_conversation_started actor="$SecretServiceActor"/>
                        <check_value value="$HQ_Handover_On_Hold?"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="not $HQ_Handover_On_Hold?">
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225231" comment="Well, I must say that I am hesitant to send you away again so soon, but since you're asking, there might indeed be something to help take your mind off these unfortunate events."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225232" comment="That is, if you think you're ready."/>
                    </do_if>

                    <do_else>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="[30225237,30225237].random" comment="(variant 1)Good to see you, operative. / (variant 2)Welcome back, operative."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225239" comment="Ready for your next mission?"/>
                    </do_else>

                    <add_player_choice text="{30225,3036}" section="section_hq_handover"         position="right" highlighted="true"/>
                    <add_player_choice text="{30225,3037}"     section="section_hq_handover_on_hold" position="left"/>
                    <signal_cue cue="md.Story_HQ_Discovery.Activate_Story" check="false"/>
                  </actions>
                </cue>

                <cue name="Ch9_1_Conversation_HQ_Mission_Handover_On_Hold" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SecretServiceActor" section="section_hq_handover_on_hold"/>
                  </conditions>
                  <actions>
                    <set_value name="$HQ_Handover_On_Hold"/>

                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225240" comment="Take your time."/>
                  </actions>
                </cue>

                <cue name="Ch9_1_Conversation_HQ_Mission_Handover">
                  <conditions>
                    <event_conversation_next_section actor="$SecretServiceActor" section="section_hq_handover"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="not $HQ_Handover_On_Hold?" comment="Only if the player wanted to continue right away.">
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30225236" comment="I see, no time to waste, am I right?"/>
                    </do_if>

                    <!--
                      <t id="30223001">Now, I would like you to talk about the so-called 'Project Genesis'. That is the codename of a top-secret operation that the Segaris Pioneers are cooking up.</t>
                      <t id="30223002">We certainly know more about it than they would like, but we remain in the dark when it comes to their ultimate goal.</t>
                      <t id="30223003">We do know that it involves a facility in their space with an unknown purpose.</t>
                      <t id="30223004">Fortunately for us, there seems to have been an incident and the station was evacuated until repairs could be carried out.</t>
                      <t id="30223005">This is a short-lived opportunity to gather intel. As such, we have taken action to inject false security documents into a Pioneer database.</t>
                      <t id="30223006">Congratulations, operative. You're now a qualified Pioneer engineer, first class.</t>
                      <t id="30223007">You are set to join one of their engineering teams to repair that facility. During the operation, gather whatever information you can, but use your disgression.</t>
                      <t id="30223008">Just go along with their instructions and you'll be fine.</t>
                    
                      <t id="30223009">The team is gathering in Neptune.</t>
                      OR
                      <t id="30223010">I'm sending you the information on where the team is gathering.</t>-->
                    <add_npc_line speaker="$SecretServiceActor" line="[30223001, 30223002, 30223003, 30223004, 30223005, 30223006, 30223007, 30223008, 30223009]"/>
                  </actions>
                </cue>

                <cue name="Ch9_1_Conversation_HQ_Mission_Handover_Finished">
                  <conditions>
                    <event_conversation_finished actor="$SecretServiceActor" outcome="section_hq_handover"/>
                  </conditions>
                  <actions>
                    <!--Signal the conversation handler to state the HQ Discovery mission-->
                    <do_if value="md.Story_HQ_Discovery.Ch1_Intro_Fly_To_Scientist.state == cuestate.waiting">
                      <signal_cue cue="md.Story_HQ_Discovery.Ch1_Intro_Fly_To_Scientist"/>
                    </do_if>

                    <signal_cue cue="Ch9_Clean_Up_Secret_Service_Contact_Mission"/>
                  </actions>
                </cue>

                <cue name="Ch9_1_Conversation_Outro_Finished">
                  <conditions>
                    <event_conversation_finished actor="$SecretServiceActor" outcome="section_outro"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch9_Clean_Up_Secret_Service_Contact_Mission"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch9_Clean_Up_Secret_Service_Contact_Mission">
              <conditions>
                <event_cue_signalled />
              </conditions>
              <actions>
                <debug_text text="'Cleaning up Secret Service Contact mission.'" chance="$DebugChance"/>

                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.terran" title="{30225,3001}" text="{30225,3004}"/>

                <remove_value name="$SecretServiceActor.$MissionCue"/>
                <remove_value name="$WingmateActor.$MissionCue"/>
                <remove_value name="$TransportCaptainActor.$MissionCue"/>
                <remove_value name="$AngryMinerActor.$MissionCue"/>
                <remove_value name="$YakiRenegadeActor.$MissionCue"/>

                <signal_cue cue="Secret_Service_Contact_Conversation_Greeting_Handler"/>

                <cancel_cue cue="Ch9_Secret_Service"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- MISSION 4 (Yaki Mission 1) -->

        <cue name="Ch10_Yaki_Investigation_Intro">
          <conditions>
            <check_any>
              <check_all>
                <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.UnlockResearch"/>
                <check_value value="Ch9_Clean_Up_Secret_Service_Contact_Mission.state == cuestate.cancelled"/>
              </check_all>
              <check_all>
                <event_cue_signalled cue="Ch9_Clean_Up_Secret_Service_Contact_Mission"/>
                <check_value value="md.X4Ep1_Mentor_Subscriptions.UnlockResearch.state == cuestate.complete"/>
              </check_all>
            </check_any>
          </conditions>
          <actions>
            <set_value name="$SecretServiceActor.$MissionCue" exact="$MissionCue"/>
            <set_value name="$YakiRenegadeActor.$MissionCue" exact="$MissionCue"/>
            <set_value name="$YakiLeaderActor.$MissionCue" exact="$MissionCue"/>
            <set_value name="$YakiCivilianActor.$MissionCue" exact="$MissionCue"/>
            <set_value name="$MiningLeaderActor.$MissionCue" exact="$MissionCue"/>
            <set_value name="$MiningSubordinateActor.$MissionCue" exact="$MissionCue"/>
            <!-- $WingmateActor.$MissionCue gets set in Setup_Yaki_Wingmate -->
          </actions>
          <force name="Ch10_Force">
            <signal_cue cue="Setup_Secret_Service_Contact"/>
            <do_if value="not player.headquarters">
              <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors" param="false"/>
            </do_if>
            <set_object_name object="$SecretServiceActor" page="30225" line="102" comment="Delilah Shiratori"/>
            <reset_cue cue="Activate_Wingmate_Handlers"/>
            <do_if value="@$WingmateShip.exists">
              <destroy_object object="$WingmateShip"/>
            </do_if>
          </force>
          <cues>

            <cue name="Ch10_Trigger_Setup">
              <actions>
                <signal_cue cue="Setup_Yaki_Story_Character_Changes"/>
              </actions>
            </cue>

            <cue name="Ch10_1_Conversation">
              <conditions>
                <event_cue_completed cue="Setup_Yaki_Story_Character_Changes"/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="1"/>
              </actions>
              <cues>

                <cue name="Ch10_1_Conversation_Call" checkinterval="5min">
                  <conditions>
                    <check_value value="$SecretServiceStation? and not player.entity.hascontext.{$SecretServiceStation}"/>
                    <check_value value="$HQ? and not player.entity.hascontext.{$HQ}"/>
                    <check_value value="Ch10_1_Conversation_Outro.state == cuestate.waiting"/>
                  </conditions>
                  <cues>

                    <cue name="Ch10_1_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="IsInMission"       value="false"/>
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30226601],[30226001],[30226002]]"/>
                      <param name="EndSignalCue"      value="Ch10_1_Conversation_Call_Update_Objective"/>
                      <!--
                            Delilah:
                              (serious)Operative.
                              There are new developments you might be interested in.
                              Meet me once you can spare a moment.
                            -->
                    </cue>

                    <!-- TODO: Add a call here, if the mission ends up being difficult to find. -->

                    <cue name="Ch10_1_Conversation_Call_Update_Objective">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <create_mission cue="$MissionCue" name="{30226,1001}" description="{30226,1002}" rewardtext="{30226,1003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.name">
                          <briefing>
                            <objective step="1" action="objective.talkto" object="$SecretServiceActor" text="{30225,102}"/>
                          </briefing>
                        </create_mission>
                        <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch10_1_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$SecretServiceActor"/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30226,1030}" section="section_yaki_briefing_main" choiceparam="'incident'"/>
                  </actions>
                </cue>

                <cue name="Ch10_1_Conversation_Section_Main" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SecretServiceActor" section="section_yaki_briefing_main"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="event.param2 == 'incident'">
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226102" comment="Ever since you handed in your report, my people have been working tirelessly to find a connection between a number of intriguing events that have occurred in Sol over the course of the last few weeks."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226103" comment="The first incidents were barely beyond the ordinary: high-tech traders missing cargo, manipulated delivery schedules, the occasional kidnapping and ransoming..."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226104" comment="Then things began to ramp up: top secret deliveries being raided, fake distress signals targeting our military trainees, sabotage on a grand scale."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226105" comment="And lately, more and more of these incidents involve the Xenon in some fashion."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226106" comment="We can no longer ignore the possibility of a major new threat for the Terran Protectorate."/>
                    </do_if>

                    <do_elseif value="event.param2 == 'perpetrators'">
                      <set_value name="$PerpetratorsAsked"/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226107" comment="Ever since your last report, we've been fairly sure that our opponents are the infamous Yaki."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226108" comment="To make it short, they're pirates. Our data suggests that they've originally spawned from members of the Argon Federation. Another splinter group they couldn't keep under control."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226109" comment="The Yaki have always dabbled in dangerous technology, and they seem to only have doubled down on that alarming tendency since we last had the pleasure to make contact."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226150" comment="One of their criminal spin-off enterprises, the infamous Beryll, was responsible for an AGI drone attack on Earth in recent history."/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226110" comment="Expect their ships to be heavily armed and manoeuvrable."/>
                    </do_elseif>

                    <add_player_choice text="{30226,1030}" section="section_yaki_briefing_main" choiceparam="'incident'" position="top_left"/>
                    <add_player_choice text="{30226,1031}" section="section_yaki_briefing_main" choiceparam="'perpetrators'" position="bottom_left" highlighted="not $PerpetratorsAsked?"/>

                    <do_if value="$PerpetratorsAsked?">
                      <add_player_choice text="{30226,1032}" section="section_yaki_briefing_outro" position="right" highlighted="true"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch10_1_Conversation_Outro">
                  <conditions>
                    <event_conversation_next_section actor="$SecretServiceActor" section="section_yaki_briefing_outro"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226101" comment="Ah, yes, indeed. I recognise you might have... personal reasons for your interest, so it only seems prudent to offer you this assignment first."/>
                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226111" comment="The objective is simple: Find out where these pirates are hiding, what their goals are, and whether they can be defeated."/>
                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226112" comment="Unfortunately, you will only be able to call upon limited support during your mission."/>
                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226113" comment="As an undercover operative, it is paramount that no direct connection can be drawn between you and the Terran Secret Service."/>
                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226114" comment="Once you leave Protectorate space, you're on your own."/>
                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226115" comment="I can provide some guidance to help you start, but ultimately you will be the one making decisions under pressure."/>
                  </actions>
                </cue>

                <cue name="Ch10_1_Conversation_Finished">
                  <conditions>
                    <event_conversation_finished actor="$SecretServiceActor" outcome="section_yaki_briefing_outro"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch10_Clean_Up"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch10_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Ch11_Find_Traces"/>
                <cancel_cue cue="Ch10_Yaki_Investigation_Intro"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch11_Find_Traces">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_mission cue="$MissionCue" name="{30226,1001}" description="{30226,1002}" rewardtext="{30226,1003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.name">
              <briefing>
                <objective step="1" action="objective.talkto" text="{30225,102}"/>
              </briefing>
            </create_mission>
          </actions>
          <cues>

            <cue name="Ch11_Setup_Search">
              <actions>
                <!-- Offsets for the sectors leading up to the final one -->
                <create_position name="$SatelliteOffset1" space="$TrackYakiSector1" x="35km" z="10km"/>
                <create_position name="$SatelliteOffset2" space="$TrackYakiSector2" x="30km" z="-10km"/>
                <create_position name="$SatelliteOffset3" space="$AmbushWreckSector" x="0km" z="-30km"/>
                <set_value name="$SatelliteRadius1" exact="150km"/>
                <set_value name="$SatelliteRadius2" exact="200km"/>
                <set_value name="$SatelliteRadius3" exact="200km"/>

                <signal_cue cue="Ch11_1_Briefing"/>
              </actions>
            </cue>

            <cue name="Ch11_1_Briefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="2"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" object="$TrackYakiSector1" offset="$SatelliteOffset1" radius="$SatelliteRadius1" customaction="{30226,1010}" updatebriefing="true" insert="true"/>
              </actions>
              <cues>

                <cue name="Ch11_1_Briefing_Speak_1">
                  <actions>
                    <speak actor="$SecretServiceActor" priority="100">
                      <text line="if (player.module == 'x4ep1_gamestart_terran1') then 30226117 else 30226116" comment="(variant 2)You and cadet Shinamon recently encountered an especially malicious distress signal trap that was presumably set by these Yaki.
                                                                                                                        (variant 1)Two of our cadets recently encountered an especially malicious distress signal trap that was presumably set by these Yaki."/>
                      <text line="30226118" comment="They seem to be targeting specific Terran ships for some reason. And since they're keen on eliminating anyone who follows their trail, that reason remains a mystery to us."/>
                      <text line="30226119" comment="If we catch them in the act, that will tell us more about their objectives."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch11_1_Briefing_Speak_2">
                  <conditions>
                    <check_any>
                      <event_speak_finished actor="$SecretServiceActor" line="30226116"/>
                      <event_speak_finished actor="$SecretServiceActor" line="30226117"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch11_2_First_Sector_Satellite"/>

                    <do_if value="player.room == $SecretServiceActor.room">
                      <speak actor="$SecretServiceActor" priority="100">
                        <text line="30226120" comment="An advanced satellite should be able to pick up on all distress signals in the sector. My team will evaluate the data and point you towards potential discrepancies."/>
                        <text line="30226121" comment="With your record, you will do just fine, operative. I will leave you to prepare."/>
                      </speak>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch11_1_Briefing_Speak_2_Remote_Dialog"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch11_1_Briefing_Speak_2_Remote_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch11_1_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30226120],[30226121]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Delilah:
                              An advanced satellite should be able to pick up on all distress signals in the sector. My team will evaluate the data and point you towards potential discrepancies.
                              With your record, you will do just fine, operative. I will leave you to prepare.
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch11_2_First_Sector_Satellite">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch11_2_Sector_Reached_Speak">
                  <conditions>
                    <event_object_changed_sector object="player.entity" sector="$TrackYakiSector1"/>
                  </conditions>
                  <cues>

                    <cue name="Ch11_2_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30226122]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Delilah:
                              <t id="30226122">Anywhere within this sector will be fine, operative.</t>
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch11_2_DeployInPlace_Ref" ref="md.RML_DeployInPlace.DeployInPlace">
                  <param name="EndSignalCue"                  value="Ch11_2_Satellite_Deployed_Speak"/>
                  <param name="MissionCue"                    value="$MissionCue"/>
                  <param name="StartStep"                     value="$CurrentStep" comment="Briefing step to start the mission on"/>
                  <param name="UpdateBriefing"                value="true" comment="Update the briefing objective step when the objective is updated"/>
                  <param name="DebugChance"                   value="$DebugChance"/>
                  <param name="ObjectiveText"                 value="{30226,1013}"/>
                  <param name="ObjectiveText_Plural"          value="{30226,1013}"/>
                  <param name="ObjectiveText_InRange"         value="{20201,20401}"/>
                  <param name="ObjectiveText_InRange_Plural"  value="{20201,20401}"/>

                  <param name="TargetSector"        value="$TrackYakiSector1"/>
                  <param name="TargetOffset"        value="$SatelliteOffset1"/>
                  <param name="TargetRadius"        value="$SatelliteRadius1"/>
                  <param name="TargetCount"         value="1"/>
                  <param name="DeployableCategory"  value="deployablecategory.satellite"/>
                  <param name="Faction"             value="faction.player"/>
                </cue>

                <cue name="Ch11_2_Satellite_Deployed_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Overwrite step. -->
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,1012}" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch11_2_Secret_Service_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30226123],[30226124]]"/>
                      <param name="EndSignalCue"      value="Ch11_3_Second_Sector_Satellite"/>
                      <!--
                            Delilah:
                              <t id="30226123">Let's see here... two medical emergencies, and a harmless collision in the docking queue. Nothing out of the ordinary.</t>
                              <t id="30226124">Patrols are already moving in to assist. Carry on with your task.</t>
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch11_3_Second_Sector_Satellite">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch11_3_Sector_Reached_Speak">
                  <conditions>
                    <event_object_changed_sector object="player.entity" sector="$TrackYakiSector2"/>
                  </conditions>
                  <cues>

                    <cue name="Ch11_3_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="DelayInitial"      value="3s"/>
                      <param name="Lines"             value="[[30226125]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Delilah:
                              <t id="30226125">Beautiful, isn't it? Sol at peace, I mean. I hope we can keep it that way.</t>
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch11_3_DeployInPlace_Ref" ref="md.RML_DeployInPlace.DeployInPlace">
                  <param name="EndSignalCue"                  value="Ch11_3_Satellite_Deployed_Speak"/>
                  <param name="MissionCue"                    value="$MissionCue"/>
                  <param name="StartStep"                     value="$CurrentStep" comment="Briefing step to start the mission on"/>
                  <param name="UpdateBriefing"                value="true" comment="Update the briefing objective step when the objective is updated"/>
                  <param name="DebugChance"                   value="$DebugChance"/>
                  <param name="ObjectiveText"                 value="{30226,1013}"/>
                  <param name="ObjectiveText_Plural"          value="{30226,1013}"/>
                  <param name="ObjectiveText_InRange"         value="{20201,20401}"/>
                  <param name="ObjectiveText_InRange_Plural"  value="{20201,20401}"/>

                  <param name="TargetSector"        value="$TrackYakiSector2"/>
                  <param name="TargetOffset"        value="$SatelliteOffset2"/>
                  <param name="TargetRadius"        value="$SatelliteRadius2"/>
                  <param name="TargetCount"         value="1"/>
                  <param name="DeployableCategory"  value="deployablecategory.satellite"/>
                  <param name="Faction"             value="faction.player"/>
                </cue>

                <cue name="Ch11_3_Satellite_Deployed_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Overwrite step. -->
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30226,1012}" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch11_3_Secret_Service_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30226126],[30226127],[30226128],[30226129]]"/>
                      <param name="EndSignalCue"      value="Ch11_4_Final_Sector_Satellite"/>
                      <!--
                            Delilah:
                               <t id="30226126">(smug)And here we are. You just have to know what to watch out for.</t>
                               <t id="30226127">A civilian transport logged an unidentified vessel creeping about at the edges of the sector, refusing to answer when being asked for directions.</t>
                               <t id="30226128">There's no mention of a patrol encounter, so that ship might still be out there. Judging by the logged trajectory, we may be able to make a strike in the next sector.</t>
                               <t id="30226129">That's a lead! Let's move.</t>
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch11_4_Final_Sector_Satellite">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch11_4_Trigger_Fluff_Dialog">
                  <delay exact="5s"/>
                  <actions>
                    <do_if value="Ch11_4_Satellite_Deployed_Speak.state == cuestate.waiting">
                      <signal_cue cue="Ch11_4_Fluff_Dialog"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch11_4_Fluff_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch11_4_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30226130],[30226131],[30226132]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            Delilah:
                                <t id="30226130">Interesting. We're getting dangerously close to Segaris Pioneers territory.</t>
                                <t id="30226131">They're spread thin and rely on Terran trade. That makes them especially vulnerable to these pirate raids.</t>
                                <t id="30226132">If I were a shadowy nemesis that wanted to strike the Protectorate where it's weakest, Pioneers space is where I'd begin.</t>
                            -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch11_4_DeployInPlace_Ref" ref="md.RML_DeployInPlace.DeployInPlace">
                  <param name="EndSignalCue"                  value="Ch11_4_Satellite_Deployed_Speak"/>
                  <param name="MissionCue"                    value="$MissionCue"/>
                  <param name="StartStep"                     value="$CurrentStep" comment="Briefing step to start the mission on"/>
                  <param name="UpdateBriefing"                value="true" comment="Update the briefing objective step when the objective is updated"/>
                  <param name="DebugChance"                   value="$DebugChance"/>
                  <param name="ObjectiveText"                 value="{30226,1013}"/>
                  <param name="ObjectiveText_Plural"          value="{30226,1013}"/>
                  <param name="ObjectiveText_InRange"         value="{20201,20401}"/>
                  <param name="ObjectiveText_InRange_Plural"  value="{20201,20401}"/>

                  <param name="TargetSector"        value="$AmbushWreckSector"/>
                  <param name="TargetOffset"        value="$SatelliteOffset3"/>
                  <param name="TargetRadius"        value="$SatelliteRadius3"/>
                  <param name="TargetCount"         value="1"/>
                  <param name="DeployableCategory"  value="deployablecategory.satellite"/>
                  <param name="Faction"             value="faction.player"/>
                </cue>

                <cue name="Ch11_4_Satellite_Deployed_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Overwrite step. -->
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30226,1012}" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch11_4_Secret_Service_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30226133],[30226134],[30226135]]"/>
                      <param name="EndSignalCue"      value="Ch11_Clean_Up"/>
                      <!--
                            Delilah:
                                <t id="30226133">No hits. That's somewhat unexpected.</t>
                                <t id="30226134">No, there's something here. A faint signal my team can't quite pinpoint.</t>
                                <t id="30226135">I believe a more in-depth search is in order.</t>
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch11_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <signal_cue cue="Ch12_Ambush_Wreck"/>
                <cancel_cue cue="Ch11_Find_Traces"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch12_Ambush_Wreck">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <update_mission cue="$MissionCue" comment="Collapse steps.">
              <briefing replace="true">
                <objective step="1" action="objective.talkto" text="{30225,102}"/>
                <objective step="2" action="objective.custom" customaction="{30226,1010}"/>
              </briefing>
            </update_mission>
          </actions>
          <cues>

            <cue name="Ch12_Setup_Wreck">
              <actions>
                <!-- Wreck at the end of the trail -->
                <create_position name="$AmbushWreckPosition" space="$AmbushWreckSector" x="-170km" z="-33km"/>
                <create_object name="$AmbushWreck" macro="macro.ship_ter_l_trans_container_01_landmark_macro" sector="$AmbushWreckSector">
                  <safepos value="$AmbushWreckPosition"/>
                </create_object>
                <set_object_name object="$AmbushWreck" page="30226" line="216" comment="Mariner Valley Sea Life Club"/>
                <set_object_radar_visible object="$AmbushWreck" visible="false"/>

                <!-- Initialise lists -->
                <create_list name="$SearchOffsetList"/>
                <create_list name="$SearchRadiusList"/>
                <set_value name="$SearchSpeakList" exact="[null,[[30226136],[30226137]],[[30226138]],[[30226139]],[[30226140]]]" comment="4 elements, 5 search counters."/>

                <!--First Entry:
                     empty (initial search settings don't have an associated voice line)
                    Delilah 1:
                     <t id="30226136">That produced a result at least. If you keep this up, you'll be able to narrow down the signal's origin.</t>
                     <t id="30226137">Move towards the new search area and try again.</t>
                    Delilah 2:
                     <t id="30226138">It's getting clearer.</t>
                    Delilah 3:
                     <t id="30226139">Great. Keep it up.</t>
                    Delilah 4:
                     <t id="30226140">We've almost got it.</t>
                -->

                <!-- Final sector: first offset -->
                <create_position name="$SearchOffset1" space="$AmbushWreckSector"/>
                <set_value name="$SearchRadius1" exact="200km"/>
                <append_to_list name="$SearchOffsetList" exact="$SearchOffset1"/>
                <append_to_list name="$SearchRadiusList" exact="$SearchRadius1"/>
                <!-- Final sector: second offset -->
                <create_position name="$SearchOffset2" space="$AmbushWreckSector" x="-50km" z ="70km"/>
                <set_value name="$SearchRadius2" exact="115km"/>
                <append_to_list name="$SearchOffsetList" exact="$SearchOffset2"/>
                <append_to_list name="$SearchRadiusList" exact="$SearchRadius2"/>
                <!-- Final sector: third offset -->
                <create_position name="$SearchOffset3" space="$AmbushWreckSector" x="-100km" z ="60km"/>
                <set_value name="$SearchRadius3" exact="80km"/>
                <append_to_list name="$SearchOffsetList" exact="$SearchOffset3"/>
                <append_to_list name="$SearchRadiusList" exact="$SearchRadius3"/>
                <!-- Final sector: fourth offset -->
                <create_position name="$SearchOffset4" space="$AmbushWreckSector" x="-150km" z ="25km"/>
                <set_value name="$SearchRadius4" exact="50km"/>
                <append_to_list name="$SearchOffsetList" exact="$SearchOffset4"/>
                <append_to_list name="$SearchRadiusList" exact="$SearchRadius4"/>
                <!-- Final sector: final offset -->
                <create_position name="$FinalOffset" space="$AmbushWreckSector" x="-180km" z ="-25km"/>
                <set_value name="$FinalRadius" exact="25km"/>
                <append_to_list name="$SearchOffsetList" exact="$FinalOffset"/>
                <append_to_list name="$SearchRadiusList" exact="$FinalRadius"/>

                <signal_cue cue="Ch12_1_Search"/>
              </actions>
            </cue>

            <cue name="Ch12_Setup_Xenon_Ambush">
              <actions>
                <create_group groupname="$XenonAmbushGroup" comment="In case the group already exists."/>
                <set_value name="$XenonAmbushComposition" exact="[
                   [ macro.ship_xen_s_fighter_01_a_macro, 6 ],
                   [ macro.ship_xen_s_fighter_02_a_macro, 3 ]
                   ]" />
                <do_all exact="$XenonAmbushComposition.count" counter="$m">
                  <do_all exact="$XenonAmbushComposition.{$m}.{2}" counter="$a">
                    <create_ship name="$CurrentShip" macro="$XenonAmbushComposition.{$m}.{1}" commandeerable="false" capturable="false" missioncue="namespace" sector="$AmbushWreckSector">
                      <owner exact="faction.xenon" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.xenon" tags="tag.fighterpilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <drop ref="ship_small_xenon"/>
                      <safepos value="$AmbushWreckPosition"/>
                    </create_ship>
                    <create_order id="'Wait'" object="$CurrentShip" default="true"/>
                    <set_object_radar_visible object="$CurrentShip" visible="false"/>
                    <add_to_group groupname="$XenonAmbushGroup" object="$CurrentShip"/>
                  </do_all>
                </do_all>
              </actions>
            </cue>

            <cue name="Ch12_1_Search">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$SearchCounter"/>
                <set_value name="$CurrentSearchOffset" exact="$SearchOffsetList.{$SearchCounter}"/>
                <set_value name="$CurrentSearchRadius" exact="$SearchRadiusList.{$SearchCounter}"/>
                <debug_text text="'Current search settings are Counter: ' + $SearchCounter + '. Offset: ' + $CurrentSearchOffset + '. Radius: ' + $CurrentSearchRadius" chance="$DebugChance"/>

                <set_value name="$CurrentStep" exact="2"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,1014}" object="$AmbushWreckSector" offset="$CurrentSearchOffset" radius="$CurrentSearchRadius" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch12_1_Long_Range_Scan_Used" instantiate="true">
                  <conditions>
                    <event_long_range_scan_sent object="player.entity"/>
                    <check_value value="player.sector == $AmbushWreckSector"/>
                  </conditions>
                  <delay exact="4s" comment="Give Ch12_1_Long_Range_Scan_Success enough time to cancel this cue in case the wreck gets spotted."/>
                  <actions>
                    <do_if value="player.entity.distanceto.[$AmbushWreckSector, $CurrentSearchOffset] le $CurrentSearchRadius">
                      <do_if value="$SearchCounter == $SearchOffsetList.count">
                        <debug_text text="'Player used long range scan in the correct area, but the smallest search area has already been reached.'" chance="$DebugChance"/>
                      </do_if>
                      <do_else>
                        <debug_text text="'Player used long range scan in the correct area. Shrinking search area (' + $CurrentSearchRadius + ').'" chance="$DebugChance"/>
                        <set_value name="$SearchCounter" operation="add"/>
                        <set_value name="$CurrentSearchOffset" exact="$SearchOffsetList.{$SearchCounter}"/>
                        <set_value name="$CurrentSearchRadius" exact="$SearchRadiusList.{$SearchCounter}"/>
                        <set_value name="$CurrentSearchSpeak"  exact="$SearchSpeakList.{$SearchCounter}"/>
                        <debug_text text="'Current search settings are Counter: ' + $SearchCounter + '. Offset: ' + $CurrentSearchOffset + '. Radius: ' + $CurrentSearchRadius" chance="$DebugChance"/>
                        <signal_cue cue="Ch12_1_Target_Area_Shrunk_Speak"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,1014}" object="$AmbushWreckSector" offset="$CurrentSearchOffset" radius="$CurrentSearchRadius" updatebriefing="true"/>
                      </do_else>
                    </do_if>
                    <do_else>
                      <debug_text text="'Player used long range scan outside of the search area.'" chance="$DebugChance"/>
                      <debug_text text="'Current search settings are Counter: ' + $SearchCounter + '. Offset: ' + $CurrentSearchOffset + '. Radius: ' + $CurrentSearchRadius" chance="$DebugChance"/>
                      <debug_text text="'Current player position is: ' + player.entity.position + '. Distance to search offset: ' + player.entity.distanceto.{$CurrentSearchOffset}" chance="$DebugChance"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch12_1_Target_Area_Shrunk_Speak" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch12_1_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="$CurrentSearchSpeak"/>
                      <param name="EndSignalCue"      value="null"/>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch12_1_Long_Range_Scan_Success">
                  <conditions>
                    <event_long_range_scan_ping object="$AmbushWreck"/>
                    <check_value value="player.sector == $AmbushWreck.sector"/>
                    <check_value value="$SearchCounter ge 5"/>
                    <check_value value="Ch12_3_Xenon_Ambush.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <set_object_radar_visible object="$AmbushWreck" visible="true"/>

                    <!-- Stop search area objective updates. -->
                    <cancel_cue cue="Ch12_1_Long_Range_Scan_Used"/>
                    <do_if value="Ch12_3_Xenon_Ambush.state == cuestate.waiting">
                      <signal_cue cue="Ch12_2_Support"/>
                    </do_if>
                  </actions>
                </cue>

                <!-- When the player comes close to the wreck, the fight starts, no matter if they pinged it and waited for support first. -->
                <cue name="Ch12_1_Approach_AmbushWreck_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$AmbushWreck"/>
                  <param name="ApproachDistance"  value="4km"/>
                  <param name="SuccessSignalCue"  value="Ch12_3_Xenon_Ambush"/>
                </cue>

              </cues>
            </cue>

            <cue name="Ch12_2_Support">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch12_2_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30226141],[30226142]]"/>
                  <param name="EndSignalCue"      value="Ch12_2_Wait_For_Support"/>
                  <!--
                            Delilah:
                                There were go!
                                I'll assign a local patrol to assist you right away. These pirates won't ambush us this time!
                            -->
                </cue>

                <cue name="Ch12_2_Setup_Terran_Squad">
                  <actions>
                    <!-- Find closest Terran station with operational S dock in the sector. If no station could be found, the squad will spawn somewhere nearby in space to improve pacing. -->
                    <find_station_by_true_owner name="$TerranSquadStation" faction="faction.terran" sortbydistanceto="player.entity" space="player.sector">
                      <match_dock size="tag.dock_s" walkable="true"/>
                    </find_station_by_true_owner>
                    <!--<do_if value="not $TerranSquadStation">
                      <find_station_by_true_owner name="$TerranSquadStation" faction="faction.terran" sortbygatedistanceto="player.entity" space="player.galaxy">
                        <match_content checkoperational="true" walkable="true">
                          <match_dock size="tag.dock_s"/>
                        </match_content>
                      </find_station_by_true_owner>
                    </do_if>-->

                    <!-- Find internal dock. -->
                    <do_if value="$TerranSquadStation">
                      <find_dockingbay name="$TerranSquadStationInternalDock" object="$TerranSquadStation" checkoperational="true" multiple="false">
                        <match_dock storage="true" size="macro.ship_ter_s_fighter_01_a_macro.docksize"/>
                      </find_dockingbay>
                    </do_if>

                    <set_value name="$TerranSquadComposition" exact="[
                            [ macro.ship_ter_s_fighter_01_a_macro, 4 ]
                            ]" />

                    <do_all exact="$TerranSquadComposition.count" counter="$m">
                      <do_all exact="$TerranSquadComposition.{$m}.{2}" counter="$a">
                        <do_if value="$TerranSquadStationInternalDock?">
                          <create_ship name="$CurrentShip" macro="$TerranSquadComposition.{$m}.{1}" capturable="false" missioncue="namespace" dock="$TerranSquadStationInternalDock">
                            <owner exact="faction.terran" overridenpc="true"/>
                            <pilot>
                              <select faction="faction.terran" tags="tag.fighterpilot"/>
                            </pilot>
                            <loadout>
                              <level exact="1.0"/>
                            </loadout>
                          </create_ship>
                        </do_if>
                        <do_else>
                          <create_ship name="$CurrentShip" macro="$TerranSquadComposition.{$m}.{1}" capturable="false" missioncue="namespace" sector="player.sector">
                            <owner exact="faction.terran" overridenpc="true"/>
                            <pilot>
                              <select faction="faction.terran" tags="tag.fighterpilot"/>
                            </pilot>
                            <loadout>
                              <level exact="1.0"/>
                            </loadout>
                            <!-- Keep in mind: Matthias wants to change it so that the player doesn't match the camera offset in external view. -->
                            <safepos object="player.entity" z="-30km"/>
                          </create_ship>
                        </do_else>

                        <!-- No flight leader this time around. The player is in charge. -->
                        <!--<set_object_name object="$CurrentShip" page="30225" line="307" comment="Piranha Flight Leader"/>-->

                        <set_object_name object="$CurrentShip" name="'{30225,308}' + $a" comment="Piranha (followed by number)"/>

                        <set_value name="$CurrentPlayerShip" exact="player.ship"/>
                        <create_order id="'MoveWait'" object="$CurrentShip" default="true">
                          <param name="destination" value="[$AmbushWreckSector, $AmbushWreckPosition]"/>
                        </create_order>
                        <create_order id="'ProtectShip'" object="$CurrentShip" immediate="true">
                          <param name="target" value="$CurrentPlayerShip"/>
                        </create_order>

                        <add_to_group groupname="$TerranSquad" object="$CurrentShip"/>
                      </do_all>
                    </do_all>
                  </actions>
                </cue>

                <cue name="Ch12_2_Wait_For_Support">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" group="$TerranSquad" customaction="{30226,1015}" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch12_2_Approach_TerranSquad_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$TerranSquad.random"/>
                      <param name="ApproachDistance"  value="8km"/>
                      <param name="SuccessSignalCue"  value="Ch12_2_Update_Objective"/>
                    </cue>

                    <cue name="Ch12_2_Update_Objective">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$TerranSquad.count"/>
                      </conditions>
                      <actions>
                        <do_if value="Ch12_3_Xenon_Ambush.state == cuestate.waiting">
                          <set_value name="$CurrentStep" operation="add"/>
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,1016}" object="$AmbushWreck" text="{30284,1017}" insert="true" updatebriefing="true"/>
                        </do_if>
                      </actions>
                      <cues>

                        <cue name="Ch12_2_Secret_Service_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$SecretServiceActor"/>
                          <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                          <param name="Lines"             value="[[30226143]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Delilah:
                                Your escort is ready and eager for a fight.
                            -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch12_3_Xenon_Ambush" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_object_radar_visible object="$AmbushWreck" visible="true" comment="In case the player stumbled upon the ship without long range scanning it first."/>

                <set_value name="$CurrentPlayerShip" exact="player.ship"/>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$XenonAmbushGroup" text="{30284,1017}" insert="true" updatebriefing="true"/>
              </actions>
              <patch sinceversion="2">
                <set_object_radar_visible object="$AmbushWreck" visible="true"/>
              </patch>
              <cues>

                <cue name="Ch12_3_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30226144]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                            Delilah:
                                Xenon! Dispatch them, operative.
                            -->
                </cue>

                <cue name="Ch12_3_Xenon_Orders" version="2">
                  <actions>
                    <!-- The Xenon already exist before the objective updates, so they might have already been destroyed. -->
                    <do_if value="not $XenonAmbushGroup.count">
                      <set_value name="$XenonAmbushReset"/>
                      <reset_cue cue="Ch12_Setup_Xenon_Ambush"/>
                    </do_if>
                  </actions>
                  <delay exact="1s" comment="Give Ch12_Setup_Xenon_Ambush enough time to spawn the ships again if necessary."/>
                  <actions>
                    <do_for_each in="$XenonAmbushGroup" name="$CurrentShip" counter="$i">
                      <set_object_radar_visible object="$CurrentShip" visible="true"/>
                      <cancel_all_orders object="$CurrentShip"/>

                      <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                        <param name="destination" value="[$AmbushWreckSector, $AmbushWreckPosition]"/>
                        <param name="radius" value="5km"/>
                      </create_order>

                      <do_if value="not $XenonAmbushPatch?" comment="We don't want the Xenon to immediately fly towards the player in the patch case.">
                        <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                          <param name="primarytarget" value="if $i le 1 then $CurrentPlayerShip else $TerranSquad.random"/>
                          <param name="secondarytargets" value="$TerranSquad"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                      </do_if>
                    </do_for_each>

                    <!-- Update objective in case the Xenon had to be respawned. Guidance doesn't get set on them automatically even though we add them to the existing group. -->
                    <do_if value="$XenonAmbushReset?">
                      <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$XenonAmbushGroup" text="{30284,1017}" silent="true" updatebriefing="true"/>
                      <reset_cue cue="Ch12_3_Success" comment="Event source has changed."/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="(Ch12_3_Success.state == cuestate.waiting) and not $XenonAmbushGroup.count">
                      <set_value name="$XenonAmbushPatch"/>
                      <reset_cue cue="this"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch12_3_Success">
                  <conditions>
                    <event_object_destroyed group="$XenonAmbushGroup"/>
                    <check_value value="$XenonAmbushGroup.count == 1"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch12_Clean_Up"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch12_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Ch13_Track_Yaki"/>
                <cancel_cue cue="Ch12_Ambush_Wreck"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch13_Track_Yaki">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <update_mission cue="$MissionCue" comment="Clean up briefing steps.">
              <briefing replace="true">
                <objective step="1" action="objective.talkto" text="{30225,102}"/>
                <objective step="2" action="objective.custom" customaction="{30226,1010}"/>
                <objective step="3" action="objective.track" text="{30226,1011}"/>
              </briefing>
            </update_mission>
          </actions>
          <cues>

            <cue name="Ch13_Setup_Damaged_Trader">
              <actions>
                <create_position name="$GuidanceOffset" space="$DamagedTraderSector" x="85km" z="-15km"/>
                <set_value name="$GuidanceRadius" exact="75km"/>

                <create_position name="$DamagedTraderPosition" space="$DamagedTraderSector" x="105km" z="-80km"/>

                <create_ship name="$DamagedTrader" macro="ship_ter_l_trans_container_01_a_macro" sector="$DamagedTraderSector" missioncue="namespace" capturable="false">
                  <owner exact="faction.terran" overridenpc="true" />
                  <pilot>
                    <select faction="faction.terran" tags="tag.fighterpilot"/>
                  </pilot>
                  <loadout>
                    <level exact="0.1"/>
                  </loadout>
                  <safepos value="$DamagedTraderPosition"/>
                  <rotation yaw="-45deg" pitch="-25deg" roll="35deg"/>
                </create_ship>

                <set_object_name object="$DamagedTrader" page="30226" line="201" comment="Bountiful Sunlight"/>

                <set_object_min_hull object="$DamagedTrader" exact="10"/>
                <set_object_hull object="$DamagedTrader" exact="10"/>

                <find_object_component groupname="$DamagedTraderEngines" object="$DamagedTrader" multiple="true" class="class.engine"/>
                <find_object_component groupname="$DamagedTraderTurrets" object="$DamagedTrader" multiple="true" class="class.turret"/>
                <destroy_group group="$DamagedTraderEngines" explosion="true"/>
                <destroy_group group="$DamagedTraderTurrets" explosion="true"/>

                <create_order id="'Wait'" object="$DamagedTrader" default="true">
                  <param name="noattackresponse" value="true"/>
                </create_order>
              </actions>
            </cue>

            <cue name="Ch13_1_Find_Damaged_Trader">
              <actions>
                <set_value name="$CurrentStep" exact="3"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.find" object="$DamagedTraderSector" offset="$GuidanceOffset" radius="$GuidanceRadius" text="{30226,1017}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch13_1_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30226145],[30226146]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                            Delilah:
                                I'd love to take the time to commend you for your bravery, operative, but I'm afraid you'll have to continue on your quest right away.
                                A local trader just sent out a distress signal, and the pattern matches that of an earlier pirate attack. We're close to apprehending these intruders!
                            -->
                </cue>

                <cue name="Ch14_1_Approach_DamagedTrader_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$DamagedTrader"/>
                  <param name="ApproachDistance"  value="5km"/>
                  <param name="SuccessSignalCue"  value="Ch13_1_Long_Range_Scan"/>
                </cue>

                <cue name="Ch13_1_Long_Range_Scan">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_long_range_scan_ping object="$DamagedTrader"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch14_1_Approach_DamagedTrader_Ref"/>
                    <signal_cue cue="Ch13_2_Scan_Damaged_Trader"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch13_2_Scan_Damaged_Trader">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.scan" object="$DamagedTrader" text="{30226,1017}" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch13_2_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30226147]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                            Delilah:
                                Seems you've arrived just in time. The reports are piling up in Pioneers territory, as we feared.
                            -->
                </cue>

                <cue name="Ch13_2_Scan_Failsafe" comment="In case the ship already got scanned.">
                  <conditions>
                    <event_player_changed_activity activity="activity.scan"/>
                  </conditions>
                  <delay exact="15s"/>
                  <actions>
                    <do_if value="Ch13_2_Scan_Successful.state == cuestate.waiting">
                      <show_help line="15112" position="1" force="true" comment="Fly close to the target and select SCAN from the context menu." allowclose="true" timeout="false"/>
                    </do_if>
                  </actions>
                  <delay exact="25s"/>
                  <actions>
                    <do_if value="Ch13_2_Scan_Successful.state == cuestate.waiting">
                      <signal_cue cue="Ch13_2_Scan_Successful"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch13_2_Scan_Successful">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_scan_finished scanned="$DamagedTrader"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch13_2_Debriefing_Dialog"/>
                  </actions>
                </cue>

                <cue name="Ch13_2_Debriefing_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch13_2_Secret_Service_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30226148],[30226149]]"/>
                      <param name="EndSignalCue"      value="Ch13_Clean_Up"/>
                      <!--
                            Delilah:
                                How odd. The trader reports that she was ordered to drop her cargo, but that nothing of value ended up being stolen, only a small amount of foodstuffs.
                                However, there's no time to dwell on that right now. This is as far as I can safely communicate with you, operative. From here on out, you're on your own.
                            -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch13_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Remove Terran squad. -->
                <do_if value="$TerranSquad.count">
                  <find_station_by_true_owner name="$TerranSquadMoveDieStation" faction="faction.terran" sortbygatedistanceto="$TerranSquad.random" space="player.galaxy">
                    <match_dock size="tag.dock_s"/>
                  </find_station_by_true_owner>
                  <do_for_each in="$TerranSquad" name="$CurrentShip">
                    <cancel_all_orders object="$CurrentShip"/>
                    <create_order id="'Wait'" object="$CurrentShip" default="true"/>
                    <create_order id="'MoveDie'" object="$CurrentShip">
                      <param name="atstation" value="$TerranSquadMoveDieStation"/>
                    </create_order>
                  </do_for_each>
                </do_if>
                <!-- Remove damaged trader. -->
                <find_station_by_true_owner name="$DamagedTraderMoveDieStation" faction="faction.terran" sortbygatedistanceto="$DamagedTrader" space="player.galaxy">
                  <match_dock size="tag.dock_l"/>
                </find_station_by_true_owner>
                <cancel_all_orders object="$DamagedTrader"/>
                <create_order id="'MoveDie'" object="$DamagedTrader">
                  <param name="atstation" value="$DamagedTraderMoveDieStation"/>
                </create_order>

                <signal_cue cue="Ch14_Rescue_Pioneers"/>
                <cancel_cue cue="Ch13_Track_Yaki"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch14_Rescue_Pioneers">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <update_mission cue="$MissionCue" comment="Clean up briefing steps.">
              <briefing replace="true">
                <objective step="1" action="objective.talkto" text="{30225,102}"/>
                <objective step="2" action="objective.custom" customaction="{30226,1010}"/>
                <objective step="3" action="objective.track" text="{30226,1011}"/>
              </briefing>
            </update_mission>
          </actions>
          <cues>

            <cue name="Ch14_Setup_Ships">
              <actions>
                <!-- Mining Fleet -->
                <create_position name="$MiningFleetPosition" space="$MiningFleetSector" x="25km" z="125km"/>
                <create_position name="$MiningFleetSearchOffset" space="$MiningFleetSector" x="-5km" z="30km"/>
                <set_value name="$MiningFleetSearchRadius" exact="160km"/>

                <set_value name="$MiningFleetComposition" exact="[
                            [ macro.ship_ter_m_miner_solid_01_a_macro,     30226, 206 ],
                            [ macro.ship_ter_s_miner_solid_01_a_macro,     30226, 210 ],
                            [ macro.ship_ter_s_miner_solid_01_a_macro,     30226, 211 ],
                            [ macro.ship_ter_s_miner_solid_01_a_macro,     30226, 214 ],
                            [ macro.ship_ter_s_trans_container_01_a_macro, 30226, 217 ],
                            [ macro.ship_ter_s_trans_container_01_a_macro, 30226, 220 ]
                            ]" />
                <!-- Wisdom of the Pines
                     Memorable Chanterelle
                     Monday to Friday Ship
                     Space Dingo
                     Trusty Zori
                     Roquio-->

                <do_all exact="$MiningFleetComposition.count" counter="$m">
                  <create_ship name="$CurrentShip" macro="$MiningFleetComposition.{$m}.{1}" capturable="false" missioncue="namespace" sector="$MiningFleetSector">
                    <owner exact="faction.pioneers" overridenpc="true"/>
                    <pilot>
                      <select faction="faction.pioneers" tags="tag.fighterpilot"/>
                    </pilot>
                    <loadout>
                      <level exact="1.0"/>
                    </loadout>
                    <people ref="terran_elite_freighter_crew"/>
                    <safepos value="$MiningFleetPosition"/>
                  </create_ship>
                  <set_object_name object="$CurrentShip" page="$MiningFleetComposition.{$m}.{2}" line="$MiningFleetComposition.{$m}.{3}"/>
                  <create_order id="'Wait'" object="$CurrentShip" default="true"/>
                  <do_if value="$m == 1">
                    <set_value name="$MiningFleetCommander" exact="$CurrentShip"/>
                    <set_object_min_hull object="$MiningFleetCommander" exact="30"/>
                  </do_if>
                  <do_else>
                    <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                      <param name="commander" value="$MiningFleetCommander"/>
                      <param name="assignment" value="assignment.defence"/>
                      <param name="cancelorders" value="true"/>
                    </create_order>
                  </do_else>
                  <add_to_group groupname="$MiningFleet" object="$CurrentShip"/>
                  <add_to_group groupname="$MiningFleetPilots" object="$CurrentShip.pilot"/>
                </do_all>

                <!-- Yaki Pirate -->
                <create_ship name="$YakiPirate" macro="macro.ship_yak_m_corvette_01_a_macro" capturable="false" missioncue="namespace" sector="$MiningFleetSector">
                  <owner exact="faction.civilian" overridenpc="true"/>
                  <pilot actor="$YakiRenegadeActor"/>
                  <loadout loadout="$YakiRenegadeLoadout"/>
                  <!-- Paint mod: Violaceous Xenomask (Yaki Camo 2)-->
                  <paint ware="ware.paintmod_0125"/>
                  <safepos object="$MiningFleetCommander" y="50m" z="150m"/>
                  <rotation yaw="180deg"/>
                </create_ship>
                <create_order id="'Wait'" object="$YakiPirate" default="true">
                  <param name="noattackresponse" value="true"/>
                </create_order>

                <set_object_name object="$YakiPirate" page="30226" line="208" comment="Wolfish Heart"/>

                <set_object_min_hull object="$YakiPirate" exact="100"/>
                <set_object_min_shield object="$YakiPirate" exact="100"/>

                <set_drop_object object="$YakiPirate" drop="'drops_yakistory_yakipiratedrop_1'"/>

                <!-- Instantiate the $MiningLeaderActor on the $MiningFleetCommander ship, so that the target monitor cutscenes work correctly. -->
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MiningLeaderActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $MiningFleetCommander.controlroom,
                                                                                                                                      $position = position.[0.0m, -1.3m, -1.25m],
                                                                                                                                      $rotation = rotation.[0deg, 0deg, 0deg],
                                                                                                                                      $debugchance = 0,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                <signal_cue cue="Ch14_1_Prevent_Attack"/>
              </actions>
            </cue>

            <cue name="Ch14_1_Prevent_Attack">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="4"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,1018}" object="$MiningFleetSector" offset="$MiningFleetSearchOffset" radius="$MiningFleetSearchRadius" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch14_1_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                  <param name="DelayInitial"      value="5s"/>
                  <param name="Lines"             value="[[30226101],[30226102]]"/>
                  <param name="EndSignalCue"      value="Ch14_1_Approach_Guidance_Radius"/>
                  <!--
                              Aha! Now that the venerable Terran individual has terminated communications, I can finally share my insights with my valued assistant.
                              I do so fancy a proper scientific investigation!
                                                    -->
                </cue>

                <cue name="Ch14_1_Approach_Guidance_Radius">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch14_1_Approach_DeployMinesOffset_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                      <param name="ApproachSector"    value="$MiningFleetSector"/>
                      <param name="ApproachOffset"    value="$MiningFleetSearchOffset"/>
                      <param name="ApproachDistance"  value="$MiningFleetSearchRadius"/>
                      <param name="SuccessSignalCue"  value="Ch14_1_Guidance_Radius_Reached_Dialog"/>
                    </cue>

                    <cue name="Ch14_1_Guidance_Radius_Reached_Dialog">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch14_1_Boso_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="DelayInitial"      value="6s"/>
                          <param name="Lines"             value="[[30226103]]"/>
                          <param name="EndSignalCue"      value="Ch14_1_Approach_Mining_Fleet"/>
                          <!--
                              I spot a Pioneer mining fleet in the distance. Maybe we can ask them for directions.
                                                    -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch14_1_Approach_Mining_Fleet">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Insert before the previous step. -->
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,1020}" silent="true" object="$MiningFleetCommander" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch14_1_Approach_MiningFleetCommander_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$MiningFleetCommander"/>
                      <param name="ApproachDistance"  value="30km"/>
                      <param name="SuccessSignalCue"  value="Ch14_1_Approach_Complete_Dialog_1"/>
                    </cue>

                    <cue name="Ch14_1_Mining_Fleet_Commed">
                      <conditions>
                        <check_any>
                          <event_conversation_started actor="$MiningFleetCommander.pilot"/>
                          <check_all>
                            <event_conversation_started/>
                            <check_value value="$MiningFleetPilots.indexof.{event.object}"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch14_1_Approach_Complete_Dialog_1" check="false"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch14_1_Approach_Complete_Dialog_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch14_1_Boso_Renegade_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$BosoTa, $YakiRenegadeActor]"/>
                      <param name="CutsceneKey"       value="[$BosoCutsceneKey, $YakiRenegadeCutsceneKey]"/>
                      <param name="Lines"             value="[  [[30226104]],
                                                                [[30226101]]  ]"/>
                      <param name="EndSignalCue"      value="[null, Ch14_1_Approach_Complete_Dialog_2]"/>
                      <!--         
                      Boso:
                        By the Queen! Those Pioneer fellows seem to be in trouble!
                      Obelisk:
                        (unhinged, almost screaming)Who treads there? One step closer and you're space fly chow!
                          -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch14_1_Approach_Complete_Dialog_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$MiningLeaderActor" priority="100">
                      <text line="30226101" comment="(panicked)No, no, no, this can't be happening!"/>
                      <text line="30226102" delay="2s" comment="(gathering himself, swallowing nervously)Fleet, defend yourself! Don't let that Yaki take away our hard-earned credits!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch14_1_Approach_Complete_Dialog_3">
                  <conditions>
                    <event_speak_finished actor="$MiningLeaderActor" line="30226101"/>
                  </conditions>
                  <actions>
                    <speak actor="$MiningSubordinateActor" priority="100">
                      <text line="30226101" comment="(incredulous)Captain? Are you sure..."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch14_1_Approach_Complete_Dialog_4">
                  <conditions>
                    <event_speak_finished actor="$MiningSubordinateActor" line="30226101"/>
                  </conditions>
                  <actions>
                    <speak actor="$MiningLeaderActor" priority="100">
                      <text line="30226103" comment="(determined)Of course I am sure! We're Pioneers, and we won't be done in by a pirate!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch14_1_Approach_Complete_Dialog_Finished">
                  <conditions>
                    <event_speak_finished actor="$MiningLeaderActor" line="30226103"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <signal_cue cue="Ch14_2_Defeat_Yaki"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch14_2_Defeat_Yaki">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Skip the "prevent attack" step. -->
                <set_value name="$CurrentStep" exact="2" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" object="$YakiPirate" text="{30225,105}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch14_2_Yaki_Pirate_Dialog">
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$YakiRenegadeActor" priority="100">
                      <text line="30226102" comment="(unhinged, almost screaming)Fools! I will see you slaughtered for this!"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch14_2_Yaki_Pirate_Dialog_Finished">
                  <conditions>
                    <event_speak_finished actor="$YakiRenegadeActor" line="30226102"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="Ch14_2_Yaki_Pirate_Orders">
                  <actions>
                    <set_owner object="$YakiPirate" faction="faction.yaki" overridenpc="true"/>

                    <set_object_min_hull object="$YakiPirate" exact="0"/>
                    <set_object_min_shield object="$YakiPirate" exact="0"/>

                    <do_if value="player.entity.hascontext.{$MiningFleetSector} and player.ship">
                      <set_value name="$AttackTarget" exact="player.ship"/>
                    </do_if>
                    <do_else>
                      <set_value name="$AttackTarget" exact="$MiningFleetCommander"/>
                    </do_else>

                    <create_order id="'Attack'" object="$YakiPirate" immediate="true">
                      <param name="primarytarget" value="$MiningFleet.random"/>
                      <param name="secondarytargets" value="$MiningFleet"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                    </create_order>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <do_if value="$YakiPirate.isoperational and $AttackTarget.isoperational and @$AttackTarget.sector == $MiningFleetSector">
                      <create_order id="'Attack'" object="$YakiPirate" immediate="true">
                        <param name="primarytarget" value="$AttackTarget"/>
                        <param name="pursuetargets" value="true"/>
                        <param name="checkrelation" value="false"/>
                      </create_order>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch14_2_Mining_Fleet_Orders">
                  <actions>
                    <create_order id="'Attack'" object="$MiningFleetCommander" immediate="true">
                      <param name="primarytarget" value="$YakiPirate"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                      <param name="allowothertargets" value="false"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch14_2_Yaki_Destroyed">
                  <conditions>
                    <event_object_destroyed object="$YakiPirate"/>
                  </conditions>
                  <actions>
                    <do_if value="$YakiPirate.sector">
                      <set_value name="$YakiDeathSector" exact="$YakiPirate.sector"/>
                    </do_if>
                    <do_else>
                      <set_value name="$YakiDeathSector" exact="$MiningFleetSector"/>
                    </do_else>
                    <create_position name="$YakiDeathPosition" object="$YakiPirate" space="$YakiDeathSector"/>

                    <create_object name="$YakiCrate1" macro="macro.sm_gen_wares_rare_01_macro" sector="$YakiDeathSector">
                      <safepos value="$YakiDeathPosition"/>
                    </create_object>
                    <add_cargo object="$YakiCrate1" ware="ware.inv_sealed_vacuum_tubes" exact="1"/>
                    <add_to_group groupname="$YakiCrateGroup" object="$YakiCrate1"/>

                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$YakiRenegadeActor" priority="100">
                      <text line="30226104" comment="***Wordless Scream***"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch14_2_Yaki_Pirate_Death_Scream_Finished">
                  <conditions>
                    <event_speak_finished actor="$YakiRenegadeActor" line="30226104"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="Ch14_2_Xenon_Support" version="2">
                  <conditions>
                    <check_any>
                      <check_all>
                        <event_object_shield_damaged object="$YakiPirate"/>
                        <check_value value="$YakiPirate.shieldpercentage le 70"/>
                      </check_all>
                      <check_all>
                        <event_object_hull_damaged object="$YakiPirate"/>
                        <check_value value="$YakiPirate.hullpercentage le 95"/>
                      </check_all>
                      <!-- This can happen if Obelisk is destroyed in one shot. -->
                      <event_object_destroyed object="$YakiPirate"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$YakiRenegadeActor" priority="100">
                      <text line="30226103" comment="(unhinged, almost screaming)Come, my children! Tear them from their metal coffins!"/>
                    </speak>
                  </actions>
                  <patch sinceversion="2" state="waiting" comment="Patch case where $YakiPirate was destroyed in one shot, not triggering the event_object_shield_damaged and event_object_hull_damaged conditions of this cue (event_object_destroyed was added later).">
                    <do_if value="not $YakiPirate.isoperational">
                      <signal_cue cue="Ch14_3_Debriefing"/>
                    </do_if>
                  </patch>
                  <patch sinceversion="2" state="complete" comment="Patch case where $YakiPirate was destroyed during the above dialog, Ch14_2_Xenon_Support_Dialog_Finished triggered while $YakiPirate still counted as operational, and $YakiPirate was added to $AttackWave.">
                    <do_if value="(Ch14_3_Debriefing.state == cuestate.waiting) and not $YakiPirate.isoperational and $AttackWave? and $AttackWave.indexof.{$YakiPirate}">
                      <remove_from_group group="$AttackWave" object="$YakiPirate"/>
                      <do_if value="not $AttackWave.count">
                        <signal_cue cue="Ch14_3_Debriefing"/>
                      </do_if>
                    </do_if>
                  </patch>
                  <cues>

                    <cue name="Ch14_2_Xenon_Support_Dialog_Finished">
                      <conditions>
                        <event_speak_finished actor="$YakiRenegadeActor" line="30226103"/>
                      </conditions>
                      <delay exact="0.1s" comment="Necessary to give the destruction of the ship time to register. Otherwise it would still be .isoperational == 1 in this cue."/>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>

                        <do_if value="player.entity.hascontext.{$MiningFleetSector} and player.ship">
                          <set_value name="$AttackTarget" exact="player.ship"/>
                        </do_if>
                        <do_else>
                          <set_value name="$AttackTarget" exact="$MiningFleetCommander"/>
                        </do_else>

                        <create_position name="$YakiPiratePosition" object="$YakiPirate" space="$MiningFleetSector"/>
                        <create_position name="$XenonSpawnPosition" space="$MiningFleetSector" x="$YakiPiratePosition.x" y="$YakiPiratePosition.y - 5km" z="$YakiPiratePosition.z"/>

                        <run_actions ref="Spawn_Attack_Wave" result="$AttackWave">
                          <param name="AttackTarget"  value="$AttackTarget"/>
                          <param name="AdditionalTargetGroup" value="$MiningFleet"/>
                          <param name="Faction"       value="faction.xenon"/>
                          <param name="MissionCue"    value="$MissionCue"/>
                          <param name="Sector"        value="$MiningFleetSector"/>
                          <param name="ShipMacros"    value="[ [ macro.ship_xen_s_fighter_01_a_macro, 4 ],
                                                               [ macro.ship_xen_s_fighter_02_a_macro, 2 ],
                                                               [ macro.ship_xen_m_corvette_02_a_macro, 1 ] ]"/>
                          <param name="SpawnPosition" value="$XenonSpawnPosition"/>
                          <param name="AllowOtherTargets" value="true"/>
                        </run_actions>

                        <do_if value="$YakiPirate.isoperational">
                          <add_to_group groupname="$AttackWave" object="$YakiPirate"/>
                        </do_if>

                        <do_if value="$MiningFleetCommander.order.id == 'Attack'">
                          <edit_order_param order="$MiningFleetCommander.order" param="'secondarytargets'" value="$AttackWave"/>
                        </do_if>

                        <signal_cue cue="Ch14_2_Update_Objective"/>

                        <play_sound sound="'yaki_xenon_call'" object="player.entity"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch14_2_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$AttackWave" text="{30226,1021}" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch14_2_All_Attackers_Destroyed">
                      <conditions>
                        <event_object_destroyed group="$AttackWave"/>
                        <check_value value="$AttackWave.count == 1"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch14_3_Debriefing"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch14_3_Debriefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,1019}" object="$MiningFleetCommander" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch14_3_Mining_Fleet_Orders">
                  <actions>
                    <cancel_all_orders object="$MiningFleetCommander"/>
                    <create_order id="'Wait'" object="$MiningFleetCommander" default="true"/>
                  </actions>
                </cue>

                <cue name="Ch14_3_Mining_Leader_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$MiningLeaderActor"/>
                  <param name="CutsceneKey"       value="$MiningLeaderCutsceneKey"/>
                  <param name="DelayInitial"      value="5s"/>
                  <param name="Lines"             value="[[30226104],[30226105],[30226106]]"/>
                  <param name="EndSignalCue"      value="Ch14_3_Debriefing_Dialog_2"/>
                  <!--
                     Atreides:
                        (relieved)That was a close one.
                        (overacting)Now, friend, I don't know how to thank you.
                        (overacting)Had you not arrived at precisely the right moment, I don't know if we would have found the courage to stand up against that vile fiend.
                                                    -->
                </cue>

                <cue name="Ch14_3_Debriefing_Dialog_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$MiningSubordinateActor" priority="100">
                      <text line="30226102" comment="(worried)But, Captain Atreides..."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch14_3_Debriefing_Dialog_3">
                  <conditions>
                    <event_speak_finished actor="$MiningSubordinateActor" line="30226102"/>
                  </conditions>
                  <actions>
                    <speak actor="$MiningLeaderActor" priority="100">
                      <text line="30226107" comment="(stern)Reuven, please. Give our guest a moment to breathe."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch14_3_Debriefing_Dialog_Finished">
                  <conditions>
                    <event_speak_finished actor="$MiningLeaderActor" line="30226107"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <signal_cue cue="Ch14_Clean_Up_Yaki_Investigation_Mission_1"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch14_Clean_Up_Yaki_Investigation_Mission_1">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Cleaning up Yaki Investigation Mission 1.'" chance="$DebugChance"/>

                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.terran" title="{30226,1001}" text="{30226,1004}"/>

                <signal_cue cue="Ch15_Pioneers_Intro"/>
                <cancel_cue cue="Ch14_Rescue_Pioneers"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Mission 5 (Yaki Mission 2) -->

        <cue name="Ch15_Pioneers_Intro">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_mission cue="$MissionCue" name="{30226,2001}" description="{30226,2002}" rewardtext="{30226,2003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name">
              <briefing>
                <objective step="1" action="objective.collect" text="{30226,2010}"/>
              </briefing>
            </create_mission>
          </actions>
          <force name="Ch15_Force">
            <!-- This will produce an error, don't worry about it. -->
            <force_cue cue="Ch14_Setup_Ships"/>
            <set_value name="$YakiDeathSector" exact="$MiningFleetSector"/>
            <set_value name="$YakiDeathPosition" exact="$MiningFleetPosition"/>
          </force>
          <cues>

            <cue name="Ch15_Setup_Cargo">
              <actions>
                <create_object name="$YakiCrate2" macro="macro.sm_gen_wares_rare_01_macro" sector="$YakiDeathSector">
                  <safepos value="$YakiDeathPosition" min="300m" max="500m"/>
                </create_object>
                <add_cargo object="$YakiCrate2" ware="ware.inv_bionic_augmentation" exact="1"/>
                <add_to_group groupname="$YakiCrateGroup" object="$YakiCrate2"/>

                <create_object name="$YakiCrate3" macro="macro.sm_gen_wares_rare_01_macro" sector="$YakiDeathSector">
                  <safepos value="$YakiDeathPosition" min="300m" max="500m"/>
                </create_object>
                <add_cargo object="$YakiCrate3" ware="ware.inv_experimental_medicine" exact="1"/>
                <add_to_group groupname="$YakiCrateGroup" object="$YakiCrate3"/>

                <signal_cue cue="Ch15_1_Collect_Cargo"/>
              </actions>
            </cue>

            <cue name="Ch15_1_Collect_Cargo">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep"/>
              </actions>
              <cues>

                <cue name="Ch15_1_Mining_Leader_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$MiningLeaderActor"/>
                  <param name="CutsceneKey"       value="$MiningLeaderCutsceneKey"/>
                  <param name="DelayInitial"      value="3s"/>
                  <param name="Lines"             value="[[30226201],[30226202]]"/>
                  <param name="EndSignalCue"      value="Ch15_1_Update_Objective"/>
                  <!--
                              (stern)Maybe collecting the cargo that was scattered during this most heinous attack will help lift our spirits, yes?
                              Please, friend, give us a hand if you will.
                                                    -->
                </cue>

                <cue name="Ch15_1_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="Ch15_1_Crates_Killed.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.collect" text="{30226,2010}" group="$YakiCrateGroup" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch15_1_Crates_Killed">
                  <conditions>
                    <event_object_destroyed group="$YakiCrateGroup"/>
                    <check_value value="$YakiCrateGroup.count == 1"/>
                  </conditions>
                  <cues>

                    <cue name="Ch15_1_Mining_Leader_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$MiningLeaderActor"/>
                      <param name="CutsceneKey"       value="$MiningLeaderCutsceneKey"/>
                      <param name="Lines"             value="[[30226203],[30226204]]"/>
                      <param name="EndSignalCue"      value="Ch15_2_Follow_Miners"/>
                      <!--
                              Splendid! Please, friend, do accompany us on our journey. It is just a short hop.
                              Upon our arrival, I will arrange for you to be generously accommodated.
                                                    -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch15_2_Follow_Miners">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.follow" object="$MiningFleetCommander" text="{30226,2011}" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch15_2_Trigger_Station_Setup">
                  <actions>
                    <signal_cue cue="Setup_Conversation_Puzzle_Station"/>
                  </actions>
                </cue>

                <cue name="Ch15_2_Mining_Fleet_Orders">
                  <conditions>
                    <event_cue_completed cue="Setup_Conversation_Puzzle_Station"/>
                  </conditions>
                  <actions>
                    <cancel_all_orders object="$MiningFleetCommander"/>
                    <create_order id="'MoveToObject'" object="$MiningFleetCommander">
                      <param name="destination" value="$ConversationPuzzleStation"/>
                      <param name="noattackresponse" value="true"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch15_2_Mining_Leader_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$MiningLeaderActor, $BosoTa, $MiningLeaderActor, $BosoTa, $MiningLeaderActor]"/>
                  <param name="CutsceneKey"       value="[$MiningLeaderCutsceneKey, $BosoCutsceneKey, $MiningLeaderCutsceneKey, $BosoCutsceneKey, $MiningLeaderCutsceneKey]"/>
                  <param name="DelayInitial"      value="[45s, 0s, 0s, 0s, 0s]"/>
                  <param name="Lines"             value="[  [[30226205],[30226206],[30226207]],
                                                            [[30226201]],
                                                            [[30226208]],
                                                            [[30226202],[30226203]],
                                                            [[30226209]]  ]"/>
                  <param name="EndSignalCue"      value="[null, null, null, null, Ch15_2_Enable_Arrival_Check]"/>
                  <!--         
                      Atreides:
                        Say, friend, what leads you to this most remote of places?
                        Perhaps you heard of the famous Pioneers Initiative and couldn't help but want to see this most honourable endeavour for yourself?
                        I can proudly say that us Pioneers have dutifully expanded the reaches of Sol ever since our inception, and our glorious tale grows grander by the day!
                      Boso:
                        I must say that this operation is rather fascinating.
                      Atreides:
                        A Boron! How intriguing. You couldn't possibly be here because of the... planetary beautification program?
                      Boso:
                        Oh, indeed, I have a plethora of vivid ideas that I would very much like to...
                        (interrupting himself, pretending to be a secret agent)I mean, that information is classified... friend.
                      Atreides:
                        (deadpan, then jovial again)Right, too many ears. Well, I'm sure we'll have ample opportunity for a chat once we arrive at our destination, my dear friends.
                          -->
                </cue>

                <cue name="Ch15_2_Enable_Arrival_Check">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch15_2_Approach_MiningFleetDestinationStation_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="$MiningFleetCommander"/>
                      <param name="ApproachTarget"    value="$ConversationPuzzleStation"/>
                      <param name="ApproachDistance"  value="250km"/>
                      <param name="SuccessSignalCue"  value="Ch15_2_Mining_Fleet_Arrived_Dialog"/>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch15_2_Mining_Fleet_Arrived_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$MiningSubordinateActor" priority="100">
                      <text line="30226201" comment="(dutiful)Captain, we're approaching our base of operations."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch15_2_Mining_Fleet_Arrived_Dialog_Finished">
                  <conditions>
                    <event_speak_finished actor="$MiningSubordinateActor" line="30226201"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <signal_cue cue="Ch15_Clean_Up"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch15_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <cancel_all_orders object="$MiningFleetCommander"/>
                <create_order id="'DockAndWait'" object="$MiningFleetCommander">
                  <param name="destination" value="$ConversationPuzzleStation"/>
                </create_order>

                <signal_cue cue="Ch16_Conversation_Puzzle"/>
                <cancel_cue cue="Ch15_Pioneers_Intro"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch16_Conversation_Puzzle">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <update_mission cue="$MissionCue" comment="Collapse objectives.">
              <briefing replace="true">
                <objective step="1" action="objective.collect" text="{30226,2010}"/>
                <objective step="2" action="objective.follow" text="{30226,2011}"/>
              </briefing>
            </update_mission>
          </actions>
          <force name="Ch16_Force">
            <signal_cue cue="Setup_Conversation_Puzzle_Station"/>
            <create_mission cue="$MissionCue" name="{30226,2001}" description="{30226,2002}" rewardtext="{30226,2003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name"/>
          </force>
          <cues>

            <cue name="Ch16_Setup_Customs_Office" version="2">
              <actions>
                <!-- Determine interior macros and names. -->
                <get_room_definition macro="$OfficeCorridorMacro" doors="$OfficeDoors" race="$ConversationPuzzleStation.owner.primaryrace" tags="tag.corridor" />
                <set_value name="$OfficeRoomMacro" exact="macro.room_gen_managersoffice_01_macro"/>
                <set_value name="$OfficeInteriorName" exact="readtext.{20007}.{1091}" comment="Customs Office"/>
                <!-- Create persistent interior. -->
                <create_dynamic_interior roomname="$OfficeRoom" object="$ConversationPuzzleStation" name="$OfficeInteriorName" corridor="$OfficeCorridorMacro" room="$OfficeRoomMacro" corridorname="$OfficeCorridor" interiorname="$OfficeInterior" persistent="true"/>
                <!-- Find specific slot to place actor on. -->
                <find_npc_slot name="$PotentialOfficeSlots" excludefilled="false" object="$OfficeRoom" multiple="true"/>
                <do_for_each in="$PotentialOfficeSlots" name="$Slot">
                  <do_if value="$Slot.name == 'con_control01'">
                    <set_value name="$YakiCivilianSlot" exact="$Slot"/>
                  </do_if>
                </do_for_each>
                <!-- Slot failsafes. -->
                <do_if value="not $YakiCivilianSlot?">
                  <set_value name="$YakiCivilianSlot" exact="$PotentialOfficeSlots.random"/>
                </do_if>

                <!-- Place actor. -->
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $YakiCivilianActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $YakiCivilianSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                <signal_cue cue="Ch16_1_Register_Trade"/>
              </actions>
              <patch sinceversion="2">
                <do_if value="$OfficeRoomMacro != macro.room_gen_managersoffice_01_macro">

                  <!-- save old office values -->
                  <set_value name="$OfficeRoom_OLD"       exact="$OfficeRoom"/>
                  <set_value name="$OfficeRoomMacro_OLD"  exact="$OfficeRoomMacro"/>
                  <set_value name="$OfficeInterior_OLD"   exact="$OfficeInterior"/>
                  <set_value name="$YakiCivilianSlot_OLD" exact="$YakiCivilianSlot"/>
                  <remove_value name="$YakiCivilianSlot"/>

                  <!-- create new office -->
                  <set_value name="$OfficeRoomMacro" exact="macro.room_gen_managersoffice_01_macro"/>
                  <create_dynamic_interior roomname="$OfficeRoom" object="$ConversationPuzzleStation" name="$OfficeInteriorName" corridor="$OfficeCorridorMacro" room="$OfficeRoomMacro" corridorname="$OfficeCorridor" interiorname="$OfficeInterior" persistent="true"/>

                  <!-- cleanup old office -->
                  <run_actions ref="md.LIB_Generic.Cleanup_Mission_Interior_Call">
                    <param name="Object"      value="$ConversationPuzzleStation"/>
                    <param name="Interior"    value="$OfficeInterior_OLD"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>

                  <!-- place actors -->
                  <!-- Find specific slot to place actor on. -->
                  <find_npc_slot name="$PotentialOfficeSlots" excludefilled="false" object="$OfficeRoom" multiple="true"/>
                  <do_for_each in="$PotentialOfficeSlots" name="$Slot">
                    <do_if value="$Slot.name == 'con_control01'">
                      <set_value name="$YakiCivilianSlot" exact="$Slot"/>
                    </do_if>
                  </do_for_each>
                  <!-- Slot failsafes. -->
                  <do_if value="not $YakiCivilianSlot?">
                    <set_value name="$YakiCivilianSlot" exact="$PotentialOfficeSlots.random"/>
                  </do_if>

                  <!-- guidance -->

                  <!-- Ch16_3_Solve_Case - after this cue ch16 is complete -->
                  <do_if value="(cuestate.waiting == Ch17_Follow_Yaki_Civilian.state)
                            and (cuestate.complete == Ch16_3_Solve_Case.state)">
                    <create_position name="$GuidancePosition" space="$OfficeRoom" x="0m" y="1.8m" z="-6.6m"/>

                    <!-- Overwrite previous objective. -->
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,2015}" object="$OfficeRoom" offset="$GuidancePosition" text="{30226,103}" updatebriefing="true"/>

                    <!-- reset event listener to correct room -->
                    <do_if value="cuestate.waiting == Ch16_3_Customs_Office_Entered_Dialog.state">
                      <reset_cue cue="Ch16_3_Customs_Office_Entered_Dialog"/>
                    </do_if>
                  </do_if>

                  <!-- Place actor. -->
                  <do_if value="(Ch16_1_Disconnect_Yaki_Civilian.state == cuestate.waiting)
                             or (Ch16_1_Disconnect_Yaki_Civilian.state == cuestate.disabled)">
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $YakiCivilianActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $YakiCivilianSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </do_if>


                </do_if>
              </patch>
            </cue>

            <cue name="Ch16_Reward_SETA">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_speak_finished actor="$YakiCivilianActor" line="30226227"/>
                </check_any>
              </conditions>
              <delay exact="2s"/>
              <actions>
                <!-- If the player is missing a part for SETA, give it to them. -->
                <do_if value="not player.entity.inventory.{ware.inv_timewarp}.count">
                  <do_for_each in="[ware.inv_damagedsingularityengine, ware.inv_fluxcapacitor, ware.inv_programmablefieldarray]" name="$Ingredient">
                    <do_if value="not player.entity.inventory.{$Ingredient}.count">
                      <add_inventory entity="player.entity" ware="$Ingredient"/>
                      <show_notification text="[{1015,100}, '', $Ingredient.name]" sound="notification_achievement" comment="Item received" />
                      <set_value name="$SETA_Reward_Received"/>
                      <break/>
                    </do_if>
                  </do_for_each>
                </do_if>

                <!-- If the player already has SETA, or has the ingredients and simply didn't craft it yet, give them a random T2 mod. -->
                <do_if value="not $SETA_Reward_Received?">
                  <set_value name="$ModPartList" exact="[ [[ware.modpart_enginefuelinjector_t2, 1], [ware.modpart_extendedfuelcontainer, 3], [ware.modpart_nividiumoxide, 3]],
                                                          [[ware.modpart_shieldgeneratorcoil_t2, 1], [ware.modpart_tuningsoftware, 1]],
                                                          [[ware.modpart_shipnanoweave_t2, 1], [ware.modpart_nividiumcrystallite, 3]],
                                                          [[ware.modpart_weaponchamber_t2, 1], [ware.modpart_highenergycatalyst, 3], [ware.modpart_tuningsoftware, 1]] ].random"/>
                  <do_for_each in="$ModPartList" name="$CurrentModPart">
                    <add_inventory entity="player.entity" ware="$CurrentModPart.{1}" exact="$CurrentModPart.{2}"/>
                  </do_for_each>

                  <!-- Only show the notification for the "main" reward, to not spam too much. -->
                  <show_notification text="[{1015,100}, '', $ModPartList.{1}.{1}.name]" sound="notification_achievement" comment="Item received" />
                </do_if>
              </actions>
            </cue>

            <cue name="Ch16_Reward_Credits">
              <conditions>
                <event_speak_finished actor="$YakiCivilianActor" line="30226232"/>
              </conditions>
              <delay exact="2s"/>
              <actions>
                <reward_player money="225000Cr"/>
              </actions>
            </cue>

            <cue name="Ch16_1_Register_Trade">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="3"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$YakiCivilianActor" text="{30226,2012}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch16_1_Mining_Leader_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$MiningLeaderActor"/>
                  <param name="CutsceneKey"       value="$MiningLeaderCutsceneKey"/>
                  <param name="Lines"             value="[[30226210],[30226211]]"/>
                  <param name="EndSignalCue"      value="Ch16_1_Disconnect_Mining_Leader"/>
                  <!--
                              Capital! Well then, my friend, you go and take the cargo you helped us collect to the customs officer over yonder.
                              Don't worry, she'll catch on eventually, and you'll get your share.
                                                    -->
                </cue>

                <cue name="Ch16_1_Disconnect_Mining_Leader">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MiningLeaderActor, table[
                                                                                                                                  $requestercue = $MissionCue,
                                                                                                                                  $priority = 100,
                                                                                                                                  $location = 'disconnect',
                                                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                  </actions>
                </cue>

                <cue name="Ch16_1_Player_Docked_At_Station">
                  <conditions>
                    <event_object_docked_at container="$ConversationPuzzleStation"/>
                    <check_value value="event.param == player.ship"/>
                  </conditions>
                  <cues>

                    <cue name="Ch16_1_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226219]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                              This entire situation appears to be rather opaque. I do hope that this customs officer will be able to shed some light on what we just witnessed.
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch16_1_Yaki_Civilian_Conversation_Started">
                  <conditions>
                    <event_conversation_started actor="$YakiCivilianActor"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226222" comment="(very friendly)Yes? How can I help you?"/>

                    <add_player_choice text="{30226,2030}" section="section_customs_officer_intro" position="right"/>
                  </actions>
                </cue>

                <cue name="Ch16_1_Yaki_Civilian_Conversation_Section_Intro" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="section_customs_officer_intro"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="player.entity.inventory.{ware.inv_bionic_augmentation}.count">
                      <remove_inventory entity="player.entity" ware="ware.inv_bionic_augmentation" exact="1"/>
                    </do_if>
                    <do_if value="player.entity.inventory.{ware.inv_experimental_medicine}.count">
                      <remove_inventory entity="player.entity" ware="ware.inv_experimental_medicine" exact="1"/>
                    </do_if>
                    <do_if value="player.entity.inventory.{ware.inv_sealed_vacuum_tubes}.count">
                      <remove_inventory entity="player.entity" ware="ware.inv_sealed_vacuum_tubes" exact="1"/>
                    </do_if>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226223" comment="(eager)Ah, yes, I've been expecting another delivery. One shipment of Terran tech, unloaded and ready for sampling."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226224" comment="(thoughtful)A few of these crates are damaged. That's a bit troubling."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226225" comment="You wouldn't know anything about that, now, would you?"/>

                    <add_player_choice text="{30226,2031}" section="section_customs_officer_subtle" position="left"/>
                    <add_player_choice text="{30226,2032}" section="section_customs_officer_honest" position="right"/>
                  </actions>
                </cue>

                <cue name="Ch16_1_Yaki_Civilian_Conversation_Section_Subtle" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="section_customs_officer_subtle"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <set_value name="$Atreides_Overdid_It" comment="Changes the dialog with Atreides in the next chapter."/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226226" comment="(firmly)True, but you can't keep going overboard."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226227" comment="(empathetic)I know how much this operation means to all of you, but if Protectorate citizens keep getting hurt, that'll put us all in danger."/>
                    <!-- Reward SETA / mod automatically after a delay after line 30226227 so that it happens during line 30226228. -->
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226228" comment="(warmly)Here, take this as a token of thanks... and maybe tell Atreides to not overdo it."/>

                    <add_player_choice text="{30226,2033}" section="section_customs_officer_subtle_suspicious" position="left"/>
                    <add_player_choice text="{30226,2034}" section="section_customs_officer_subtle_followup" position="right"/>
                  </actions>
                </cue>

                <cue name="Ch16_1_Yaki_Civilian_Conversation_Section_Subtle_Suspicious" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="section_customs_officer_subtle_suspicious"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226232" comment="(nervous)Oh, I see you're not familiar with our customs procedures."/>
                    <!-- Reward credits automatically after a delay after line 30226232 so that it happens during line 30226233. -->
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226233" comment="(nervous)Don't worry about it. Here, take this as well. And you'll have to excuse me, but I'm quite busy."/>
                  </actions>
                </cue>

                <cue name="Ch16_1_Yaki_Civilian_Conversation_Section_Subtle_Followup" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="section_customs_officer_subtle_followup"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226234" comment="(relieved)Thank you. Finally someone who's reasonable."/>
                  </actions>
                </cue>

                <cue name="Ch16_1_Yaki_Civilian_Conversation_Section_Honest" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="section_customs_officer_honest"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226229" comment="(surprised)A Yaki... attack?"/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226230" comment="(nervous, starts by clearing her throat)Yes, of course. That's something we take very seriously. I will inform the local authorities right away."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226231" comment="(gathers herself)Please, deliver my thanks to Captain Atreides for his bravery."/>

                    <add_player_choice text="{30226,2035}" section="section_customs_officer_subtle_honest_followup" position="right"/>
                  </actions>
                </cue>

                <cue name="Ch16_1_Yaki_Civilian_Conversation_Section_Honest_Followup" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="section_customs_officer_subtle_honest_followup"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <signal_cue cue="Ch16_Reward_SETA" comment="Will give out the reward after a short delay."/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226233" comment="(nervous)Don't worry about it. Here, take this as well. And you'll have to excuse me, but I'm quite busy."/>
                  </actions>
                </cue>

                <cue name="Ch16_1_Yaki_Civilian_Conversation_Finished">
                  <conditions>
                    <event_conversation_finished actor="$YakiCivilianActor"/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,2013}" updatebriefing="true" insert="true"/>

                    <signal_cue cue="Ch16_Setup_Bar"/>
                  </actions>
                  <cues>

                    <cue name="Ch16_1_Boso_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="DelayInitial"      value="5s"/>
                      <param name="Lines"             value="[[30226220],[30226221]]"/>
                      <param name="EndSignalCue"      value="Ch16_2_Investigate_Pioneers"/>
                      <!--
                              (puzzled)I am afraid I was not quite able to follow. We may have to investigate further.
                              The denizens of the local recreation establishment will surely be able to elaborate. Trust me, assistant, for I have done my research on proper detective work.
                                                    -->
                    </cue>

                    <cue name="Ch16_1_Disconnect_Yaki_Civilian">
                      <conditions>
                        <event_object_changed_room object="player.entity" room="$BarRoom"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $YakiCivilianActor, table[
                                                                                                                                  $requestercue = $MissionCue,
                                                                                                                                  $priority = 100,
                                                                                                                                  $location = 'disconnect',
                                                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch16_Setup_Bar">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Determine interior macros and names. -->
                <get_room_definition macro="$BarCorridorMacro" doors="$BarDoors" race="$ConversationPuzzleStation.owner.primaryrace" tags="tag.corridor" />
                <get_room_definition macro="$BarRoomMacro" tags="tag.bar" />
                <set_value name="$BarInteriorName" exact="readtext.{20007}.{3111}" comment="Tempting Tunes"/>
                <!-- Create persistent interior. -->
                <create_dynamic_interior roomname="$BarRoom" object="$ConversationPuzzleStation" name="$BarInteriorName" corridor="$BarCorridorMacro" room="$BarRoomMacro" corridorname="$BarCorridor" interiorname="$BarInterior" persistent="true"/>
                <!-- Find specific slot to place actors on. -->
                <find_npc_slot name="$PotentialBarSlots" excludefilled="false" object="$BarRoom" multiple="true"/>
                <do_for_each in="$PotentialBarSlots" name="$Slot">
                  <do_if value="$Slot.name == 'con_npc_lean_rail00'">
                    <set_value name="$PioneersCivilianSlot_1" exact="$Slot"/>
                  </do_if>
                  <do_elseif value="$Slot.name == 'con_npc_lean_rail14'">
                    <set_value name="$PioneersCivilianSlot_2" exact="$Slot"/>
                  </do_elseif>
                  <do_elseif value="$Slot.name == 'con_npc_001'">
                    <set_value name="$MiningLeaderSlot" exact="$Slot"/>
                  </do_elseif>
                  <do_elseif value="$Slot.name == 'con_npc_lean_rail09'">
                    <set_value name="$MiningSubordinateSlot" exact="$Slot"/>
                  </do_elseif>
                </do_for_each>
                <!-- Slot failsafes. -->
                <do_if value="not $PioneersCivilianSlot_1?">
                  <set_value name="$PioneersCivilianSlot_1" exact="$PotentialBarSlots.random"/>
                  <remove_from_list name="$PotentialBarSlots" exact="$PioneersCivilianSlot_1"/>
                </do_if>
                <do_if value="not $PioneersCivilianSlot_2?">
                  <set_value name="$PioneersCivilianSlot_2" exact="$PotentialBarSlots.random"/>
                  <remove_from_list name="$PotentialBarSlots" exact="$PioneersCivilianSlot_2"/>
                </do_if>
                <do_if value="not $MiningLeaderSlot?">
                  <set_value name="$MiningLeaderSlot" exact="$PotentialBarSlots.random"/>
                  <remove_from_list name="$PotentialBarSlots" exact="$MiningLeaderSlot"/>
                </do_if>
                <do_if value="not $MiningSubordinateSlot?">
                  <set_value name="$MiningSubordinateSlot" exact="$PotentialBarSlots.random"/>
                  <remove_from_list name="$PotentialBarSlots" exact="$MiningSubordinateSlot"/>
                </do_if>

                <!-- Place pioneer civilian actors. The mining leader and his subordinate will move here later. -->
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $PioneersCivilianActor_1, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $PioneersCivilianSlot_1,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                <add_to_group groupname="$ConversationPuzzleActors" object="$PioneersCivilianActor_1"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $PioneersCivilianActor_2, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $PioneersCivilianSlot_2,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                <add_to_group groupname="$ConversationPuzzleActors" object="$PioneersCivilianActor_2"/>

                <!-- Mute bar music, because it's otherwise audible from the customs office, despite being on a different floor (overlap issue). -->
                <do_if value="player.entity.dynamicinterior != $BarRoom.dynamicinterior">
                  <debug_text text="'Setting bar music volume to 0 initially.'" chance="$DebugChance"/>
                  <set_object_sound_override object="$BarRoom" volume="0" type="ambient"/>
                </do_if>
                <do_else>
                  <debug_text text="'Setting bar music volume to 0.2 initially.'" chance="$DebugChance"/>
                  <set_object_sound_override object="$BarRoom" volume="0.2" type="ambient"/>
                </do_else>
              </actions>
              <cues>

                <cue name="Ch16_Adjust_Bar_Ambience" instantiate="true">
                  <conditions>
                    <event_object_changed_room object="player.entity"/>
                    <check_value value="$BarRoom"/>
                  </conditions>
                  <actions>
                    <do_if value="(event.param2.dynamicinterior != $BarRoom.dynamicinterior) and (event.param.dynamicinterior == $BarRoom.dynamicinterior)">
                      <debug_text text="'Player entered bar room dynamic interior. Resetting bar music volume to make it audible through the wall.'" chance="$DebugChance"/>
                      <clear_object_sound_override object="$BarRoom" type="ambient"/>
                    </do_if>
                    <do_if value="(event.param2.dynamicinterior == $BarRoom.dynamicinterior) and (event.param.dynamicinterior != $BarRoom.dynamicinterior)">
                      <debug_text text="'Player left bar room dynamic interior. Setting bar music volume to 0 because of potential space overlap.'" chance="$DebugChance"/>
                      <set_object_sound_override object="$BarRoom" volume="0" type="ambient"/>
                    </do_if>
                    <do_elseif value="event.param == $BarRoom">
                      <debug_text text="'Player entered bar. Setting bar music volume to 0.2.'" chance="$DebugChance"/>
                      <set_object_sound_override object="$BarRoom" volume="0.2" type="ambient"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == $BarRoom and event.param != $BarRoom">
                      <debug_text text="'Player left bar. Resetting bar music volume.'" chance="$DebugChance"/>
                      <clear_object_sound_override object="$BarRoom" type="ambient"/>
                    </do_elseif>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch16_Setup_Mining_Leader">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MiningLeaderActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $MiningLeaderSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                <add_to_group groupname="$ConversationPuzzleActors" object="$MiningLeaderActor"/>

                <!-- Update objective with newly arrived / added actors. -->
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" group="$ConversationPuzzleActors" customaction="{30226,2014}" updatebriefing="true" silent="true"/>
              </actions>
            </cue>

            <cue name="Ch16_Disconnect_Mining_Leader">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MiningLeaderActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Ch16_Setup_Mining_Subordinate">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MiningSubordinateActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $MiningSubordinateSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                <add_to_group groupname="$ConversationPuzzleActors" object="$MiningSubordinateActor"/>

                <!-- Update objective with newly arrived / added actors. -->
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" group="$ConversationPuzzleActors" customaction="{30226,2014}" updatebriefing="true" silent="true"/>
              </actions>
            </cue>

            <cue name="Ch16_Disconnect_Mining_Subordinate">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_speak_line_finished actor="$MiningSubordinateActor" line="30226209" comment="unreliable, but conversation has a failsafe"/>
                </check_any>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $MiningSubordinateActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Ch16_Disconnect_Pioneers_Civilian_Actor_2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $PioneersCivilianActor_2, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                <remove_from_group group="$ConversationPuzzleActors" object="$PioneersCivilianActor_2"/>
                <!-- Update objective without the actor who's about to leave and otherwise break the guidance. -->
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" group="$ConversationPuzzleActors" customaction="{30226,2014}" updatebriefing="true" silent="true"/>
              </actions>
            </cue>

            <cue name="Ch16_2_Investigate_Pioneers">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Overwrite previous objective. -->
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" group="$ConversationPuzzleActors" customaction="{30226,2014}" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch16_2_Pioneers_Civilian_1_Conversation_Section_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$PioneersCivilianActor_1"/>
                      <event_conversation_next_section actor="$PioneersCivilianActor_1" section="pio_civ_1_main"/>
                    </check_any>
                    <check_value value="Ch16_3_Solve_Case.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="Ch16_Setup_Mining_Leader.state == cuestate.waiting">
                      <signal_cue cue="Ch16_Setup_Mining_Leader"/>
                    </do_if>
                    <do_elseif value="Ch16_Setup_Mining_Subordinate.state == cuestate.waiting">
                      <signal_cue cue="Ch16_Setup_Mining_Subordinate"/>
                    </do_elseif>

                    <do_if value="event.name == 'event_conversation_started'">
                      <add_npc_line speaker="$PioneersCivilianActor_1" hidechoices="true" line="30226201" comment="Stars' light upon you."/>
                    </do_if>
                    <do_elseif value="event.param2 == 'basic'">
                      <set_value name="$Pio_Civ_1_Info_Available"/>
                      <add_npc_line speaker="$PioneersCivilianActor_1" hidechoices="true" line="30226203" comment="My people are spread far, and I consider it my holy duty to travel the Gate network and give spiritual guidance to those in need."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'fluff'">
                      <add_npc_line speaker="$PioneersCivilianActor_1" hidechoices="true" line="30226204" comment="One day, these Pioneers will perceive that their work is guided by the sacred geometry of the cosmos that shaped us all."/>
                      <add_npc_line speaker="$PioneersCivilianActor_1" hidechoices="true" line="30226205" comment="However, I have realised, with great regret, that not even my Paranid brethren among the scientific elite can spare the time for my counsel."/>
                      <add_npc_line speaker="$PioneersCivilianActor_1" hidechoices="true" line="30226206" comment="Truly a tragic display of hubris. I had no choice but to withdraw to this humble place, so that I may meditate, and resume my service among the lowest of the low."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'info'">
                      <set_value name="$Pio_Civ_1_Info_Received"/>
                      <add_npc_line speaker="$PioneersCivilianActor_1" hidechoices="true" line="30226207" comment="These people desperately need someone to teach them serenity and contentment. This area of the Gate network houses so many disparate peoples, so much potential for strife."/>
                      <add_npc_line speaker="$PioneersCivilianActor_1" hidechoices="true" line="30226208" comment="(sighs)And even on this station, there is scarcely a moment of peace. Not so long ago I observed a pilot with a terribly asymmetrical face storm through these serene halls, assailing innocent bystanders."/>
                      <add_npc_line speaker="$PioneersCivilianActor_1" hidechoices="true" line="30226209" comment="(pitiful)It would truly be a shame if this budding community were to wither in senseless conflict."/>
                    </do_elseif>

                    <add_player_choice text="{30226,2036}" section="pio_civ_1_main" choiceparam="'basic'" position="top_left"/>
                    <do_if value="$Pio_Civ_1_Info_Available?">
                      <add_player_choice text="{30226,2037}" section="pio_civ_1_main" choiceparam="'fluff'" position="left"/>
                      <add_player_choice text="{30226,2038}" section="pio_civ_1_main" choiceparam="'info'" position="top_right"/>
                    </do_if>

                    <add_player_choice text="{30226,2039}" section="g_cancel" position="bottom_right"/>
                  </actions>
                </cue>

                <cue name="Ch16_2_Pioneers_Civilian_1_Conversation_Finished" instantiate="true">
                  <conditions>
                    <event_conversation_finished actor="$PioneersCivilianActor_1"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$PioneersCivilianActor_1" priority="100">
                      <text line="30226202" comment="Good day to you."/>
                    </speak>
                  </actions>
                  <cues>

                    <cue name="Ch16_2_Pioneers_Civilian_1_Goodbye_Speak_Finished">
                      <conditions>
                        <event_speak_finished actor="$PioneersCivilianActor_1" line="30226202"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch16_2_Pioneers_Civilian_2_Conversation_Section_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$PioneersCivilianActor_2"/>
                      <event_conversation_next_section actor="$PioneersCivilianActor_2" section="pio_civ_2_main"/>
                    </check_any>
                    <check_value value="Ch16_3_Solve_Case.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="Ch16_Setup_Mining_Leader.state == cuestate.waiting">
                      <signal_cue cue="Ch16_Setup_Mining_Leader"/>
                    </do_if>
                    <do_elseif value="Ch16_Setup_Mining_Subordinate.state == cuestate.waiting">
                      <signal_cue cue="Ch16_Setup_Mining_Subordinate"/>
                    </do_elseif>

                    <do_if value="event.name == 'event_conversation_started'">
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226201" comment="Greetings, fellow Pioneer."/>
                    </do_if>
                    <do_elseif value="event.param2 == 'basic'">
                      <set_value name="$Pio_Civ_2_Basic_Asked"/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226203" comment="I am on a trade mission for the local branch of the Teladi Company."/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226204" comment="If things go well, I may soon call myself CEO of the Uguras Foundation, purveyor of progress and business partner of the Segaris Pioneers."/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226205" comment="Independence is truly one of the greatest catalysts for profit."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'fluff'">
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226206" comment="(scoffs)Everyone here is so secretive. It feels as if I am constantly walking on eggshells."/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226207" comment="That customs officer is the worst of the entire clutch. If you miss one small bit of the customs code and answer in the wrong fashion, you suddenly find yourself left outside and a deal short."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'info'">
                      <set_value name="$Pio_Civ_2_Bribe_Available"/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226208" comment="Have you heard that certain sensory impressions can trigger memories?"/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226209" comment="For me personally, it's the sight of my credit balance increasing."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'bribe'">
                      <transfer_money from="faction.player" to="player.conversationactor.owner" amount="ware.inv_securitydecryptionsystem.maxprice"/>
                      <set_value name="$Reuven_Confront_Prerequisite_1"/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226210" comment="A pleasure doing business with you. I can already feel it all coming rushing back to me."/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226211" comment="Now, I do vividly remember seeing a man, most likely an Argon, leaving the customs office in a hurry."/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226212" comment="As a Teladi, I can't really comment on such things, but one of his kind may indeed have described him as unseemly. His face bore strange markings, possibly from a war injury or a cheap surgery."/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226213" comment="That said, I was supposed to discuss a trade agreement today, and my appointment keeps getting postponed."/>
                      <add_npc_line speaker="$PioneersCivilianActor_2" hidechoices="true" line="30226214" comment="I've waited quite long enough. Farewell, generous patron."/>
                    </do_elseif>

                    <do_if value="not $Reuven_Confront_Prerequisite_1?" comment="After giving the player his bit of info, he leaves.">
                      <add_player_choice text="{30226,2040}" section="pio_civ_2_main" choiceparam="'basic'" position="top_left"/>
                      <do_if value="$Pio_Civ_2_Basic_Asked?">
                        <add_player_choice text="{30226,2041}" section="pio_civ_2_main" choiceparam="'fluff'" position="left"/>
                        <do_if value="$Pio_Civ_1_Info_Received? and not $Pio_Civ_2_Bribe_Available?">
                          <add_player_choice text="{30226,2042}" section="pio_civ_2_main" choiceparam="'info'" position="top_right"/>
                        </do_if>
                      </do_if>

                      <do_if value="$Pio_Civ_2_Bribe_Available?">
                        <set_value name="$BribeCost" exact="ware.inv_securitydecryptionsystem.maxprice"/>
                        <!-- In 0001.xml, this text reads: "Colour me intrigued. \(Pay: $CREDITS$ {1001,101}(Cr)\)" -->
                        <substitute_text text="$BribeText" source="{30226,2043}">
                          <replace string="'$CREDITS$'" with="$BribeCost.formatted.default"/>
                        </substitute_text>
                        <add_player_choice text="$BribeText" section="pio_civ_2_main" choiceparam="'bribe'" selectable="player.money ge $BribeCost" tooltip="if player.money ge $BribeCost then '' else {30226,2070}" position="top_right"/>
                      </do_if>

                      <add_player_choice text="{30226,2044}" section="g_cancel" position="bottom_right"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch16_2_Pioneers_Civilian_2_Conversation_Finished" instantiate="true">
                  <conditions>
                    <event_conversation_finished actor="$PioneersCivilianActor_2"/>
                  </conditions>
                  <actions>
                    <do_if value="not $Reuven_Confront_Prerequisite_1?">
                      <speak actor="$PioneersCivilianActor_2" priority="100">
                        <text line="30226202" comment="Profits to you."/>
                      </speak>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch16_Disconnect_Pioneers_Civilian_Actor_2"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch16_2_Mining_Leader_Conversation_Section_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$MiningLeaderActor"/>
                      <event_conversation_next_section actor="$MiningLeaderActor" section="mining_leader_main"/>
                    </check_any>
                    <check_value value="Ch16_3_Solve_Case.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="event.name == 'event_conversation_started'">
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226212" comment="(boastful)Hello there, pilot."/>
                    </do_if>
                    <do_elseif value="event.param2 == 'basic'">
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226214" comment="(boastful)End up here? I was with the Pioneers from the very start! Well, almost."/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226215" comment="Mining rights were difficult to come by back in those days, and if you're just some odd-jobber on the edges of Sol, the well-oiled machine of the Terran Protectorate economy treats you like space dust."/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226216" comment="No offence, by the way. Don't know if you're affiliated, but you did meet up with us coming from that direction."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'overdo'">
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226217" comment="(indignant; interrupts himself)Does she now? Gah! The gall of that woman! She's the one who got us into that situation in the first place!"/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226218" comment="(frustrated)Oh, I'll tell her a story all right, when I next meet her."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'overdo_followup'">
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226219" comment="(sputtering)Uh, nothing in particular. You know, the usual dangers of long-distance hauling... I mean, mining."/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226220" comment="(confident again)Don't concern yourself with that. Right now, all is well, and you're our honoured guest."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'bravery'">
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226221" comment="(sputtering)She did what? Ah, yes, of course! The bravery!"/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226222" comment="(gathers himself, boastful again)And when those Xenon started pouring in, and we just blasted them out of the sky? That was glorious, wasn't it?"/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226223" comment="(boastful)Couldn't have done it without you, friend."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'messed_up'">
                      <set_value name="$Atreides_Confront_Available"/>
                      <set_value name="$Reuven_Confront_Prerequisite_2"/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226224" comment="(scoffs)And she told you that? You two must be getting rather close already."/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226225" comment="(sighs)Look, I'm not saying she's wrong. I know I jumped the gun. Might have endangered the entire operation."/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226226" comment="(embarrassed)I'm sorry I misjudged you. I simply saw a ship I didn't know, arriving at that crucial moment, and tried my best to keep up appearances."/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226227" comment="(somber)But I know that doesn't change anything. I... should maybe just stay away from Shani for a while. A very long while."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'confront'">
                      <set_value name="$Atreides_Confronted"/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226228" comment="(shocked)No! I'm innocent, I swear!"/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226229" comment="(grasping at straws)That customs officer has been in cahoots with those pirates this entire time! I wouldn't be surprised if she was a Yaki herself!"/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226209" comment="(disgusted)You disgust me, Atreides. We made a promise."/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226230" lookat="$MiningSubordinateActor" comment="(shouting after someone who's walking away)I'm only telling the truth, Reuven! I keep telling you that we can't stand up to the Protectorate!"/>
                      <add_npc_line speaker="$MiningLeaderActor" hidechoices="true" line="30226231" lookat="player.entity" comment="(pleading)Please don't tell your superiors. Apprehend that customs officer, and this entire mess will be cleaned up, I promise!"/>
                    </do_elseif>

                    <do_if value="event.param2 == 'confront'">
                      <debug_text text="'Atreides confronted. Puzzle solved. Conversation ends automatically.'" chance="$DebugChance"/>
                    </do_if>
                    <do_else>
                      <do_if value="event.param2 == 'overdo'">
                        <add_player_choice text="{30226,2047}" section="mining_leader_main" choiceparam="'overdo_followup'" position="left"/>
                      </do_if>
                      <do_else>
                        <add_player_choice text="{30226,2045}" section="mining_leader_main" choiceparam="'basic'" position="top_left"/>

                        <do_if value="$Atreides_Overdid_It?">
                          <add_player_choice text="{30226,2046}" section="mining_leader_main" choiceparam="'overdo'" position="left"/>
                        </do_if>
                        <do_else>
                          <add_player_choice text="{30226,2048}" section="mining_leader_main" choiceparam="'bravery'" position="left"/>
                        </do_else>

                        <do_if value="$Atreides_Messed_Up?">
                          <add_player_choice text="{30226,2049}" section="mining_leader_main" choiceparam="'messed_up'" position="bottom_left"/>
                        </do_if>

                        <do_if value="$Atreides_Confront_Available?">
                          <add_player_choice text="{30226,2054}" section="mining_leader_main" choiceparam="'confront'" position="top_right"/>
                        </do_if>

                        <add_player_choice text="{30226,2050}" section="g_cancel" position="bottom_right"/>
                      </do_else>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch16_2_Mining_Leader_Conversation_Finished" instantiate="true">
                  <conditions>
                    <event_conversation_finished actor="$MiningLeaderActor"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <do_if value="$Atreides_Confronted?">
                      <speak actor="$MiningLeaderActor" priority="100">
                        <text line="30226232" comment="(shouting)Damn it. Reuven, wait!"/>
                      </speak>
                      <signal_cue cue="Ch16_Disconnect_Mining_Leader"/>
                      <signal_cue cue="Ch16_Disconnect_Mining_Subordinate" check="false"/>
                      <signal_cue cue="Ch16_3_Solve_Case"/>
                    </do_if>
                    <do_else>
                      <speak actor="$MiningLeaderActor" priority="100">
                        <text line="30226213" comment="(magnanimously)Enjoy your stay."/>
                      </speak>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Ch16_2_Mining_Leader_Conversation_Goodbye_Speak_Finished">
                      <conditions>
                        <check_any>
                          <event_speak_finished actor="$MiningLeaderActor" line="30226232"/>
                          <event_speak_finished actor="$MiningLeaderActor" line="30226213"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch16_2_Mining_Subordinate_Conversation_Section_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$MiningSubordinateActor"/>
                      <event_conversation_next_section actor="$MiningSubordinateActor" section="mining_subordinate_main"/>
                    </check_any>
                    <check_value value="Ch16_3_Solve_Case.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="event.name == 'event_conversation_started'">
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226202" comment="(hesitant)Hello there."/>
                    </do_if>
                    <do_elseif value="event.param2 == 'basic'">
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226203" comment="(relieved)Oh, I'm just working for the captain over there. "/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226204" comment="(hesitant to talk about pirates)It's a well-paying job, all things considered. Especially with all the... pirate attacks recently."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'intime'">
                      <set_value name="$Atreides_Messed_Up"/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226205" comment="(hesitant)Yeah, about that..."/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226206" comment="(firmly)You do realise that we're professionals, right? That we've probably dealt with pirates in the past?"/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226207" comment="(frustrated)That situation could have gone a lot worse. But it also could have gone a whole lot better if we'd made even the slightest effort to de-escalate."/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226208" comment="(more friendly)Look, I'm glad you came to help us out, but next time, try to read the situation first. Should probably tell that to the captain, too."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'confront'">
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226210" comment="(defiantly)Yeah? What makes you think that?"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'confront_followup'">
                      <set_value name="$Reuven_Opened_Up"/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226211" comment="(whispers urgently)OK, OK, calm down. Please don't make any rash decisions."/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226212" comment="We're not criminals, all right? We're the neglected stepchild of the Terran Protectorate, and we've got to make ends meet somehow."/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226213" comment="Sometimes, one of those Yaki needs something from us, and we need something from them. We didn't expect it to turn sour this suddenly."/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226214" comment="Please don't make a fuss. I'll tell you what you want to know."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'trade'">
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226215" comment="Hah, that sort of knowledge is way above my pay grade. I only know that it has something to do with all those new research programs that have sprung up in these parts."/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226216" comment="Apparently, our scientists are constantly hitting a wall, and those Yaki just so happen to sometimes have the solution... in exchange for high tech components, for the most part."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'meet'">
                      <set_value name="$Reuven_Confronted"/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226217" comment="(scoffs)Well, good luck with that."/>
                      <add_npc_line speaker="$MiningSubordinateActor" hidechoices="true" line="30226218" comment="(deliberating, then warningly)Tamatha might know, but be gentle with her. She's just lost someone, and I imagine she's too worked up to sit through one of your interrogations."/>
                    </do_elseif>

                    <do_if value="not $Reuven_Confronted?" comment="The conversation ends automatically, if this is set.">
                      <do_if value="event.param2 == 'confront'">
                        <add_player_choice text="{30226,2056}" section="mining_subordinate_main" choiceparam="'confront_followup'" position="left"/>
                      </do_if>
                      <do_else>
                        <add_player_choice text="{30226,2051}" section="mining_subordinate_main" choiceparam="'basic'" position="top_left"/>
                        <add_player_choice text="{30226,2052}" section="mining_subordinate_main" choiceparam="'intime'" position="left"/>

                        <do_if value="$Reuven_Opened_Up?">
                          <add_player_choice text="{30226,2057}" section="mining_subordinate_main" choiceparam="'trade'" position="top_right"/>
                          <add_player_choice text="{30226,2058}" section="mining_subordinate_main" choiceparam="'meet'" position="right" highlighted="true"/>
                        </do_if>
                        <do_elseif value="$Reuven_Confront_Prerequisite_1? and $Reuven_Confront_Prerequisite_2?">
                          <add_player_choice text="{30226,2055}" section="mining_subordinate_main" choiceparam="'confront'" position="bottom_left"/>
                        </do_elseif>

                        <add_player_choice text="{30226,2053}" section="g_cancel" position="bottom_right"/>
                      </do_else>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch16_2_Mining_Subordinate_Conversation_Finished" instantiate="true">
                  <conditions>
                    <event_conversation_finished actor="$MiningSubordinateActor"/>
                  </conditions>
                  <actions>
                    <!-- We don't have a "goodbye" voice line for her. -->
                    <do_if value="$Reuven_Confronted?">
                      <signal_cue cue="Ch16_Disconnect_Mining_Subordinate"/>
                      <signal_cue cue="Ch16_Disconnect_Mining_Leader"/>
                      <signal_cue cue="Ch16_3_Solve_Case"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch16_2_Clues_Gathered_Check" instantiate="true">
                  <conditions>
                    <event_conversation_finished/>
                    <check_value value="$Reuven_Confront_Prerequisite_1? and $Reuven_Confront_Prerequisite_2?"/>
                    <check_value value="Ch16_3_Solve_Case.state == cuestate.waiting"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <!-- Give other cues that are listening for event_conversation_finished the chance to wrap up this part of the mission before giving a hint. -->
                    <do_if value="(Ch16_3_Solve_Case.state == cuestate.waiting) and not player.isinconversation">
                      <signal_cue cue="Ch16_2_Clues_Gathered"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch16_2_Clues_Gathered">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch16_2_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226222]]"/>
                      <param name="EndSignalCue"      value="Ch16_2_Update_Objective"/>
                      <!--
                              That should do it! I believe we have enough clues to find our Yaki connection.
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch16_2_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <remove_from_group group="$ConversationPuzzleActors" object="$PioneersCivilianActor_1"/>

                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,2015}" group="$ConversationPuzzleActors" text="{30226,2016}" insert="true" updatebriefing="true"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch16_3_Solve_Case">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_position name="$GuidancePosition" space="$OfficeRoom" x="0m" y="1.8m" z="-6.6m"/>

                <!-- Overwrite previous objective. -->
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,2015}" object="$OfficeRoom" offset="$GuidancePosition" text="{30226,103}" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch16_3_Confront_Suspect_Dialog">
                  <actions>
                    <do_if value="$Atreides_Confronted?">
                      <set_value name="$BosoLines" exact="[[30226223],[30226224]]"/>
                    </do_if>
                    <do_else>
                      <set_value name="$BosoLines" exact="[[30226224]]"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Ch16_3_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="DelayInitial"      value="2s"/>
                      <param name="Lines"             value="$BosoLines"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                              Praise miscommunication, as our new Paranid friend might say.
                              Onward! I have marked the customs office for you.
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch16_3_Customs_Office_Entered_Dialog">
                  <conditions>
                    <event_object_changed_room object="player.entity" room="$OfficeRoom"/>
                  </conditions>
                  <cues>

                    <cue name="Ch16_3_Boso_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226225],[30226204]]"/>
                      <param name="EndSignalCue"      value="Ch16_Clean_Up"/>
                      <!--
                              Oh no! The tadpole has jumped the pond!(the person has left)
                              Hurry up, assistant! Our investigation demands the utmost haste!
                                                    -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch16_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <signal_cue cue="Ch17_Follow_Yaki_Civilian"/>
                <cancel_cue cue="Ch16_Conversation_Puzzle"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch17_Follow_Yaki_Civilian">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <update_mission cue="$MissionCue" comment="Collapse objectives.">
              <briefing replace="true">
                <objective step="1" action="objective.collect" text="{30226,2010}"/>
                <objective step="2" action="objective.follow" text="{30226,2011}"/>
                <objective step="3" action="objective.custom" customaction="{30226,2014}"/>
                <objective step="4" action="objective.follow" text="{30226,103}"/>
                <objective step="5" action="objective.find" text="{30226,2018}"/>
              </briefing>
            </update_mission>
          </actions>
          <force name="Ch17_Force">
            <force_cue cue="Ch15_2_Setup_Destination_Station"/>
          </force>
          <cues>

            <cue name="Ch17_Setup_Asteroid_Base" version="2">
              <actions>
                <get_safe_pos result="$AsteroidBasePosition" sector="$ConversationPuzzleSector" object="$ConversationPuzzleStation" min="40km" max="50km" allowyaxis="false"/>
                <!--<create_position name="$AsteroidBasePosition" space="$ConversationPuzzleSector" object="$ConversationPuzzleStation" min="30km" max="50km"/>-->
                <create_position name="$AsteroidBasePosition" space="$ConversationPuzzleSector" x="$AsteroidBasePosition.x" y="-30km" z="$AsteroidBasePosition.z"/>
                <!--<set_value name="$AsteroidBasePosition" exact="position.[$AsteroidBasePosition.x, -30km, $AsteroidBasePosition.z]" comment="Always spawn the station at a fixed distance below the ecliptic."/>-->
                <create_object macro="macro.xenon_asteroid_01_base_01_story_macro" name="$AsteroidBase" sector="$ConversationPuzzleSector" owner="faction.ownerless">
                  <safepos value="$AsteroidBasePosition"/>
                </create_object>

                <!-- On second thought, let's not place mines around the asteroid. T'is a silly idea. -->
                <!--<do_all exact="75">
                  <create_object groupname="$AsteroidBaseMines" macro="macro.weapon_gen_mine_01_macro" sector="$ConversationPuzzleSector" owner="faction.yaki">
                    <safepos max="5km" object="$AsteroidBase"/>
                  </create_object>
                </do_all>-->

                <!--<do_all exact="20">
                  <set_value name="$RandomPitch" min="0deg" max="360deg"/>
                  <set_value name="$RandomRoll" min="0deg" max="360deg"/>
                  <create_object name="$XenonAsteroidTurret" macro="macro.asteroid_turret_m_01_macro" sector="$ConversationPuzzleSector" owner="faction.xenon">
                    <safepos object="$AsteroidBase"/>
                    <rotation pitch="$RandomPitch" roll="$RandomRoll"/>
                  </create_object>
                  <signal_objects object="player.galaxy" param="'init station'" param2="$XenonAsteroidTurret" param3="false" comment="Add control entities."/>
                </do_all>-->

                <create_position name="$ActualAsteroidBasePosition" space="$ConversationPuzzleSector" object="$AsteroidBase"/>

                <create_position name="$AsteroidBaseSkipPosition" space="$ConversationPuzzleSector" object="$AsteroidBase" x="1977.029175m" y="-463.173828m" z="271.982422m"/>

                <set_object_min_hull object="$AsteroidBase" exact="100"/>

                <!-- Place hazards inside. -->
                <set_value name="$InteriorTowerPositions" exact="[position.[1538.842285m, -191.023438m, 434.175781m],
                                                                  position.[1547.915283m, -324.421875m, 434.146484m]
                                                                  ]"/>

                <set_value name="$InteriorMinePositions" exact="[position.[1149.769531m, -200.574219m, -539.146484m],
                                                                 position.[1179.157715m, -210.902344m, -545.820313m],
                                                                 position.[1150.713135m, -209.218750m, -537.597656m],
                                                                 
                                                                 position.[1186.695313m, -257.595703m, -294.972656m],
                                                                 position.[1146.648438m, -281.015625m, -293.093750m],
                                                                 position.[1179.781250m, -300.320313m, -291.878906m],
                                                                 position.[1141.746094m, -329.468750m, -289.601563m],
                                                                 position.[1184.691406m, -351.263672m, -288.257813m],
                                                                 
                                                                 position.[1188.867188m, -260.060547m, -53.535156m],
                                                                 position.[1158.199219m, -239.568359m, -52.273438m],
                                                                 position.[1183.667969m, -215.667969m, -52.601563m],
                                                                 position.[1155.343750m, -190.439453m, -51.328125m],
                                                                 
                                                                 position.[1138.921875m, -234.226563m, 191.585938m],
                                                                 position.[1165.679688m, -240.904297m, 191.960938m],
                                                                 position.[1190.402344m, -255.759766m, 191.457031m],
                                                                 position.[1151.425781m, -253.875000m, 190.144531m],
                                                                 position.[1171.214844m, -273.445313m, 188.992188m],
                                                                 position.[1185.511719m, -298.871094m, 187.054688m],
                                                                 position.[1155.636719m, -298.412109m, 185.949219m],
                                                                 position.[1170.710938m, -330.201172m, 183.421875m],
                                                                 position.[1184.230469m, -353.568359m, 181.656250m],
                                                                 position.[1155.230469m, -357.509766m, 180.156250m],
                                                                 
                                                                 position.[1162.296875m, -288.804688m, 354.648438m],
                                                                 position.[1179.324219m, -274.015625m, 360.609375m],
                                                                 position.[1140.187500m, -273.753906m, 365.644531m],
                                                                 position.[1173.351563m, -262.667969m, 363.769531m],
                                                                 position.[1191.707031m, -248.343750m, 362.535156m],
                                                                 position.[1165.449219m, -248.326172m, 363.808594m],
                                                                 position.[1149.257813m, -219.419922m, 363.898438m],
                                                                 position.[1175.121094m, -213.857422m, 362.507813m],
                                                                 position.[1206.347656m, -200.552734m, 360.675781m]
                                                                ]"/>

                <do_for_each in="$InteriorTowerPositions" name="$Pos">
                  <create_ship groupname="$InteriorTowers" name="$InteriorTower" macro="macro.ship_gen_xs_lasertower_01_a_macro" sector="$ConversationPuzzleSector" missioncue="namespace">
                    <owner exact="faction.civilian" overridenpc="true"/>
                    <pilot>
                      <select race="race.drone" tags="tag.aipilot"/>
                    </pilot>
                    <position object="$AsteroidBase" value="$Pos"/>
                  </create_ship>
                  <set_ship_safepos_allowed ship="$InteriorTower" allow="false"/>
                </do_for_each>

                <do_for_each in="$InteriorMinePositions" name="$Pos">
                  <create_object name="$InteriorMine" macro="macro.weapon_gen_mine_02_story_macro" sector="$ConversationPuzzleSector" owner="faction.xenon">
                    <position object="$AsteroidBase" value="$Pos"/>
                  </create_object>
                </do_for_each>

                <signal_cue cue="Ch17_Setup_Yaki_Civilian_Ship"/>
              </actions>
              <patch sinceversion="2" state="complete">
                <do_for_each in="$InteriorTowers" name="$InteriorTower">
                  <set_ship_safepos_allowed ship="$InteriorTower" allow="false"/>
                </do_for_each>
              </patch>
              <patch sinceversion="2" state="cancelled">
                <do_for_each in="$InteriorTowers" name="$InteriorTower">
                  <set_ship_safepos_allowed ship="$InteriorTower" allow="false"/>
                </do_for_each>
              </patch>
              <cues>

                <cue name="DEBUG_Spawn_Mines" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$InteriorMinePositions" exact="[position.[1149.769531m, -200.574219m, -539.146484m],
                                                                 position.[1179.157715m, -210.902344m, -545.820313m],
                                                                 position.[1150.713135m, -209.218750m, -537.597656m],
                                                                 
                                                                 position.[1186.695313m, -257.595703m, -294.972656m],
                                                                 position.[1146.648438m, -281.015625m, -293.093750m],
                                                                 position.[1179.781250m, -300.320313m, -291.878906m],
                                                                 position.[1141.746094m, -329.468750m, -289.601563m],
                                                                 position.[1184.691406m, -351.263672m, -288.257813m],
                                                                 
                                                                 position.[1188.867188m, -260.060547m, -53.535156m],
                                                                 position.[1158.199219m, -239.568359m, -52.273438m],
                                                                 position.[1183.667969m, -215.667969m, -52.601563m],
                                                                 position.[1155.343750m, -190.439453m, -51.328125m],
                                                                 
                                                                 position.[1138.921875m, -234.226563m, 191.585938m],
                                                                 position.[1165.679688m, -240.904297m, 191.960938m],
                                                                 position.[1190.402344m, -255.759766m, 191.457031m],
                                                                 position.[1151.425781m, -253.875000m, 190.144531m],
                                                                 position.[1171.214844m, -273.445313m, 188.992188m],
                                                                 position.[1185.511719m, -298.871094m, 187.054688m],
                                                                 position.[1155.636719m, -298.412109m, 185.949219m],
                                                                 position.[1170.710938m, -330.201172m, 183.421875m],
                                                                 position.[1184.230469m, -353.568359m, 181.656250m],
                                                                 position.[1155.230469m, -357.509766m, 180.156250m],
                                                                 
                                                                 position.[1162.296875m, -288.804688m, 354.648438m],
                                                                 position.[1179.324219m, -274.015625m, 360.609375m],
                                                                 position.[1140.187500m, -273.753906m, 365.644531m],
                                                                 position.[1173.351563m, -262.667969m, 363.769531m],
                                                                 position.[1191.707031m, -248.343750m, 362.535156m],
                                                                 position.[1165.449219m, -248.326172m, 363.808594m],
                                                                 position.[1149.257813m, -219.419922m, 363.898438m],
                                                                 position.[1175.121094m, -213.857422m, 362.507813m],
                                                                 position.[1206.347656m, -200.552734m, 360.675781m]
                                                                ]"/>

                    <do_for_each in="$InteriorMinePositions" name="$Pos">
                      <create_object name="$InteriorMine" macro="macro.weapon_gen_mine_02_story_macro" sector="$ConversationPuzzleSector" owner="faction.xenon">
                        <position object="$AsteroidBase" value="$Pos"/>
                      </create_object>
                    </do_for_each>
                  </actions>
                </cue>

                <cue name="Ch17_1_Approach_AsteroidBaseSkipPosition_1_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                  <param name="ApproachSector"    value="$ConversationPuzzleSector"/>
                  <param name="ApproachOffset"    value="$AsteroidBaseSkipPosition"/>
                  <param name="ApproachDistance"  value="250m"/>
                  <param name="SuccessSignalCue"  value="Ch17_Asteroid_Base_Skip"/>
                </cue>

                <cue name="Ch17_Asteroid_Base_Skip_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="Ch17_3_Optional_Fight.state == cuestate.waiting"/>
                    <check_value value="Ch17_Clean_Up.state == cuestate.waiting"/>
                  </conditions>
                  <cues>

                    <cue name="Ch17_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226212]]"/>
                      <param name="EndSignalCue"      value="Ch17_Asteroid_Base_Skip"/>
                      <!--
                              Such ingenuity! Assistant, you have outdone yourself!
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch17_Asteroid_Base_Skip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch17_Clean_Up"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch17_Setup_Yaki_Civilian_Ship">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- TODO: Why does the ship spawns rotated away from the ref object? -->
                <create_position name="$YakiCivilianWaitPosition" space="$ConversationPuzzleSector" object="$AsteroidBase" x="350m" y="1230m" z="2800m"/>

                <!--<find_object_component name="$ConversationPuzzleStationInternalDock" object="$ConversationPuzzleStation" checkoperational="true" multiple="false">
                  <match_dock storage="true" size="macro.ship_ter_s_fighter_01_a_macro.docksize"/>
                </find_object_component>-->
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $YakiCivilianActor, $MissionCue]" comment="Remove earlier 'disconnect' request, or the actor will disappear from the pilot seat."/>

                <create_ship name="$YakiCivilianShip" macro="macro.ship_ter_s_scout_01_a_macro" capturable="false" missioncue="namespace" sector="$ConversationPuzzleSector">
                  <pilot actor="$YakiCivilianActor"/>
                  <owner exact="faction.pioneers" overridenpc="true"/>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <equipmentmods>
                    <engine ware="ware.mod_engine_forwardthrust_01_mk2"/>
                    <shield ware="ware.mod_shield_capacity_01_mk2"/>
                    <ship ware="ware.mod_ship_mass_01_mk2"/>
                  </equipmentmods>
                  <!-- Paint mod: Azureous Utopia (Pioneers Camo 1) -->
                  <paint ware="ware.paintmod_0121"/>
                  <orientation refobject="$ConversationPuzzleStation" orientation="look_at"/>
                  <position value="$YakiCivilianWaitPosition"/>
                </create_ship>
                <set_object_name object="$YakiCivilianShip" page="30226" line="207" comment="Ellipsis Trouble"/>
                <!--<set_drop_object object="$YakiCivilianShip" drop="'drops_yakistory_asteroidbasekey_1'"/>-->
                <set_object_docking_enabled object="$YakiCivilianShip" enabled="false"/>
                <set_object_min_hull object="$YakiCivilianShip" exact="100"/>
                <set_object_min_shield object="$YakiCivilianShip" exact="100"/>

                <create_order id="'Wait'" object="$YakiCivilianShip" default="true">
                  <param name="noattackresponse" value="true"/>
                </create_order>

                <!-- Pilot is invisible for some reason. -->
                <set_entity_traits entity="$YakiCivilianActor" hidden="false"/>

                <signal_cue cue="Ch17_1_Follow"/>
              </actions>
            </cue>

            <cue name="DEBUG_Check_YakiCivilianShip_Pilot" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="$YakiCivilianShip.pilot.knownname"/>
              </actions>
            </cue>

            <cue name="Ch17_Remove_Interiors">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Remove interiors created in Ch16 and make station vulnerable. -->
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $PioneersCivilianActor_1, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $PioneersCivilianActor_2, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                <remove_dynamic_interior object="$ConversationPuzzleStation" corridor="$OfficeCorridorMacro" room="$OfficeRoomMacro" interior="$OfficeInterior"/>
                <remove_dynamic_interior object="$ConversationPuzzleStation" corridor="$BarCorridorMacro" room="$BarRoomMacro" interior="$BarInterior"/>
                <set_object_min_hull object="$ConversationPuzzleStation" exact="0"/>
              </actions>
            </cue>

            <cue name="Ch17_1_Follow">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="4"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.follow" object="$YakiCivilianShip" text="{30226,103}" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch17_1_Approach_YakiCivilianShip_1_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$YakiCivilianShip"/>
                  <param name="ApproachDistance"  value="35km"/>
                  <param name="SuccessSignalCue"  value="Ch17_1_Approach_Far_Boso_Speak"/>
                </cue>

                <cue name="Ch17_1_Approach_Far_Boso_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch17_1_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226205],[30226226],[30226206]]"/>
                      <param name="EndSignalCue"      value="Ch17_1_Activate_Closer_Approach_Check"/>
                      <!--
                              That asteroid does look peculiarly inhabited... or abandoned? Hmm, it might just be the poor quality of your camera's resolution, but I do advise caution.
                              <t id="30226226">And there's the customs officer again.</t>
                              (whispers to the player; speak as if "the clue" is something incredibly mysterious)Do not spook her! We still have to find... the clue.
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch17_1_Activate_Closer_Approach_Check">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch17_1_Approach_YakiCivilianShip_2_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$YakiCivilianShip"/>
                      <param name="ApproachDistance"  value="12km"/>
                      <param name="SuccessSignalCue"  value="Ch17_1_Approach_Close_Boso_Speak"/>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch17_1_Approach_Close_Boso_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <play_music music="'music_dlc_terran_story_yaki_1'"/>

                    <do_if value="$Atreides_Confronted?">
                      <set_value name="$BosoLines" exact="[[30226228]]"/>
                    </do_if>
                    <do_else>
                      <set_value name="$BosoLines" exact="[[30226227]]"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Ch17_1_Tamatha_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$YakiCivilianActor, $BosoTa]"/>
                      <param name="CutsceneKey"       value="[$YakiCivilianCutsceneKey, $BosoCutsceneKey]"/>
                      <param name="Lines"             value="[  [[30226201]], $BosoLines  ]"/>
                      <param name="EndSignalCue"      value="[null, Ch17_2_Persuade]"/>
                      <!--         
                      Tamatha:
                        (trembling)You! Stop right there!
                      Boso:
                        <t id="30226227">(variant 1)It appears that we involuntarily created somewhat of a tragedy for her. A careful emotional push might convince her to spill the bofu.</t>
                        <t id="30226228">(variant 2)Judging by previous reactions to your rather forceful negotiation tactics, a certain amount of pressure will likely cause her to yield.</t>
                          -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch17_2_Persuade">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <do_if value="$Atreides_Confronted?">
                  <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,2015}" text="{30226,103}" object="$YakiCivilianActor" insert="true" updatebriefing="true"/>
                </do_if>
                <do_else>
                  <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" text="{30226,103}" object="$YakiCivilianActor" insert="true" updatebriefing="true"/>
                </do_else>

                <signal_cue cue="Ch17_Remove_Interiors"/>
              </actions>
              <cues>

                <cue name="Ch17_2_Yaki_Civilian_Attacked">
                  <conditions>
                    <event_object_attacked object="$YakiCivilianShip"/>
                    <check_value value="event.param.trueowner == faction.player"/>
                  </conditions>
                  <actions>
                    <do_if value="player.isinconversation and (player.conversationactor == $YakiCivilianActor)">
                      <cancel_conversation actor="player.conversationactor"/>
                    </do_if>
                    <signal_cue cue="Ch17_3_Optional_Fight"/>
                    <cancel_cue cue="Ch17_2_Persuade"/>
                  </actions>
                </cue>

                <cue name="Ch17_2_Yaki_Civilian_Conversation_Started">
                  <conditions>
                    <event_conversation_started actor="$YakiCivilianActor"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226202" comment="(trembling)What do you want? Are you threatening me? I have no further business with you!"/>

                    <add_player_choice text="{30226,2059}" section="yaki_civ_violent" position="left"/>
                    <add_player_choice text="{30226,2060}" section="yaki_civ_peaceful_1" position="right"/>
                  </actions>
                </cue>

                <cue name="Ch17_2_Yaki_Civilian_Conversation_Section_Peaceful_1">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="yaki_civ_peaceful_1"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226209" comment="(quietly)Thank you for letting me know."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226210" comment="(quietly)Maybe it's for the best. Towards the end, he was a danger to himself, and everyone around him."/>

                    <add_player_choice text="{30226,2061}" section="yaki_civ_peaceful_2" position="left"/>
                  </actions>
                </cue>

                <cue name="Ch17_2_Yaki_Civilian_Conversation_Section_Peaceful_2">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="yaki_civ_peaceful_2"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226211" comment="We might have been, once."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226212" comment="(sighs)It's true, by the way. He came to me, quite recently. Went on and on about this new piece of cyberware he'd built out of Terran high tech."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226213" comment="(smiles to herself)He was so proud. And of course he wanted me to have it; thought that it would make me reconsider my decision and maybe go back with him."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226214" comment="(sad)He was already so far gone. I couldn't bring myself to say no, and so I took it. Kept it with me, even though I knew I'd never return... there."/>

                    <add_player_choice text="{30226,2062}" section="yaki_civ_peaceful_3" position="left"/>
                  </actions>
                </cue>

                <cue name="Ch17_2_Yaki_Civilian_Conversation_Section_Peaceful_3">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="yaki_civ_peaceful_3"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226215" comment="(steels herself)Here, I'll make you an offer. You seem... more sensible than I expected, and I have a feeling that you wouldn't stop searching just because I told you to get lost."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226216" comment="You go ahead and take this. See where it leads you."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226217" comment="All I ask of you is to keep an open mind, and don't judge a book by its cover. There are going to be a few ugly ones where you're headed."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226218" comment="Good luck."/>
                  </actions>
                </cue>

                <cue name="Ch17_2_Yaki_Civilian_Conversation_Section_Violent">
                  <conditions>
                    <event_conversation_next_section actor="$YakiCivilianActor" section="yaki_civ_violent"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226203" comment="(bitter)What's that supposed to tell me? That you're willing to murder the unfortunate until you get what you want? Is that how you negotiate?"/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226204" comment="(bitter)There are many here like me. People who've found a glimmer of purpose with the Pioneers, after everything else failed them."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226205" comment="(bitter)And day after day, people like you, who just want to ruin our lives for the sake of it, keep showing up."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226206" comment="(determined; 'you' refers to the lackeys of the Terran Protectorate)I won't put up with it any more. I can't. You will just keep coming."/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226207" comment="(determined)You say you killed one of my friends? Just like that?"/>
                    <add_npc_line speaker="$YakiCivilianActor" hidechoices="true" line="30226208" comment="(determined, angry)I won't let you hurt anyone else."/>
                  </actions>
                </cue>

                <cue name="Ch17_2_Yaki_Civilian_Conversation_Finished" version="2">
                  <conditions>
                    <event_conversation_finished actor="$YakiCivilianActor"/>
                    <check_value value="Ch17_2_Yaki_Civilian_Conversation_Started.state == cuestate.complete"/>
                  </conditions>
                  <actions>
                    <do_if value="event.param == 'yaki_civ_violent'">
                      <signal_cue cue="Ch17_3_Optional_Fight"/>
                    </do_if>
                    <do_elseif value="event.param == 'yaki_civ_peaceful_3'">
                      <set_value name="$CalmedTamatha"/>
                      <signal_cue cue="Ch17_4_Pick_Up_Key"/>
                    </do_elseif>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="(Ch17_3_Optional_Fight.state == cuestate.waiting) and (Ch17_4_Pick_Up_Key.state == cuestate.waiting)">
                      <do_if value="Ch17_2_Yaki_Civilian_Conversation_Section_Violent.state == cuestate.complete">
                        <signal_cue cue="Ch17_3_Optional_Fight"/>
                      </do_if>
                      <do_elseif value="Ch17_2_Yaki_Civilian_Conversation_Section_Peaceful_3.state == cuestate.complete">
                        <set_value name="$CalmedTamatha"/>
                        <signal_cue cue="Ch17_4_Pick_Up_Key"/>
                      </do_elseif>
                      <do_else>
                        <reset_cue cue="this"/>
                      </do_else>
                    </do_if>
                  </patch>
                </cue>

              </cues>
            </cue>

            <cue name="Ch17_3_Optional_Fight">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$FoughtTamatha"/>

                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.kill" object="$YakiCivilianShip" text="{30226,103}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch17_3_Optional_Fight_Orders">
                  <actions>
                    <set_object_min_hull object="$YakiCivilianShip" exact="0"/>
                    <set_object_min_shield object="$YakiCivilianShip" exact="0"/>
                    <set_relation_boost object="$YakiCivilianShip" faction="faction.player" value="-1.0" decay="0"/>

                    <cancel_all_orders object="$YakiCivilianShip"/>
                    <create_order id="'MoveToObject'" object="$YakiCivilianShip" default="true">
                      <param name="destination" value="$AsteroidBase"/>
                    </create_order>

                    <set_value name="$CurrentPlayerShip" exact="player.ship"/>
                    <create_order id="'Attack'" object="$YakiCivilianShip" immediate="true">
                      <param name="primarytarget" value="$CurrentPlayerShip"/>
                      <param name="pursuetargets" value="false"/>
                      <param name="checkrelation" value="false"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch17_3_Xenon_Support_Timer_Start">
                  <conditions>
                    <check_any>
                      <check_all>
                        <event_object_shield_damaged object="$YakiCivilianShip"/>
                        <check_value value="$YakiPirate.shieldpercentage le 70"/>
                      </check_all>
                      <check_all>
                        <event_object_hull_damaged object="$YakiCivilianShip"/>
                        <check_value value="$YakiPirate.hullpercentage le 95"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_value name="$TimerEnd" exact="player.age + 30s"/>

                    <!-- Overwrite previous objective. -->
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.kill" object="$YakiCivilianShip" text="{30226,103}" endtime="$TimerEnd" updatebriefing="true"/>
                  </actions>
                  <delay exact="2s"/>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$YakiCivilianActor" priority="100">
                      <text line="30226219" comment="(strained, panicking)I really don't want to use this, but you leave me no choice!"/>
                    </speak>
                  </actions>
                  <delay exact="12s"/>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$YakiCivilianActor" priority="100">
                      <text line="30226220" comment="(groaning, having trouble speaking)Why isn't this working?"/>
                    </speak>
                  </actions>
                  <delay exact="10s"/>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$YakiCivilianActor" priority="100">
                      <text line="30226221" comment="(in pain, having trouble speaking)It hurts. It hurts so much!"/>
                    </speak>
                  </actions>
                  <delay exact="6s"/>
                  <actions>
                    <signal_cue cue="Ch17_3_Xenon_Support"/>
                  </actions>
                  <cues>

                    <cue name="Ch17_3_Speaks_Finished" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_speak_finished actor="$YakiCivilianActor" line="30226219"/>
                          <event_speak_finished actor="$YakiCivilianActor" line="30226220"/>
                          <event_speak_finished actor="$YakiCivilianActor" line="30226221"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch17_3_Xenon_Support">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$YakiCivilianPosition" object="$YakiCivilianShip" space="$YakiCivilianShip.sector"/>

                    <do_if value="player.entity.hascontext.{$YakiCivilianShip.sector} and player.ship">
                      <set_value name="$AttackTarget" exact="player.ship"/>
                    </do_if>
                    <do_else>
                      <find_ship name="$AttackTarget" multiple="false" owner="faction.player" space="$YakiCivilianShip.sector" sortbydistanceto="$YakiCivilianShip"/>
                    </do_else>

                    <do_if value="$YakiCivilianShip.sector == $AsteroidBase.sector">
                      <create_position name="$XenonSpawnPosition" space="$YakiCivilianShip.sector" object="$AsteroidBase" y="- 1km"/>
                    </do_if>
                    <do_else>
                      <create_position name="$XenonSpawnPosition" space="$YakiCivilianShip.sector" x="$YakiCivilianPosition.x" y="$YakiCivilianPosition.y - 5km" z="$YakiCivilianPosition.z"/>
                    </do_else>

                    <run_actions ref="Spawn_Attack_Wave" result="$AttackWave">
                      <param name="AttackTarget"  value="$AttackTarget"/>
                      <param name="Faction"       value="faction.xenon"/>
                      <param name="MissionCue"    value="$MissionCue"/>
                      <param name="Sector"        value="$YakiCivilianShip.sector"/>
                      <param name="ShipMacros"    value="[ [ macro.ship_xen_m_corvette_02_a_macro, 1 ],
                                                           [ macro.ship_xen_s_fighter_02_a_macro, 2 ],
                                                           [ macro.ship_xen_s_fighter_01_a_macro, 4 ] ]"/>
                      <param name="SpawnPosition" value="$XenonSpawnPosition"/>
                      <param name="AllowOtherTargets" value="true"/>
                    </run_actions>

                    <play_sound sound="'yaki_xenon_call'" object="player.entity"/>

                    <!--<signal_cue cue="Ch17_3_Update_Objective"/>-->

                    <destroy_object object="$YakiCivilianShip" explosion="true"/>
                  </actions>
                </cue>

                <!--<cue name="Ch17_3_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.destroy" group="$AttackWave" text="{30225,1022}" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch17_3_Xenon_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$AttackWave"/>
                        <check_value value="$AttackWave.count == 1"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch17_4_Pick_Up_Key"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>-->

                <cue name="Ch17_3_Ship_Destroyed">
                  <conditions>
                    <event_object_destroyed object="$YakiCivilianShip"/>
                  </conditions>
                  <actions>
                    <do_if value="Ch17_3_Xenon_Support.state == cuestate.waiting">
                      <cancel_cue cue="Ch17_3_Xenon_Support_Timer_Start"/>
                    </do_if>

                    <!-- Remember the position the ship got destroyed at. -->
                    <do_if value="$YakiCivilianShip.sector">
                      <set_value name="$KeyDropSector" exact="$YakiCivilianShip.sector" comment="Might fail if the ship is e.g. on a highway."/>
                    </do_if>
                    <do_else>
                      <set_value name="$KeyDropSector" exact="$ConversationPuzzleSector"/>
                    </do_else>

                    <create_position name="$KeyDropPosition" object="$YakiCivilianShip" space="$KeyDropSector"/>

                    <signal_cue cue="Ch17_4_Pick_Up_Key"/>
                  </actions>
                  <cues>

                    <cue name="Ch17_3_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30221231]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                              <t id="30221231">Oh dear me, no.</t>
                              <t id="30201142">Oh. That is rather unfortunate.</t>
                                                    -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch17_4_Pick_Up_Key">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- In case of a peaceful solution, we haven't set the position yet. -->
                <do_if value="$YakiCivilianShip.isoperational">
                  <do_if value="$YakiCivilianShip.sector">
                    <set_value name="$KeyDropSector" exact="$YakiCivilianShip.sector" comment="Might fail if the ship is e.g. on a highway."/>
                  </do_if>
                  <do_else>
                    <set_value name="$KeyDropSector" exact="$ConversationPuzzleSector"/>
                  </do_else>
                  <create_position name="$KeyDropPosition" object="$YakiCivilianShip" space="$KeyDropSector"/>
                </do_if>

                <create_object name="$KeyDrop" macro="macro.sm_gen_wares_rare_01_macro" sector="$KeyDropSector">
                  <safepos value="$KeyDropPosition" min="5m" max="20m"/>
                </create_object>
                <add_cargo object="$KeyDrop" ware="ware.inv_xenoterran_implant" exact="1"/>

                <create_object name="$ExtraLootDrop" macro="macro.sm_gen_wares_rare_01_macro" sector="$KeyDropSector">
                  <safepos value="$KeyDropPosition" min="5m" max="20m"/>
                </create_object>
                <add_cargo object="$ExtraLootDrop" ware="ware.inv_seminar_management_2" exact="1"/>

                <play_music music="'music_dlc_terran_story_yaki_2'"/>
              </actions>
              <cues>

                <cue name="Ch17_4_Yaki_Civilian_Orders">
                  <actions>
                    <do_if value="$YakiCivilianShip.isoperational">
                      <cancel_all_orders object="$YakiCivilianShip"/>
                      <find_dockingbay groupname="$ConversationPuzzleStationDockingAreas" object="$ConversationPuzzleStation" checkoperational="true" multiple="true">
                        <match_dock size="tag.dock_s"/>
                      </find_dockingbay>
                      <do_if value="$ConversationPuzzleStationDockingAreas.count">
                        <create_order id="'MoveDie'" object="$YakiCivilianShip">
                          <param name="atstation" value="$ConversationPuzzleStation"/>
                        </create_order>
                      </do_if>
                      <do_else>
                        <create_order id="'MoveDie'" object="$YakiCivilianShip"/>
                      </do_else>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch17_4_Update_Objective">
                  <delay exact="2s"/>
                  <actions>
                    <do_if value="$KeyDrop.exists">
                      <set_value name="$CurrentStep" operation="add"/>
                      <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.collect" object="$KeyDrop" text="{30226,2017}" insert="true" updatebriefing="true"/>
                      <signal_cue cue="Ch17_4_Key_Spotted_Dialog"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch17_4_Key_Collected_Dialog"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch17_4_Key_Spotted_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch17_4_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226207]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                              An item! How curious!
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch17_4_Key_Collected">
                  <conditions>
                    <event_object_destroyed object="$KeyDrop" comment="Ideally the drop is killed by being collected by the player, but we want the mission to continue either way." check="false"/>
                  </conditions>
                  <actions>
                    <!--<do_for_each in="$AsteroidBaseLasertowers" name="$Tower">
                      <set_relation_boost object="$Tower" faction="faction.player" value="faction.yaki.relation.neutral.mid" decay="0"/>
                    </do_for_each>-->
                    <signal_cue cue="Ch17_4_Key_Collected_Dialog"/>
                  </actions>
                </cue>

                <cue name="Ch17_4_Key_Collected_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch17_4_Boso_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226208],[30226209],[30226210]]"/>
                      <param name="EndSignalCue"      value="Ch17_Clean_Up"/>
                      <!--
                              This appears to be a rather advanced piece of cybernetics. Its creator seems to have poured his very soul into the intricate metalwork.
                              And if my eyes do not mislead me... yes! It appears to be linked to the scary and sinister asteroid in your vicinity.
                              Assistant! I command you to investigate!
                                                    -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch17_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <!-- Tester reported that he didn't have the item at this point. No repro, but add a failsafe nonetheless. -->
                <do_if value="not player.entity.inventory.{ware.inv_xenoterran_implant}.count">
                  <add_inventory entity="player.entity" ware="ware.inv_xenoterran_implant"/>
                </do_if>

                <do_if value="$YakiCivilianShip.isoperational and ($YakiCivilianShip.order.id != 'MoveDie')">
                  <cancel_all_orders object="$YakiCivilianShip"/>
                  <find_dockingbay groupname="$ConversationPuzzleStationDockingAreas" object="$ConversationPuzzleStation" checkoperational="true" multiple="true">
                    <match_dock size="tag.dock_s"/>
                  </find_dockingbay>
                  <do_if value="$ConversationPuzzleStationDockingAreas.count">
                    <create_order id="'MoveDie'" object="$YakiCivilianShip">
                      <param name="atstation" value="$ConversationPuzzleStation"/>
                    </create_order>
                  </do_if>
                  <do_else>
                    <create_order id="'MoveDie'" object="$YakiCivilianShip"/>
                  </do_else>
                </do_if>

                <signal_cue cue="Ch18_Asteroid_Base"/>
                <cancel_cue cue="Ch17_Follow_Yaki_Civilian"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch18_Asteroid_Base">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Don't collapse the mission briefing for this last step. -->
          </actions>
          <force name="Ch18_Force">
            <force_cue cue="Ch15_2_Setup_Destination_Station"/>
            <force_cue cue="Ch17_Setup_Asteroid_Base"/>
          </force>
          <cues>

            <cue name="DEBUG_Print_Player_Position_Relative_To_Asteroid" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_position name="$pos" object="player.ship" space="$AsteroidBase"/>
                <debug_text text="$pos"/>
              </actions>
            </cue>

            <cue name="Ch18_Setup_Asteroid_Base_Tunnels" version="3">
              <actions>
                <create_position name="$ActualAsteroidBasePosition" object="$AsteroidBase" space="$AsteroidBase.sector"/>

                <create_loadout result="$OldYakiShipLoadout" comment="ship_yak_s_fighter_01_a_macro">
                  <macros>
                    <engine macro="engine_arg_s_combat_01_mk2_macro" path="../con_engine_02"/>
                    <engine macro="engine_arg_s_combat_01_mk2_macro" path="../con_engine_01"/>
                    <weapon macro="weapon_gen_s_gatling_01_mk2_macro" path="../con_weapon_02"/>
                    <weapon macro="weapon_gen_s_gatling_01_mk2_macro" path="../con_weapon_04"/>
                    <weapon macro="weapon_gen_s_gatling_01_mk2_macro" path="../con_weapon_03"/>
                    <weapon macro="weapon_gen_s_gatling_01_mk2_macro" path="../con_weapon_01"/>
                    <shield macro="shield_tel_s_standard_01_mk2_macro" path="../con_shield_01"/>
                  </macros>
                  <software>
                    <software ware="software_dockmk2"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk2"/>
                    <software ware="software_scannerobjectmk1"/>
                    <software ware="software_targetmk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_s_allround_01_mk2_macro"/>
                  </virtualmacros>
                </create_loadout>

                <create_position name="$OldYakiShipPosition" object="$AsteroidBase" space="$ConversationPuzzleSector" x="1960m" y="-166m" z="446m"/>

                <create_ship name="$OldYakiShip" macro="macro.ship_yak_s_fighter_01_a_macro" sector="$ConversationPuzzleSector" missioncue="namespace" capturable="false">
                  <owner exact="faction.ownerless"/>
                  <loadout loadout="$OldYakiShipLoadout"/>
                  <!-- Paint mod: Violaceous Cybershroud (Yaki Camo 1) -->
                  <paint ware="ware.paintmod_0124"/>
                  <position value="$OldYakiShipPosition"/>
                  <rotation yaw="176.70059deg" pitch="-13.4957deg"/>
                </create_ship>

                <set_object_name object="$OldYakiShip" page="30226" line="235" comment="Litigious Rodent"/>

                <!--<signal_cue_instantly cue="Ch19_Setup_Cover_Owner" param="table[$CoverShip        = $OldYakiShip,
                                                                                        $CoverFaction     = faction.yaki,
                                                                                        $CoverCancelCue   = null]"/>-->
                <!-- Example positions:
                Asteroid Base:
                position.[14375.043945m, -30000.000000m, 24115.416016m]
                Yaki Ship:
                <position x="16335.15" y="-30166.436" z="24561.287"/>
                <rotation yaw="176.70059deg" pitch="-13.4957deg"/>
                Relative Position of the Ship:
                x: 1960m, y: -166m, z: 446m-->

                <add_to_group groupname="global.$IgnoredAbandonedShips" object="$OldYakiShip"/>

                <set_object_radar_visible object="$OldYakiShip" visible="false"/>
                <set_object_min_hull object="$OldYakiShip" exact="100"/>

                <set_ship_safepos_allowed ship="$OldYakiShip" allow="false"/>

                <find_object_component name="$AsteroidBaseDoors" object="$AsteroidBase" macro="macro.positiondummy1_macro" multiple="false" required="true"/>

                <create_position name="$AsteroidBaseWorryPosition" object="$AsteroidBase" space="$ConversationPuzzleSector" value="position.[663.367188m, -190.701172m, -640.914063m]"/>
                <create_position name="$AsteroidBaseWarningPosition" object="$AsteroidBase" space="$ConversationPuzzleSector" value="position.[1581.562500m, -261.460938m, 432.484375m]"/>
                <create_position name="$AsteroidExitPosition" object="$AsteroidBase" space="$ConversationPuzzleSector" value="position.[1968.714844m, -561.152344m, -92.128906m]"/>
              </actions>
              <patch sinceversion="2">
                <create_position name="$OldYakiShipPosition" object="$AsteroidBase" space="$ConversationPuzzleSector" x="1960m" y="-166m" z="446m"/>
              </patch>
              <patch sinceversion="3">
                <do_if value="Ch18_2_Yaki_Ship_Claimed.state == cuestate.waiting">
                  <set_ship_safepos_allowed ship="$OldYakiShip" allow="false"/>
                </do_if>
              </patch>
              <cues>

                <cue name="DEBUG_Asteroid_Base_Position_Guidance">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$DebugPositionMissionCue" exact="this"/>
                    <create_mission cue="$DebugPositionMissionCue" name="'Asteroid Trigger Position Guidance'" description="''" type="missiontype.plot" faction="faction.player" difficulty="level.trivial" abortable="true"/>
                  </actions>
                  <cues>

                    <cue name="DEBUG_Worry_Position_Guidance" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$DebugPositionMissionCue" step="1" action="objective.flyto" object="$ConversationPuzzleSector" offset="$AsteroidBaseWorryPosition" text="'Worry Position'" updatebriefing="true"/>
                      </actions>
                    </cue>

                    <cue name="DEBUG_Warning_Position_Guidance" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$DebugPositionMissionCue" step="1" action="objective.flyto" object="$ConversationPuzzleSector" offset="$AsteroidBaseWarningPosition" text="'Warning Position'" updatebriefing="true"/>
                      </actions>
                    </cue>

                    <cue name="DEBUG_Exit_Position_Guidance" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$DebugPositionMissionCue" step="1" action="objective.flyto" object="$ConversationPuzzleSector" offset="$AsteroidExitPosition" text="'Exit Position'" updatebriefing="true"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch18_Open_Asteroid_Base_Doors" checkinterval="1s">
                  <conditions>
                    <check_value value="(player.sector == $AsteroidBase.sector) and (player.entity.distanceto.{$AsteroidBaseDoors} le 200m)"/>
                    <check_value value="player.entity.inventory.{ware.inv_xenoterran_implant}.count"/>
                  </conditions>
                  <actions>
                    <trigger_animation object="$AsteroidBase" trigger="open_doors"/>
                  </actions>
                  <cues>

                    <cue name="Ch18_Close_Asteroid_Base_Doors" checkinterval="1s">
                      <conditions>
                        <check_value value="(player.sector == $AsteroidBase.sector) and (player.entity.distanceto.{$AsteroidBaseDoors} gt 200m)"/>
                      </conditions>
                      <actions>
                        <trigger_animation object="$AsteroidBase" trigger="close_doors"/>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch18_1_Explore_Asteroid">
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <!-- We've now finally reached the objective "Find: Connection to the Yaki". Overwrite it. -->
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.find" object="$ConversationPuzzleSector" offset="$ActualAsteroidBasePosition" radius="3km" text="{30226,2018}" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch18_1_Approach_AsteroidBaseSkipPosition_1_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                  <param name="ApproachSector"    value="$ConversationPuzzleSector"/>
                  <param name="ApproachOffset"    value="$AsteroidBaseSkipPosition"/>
                  <param name="ApproachDistance"  value="250m"/>
                  <param name="SuccessSignalCue"  value="Ch18_1_Asteroid_Base_Skip_Dialog"/>
                </cue>

                <cue name="Ch18_1_Asteroid_Base_Skip_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="Ch18_1_Old_Yaki_Ship_Found.state == cuestate.waiting"/>
                  </conditions>
                  <cues>

                    <cue name="Ch18_1_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226212]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                              Such ingenuity! Assistant, you have outdone yourself!
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch18_1_Approach_AsteroidBaseWorryPosition_1_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                  <param name="ApproachSector"    value="$ConversationPuzzleSector"/>
                  <param name="ApproachOffset"    value="$AsteroidBaseWorryPosition"/>
                  <param name="ApproachDistance"  value="300m"/>
                  <param name="SuccessSignalCue"  value="Ch18_1_Asteroid_Base_Worried_Dialog"/>
                </cue>

                <cue name="Ch18_1_Asteroid_Base_Worried_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch18_1_Boso_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226211]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                              (worried)I can feel this place watching me. I suggest we conclude our investigation in the most efficacious and hasty manner possible.
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch18_1_Approach_AsteroidBaseWorryPosition_2_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                  <param name="ApproachSector"    value="$ConversationPuzzleSector"/>
                  <param name="ApproachOffset"    value="$AsteroidBaseWorryPosition"/>
                  <param name="ApproachDistance"  value="1km"/>
                  <param name="SuccessSignalCue"  value="Ch18_1_Asteroid_Base_Ship_Size_Hint"/>
                </cue>

                <cue name="Ch18_1_Asteroid_Base_Ship_Size_Hint">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="player.ship and not [tag.dock_xs, tag.dock_s].indexof.{player.ship.docksize}">
                      <show_help line="839" position="1" force="true" comment="Anything larger than an S-sized ship may get stuck in these tunnels." allowclose="true" timeout="false"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch18_1_Approach_AsteroidBaseWarningPosition_1_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                  <param name="ApproachSector"    value="$ConversationPuzzleSector"/>
                  <param name="ApproachOffset"    value="$AsteroidBaseWarningPosition"/>
                  <param name="ApproachDistance"  value="400m"/>
                  <param name="SuccessSignalCue"  value="Ch18_1_Asteroid_Base_Warning_Dialog"/>
                </cue>

                <cue name="Ch18_1_Asteroid_Base_Warning_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch18_1_Boso_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226213]]"/>
                      <param name="EndSignalCue"      value="Ch18_1_Activate_Lasertowers"/>
                      <!--
                              (worried)I do not like the look of that.
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch18_1_Activate_Lasertowers">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Don't activate the lasertowers if the player is in a spacesuit. -->
                    <do_if value="not @player.controlled.isclass.spacesuit">
                      <set_value name="$CurrentPlayerShip" exact="player.ship"/>
                      <do_for_each in="$InteriorTowers" name="$CurrentTower">
                        <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                          <param name="Ship" value="$CurrentTower"/>
                          <param name="Faction" value="faction.xenon"/>
                        </run_actions>
                        <create_order id="'Attack'" object="$CurrentTower" immediate="true">
                          <param name="primarytarget" value="$CurrentPlayerShip"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                      </do_for_each>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch18_1_Approach_OldYakiShipPosition_Patch" onfail="cancel">
                  <conditions>
                    <check_value value="Ch18_2_Take_Control.state == cuestate.waiting"/>
                  </conditions>
                  <cues>

                    <cue name="Ch18_1_Approach_OldYakiShipPosition_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                      <param name="ApproachSector"    value="$ConversationPuzzleSector"/>
                      <param name="ApproachOffset"    value="$OldYakiShipPosition"/>
                      <param name="ApproachDistance"  value="150m"/>
                      <param name="SuccessSignalCue"  value="Ch18_1_Old_Yaki_Ship_Found"/>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch18_1_Old_Yaki_Ship_Found">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch18_1_Boso_Speak_4_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226215],[30226216]]"/>
                      <param name="EndSignalCue"      value="Ch18_2_Take_Control"/>
                      <!--
                              An abandoned Yaki ship!
                              So this is what that awfully suspicious customs officer was hiding!
                                                    -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch18_2_Take_Control">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.claim" object="$OldYakiShip" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch18_2_Activate_Yaki_Ship" version="2">
                  <actions>
                    <set_object_radar_visible object="$OldYakiShip" visible="true"/>
                    <set_object_capturable object="$OldYakiShip" capturable="true"/>

                    <!-- Originally, $OldYakiShip was created with capturable="true", so it might already be in the player's possession at this point. -->
                    <do_if value="$OldYakiShip.trueowner == faction.player">
                      <signal_cue cue="Ch18_2_Yaki_Ship_Claimed"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="(Ch18_2_Yaki_Ship_Claimed.state == cuestate.waiting) and ($OldYakiShip.trueowner == faction.player)">
                      <signal_cue cue="Ch18_2_Yaki_Ship_Claimed"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch18_2_Yaki_Ship_Claimed">
                  <conditions>
                    <check_any>
                      <check_all>
                        <event_object_claimed claimed="$OldYakiShip"/>
                        <check_value value="event.object.trueowner == faction.player"/>
                      </check_all>
                      <event_object_changed_owner object="$OldYakiShip" owner="faction.player"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_ship_safepos_allowed ship="$OldYakiShip" allow="true"/>
                    <signal_cue_instantly cue="Cover_Handler_v2" param="table[$CoverShip = $OldYakiShip,
                                                                              $CoverFaction = faction.yaki ]"/>

                    <!-- If the door is currently open, close it. -->
                    <do_if value="Ch18_Close_Asteroid_Base_Doors.state == cuestate.waiting">
                      <trigger_animation object="$AsteroidBase" trigger="close_doors"/>
                    </do_if>
                    <!-- Prevent to door from opening again on proximity. -->
                    <cancel_cue cue="Ch18_Open_Asteroid_Base_Doors"/>

                    <set_object_min_hull object="$OldYakiShip" exact="0"/>
                  </actions>
                  <cues>

                    <cue name="Ch18_2_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226217],[30226218]]"/>
                      <param name="EndSignalCue"      value="Ch18_3_Leave_Asteroid_Base"/>
                      <!--
                              Now, I am sure you would like to familiarise yourself with the controls of this intriguing vessel, but all in due time.
                              May I propose that we first increase the abandonment of this horrible place by several levels of desolation?
                                                    -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch18_3_Leave_Asteroid_Base">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,2019}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch18_3_Approach_AsteroidBaseDoors_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$AsteroidBaseDoors"/>
                  <param name="ApproachDistance"  value="40m"/>
                  <param name="SuccessSignalCue"  value="Ch18_3_Doors_Closed_Dialog"/>
                </cue>

                <cue name="Ch18_3_Doors_Closed_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="Ch18_1_Asteroid_Base_Skip_Dialog.state == cuestate.waiting"/>
                  </conditions>
                  <cues>

                    <cue name="Ch18_3_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30221321],[30226214]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                              *** Squeaking Noise of Worry and Discontent ***
                              It appears we have to find another exit.
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch18_3_Approach_AsteroidExitPosition_1_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                  <param name="ApproachSector"    value="$ConversationPuzzleSector"/>
                  <param name="ApproachOffset"    value="$AsteroidExitPosition"/>
                  <param name="ApproachDistance"  value="250m"/>
                  <param name="SuccessSignalCue"  value="Ch18_3_Asteroid_Base_Secret_Exit_Dialog"/>
                </cue>

                <cue name="Ch18_3_Asteroid_Base_Secret_Exit_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="Ch18_1_Asteroid_Base_Skip_Dialog.state == cuestate.waiting"/>
                  </conditions>
                  <cues>

                    <cue name="Ch18_3_Boso_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30226212]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                              Such ingenuity! Assistant, you have outdone yourself!
                                                    -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch18_3_Leaving_Asteroid_Base" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"      value="$AsteroidBase"/>
                  <param name="ApproachDistance"    value="3km"/>
                  <param name="SuccessSignalCue"    value="Ch18_Clean_Up_Yaki_Investigation_Mission_2"/>
                  <param name="Invert"              value="true"      comment="Turns Approach into Diverge"/>
                </cue>

              </cues>
            </cue>

            <cue name="Ch18_Clean_Up_Yaki_Investigation_Mission_2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Cleaning up Yaki Investigation mission 2.'" chance="$DebugChance"/>

                <set_object_min_hull object="$AsteroidBase" exact="0"/>

                <trigger_animation object="$AsteroidBase" trigger="open_doors" comment="So that if the player jammed a corvette in there, they can now get it out."/>

                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.terran" title="{30226,2001}" text="{30226,2004}"/>

                <signal_cue cue="Ch19_Discover_Yaki"/>
                <cancel_cue cue="Ch18_Asteroid_Base"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Mission 6 (Yaki Mission 3) -->

        <cue name="Ch19_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch19_Story_Yaki">

          </force>
          <cues>
            <cue name="Ch19_Check_HQ">
              <actions>
                <do_if value="not $HQ?">
                  <signal_cue cue="md.Story_Terraforming.Debug_Setup_HQ"/>
                </do_if>
                <signal_cue cue="Ch19_Force_Delay"/>
              </actions>
            </cue>
            <cue name="Ch19_Force_Delay">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="10s"/>
              <actions>
                <set_value name="$OldYakiShip" exact="player.ship"/>
                <!--<signal_cue_instantly cue="Ch19_Setup_Cover_Owner" param="table[$CoverShip        = $OldYakiShip,
                                                                                        $CoverFaction     = faction.yaki,
                                                                                        $CoverCancelCue   = null]"/>-->

                <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>

                <set_value name="$BosoCutsceneKey"    exact="table[ $key = 'ShowCharacterBoron']"/>
                <set_value name="$DalCutsceneKey"     exact="table[ $key = 'ShowCharacterDal']"/>

                <do_if value="md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete">
                  <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
                </do_if>
                <force_cue cue="Ch19_Discover_Yaki"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Ch19_Discover_Yaki">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_mission cue="$MissionCue" name="{30226,3001}" description="{30226,3002}" rewardtext="{30226,3003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name">
              <briefing>
                <objective step="1" action="objective.custom" customaction="{30226,3010}"/>
                <objective step="2" action="objective.await" text="{30226,3011}"/>
                <objective step="3" action="objective.find" text="{30226,3012}"/>
              </briefing>
            </create_mission>
            <!--
            - You can deliver the Yaki Ship to the HQ to get guidance
            - You can deliver the Yaki Ship to Delilah to get a Terran ship instead and guidance
            - Player gets a cover owner for either of those ships
            - Player can skip delivering the ship alltogether and go to the correct sector to continue            
            -->
          </actions>
          <cues>

            <cue name="Ch19_1_Return_Ship">
              <actions>
                <set_value name="$CurrentStep"/>
                <create_group groupname="$ReportingActors"/>
                <add_to_group groupname="$ReportingActors" list="[$BosoTa, $SecretServiceActor]"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,3010}" group="$ReportingActors" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch19_Hints">
                  <actions>
                    <set_value name="$Ch19_LibDialog_Cues"
                               exact="[
                               Ch19_1_Boso_Speak_FindYakiOptions_Ref,
                               Ch19_1_Secret_Service_Speak_ProtectorateInstructions_Ref,
                               Ch19_1_Secret_Service_Speak_PlayerDocks_Ref,
                               Ch19_1_Secret_Service_Speak_TerranShip_Ref,
                               Ch19_1_Secret_Service_Speak_PlayerUndocks_Ref,
                               Ch19_1_Boso_Speak_PlayerHQDock_Ref,
                               Ch19_1_Boso_Speak_XenonCover_Ref]"/>
                  </actions>
                  <cues>
                    <cue name="Ch19_1_Boso_Speak_FindYakiOptions">
                      <cues>
                        <cue name="Ch19_1_Boso_Speak_FindYakiOptions_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30226301],[30226302],[30226303],[30226304],[30226305],[30201422]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          <t id="	30226301	">	(relieved)Now that we have completed that most uncomfortable episode, there appear to be multiple options at your disposal, assistant.	</t>
                          <t id="	30226302	">	(pronounce "other employer" disparagingly)From what I could gather, your other employer would undoubtedly appreciate your swift return.	</t>
                          <t id="	30226303	">	However, those overzealous Terrans will likely quarantine this marvellous piece of technology in their enthusiasm. Should you decide to meet them, it would be prudent to not waste resources on ship equipment beforehand.	</t>
                          <t id="	30226304	">	Alternatively, and, if I may say so, preferably, you are always welcome to join me at our own Headquarters.	</t>
                          <t id="	30226305	">	I do admit that I may not be the most ostentatious or generous of hosts, but I promise to not damage your newly acquired vessel during the examination.	</t>
                          <t id="	30201422	">	The quest for knowledge is the noblest of pursuits!	</t>
                                                    -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch19_1_Secret_Service_Speak_ProtectorateInstructions">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch19_1_Secret_Service_Speak_ProtectorateInstructions_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$SecretServiceActor"/>
                          <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                          <param name="Lines"             value="[[30226301],[30226302]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          <t id="	30226301	">	Welcome back to the Protectorate, operative.	</t>
                          <t id="	30226302	">	I see you've made a new acquisition. If you dock it at our Headquarters, my team will take it apart and extract all the information relevant to your investigation.	</t>
                                                    -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch19_1_Secret_Service_Speak_PlayerDocks">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch19_1_Secret_Service_Speak_PlayerDocks_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$SecretServiceActor"/>
                          <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                          <param name="Lines"             value="[[30226303]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          <t id="	30226303	">	Please step out of this monstrosity, operative. My team will take it from here.	</t>
                                                    -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch19_1_Secret_Service_Speak_TerranShip">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch19_1_Secret_Service_Speak_TerranShip_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$SecretServiceActor"/>
                          <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                          <param name="Lines"             value="[[30226304],[30226305],[30226306],[30226307],[30226308]]"/>
                          <param name="EndSignalCue"      value="Ch19_1_Secret_Service_Speak_TerranShip_EndSignalCue"/>
                          <!--
                          <t id="	30226304	">	Wonderful, that didn't take long.	</t>
                          <t id="	30226305	">	I'm transmitting the decrypted navigational data to your mission interface.	</t>
                          <t id="	30226306	">	And one more thing: Since you appear to be nearing the final stage of your investigation, I think you should travel in style.	</t>
                          <t id="	30226307	">	It's time to drop the masquerade and display the full force of the Terran Protectorate.	</t>
                          <t id="	30226308	">	("her" refers to a ship)You'll find her on the dock.	</t>
                                                    -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch19_1_Secret_Service_Speak_PlayerUndocks">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch19_1_Secret_Service_Speak_PlayerUndocks_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$SecretServiceActor"/>
                          <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                          <param name="Lines"             value="[[30226309],[30226310]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          <t id="	30226309	">	We've transferred a peculiar program from the Yaki ship to this one. It appears to manipulate the friend/foe identification in some manner.	</t>
                          <t id="	30226310	">	This might come in handy when you reach your destination, but stay alert nonetheless.	</t>
                                                    -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch19_1_Boso_Speak_PlayerHQDock">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch19_1_Boso_Speak_PlayerHQDock_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30226306],[30226307],[30226308]]"/>
                          <param name="EndSignalCue"      value="Ch19_1_Boso_Speak_PlayerHQDock_EndSignalCue"/>
                          <!--
                          <t id="	30226306	">	Oh, how fascinating! This ship appears to be equipped with rather sophisticated spoofing technology that exceeds my wildest imaginations.	</t>
                          <t id="	30226307	">	I am devastated, but despite my numerous qualifications at the highest level in many subjects, I am unable to reverse-engineer this peculiar apparatus. You will have to discover its functions in the field.	</t>
                          <t id="	30226308	">	I did, however, manage to decrypt the ship's navigational data. You should be able to find its point of origin now.	</t>
                                                    -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch19_1_Boso_Speak_XenonCover">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch19_1_Boso_Speak_XenonCover_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30226309]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          <t id="	30226309	">	So that is the arcane function of that peculiar apparatus! Those Xenon do not recognise you as an enemy!	</t>
                                                    -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch19_1_Old_Yaki_Ship_Destroyed_Prematurely">
                  <conditions>
                    <check_any>
                      <event_object_destroyed object="$OldYakiShip"/>
                      <event_object_changed_true_owner object="$OldYakiShip" previous="faction.player" comment="In case the player sells it."/>
                    </check_any>
                    <check_value value="Ch19_1_Found_Yaki_Home_Sector.state == cuestate.waiting"/>
                    <check_value value="not $OldYakiShipTransferComplete?"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch19_1_Returned_To_Secret_Service_Headquarters"/>
                    <cancel_cue cue="Ch19_1_Returned_To_Player_Headquarters"/>

                    <update_mission cue="$MissionCue">
                      <briefing replace="true">
                        <objective step="1" action="objective.custom" customaction="{30226,3010}" failed="true"/>
                        <objective step="2" action="objective.await" text="{30226,3011}" failed="true"/>
                        <objective step="3" action="objective.custom" customaction="{30226,3013}"/>
                      </briefing>
                    </update_mission>

                    <set_value name="$CurrentStep" exact="3"/>
                    <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep"/>
                  </actions>
                </cue>

                <cue name="Ch19_1_Protectorate_Space_Entering" instantiate="true">
                  <conditions>
                    <event_object_changed_sector object="$OldYakiShip"/>
                    <check_value value="event.param != null"/>
                  </conditions>
                  <actions>
                    <set_value name="$NewSector" exact="event.param"/>

                    <do_if value="$NewSector.owner == faction.terran">
                      <signal_cue cue="Ch19_1_Secret_Service_Speak_ProtectorateInstructions" check="false"/>
                      <cancel_cue cue="Ch19_1_Protectorate_Space_Entering" comment="No more instantiations"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch19_1_Returned_To_Secret_Service_Headquarters">
                  <conditions>
                    <event_object_docked object="$OldYakiShip" dock="$SecretServiceStation"/>
                    <check_value value="Ch19_1_Returned_To_Player_Headquarters.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.disembark" text="$OldYakiShip.knownname" updatebriefing="true"/>
                    <signal_cue cue="Ch19_1_Secret_Service_Speak_PlayerDocks" check="false" comment="Only play dialog the first time."/>
                  </actions>
                  <cues>

                    <cue name="Ch19_1_Player_Undocked_Prematurely">
                      <conditions>
                        <event_object_undocked_from container="$SecretServiceStation"/>
                        <check_value value="event.param == $OldYakiShip"/>
                        <check_value value="Ch19_1_Player_Left_Ship.state == cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,3010}" group="$ReportingActors" updatebriefing="true"/>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>

                    <cue name="Ch19_1_Player_Left_Ship">
                      <conditions>
                        <event_object_changed_object object="player.entity" previous="$OldYakiShip"/>
                        <check_value value="$OldYakiShip.hascontext.{$SecretServiceStation}"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch19_1_Returned_To_Player_Headquarters"/>
                        <set_value name="$OldYakiShipTransferComplete"/>

                        <!-- Transfer OldYakiShip -->
                        <set_value name="$OldYakiShipDockingPad" exact="$OldYakiShip.room"/>

                        <signal_cue cue="Disable_Current_Cover_Handler_v2"/>

                        <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                          <param name="Ship" value="$OldYakiShip"/>
                          <param name="Faction" value="faction.civilian" comment="To make the station store this exact ship in request_store_ship"/>
                        </run_actions>
                        <cancel_all_orders object="$OldYakiShip"/>
                        <create_order id="'Wait'" object="$OldYakiShip" default="true"/>
                      </actions>
                      <cues>

                        <cue name="Ch19_1_Player_Entered_Walkway" checkinterval="1s">
                          <conditions>
                            <check_value value="not player.entity.hascontext.{$OldYakiShip}"/>
                            <check_value value="not player.entity.floortags.indexof.{tag.walk_dockingbay}"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Floor tags: ' + player.entity.floortags" chance="$DebugChance"/>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <do_if value="player.entity.hascontext.{$OldYakiShip}">
                              <debug_text text="'Player returned into the ship. Resetting cue.'" chance="$DebugChance"/>
                              <reset_cue cue="this"/>
                            </do_if>
                            <do_elseif value="not player.entity.floortags.indexof.{tag.walk_dockingbay}">
                              <debug_text text="'Floor tags list still doesn\'t contain tag.walk_dockingbay after second check. Player has probably stepped onto the walkway.'" chance="$DebugChance"/>
                              <signal_cue cue="Ch19_1_Player_Left_Landing_Pad"/>
                            </do_elseif>
                            <do_else>
                              <debug_text text="'Floor tags list contains tag.walk_dockingbay. Resetting cue.'" chance="$DebugChance"/>
                              <reset_cue cue="this"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch19_1_Player_Left_Landing_Pad">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <check_all>
                                <event_object_changed_room object="player.entity" previous="$OldYakiShipDockingPad"/>
                                <check_value value="not player.entity.hascontext.{$OldYakiShip}"/>
                              </check_all>
                            </check_any>
                          </conditions>
                          <actions>
                            <debug_text text="'Player has left the docking pad of the $OldYakiShip.'" chance="$DebugChance"/>
                            <cancel_cue cue="Ch19_1_Player_Entered_Walkway"/>

                            <!-- Remove OldYakiShip -->
                            <cancel_all_orders object="$OldYakiShip"/>
                            <create_order id="'MoveDie'" object="$OldYakiShip">
                              <param name="atstation" value="$SecretServiceStation"/>
                            </create_order>

                            <request_store_ship object="$OldYakiShip.station" refobject="$OldYakiShip" ship="$OldYakiShip"/>

                            <set_value name="$DecryptionDelay" exact="20s"/>

                            <set_value name="$CurrentStep" exact="2"/>
                            <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30226,3011}" endtime="player.age + $DecryptionDelay" updatebriefing="true"/>
                          </actions>
                          <delay exact="$DecryptionDelay"/>
                          <actions>
                            <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30226,3011}" silent="true" updatebriefing="true"/>
                            <signal_cue cue="Ch19_1_Secret_Service_Speak_TerranShip"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch19_1_Secret_Service_Speak_TerranShip_EndSignalCue">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <create_loadout result="$loadout" comment="ship_ter_m_corvette_01_a_macro (Katana)">
                          <macros>
                            <engine macro="engine_ter_m_combat_01_mk2_macro" path="../con_engine_02"/>
                            <engine macro="engine_ter_m_combat_01_mk2_macro" path="../con_engine_01"/>
                            <weapon macro="weapon_ter_m_laser_01_mk2_macro" path="../con_weapon_01"/>
                            <weapon macro="weapon_ter_m_laser_01_mk2_macro" path="../con_weapon_02"/>
                            <weapon macro="weapon_ter_m_laser_01_mk2_macro" path="../con_weapon_03"/>
                            <weapon macro="weapon_ter_m_laser_01_mk2_macro" path="../con_weapon_04"/>
                            <shield macro="shield_ter_m_standard_01_mk2_macro" path="../con_shield_01"/>
                            <shield macro="shield_ter_m_standard_01_mk2_macro" path="../con_shield_02"/>
                            <turret macro="turret_ter_m_laser_01_mk1_macro" path="../con_turret_mid"/>
                            <turret macro="turret_ter_m_laser_01_mk1_macro" path="../con_turret_front"/>
                          </macros>
                          <software>
                            <software ware="software_dockmk1"/>
                            <software ware="software_flightassistmk1"/>
                            <software ware="software_scannerlongrangemk1"/>
                            <software ware="software_scannerobjectmk1"/>
                            <software ware="software_targetmk1"/>
                          </software>
                          <virtualmacros>
                            <thruster macro="thruster_gen_m_allround_01_mk2_macro"/>
                          </virtualmacros>
                        </create_loadout>

                        <create_ship name="$ProtectoratePlayerShip" commandeerable="false"
                                     missioncue="namespace" macro="ship_ter_m_corvette_01_a_macro"
                                     sector="$SecretServiceStation.sector" dock="$SecretServiceStation">
                          <owner exact="faction.terran"/>
                          <loadout loadout="$loadout"/>
                          <pilot actor="null"/>
                          <!-- Paint mod: Solset Dapple (Terran Camo 1)-->
                          <paint ware="ware.paintmod_0118"/>
                        </create_ship>
                        <set_owner object="$ProtectoratePlayerShip" faction="faction.player"/>

                        <signal_cue cue="Ch19_2_Find_Yaki_Home_Sector" check="false"/>
                      </actions>
                      <cues>
                        <cue name="Ch19_1_TerranShip_Undock" version="2">
                          <conditions>
                            <event_object_undocked object="$ProtectoratePlayerShip"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch19_1_Secret_Service_Speak_PlayerUndocks"/>

                            <signal_cue_instantly cue="Cover_Handler_v2" param="table[$CoverShip = $ProtectoratePlayerShip,
                                                                                      $CoverFaction = faction.yaki ]"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch19_1_Returned_To_Player_Headquarters">
                  <conditions>
                    <event_object_docked object="$OldYakiShip" dock="$HQ"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch19_1_Returned_To_Secret_Service_Headquarters"/>
                    <set_value name="$OldYakiShipTransferComplete"/>

                    <set_value name="$DecryptionDelay" exact="10s"/>
                    <set_value name="$CurrentStep" exact="2"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30226,3011}" endtime="player.age + $DecryptionDelay" updatebriefing="true"/>
                  </actions>
                  <delay exact="$DecryptionDelay"/>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30226,3011}" silent="true" updatebriefing="true"/>
                    <signal_cue cue="Ch19_1_Boso_Speak_PlayerHQDock"/>
                  </actions>
                  <cues>
                    <cue name="Ch19_1_Boso_Speak_PlayerHQDock_EndSignalCue">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch19_2_Find_Yaki_Home_Sector"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch19_1_Found_Yaki_Home_Sector">
                  <conditions>
                    <event_object_changed_sector object="player.entity" sector="$YakiHomeSector" comment="What counts is the player themselves arriving. The old Yaki ship just makes it easier to get there."/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch19_Clean_Up_Yaki_Investigation_Mission_3"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch19_2_Find_Yaki_Home_Sector" version="2">
              <!-- Guidance -->
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="3"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.find" text="{30226,3012}" object="$YakiHomeSector" updatebriefing="true"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$CurrentStep" exact="3"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.find" text="{30226,3012}" object="$YakiHomeSector" updatebriefing="true"/>
              </patch>
              <cues>

                <!--<cue name="Ch19_Xenon_Ships_In_Range">
                  <cues>
                    <cue name="Ch19_Xenon_Ships_In_Range_Check" checkinterval="5s">
                      <conditions>
                        <check_any>
                          <check_all>
                            <check_value value="$OldYakiShip?"/>
                            <check_value value="player.ship == $OldYakiShip"/>
                          </check_all>
                          <check_all>
                            <check_value value="$ProtectoratePlayerShip?"/>
                            <check_value value="player.ship == $ProtectoratePlayerShip"/>
                          </check_all>
                        </check_any>
                        <check_value value="player.sector != null"/>
                        <count_ships result="$XenonShips"
                                     owner="faction.xenon"
                                     space="player.sector" min="1" masstraffic="false"
                                     checkoperational="true" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
                          <match_distance max="player.ship.maxradarrange * 0.8" object="player.ship"/>
                        </count_ships>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch19_1_Boso_Speak_XenonCover" check="false"/>
                        <cancel_cue cue="Ch19_Xenon_Ships_In_Range_Check"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>-->

                <!--<cue name="Ch19_2_Set_Path_Objective" instantiate="true">
                  <conditions>
                    <check_any>
                      <check_all>
                        <event_object_changed_sector object="player.entity"/>
                        <check_value value="event.param != null"/>
                        <check_value value="event.param != $YakiHomeSector"/>
                      </check_all>
                      <check_all>
                        <event_cue_signalled/>
                        <check_value value="player.sector != null"/>
                        <check_value value="player.sector != $YakiHomeSector"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_value name="$PathComponents" exact="[]"/>
                    <get_global_path multiple="true" component="$PathComponents" uselocalhighways="false">
                      <start object="player.sector"/>
                      <end object="$YakiHomeSector"/>
                    </get_global_path>
                    <do_for_each in="$PathComponents" name="$CurrentComponent">
                      <do_if value="$CurrentComponent.isclass.{class.gate} or $CurrentComponent.isclass.{class.highwayentrygate}">
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.find" text="{30226,3012}" object="$CurrentComponent" updatebriefing="true" comment="Follow: Dead Drop Signal"/>
                        <break/>
                      </do_if>
                    </do_for_each>
                  </actions>
                </cue>-->

              </cues>
            </cue>

            <cue name="Ch19_Clean_Up_Yaki_Investigation_Mission_3">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Cleaning up Yaki Investigation mission 3.'" chance="$DebugChance"/>

                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.terran" title="{30226,3001}" text="{30226,3004}"/>

                <signal_cue cue="Ch20_Arrival"/>
                <!-- Make sure no Lib_Dialog is running when canceling Ch19 -->
              </actions>
              <cues>
                <cue name="Ch19_Cleanup_LibDialog_Init">
                  <actions>
                    <signal_cue cue="Ch19_Cleanup_LibDialog_Check"/>
                  </actions>
                </cue>

                <cue name="Ch19_Cleanup_LibDialog_Check" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$LibDialogRunning" exact="false"/>
                    <do_for_each in="$Ch19_LibDialog_Cues" name="$Cue">
                      <do_if value="$Cue.state == cuestate.complete" comment="Not running should be either disabled, active or cancelled">
                        <set_value name="$LibDialogRunning" exact="true"/>
                        <break/>
                      </do_if>
                    </do_for_each>
                    <do_if value="$LibDialogRunning">
                      <signal_cue cue="Ch19_Cleanup_LibDialog_Wait"/>
                    </do_if>
                    <do_else>
                      <cancel_cue cue="Ch19_Discover_Yaki"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch19_Cleanup_LibDialog_Wait">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="5s"/>
                  <actions>
                    <debug_text text="'Trying again to Cleanup, Checking for active LibDialog Cues'" chance="$DebugChance"/>
                    <reset_cue cue="Ch19_Cleanup_LibDialog_Init"/>
                  </actions>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Mission 7 (Yaki Mission 4) -->

        <cue name="Ch20_Arrival">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_mission cue="$MissionCue" name="{30226,4001}" description="{30226,4002}" rewardtext="{30226,4003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.yaki" difficulty="level.medium" abortable="false" icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name"/>
            <set_value name="$CurrentStep"/>
          </actions>
          <cues>

            <cue name="Ch20_Dialog_Arrived_With_Yaki_Ship">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch20_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                  <param name="Lines"             value="[[30226401],[30220413]]"/>
                  <param name="EndSignalCue"      value="Ch20_Dialog_Invitation"/>
                  <!--
                          (childish giggle)It worked! Great magenta-flecked spirit of cybernetic science, it worked!
                          I can barely contain my excitement!
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch20_Dialog_Arrived_With_Terran_Ship">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch20_Boso_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                  <param name="Lines"             value="[[30226402],[30226403]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                          How unfortunate. I am detecting multiple entities with outspokenly murderous intent.
                          Evidently masking a ship's identity does not accomplish much if the ship is clearly of Terran design.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch20_Dialog_Arrived_Without_Ship">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch20_Boso_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                  <param name="Lines"             value="[[30226402]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                          How unfortunate. I am detecting multiple entities with outspokenly murderous intent.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch20_Dialog_Tamatha_Recording">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch20_Dialog_Tamatha_Recording_Speak_1">
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$YakiCivilianActor" priority="100">
                      <text line="30226401" comment="(start with a hrumph)Hello, old friend. This is Tamatha."/>
                      <text line="30226402" comment="(a bit shaky)I'm just a recording, but if there's still good in you, I know you will hear me out."/>
                      <text line="30226403" comment="(more firmly)I believe this person can help you. Consider this my parting gift."/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch20_Dialog_Tamatha_Recording_Speak_2">
                  <conditions>
                    <event_speak_finished actor="$YakiCivilianActor" line="30226401"/>
                  </conditions>
                  <actions>
                    <do_if value="Ch20_1_Xenon_Defeated.state == cuestate.waiting" comment="Xenon might have been defeated during the dialog.">
                      <speak actor="$YakiLeaderActor" priority="100">
                        <text line="30226401" comment="(sighs, annoyed; Kailan Weaver is a female historical figure; the 'hounds' are Xenon)Guard! Get your hounds under control, for Weaver's sake."/>
                        <text line="30226402" comment="(annoyed, louder; responding to an answer by the guard that the player couldn't hear)I know they don't listen! Handle it!"/>
                      </speak>
                    </do_if>
                  </actions>
                </cue>
                <cue name="Ch20_Dialog_Tamatha_Recording_Finished">
                  <conditions>
                    <event_speak_finished actor="$YakiLeaderActor" line="30226401"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <signal_cue cue="Ch20_1_Call_Off_Attack_Orders"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch20_Dialog_Invitation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch20_Kendai_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$YakiLeaderActor, $BosoTa]"/>
                  <param name="CutsceneKey"       value="[$YakiLeaderCutsceneKey, $BosoCutsceneKey]"/>
                  <param name="Lines"             value="[  [[30226403],[30226404],[30226405]],
                                                            [[30221321]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[null, Ch20_2_Yaki_Leader_Conversation]"/>
                  <!--         
                      Kendai:
                        (furious)Stranger! Explain yourself!
                        (furious, interrupts herself at the end)Who are you, and how did get here? Why...
                        (catches herself, sighs, then firmly)What a mess! Meet me at these coordinates, immediately. I'm providing you with an escort.
                      Boso:
                        *** Squeaking Noise of Worry and Discontent ***
                          -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch20_Dialog_Sightseeing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch20_Boso_Kendai_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$BosoTa, $YakiLeaderActor]"/>
                  <param name="CutsceneKey"       value="[$BosoCutsceneKey, $YakiLeaderCutsceneKey]"/>
                  <param name="Lines"             value="[  [[30226404],[30226405]],
                                                            [[30226406]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[null, Ch20_2_Dialog_Sightseeing_Finished]"/>
                  <!--         
                      Boso:
                        What is this?! A Xenon station? I think we might have already passed one of these earlier.
                        I must say, I am rightly flabbergasted by its intricate entanglement. And such an aggressive colour scheme!
                      Kendai:
                        (reprimanding, impatient)Oi! No sightseeing!
                          -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch20_Dialog_Landing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch20_Kendai_Boso_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$YakiLeaderActor, $BosoTa]"/>
                  <param name="CutsceneKey"       value="[$YakiLeaderCutsceneKey, $BosoCutsceneKey]"/>
                  <param name="Lines"             value="[  [[30226407]],
                                                            [[30226406],[30226407]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[null, null]"/>
                  <!--         
                      Kendai:
                        (sigh of relief, stays serious though)Glad you're reasonable, stranger. I'm adding you to the admission list for my office.
                      Boso:
                        That does sound eerily familiar...
                        I think I will terminate my communications for now and observe quietly.
                          -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch20_Dialog_Office_Entered">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch20_Dialog_Office_Entered_Speak_1">
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$YakiLeaderActor" priority="100">
                      <text line="30226408" comment="(serious)Finally. Come in."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch20_Dialog_Office_Entered_Speak_Finished">
                  <conditions>
                    <event_speak_finished actor="$YakiLeaderActor" line="30226408"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch20_Setup_Yaki_Amplifier">
              <actions>
                <create_object name="$YakiAmplifierStation" macro="macro.xenon_asteroid_02_base_03_macro" sector="$YakiHomeSector" owner="faction.xenon">
                  <safepos value="position.[50605.707031m, 0.000000m, 44402.492188m]"/>
                </create_object>
                <create_position name="$YakiAmplifierPosition" space="$YakiHomeSector" object="$YakiAmplifierStation"/>

                <set_object_name object="$YakiAmplifierStation" page="20102" line="2061" comment="Amplifier Station, overloaded because macro defaults to a more generic {20102,1431}'Xenon Station'"/>
                <set_object_description object="$YakiAmplifierStation" page="20102" line="2062" comment="Amplifier Station Description, overloaded because the macro assumes a generic station and doesn't set it"/>

                <find_object_component name="$YakiAmplifierModules" object="$YakiAmplifierStation" multiple="true" class="class.module"/>
                <do_for_each in="$YakiAmplifierModules" name="$CurrentModule">
                  <set_object_min_hull object="$CurrentModule" exact="100"/>
                </do_for_each>

                <do_all exact="30">
                  <set_value name="$RandomPitch" min="0deg" max="360deg"/>
                  <set_value name="$RandomRoll" min="0deg" max="360deg"/>
                  <create_station name="$XenonAsteroidTurret" macro="macro.asteroid_turret_m_01_macro" sector="$YakiHomeSector" owner="faction.xenon" state="componentstate.operational">
                    <safepos object="$YakiAmplifierStation"/>
                    <rotation pitch="$RandomPitch" roll="$RandomRoll"/>
                  </create_station>
                  <signal_objects object="player.galaxy" param="'init station'" param2="$XenonAsteroidTurret" param3="false" comment="Add control entities."/>
                </do_all>
              </actions>
            </cue>

            <cue name="Ch20_Setup_Yaki_Headquarters">
              <actions>
                <create_position name="$YakiHeadquartersPosition" space="$YakiHomeSector" value="position.[-80000m, 0m, 120000m]"/>
                <signal_cue cue="Setup_Yaki_Leader"/>
              </actions>
              <cues>

                <cue name="Ch20_Make_Yaki_Headquarters_Invulnerable">
                  <conditions>
                    <event_cue_completed cue="Setup_Yaki_Headquarters"/>
                  </conditions>
                  <actions>
                    <set_object_min_hull object="$YakiHeadquarters" exact="100"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch20_Setup_Yaki_Gate_Guard">
              <actions>
                <set_value name="$YakiGuardComposition" exact="[
                            [ macro.ship_yak_s_fighter_01_a_macro, 3 ]
                            ]" />

                <do_all exact="$YakiGuardComposition.count" counter="$m">
                  <do_all exact="$YakiGuardComposition.{$m}.{2}" counter="$a">
                    <create_ship name="$CurrentShip" macro="$YakiGuardComposition.{$m}.{1}" capturable="false" missioncue="namespace" sector="$YakiHomeSector">
                      <owner exact="faction.yaki" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.yaki" tags="tag.fighterpilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <safepos value="position.[153254.671875m, 3475.066895m, 151570.265625m]"/>
                    </create_ship>

                    <create_order id="'Wait'" object="$CurrentShip" default="true"/>

                    <add_to_group groupname="$YakiGuard" object="$CurrentShip"/>
                  </do_all>
                </do_all>
              </actions>
            </cue>

            <cue name="Ch20_Setup_Wingmate_In_Office_Patch_Helper" onfail="cancel">
              <conditions>
                <check_value value="$YakiOfficeWingmateActorPatch?"/>
              </conditions>
              <actions>
                <signal_cue cue="Ch20_Setup_Wingmate_In_Office_v2"/>
              </actions>
            </cue>

            <cue name="Ch20_Setup_Wingmate_In_Office_v2" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_position name="$WingmatePosition" x="-2.5" y="0" z="-4.0"/>
                <create_rotation name="$WingmateRotation" yaw="138deg" />
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $WingmateActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $YakiOfficeRoom,
                                                                                                                                      $rotation = $WingmateRotation,
                                                                                                                                      $position = $WingmatePosition,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Ch20_Disconnect_Wingmate_From_Office">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $WingmateActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Ch20_Setup_Appropriate_Welcome" version="2">
              <actions>
                <set_faction_relation_locked faction="faction.yaki" locked="false"/>
                <!-- Activate the Yaki Diplomat -->
                <run_actions ref="md.Diplomacy.Diplomacy_ActivateFactionLibrary">
                  <param name="Faction" value="faction.yaki"/>
                  <param name="DiplomatCapable" value="true"/>
                  <param name="EventCapable" value="false"/>
                </run_actions>
                <!-- Don't set relations if the player has changed them in the custom gamestart. -->
                <do_if value="faction.yaki.relationto.{faction.player} lt faction.yaki.relation.neutral.mid">
                  <set_faction_relation faction="faction.yaki" otherfaction="faction.player" value="faction.yaki.relation.neutral.mid"/>
                </do_if>
              </actions>
              <delay exact="3s" comment="Let sector name announcement play."/>
              <actions>
                <do_if value="player.ship == $OldYakiShip">
                  <set_value name="$ArrivedInYakiShip"/>
                  <signal_cue cue="Ch20_Dialog_Arrived_With_Yaki_Ship"/>
                </do_if>
                <do_else>
                  <do_if value="player.ship == $ProtectoratePlayerShip">
                    <set_value name="$ArrivedInTerranShip"/>
                  </do_if>
                  <signal_cue cue="Ch20_1_Optional_Gate_Fight"/>
                </do_else>
              </actions>
              <patch sinceversion="2" state="complete">
                <!-- Activate the Yaki Diplomat -->
                <run_actions ref="md.Diplomacy.Diplomacy_ActivateFactionLibrary">
                  <param name="Faction" value="faction.yaki"/>
                  <param name="DiplomatCapable" value="true"/>
                  <param name="EventCapable" value="false"/>
                </run_actions>
              </patch>
              <patch sinceversion="2" state="cancelled">
                <!-- Activate the Yaki Diplomat -->
                <run_actions ref="md.Diplomacy.Diplomacy_ActivateFactionLibrary">
                  <param name="Faction" value="faction.yaki"/>
                  <param name="DiplomatCapable" value="true"/>
                  <param name="EventCapable" value="false"/>
                </run_actions>
              </patch>
            </cue>

            <cue name="Ch20_1_Optional_Gate_Fight">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch20_1_Setup_Xenon_Attackers">
                  <actions>
                    <create_position name="$XenonSpawnPosition" space="$YakiHomeSector" value="position.[154771.453125m, -6363.919922m, 152553.718750m]"/>

                    <run_actions ref="Spawn_Attack_Wave" result="$AttackWave">
                      <param name="AttackTarget"  value="player.ship"/>
                      <param name="Faction"       value="faction.xenon"/>
                      <param name="MissionCue"    value="$MissionCue"/>
                      <param name="Sector"        value="$YakiHomeSector"/>
                      <param name="ShipMacros"    value="[ [ macro.ship_xen_m_corvette_02_a_macro, 1 ],
                                                           [ macro.ship_xen_s_fighter_02_a_macro, 4 ] ]"/>
                      <param name="SpawnPosition" value="$XenonSpawnPosition"/>
                      <param name="AllowOtherTargets" value="true"/>
                    </run_actions>

                    <!-- Prevent negative relation boosts between Xenon and Yaki attackers from influencing the actual faction relations. -->
                    <do_for_each in="$AttackWave" name="$CurrentShip">
                      <set_object_relation_behaviour object="$CurrentShip" disable="true"/>
                    </do_for_each>

                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" text="{30225,1022}" group="$AttackWave" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch20_1_Xenon_Defeated">
                      <conditions>
                        <event_object_destroyed group="$AttackWave"/>
                        <check_value value="$AttackWave.count == 1"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch20_Dialog_Invitation"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch20_1_Select_Initial_Dialog">
                  <actions>
                    <do_if value="$ArrivedInTerranShip?">
                      <signal_cue cue="Ch20_Dialog_Arrived_With_Terran_Ship"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch20_Dialog_Arrived_Without_Ship"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch20_1_Call_Off_Attack_Timer">
                  <delay exact="20s"/>
                  <actions>
                    <do_if value="$CalmedTamatha?">
                      <signal_cue cue="Ch20_Dialog_Tamatha_Recording"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch20_1_Call_Off_Attack_Orders">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$AttackWave.count">
                      <set_value name="$CurrentPlayerShip" exact="player.ship"/>
                      <do_for_each in="$YakiGuard" name="$CurrentShip">
                        <!-- Prevent negative relation boosts between Xenon and Yaki attackers from influencing the actual faction relations. -->
                        <set_object_relation_behaviour object="$CurrentShip" disable="true"/>
                        <cancel_all_orders object="$CurrentShip"/>
                        <create_order id="'Patrol'" object="$CurrentShip" default="true">
                          <param name="space" value="$YakiHomeSector"/>
                        </create_order>
                        <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                          <param name="primarytarget" value="$AttackWave.random"/>
                          <param name="secondarytargets" value="$AttackWave"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                          <param name="allowothertargets" value="false"/>
                        </create_order>
                      </do_for_each>
                    </do_if>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch20_2_Yaki_Leader_Conversation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="Ch20_1_Optional_Gate_Fight.state == cuestate.waiting">
                  <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$YakiLeaderActor" updatebriefing="true"/>
                </do_if>
                <do_else>
                  <set_value name="$CurrentStep" operation="add"/>
                  <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$YakiLeaderActor" insert="true" updatebriefing="true"/>
                </do_else>
              </actions>
              <cues>

                <cue name="Ch20_2_Escort_Orders">
                  <actions>
                    <set_value name="$CurrentPlayerShip" exact="player.ship"/>
                    <do_for_each in="$YakiGuard" name="$CurrentShip">
                      <set_object_relation_behaviour object="$CurrentShip" disable="false"/>
                      <!--<reset_relation_boost object="$CurrentShip" faction="faction.xenon" comment="May have received negative boosts by attacking the Xenon."/>-->
                      <cancel_all_orders object="$CurrentShip"/>
                      <create_order id="'Patrol'" object="$CurrentShip" default="true">
                        <param name="space" value="$YakiHomeSector"/>
                      </create_order>
                      <create_order id="'ProtectShip'" object="$CurrentShip" immediate="true">
                        <param name="target" value="$CurrentPlayerShip"/>
                      </create_order>
                    </do_for_each>
                  </actions>
                </cue>

                <cue name="Ch20_2_Approach_YakiAmplifierStation_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$YakiAmplifierStation"/>
                  <param name="ApproachDistance"  value="100km"/>
                  <param name="SuccessSignalCue"  value="Ch20_2_Sightseeing"/>
                </cue>

                <cue name="Ch20_2_Sightseeing">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch20_Dialog_Sightseeing"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.investigate" text="{30226,4010}" object="$YakiAmplifierStation" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch20_2_Dialog_Sightseeing_Finished">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$YakiLeaderActor" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch20_2_Docked_At_Headquarters">
                  <conditions>
                    <event_object_docked_at container="$YakiHeadquarters"/>
                    <check_value value="event.param == player.ship"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch20_Dialog_Landing"/>
                  </actions>
                </cue>

                <cue name="Ch20_2_Entered_Office">
                  <conditions>
                    <event_object_changed_room object="player.entity" room="$YakiOfficeRoom"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch20_Dialog_Office_Entered"/>
                  </actions>
                </cue>

                <cue name="Ch20_2_Yaki_Leader_Conversation_Section_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$YakiLeaderActor"/>
                      <event_conversation_next_section actor="$YakiLeaderActor" section="yaki_leader_ch20_main"/>
                    </check_any>
                    <check_value value="Ch20_3_Wingmate_Conversation.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="event.name == 'event_conversation_started'">
                      <signal_cue cue="Ch20_Setup_Wingmate_In_Office_v2"/>

                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226409" comment="Well, where do I start? Where would you start, if you were in my place?"/>
                      <do_if value="$ArrivedInYakiShip?">
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226410" comment="(variant 1)You suddenly barge into our system, in a ship that obviously doesn't belong to you..."/>
                      </do_if>
                      <do_elseif value="$ArrivedInTerranShip?">
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226411" comment="(variant 2)You suddenly barge into our system, in a Terran-made warship..."/>
                      </do_elseif>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226412" comment="You're a damn security risk!"/>
                    </do_if>

                    <do_elseif value="event.param2 == 'alive'">
                      <set_value name="$Alive_Asked"/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226413" comment="(sighs)Because you're not the first to arrive here."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226414" comment="(disgusted, spit the word 'scientists')Ever since the realignment of the Gates, we're picking up scrappers, adventurers, scientists."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226415" comment="Maniacs, all of you!"/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226416" comment="But we can't let anyone die out here. There are already far too few of us."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'recruit'">
                      <set_value name="$Recruit_Asked"/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226417" comment="I'm not asking you to join the Yaki. We all have our allegiances."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226418" comment="(stress 'am')But I am asking you to have a closer look, make your rounds, see how we live."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226419" comment="Might just change your perspective."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'place'">
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226420" comment="(mockingly)Oh, have I not made my formal speech yet?."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226421" comment="(mockingly, with pathos, switch to serious after 'freebooting')Welcome to the home of the Yaki, freedom-loving, freebooting and who am I kidding."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226422" comment="What you see here is the last remnant of the Yaki. At least the last that we know of."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226423" comment="When those Gates shut down, two generations ago, my people got stranded here together with the Xenon."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226424" comment="Most died in that first week. A few found hiding spots inside an abandoned outpost."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226425" comment="And then, some star-sent augmentation artists found the solution."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'survive'">
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226426" comment="These things on my face, they're not just for show, you know?"/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226427" comment="I don't exactly know how they function, but they keep the Xenon away... most of the time."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226428" comment="('aug-art' is the art of facial augmentation)But that's not all: This aug-art also lets a few of the most 'gifted' Yaki... do things to the Xenon, prod them here and there."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226429" comment="It doesn't always work, and you've seen what happens when you indulge too much, but it kept us alive."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226430" comment="And so here we are: Pirates to some, abominations to others, and with the Xenon strapped to our back like a damn tumour."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226431" comment="(resigned)Doesn't matter if we stay or leave. Either way, we're fair game."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'obelisk'">
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226432" comment="Good. Then he's no longer a threat."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226433" comment="Don't get me wrong. It's kind of sad that he's gone. He was a good Yaki once."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226434" comment="But the way he plastered himself with those cybernetics, with no regard for his or our safety?"/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226435" comment="There's really only one way this could have ended."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'tamatha'">
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226436" comment="(somber)That's... a real shame."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226437" comment="I can only hope you regret it."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226438" comment="Tamatha left because she saw the end approaching from lightyears away, but she still tried to help us out from a distance."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226439" comment="(sighs)Seems like it caught up with her first."/>
                    </do_elseif>

                    <do_elseif value="event.param2 == 'leave'">
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226440" comment="Damn right I am."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226441" comment="Thanks to that fool Obelisk, the war's already under way."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226442" comment="With you on the loose, there'll at least be one more pilot with a brain... and a conscience, I hope."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226443" comment="Another thing: I called you a stranger earlier, and that was a lie."/>
                      <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226444" comment="There's someone I'd like you to meet."/>
                    </do_elseif>

                    <do_if value="event.param2 != 'leave'" comment="After asking about leaving, the conversation ends.">
                      <do_if value="event.param2 == 'place'">
                        <add_player_choice text="{30226,4033}" section="yaki_leader_ch20_main" choiceparam="'survive'" position="left"/>
                      </do_if>

                      <do_else>
                        <add_player_choice text="{30226,4030}" section="yaki_leader_ch20_main" choiceparam="'alive'" position="top_left"/>

                        <do_if value="$Alive_Asked?">
                          <add_player_choice text="{30226,4031}" section="yaki_leader_ch20_main" choiceparam="'recruit'" position="left"/>

                          <do_if value="$Recruit_Asked?">
                            <add_player_choice text="{30226,4032}" section="yaki_leader_ch20_main" choiceparam="'place'" position="bottom_left"/>
                            <add_player_choice text="{30226,4034}" section="yaki_leader_ch20_main" choiceparam="'obelisk'" position="top_right"/>
                            <do_if value="$FoughtTamatha?">
                              <add_player_choice text="{30226,4035}" section="yaki_leader_ch20_main" choiceparam="'tamatha'" position="right"/>
                            </do_if>
                            <add_player_choice text="{30226,4036}" section="yaki_leader_ch20_main" choiceparam="'leave'" position="bottom_right" highlighted="true"/>
                          </do_if>

                        </do_if>
                      </do_else>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch20_2_Yaki_Leader_Conversation_Finished">
                  <conditions>
                    <event_conversation_finished actor="$YakiLeaderActor"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <speak actor="$WingmateActor" priority="100">
                      <text line="30226401" comment="(serious, as if avoiding eye contact)Hey."/>
                    </speak>

                    <signal_cue cue="Ch20_3_Wingmate_Conversation"/>
                  </actions>
                  <cues>

                    <cue name="Ch20_2_Yaki_Leader_Conversation_Finished_Wingmate_Greeting_Speak_Finished">
                      <conditions>
                        <event_speak_finished actor="$WingmateActor" line="30226401"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                          <param name="Cue" value="Start"/>
                        </run_actions>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch20_3_Wingmate_Conversation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$WingmateActor" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch20_3_Wingmate_Conversation_Started">
                  <conditions>
                    <event_conversation_started actor="$WingmateActor"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226402" comment="Well, this is kind of awkward. Don't know if you were expecting to see me."/>
                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226403" comment="Maybe you were. Maybe that's why you came in the first place."/>
                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226404" comment="(tense)Doesn't matter. What counts is that you're here right now."/>

                    <add_player_choice text="{30226,4037}" section="wingmate_ch20_followup" position="right"/>
                  </actions>
                </cue>

                <cue name="Ch20_3_Wingmate_Conversation_Next_Section">
                  <conditions>
                    <event_conversation_next_section actor="$WingmateActor" section="wingmate_ch20_followup"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226405" comment="That's... not an easy question to answer."/>
                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226406" comment="(obviously lying)I guess I was kind of overwhelmed back there."/>
                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226407" comment="(obviously lying)If you remember, we thought we were hot on a trail and then everything went nova."/>
                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226408" comment="(obviously lying)Orcanic pulled me out when that maniac Obelisk disabled my ship."/>
                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226409" comment="(obviously lying)Been here since then, flying with the Yaki, testing out my powers."/>
                    <add_npc_line speaker="$WingmateActor" hidechoices="true" line="30226410" comment="Meet me outside. We'll talk some more when we're back in our pilot seats."/>
                  </actions>
                </cue>

                <cue name="Ch20_3_Wingmate_Conversation_Finished">
                  <conditions>
                    <event_conversation_finished actor="$WingmateActor"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch20_Disconnect_Wingmate_From_Office"/>
                    <signal_cue cue="Ch20_4_Leave_Yaki_Headquarters"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch20_4_Leave_Yaki_Headquarters">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.undock" object="$YakiHeadquarters" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="CH20_4_Player_Undocked">
                  <conditions>
                    <event_object_undocked_from container="$YakiHeadquarters"/>
                    <check_value value="event.param == player.ship"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch20_Clean_Up"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch20_Clean_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Failsafe. -->
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <do_for_each in="$YakiGuard" name="$CurrentShip">
                  <cancel_all_orders object="$CurrentShip"/>
                  <create_order id="'Patrol'" object="$CurrentShip" default="true">
                    <param name="space" value="$YakiHomeSector"/>
                  </create_order>
                </do_for_each>

                <signal_cue cue="Ch21_Yaki_Station"/>
                <cancel_cue cue="Ch20_Arrival"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch21_Yaki_Station">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $WingmateActor, $MissionCue]" comment="Remove earlier 'disconnect' request, or the actor will disappear from the pilot seat."/>
            <include_actions ref="Setup_Wingmate"/>
            <!-- No need to collapse the briefing here. Not much has happened. -->
          </actions>
          <cues>

            <cue name="Ch21_Dialog_Straight_Talk">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch21_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226411],[30226412],[30226413],[30226414]]"/>
                  <param name="EndSignalCue"      value="Ch21_2_Fly_To_Amplifier_Station"/>
                  <!--
                          All right, time for straight talk.
                          First of all, it's damn good to have you back. I've been waiting for an opportunity, and here it is.
                          Secondly, this place stinks, and we're about to take a real close look at the heap at its centre.
                          (stress "really")And thirdly, it's really good to have you back. Just... wanted to make that clear.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch21_Dialog_Get_Going">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch21_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226415],[30226416]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                          Anyway, we should get going.
                          If you have something on your mind, just comm me.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch21_Dialog_Real_Deal">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch21_Wingmate_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226427],[30226428],[30226429],[30226430],[30226431],[30226432],[30226433],[30226434],[30226435],[30226436],[30226437],[30226438]]"/>
                  <param name="EndSignalCue"      value="Ch21_3_Spawn_Escort"/>
                  <!--
                          OK, we're here. Time to clue you in about the real deal.
                          That over there, my friend, is an amplifier station. The only one under Yaki control.
                          You've seen what heavily augmented Yaki can do with their cybernetics.
                          This thing, if turned on, further increases the strength and range of those Xenon attacks.
                          Orcanic says they need it for their own safety, and as a dead man's switch when the Protectorate inevitably finds and attacks this place.
                          (sighs, gets angry)But she doesn't understand - no, none of them understand!
                          All they're doing is hiding and delaying until they suffocate, or someone like Obelisk snaps and turns this side of the Gate network into a slaughterhouse.
                          In the end, despite all their precautions and with all the technology in the universe, these people have nowhere to go except out and through.
                          This system, this entire situation, is a giant ticking time bomb!
                          There's only one way to stop it once and for all: We have to destroy that amplifier.
                          It's brutal, but Mission Command has trained us to make hard choices.
                          These people have shown me kindness, but I'd trade them all in for the safety of Sol.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch21_Dialog_New_Escort">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch21_Wingmate_Speak_4_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226439],[30226440],[30226441]]"/>
                  <param name="EndSignalCue"      value="Ch21_Clean_Up_Yaki_Investigation_Mission_4"/>
                  <!--
                          I've gathered a handful of fighters who want to stop this downward spiral at once, regardless of their own fate.
                          It's going to take serious preparation to make this work, but you've always kept a cool head when I couldn't.
                          Awaiting your command, wing leader.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch21_1_Listen_To_Wingmate">
              <actions>
                <set_value name="$CurrentStep"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,4011}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch21_1_Trigger_Dialog">
                  <actions>
                    <signal_cue cue="Ch21_Dialog_Straight_Talk"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch21_2_Fly_To_Amplifier_Station">
              <actions>
                <set_value name="$CurrentStep"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.flyto" object="$YakiAmplifierStation" text="{30226,4010}" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch21_2_Trigger_Dialog">
                  <actions>
                    <signal_cue cue="Ch21_Dialog_Get_Going"/>
                  </actions>
                </cue>

                <cue name="Ch21_2_Approach_YakiStation_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$YakiAmplifierStation"/>
                  <param name="ApproachDistance"  value="20km"/>
                  <param name="SuccessSignalCue"  value="Ch21_2_Approach_Complete"/>
                </cue>

                <cue name="Ch21_2_Approach_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch21_2_Wait_For_Conversation_End" checkinterval="1s">
                      <conditions>
                        <check_value value="not player.isinconversation"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch21_3_Investigate_Station"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch21_3_Investigate_Station">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,4011}" object="$YakiAmplifierStation" insert="true" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch21_3_Trigger_Dialog">
                  <actions>
                    <signal_cue cue="Ch21_Dialog_Real_Deal"/>
                  </actions>
                </cue>

                <cue name="Ch21_3_Spawn_Escort">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$YakiEscortComposition" exact="[
                            [ macro.ship_yak_s_fighter_01_a_macro, 30226, 202 ],
                            [ macro.ship_yak_s_fighter_01_a_macro, 30226, 203 ],
                            [ macro.ship_yak_s_fighter_01_a_macro, 30226, 205 ],
                            [ macro.ship_yak_s_fighter_01_a_macro, 30226, 213 ],
                            [ macro.ship_yak_s_fighter_01_a_macro, 30226, 225 ],
                            [ macro.ship_yak_s_fighter_01_a_macro, 30226, 226 ]
                            ]" />
                    <!-- Moon Fang
                         Holy Mackerel
                         Neiro Amsturong
                         Mister Falcon
                         Suspect Orange
                         Rowboat Gorillaman
                         -->

                    <do_all exact="$YakiEscortComposition.count" counter="$m">
                      <create_ship name="$CurrentShip" macro="$YakiEscortComposition.{$m}.{1}" capturable="false" missioncue="namespace" sector="$YakiHomeSector">
                        <owner exact="faction.yaki" overridenpc="true"/>
                        <pilot>
                          <select faction="faction.yaki" tags="tag.fighterpilot"/>
                        </pilot>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                        <safepos value="position.[51019.906250m, 6222.559570m, 43543.472656m]"/>
                      </create_ship>

                      <do_if value="$YakiEscortComposition.{$m}.{2}">
                        <set_object_name object="$CurrentShip" page="$YakiEscortComposition.{$m}.{2}" line="$YakiEscortComposition.{$m}.{3}"/>
                      </do_if>

                      <do_if value="player.ship">
                        <set_value name="$CurrentPlayerShip" exact="player.ship"/>
                        <create_order id="'Patrol'" object="$CurrentShip" default="true">
                          <param name="space" value="$YakiHomeSector"/>
                        </create_order>
                        <create_order id="'ProtectShip'" object="$CurrentShip" immediate="true">
                          <param name="target" value="$CurrentPlayerShip"/>
                        </create_order>
                        <set_object_relation_behaviour object="$CurrentShip" disable="true"/>
                      </do_if>
                      <do_else>
                        <create_order id="'Patrol'" object="$CurrentShip" default="true">
                          <param name="space" value="$YakiHomeSector"/>
                        </create_order>
                      </do_else>

                      <add_to_group groupname="$YakiEscort" object="$CurrentShip"/>
                    </do_all>

                    <signal_cue cue="Activate_Yaki_Escort_Handlers"/>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,4012}" group="$YakiEscort" insert="true" updatebriefing="true"/>
                  </actions>
                  <delay exact="3s"/>
                  <actions>

                    <signal_cue cue="Ch21_Dialog_New_Escort"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch21_Clean_Up_Yaki_Investigation_Mission_4">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Cleaning up Yaki Investigation mission 4.'" chance="$DebugChance"/>

                <set_object_min_hull object="$YakiHeadquarters" exact="0"/>

                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.yaki" title="{30226,4001}" text="{30226,4004}"/>

                <signal_cue cue="Ch22_Decide_Outcome"/>
                <cancel_cue cue="Ch21_Yaki_Station"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Mission 8 (Yaki Mission 5) -->

        <cue name="Ch22_Decide_Outcome">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_mission_thread cue="$MissionCue" name="{30226,5001}" description="{30226,5002}" rewardtext="{30226,5003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.player" difficulty="level.hard" abortable="false" threadtype="parallel" icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name"/>
            <signal_cue cue="Activate_Yaki_Home_Sector_Defence"/>
            <set_value name="$StopYakiHeadquartersSpawn" comment="From this point onward, if the Yaki lose all stations, the mission ends."/>
          </actions>
          <cues>

            <!-- Inform Secret Service Mission Dialog Cues -->
            <cue name="Ch22_Dialog_Inform_Mission_Insane">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226501],[30226502],[30226503],[30226504]]"/>
                  <param name="EndSignalCue"      value="Ch22_A_2_Inform_Secret_Service"/>
                  <!--
                          (outraged)Is she insane? She can't possibly think that we would ever ally ourselves with her against the Protectorate!
                          (thoughtful)Actually, now that I think about it...
                          (more firmly)If these pieces of human trash are already contemplating genocide to save themselves, there's no reason we shouldn't do the same.
                          (determined)Yeah, you know what? Let's tell Mission Command about this whole mess. Get the Terran navy to warm up the big guns.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Inform_Mission_Hold_Up_There">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Dal_Wingmate_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$DalBusta, $WingmateActor, $DalBusta, $WingmateActor]"/>
                  <param name="CutsceneKey"       value="[$DalCutsceneKey, $WingmateCutsceneKey, $DalCutsceneKey, $WingmateCutsceneKey]"/>
                  <param name="Lines"             value="[  [[30227132],[30226501]],
                                                            [[30226505]],
                                                            [[30226502],[30226503],[30226504],[30226505],[30226506],[30226507],[30226508]],
                                                            [[30226506],[30226507]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[null, null, null, Ch22_A_2_Enable_Secret_Service_Conversation]"/>
                  <!--         
                      Dal:
                        (Urgent tone, interrupts conversation)Woah, hold up a minute there, partner!
                        (urgently)There's more to this than meets the eye!
                      Wingmate:
                        (dumbfounded)What the...? Who's this joker?
                      Dal:
                        (proud)Allow me to introduce myself: Dal Busta, political analyst, private tutor and bon vivant extraordinaire.
                        (musing about)Look, if you want these two factions at each others' throats right this instant, who am I to judge?
                        (musing about)Nobody likes pirates, and helping the Terrans wipe out the Yaki would certainly put an end to their shenanigans.
                        (musing about, then becoming serious again)All it will take is for someone to inform your precious Mission Command about this dire threat... but what if you tell them the exact opposite?
                        No Yaki threat, no Terran military response, no fuel for the Yaki hard-liners. It all unravels and the Yaki are back to square one.
                        Who knows, they might even end up needing some outside help with their Xenon problem.
                        (mischievous)I'll leave you two alone with your thoughts.
                      Wingmate:
                        (incredulous)I... honestly don't know what to think.
                        (incredulous)Your choice, I guess.
                          -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Inform_Mission_Ethically_Challenged">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Boso_Wingmate_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$BosoTa, $WingmateActor]"/>
                  <param name="CutsceneKey"       value="[$BosoCutsceneKey, $WingmateCutsceneKey]"/>
                  <param name="Lines"             value="[  [[30226501]],
                                                            [[30226508]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[null, Ch22_A_2_Enable_Secret_Service_Conversation]"/>
                  <!--         
                      Boso:
                        (meek)Please, my ethically challenged assistants, consider the immeasurable suffering this may bring upon these poor people.
                      Wingmate:
                        (determined, dismissive)Shut up, squid. Nobody invited you.
                          -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Inform_Mission_Secret_Service_Reward">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Secret_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30226514],[if $KeptYakiSecret? then 30226515 else 30226516],[30226517],[30226518]]"/>
                  <param name="EndSignalCue"      value="Ch22_D_1_Update_Objective"/>
                  <!--
                      Delilah:
                          Another thing, operative.
                          (variant 1; "Intervention is shorthand for the "Intervention Corps")Intervention let me know that the ship that's been anchoring in front of our HQ is not actually an attempt at intimidation, but simply a decommissioned heap of scrap.
                          (variant 2; "Intervention is shorthand for the "Intervention Corps")Intervention has gracefully provided us with a military asset, should we deign to support their upcoming operation. A decommissioned model by the looks of it.
                          It may require a few finishing touches to become fully functional again, but I'm sure you can make use of it.
                          I'll transmit the ship's location to you. Consider it a reward for your efforts.
                            -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Inform_Mission_Nice_Choice_Amplifier_Destroyed_Variant">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226509]]"/>
                  <param name="EndSignalCue"      value="Ch22_A_3_Handover"/>
                  <!--
                      Wingmate:
                          (jubilant)Nice choice! Those Yaki won't know what hit them.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Inform_Mission_Nice_Choice_Amplifier_Operational_Variant">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226509],[30226510],[30226511]]"/>
                  <param name="EndSignalCue"      value="Ch22_A_3_Handover"/>
                  <!--
                      Wingmate:
                          (jubilant)Nice choice! Those Yaki won't know what hit them.
                          (smug)No, I mean it. They have no idea what you just did, and I'm certainly not going to tell them.
                          (rubbing his hands)That upcoming invasion will be the perfect opportunity to take down the amplifier station.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Inform_Mission_Invasion_Fleet_Approaching" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Secret_Service_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30226519],[30226520]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Delilah:
                          Operative, the Intervention Corps just signalled that their fleet is approaching the Yaki base.
                          If you wish to contribute to the war effort and reap the spoils, now is the time to engage.
                            -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Inform_Mission_Intervention_Corps_Reward">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Secret_Service_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30226521],[30226522],[30226523],[30226524]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Delilah:
                          Excellent work, operative! Commander Lee has personally requested a commendation for your efforts. That smug little rat.
                          He also insisted that you be the first to... rummage around in the battlefield debris, to put it politely.
                          Coming from him, that almost sounds like an exclusive honour. You may find a few useful pieces of scrap out there.
                          I'll mark the location for you.
                            -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Inform_Mission_Dubious_Choice_Amplifier_Operational_Variant">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_4_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226512],[30226513]]"/>
                  <param name="EndSignalCue"      value="Ch22_A_3_Handover"/>
                  <!--
                      Wingmate:
                          (doubtful)Well, here's hoping you made the right choice.
                          (worried)That amplifier station certainly won't be easy to take down without Protectorate support.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Inform_Mission_Dubious_Choice_Amplifier_Destroyed_Variant">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_5_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226512],[30226514]]"/>
                  <param name="EndSignalCue"      value="Ch22_A_3_Handover"/>
                  <!--
                      Wingmate:
                          (doubtful)Well, here's hoping you made the right choice.
                          You'd better make your way back to the Yaki headquarters and tell Orcanic the good news.
                                                    -->
                </cue>
              </cues>
            </cue>

            <!-- Activate Amplifier Mission Dialog Cues -->

            <cue name="Ch22_Dialog_Amplifier_Mission_Briefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Yaki_Leader_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$YakiLeaderActor"/>
                  <param name="CutsceneKey"       value="$YakiLeaderCutsceneKey"/>
                  <param name="DelayInitial"      value="3s"/>
                  <param name="Lines"             value="[[30226601],[30226602],[30226603],[30226604],[30226605],[30226606],[30226607]]"/>
                  <param name="EndSignalCue"      value="Ch22_B_2_Trail"/>
                  <!--
                      Orcanic:
                          Hello there, pilot.
                          (reproachful)Since you and your friend have already inspected the merchandise, I guess there's nothing else for it.
                          (firmly)It's time to put all our cards on the table. When you've got a moment, have a look at the briefing I just sent you.
                          (eye-rolling, a bit theatrically)And before you flip your hatch: I'm not asking you to betray Earth.("flip your hatch" meaning react angrily)
                          (deliberating, almost mumbling)Well, I guess I am, but, you know, desperate times and all that.
                          (intense)Think about where you want your loyalties to lie. Mull it over, consider all possible consequences.
                          (a bit warmer)You're not the first to attempt this mission, but you might just have a shot at success.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Doubts_No_Dal">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Boso_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                  <param name="Lines"             value="[[30226601],[30226602]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Boso:
                        (meek)Oh my goodness. You certainly are an obedient and meticulous assistant, but I worry that you may have been led astray.
                        (gathering confidence)I implore you to listen to your circulatory organs and maybe reconsider what you are setting out to do.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Doubts_Dal_Variant">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Boso_Dal_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$BosoTa, $DalBusta]"/>
                  <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey]"/>
                  <param name="Lines"             value="[  [[30226601],[30226602]],
                                                            [[30226601],[30226602],[30226603]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[null, null]"/>
                  <!--         
                      Boso:
                        (meek)Oh my goodness. You certainly are an obedient and meticulous assistant, but I worry that you may have been led astray.
                        (gathering confidence)I implore you to listen to your circulatory organs and maybe reconsider what you are setting out to do.
                      Dal:
                        (eager; interjects)No, no, no! I respect your compassion, dear Boso, but this is a matter far beyond ethical considerations.
                        (addressing the player)You, my friend, have to ask yourself: Will your actions cause a great loss of military equipment? Could you potentially profit from that loss? And, most importantly, would you get away with it?
                        (smug)If I may be so bold, the answer to all of those questions is obviously a resounding "yes".
                          -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Wingmate_Notices">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_7_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226601],[30226602],[30226603],[30226604],[30226605],[30226606]]"/>
                  <param name="EndSignalCue"      value="Ch22_B_3_Intercept_Wingmate"/>
                  <!--
                      Wingmate:
                          (puzzled)Uh, hey, sorry for interrupting... whatever it is that you're doing out there.
                          (puzzled)The amplifier station is broadcasting that it's somehow been armed, and that can't be true.
                          (puzzled)I mean, I know what might theoretically cause this reaction. I did get a weird mission briefing from Orcanic once but I haven't even...
                          (realisation kicking in)Wait a minute. It was you! You actually went along with that crazy woman's plan!
                          (furious)Can you even conceive what you've just done? What you've done to Sol?
                          (disgusted)I can't believe it. Screw these cybernetics, let the Terran police shoot me if they dare! I'm done with all of you!
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Boso_Warning_No_Dal">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Boso_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                  <param name="Lines"             value="[[30226603],[30226604]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Boso:
                        (shocked)Oh, dear! He appears to be making his way towards the Terran Secret Service Headquarters!
                        (urgent)I do understand his frustration, but at this rate, my assistant is going to be in trouble!
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Boso_Warning_Dal_Variant">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Boso_Dal_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$BosoTa, $DalBusta]"/>
                  <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey]"/>
                  <param name="Lines"             value="[  [[30226603],[30226604]],
                                                            [[30226604],[30226605]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[null, null]"/>
                  <!--         
                      Boso:
                        (shocked)Oh, dear! He appears to be making his way towards the Terran Secret Service Headquarters!
                        (urgent)I do understand his frustration, but at this rate, my assistant is going to be in trouble!
                      Dal:
                        (dead serious)You've made your choice and he's made his.
                        (dead serious)Show him the consequences of crossing you.
                          -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Secret_Service_Reached">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Secret_Service_Speak_4_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30226601],[30226602],[30226603]]"/>
                  <param name="EndSignalCue"      value="Ch22_B_3_Wingmate_Arrived_Dialog_Finished_v2"/>
                  <!--
                      Delilah:
                          (serious)Operative.
                          (serious)It has come to my attention that I may have chosen my subordinates... poorly.
                          (serious)Consider your contract terminated. And, should you enter Protectorate space again, the same will apply to you.
                            -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Wingmate_Attacked">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_12_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226607]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Wingmate:
                          (furious)You're despicable! And to think I've trusted you!
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Wingmate_Killed">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_13_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226608]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Wingmate:
                          (furious, in tears)After everything we've been through! I thought we were friends!
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Boso_Return_Hint">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Boso_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                  <param name="Lines"             value="[[30226605]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Boso:
                        (sulky)How very unpleasant. Maybe you should pay your new Yaki friends another visit to see what you have wrought.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Dal_Options">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Dal_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30227132],[30226606],[30226607],[30226608],[30226609]]"/>
                  <param name="EndSignalCue"      value="Ch22_B_6_Big_Button"/>
                  <!--
                      Boso:
                        (Urgent tone, interrupts conversation)Woah, hold up a minute there, partner!
                        The most obvious thing to do would be to coordinate your own attack against the Terran Protectorate with the surge in Xenon activity.
                        You could, however, also go in an entirely different direction. After all, without the Xenon around, these Yaki will be an easy target for expansion.
                        Or, if you're altruistically inclined, you could take that opportunity to destroy the Xenon stations in the system while their defenders are abroad.
                        As I said, there are many ways you could profit from this. The choice is yours.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Amplifier_Mission_Button_Available_Again">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Yaki_Leader_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$YakiLeaderActor"/>
                  <param name="CutsceneKey"       value="$YakiLeaderCutsceneKey"/>
                  <param name="Lines"             value="[[30226601],[30226625],[30226626]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Orcanic:
                          Hello there, pilot.
                          I thought you might be interested to hear that our local Xenon density is approaching nominal levels again.
                          We're ready for another activation of the amplifier. Just give the signal.
                                                    -->
                </cue>
              </cues>
            </cue>

            <!-- Freedom Mission Dialog -->

            <cue name="Ch22_Dialog_Freedom_Mission_Attack_Warning">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_8_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226701]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Wingmate:
                          (warning)The Yaki don't like this one bit! Here they come! 
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Leave_Sector">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Yaki_Leader_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$YakiLeaderActor"/>
                  <param name="CutsceneKey"       value="$YakiLeaderCutsceneKey"/>
                  <param name="Lines"             value="[[30226701]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Orcanic:
                          (furious)What have you done? That station was our lifeline!
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Get_Out">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Yaki_Leader_Speak_6_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$YakiLeaderActor"/>
                  <param name="CutsceneKey"       value="$YakiLeaderCutsceneKey"/>
                  <param name="Lines"             value="[[30226702]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Orcanic:
                          (whispering loudly)Get out of the system now, or I can't ensure your safety.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Discussion_Standard_Variant">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Yaki_Leader_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$WingmateActor, $YakiLeaderActor, $WingmateActor, $YakiLeaderActor, $WingmateActor, $YakiLeaderActor, $WingmateActor]"/>
                  <param name="CutsceneKey"       value="[$WingmateCutsceneKey, $YakiLeaderCutsceneKey, $WingmateCutsceneKey, $YakiLeaderCutsceneKey, $WingmateCutsceneKey, $YakiLeaderCutsceneKey, $WingmateCutsceneKey]"/>
                  <param name="Lines"             value="[  [[30226702],[30226703],[30226704]],
                                                            [[30226703],[30226704]],
                                                            [[30226705],[30226706],[30226707]],
                                                            [[30226705],[30226706],[30226707]],
                                                            [[30226708],[30226709]],
                                                            [[30226708],[30226709],[30226710],[30226711]],
                                                            [[30226710],[30226711],[30226712]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[null, null, null, null, null, null, Ch22_C_3_Keep_Yaki_Secret]"/>
                  <!--
                    Wingmate:
                      (sighs to release pent-up tension)That... wasn't exactly unexpected.
                      (hesitant)Let's see if we can get her to talk to us.
                      (shouting over comms)Orcanic! Orcanic, are you there? We don't have to part like this.
                    Orcanic:
                      (initial pause, then trenchant)What do you want?
                      (angry, intense)I've got every single Yaki hard-liner banging at my door, demanding my head, because of you fools! Be glad that I held them back from hunting you down!
                    Wingmate:
                      (starts reassuringly, builds momentum)Yeah, yeah, we're very sorry about that, but you didn't honestly expect a plan like that to work, did you?
                      (serious)Listen, you've got to understand that this entire project was bound to fail. All it did was keep you holed up in your system, with no bright spot to light up your miserable existence.
                      (reproachful)You put a gun to the Gate network's head and expected no pushback?
                    Orcanic:
                      (bitter)You have no idea what you're talking about.
                      (bitter)Do you think that taking away the best protection we had against the Terran scourge would somehow give us hope? How delusional can you be?
                      (serious)You know your people best. No threat short of total annihilation would keep them from scouring the entire Gate network to subjugate or eradicate everyone who dares to oppose them.
                    Wingmate:
                      (annoyed)No, you've got it backwards! Can't you see that? If they'd learned of a threat like the one we just wiped out, they'd have had no choice but to retaliate!
                      (reassuring)Now there's at least some chance of a peaceful solution. We only have to talk to the right people.
                    Orcanic:
                      (bitter laugh)As if that's going to happen! The moment you step back into their ranks, you're going to tell them that we're here, and that we're vulnerable.
                      (smug)And then your dutiful superiors are going to suspend you, lock you up, put you under surveillance.
                      (bitter)You're an abomination now, just like us. It's time for you to face reality. You have nowhere to go.
                      (dismissive)Make your choice. I'm done with you.
                    Wingmate:
                      (short pause, then demotivated)Uh, that hit far too close to home.
                      She's right, I can't show myself. You'll have to be our envoy.
                      (determined)There's no time to waste. Go and make the right decision. I trust your instincts.
                          -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Discussion_Prepared_Variant">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Yaki_Leader_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$WingmateActor, $YakiLeaderActor, $WingmateActor, $YakiLeaderActor, $WingmateActor, $YakiLeaderActor]"/>
                  <param name="CutsceneKey"       value="[$WingmateCutsceneKey, $YakiLeaderCutsceneKey, $WingmateCutsceneKey, $YakiLeaderCutsceneKey, $WingmateCutsceneKey, $YakiLeaderCutsceneKey]"/>
                  <param name="Lines"             value="[  [[30226713]],
                                                            [[30226713]],
                                                            [[30226706],[30226707]],
                                                            [[30226705],[30226706],[30226707]],
                                                            [[30226714],[30226715]],
                                                            [[30226714],[30226715]]
                                                                                      ]"/>
                  <param name="EndSignalCue"      value="[null, null, null, null, null, Ch22_C_4_Return_To_Yaki]"/>
                  <!--
                    Wingmate:
                      (urgent)Stop! Stop your lackeys, Orcanic! This is one gigantic misunderstanding!
                    Orcanic:
                      (intense)Explain yourself. Now.
                    Wingmate:
                      (serious)Listen, you've got to understand that this entire project was bound to fail. All it did was keep you holed up in your system, with no bright spot to light up your miserable existence.
                      (reproachful)You put a gun to the Gate network's head and expected no pushback?
                    Orcanic:
                      (bitter)You have no idea what you're talking about.
                      (bitter)Do you think that taking away the best protection we had against the Terran scourge would somehow give us hope? How delusional can you be?
                      (serious)You know your people best. No threat short of total annihilation would keep them from scouring the entire Gate network to subjugate or eradicate everyone who dares to oppose them.
                    Wingmate:
                      (urgent)But they don't know! You understand me? They have no idea you're here!
                      (confident)In fact, they now believe that your Yaki are an unorganised bunch without a base. For the time being, nobody's going to bother you here.
                    Orcanic:
                      (in thought)Forgive me, but that is a lot to take in.
                      (gathering herself)I think we should have a talk in private. I'll try to calm the hard-liners down until we've sorted this out.
                          -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Discussion_Prepared_Variant_Patch_While_Running" onfail="cancel">
              <conditions>
                <check_value value="Ch22_Wingmate_Yaki_Leader_Speak_2_Ref.state == cuestate.complete"/>
              </conditions>
              <cues>
                <cue name="Ch22_Dialog_Freedom_Mission_Discussion_Prepared_Variant_Patch_Cancel_Event">
                  <conditions>
                    <event_cue_cancelled cue="Ch22_Wingmate_Yaki_Leader_Speak_2_Ref"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch22_C_4_Return_To_Yaki"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Discussion_Prepared_Variant_Patch_After_Cancel" onfail="cancel">
              <conditions>
                <check_value value="Ch22_Wingmate_Yaki_Leader_Speak_2_Ref.state == cuestate.cancelled"/>
                <check_value value="Ch22_C_4_Return_To_Yaki.state == cuestate.waiting"/>
              </conditions>
              <actions>
                <signal_cue cue="Ch22_C_4_Return_To_Yaki"/>
              </actions>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Enter_Sector_Warning">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Yaki_Leader_Speak_4_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$YakiLeaderActor"/>
                  <param name="CutsceneKey"       value="$YakiLeaderCutsceneKey"/>
                  <param name="Lines"             value="[[30226712]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Orcanic:
                          You've been warned. Don't expect me to lift a finger to stop them.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Return_To_Yaki_Space">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_9_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226716]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Wingmate:
                          (urgent)Come on, just take a leap of faith. I know these people well enough. They'll see reason. Eventually.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Enter_Yaki_Home_Sector">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Yaki_Leader_Speak_5_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$YakiLeaderActor"/>
                  <param name="CutsceneKey"       value="$YakiLeaderCutsceneKey"/>
                  <param name="Lines"             value="[[30226716],[30226717]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Orcanic:
                          (intrigued)A little gullish("gullish" German translation: Möwische) told me that the gaze of the Terran Protectorate might have been turned away from us for the time being.
                          (intrigued)Come in, come in!
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Outro_No_Dal">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_10_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226718],[30226719],[30226720]]"/>
                  <param name="EndSignalCue"      value="Ch22_C_Clean_Up_Mission"/>
                  <!--
                      Wingmate:
                          (impressed; addressing the player privately)Well, look how that turned out.
                          (content)To me it seems like we've done enough good deeds for one lifetime.
                          (half-joking)And since you seem to have things under control, I guess I'll subject myself to your command now, wing leader.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch22_Dialog_Freedom_Mission_Outro_Dal_Known">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch22_Wingmate_Speak_11_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$WingmateActor"/>
                  <param name="CutsceneKey"       value="$WingmateCutsceneKey"/>
                  <param name="Lines"             value="[[30226717],[30226719],[30226720]]"/>
                  <param name="EndSignalCue"      value="Ch22_C_Clean_Up_Mission"/>
                  <!--
                      Wingmate:
                          (interrupts conversation; chuckling)Let's leave those two alone for a while.
                          (content)To me it seems like we've done enough good deeds for one lifetime.
                          (half-joking)And since you seem to have things under control, I guess I'll subject myself to your command now, wing leader.
                                                    -->
                </cue>
              </cues>
            </cue>

            <!-- ID Range 6000-->
            <cue name="Ch22_A_Inform_Terran_Fleet" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$SubMissionCue_A" exact="this"/>
                <create_mission cue="$SubMissionCue_A" name="{30226,6001}" description="{30226,6002}" rewardtext="{30226,6003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.terran" difficulty="level.easy" abortable="false" missionthread="$MissionCue" activate="true" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.name"/>
              </actions>
              <patch sinceversion="2" state="waiting">
                <do_if value="$AmplifierDestroyed?">
                  <signal_cue cue="this"/>
                </do_if>
              </patch>
              <cues>

                <cue name="Ch22_A_1_Intro">
                  <actions>
                    <set_value name="$CurrentStep_A"/>
                    <set_objective cue="$SubMissionCue_A" step="$CurrentStep_A" action="objective.custom" customaction="{30226,4011}" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_A_1_Trigger_Dialog">
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Inform_Mission_Insane"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_A_2_Inform_Secret_Service">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_A" operation="add"/>
                    <set_objective cue="$SubMissionCue_A" step="$CurrentStep_A" action="objective.talkto" object="$SecretServiceActor" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_A_2_Trigger_Dialog">
                      <actions>
                        <do_if value="$DalBusta?">
                          <signal_cue cue="Ch22_Dialog_Inform_Mission_Hold_Up_There"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch22_Dialog_Inform_Mission_Ethically_Challenged"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch22_A_2_Enable_Secret_Service_Conversation">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch22_A_2_Secret_Service_Conversation_Header" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$SecretServiceActor"/>
                          </conditions>
                          <actions>
                            <add_player_choice text="{30226,6030}" section="section_ch22_secret_service_1"/>
                          </actions>
                        </cue>

                        <cue name="Ch22_A_2_Secret_Service_Conversation_Section_1" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$SecretServiceActor" section="section_ch22_secret_service_1"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226501" comment="(intrigued)So, what's the status of the investigation?"/>

                            <add_player_choice text="{30226,6031}" section="section_ch22_secret_service_2" choiceparam="'more_time'" position="left"/>
                            <add_player_choice text="{30226,6032}" section="section_ch22_secret_service_2" choiceparam="'conclusion'" position="right"/>
                          </actions>
                        </cue>

                        <cue name="Ch22_A_2_Secret_Service_Conversation_Section_2" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$SecretServiceActor" section="section_ch22_secret_service_2"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <do_if value="event.param2 == 'more_time'">
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226502" comment="Take all the time you need. We can't afford to mess this up, or we'll be the laughing stock of the entire Protectorate."/>
                            </do_if>

                            <do_elseif value="event.param2 == 'conclusion'">
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226503" comment="(eager)Excellent! Then tell me, are these Yaki an organised threat to the Protectorate? Do they have a base of operations that we can target?"/>

                              <add_player_choice text="{30226,6033}" section="section_ch22_secret_service_3" choiceparam="'yes'" position="top_right" highlighted="true"/>
                              <add_player_choice text="{30226,6034}" section="section_ch22_secret_service_3" choiceparam="'no'" position="bottom_right" highlighted="true"/>
                              <add_player_choice text="{30226,6035}" section="section_ch22_secret_service_3" choiceparam="'second_thought'" position="left"/>
                            </do_elseif>
                          </actions>
                        </cue>

                        <cue name="Ch22_A_2_Secret_Service_Conversation_Section_3" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$SecretServiceActor" section="section_ch22_secret_service_3"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <do_if value="event.param2 == 'yes'">
                              <set_value name="$ToldTerransAboutYaki"/>
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226504" comment="(excited)Outstanding work, operative! I will relay this intel to Intervention right away."/>
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226505" comment="(smug)Those overblown grunts will finally see the importance of the work we do.('overblown grunts' meaning self-important military people)"/>
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226506" comment="If you want to participate, you'd better prepare for action. "/>
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226507" comment="Once the Protectorate forces are under way, I'll mark their position for you."/>
                            </do_if>

                            <do_elseif value="event.param2 == 'no'">
                              <set_value name="$KeptYakiSecret"/>
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226508" comment="(relieved)I see. That conclusion does match our observations. These pirates behave far too erratically."/>
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226509" comment="In that case, I will attempt to sway Intervention to tone down their war preparations and instead get an anti-pirate task force under way."/>
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226510" comment="(proud)Again, excellent work, operative. You've done Sol a great service."/>
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226511" comment="(somber)My only regret is that we haven't found out what happened to Cadet Shinamon."/>
                            </do_elseif>

                            <do_elseif value="event.param2 == 'second_thought'">
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226512" comment="(worried)Are you all right, operative?"/>
                              <add_npc_line speaker="$SecretServiceActor" hidechoices="true" line="30226513" comment="(warningly)Don't get ahead of yourself. This matter is far too important to jump to conclusions."/>
                            </do_elseif>
                          </actions>
                        </cue>

                        <cue name="Ch22_A_2_Secret_Service_Conversation_Finished" instantiate="true">
                          <conditions>
                            <event_conversation_finished actor="$SecretServiceActor"/>
                          </conditions>
                          <actions>
                            <do_if value="$ToldTerransAboutYaki? or $KeptYakiSecret?">
                              <signal_cue cue="Ch22_A_3_Epilogue"/>
                            </do_if>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_A_3_Epilogue">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_A" operation="add"/>
                    <set_objective cue="$SubMissionCue_A" step="$CurrentStep_A" action="objective.custom" customaction="{30226,6010}" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_A_3_Trigger_Wingmate_Reaction_Dialog">
                      <actions>
                        <do_if value="$ToldTerransAboutYaki?">
                          <unlock_achievement name="COH_PLOT_YAKI_1"/>

                          <signal_cue cue="Ch22_E_Terran_Invasion"/>

                          <!-- Variant 1: The Amplifier is already destroyed, so the reconciliation mission ends now. -->
                          <do_if value="$AmplifierDestroyed?">
                            <signal_cue cue="Ch22_C_Clean_Up_Mission"/>

                            <do_if value="$WingmateBetrayed?">
                              <signal_cue cue="Ch22_A_3_Handover"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch22_Dialog_Inform_Mission_Nice_Choice_Amplifier_Destroyed_Variant"/>
                            </do_else>
                          </do_if>

                          <!-- Variant 2: The Terran fleet is on the way, so once the Amplifier gets destroyed, the mission ends. -->
                          <do_else>
                            <do_if value="$WingmateBetrayed?">
                              <signal_cue cue="Ch22_A_3_Handover"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch22_Dialog_Inform_Mission_Nice_Choice_Amplifier_Operational_Variant"/>
                            </do_else>
                          </do_else>
                        </do_if>

                        <do_else>
                          <unlock_achievement name="COH_PLOT_YAKI_2"/>

                          <!-- Variant 3: The player already destroyed the Amplifier and has now chosen to keep the Yaki HQ secret and reconcile with them. -->
                          <do_if value="$AmplifierDestroyed?">
                            <signal_cue cue="Ch22_C_4_Return_To_Yaki"/>

                            <do_if value="$WingmateBetrayed?">
                              <signal_cue cue="Ch22_A_3_Handover"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch22_Dialog_Inform_Mission_Dubious_Choice_Amplifier_Destroyed_Variant"/>
                            </do_else>
                          </do_if>

                          <!-- Variant 4: The player has kept the Yaki HQ secret, so once he destroys the amplifier, the mission will skip ahead to the peaceful conclusion. -->
                          <do_else>
                            <do_if value="$WingmateBetrayed?">
                              <signal_cue cue="Ch22_A_3_Handover"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch22_Dialog_Inform_Mission_Dubious_Choice_Amplifier_Operational_Variant"/>
                            </do_else>
                          </do_else>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch22_A_3_Handover">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch22_D_Secret_Service_Reward"/>
                        <signal_cue cue="Ch22_A_Clean_Up_Mission"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_A_Clean_Up_Mission">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_cue_cancelled cue="Setup_Yaki_Leader" comment="This cue gets cancelled if the Yaki lose all their stations."/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="$ToldTerransAboutYaki?">
                      <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.1" reason="relationchangereason.missioncompleted"/>
                      <write_to_logbook category="missions" faction="faction.terran" title="{30226,6001}" text="{30226,6004}"/>
                      <remove_mission cue="$SubMissionCue_A" type="completed"/>
                    </do_if>
                    <do_elseif value="$KeptYakiSecret?">
                      <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.1" reason="relationchangereason.missioncompleted"/>
                      <write_to_logbook category="missions" faction="faction.terran" title="{30226,6001}" text="{30226,6005}"/>
                      <remove_mission cue="$SubMissionCue_A" type="completed"/>
                    </do_elseif>
                    <do_else>
                      <!-- This can happen if the Wingmate tells the Terrans about the player's betrayal, or if the Yaki get wiped out. -->
                      <write_to_logbook category="missions" faction="faction.terran" title="{30226,6001}" text="{30226,6006}"/>
                      <remove_mission cue="$SubMissionCue_A" type="failed"/>
                    </do_else>

                    <cancel_cue cue="Ch22_A_Inform_Terran_Fleet"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <!-- ID Range 7000-->
            <cue name="Ch22_B_Deploy_Yaki_Beacons">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$SubMissionCue_B" exact="this"/>
                <create_mission cue="$SubMissionCue_B" name="{30226,7001}" description="{30226,7002}" rewardtext="{30226,7003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.yaki" difficulty="level.easy" abortable="false" missionthread="$MissionCue" activate="true" icon="'briefing_kendai_orcanic_01'" iconcaption="$YakiLeaderActor.name"/>
              </actions>
              <cues>

                <cue name="Ch22_B_1_Briefing">
                  <actions>
                    <set_value name="$CurrentStep_B"/>
                    <set_objective cue="$SubMissionCue_B" step="$CurrentStep_B" action="objective.custom" customaction="{30226,7010}" insert="true" updatebriefing="true" silent="false"/>

                    <activate_mission cue="$SubMissionCue_B"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_B_1_Trigger_Dialog">
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Briefing"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_B_2_Trail">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <show_help line="835" position="1" force="true" comment="The current mission now contains multiple parallel sub-missions. You can track the status of each in the MISSION MANAGER tab of your map menu." allowclose="true" timeout="false"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_B_2_Trigger_Mission_A">
                      <delay exact="10s"/>
                      <actions>
                        <!-- Shortly after the player receives Orcanic's mission briefing, the Wingmate chimes in with his own plan. -->
                        <signal_cue cue="Ch22_A_Inform_Terran_Fleet"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_B_2_Setup_Trail">
                      <actions>
                        <create_list name="$TrailSectorList"/>
                        <set_value name="$TrailSectorMacroList" exact="[macro.cluster_112_sector002_macro, 
                                                                    macro.cluster_48_sector001_macro,
                                                                    macro.cluster_100_sector001_macro,
                                                                    macro.Cluster_101_Sector001_macro,
                                                                    macro.Cluster_102_Sector001_macro,
                                                                    macro.Cluster_104_Sector002_macro,
                                                                    macro.Cluster_104_Sector001_macro]" comment="Savage Spur II, Getsu Fune, Asteroid Belt, Mars, Venus, The Moon, Earth"/>
                        <do_for_each in="$TrailSectorMacroList" name="$CurrentSectorMacro" counter="$i">
                          <find_sector name="this.$sector" macro="$CurrentSectorMacro" required="true"/>
                          <append_to_list name="$TrailSectorList" exact="this.$sector"/>

                          <substitute_text text="$ObjectiveText" source="{30226,7011}">
                            <replace string="'$SECTOR$'" with="this.$sector.knownname"/>
                          </substitute_text>

                          <update_mission cue="$SubMissionCue_B">
                            <briefing>
                              <objective step="$i" action="objective.deploy" text="$ObjectiveText" object="this.$sector" radius="100km"/>
                            </briefing>
                          </update_mission>
                        </do_for_each>

                        <set_objective_from_briefing cue="$SubMissionCue_B" step="1"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_B_2_Beacon_Deployed" instantiate="true">
                      <conditions>
                        <event_navbeacon_launched space="player.galaxy"/>
                        <check_value value="$TrailSectorList.indexof.{@event.param.sector}"/>
                        <check_value value="event.param.trueowner == faction.player"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Nav Beacon in relevant sector deployed. Checking how many we already have.'" chance="$DebugChance"/>
                        <set_value name="$BeaconsDeployed" exact="0"/>
                        <set_value name="$BeaconObjectiveSet" exact="false"/>
                        <do_for_each in="$TrailSectorList" name="$CurrentSector" counter="$i">
                          <find_object name="this.$NavBeacon" class="class.navbeacon" space="$CurrentSector"/>
                          <do_if value="this.$NavBeacon">
                            <set_value name="$BeaconsDeployed" operation="add"/>
                            <debug_text text="'Found Beacon in sector: ' + $CurrentSector.knownname" chance="$DebugChance"/>
                          </do_if>
                          <do_else>
                            <do_if value="not $BeaconObjectiveSet">
                              <set_objective_from_briefing cue="$SubMissionCue_B" step="$i"/>
                              <set_value name="$BeaconObjectiveSet" exact="true"/>
                            </do_if>
                          </do_else>
                        </do_for_each>
                        <do_if value="$BeaconsDeployed ge 3">
                          <do_if value="$DalBusta?">
                            <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Doubts_Dal_Variant" check="false"/>
                          </do_if>
                          <do_else>
                            <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Doubts_No_Dal" check="false"/>
                          </do_else>
                        </do_if>
                        <do_if value="$BeaconsDeployed ge 7">
                          <set_value name="$WingmateBetrayed"/>
                          <signal_cue cue="Ch22_C_Clean_Up_Mission"/>
                          <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Wingmate_Notices"/>
                          <cancel_cue cue="Ch22_B_2_Trail"/>
                        </do_if>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_B_3_Intercept_Wingmate">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_B" exact="8"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_B_3_Trigger_Mentor_Dialog">
                      <actions>
                        <play_music music="'music_dlc_terran_story_yaki_3'"/>

                        <do_if value="$DalBusta?">
                          <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Boso_Warning_Dal_Variant"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Boso_Warning_No_Dal"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch22_B_3_Wingmate_Orders" version="2">
                      <actions>
                        <!-- Remove all special handling of the wingmate. -->
                        <cancel_cue cue="Activate_Wingmate_Handlers"/>
                        <cancel_cue cue="Activate_Yaki_Escort_Handlers"/>

                        <!-- Before creating the ship with the wingmate as pilot, despawn the NPC if he exists. Relevant for when he was placed on a station, and the ship gets spawned the non-conversation way. -->
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $WingmateActor, $MissionCue]"/>

                        <!-- Spawn Wingmate at Yaki wharf. -->
                        <do_if value="$WingmateShip.exists">
                          <warp object="$WingmateShip" sector="$YakiHomeSector">
                            <safepos object="$YakiHeadquarters"/>
                          </warp>
                        </do_if>
                        <do_else>
                          <create_ship name="$WingmateShip" macro="macro.ship_yak_m_corvette_01_a_macro" sector="$YakiHomeSector" missioncue="namespace" capturable="false">
                            <owner exact="faction.yaki" overridenpc="true" />
                            <pilot actor="$WingmateActor"/>
                            <loadout loadout="$WingmateYakiLoadout"/>
                            <equipmentmods>
                              <engine ware="ware.mod_engine_rotationthrust_01_mk3"/>
                              <shield ware="ware.mod_shield_capacity_02_mk3"/>
                              <ship ware="ware.mod_ship_mass_01_mk3"/>
                            </equipmentmods>
                            <safepos object="$YakiHeadquarters"/>
                          </create_ship>
                          <set_object_name object="$WingmateShip" page="30226" line="204" comment="Gumption's Gambit"/>
                        </do_else>

                        <set_object_min_hull object="$WingmateShip" exact="100"/>
                        <set_object_min_shield object="$WingmateShip" exact="100"/>

                        <cancel_all_orders object="$WingmateShip"/>

                        <!-- TODO: Check if this works, and if it persists through attacks. -->
                        <set_relation_boost object="$WingmateShip" faction="faction.terran" value="0.032" decay="0"/>

                        <create_order id="'MoveWait'" object="$WingmateShip" default="true">
                          <param name="destination" value="[$SecretServiceSector, $SecretServiceStationPosition]"/>
                          <param name="noattackresponse" value="true"/>
                        </create_order>

                        <create_order id="'MoveToObject'" object="$WingmateShip">
                          <param name="destination" value="$SecretServiceStation"/>
                          <param name="noattackresponse" value="true"/>
                        </create_order>
                        <!--<create_order id="'DockAndWait'" object="$WingmateShip">
                          <param name="destination" value="$SecretServiceStation"/>
                        </create_order>-->

                        <do_for_each in="$YakiEscort" name="$CurrentShip">
                          <cancel_all_orders object="$CurrentShip"/>
                          <create_order id="'Patrol'" object="$CurrentShip" default="true">
                            <param name="space" value="$YakiHomeSector"/>
                          </create_order>
                          <create_order id="'ProtectShip'" object="$CurrentShip" immediate="true">
                            <param name="target" value="$WingmateShip"/>
                          </create_order>
                          <set_relation_boost object="$CurrentShip" faction="faction.player" value="-1.0" decay="0"/>
                          <set_relation_boost object="$CurrentShip" faction="faction.terran" value="0.032" decay="0"/>
                        </do_for_each>

                        <signal_cue cue="Ch22_B_3_Update_Objective"/>
                      </actions>
                      <patch sinceversion="2">
                        <do_if value="$WingmateActor.object != $WingmateShip">
                          <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $WingmateActor, $MissionCue]"/>
                          <signal_objects object="$WingmateActor" param="'npc_state_reinit'"/>
                        </do_if>
                        <do_if value="Ch22_B_3_Wingmate_Arrived_v2.state == cuestate.disabled">
                          <debug_text text="'reset approach cue'"/>
                          <reset_cue cue="Ch22_B_3_Approach_SecretServiceStation_Ref"/>
                        </do_if>
                      </patch>
                      <cues>

                        <cue name="Ch22_B_3_Approach_SecretServiceStation_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                          <param name="ApproachObject"    value="$WingmateShip"/>
                          <param name="ApproachTarget"    value="$SecretServiceStation"/>
                          <param name="ApproachDistance"  value="10km"/>
                          <param name="SuccessSignalCue"  value="Ch22_B_3_Wingmate_Arrived_v2"/>
                        </cue>

                        <cue name="Ch22_B_3_Disable_Wingmate_Relation_Behaviour" comment="Prevent reputation hit for kill.">
                          <conditions>
                            <event_object_hull_damaged object="$WingmateShip" check="false"/>
                            <check_value value="$WingmateShip.hullpercentage le 25"/>
                          </conditions>
                          <actions>
                            <set_object_relation_behaviour object="$WingmateShip" disable="true"/>
                          </actions>
                        </cue>

                        <cue name="Ch22_B_3_Wingmate_Attacked_v2">
                          <conditions>
                            <event_object_attacked object="$WingmateShip"/>
                            <check_value value="event.param.trueowner == faction.player"/>
                          </conditions>
                          <actions>
                            <set_object_min_hull object="$WingmateShip" exact="0"/>
                            <set_object_min_shield object="$WingmateShip" exact="0"/>
                            <set_value name="$WingmateAttacker" exact="event.param"/>
                            <signal_cue cue="Ch22_B_4_Defeat_Wingmate" check="false"/>
                          </actions>
                        </cue>

                        <cue name="Ch22_B_3_Wingmate_Arrived_v2">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_object_docked object="$WingmateShip" dock="$SecretServiceStation"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <cancel_cue cue="Ch22_B_4_Defeat_Wingmate"/>
                            <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Secret_Service_Reached"/>

                            <cancel_all_orders object="$WingmateShip"/>
                            <create_order id="'MoveDie'" object="$WingmateShip">
                              <param name="atstation" value="$SecretServiceStation"/>
                            </create_order>

                            <do_for_each in="$YakiEscort" name="$CurrentShip">
                              <create_order id="'MoveDie'" object="$CurrentShip">
                                <param name="atstation" value="$SecretServiceStation"/>
                              </create_order>
                            </do_for_each>
                          </actions>
                        </cue>

                        <cue name="Ch22_B_3_Wingmate_Arrived_Dialog_Finished_v2">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="faction.terran.relationto.{faction.player} gt faction.terran.relation.killmilitary.mid">
                              <set_faction_relation faction="faction.terran" otherfaction="faction.player" value="faction.terran.relation.killmilitary.mid"/>
                            </do_if>

                            <!-- This declaration of war cancels the option to inform the Terran fleet about the Yaki HQ. -->
                            <do_if value="Ch22_A_Inform_Terran_Fleet.state != cuestate.cancelled">
                              <signal_cue cue="Ch22_A_Clean_Up_Mission"/>
                            </do_if>

                            <signal_cue cue="Ch22_B_5_Return_To_Yaki"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch22_B_3_Update_Objective">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$SubMissionCue_B" step="$CurrentStep_B" action="objective.custom" customaction="{30226,7012}" object="$WingmateShip" insert="true" updatebriefing="true"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_B_4_Defeat_Wingmate">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_B" operation="add"/>
                    <set_objective cue="$SubMissionCue_B" step="$CurrentStep_B" action="objective.kill" object="$WingmateShip" text="{30225,101}" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_B_4_Trigger_Dialog">
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Wingmate_Attacked"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_B_4_Wingmate_Orders">
                      <actions>
                        <cancel_all_orders object="$WingmateShip"/>
                        <set_value name="$CurrentTarget" exact="null"/>

                        <do_if value="$WingmateAttacker.isoperational">
                          <set_value name="$CurrentTarget" exact="$WingmateAttacker"/>
                          <debug_text text="$WingmateAttacker.knownname + ' is operational. Set $CurrentTarget to ' + $CurrentTarget.knownname" chance="$DebugChance"/>
                        </do_if>
                        <do_elseif value="player.ship and player.sector == $WingmateShip.sector">
                          <set_value name="$CurrentTarget" exact="player.ship"/>
                          <debug_text text="$WingmateAttacker.knownname + ' is not operational, but player.ship is in the same sector as $WingmateShip. Set $CurrentTarget to ' + player.ship.knownname" chance="$DebugChance"/>
                        </do_elseif>
                        <do_else>
                          <find_ship_by_true_owner name="$CurrentTarget" faction="faction.player" class="class.ship" space="$WingmateShip.sector" sortbydistanceto="$WingmateShip" multiple="false"/>
                          <debug_text text="$WingmateAttacker.knownname + ' is not operational, and player.ship is not in the same sector as $WingmateShip. Set $CurrentTarget to ' + $CurrentTarget.knownname" chance="$DebugChance"/>
                        </do_else>

                        <do_if value="$CurrentTarget">
                          <create_order id="'Patrol'" object="$WingmateShip" default="true">
                            <param name="space" value="$SecretServiceSector"/>
                          </create_order>
                          <create_order id="'Attack'" name="$WingmateAttackOrder" object="$WingmateShip" immediate="true">
                            <param name="primarytarget" value="$CurrentTarget"/>
                            <param name="pursuetargets" value="true"/>
                            <param name="checkrelation" value="false"/>
                            <param name="allowothertargets" value="false"/>
                          </create_order>
                        </do_if>
                        <do_else>
                          <create_order id="'MoveToObject'" object="$WingmateShip" default="true">
                            <param name="destination" value="$SecretServiceStation"/>
                            <param name="noattackresponse" value="true"/>
                          </create_order>
                          <create_order id="'DockAndWait'" object="$WingmateShip">
                            <param name="destination" value="$SecretServiceStation"/>
                          </create_order>
                        </do_else>
                      </actions>
                      <cues>

                        <cue name="Ch22_B_4_Attacker_Destroyed">
                          <conditions>
                            <check_any>
                              <event_object_order_finished object="$WingmateShip" order="$WingmateAttackOrder"/>
                              <event_object_destroyed object="$CurrentTarget"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <debug_text text="'$WingmateAttackOrder finished or cancelled, or $CurrentTarget destroyed. Resetting Ch22_B_4_Wingmate_Orders in 1s.'" chance="$DebugChance"/>
                          </actions>
                          <delay exact="1s" comment="Prevent infinite loops."/>
                          <actions>
                            <reset_cue cue="parent"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch22_B_4_Wingmate_Ship_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$WingmateShip"/>
                      </conditions>
                      <actions>
                        <set_value name="$WingmateDied"/>

                        <cancel_cue cue="Ch22_B_4_Wingmate_Orders" comment="Prevent new orders."/>
                        <cancel_cue cue="Ch22_B_3_Wingmate_Arrived_v2"/>
                        <signal_cue cue="Ch22_B_5_Return_To_Yaki"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_B_5_Return_To_Yaki">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- It's theoretically possible that the player destroyed the Amplifier after deploying the beacons. -->
                    <do_if value="not $YakiAmplifierStation.isoperational">
                      <signal_cue cue="Ch22_B_Clean_Up_Mission"/>
                      <cancel_cue cue="this"/>
                    </do_if>
                    <do_else>
                      <set_value name="$CurrentStep_B" operation="add"/>
                      <set_objective cue="$SubMissionCue_B" step="$CurrentStep_B" action="objective.talkto" object="$YakiLeaderActor" insert="true" updatebriefing="true"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Ch22_B_5_Trigger_Dialog">
                      <delay exact="5s"/>
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Boso_Return_Hint"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_B_5_Yaki_Leader_Conversation_Started">
                      <conditions>
                        <event_conversation_started actor="$YakiLeaderActor"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226608" comment="(proud)The hero of the Yaki returns!"/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226609" comment="(excited)The entire system is talking about you! Well, apart from the Xenon, but they've never been much fun."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226610" comment="I guess I don't really have to say it, but you can help yourself to anything you want."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226611" comment="(backpedalling quickly)Uh, I mean, we'll arrange for something, OK? Our scavengers keep bringing in the weirdest stuff, and there's bound to be something you like."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226612" comment="(gathering herself)And then there's the matter of the amplifier."/>

                        <add_player_choice text="{30226,7030}" section="yaki_leader_ch22_b_rewards" position="right"/>
                        <add_player_choice text="{30226,7031}" section="yaki_leader_ch22_b_amplifier" position="left"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_B_5_Yaki_Leader_Conversation_Section_Rewards">
                      <conditions>
                        <event_conversation_next_section actor="$YakiLeaderActor" section="yaki_leader_ch22_b_rewards"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <set_value name="$YakiRewardAsked"/>

                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226613" comment="Of course. Go and enjoy yourself. The big red button won't be going anywhere."/>
                      </actions>
                    </cue>

                    <cue name="Ch22_B_5_Yaki_Leader_Conversation_Resume" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$YakiLeaderActor"/>
                        <check_value value="$YakiRewardAsked?"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226621" comment="Welcome back, friend."/>

                        <add_player_choice text="{30226,2053}" section="g_cancel" position="bottom_right"/>
                        <add_player_choice text="{30226,7031}" section="yaki_leader_ch22_b_amplifier" position="left"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_B_5_Yaki_Leader_Conversation_Section_Amplifier">
                      <conditions>
                        <event_conversation_next_section actor="$YakiLeaderActor" section="yaki_leader_ch22_b_amplifier"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226614" comment="Well, as you've probably already found out, this system is protected by an arcane mechanism we don't even properly understand ourselves."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226615" comment="Our enemies make one false move, take one step into our home territory, and all the Xenon in this corner of the Gate network will come crashing down on their ships."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226616" comment="That's just a defensive measure, though. A safeguard, in case push comes to shove."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226617" comment="The real deal is this: Thanks to you, we've now got a gun to the Terran Protectorate's head."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226618" comment="That trail of beacons you put down will show the Xenon the path to the greenest pastures they've ever seen... and rid us of them for a while."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226619" comment="One squeeze of the trigger, and both the Terrans and the Xenon are suddenly a whole lot weaker."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226620" comment="We'll be relying on you for the perfect timing. We've only got one shot at this, so make sure you're prepared before you give me the signal."/>
                      </actions>
                    </cue>

                    <cue name="Ch22_B_5_Yaki_Leader_Conversation_Finished" instantiate="true">
                      <conditions>
                        <event_conversation_finished actor="$YakiLeaderActor"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch22_F_Yaki_Reward" check="false"/>

                        <do_if value="event.param == 'yaki_leader_ch22_b_amplifier'">
                          <cancel_cue cue="Ch22_B_5_Yaki_Leader_Conversation_Resume"/>

                          <do_if value="$DalBusta?">
                            <set_value name="$CurrentStep_B" operation="add"/>
                            <set_objective cue="$SubMissionCue_B" step="$CurrentStep_B" action="objective.custom" customaction="{30226,7013}" insert="true" updatebriefing="true"/>
                            <signal_cue cue="Ch22_Dialog_Amplifier_Mission_Dal_Options"/>
                          </do_if>
                          <do_else>
                            <signal_cue cue="Ch22_B_6_Big_Button"/>
                          </do_else>
                        </do_if>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_B_6_Big_Button">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_B" operation="add"/>
                    <set_objective cue="$SubMissionCue_B" step="$CurrentStep_B" action="objective.custom" customaction="{30226,7014}" object="$YakiLeaderActor" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_B_6_Yaki_Leader_Conversation">
                      <cues>

                        <cue name="Ch22_B_6_Yaki_Leader_Conversation_Started" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$YakiLeaderActor"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226621" comment="Welcome back, friend."/>

                            <add_player_choice text="{30226,2053}" section="g_cancel" position="bottom_right"/>
                            <add_player_choice text="{30226,7032}" section="yaki_leader_ch22_b_activate" position="left" highlighted="true"/>
                          </actions>
                        </cue>

                        <cue name="Ch22_B_6_Yaki_Leader_Conversation_Section_Activate" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$YakiLeaderActor" section="yaki_leader_ch22_b_activate"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226622" comment="(concerned)Are you sure? Is this really the ideal moment?"/>

                            <add_player_choice text="{30226,7033}" section="yaki_leader_ch22_b_confirm" position="right" highlighted="true"/>
                            <add_player_choice text="{30226,7034}" section="yaki_leader_ch22_b_decline" position="left"/>
                          </actions>
                        </cue>

                        <cue name="Ch22_B_6_Yaki_Leader_Conversation_Section_Decline" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$YakiLeaderActor" section="yaki_leader_ch22_b_decline"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226624" comment="(relieved)Very well. Take all the time you need."/>
                          </actions>
                        </cue>

                        <cue name="Ch22_B_6_Yaki_Leader_Conversation_Section_Confirm">
                          <conditions>
                            <event_conversation_next_section actor="$YakiLeaderActor" section="yaki_leader_ch22_b_confirm"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226623" comment="(urgent)It's done! Go and make use of it!"/>
                          </actions>
                        </cue>

                        <cue name="Ch22_B_6_Yaki_Leader_Conversation_Finished">
                          <conditions>
                            <event_conversation_finished actor="$YakiLeaderActor" outcome="yaki_leader_ch22_b_confirm"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch22_B_6_Xenon_Horde"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch22_B_6_Xenon_Horde" version="2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$AmplifierActivated"/>

                        <set_value name="$TerranTarget" exact="null"/>
                        <!-- Same list that's been used for the nav beacon deployment. -->
                        <do_for_each in="$TrailSectorList" name="$CurrentSector" reverse="true">
                          <find_station name="$TerranTarget" owner="faction.terran" space="$CurrentSector">
                            <match_content canclaimownership="true"/>
                          </find_station>
                          <do_if value="not $TerranTarget">
                            <find_station name="$TerranTarget" owner="faction.terran" space="$CurrentSector"/>
                          </do_if>
                          <do_if value="$TerranTarget">
                            <break/>
                          </do_if>
                        </do_for_each>

                        <!-- Failsafe station selection. -->
                        <do_if value="not $TerranTarget">
                          <find_station name="$TerranTarget" owner="faction.terran" space="player.galaxy" sortbygatedistanceto="$TerranOutpostSector">
                            <match_content canclaimownership="true"/>
                          </find_station>
                        </do_if>
                        <do_if value="not $TerranTarget">
                          <find_station name="$TerranTarget" owner="faction.terran" space="player.galaxy" sortbygatedistanceto="$TerranOutpostSector"/>
                        </do_if>

                        <do_if value="$TerranTarget">
                          <play_sound sound="'yaki_xenon_call'" object="player.entity"/>
                          <run_actions ref="Xenon_Horde" result="$EarthXenonHorde">
                            <param name="SectorList"          value="[$YakiExitSector, $YakiHomeSector, $XenonSectorNextToYaki, $TharkasCascadeXVII, $TharkasCascadeXV]"/>
                            <param name="Target"              value="$TerranTarget"/>
                            <param name="AllowOtherTargets"   value="true"/>
                            <param name="DefaultPatrolTargetSector" value="true"/>
                            <param name="RallySector"         value="$YakiHomeSector"/>
                            <param name="MinFleetComposition" value="[
                                                                       [ macro.ship_xen_xl_carrier_01_a_macro,   4 ],
                                                                       [ macro.ship_xen_xl_destroyer_01_a_macro, 14 ],
                                                                       [ macro.ship_xen_m_corvette_02_a_macro,   27 ],
                                                                       [ macro.ship_xen_s_fighter_02_a_macro,   54 ],
                                                                       [ macro.ship_xen_s_fighter_01_a_macro,   54 ]
                                                                     ]"/>
                          </run_actions>

                          <signal_cue cue="Activate_Xenon_Horde_Replenishment"/>
                        </do_if>
                        <do_else>
                          <debug_text text="'No Terran target left for the Xenon horde.'" chance="$DebugChance"/>
                        </do_else>

                        <play_music music="'music_dlc_terran_story_yaki_4'"/>

                        <signal_cue cue="Ch22_B_Clean_Up_Mission"/>
                      </actions>
                      <patch sinceversion="2" state="cancelled">
                        <do_if value="$AmplifierActivated? and $EarthXenonHorde.count">
                          <signal_cue cue="Activate_Xenon_Horde_Replenishment"/>
                        </do_if>
                      </patch>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_B_Clean_Up_Mission">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_cue_cancelled cue="Setup_Yaki_Leader" comment="This cue gets cancelled if the Yaki lose all their stations."/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="$AmplifierActivated?">
                      <write_to_logbook category="missions" faction="faction.yaki" title="{30226,7001}" text="{30226,7004}"/>
                      <remove_mission cue="$SubMissionCue_B" type="completed"/>
                      <unlock_achievement name="COH_PLOT_YAKI_5"/>
                    </do_if>
                    <do_else>
                      <write_to_logbook category="missions" faction="faction.yaki" title="{30226,7001}" text="{30226,7005}"/>
                      <remove_mission cue="$SubMissionCue_B" type="failed"/>
                    </do_else>

                    <cancel_cue cue="Ch22_B_Deploy_Yaki_Beacons"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <!-- ID Range 8000-->
            <cue name="Ch22_C_Yaki_Freedom">
              <!-- The thread starts with this mission. -->
              <actions>
                <set_value name="$SubMissionCue_C" exact="this"/>
                <create_mission cue="$SubMissionCue_C" name="{30226,8001}" description="{30226,8002}" rewardtext="{30226,8003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.player" difficulty="level.hard" abortable="false" missionthread="$MissionCue" activate="true" icon="'briefing_haile_shinamon_02'" iconcaption="$WingmateActor.name"/>
              </actions>
              <cues>

                <cue name="Ch22_C_1_Destroy_Station" version="3">
                  <actions>
                    <find_object_component name="$YakiAmplifierModules" object="$YakiAmplifierStation" multiple="true" class="class.module"/>
                    <find_object_component groupname="$AmplifierShellModules" object="$YakiAmplifierStation" multiple="true" macro="macro.struct_at_xen_shell_macro"/>
                    <find_object_component name="$AmplifierCoreModule" object="$YakiAmplifierStation" macro="macro.xenon_asteroid_03_macro"/>

                    <set_value name="$CurrentStep_C"/>
                    <set_objective cue="$SubMissionCue_C" step="$CurrentStep_C" action="objective.destroy" object="$YakiAmplifierStation" insert="true" silent="true" updatebriefing="true"/>

                    <activate_mission cue="$SubMissionCue_C"/>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <signal_cue cue="Ch22_B_Deploy_Yaki_Beacons"/>
                  </actions>
                  <patch sinceversion="2" comment="Patch running mission for story testers.">
                    <do_if value="$YakiAmplifierStation.isoperational">
                      <find_object_component groupname="$AmplifierShellModules" object="$YakiAmplifierStation" multiple="true" macro="macro.struct_at_xen_shell_macro"/>
                      <find_object_component name="$AmplifierCoreModule" object="$YakiAmplifierStation" macro="macro.xenon_asteroid_03_macro"/>
                    </do_if>
                    <do_else>
                      <cancel_cue cue="Ch22_C_1_Shell_Module_Destroyed"/>
                      <cancel_cue cue="Ch22_C_1_Core_Module_Destroyed"/>
                    </do_else>
                  </patch>
                  <patch sinceversion="3">
                    <do_if value="(Ch22_C_1_Player_Attacked_Station.state == cuestate.waiting) and (Ch22_E_Terran_Invasion.state == cuestate.waiting)">
                      <do_for_each in="$YakiAmplifierModules" name="$CurrentModule">
                        <set_object_min_hull object="$CurrentModule" exact="100"/>
                      </do_for_each>
                    </do_if>
                  </patch>
                  <cues>

                    <cue name="Ch22_C_1_Shell_Module_Destroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$AmplifierShellModules"/>
                        <check_value value="$AmplifierCoreModule.hullpercentage ge 0" comment="Don't react if triggered by the destruction of the core."/>
                      </conditions>
                      <actions>
                        <do_if value="($AmplifierCoreModule.hull - 325000) le 0" comment="If the damage would destroy the core, do it in a more direct way.">
                          <apply_attackstrength object="$YakiAmplifierStation" module="$AmplifierCoreModule" strength="$AmplifierCoreModule.hull"/>
                        </do_if>
                        <do_else>
                          <set_object_hull object="$AmplifierCoreModule" exact="$AmplifierCoreModule.hullpercentage - (325000 / $AmplifierCoreModule.maxhull * 100)"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch22_C_1_Core_Module_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$AmplifierCoreModule" check="false" comment="Check false to prevent error in story tester saves."/>
                      </conditions>
                      <actions>
                        <do_for_each in="$AmplifierShellModules" name="$CurrentModule">
                          <do_if value="$CurrentModule.isoperational">
                            <apply_attackstrength object="$YakiAmplifierStation" module="$CurrentModule" strength="$CurrentModule.hull"/>
                          </do_if>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="DEBUG_Print_Amplifier_Hull" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <find_object_component name="$YakiAmplifierModules" object="$YakiAmplifierStation" multiple="true" class="class.module"/>
                        <do_for_each in="$YakiAmplifierModules" name="$CurrentModule">
                          <debug_text text="$CurrentModule.hullpercentage + ' ' + $CurrentModule.hull"/>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="DEBUG_Damage_Amplifier_Hull" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <find_object_component name="$YakiAmplifierModules" object="$YakiAmplifierStation" multiple="true" class="class.module"/>
                        <do_for_each in="$YakiAmplifierModules" name="$CurrentModule">
                          <set_object_hull object="$CurrentModule" exact="1"/>
                          <set_object_hull_unrepairable object="$CurrentModule" unrepairable="true"/>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="Ch22_C_1_Deactivate_Amplifier_Invincibility">
                      <conditions>
                        <check_any>
                          <check_all>
                            <event_object_attacked object="$YakiAmplifierStation"/>
                            <check_value value="(event.param.trueowner == faction.player)"/>
                          </check_all>
                          <event_cue_signalled cue="Ch22_E_Terran_Invasion"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_for_each in="$YakiAmplifierModules" name="$CurrentModule">
                          <set_object_min_hull object="$CurrentModule" exact="0"/>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="Ch22_C_1_Player_Attacked_Station" version="3">
                      <conditions>
                        <check_any>
                          <check_all>
                            <event_object_attacked object="$YakiAmplifierStation"/>
                            <check_value value="(event.param.trueowner == faction.player)"/>
                            <!-- or $YakiEscort.indexof.{event.param} or (event.param == $WingmateShip) -->
                          </check_all>
                          <!--<event_object_bomb_attached object="$YakiAmplifierStation"/>-->
                        </check_any>
                        <check_value value="$YakiAmplifierStation.hullpercentage le 95"/>
                        <!-- Wait with the attack response until Kendai has explained her alternative mission. -->
                        <check_value value="Ch22_B_2_Trail.state != cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <set_value name="$PlayerAttackedAmplifier"/>

                        <!-- Since cover is now triggered with a button in the ship menu, it's safe to let the player keep the ability after the plot. -->
                        <!--<signal_cue cue="Disable_Current_Cover_Handler"/>-->

                        <do_if value="not $WingmateDied?">
                          <cancel_cue cue="Wingmate_Repair"/>
                          <signal_cue cue="Ch22_Dialog_Freedom_Mission_Attack_Warning"/>
                        </do_if>

                        <!-- One Yaki each with a bunch of Xenon in tow. -->
                        <set_value name="$DefenderComposition" exact="[
                            [ [ macro.ship_yak_m_corvette_01_a_macro ],
                              [ macro.ship_xen_s_fighter_01_a_macro, 4 ],
                              [ macro.ship_xen_s_fighter_02_a_macro, 2 ] ],
                              
                            [ [ macro.ship_yak_m_corvette_01_a_macro ],
                              [ macro.ship_xen_s_fighter_01_a_macro, 4 ],
                              [ macro.ship_xen_s_fighter_02_a_macro, 2 ] ],
                              
                            [ [ macro.ship_yak_m_corvette_01_a_macro ],
                              [ macro.ship_xen_s_fighter_01_a_macro, 4 ],
                              [ macro.ship_xen_s_fighter_02_a_macro, 2 ] ]
                            ]" />

                        <do_for_each in="$DefenderComposition" name="$SquadMacros">
                          <do_for_each in="$SquadMacros" name="$Macro" counter="$i">
                            <do_if value="$i == 1" comment="First ship in each list becomes the leader.">
                              <create_ship name="$CurrentShip" macro="$Macro.{1}" capturable="false" missioncue="$MissionCue" sector="$YakiHomeSector">
                                <owner exact="faction.yaki" overridenpc="true"/>
                                <pilot>
                                  <select faction="faction.yaki" tags="tag.fighterpilot"/>
                                </pilot>
                                <loadout>
                                  <level exact="1.0"/>
                                </loadout>
                                <safepos object="$YakiAmplifierStation" min="10km" max="15km"/>
                              </create_ship>
                              <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                                <param name="destination" value="[$YakiHomeSector, $YakiAmplifierPosition]"/>
                              </create_order>
                              <set_value name="$Leader" exact="$CurrentShip"/>
                            </do_if>
                            <do_else>
                              <do_all exact="$Macro.{2}" counter="$a">
                                <create_ship name="$CurrentShip" macro="$Macro.{1}" capturable="false" missioncue="$MissionCue" sector="$YakiHomeSector">
                                  <owner exact="faction.xenon" overridenpc="true"/>
                                  <pilot>
                                    <select faction="faction.xenon" tags="tag.fighterpilot"/>
                                  </pilot>
                                  <loadout>
                                    <level exact="1.0"/>
                                  </loadout>
                                  <drop ref="ship_small_xenon"/>
                                  <safepos object="$Leader"/>
                                </create_ship>
                                <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                                  <param name="destination" value="[$YakiHomeSector, $YakiAmplifierPosition]"/>
                                </create_order>
                                <create_order id="'ProtectShip'" object="$CurrentShip" immediate="true">
                                  <param name="target" value="$Leader"/>
                                </create_order>
                              </do_all>
                            </do_else>
                            <set_relation_boost object="$CurrentShip" faction="faction.player" value="-1.0" decay="0"/>
                            <add_to_group groupname="$AmplifierDefenders" object="$CurrentShip"/>
                          </do_for_each>
                        </do_for_each>
                      </actions>
                      <patch sinceversion="3" state="cancelled">
                        <do_if value="$OldYakiShip.isoperational and $PlayerAttackedAmplifier?">
                          <set_object_npc_assignment_restricted object="$OldYakiShip" restricted="false"/>
                        </do_if>
                      </patch>
                    </cue>

                    <cue name="Ch22_C_1_Yaki_Station_Destroyed" version="3">
                      <conditions>
                        <event_object_destroyed object="$YakiAmplifierStation"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_yaki_amplifier"/>

                        <unlock_achievement name="COH_PLOT_YAKI_3"/>

                        <set_value name="$AmplifierDestroyed"/>

                        <do_if value="Ch22_A_Inform_Terran_Fleet.state == cuestate.waiting" comment="Can happen if the amplifier is destroyed immediately after the player gets the objective.">
                          <signal_cue cue="Ch22_A_Inform_Terran_Fleet"/>
                        </do_if>
                        <signal_cue cue="Ch22_B_Clean_Up_Mission"/>
                        <cancel_cue cue="Activate_Yaki_Home_Sector_Defence"/>

                        <cancel_cue cue="Activate_Yaki_Escort_Handlers" comment="The Yaki supporters have done their part."/>

                        <do_for_each in="$YakiEscort" name="$CurrentShip">
                          <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                            <param name="Ship" value="$CurrentShip"/>
                            <param name="Faction" value="faction.civilian"/>
                          </run_actions>
                          <cancel_all_orders object="$CurrentShip"/>
                          <create_order id="'MoveDie'" object="$CurrentShip"/>
                        </do_for_each>

                        <do_for_each in="$AmplifierDefenders" name="$CurrentShip">
                          <!-- Should keep the subordinate structure intact. -->
                          <create_order id="'Patrol'" object="$CurrentShip" default="true">
                            <param name="space" value="$YakiHomeSector"/>
                          </create_order>
                        </do_for_each>

                        <!-- Variants 1-3 assume that the player was involved in the destruction of the Amplifier. -->
                        <do_if value="$PlayerAttackedAmplifier?">
                          <do_if value="faction.yaki.relationto.{faction.player} gt faction.yaki.relation.killmilitary.mid">
                            <set_faction_relation faction="faction.yaki" otherfaction="faction.player" value="faction.yaki.relation.killmilitary.mid" reason="relationchangereason.killedobject"/>
                          </do_if>

                          <!-- Player relation to Yaki likely just dropped, so we have to give the Wingmate a boost to prevent him from becoming hostile to the player. -->
                          <set_relation_boost object="$WingmateShip" faction="faction.player" value="1.0" decay="0"/>

                          <!-- All of these options require the wingmate. Without him, there's no back-and-forth dialog. -->
                          <do_if value="not $WingmateBetrayed?">
                            <!-- Variant 1: If the Terrans have already been told about the Yaki, the mission ends here. -->
                            <do_if value="$ToldTerransAboutYaki?">
                              <signal_cue cue="Ch22_C_2_Flee_Sector" comment="There's another check for $ToldTerransAboutYaki in there."/>
                            </do_if>
                            <!-- Variant 2: If the Terrans have already been told that the Yaki don't have an HQ, the mission skips ahead. -->
                            <do_elseif value="$KeptYakiSecret?">
                              <set_value name="$CurrentStep_C" operation="add"/>
                              <set_objective cue="$SubMissionCue_C" step="$CurrentStep_C" action="objective.custom" customaction="{30226,8010}" object="$XenonSectorNextToYaki" insert="true" updatebriefing="true"/>
                              <signal_cue cue="Ch22_Dialog_Freedom_Mission_Discussion_Prepared_Variant" comment="Signals Ch22_C_4_Return_To_Yaki"/>
                            </do_elseif>
                            <!-- Variant 3: If the Terrans haven't been told anything yet, the mission is put on hold until the decision has been made. -->
                            <do_else>
                              <signal_cue cue="Ch22_C_2_Flee_Sector"/>
                            </do_else>
                          </do_if>
                          <!-- Without the wingmate, the mission ends here, even if the conditions for further objectives are otherwise met. -->
                          <do_else>
                            <signal_cue cue="Ch22_C_Clean_Up_Mission"/>
                          </do_else>
                        </do_if>
                        <!-- Variant 4: If the station was destroyed without the player's help, that means that the Yaki are fighting a war on their territory. They won't agree to the peaceful solution in that case. -->
                        <!-- TODO: Log entry that explains this. -->
                        <do_elseif value="not $WingmateBetrayed?">
                          <signal_cue cue="Ch22_Dialog_Freedom_Mission_Outro_No_Dal"/>
                        </do_elseif>
                        <do_else>
                          <signal_cue cue="Ch22_C_Clean_Up_Mission"/>
                        </do_else>
                      </actions>
                      <patch sinceversion="2">
                        <do_if value="$PlayerAttackedAmplifier? and $WingmateBetrayed? and (Ch22_C_Clean_Up_Mission.state == cuestate.waiting)">
                          <signal_cue cue="Ch22_C_Clean_Up_Mission"/>
                        </do_if>
                      </patch>
                      <patch sinceversion="3" state="complete">
                        <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_yaki_amplifier"/>
                      </patch>
                      <patch sinceversion="3" state="cancelled">
                        <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_yaki_amplifier"/>
                      </patch>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_C_2_Flee_Sector">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_C" operation="add"/>
                    <set_objective cue="$SubMissionCue_C" step="$CurrentStep_C" action="objective.custom" customaction="{30226,8010}" object="$TerranOutpostSector" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_C_2_Trigger_Dialog">
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Freedom_Mission_Leave_Sector"/>
                      </actions>
                      <delay exact="20s"/>
                      <actions>
                        <do_if value="@player.sector == $YakiHomeSector">
                          <signal_cue cue="Ch22_Dialog_Freedom_Mission_Get_Out"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch22_C_2_Deactivate_Wingmate_Handlers">
                      <actions>
                        <reset_cue cue="Activate_Wingmate_Handlers" comment="Only until the player has progressed further in the plot."/>
                        <cancel_all_orders object="$WingmateShip"/>
                        <create_order id="'MoveWait'" object="$WingmateShip" default="true">
                          <param name="destination" value="[$YakiExitSector, position.[0,0,0]]"/>
                          <param name="noattackresponse" value="true"/>
                        </create_order>
                      </actions>
                      <cues>

                        <cue name="Ch22_C_2_Wingmate_Despawn">
                          <conditions>
                            <event_object_changed_sector object="$WingmateShip" previous="$YakiHomeSector"/>
                          </conditions>
                          <actions>
                            <destroy_object object="$WingmateShip" explosion="false"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch22_C_2_Sector_Changed">
                      <conditions>
                        <event_object_changed_sector object="player.entity" previous="$YakiHomeSector"/>
                      </conditions>
                      <actions>
                        <do_if value="$ToldTerransAboutYaki?">
                          <signal_cue cue="Ch22_Dialog_Freedom_Mission_Outro_No_Dal"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch22_Dialog_Freedom_Mission_Discussion_Standard_Variant"/>
                        </do_else>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_C_3_Keep_Yaki_Secret">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_C" operation="add"/>
                    <set_objective cue="$SubMissionCue_C" step="$CurrentStep_C" action="objective.custom" customaction="{30226,8011}" object="$SecretServiceActor" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_C_3_Returned_To_Crime_Scene">
                      <conditions>
                        <event_object_changed_sector object="player.entity" sector="$YakiHomeSector"/>
                        <check_value value="Ch22_C_4_Return_To_Yaki.state == cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Freedom_Mission_Enter_Sector_Warning"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <!-- This is what needs to get signalled from the outside once the mission is ready to continue. -->
                <cue name="Ch22_C_4_Return_To_Yaki">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_C" operation="add"/>
                    <set_objective cue="$SubMissionCue_C" step="$CurrentStep_C" action="objective.talkto" object="$YakiLeaderActor" insert="true" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_C_4_Relation_Change">
                      <actions>
                        <do_if value="faction.yaki.relationto.{faction.player} lt faction.yaki.relation.member.min">
                          <set_faction_relation faction="faction.yaki" otherfaction="faction.player" value="faction.yaki.relation.member.min" reason="relationchangereason.missioncompleted"/>
                        </do_if>

                        <!-- If the mission jumped to this part immediately after the destruction of the Amplifier (Ch22_C_2_Flee_Sector skipped),
                             that means that the wingmate handler is still active and $WingmateShip still exists and we have to reset its positive relation boost. -->
                        <reset_relation_boost object="$WingmateShip" faction="faction.player"/>
                        <signal_cue cue="Activate_Wingmate_Handlers" check="false" comment="See comment above."/>
                      </actions>
                    </cue>

                    <cue name="Ch22_C_4_Returned_To_Yaki_Space">
                      <conditions>
                        <event_object_changed_sector object="player.entity" sector="$YakiHomeSector"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Freedom_Mission_Return_To_Yaki_Space"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_C_4_Docked_At_Headquarters">
                      <conditions>
                        <event_object_docked_at container="$YakiHeadquarters"/>
                        <check_value value="event.param == player.ship"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Freedom_Mission_Enter_Yaki_Home_Sector"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_C_4_Yaki_Leader_Conversation_Started">
                      <conditions>
                        <event_conversation_started actor="$YakiLeaderActor"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226718" comment="I must say, working with you has been a real rollercoaster."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226719" comment="But it seems that, despite the confusion you keep causing, you've managed to manoeuvre us into a position everyone can be reasonably content with."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226720" comment="(deliberating)We're really running out of rewards here. What would someone like you appreciate?"/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226721" comment="(deliberating)We don't have much in terms of resources we could share. Everything our freebooters have brought in so far went straight into repairs and research."/>
                        <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226722" comment="(frustrated)If only we didn't have to worry about the Xenon whenever we make a move, we could actually expand our operations..."/>
                        <do_if value="$DalBusta?">
                          <add_npc_line speaker="$DalBusta" hidechoices="true" line="30226701" comment="(interrupts conversation)Now you're talking my language!"/>
                          <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226723" comment="(dumbfounded)Who invited this clown?"/>
                          <add_npc_line speaker="$DalBusta" hidechoices="true" line="30226502" comment="(proud)Allow me to introduce myself: Dal Busta, political analyst, private tutor and bon vivant extraordinnaire."/>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226724" comment="(composes herself)But that's just wishful thinking at this point."/>
                          <add_npc_line speaker="$YakiLeaderActor" hidechoices="true" line="30226725" comment="Go now, hero of the Yaki. Maybe you'll visit from time to time, hm?"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch22_C_4_Yaki_Leader_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$YakiLeaderActor"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch22_F_Yaki_Reward"/>

                        <do_if value="$DalBusta?">
                          <signal_cue cue="Ch22_Dialog_Freedom_Mission_Outro_Dal_Known"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch22_Dialog_Freedom_Mission_Outro_No_Dal"/>
                        </do_else>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_C_Clean_Up_Mission" version="4">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_cue_cancelled cue="Setup_Yaki_Leader" comment="This cue gets cancelled if the Yaki lose all their stations."/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="not $WingmateBetrayed?">
                      <signal_cue cue="Wingmate_Transfer"/>
                      <write_to_logbook category="missions" faction="faction.player" title="{30226,8001}" text="{30226,8004}"/>
                      <remove_mission cue="$SubMissionCue_C" type="completed"/>
                    </do_if>
                    <do_else>
                      <remove_mission cue="$SubMissionCue_C" type="failed"/>
                    </do_else>

                    <!-- The mission may abort before the Amplifier has been attacked, so it could still be invincible. Revert invincibility to be sure. -->
                    <do_for_each in="$YakiAmplifierModules" name="$CurrentModule">
                      <do_if value="$CurrentModule.isoperational">
                        <set_object_min_hull object="$CurrentModule" exact="0"/>
                      </do_if>
                    </do_for_each>

                    <!-- Since cover is now triggered with a button in the ship menu, it's safe to let the player keep the ability after the plot.
                         Originally, cover was disabled here even if the mission didn't end with the destruction of the Amplifier (which would have disabled cover in a more natural way). -->
                    <!--<signal_cue cue="Disable_Current_Cover_Handler" check="false"/>-->

                    <cancel_cue cue="Ch22_C_Yaki_Freedom"/>
                  </actions>
                  <patch sinceversion="2" state="cancelled" comment="Patch existing save so story testers can quickly confirm the fix.">
                    <do_if value="not $WingmateBetrayed?">
                      <set_entity_traits entity="$WingmateActor" missionactor="false" customhandler="false" subtitlename="true"/>
                    </do_if>
                  </patch>
                  <patch sinceversion="3" state="waiting">
                    <do_if value="$WingmateBetrayed?">
                      <signal_cue cue="this"/>
                    </do_if>
                  </patch>
                  <patch sinceversion="4" state="cancelled">
                    <signal_cue cue="Disable_Current_Cover_Handler" check="false"/>
                  </patch>
                </cue>

              </cues>
            </cue>

            <!-- ID Range 9000 -->
            <cue name="Ch22_D_Secret_Service_Reward">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$SubMissionCue_D" exact="this"/>
              </actions>
              <cues>

                <cue name="Ch22_D_Setup_Reward_Ship" checkinterval="1s">
                  <conditions>
                    <check_value value="not player.entity.hascontext.{$SecretServiceStation}"/>
                  </conditions>
                  <actions>
                    <create_loadout result="$SwansongLoadout">
                      <macros>
                        <engine macro="engine_ter_l_allround_01_mk1_macro" path="../con_engine_01"/>
                        <weapon macro="weapon_ter_l_destroyer_01_mk1_macro" path="../con_weapon_03"/>
                        <weapon macro="weapon_ter_l_destroyer_01_mk1_macro" path="../con_weapon_01"/>
                        <weapon macro="weapon_ter_l_destroyer_01_mk1_macro" path="../con_weapon_02"/>
                        <shield macro="shield_ter_l_standard_01_mk2_macro" path="../con_shieldgen_l_03"/>
                        <shield macro="shield_ter_l_standard_01_mk2_macro" path="../con_shieldgen_l_02"/>
                        <shield macro="shield_ter_l_standard_01_mk2_macro" path="../con_shieldgen_l_01"/>
                      </macros>
                      <groups>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_back_mid_mid" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_back_up_mid" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_mid_up_left_2" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_mid_right_up_2" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_back_down_mid" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_mid_up_left_1" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_mid_right_up_1" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_mid_right_down_2" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_mid_right_down_1" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_mid_down_left_2" exact="2"/>
                        <shields macro="shield_ter_m_standard_02_mk2_macro" path=".." group="group_mid_down_left_1" exact="2"/>
                        <turrets macro="turret_ter_m_gatling_02_mk1_macro" path=".." group="group_back_up_mid" exact="2"/>
                        <turrets macro="turret_ter_l_gatling_01_mk1_macro" path=".." group="group_mid_up_left_2"/>
                        <turrets macro="turret_ter_l_gatling_01_mk1_macro" path=".." group="group_mid_right_up_2"/>
                        <turrets macro="turret_ter_m_gatling_02_mk1_macro" path=".." group="group_back_down_mid" exact="2"/>
                        <turrets macro="turret_ter_l_gatling_01_mk1_macro" path=".." group="group_mid_up_left_1"/>
                        <turrets macro="turret_ter_l_gatling_01_mk1_macro" path=".." group="group_mid_right_up_1"/>
                        <turrets macro="turret_ter_l_gatling_01_mk1_macro" path=".." group="group_mid_right_down_2"/>
                        <turrets macro="turret_ter_l_gatling_01_mk1_macro" path=".." group="group_mid_right_down_1"/>
                        <turrets macro="turret_ter_l_gatling_01_mk1_macro" path=".." group="group_mid_down_left_2"/>
                        <turrets macro="turret_ter_l_gatling_01_mk1_macro" path=".." group="group_mid_down_left_1"/>
                      </groups>
                      <software>
                        <software ware="software_dockmk2"/>
                        <software ware="software_flightassistmk1"/>
                        <software ware="software_scannerlongrangemk2"/>
                        <software ware="software_scannerobjectmk1"/>
                        <software ware="software_targetmk1"/>
                      </software>
                      <virtualmacros>
                        <thruster macro="thruster_gen_l_allround_01_mk2_macro"/>
                      </virtualmacros>
                    </create_loadout>

                    <set_value name="$RandomPitch" min="0deg" max="360deg"/>
                    <set_value name="$RandomRoll" min="0deg" max="360deg"/>

                    <create_ship name="$SecretServiceRewardShip" macro="macro.ship_atf_l_destroyer_01_a_macro" sector="$SecretServiceStation.sector" missioncue="$MissionCue" capturable="true">
                      <owner exact="faction.ownerless"/>
                      <loadout loadout="$SwansongLoadout"/>
                      <!-- Paint mod: Solset (Terran standard paint)-->
                      <paint ware="ware.paintmod_0117"/>
                      <safepos object="$SecretServiceStation"/>
                      <rotation pitch="$RandomPitch" roll="$RandomRoll"/>
                    </create_ship>
                    <set_object_name object="$SecretServiceRewardShip" page="30226" line="209" comment="Delilah's Swansong"/>

                    <add_to_group groupname="global.$IgnoredAbandonedShips" object="$SecretServiceRewardShip"/>

                    <signal_cue cue="Ch22_D_1_Claim_Reward"/>
                  </actions>
                </cue>

                <cue name="Ch22_D_1_Claim_Reward">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_mission cue="$SubMissionCue_D" name="{30226,9001}" description="{30226,9002}" rewardtext="{30226,9003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.terran" difficulty="level.easy" abortable="false" missionthread="$MissionCue" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.name"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_D_1_Trigger_Dialog">
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Inform_Mission_Secret_Service_Reward"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_D_1_Update_Objective">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$CurrentStep_D"/>
                        <set_objective cue="$SubMissionCue_D" step="$CurrentStep_D" action="objective.claim" object="$SecretServiceRewardShip" insert="true" updatebriefing="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch22_D_1_Ship_Claimed">
                      <conditions>
                        <check_any>
                          <event_object_changed_owner object="$SecretServiceRewardShip" owner="faction.player"/>
                          <event_object_destroyed object="$SecretServiceRewardShip"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch22_D_Clean_Up_Mission"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_D_Clean_Up_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <write_to_logbook category="missions" faction="faction.player" title="{30226,9001}" text="{30226,9004}"/>
                    <remove_mission cue="$SubMissionCue_D" type="completed"/>

                    <cancel_cue cue="Ch22_D_Secret_Service_Reward"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <!-- ID Range 10000 -->
            <cue name="Ch22_E_Terran_Invasion">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$SubMissionCue_E" exact="this"/>
                <create_mission cue="$SubMissionCue_E" name="{30226,10001}" description="{30226,10002}" rewardtext="{30226,10003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.terran" difficulty="level.veryhard" abortable="false" missionthread="$MissionCue" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.name"/>

                <!-- The ships will come from Earth - The Moon - Mercury - Venus - Mars - Oort Cloud - Pluto - Neptune - Uranus - Titan - Saturn - Jupiter - Asteroid Belt,
                 in that order. If not enough ships can be found, the invasion will be put on hold for a while. -->
                <set_value name="$TerranSectorMacroList" exact="[ macro.Cluster_104_Sector001_macro,
                                                                  macro.Cluster_104_Sector002_macro,
                                                                  macro.Cluster_106_Sector001_macro,
                                                                  macro.Cluster_102_Sector001_macro,
                                                                  macro.Cluster_101_Sector001_macro,
                                                                  macro.Cluster_116_Sector001_macro,
                                                                  macro.Cluster_111_Sector001_macro,
                                                                  macro.Cluster_110_Sector001_macro,
                                                                  macro.Cluster_109_Sector001_macro,
                                                                  macro.Cluster_108_Sector002_macro,
                                                                  macro.Cluster_108_Sector001_macro,
                                                                  macro.Cluster_107_Sector001_macro,
                                                                  macro.Cluster_100_Sector001_macro]"/>
                <create_list name="$TerranSectorList"/>
                <do_for_each in="$TerranSectorMacroList" name="$CurrentSectorMacro">
                  <find_sector name="$CurrentSector" macro="$CurrentSectorMacro"/>
                  <append_to_list name="$TerranSectorList" exact="$CurrentSector"/>
                </do_for_each>
                <set_value name="$MinShipAmount" exact="50"/>
                <set_value name="$MaxShipAmount" exact="400"/>
                <set_value name="$InvasionCooldownDelay" exact="15min"/>
              </actions>
              <cues>

                <cue name="Terran_Invasion_Setup_Target">
                  <actions>
                    <find_station_by_true_owner name="$TerranFleetAttackTarget" faction="faction.yaki" space="$YakiHomeSector"/>
                    <do_if value="not $TerranFleetAttackTarget">
                      <signal_cue cue="Clean_Up_Terran_Invasion_Mission"/>
                    </do_if>
                    <!-- If this happens while the fleet is on its way, we have to adjust their orders. -->
                    <do_elseif value="$TerranFleetCommander? and $TerranFleetCommander.isoperational">
                      <create_order id="'Attack'" object="$TerranFleetCommander" immediate="true">
                        <param name="primarytarget" value="$TerranFleetAttackTarget"/>
                        <param name="pursuetargets" value="true"/>
                        <param name="checkrelation" value="false"/>
                      </create_order>
                    </do_elseif>
                  </actions>
                  <cues>

                    <cue name="Target_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$TerranFleetAttackTarget"/>
                      </conditions>
                      <actions>
                        <reset_cue cue="Terran_Invasion_Setup_Target"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Terran_Invasion_Delay">
                  <actions>
                    <set_value name="$InvasionStartTime" exact="player.age + $InvasionCooldownDelay"/>
                    <update_mission cue="$SubMissionCue_E">
                      <briefing replace="true">
                        <objective step="1" action="objective.custom" customaction="{30226,10011}" endtime="$InvasionStartTime"/>
                      </briefing>
                    </update_mission>
                    <set_objective_from_briefing cue="$SubMissionCue_E" step="1"/>
                  </actions>
                  <delay exact="$InvasionCooldownDelay"/>
                  <actions>
                    <signal_cue cue="Terran_Invasion_Start"/>
                  </actions>
                </cue>

                <cue name="Terran_Invasion_Start">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_group groupname="$TerranJobCommanders"/>
                    <create_group groupname="$TerranFleet"/>
                    <!-- We want to grab the defence fleet commanders and leave their fleet structures intact. -->
                    <get_suitable_job result="$TerranDefenceJobList" faction="faction.terran" exceedquota="true" multiple="true" onlycommandeerable="true" tags="tag.terrandefence"/>
                    <debug_text text="'Found jobs: ' + $TerranDefenceJobList" chance="$DebugChance"/>

                    <do_for_each in="$TerranSectorList" name="$CurrentSector">
                      <debug_text text="'Checking sector ' + $CurrentSector.knownname" chance="$DebugChance"/>
                      <create_group groupname="$AvailableTerranCommanders" comment="Empty the group after each search."/>
                      <find_ship_by_true_owner groupname="$AvailableTerranCommanders" faction="faction.terran" space="$CurrentSector" job="$TerranDefenceJobList" multiple="true"/>
                      <debug_text text="'Found ' + $AvailableTerranCommanders.count + ' job commanders in sector ' + $CurrentSector.knownname" chance="$DebugChance"/>
                      <!-- Add the available ships to the pool one by one. -->
                      <do_for_each in="$AvailableTerranCommanders" name="$CurrentShip">
                        <debug_text text="'Now checking ' + $CurrentShip.knownname" chance="$DebugChance"/>
                        <do_if value="not $CurrentShip.iscommandeerable">
                          <debug_text text="$CurrentShip.name + ' ' + $CurrentShip + ' in sector ' + $CurrentShip.sector.knownname + ' is not commandeerable.'" chance="$DebugChance"/>
                        </do_if>
                        <do_else>
                          <add_to_group groupname="$TerranJobCommanders" object="$CurrentShip"/>
                          <add_to_group groupname="$TerranFleet" object="$CurrentShip"/>
                          <add_to_group groupname="$TerranFleet" list="$CurrentShip.allsubordinates"/>
                          <debug_text text="$CurrentShip.knownname + ' ' + $CurrentShip + ' and ' + $CurrentShip.allsubordinates.count + ' subordinates in sector ' + $CurrentShip.sector.knownname + ' are available. We now have ' + $TerranJobCommanders.count + ' job commanders and ' + $TerranFleet.count + ' ships total in the fleet.'" chance="$DebugChance"/>
                          <set_value name="$InvasionFleetRallySector" exact="$CurrentSector" comment="Last sector we found ships in becomes the rally point."/>
                        </do_else>
                        <do_if value="$TerranFleet.count ge $MaxShipAmount">
                          <break/>
                        </do_if>
                      </do_for_each>
                      <do_if value="$TerranFleet.count ge $MaxShipAmount">
                        <debug_text text="$TerranFleet.count + ' is more than ' + $MaxShipAmount + ' and we stop gathering ships.'" chance="$DebugChance"/>
                        <break/>
                      </do_if>
                    </do_for_each>

                    <!-- If we found enough ships, put together the invasion fleet under a spawned fleet commander. -->
                    <do_if value="$TerranFleet.count ge $MinShipAmount">
                      <create_ship name="$TerranFleetCommander" macro="macro.ship_atf_xl_battleship_01_a_macro" sector="$InvasionFleetRallySector" missioncue="$SubMissionCue_E" capturable="false">
                        <owner exact="faction.terran" overridenpc="true" />
                        <pilot>
                          <select faction="faction.terran" tags="tag.fighterpilot"/>
                        </pilot>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                        <people ref="terran_elite_military_crew"/>
                      </create_ship>
                      <set_object_name object="$TerranFleetCommander" page="30225" line="206" comment="Spear of Odin"/>
                      <debug_text text="'$TerranFleetCommander initialised as ' + $TerranFleetCommander.knownname" chance="$DebugChance"/>
                      <add_to_group groupname="$TerranFleet" object="$TerranFleetCommander"/>

                      <do_for_each in="$TerranJobCommanders" name="$CurrentShip" counter="$i">
                        <commandeer_object object="$CurrentShip"/>
                        <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                          <param name="commander" value="$TerranFleetCommander"/>
                          <param name="assignment" value="assignment.attack"/>
                          <param name="setgroupassignment" value="true"/>
                          <param name="subordinategroup" value="if ($i le 10) then $i else 1"/>
                        </create_order>
                      </do_for_each>

                      <create_order id="'Patrol'" object="$TerranFleetCommander" default="true">
                        <param name="space" value="$YakiHomeSector"/>
                      </create_order>

                      <create_order id="'Attack'" object="$TerranFleetCommander" immediate="true">
                        <param name="primarytarget" value="$TerranFleetAttackTarget"/>
                        <param name="pursuetargets" value="true"/>
                        <param name="checkrelation" value="false"/>
                        <param name="targetclasses" value="[class.station, class.ship_xl, class.ship_l]"/>
                      </create_order>

                      <set_objective cue="$SubMissionCue_E" step="1" action="objective.custom" customaction="{30226,10010}" object="$TerranFleetCommander" updatebriefing="true"/>
                    </do_if>

                    <!-- If after looping over all Terran core sectors we didn't find enough ships, the invasion is delayed. -->
                    <do_else>
                      <debug_text text="$TerranFleet.count + ' is lower than ' + $MinShipAmount + ' and the invasion timer gets reset.'" chance="$DebugChance"/>
                      <write_to_logbook category="missions" faction="faction.terran" title="{30226,10001}" text="{30226,10004}"/>
                      <reset_cue cue="Terran_Invasion_Delay"/>
                      <reset_cue cue="this"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="DEBUG_Fleet_Guidance" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$SubMissionCue_E" step="1" action="objective.find" group="$TerranFleet" silent="true" updatebriefing="true"/>
                        <debug_text text="$TerranFleet.count + ' ships left.'" chance="$DebugChance"/>
                      </actions>
                    </cue>

                    <cue name="DEBUG_Commander_Guidance" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$SubMissionCue_E" step="1" action="objective.find" object="$TerranFleetCommander" silent="true" updatebriefing="true"/>
                      </actions>
                    </cue>

                    <cue name="Terran_Fleet_Commander_Changed" version="3">
                      <conditions>
                        <check_any>
                          <event_object_commander_set object="$TerranFleetCommander" comment="For unknown reasons, $TerranFleetCommander can sometimes be found escorting other job ships in player saves."/>
                          <event_object_subordinate_promoted object="$TerranFleetCommander"/>
                        </check_any>
                        <check_value value="parent.state == cuestate.complete"/>
                      </conditions>
                      <actions>
                        <!-- Whenever the commander changes, we want to switch the guidance towards the new one. -->
                        <do_if value="not event.param.commander">
                          <set_value name="$TerranFleetCommander" exact="event.param"/>
                        </do_if>
                        <do_else>
                          <set_value name="$TerranFleetCommander" exact="event.param.toplevelcommander"/>
                        </do_else>

                        <debug_text text="event.object.knownname + ' was destroyed. $TerranFleetCommander set to ' + $TerranFleetCommander.knownname" chance="$DebugChance"/>
                        <do_if value="$TerranFleetCommander.isoperational">
                          <create_order id="'Patrol'" object="$TerranFleetCommander" default="true">
                            <param name="space" value="$YakiHomeSector"/>
                          </create_order>
                          <create_order id="'Attack'" object="$TerranFleetCommander" immediate="true">
                            <param name="primarytarget" value="$TerranFleetAttackTarget"/>
                            <param name="pursuetargets" value="true"/>
                            <param name="checkrelation" value="false"/>
                          </create_order>

                          <set_objective cue="$SubMissionCue_E" step="1" action="objective.custom" customaction="{30226,10010}" object="$TerranFleetCommander" silent="true" updatebriefing="true"/>

                          <!-- Reset cue to update event source. -->
                          <do_if value="Terran_Fleet_Entered_Neighbouring_Sector.state == cuestate.waiting">
                            <reset_cue cue="Terran_Fleet_Entered_Neighbouring_Sector"/>
                          </do_if>

                          <!-- Reset cue after each trigger instead of instantiating it. Otherwise, we'd get a trigger for each subordinate at once when the commander dies. -->
                          <reset_cue cue="this"/>
                        </do_if>
                        <do_else>
                          <!-- If for whatever reason no new commander could be set, count the fleet as defeated. -->
                          <signal_cue cue="Terran_Fleet_Destroyed"/>
                        </do_else>
                      </actions>
                      <patch sinceversion="2" state="waiting">
                        <do_if value="$TerranFleetCommander.commander or not $TerranFleetCommander.subordinates.count">
                          <signal_cue cue="Terran_Fleet_Destroyed"/>
                        </do_if>
                      </patch>
                      <patch sinceversion="3" state="waiting">
                        <!-- Before version 3, the cue didn't give the new commander a default order, only the immediate attack order.
                             If that attack order failed, e.g. because the new commander was a carrier with only missile turrets and no ammo, it would return to patrol in Sol. -->
                        <do_if value="$TerranFleetCommander.isoperational">
                          <create_order id="'Patrol'" object="$TerranFleetCommander" default="true">
                            <param name="space" value="$YakiHomeSector"/>
                          </create_order>
                          <create_order id="'Attack'" object="$TerranFleetCommander" immediate="true">
                            <param name="primarytarget" value="$TerranFleetAttackTarget"/>
                            <param name="pursuetargets" value="true"/>
                            <param name="checkrelation" value="false"/>
                          </create_order>
                        </do_if>
                      </patch>
                    </cue>

                    <!-- This cue will complete when the commander dies after some of the lower hierarchy has already been reassigned to other terran job commanders outside of the fleet. -->
                    <cue name="Terran_Fleet_Commander_Failsafe" checkinterval="5s">
                      <conditions>
                        <check_value value="not $TerranFleetCommander.isoperational"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Terran_Fleet_Destroyed"/>
                      </actions>
                    </cue>

                    <cue name="Terran_Fleet_Entered_Neighbouring_Sector">
                      <conditions>
                        <event_object_changed_sector object="$TerranFleetCommander" sector="$XenonSectorNextToYaki"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch22_Dialog_Inform_Mission_Invasion_Fleet_Approaching"/>
                      </actions>
                    </cue>

                    <cue name="Terran_Fleet_Destroyed">
                      <conditions>
                        <check_any>
                          <check_all>
                            <event_object_destroyed group="$TerranFleet"/>
                            <check_value value="$TerranFleet.count == 1"/>
                          </check_all>
                          <event_cue_signalled/>
                        </check_any>
                      </conditions>
                      <actions>
                        <set_value name="$TerranFleetCommander" exact="null"/>
                        <write_to_logbook category="missions" faction="faction.terran" title="{30226,10001}" text="{30226,10005}"/>
                        <reset_cue cue="Terran_Invasion_Delay"/>
                        <reset_cue cue="Terran_Invasion_Start"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Clean_Up_Terran_Invasion_Mission" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$TerranFleet.count">
                      <do_for_each in="$TerranFleetCommander.subordinates" name="$CurrentShip">
                        <remove_object_commander object="$CurrentShip"/>
                        <do_if value="$CurrentShip.iscommandeered">
                          <release_commandeered_object object="$CurrentShip"/>
                        </do_if>
                        <do_else>
                          <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true"/>
                        </do_else>
                      </do_for_each>
                    </do_if>

                    <remove_mission cue="$SubMissionCue_E" type="completed"/>
                    <write_to_logbook category="missions" faction="faction.player" title="{30226,10001}" text="{30226,10006}"/>

                    <unlock_achievement name="COH_PLOT_YAKI_4"/>

                    <signal_cue cue="Ch22_G_Intervention_Reward"/>
                    <cancel_cue cue="Ch22_E_Terran_Invasion"/>
                  </actions>
                  <patch sinceversion="2" state="cancelled">
                    <do_if value="$ToldTerransAboutYaki? and not $YakiHeadquarters.isoperational">
                      <set_value name="$CrateContent" exact="[
                        [[ware.inv_sedative, 5], [ware.inv_crystal_04, 13], [ware.inv_spaceflyeggs, 8]],
                        [[ware.modpart_enginefuelinjector_t3, 1], [ware.modpart_extendedfuelcontainer, 3], [ware.modpart_nividiumoxide, 3]],
                        [[ware.modpart_shieldgeneratorcoil_t3, 1], [ware.modpart_tuningsoftware, 1]],
                        [[ware.modpart_shipnanoweave_t3, 1], [ware.modpart_nividiumcrystallite, 3]],
                        [[ware.modpart_weaponchamber_t3, 1], [ware.modpart_highenergycatalyst, 3], [ware.modpart_tuningsoftware, 1]],
                        [[ware.modpart_weaponchamber_t3, 1], [ware.modpart_highenergycatalyst, 3], [ware.modpart_tuningsoftware, 1]],
                        [[ware.inv_seminar_management_3, 1], [ware.inv_seminar_management_4, 1]],
                        [[ware.inv_seminar_piloting_3, 3], [ware.inv_seminar_piloting_4, 1]],
                        [[ware.paintmod_0084, 10]]
                          ]" comment="Lockbox group -> Lockbox' crate group -> Crate"/>
                      <do_for_each in="$CrateContent" name="$CrateList">
                        <do_for_each in="$CrateList" name="$CrateContentList">
                          <add_inventory entity="player.entity" ware="$CrateContentList.{1}" exact="$CrateContentList.{2}"/>
                        </do_for_each>
                      </do_for_each>
                      <write_to_logbook category="missions" faction="faction.player" title="{30226,12001}" text="{30226,12004}"/>
                    </do_if>
                  </patch>
                </cue>

              </cues>
            </cue>

            <!-- ID Range 11000 -->
            <cue name="Ch22_F_Yaki_Reward">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$SubMissionCue_F" exact="this"/>
                <create_mission cue="$SubMissionCue_F" name="{30226,11001}" description="{30226,11002}" rewardtext="{30226,11003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.yaki" difficulty="level.easy" abortable="false" missionthread="$MissionCue" icon="'briefing_kendai_orcanic_01'" iconcaption="$YakiLeaderActor.name"/>

                <add_faction_relation faction="faction.yaki" otherfaction="faction.player" value="0.1" reason="relationchangereason.missioncompleted"/>
              </actions>
              <cues>

                <cue name="Ch22_F_Setup_Lockboxes">
                  <actions>
                    <set_value name="$TargetSector" exact="$YakiHomeSector"/>
                    <get_safe_pos result="$TargetOffset" sector="$YakiHomeSector" ignored="$YakiHeadquarters" exact="100km"/>
                    <set_value name="$TargetRadius" exact="100m"/>
                    <set_value name="$CrateContent" exact="[
                        [[ware.inv_sedative, 5], [ware.inv_crystal_04, 13], [ware.inv_spaceflyeggs, 8]],
                        [[ware.modpart_enginefuelinjector_t3, 1], [ware.modpart_extendedfuelcontainer, 3], [ware.modpart_nividiumoxide, 3]],
                        [[ware.modpart_shieldgeneratorcoil_t3, 1], [ware.modpart_tuningsoftware, 1]],
                        [[ware.modpart_shipnanoweave_t3, 1], [ware.modpart_nividiumcrystallite, 3]],
                        [[ware.modpart_weaponchamber_t3, 1], [ware.modpart_highenergycatalyst, 3], [ware.modpart_tuningsoftware, 1]],
                        [[ware.modpart_weaponchamber_t3, 1], [ware.modpart_highenergycatalyst, 3], [ware.modpart_tuningsoftware, 1]],
                        [[ware.inv_seminar_management_3, 1], [ware.inv_seminar_management_4, 1]],
                        [[ware.inv_seminar_piloting_3, 3], [ware.inv_seminar_piloting_4, 1]],
                        [[ware.paintmod_0123, 10]]
                    ]" comment="Lockbox group -> Lockbox' crate group -> Crate"/>
                    <set_value name="$LockboxMacro" exact="macro.sm_gen_lockbox_common_01_macro"/>
                    <create_group groupname="$DroppedObjects" comment="Gets filled in the RML."/>
                    <!--Use GM library to spawn crates. Output: $TargetObjects-->
                    <include_actions ref="md.GM_FindObject.Setup_SpawnCrates"/>
                    <do_for_each in="$TargetObjects" name="$CurrentCrate">
                      <set_object_min_hull object="$CurrentCrate" exact="20" comment="We don't want to deal with this one getting destroyed."/>
                    </do_for_each>
                    <signal_cue cue="Ch22_F_Find_Object"/>
                  </actions>
                </cue>

                <cue name="Ch22_F_Find_Object">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_F"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_F_FindObject_Ref" ref="md.RML_FindObject.FindObject">
                      <!--always pass these-->
                      <param name="EndSignalCue"      value="Ch22_F_Clean_Up_Mission"/>
                      <param name="MissionCue"        value="$SubMissionCue_F"/>
                      <param name="StartStep"         value="$CurrentStep_F" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="$DebugChance"/>
                      <param name="Text_Objective_Find"   value="{30225,1018}"/>
                      <param name="Text_Objective_Pickup" value="{30226,11003}"/>
                      <!--mission-related parameters-->
                      <param name="TargetSector"      value="$TargetSector"/>
                      <param name="TargetOffset"      value="$TargetOffset"/>
                      <param name="TargetRadius"      value="$TargetRadius"/>
                      <param name="TargetObjects"     value="$TargetObjects"/>
                      <param name="DroppedObjects"    value="$DroppedObjects"/>
                      <param name="SignalCue_ObjectsDropped" value="null"/>
                      <param name="SignalCue_ObjectCollected" value="null"/>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_F_Clean_Up_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <write_to_logbook category="missions" faction="faction.player" title="{30226,11001}" text="{30226,11004}"/>
                    <remove_mission cue="$SubMissionCue_F" type="completed"/>

                    <cancel_cue cue="Ch22_F_Yaki_Reward"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <!-- ID Range 12000 -->
            <cue name="Ch22_G_Intervention_Reward">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$SubMissionCue_G" exact="this"/>
                <create_mission cue="$SubMissionCue_G" name="{30226,12001}" description="{30226,12002}" rewardtext="{30226,12003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.terran" difficulty="level.trivial" abortable="false" missionthread="$MissionCue" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.name"/>

                <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.1" reason="relationchangereason.missioncompleted"/>
              </actions>
              <cues>

                <cue name="Ch22_G_Trigger_Dialog">
                  <actions>
                    <signal_cue cue="Ch22_Dialog_Inform_Mission_Intervention_Corps_Reward"/>
                  </actions>
                </cue>

                <cue name="Ch22_G_Setup_Lockboxes">
                  <actions>
                    <set_value name="$TargetSector" exact="$YakiHomeSector"/>
                    <get_safe_pos result="$TargetOffset" sector="$YakiHomeSector" exact="100km"/>
                    <set_value name="$TargetRadius" exact="100m"/>
                    <set_value name="$CrateContent" exact="[
                        [[ware.inv_sedative, 5], [ware.inv_crystal_04, 13], [ware.inv_spaceflyeggs, 8]],
                        [[ware.modpart_enginefuelinjector_t3, 1], [ware.modpart_extendedfuelcontainer, 3], [ware.modpart_nividiumoxide, 3]],
                        [[ware.modpart_shieldgeneratorcoil_t3, 1], [ware.modpart_tuningsoftware, 1]],
                        [[ware.modpart_shipnanoweave_t3, 1], [ware.modpart_nividiumcrystallite, 3]],
                        [[ware.modpart_weaponchamber_t3, 1], [ware.modpart_highenergycatalyst, 3], [ware.modpart_tuningsoftware, 1]],
                        [[ware.modpart_weaponchamber_t3, 1], [ware.modpart_highenergycatalyst, 3], [ware.modpart_tuningsoftware, 1]],
                        [[ware.inv_seminar_management_3, 1], [ware.inv_seminar_management_4, 1]],
                        [[ware.inv_seminar_piloting_3, 3], [ware.inv_seminar_piloting_4, 1]],
                        [[ware.paintmod_0084, 10]]
                    ]" comment="Lockbox group -> Lockbox' crate group -> Crate"/>
                    <set_value name="$LockboxMacro" exact="macro.sm_gen_lockbox_common_01_macro"/>
                    <create_group groupname="$DroppedObjects" comment="Gets filled in the RML."/>
                    <!--Use GM library to spawn crates. Output: $TargetObjects-->
                    <include_actions ref="md.GM_FindObject.Setup_SpawnCrates"/>
                    <do_for_each in="$TargetObjects" name="$CurrentCrate">
                      <set_object_min_hull object="$CurrentCrate" exact="20" comment="We don't want to deal with this one getting destroyed."/>
                    </do_for_each>
                    <signal_cue cue="Ch22_G_Find_Object"/>
                  </actions>
                </cue>

                <cue name="Ch22_G_Find_Object">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep_G"/>
                  </actions>
                  <cues>

                    <cue name="Ch22_G_FindObject_Ref" ref="md.RML_FindObject.FindObject">
                      <!--always pass these-->
                      <param name="EndSignalCue"      value="Ch22_G_Clean_Up_Mission"/>
                      <param name="MissionCue"        value="$SubMissionCue_G"/>
                      <param name="StartStep"         value="$CurrentStep_G" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="$DebugChance"/>
                      <param name="Text_Objective_Find"   value="{30225,1018}"/>
                      <param name="Text_Objective_Pickup" value="{30226,12003}"/>
                      <!--mission-related parameters-->
                      <param name="TargetSector"      value="$TargetSector"/>
                      <param name="TargetOffset"      value="$TargetOffset"/>
                      <param name="TargetRadius"      value="$TargetRadius"/>
                      <param name="TargetObjects"     value="$TargetObjects"/>
                      <param name="DroppedObjects"    value="$DroppedObjects"/>
                      <param name="SignalCue_ObjectsDropped" value="null"/>
                      <param name="SignalCue_ObjectCollected" value="null"/>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch22_G_Clean_Up_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <write_to_logbook category="missions" faction="faction.player" title="{30226,12001}" text="{30226,12004}"/>
                    <remove_mission cue="$SubMissionCue_G" type="completed"/>

                    <cancel_cue cue="Ch22_G_Intervention_Reward"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch22_Clean_Up_Yaki_Investigation_Mission_5">
              <conditions>
                <check_any>
                  <event_cue_cancelled cue="Ch22_A_Inform_Terran_Fleet"/>
                  <event_cue_cancelled cue="Ch22_B_Deploy_Yaki_Beacons"/>
                  <event_cue_cancelled cue="Ch22_C_Yaki_Freedom"/>
                  <event_cue_cancelled cue="Ch22_D_Secret_Service_Reward"/>
                  <event_cue_cancelled cue="Ch22_E_Terran_Invasion"/>
                  <event_cue_cancelled cue="Ch22_F_Yaki_Reward"/>
                  <event_cue_cancelled cue="Ch22_G_Intervention_Reward"/>
                </check_any>
                <check_value value="(Ch22_A_Inform_Terran_Fleet.state != cuestate.complete)
                                and (Ch22_B_Deploy_Yaki_Beacons.state != cuestate.complete)
                                and (Ch22_C_Yaki_Freedom.state != cuestate.complete)
                                and (Ch22_D_Secret_Service_Reward.state != cuestate.complete)
                                and (Ch22_E_Terran_Invasion.state != cuestate.complete)
                                and (Ch22_F_Yaki_Reward.state != cuestate.complete)
                                and (Ch22_G_Intervention_Reward.state != cuestate.complete)"/>
              </conditions>
              <actions>
                <debug_text text="'Cleaning up Yaki Investigation mission 5 (mission thread).'" chance="$DebugChance"/>

                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30226,5001}" text="{30226,5004}"/>

                <remove_value name="$SecretServiceActor.$MissionCue"/>
                <remove_value name="$WingmateActor.$MissionCue"/>
                <remove_value name="$YakiRenegadeActor.$MissionCue"/>
                <remove_value name="$YakiLeaderActor.$MissionCue"/>
                <remove_value name="$YakiCivilianActor.$MissionCue"/>
                <remove_value name="$MiningLeaderActor.$MissionCue"/>
                <remove_value name="$MiningSubordinateActor.$MissionCue"/>

                <cancel_cue cue="Ch22_Decide_Outcome"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Wingmate_Transfer">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Remove custom handler so that he responds to comms requests like a generic NPC. -->
            <set_entity_traits entity="$WingmateActor" missionactor="false" customhandler="false" subtitlename="true"/>

            <!-- Make sure he is set up properly. -->
            <include_actions ref="Setup_Wingmate"/>

            <!-- Stop the handlers from interfering in the future. -->
            <reset_cue cue="Activate_Wingmate_Handlers"/>

            <!-- Make him invulnerable until he's safe. -->
            <set_object_min_hull object="$WingmateShip" exact="100"/>
            <set_object_min_shield object="$WingmateShip" exact="100"/>

            <cancel_all_orders object="$WingmateShip"/>

            <run_actions ref="md.LIB_Generic.TransferShipOwnership">
              <param name="Ship" value="$WingmateShip"/>
              <param name="Faction" value="faction.player"/>
            </run_actions>

            <set_owner object="$WingmateActor" faction="faction.player"/>

            <!-- Find suitable nearby station -->
            <do_if value="$WingmateShip.sector" comment="Sector could always be null, e.g. if the ship is on a superhighway.">
              <find_station name="$WingmateTransferStation" space="player.galaxy" sortbygatedistanceto="$WingmateShip.sector">
                <match_relation_to faction="faction.player" relation="dock"/>
                <match_dock size="tag.dock_m"/>
              </find_station>
            </do_if>
            <do_else>
              <find_station name="$WingmateTransferStation" space="player.galaxy" sortbygatedistanceto="$YakiHomeSector">
                <match_relation_to faction="faction.player" relation="dock"/>
                <match_dock size="tag.dock_m"/>
              </find_station>
            </do_else>

            <do_if value="$WingmateTransferStation">
              <create_order id="'Wait'" object="$WingmateShip" default="true"/>
              <create_order id="'DockAndWait'" object="$WingmateShip">
                <param name="destination" value="$WingmateTransferStation"/>
              </create_order>
              <create_order id="'MoveToObject'" name="$WingmateTransferOrder" object="$WingmateShip" immediate="true">
                <param name="destination" value="$WingmateTransferStation"/>
                <param name="noattackresponse" value="true"/>
              </create_order>
            </do_if>
          </actions>
          <delay exact="5min"/>
          <actions>
            <!-- Failsafe -->
            <do_if value="Wingmate_Transfer_Order_Complete.state == cuestate.waiting">
              <signal_cue cue="Wingmate_Transfer_Order_Complete"/>
            </do_if>
          </actions>
          <cues>

            <cue name="Wingmate_Transfer_Order_Complete">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_object_order_cancelled object="$WingmateShip" order="$WingmateTransferOrder"/>
                  <event_object_order_finished object="$WingmateShip" order="$WingmateTransferOrder"/>
                  <event_object_docked object="$WingmateShip" dock="$WingmateTransferStation"/>
                </check_any>
              </conditions>
              <actions>
                <debug_text text="'Wingmate made vulnerable again for the following reason: ' + event.name" chance="$DebugChance"/>

                <set_object_min_hull object="$WingmateShip" exact="0"/>
                <set_object_min_shield object="$WingmateShip" exact="0"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Mission 9 (Yaki Mission 6), ID Range 13000 -->

        <cue name="Yaki_Trade_Mission_Activation_Manager">
          <conditions>
            <check_any>
              <check_all>
                <event_cue_cancelled cue="Ch22_Decide_Outcome"/>
                <check_value value="$DalBusta?"/>
              </check_all>
              <check_all>
                <event_cue_completed cue="Check_For_Diplomatic_Mentor_Plot_Ending"/>
                <check_value value="Ch22_Decide_Outcome.state == cuestate.cancelled"/>
              </check_all>
            </check_any>
            <check_value value="$YakiHeadquarters.isoperational"/>
          </conditions>
          <delay exact="1min"/>
          <actions>
            <signal_cue cue="Ch23_Yaki_Trade"/>
          </actions>
        </cue>

        <cue name="Ch23_Yaki_Trade">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <!-- All dialog cues should be outside of the resettable parent cue. -->
            <cue name="Ch23_Dialog_Mission_Offer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch23_Dal_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30200001],[30226801],[30226802],[30226803],[30226804],[30226805],[30226806],[30226807],[30226808]]"/>
                  <param name="EndSignalCue"      value="Ch23_2_Eliminate_Xenon"/>

                  <!--
                      Dal:
                          Hey there partner.
                          I just had a tremendously refreshing conversation with a representative(female representative) of the Yaki, and I might have dug up another opportunity for you.
                          It's really just a side project. Something small to give you an objective when you find yourself bored.
                          If everything goes well, we could enable the Yaki to trade with their neighbours, and create a new market for your goods in this part of the Gate network.
                          All it would take is... the elimination of the entire Xenon presence in their system.
                          (calming, raised hands)Now, don't look at me like that. It's just a proposal, OK?
                          And before you ask: There won't be a reward. At least, not cash on the spot.
                          I just thought that if you're conducting military operations in this area of the Gate network anyway, you might as well get yourself another trade partner in return for your efforts.
                          All right, that's it. Have a good one. Dal out.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch23_Dialog_Mission_Aborted_Cutscene" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch23_Dal_Speak_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="IsInMission"       value="false"/>
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30200006]]"/>
                  <param name="EndSignalCue"      value="Ch23_Enable_Mission_Restart"/>

                  <!--
                      Dal:
                          You can always come and find me if you change your mind.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch23_Dialog_Mission_Aborted_In_Person" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <run_actions ref="md.LIB_Generic.SuppressCommChatter_AddCue">
                  <param name="Cue" value="Start"/>
                </run_actions>

                <speak actor="$DalBusta" priority="100">
                  <text line="30200006" comment="You can always come and find me if you change your mind."/>
                </speak>
              </actions>
              <cues>
                <cue name="Ch23_Dialog_Mission_Aborted_In_Person_Speak_Finished">
                  <conditions>
                    <event_speak_finished actor="$DalBusta" line="30200006"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <signal_cue cue="Ch23_Enable_Mission_Restart"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch23_Dialog_Mission_Complete_Kendai_Message">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch23_Yaki_Leader_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="Actor"             value="$YakiLeaderActor"/>
                  <param name="CutsceneKey"       value="$YakiLeaderCutsceneKey"/>
                  <param name="Lines"             value="[[30226801],[30226802],[30226803],[30226804],[30226805]]"/>
                  <param name="EndSignalCue"      value="Ch23_Dialog_Mission_Complete_Dal_Response"/>
                  <!--
                      Kendai:
                          (incredulous)Did you just wipe our neighbourhood clean of Xenon? Just like that?
                          (incredulous)I'm... speechless. I thought that Dal Busta guy was joking!
                          (grateful, hesitant)I don't know how to reward you. Look at you! There's nothing of value to you that we could still give.
                          (grateful, but very distracted)Sorry, this is breathtaking. I have to make a load of arrangements right away.
                          (grateful, but very distracted)Take care.
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch23_Dialog_Mission_Complete_Dal_Response">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch23_Dal_Speak_3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="DelayInitial"      value="5s"/>
                  <param name="Lines"             value="[[30226811],[30226812],[30226813]]"/>
                  <param name="EndSignalCue"      value="Ch23_Clean_Up_Mission"/>

                  <!--
                      Dal:
                          Well, well, well. Mission successful, I'd say.
                          With the Xenon gone, the Yaki won't have to fear for their lives any more, but they also can't rely on the machines' protection.
                          I hope your traders are already waiting in the wings. Let's make the most of this!
                                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch23_Parent_Cue" comment="Reset this when creating the mission again, e.g. after the player has decided to clean up their mission manager, but now wants it back.">
              <cues>

                <cue name="Ch23_Create_Mission">
                  <actions>
                    <!-- Savage Spur, Matrix #79B, Tharka's Cascade -->
                    <set_value name="$DescriptionText" exact="readtext.{30226}.{13002} + '\n\n' + readtext.{20003}.{1120001} + '\n' + readtext.{20003}.{330001} + '\n' + readtext.{20003}.{320001}"/>

                    <create_mission cue="$MissionCue" name="{30226,13001}" description="$DescriptionText" rewardtext="{30226,13003}" type="missiontype.plot" group="missiongroup.story_yaki" faction="faction.player" difficulty="level.veryhard" abortable="true" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name"/>
                  </actions>
                  <cues>

                    <cue name="Ch23_1_Intro_Dialog">
                      <actions>
                        <do_if value="Ch23_Dialog_Mission_Offer.state == cuestate.waiting" comment="Only play this explanation the first time the mission is started.">
                          <signal_cue cue="Ch23_Dialog_Mission_Offer"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch23_2_Eliminate_Xenon"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch23_2_Eliminate_Xenon">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$XenonTargetClusterMacroList" exact="[macro.Cluster_112_macro, 
                                                                    macro.Cluster_33_macro,
                                                                    macro.Cluster_32_macro]" comment="Savage Spur, Matrix #79B, Tharka's Cascade"/>

                        <create_list name="$XenonTargetClusterList"/>

                        <do_for_each in="$XenonTargetClusterMacroList" name="$CurrentClusterMacro">
                          <find_cluster name="$CurrentCluster" macro="$CurrentClusterMacro"/>
                          <append_to_list name="$XenonTargetClusterList" exact="$CurrentCluster"/>
                        </do_for_each>

                        <set_value name="$CurrentStep"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,13010}" insert="true" updatebriefing="true"/>
                      </actions>
                      <cues>

                        <cue name="Ch23_2_Update_Objective" version="3">
                          <actions>
                            <create_group groupname="$XenonTargets"/>

                            <!-- Step 1: Find all Xenon stations in the relevant clusters. -->
                            <find_station_by_true_owner groupname="$ExcludedAsteroidTurrets" macro="macro.asteroid_turret_m_01_macro" faction="faction.xenon" space="$XenonTargetClusterList" multiple="true" comment="Asteroid turrets are difficult to find on the map."/>
                            <find_station_by_true_owner groupname="$XenonTargets" faction="faction.xenon" space="$XenonTargetClusterList" multiple="true" excluded="$ExcludedAsteroidTurrets"/>

                            <!-- Step 2: Find all Xenon M, L and XL military ships in the relevant clusters. -->
                            <find_ship_by_true_owner groupname="$XenonTargets" faction="faction.xenon" class="class.ship_xl" primarypurpose="purpose.fight" space="$XenonTargetClusterList" multiple="true"/>
                            <find_ship_by_true_owner groupname="$XenonTargets" faction="faction.xenon" class="class.ship_l" primarypurpose="purpose.fight" space="$XenonTargetClusterList" multiple="true"/>
                            <find_ship_by_true_owner groupname="$XenonTargets" faction="faction.xenon" class="class.ship_m" primarypurpose="purpose.fight" space="$XenonTargetClusterList" multiple="true"/>

                            <!-- Step 3: Determine mission status. -->
                            <do_if value="not $XenonTargets.count">
                              <signal_cue cue="Ch23_Dialog_Mission_Complete_Kendai_Message"/>
                            </do_if>
                            <do_elseif value="$XenonTargets.count le 10">
                              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,13010}" group="$XenonTargets" updatebriefing="true"/>
                            </do_elseif>
                          </actions>
                          <patch sinceversion="2">
                            <do_for_each in="$XenonTargets" name="$CurrentTarget" reverse="true">
                              <do_if value="$CurrentTarget.macro == macro.asteroid_turret_m_01_macro">
                                <remove_from_group group="$XenonTargets" object="$CurrentTarget"/>
                              </do_if>
                            </do_for_each>
                            <reset_cue cue="this"/>
                          </patch>
                          <patch sinceversion="3" comment="Remaining targets for guidance set from 5 to 10">
                            <do_if value="$XenonTargets.count">
                              <reset_cue cue="this"/>
                            </do_if>
                          </patch>
                          <cues>

                            <cue name="Ch23_2_DEBUG_Show_Remaining_Xenon">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30226,13010}" group="$XenonTargets" updatebriefing="true"/>
                              </actions>
                            </cue>

                            <cue name="Ch23_2_Target_Left_Mission_Area">
                              <conditions>
                                <event_object_changed_cluster group="$XenonTargets"/>
                                <check_value value="not $XenonTargetClusterList.indexof.{event.param}"/>
                              </conditions>
                              <actions>
                                <remove_from_group group="$XenonTargets" object="event.object"/>
                                <reset_cue cue="parent"/>
                              </actions>
                            </cue>

                            <cue name="Ch23_2_Target_Destroyed">
                              <conditions>
                                <event_object_destroyed group="$XenonTargets"/>
                              </conditions>
                              <actions>
                                <reset_cue cue="parent"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch23_Mission_Aborted" version="2">
                      <conditions>
                        <event_mission_aborted cue="$MissionCue"/>
                      </conditions>
                      <actions>
                        <remove_mission cue="$MissionCue" type="aborted"/>
                        <cancel_cue cue="Ch23_2_Eliminate_Xenon"/>

                        <do_if value="player.entity.hascontext.{$DalBusta.room}">
                          <signal_cue cue="Ch23_Dialog_Mission_Aborted_In_Person"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch23_Dialog_Mission_Aborted_Cutscene"/>
                        </do_else>
                      </actions>
                      <patch sinceversion="2">
                        <remove_mission cue="$MissionCue" type="aborted"/>
                      </patch>
                    </cue>

                    <cue name="Ch23_Enable_Mission_Restart">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch23_Dal_Conversation_Header" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$DalBusta"/>
                            <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                            <check_value value="Setup_Yaki_Leader.state != cuestate.cancelled"/>
                          </conditions>
                          <actions>
                            <add_player_choice text="{30226,13030}" section="ch23_dal_choice"/>
                          </actions>
                        </cue>

                        <cue name="Ch23_Dal_Conversation_Section_Choice" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$DalBusta" section="ch23_dal_choice"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$DalBusta" hidechoices="true" line="30226809" comment="Ah, yes, that project. Time to give it a go?"/>

                            <add_player_choice text="{30226,13031}" section="ch23_dal_mission_restart" position="right"/>
                            <add_player_choice text="{30226,13032}" section="ch23_dal_mission_decline" position="left"/>
                          </actions>
                        </cue>

                        <cue name="Ch23_Dal_Conversation_Section_Restart">
                          <conditions>
                            <event_conversation_next_section actor="$DalBusta" section="ch23_dal_mission_restart"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$DalBusta" hidechoices="true" line="30220984" comment="Excellent!"/>
                          </actions>
                        </cue>

                        <cue name="Ch23_Dal_Conversation_Section_Decline" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$DalBusta" section="ch23_dal_mission_decline"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$DalBusta" hidechoices="true" line="30226810" comment="I'll be waiting."/>
                          </actions>
                        </cue>

                        <cue name="Ch23_Dal_Conversation_Finished">
                          <conditions>
                            <event_conversation_finished actor="$DalBusta" outcome="ch23_dal_mission_restart"/>
                          </conditions>
                          <actions>
                            <reset_cue cue="Ch23_Parent_Cue"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch23_Clean_Up_Mission" version="3">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_cue_cancelled cue="Setup_Yaki_Leader" comment="This cue gets cancelled if the Yaki lose all their stations."/>
                    </check_any>
                  </conditions>
                  <actions>
                    <!-- Failsafe. -->
                    <run_actions ref="md.LIB_Generic.SuppressCommChatter_RemoveCue">
                      <param name="Cue" value="Start"/>
                    </run_actions>

                    <do_if value="event.name != 'event_cue_cancelled'">
                      <set_faction_relation_locked faction="faction.yaki" locked="false" comment="Only relevant for testing."/>
                      <set_faction_relation faction="faction.yaki" otherfaction="faction.argon" value="faction.yaki.relation.neutral.mid"/>
                      <set_faction_relation faction="faction.yaki" otherfaction="faction.antigone" value="faction.yaki.relation.neutral.mid"/>
                      <set_faction_relation faction="faction.yaki" otherfaction="faction.teladi" value="faction.yaki.relation.neutral.mid"/>
                      <set_faction_relation faction="faction.yaki" otherfaction="faction.ministry" value="faction.yaki.relation.neutral.mid"/>

                      <do_if value="md.$SplitFactions?">
                        <do_for_each in="md.$SplitFactions" name="$CurrentFaction">
                          <set_faction_relation faction="faction.yaki" otherfaction="$CurrentFaction" value="faction.yaki.relation.neutral.mid"/>
                        </do_for_each>
                      </do_if>

                      <do_if value="md.$DLCBoronFactions?">
                        <do_for_each in="md.$DLCBoronFactions" name="$CurrentFaction">
                          <set_faction_relation faction="faction.yaki" otherfaction="$CurrentFaction" value="faction.yaki.relation.neutral.mid"/>
                        </do_for_each>
                      </do_if>

                      <add_faction_relation faction="faction.yaki" otherfaction="faction.player" value="0.32" reason="relationchangereason.missioncompleted"/>

                      <remove_mission cue="$MissionCue" type="completed"/>
                      <write_to_logbook category="missions" faction="faction.player" title="{30226,13001}" text="{30226,13004}"/>

                      <unlock_achievement name="COH_PLOT_YAKI_6"/>
                    </do_if>
                    <do_else>
                      <remove_mission cue="$MissionCue" type="failed"/>
                      <write_to_logbook category="missions" faction="faction.player" title="{30226,13001}" text="{30226,13005}"/>
                    </do_else>

                    <set_userdata storystate="'story_yaki_complete'" value="1"/>
                    <cancel_cue cue="Ch23_Yaki_Trade"/>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="faction.yaki.relationto.{faction.player} gt faction.yaki.relation.killmilitary.max" comment="If the relation is below this threshold, assume that the player declared war.">
                      <add_faction_relation faction="faction.yaki" otherfaction="faction.player" value="0.32" reason="relationchangereason.missioncompleted"/>
                    </do_if>
                  </patch>
                  <patch sinceversion="3" state="cancelled">
                    <do_if value="md.$DLCBoronFactions? and faction.argon.hasrelation.neutral.{faction.yaki}" comment="This seems to be the only 'flag' we can use to determine if the mission was completed successfully">
                      <do_for_each in="md.$DLCBoronFactions" name="$CurrentFaction">
                        <set_faction_relation faction="faction.yaki" otherfaction="$CurrentFaction" value="faction.yaki.relation.neutral.mid"/>
                      </do_for_each>
                    </do_if>
                  </patch>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <!-- *** Activation cues for mechanics that are supposed to still work after the plot is complete. *** -->
        <cue name="Activate_Yaki_Home_Sector_Defence">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Yaki_Home_Sector_Defence_Xenon_Horde_Trigger">
              <conditions>
                <event_object_entered space="$YakiHomeSector"/>
                <check_value value="event.param.relationto.{faction.yaki} le faction.yaki.relation.killmilitary.max"/>
                <check_value value="event.param.owner != faction.xenon"/>
                <check_value value="event.param.owner != faction.khaak"/>
              </conditions>
              <delay exact="5s"/>
              <actions>
                <run_actions ref="Xenon_Horde" result="$DefenceXenonHorde">
                  <param name="SectorList" value="[$YakiHomeSector, $XenonSectorNextToYaki]"/>
                  <param name="Target" value="event.param"/>
                </run_actions>
              </actions>
              <delay exact="1h"/>
              <actions>
                <reset_cue cue="this"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Activate_Xenon_Horde_Warning">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Xenon_Horde_Approaches_Sol">
              <conditions>
                <event_object_changed_sector group="$EarthXenonHorde" sector="$TerranOutpostSector"/>
                <check_value value="not faction.terran.hasrelation.enemy.{faction.player}"/>
              </conditions>
              <cues>

                <cue name="Xenon_Horde_Service_Speak_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30226604],[30226605]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      Delilah:
                          Operative, this is an emergency! A massive Xenon assault is approaching the Sol Gate!
                          I need you to reinforce the defences, now! If you still have an ace up your sleeve, this is the time to play it!
                            -->
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Activate_Xenon_Horde_Replenishment">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Savegame compatibility. Some ships may have split off from the fleet and have become their own toplevelcommander. -->
            <do_for_each in="$EarthXenonHorde" name="$CurrentShip">
              <add_to_group groupname="$EarthXenonHordeTopLevelCommanders" object="$CurrentShip.toplevelcommander"/>
            </do_for_each>
            <do_for_each in="$EarthXenonHordeTopLevelCommanders" name="$CurrentShip">
              <do_if value="$CurrentShip.type == shiptype.battleship">
                <set_value name="$EarthXenonHordeCommander" exact="$CurrentShip"/>
                <debug_text text="'$EarthXenonHordeCommander set to: ' + $EarthXenonHordeCommander.knownname" chance="$DebugChance"/>
                <break/>
              </do_if>
            </do_for_each>

            <do_if value="not $EarthXenonHordeCommander?">
              <cancel_cue cue="this"/>
            </do_if>
          </actions>
          <cues>

            <cue name="Find_Xenon_Shipyards">
              <actions>
                <find_station_by_true_owner groupname="$XenonShipyards" faction="faction.xenon" space="[$YakiExitSector, $YakiHomeSector, $XenonSectorNextToYaki, $TharkasCascadeXVII, $TharkasCascadeXV]" multiple="true" shipyard="true"/>
                <find_station_by_true_owner groupname="$XenonShipyards" faction="faction.xenon" space="[$YakiExitSector, $YakiHomeSector, $XenonSectorNextToYaki, $TharkasCascadeXVII, $TharkasCascadeXV]" multiple="true" wharf="true"/>

                <debug_text text="'$XenonShipyards found: ' + $XenonShipyards" chance="$DebugChance"/>

                <do_if value="not $XenonShipyards.count">
                  <cancel_cue cue="Activate_Xenon_Horde_Replenishment"/>
                </do_if>
              </actions>
              <cues>

                <cue name="Xenon_Ship_Constructed" instantiate="true">
                  <conditions>
                    <event_object_built_ship group="$XenonShipyards"/>
                  </conditions>
                  <actions>
                    <do_if value="event.param.primarypurpose == purpose.fight">
                      <do_if value="[shiptype.destroyer, shiptype.carrier, shiptype.battleship].indexof.{event.param.type}">
                        <create_order id="'AssignCommander'" object="event.param" immediate="true">
                          <param name="commander" value="$EarthXenonHordeCommander"/>
                          <param name="assignment" value="assignment.attack"/>
                          <param name="cancelorders" value="true"/>
                        </create_order>
                        <debug_text text="'Newly build Xenon ship assigned as attacker to ' + $EarthXenonHordeCommander.knownname + ': ' + event.param.knownname" chance="$DebugChance"/>
                      </do_if>
                      <do_else>
                        <create_order id="'AssignCommander'" object="event.param" immediate="true">
                          <param name="commander" value="$EarthXenonHordeCommander"/>
                          <param name="assignment" value="assignment.interception"/>
                          <param name="cancelorders" value="true"/>
                        </create_order>
                        <debug_text text="'Newly build Xenon ship assigned as interceptor to ' + $EarthXenonHordeCommander.knownname + ': ' + event.param.knownname" chance="$DebugChance"/>
                      </do_else>
                      <add_to_group groupname="$EarthXenonHorde" object="event.param"/>
                    </do_if>
                    <do_else>
                      <debug_text text="'Newly build Xenon ship is not meant for fighting: ' + event.param.knownname" chance="$DebugChance"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Xenon_Shipyard_Destroyed">
                  <conditions>
                    <event_object_destroyed group="$XenonShipyards"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Xenon shipyard destroyed. Re-counting shipyards.'" chance="$DebugChance"/>
                    <reset_cue cue="parent"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Deactivate_Xenon_Horde_Replenishment">
              <conditions>
                <check_any>
                  <event_object_destroyed object="$EarthXenonHordeCommander"/>
                  <event_object_destroyed object="$TerranTarget"/>
                </check_any>
              </conditions>
              <actions>
                <debug_text text="'$EarthXenonHordeCommander or $TerranTarget destroyed. Cancelling replenishment.'" chance="$DebugChance"/>
                <cancel_cue cue="parent"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="DEBUG_Xenon_Horde">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <find_sector name="$EarthSector" macro="macro.cluster_104_sector001_macro" comment="Earth"/>
            <find_station name="$TerranTarget" owner="faction.terran" space="$EarthSector">
              <match_content canclaimownership="true"/>
            </find_station>
            <run_actions ref="Xenon_Horde" result="$EarthXenonHorde">
              <param name="SectorList"          value="[$YakiExitSector, $YakiHomeSector, $XenonSectorNextToYaki, $TharkasCascadeXVII, $TharkasCascadeXV]"/>
              <param name="Target"              value="$TerranTarget"/>
              <param name="AllowOtherTargets"   value="true"/>
              <param name="DefaultPatrolTargetSector" value="true"/>
              <param name="RallySector"         value="$YakiHomeSector"/>
            </run_actions>
          </actions>
        </cue>

        <library name="Xenon_Horde" purpose="run_actions">
          <params>
            <param name="SectorList"                                   comment="Which sectors should we pull the Xenon ships from, and in which order?"/>
            <param name="Target"                                       comment="Which target should they attack?"/>
            <param name="ShipCount"                    default="null"  comment="How many ships total? If left empty, we'll take everything available in the provided sectors."/>
            <param name="AllowOtherTargets"            default="true"  comment="Should the ships react when they get attacked along the way?"/>
            <param name="CapitalShipCount"             default="-1"    comment="How many capital ships should be part of the horde? If you want all of them, pick -1."/>
            <param name="DefaultProtectTargetPosition" default="false" comment="Should 'ProtectPosition' on the target's position be given as a default order?"/>
            <param name="DefaultPatrolTargetSector"    default="false" comment="Should 'Patrol' on the target's sector be given as a default order?"/>
            <param name="DefaultPatrolOriginSector"    default="false" comment="Should 'Patrol' on the origin sector be given as a default order?"/>
            <param name="IncludeScouts"                default="false" comment="Are we including Xenon T in the attack? They're really fast and tend to flee to other sectors."/>
            <param name="RallySector"                  default="null"  comment="If supplied, we spawn a flagship and form the fleet around it to give the Xenon a better fighting chance. This will destroy previous hierarchies."/>
            <param name="MinFleetComposition"          default="null"  comment="If supplied, we spawn ships until the desired amount of each ship macro exists."/>
            <param name="DebugChance"                  default="0"/>
          </params>
          <actions>
            <create_group groupname="$XenonHorde"/>
            <set_value name="$FleetComposition" exact="table[]"/>
            <do_for_each in="$SectorList" name="$CurrentSector">
              <create_group groupname="$AvailableShips" comment="Empty group after each sector."/>
              <find_ship_by_true_owner groupname="$AvailableShips" faction="faction.xenon" class="class.ship" primarypurpose="purpose.fight" space="$CurrentSector" multiple="true"/>

              <do_for_each in="$AvailableShips" name="$CurrentShip">
                <!--<do_if value="not $CurrentShip.iscommandeerable">
                  <debug_text text="$CurrentShip.name + ' is not commandeerable. Check the next one.'" chance="$DebugChance"/>
                </do_if>-->
                <do_if value="[shiptype.scout].indexof.{$CurrentShip.type} and not $IncludeScouts">
                  <debug_text text="$CurrentShip.name + ' is a scout ship and we\'re excluding them from the attack.'" chance="$DebugChance"/>
                </do_if>
                <do_else>
                  <do_if value="[shiptype.destroyer, shiptype.battleship, shiptype.carrier].indexof.{$CurrentShip.type}">
                    <do_if value="$CapitalShipCount == 0">
                      <debug_text text="$CurrentShip.name + ' is a capital ship and we don\'t want any more of those in our fleet.'" chance="$DebugChance"/>
                    </do_if>
                    <do_else>
                      <add_to_group groupname="$XenonHorde" object="$CurrentShip"/>
                      <debug_text text="$CurrentShip.name + ' is a capital ship and we could use ' + $CapitalShipCount + ' more of those in our fleet, so we\'ll take it. We now have ' + $XenonHorde.count + ' ships in the fleet.'" chance="$DebugChance"/>
                      <set_value name="$CapitalShipCount" operation="subtract"/>
                    </do_else>
                  </do_if>
                  <do_else>
                    <add_to_group groupname="$XenonHorde" object="$CurrentShip"/>
                    <debug_text text="$CurrentShip.name + ' is available. We now have ' + $XenonHorde.count + ' ships in the fleet.'" chance="$DebugChance"/>
                  </do_else>

                  <!-- Keep track of the amount of existing ships, in case we later want to spawn extras. -->
                  <do_if value="$FleetComposition.{$CurrentShip.macro}?">
                    <set_value name="$FleetComposition.{$CurrentShip.macro}" operation="add"/>
                    <debug_text text="'Got ' + $FleetComposition.{$CurrentShip.macro} + ' ' + $CurrentShip.macro + ' in the list.'" chance="$DebugChance"/>
                  </do_if>
                  <do_else>
                    <set_value name="$FleetComposition.{$CurrentShip.macro}" exact="1"/>
                    <debug_text text="'Adding ' + $CurrentShip.macro + ' to the list.'" chance="$DebugChance"/>
                  </do_else>
                </do_else>

                <do_if value="$ShipCount and ($XenonHorde.count ge $ShipCount)">
                  <!-- Inner break for stopping the loop over all available ships of a given sector. -->
                  <break/>
                </do_if>
              </do_for_each>

              <do_if value="$ShipCount and $XenonHorde.count ge $ShipCount">
                <!-- Outer break for stopping the loop over the sectors. -->
                <break/>
              </do_if>
            </do_for_each>

            <!-- If $MinFleetComposition is supplied, spawn the rest of the ships. -->
            <do_if value="$MinFleetComposition">
              <do_for_each in="$MinFleetComposition" name="$CurrentDefinition">
                <do_if value="$FleetComposition.{$CurrentDefinition.{1}}?">
                  <set_value name="$CurrentDefinition.{2}" exact="$FleetComposition.{$CurrentDefinition.{1}}" operation="subtract"/>
                  <debug_text text="$CurrentDefinition.{1} + ' already exists ' + $FleetComposition.{$CurrentDefinition.{1}} + ' times. ' + $CurrentDefinition.{2} + ' left to spawn.'" chance="$DebugChance"/>
                </do_if>
                <do_else>
                  <debug_text text="$CurrentDefinition.{1} + ' doesn\'t exist in the wild. We have to spawn all ' + $CurrentDefinition.{2} + ' ships with this macro.'" chance="$DebugChance"/>
                </do_else>
                <do_all exact="$CurrentDefinition.{2}" counter="$i">
                  <create_ship name="$CurrentShip" macro="$CurrentDefinition.{1}" sector="if $RallySector then $RallySector else $SectorList.{1}">
                    <owner exact="faction.xenon" overridenpc="true" />
                    <pilot>
                      <select faction="faction.xenon" tags="tag.fighterpilot"/>
                    </pilot>
                    <loadout>
                      <level exact="1.0"/>
                    </loadout>
                    <drop ref="if [tag.dock_xl, tag.dock_l].indexof.{$CurrentDefinition.{1}.docksize} then ship_large_xenon else ship_small_xenon"/>
                    <safepos x="0km" y="0km" z="0km"/>
                  </create_ship>
                  <add_to_group groupname="$XenonHorde" object="$CurrentShip"/>
                </do_all>
              </do_for_each>
            </do_if>

            <!-- Regardless of how many ships we found, as long as we found any, issue the attack. -->
            <do_if value="$XenonHorde.count">
              <set_value name="$TargetSector" exact="$Target.sector"/>
              <create_position name="$TargetPosition" space="$TargetSector" object="$Target"/>

              <do_if value="$RallySector">
                <create_ship name="$XenonFleetCommander" macro="macro.ship_xen_xl_carrier_01_a_macro" sector="$RallySector">
                  <owner exact="faction.xenon" overridenpc="true" />
                  <pilot>
                    <select faction="faction.xenon" tags="tag.fighterpilot"/>
                  </pilot>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <drop ref="ship_large_xenon"/>
                  <safepos x="0km" y="0km" z="0km"/>
                </create_ship>

                <do_for_each in="$XenonHorde" name="$CurrentShip">
                  <!--<commandeer_object object="$CurrentShip"/>-->
                  <do_if value="[shiptype.destroyer, shiptype.carrier, shiptype.battleship].indexof.{$CurrentShip.type}">
                    <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                      <param name="commander" value="$XenonFleetCommander"/>
                      <param name="assignment" value="assignment.attack"/>
                      <param name="cancelorders" value="true"/>
                    </create_order>
                  </do_if>
                  <do_else>
                    <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                      <param name="commander" value="$XenonFleetCommander"/>
                      <param name="assignment" value="assignment.interception"/>
                      <param name="cancelorders" value="true"/>
                    </create_order>
                  </do_else>
                </do_for_each>

                <do_if value="$DefaultProtectTargetPosition">
                  <create_order id="'ProtectPosition'" object="$XenonFleetCommander" default="true">
                    <param name="destination" value="[$TargetSector, $TargetPosition]"/>
                  </create_order>
                </do_if>
                <do_elseif value="$DefaultPatrolTargetSector">
                  <create_order id="'Patrol'" object="$XenonFleetCommander" default="true">
                    <param name="space" value="$TargetSector"/>
                  </create_order>
                </do_elseif>
                <do_elseif value="$DefaultPatrolOriginSector">
                  <create_order id="'Patrol'" object="$XenonFleetCommander" default="true">
                    <param name="space" value="$RallySector"/>
                  </create_order>
                </do_elseif>
                <do_else comment="Fallback.">
                  <create_order id="'Patrol'" object="$XenonFleetCommander" default="true">
                    <param name="space" value="$RallySector"/>
                  </create_order>
                </do_else>

                <create_order id="'Attack'" object="$XenonFleetCommander" immediate="true">
                  <param name="primarytarget" value="$Target"/>
                  <param name="pursuetargets" value="true"/>
                  <param name="allowothertargets" value="$AllowOtherTargets"/>
                  <param name="checkrelation" value="false"/>
                  <param name="targetclasses" value="[class.station, class.ship_xl, class.ship_l]"/>
                </create_order>

                <add_to_group groupname="$XenonHorde" object="$XenonFleetCommander"/>
              </do_if>
              <do_else>
                <do_for_each in="$XenonHorde" name="$CurrentShip">
                  <!--<commandeer_object object="$CurrentShip"/>-->

                  <!-- If no default order param is given, the ship will return to whatever it was doing before the attack once the order ends. -->
                  <do_if value="$DefaultProtectTargetPosition">
                    <cancel_all_orders object="$CurrentShip"/>
                    <create_order id="'ProtectPosition'" object="$CurrentShip" default="true">
                      <param name="destination" value="[$TargetSector, $TargetPosition]"/>
                    </create_order>
                  </do_if>
                  <do_elseif value="$DefaultPatrolTargetSector">
                    <cancel_all_orders object="$CurrentShip"/>
                    <create_order id="'Patrol'" object="$CurrentShip" default="true">
                      <param name="space" value="$TargetSector"/>
                    </create_order>
                  </do_elseif>
                  <do_elseif value="$DefaultPatrolOriginSector">
                    <cancel_all_orders object="$CurrentShip"/>
                    <create_order id="'Patrol'" object="$CurrentShip" default="true">
                      <param name="space" value="$CurrentShip.sector"/>
                    </create_order>
                  </do_elseif>

                  <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                    <param name="primarytarget" value="$Target"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="allowothertargets" value="$AllowOtherTargets"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_for_each>
              </do_else>
            </do_if>

            <return value="$XenonHorde"/>
          </actions>
        </library>

      </cues>
    </cue>

    <cue name="Patch_Userdata" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
      </conditions>
      <actions>
        <do_if value="Ch23_Yaki_Trade.state == cuestate.cancelled">
          <set_userdata storystate="'story_yaki_complete'" value="1"/>
        </do_if>
      </actions>
    </cue>
  </cues>
</mdscript>
