<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Story_Covert_Operations" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="Start" namespace="this" mapeditor="false" version="4">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
        <check_value value="player.galaxy.macro.ismacro.{macro.xu_ep2_universe_macro}" comment="only in main-galaxy"/>
      </conditions>
      <actions>
        <set_value name="$DebugChance"                exact="0"/>
        <set_value name="$DeepDebugChance"            exact="0"     comment="for AI scripts and similar external code"/>
        <set_value name="$MissionCue"                 exact="this"/>
        <set_value name="$Page"                       exact="30227"/>
        <set_value name="$Faction" exact="faction.terran"/>

        <!--Custom gamestart flags (only reliable after 6.20 gamestarts)-->
        <set_value name="$story_covert_ops_war" exact="gamestart.storystate.story_covert_ops_war"/>
        <set_value name="$story_covert_ops_argon_schism" exact="gamestart.storystate.story_covert_ops_argon_schism"/>
        <set_value name="$story_covert_ops_neutral" exact="gamestart.storystate.story_covert_ops_neutral"/>
        <set_value name="$HasCustomGamestartSkip" exact="
                   $story_covert_ops_war or
                   $story_covert_ops_argon_schism or
                   $story_covert_ops_neutral"/>
      </actions>
      <patch sinceversion="2">
        <set_value name="$HasCustomGamestartSkip" exact="false"/>
      </patch>
      <patch sinceversion="3">
        <set_value name="$story_split_faction_decision" exact="false"/>
        <set_value name="$story_covert_ops_war" exact="false"/>
        <set_value name="$story_covert_ops_neutral" exact="false"/>
      </patch>
      <patch sinceversion="4">
        <do_if value="$MissionCue.hasmissionoffer">
          <update_offer cue="$MissionCue" group="missiongroup.story_covert_operations"/>
        </do_if>
        <do_if value="$MissionCue.hasmission">
          <do_if value="@$MissionCue.canactivatesubmission.{@$MissionCue_Ch4_BuildStation} or @$MissionCue.canactivatesubmission.{@$MissionCue_Ch4_DeliverShip}">
            <update_mission_thread cue="$MissionCue" group="missiongroup.story_covert_operations"/>
          </do_if>
          <do_else>
            <update_mission cue="$MissionCue" group="missiongroup.story_covert_operations"/>
          </do_else>
        </do_if>

        <!-- There might be misisons within a thread too -->
        <do_if value="@$MissionCue_Ch4_BuildStation.hasmission">
          <update_mission cue="$MissionCue_Ch4_BuildStation" group="missiongroup.story_covert_operations"/>
        </do_if>
        <do_if value="@$MissionCue_Ch4_DeliverShip.hasmission">
          <update_mission cue="$MissionCue_Ch4_DeliverShip" group="missiongroup.story_covert_operations"/>
        </do_if>
      </patch>
      <cues>
        <cue name="Setup" version="2">
          <patch sinceversion="2">
            <do_if value="@$SecretServiceActorShip.exists and not $SecretServiceActorShip.isinvulnerable">
              <!-- Switch from min-hull 20 to using the invulnerability manager -->
              <set_object_min_hull object="$SecretServiceActorShip" exact="0"/>
              <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                <param name="Object"        value="$SecretServiceActorShip"/>
                <param name="RequesterCue"  value="namespace"/>
                <param name="DebugChance"   value="$DebugChance"/>
              </run_actions>
            </do_if>
          </patch>
          <cues>
            <cue name="Setup_ImportantSystems">
              <actions>
                <find_cluster name="$AntigoneMemorial" macro="macro.cluster_28_macro" required="true" comment="Antigone Memorial"/>
                <!-- Set Base Reward Credits (can be reduced on failures) -->
                <set_value name="$RewardCredits" exact="15000000Cr"/>
              </actions>
            </cue>

            <cue name="Setup_Character_AntigoneOfficial" version="2">
              <actions>
                <debug_text text="'Setting up Saman Red'" chance="$DebugChance"/>
                <!-- Saman Red: Antigone diplomat and Anti-Terran Operative -->
                <create_cue_actor name="$SamanActor" cue="namespace" macro="character_argon_male_plot_antigone_official_macro">
                  <page exact="10162"/>
                  <owner exact="faction.antigone"/>
                  <skills>
                    <skill type="management"  exact="15"/>
                    <skill type="morale"      exact="15"/>
                    <skill type="piloting"    exact="12"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="12"/>
                  </skills>
                </create_cue_actor>
                <set_value name="$AddStoryMentors_Saman"/>
                <set_entity_overrides entity="$SamanActor" title="'{30227,102}'" icon="'defenceofficer'"/>
                <set_entity_traits entity="$SamanActor" missionactor="true" customhandler="true" subtitlename="true"/>

                <set_value name="$SamanCutsceneKey"       exact="table[ $key = 'ShowNPCFace']"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$AddStoryMentors_Saman"/>
              </patch>
              <cues>
                <cue name="PATCH_AddStoryMentors_Saman" onfail="cancel">
                  <conditions>
                    <check_value value="$AddStoryMentors_Saman?"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$SamanActor]"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Setup_Character_ScaleplateLieutenant" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_cue_actor name="$ScalePlateActor" cue="namespace" macro="character_teladi_male_plot_scaleplate_collaborator_macro">
                  <page exact="10555"/>
                  <owner exact="faction.scaleplate"/>
                  <skills>
                    <skill type="management"  exact="9"/>
                    <skill type="morale"      exact="7"/>
                    <skill type="piloting"    exact="3"/>
                    <skill type="engineering" exact="4"/>
                    <skill type="boarding"    exact="5"/>
                  </skills>
                </create_cue_actor>
                <set_value name="$AddStoryMentors_ScalePlateActor"/>
                <set_entity_traits entity="$ScalePlateActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$ScalePlateActor" title="'{30227,103}'" icon="'shadyguy'"/>
                <set_value name="$ScalePlateActorCutsceneKey"       exact="table[ $key = 'ShowCharacter']"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$AddStoryMentors_ScalePlateActor"/>
              </patch>
              <cues>
                <cue name="PATCH_AddStoryMentors_ScalePlateActor" onfail="cancel">
                  <conditions>
                    <check_value value="$AddStoryMentors_ScalePlateActor?"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$ScalePlateActor]"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Setup_Remember_SecretService_Yaki_Story">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$SecretServiceActor" exact="md.$PersistentCharacters.$SecretServiceActor"/>
                <assert value="$SecretServiceActor != null" text="'SecretServiceActor is null'"/>
                <set_value name="$SecretServiceStation" exact="md.Story_Yaki.Start.$SecretServiceStation"/>
                <set_value name="$SecretServiceSector" exact="md.Story_Yaki.Start.$SecretServiceSector"/>
                <set_value name="$SecretServiceCutsceneKey"       exact="table[ $key = 'ShowNPCFace' ]"/>
                <debug_text text="'SecretService Actor: ' + $SecretServiceActor.knownname + ' ' + $SecretServiceStation.knownname + ' ' + $SecretServiceSector.knownname"/>
              </actions>
            </cue>

            <cue name="Setup_Remember_Diplomacy_Plot">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="1.5s"/>
              <actions>
                <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
                <assert value="$DalBusta != null" text="'DalBusta is null'"/>
                <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
                <assert value="$BosoTa != null" text="'Boso is null'"/>

                <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                <set_value name="$DalCutsceneKey"       exact="table[ $key = 'ShowCharacterDal']"/>
                <set_value name="$BosoCutsceneKey"      exact="table[ $key = 'ShowCharacterBoron']"/>
              </actions>
            </cue>

            <cue name="Setup_Ch3_RelayStation" version="3">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_sector name="$AntigoneMemorialSector" macro="macro.cluster_28_sector001_macro"/>
                <!--Find fitting Station-->
                <find_station_by_true_owner name="$RelayStation" faction="faction.antigone" space="$AntigoneMemorialSector" state="componentstate.operational" canclaimownership="true">
                  <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                </find_station_by_true_owner>
                <do_if value="not $RelayStation.exists">
                  <find_station_by_true_owner name="$RelayStation" faction="faction.antigone" space="player.galaxy" sortbygatedistanceto="$AntigoneMemorial" state="componentstate.operational" canclaimownership="true">
                    <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                  </find_station_by_true_owner>
                  <do_if value="not $RelayStation.exists">
                    <find_station_by_true_owner name="$RelayStation" faction="faction.antigone" space="player.galaxy" sortbygatedistanceto="$AntigoneMemorial" state="componentstate.operational">
                      <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                    </find_station_by_true_owner>
                  </do_if>
                </do_if>

                <do_if value="not $RelayStation.exists">
                  <create_station macro="macro.station_gen_factory_base_01_macro" name="$RelayStation" owner="faction.antigone" sector="$AntigoneMemorialSector" state="componentstate.operational" constructionplan="'arg_defence'">
                    <safepos space="$AntigoneMemorial" min="30km" max="80km" radius="80km" allowyaxis="false"/>
                  </create_station>
                  <signal_objects object="player.galaxy" param="'init station'" param2="$RelayStation" param3="false" comment="Add control entities."/>
                </do_if>
                <!-- Request Relay Station Invincibility -->
                <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                  <param name="Object" value="$RelayStation"/>
                  <param name="RequesterCue" value="Setup_Ch3_RelayStation"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>
              </actions>
              <patch sinceversion="2">
                <do_if value="Ch_5_Escape_Station.state != cuestate.complete">
                  <do_if value="$RelayStation.isoperational">
                    <!-- Request Relay Station Invincibility -->
                    <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                      <param name="Object" value="$RelayStation"/>
                      <param name="RequesterCue" value="Setup_Ch3_RelayStation"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                  </do_if>
                </do_if>
              </patch>
              <patch sinceversion="3">
                <do_if value="$RelayStation.isindestructible">
                  <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                    <param name="Object" value="$RelayStation"/>
                    <param name="RequesterCue" value="Start"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>
                </do_if>
                <do_if value="Ch_5_Escape_Station.state == cuestate.cancelled or Ch_5_Escape_Station.state == cuestate.complete">
                  <cancel_cue cue="Setup_Ch3_RelayStation"/>
                </do_if>
              </patch>
            </cue>

            <cue name="Setup_Ch3_Relay_Station_Interior" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>

                <!-- Create Server Room -->
                <set_value name="$ServerRoomnMacro" exact="macro.room_gen_serverroom_01_macro"/>
                <get_room_definition doors="$RelayStation_InteriorDoors" macro="$RelayStation_CorridorMacro" race="race.argon" tags="tag.genericcorridor" />
                <set_value name="$RelayStation_Door" exact="if $RelayStation_InteriorDoors.count ge 3 then $RelayStation_InteriorDoors.{3} else $RelayStation_InteriorDoors.{1}"/>
                <create_dynamic_interior interiorname="$ServerRoom_Interior" corridorname="$ServerRoom_Corridor" roomname="$RelayStation_ServerRoom" object="$RelayStation" room="$ServerRoomnMacro" corridor="$RelayStation_CorridorMacro" door="$RelayStation_Door" name="'{20007,1481}'" persistent="true"/>
                <set_dynamic_interior_private object="$RelayStation" interior="$ServerRoom_Interior" private="true"/>

                <set_trigger_activation_wares room="$RelayStation_ServerRoom" group="tag.console_01" ware="ware.inv_sandwell_archive_pass" amount="1" consumeonuse="true" />
                <set_triggers_locked object="$RelayStation_ServerRoom" group="tag.door_01" locked="true"/>

                <debug_text text="'Setting up Server Room Guard'" chance="$DebugChance"/>

                <!-- Argon Guard: Guarding the Antigone Station Server Room -->
                <create_cue_actor name="$ArgonGuardActor" cue="namespace" group="argon.commander.female">
                  <page exact="10164"/>
                  <owner exact="faction.argon"/>
                  <skills>
                    <skill type="management"  exact="15"/>
                    <skill type="morale"      exact="15"/>
                    <skill type="piloting"    exact="12"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="12"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$ArgonGuardActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$ArgonGuardActor" icon="'marineofficer'"/>

                <create_cue_actor name="$AddititionalGuardActor" cue="namespace" group="argon.marine.male">
                  <page exact="10101"/>
                  <owner exact="faction.argon"/>
                  <skills>
                    <skill type="management"  exact="10"/>
                    <skill type="morale"      exact="13"/>
                    <skill type="piloting"    exact="9"/>
                    <skill type="engineering" exact="5"/>
                    <skill type="boarding"    exact="15"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$AddititionalGuardActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$AddititionalGuardActor" icon="'marineofficer'"/>

                <!-- Set Guard Position -->
                <create_position name="$GuardPos" x="-1" y="0.05m" z="0"/>
                <create_position name="$AdditionalGuardPos" x="-0.5" y="0.05m" z="0.6"/>

                <create_rotation name="$GuardRot" yaw="-90.0deg"/>

                <!-- Place actors. -->
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $ArgonGuardActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $ServerRoom_Corridor,
                                                                                                                                      $position = $GuardPos,
                                                                                                                                      $rotation = $GuardRot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AddititionalGuardActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $ServerRoom_Corridor,
                                                                                                                                      $position = $AdditionalGuardPos,
                                                                                                                                      $rotation = $GuardRot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                <set_value name="$ArgonGuardActorCutsceneKey"       exact="table[$key = 'ShowCharacter']"/>
              </actions>
              <patch sinceversion="2">
                <!--Moved from Setting up Invincibility on Room Creation to Station Creation-->
                <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                  <param name="Object" value="$RelayStation"/>
                  <param name="RequesterCue" value="Setup_Ch3_Relay_Station_Interior"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>
              </patch>
            </cue>

            <cue name="Setup_Ch5_SecretServiceActorShip" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Setting up Secret Service Ship-->
                <find_sector name="$Closest_ANT_Sector" owner="faction.antigone" sortbygatedistanceto="player.entity"/>
                <create_cue_actor name="$SecretServiceActor_Pilot" cue="namespace" group="terran.pilot.male">
                  <page exact="10101"/>
                  <owner exact="faction.terran"/>
                  <skills>
                    <skill type="management"  exact="2"/>
                    <skill type="morale"      exact="6"/>
                    <skill type="piloting"    exact="4"/>
                    <skill type="engineering" exact="2"/>
                    <skill type="boarding"    exact="5"/>
                  </skills>
                </create_cue_actor>

                <get_safe_pos result="$SectorSafePos" sector="$Closest_ANT_Sector" min="80" max="120km" radius="50km" allowyaxis="false" comment="big radius to have the ship be isolated"/>
                <set_value name="$ShipOffset" exact="position.[$SectorSafePos.x, 0, $SectorSafePos.z]"/>

                <create_ship name="$SecretServiceActorShip" macro="macro.ship_arg_l_trans_container_01_a_macro" sector="$Closest_ANT_Sector" capturable="false" commandeerable="false">
                  <owner exact="faction.terran" overridenpc="true"/>
                  <pilot actor="$SecretServiceActor_Pilot"/>
                  <position value="$ShipOffset"/>
                </create_ship>

                <set_object_name object="$SecretServiceActorShip" page="30227" line="203" comment="Sweet Jack"/>

                <set_value name="$SecretServiceActorShip.pilot.$donotscan" comment="Prevents police from uncovering the ship."/>
                <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                  <param name="Object"        value="$SecretServiceActorShip"/>
                  <param name="RequesterCue"  value="namespace"/>
                  <param name="DebugChance"   value="$DebugChance"/>
                </run_actions>

                <create_order id="'Patrol'" object="$SecretServiceActorShip" immediate="true">
                  <param name="space" value="$Closest_ANT_Sector"/>
                </create_order>

                <signal_objects object="player.galaxy" param="'Cover'" param2="[$SecretServiceActorShip, faction.antigone]"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <debug_text text="'Pilot: ' + $SecretServiceActorShip.pilot.knownname"/>
                <set_value name="$SecretServiceActorShip.pilot.$freezeinstancedNPCs" exact="true"/>
                <signal_objects object="$SecretServiceActorShip.pilot" param="'npc_state_reinit'"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Debug">
          <cues>
            <!-- Police Faction Change: Skips the entire story and just triggers the final change if siding with TER -->
            <cue name="Debug_PoliceChange_Force">
              <actions>
                <!-- Special setup when you "fast-forward" into a chapter (skipping earlier ones) -->
              </actions>
              <force name="PoliceChange_Force">
                <signal_cue_instantly cue="Debug_Setup_HQ" check="false"/>
                <signal_cue cue="Setup_Remember_Diplomacy_Plot"/>
                <signal_cue cue="Terran_Side_Impact"/>
              </force>
            </cue>


            <cue name="Ch1_DEBUG_Acquire_AdvancedSat">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_ammo object="player.ship" macro="macro.eq_arg_satellite_02_macro" amount="1" />
              </actions>
            </cue>

            <cue name="Ch2_DEBUG_Acquire_Security_Decryption">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.inv_securitydecryptionsystem" exact="2"/>
              </actions>
            </cue>

            <cue name="Ch2_DEBUG_Acquire_EMP_Bomb">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.bomb_player_limpet_emp_01_mk1" exact="5"/>
              </actions>
            </cue>


            <cue name="Ch2_DEBUG_Acquire_Bomb_Launcher">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.weapon_gen_spacesuit_demolition_01_mk1" exact="1"/>
              </actions>
            </cue>


            <cue name="Debug_Setup_Terran_SSC">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="md.$PersistentCharacters.$SecretServiceActor?">
                  <set_value name="$SecretServiceActor" exact="md.$PersistentCharacters.$SecretServiceActor"/>
                </do_if>
                <do_else>

                  <!-- THIS IS A TEMP DEBUG MACRO -->
                  <create_cue_actor name="$SecretServiceActor" cue="namespace" macro="character_terran_female_plot_secret_service_contact_macro">
                    <page exact="10157"/>
                    <owner exact="faction.terran"/>
                    <skills>
                      <skill type="management"  exact="15"/>
                      <skill type="morale"      exact="12"/>
                      <skill type="piloting"    exact="6"/>
                      <skill type="engineering" exact="3"/>
                      <skill type="boarding"    exact="3"/>
                    </skills>
                  </create_cue_actor>
                  <set_entity_traits entity="$SecretServiceActor" missionactor="true" customhandler="true" subtitlename="true"/>
                  <set_value name="$SecretServiceCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>
                  <set_value name="md.$PersistentCharacters.$SecretServiceActor" exact="$SecretServiceActor"/>

                </do_else>

                <find_sector name="$SecretServiceSector" macro="macro.cluster_101_sector001_macro" comment="Mars"/>
                <find_station_by_true_owner name="$SecretServiceStation" faction="faction.terran" space="$SecretServiceSector">
                  <match_content canclaimownership="true"/>
                </find_station_by_true_owner>
                <do_if value="not $SecretServiceStation">
                  <find_station_by_true_owner name="$SecretServiceStation" faction="faction.terran" space="$SecretServiceSector"/>
                </do_if>

                <find_dockingbay groupname="$SecretServiceStationDockingAreas" object="$SecretServiceStation" checkoperational="true" multiple="true">
                  <match_dock walkable="true"/>
                </find_dockingbay>

                <!-- Determine interior macros and names. -->
                <get_room_definition macro="$SecretServiceCorridorMacro" doors="$SecretServiceDoors" race="$SecretServiceStation.owner.primaryrace" tags="tag.corridor"/>
                <get_room_definition macro="$SecretServiceRoomMacro" tags="tag.office" />
                <set_value name="$SecretServiceInteriorName" exact="readtext.{20007}.{3041}" comment="Secret Service Bureau"/>

                <!-- Create persistent interior. -->
                <create_dynamic_interior roomname="$SecretServiceRoom" object="$SecretServiceStation" name="$SecretServiceInteriorName" corridor="$SecretServiceCorridorMacro" room="macro.room_gen_intelligenceoffice_01_macro" corridorname="$SecretServiceCorridor" interiorname="$SecretServiceInterior" persistent="true"/>

                <!-- Find specific slot to place actor on. -->
                <find_npc_slot name="$PotentialSlots" excludefilled="false" object="$SecretServiceRoom" multiple="true"/>
                <do_for_each in="$PotentialSlots" name="$Slot">
                  <do_if value="$Slot.name == 'con_control01'">
                    <set_value name="$SecretServiceSlot" exact="$Slot"/>
                  </do_if>
                </do_for_each>
                <!-- Slot failsafe. -->
                <do_if value="not $SecretServiceSlot?">
                  <set_value name="$SecretServiceSlot" exact="$PotentialSlots.random"/>
                </do_if>

                <!-- Place actor. -->
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SecretServiceActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $SecretServiceSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                <!-- Change name of Secret Service Contact. Up until this point, she's only appeared as "Mission Command" -->
                <set_object_name object="$SecretServiceActor" page="30225" line="102" comment="Delilah Shiratori"/>

                <set_value name="$SecretServiceCutsceneKey"       exact="table[ $key = 'ShowNPCFace' ]"/>
                <set_value name="$BosoCutsceneKey"      exact="table[ $key = 'ShowCharacterBoron']"/>
              </actions>
            </cue>

            <cue name="Debug_Setup_HQ">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Debug_Spawn_HQ">
                  <delay exact="5ms"/>
                  <actions>
                    <do_if value="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors.state == cuestate.waiting and not md.X4Ep1_Mentor_Subscriptions.Start.$HQ?">
                      <signal_cue cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors"/>
                      <signal_cue cue="Set_Persistent_Characters"/>
                    </do_if>
                    <do_elseif value="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors.state == cuestate.waiting and md.X4Ep1_Mentor_Subscriptions.Start.$HQ? and not md.X4Ep1_Mentor_Subscriptions.Start.$HQ.isplayerowned">
                      <signal_cue cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors"/>
                      <signal_cue cue="Set_Persistent_Characters"/>
                    </do_elseif>
                    <do_elseif value="md.X4Ep1_Mentor_Subscriptions.Start.$HQ? and md.Story_Diplomacy_Intro.Pt11_End.state != cuestate.complete">
                      <signal_objects object="md.$PersistentCharacters.$DalBusta" param="'new_hq_interior'" param2="md.$PersistentCharacters.$BosoTa.room"/>
                      <signal_cue_instantly cue="md.Story_Diplomacy_Intro.Pt11_End"/>
                    </do_elseif>
                  </actions>
                </cue>
                <cue name="Set_Persistent_Characters">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                    <set_value name="$DalBusta"   exact="md.$PersistentCharacters.$DalBusta"/>
                    <set_value name="$BosoTa"     exact="md.$PersistentCharacters.$BosoTa"/>
                    <assert value="$DalBusta != null" text="'Dal is null'"/>
                    <assert value="$BosoTa != null" text="'Boso is null'"/>
                    <set_value name="md.X4Ep1_Mentor_Subscriptions.Start.$BoronMet" exact="true"/>

                    <!-- Debug Dal Placement, he disappeared with recent commits TODO: @Owen -->
                    <create_position name="$DalPos" x="-3.17" y="0.05m" z="-5.0"/>
                    <create_rotation name="$DalRot" yaw="90.0deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $DalBusta,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $BosoTa.room,
                                                                                                      $rotation = $DalRot,
                                                                                                      $position = $DalPos,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <force_cue cue="md.Story_Diplomacy_Intro.Pt11_End"/>
                    <!--<signal_cue cue="md.Story_Diplomacy_Intro.Pt11_End"/>-->
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Debug_Skipper" onfail="cancel">
              <conditions>
                <check_value value="player.debug" comment="skipper only in debug builds"/>
              </conditions>
              <cues>
                <cue name="Debug_SkipperShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.Debug_Setup_SkipperShip_Create"/>
                  </actions>
                </cue>

                <cue name="Debug_SkipperShip_Completed">
                  <conditions>
                    <event_cue_completed cue="md.Setup.Debug_Setup_SkipperShip_Create_Completed"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="Debug_Skipper_CreateActor"/>
                    <signal_cue cue="Debug_Skipper_Spawn"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_CreateActor">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentCheatChapter" exact="null"/>
                    <create_cue_actor name="$SkipperActor" cue="$MissionCue" macro="character_argon_male_dyn_jacket_fighterpilot_01_macro">
                      <owner exact="faction.civilian"/>
                      <name name="'CovOps Skipper'"/>
                    </create_cue_actor>
                    <set_entity_type entity="$SkipperActor" type="entitytype.crowd"/>
                    <set_entity_traits entity="$SkipperActor" missionactor="true" customhandler="true"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Spawn" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$SkipperPos" x="12.5" y="-2.8m" z="0.8"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = md.Setup.Debug_Setup_SkipperShip.$SkipperShip.controlroom,
                                                                                                                                      $position = $SkipperPos,
                                                                                                                                      $rotation = rotation.[250deg, 0deg, 0deg],
                                                                                                                                      $debugchance = 0,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                  </actions>
                </cue>

                <cue name="Debug_Skipper_Disconnect" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation">
                  <conditions>
                    <event_cue_completed cue="Debug_Skipper_CreateActor"/>
                  </conditions>
                  <cues>

                    <cue name="Debug_Skipper_Conversation_Start" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$SkipperActor"/>
                      </conditions>
                      <actions>
                        <add_player_choice highlighted="true" section="skipper_main" text="'PLEASE SAVE YOUR GAME'"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Conversation_Main" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_main"/>
                          <event_conversation_returned_to_section actor="$SkipperActor" section="skipper_main"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <add_player_choice_sub section="skipper_chapter_covops" text="'Skip to CovOps chapter'"/>
                        <add_player_choice_sub section="skipper_reputation_covops" text="'Cheat Terran reputation'"/>
                        <add_player_choice_sub section="skipper_setup_hq" text="'Cheat Dal'"/>

                        <add_player_choice_sub section="skipper_credits" text="'Cheat 500 mio credits'"/>
                      </actions>
                    </cue>

                    <!-- *** CovOps SKIPPER *** -->
                    <cue name="Debug_Skipper_Conversation_Chapter" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_chapter_covops"/>
                      </conditions>
                      <actions>
                        <!-- Allow skip to monument if the player hasn't reached that point. -->
                        <do_if value="Ch1_Covert_Intro.state == cuestate.waiting">
                          <add_player_choice section="skipper_chapter_covops_selected" choiceparam="'ch_1'" text="'CovOps: Chapter 1'"/>
                        </do_if>

                        <do_if value="Ch2_RepairBait.state == cuestate.waiting">
                          <add_player_choice section="skipper_chapter_covops_selected" choiceparam="'ch_2'" text="'CovOps: Chapter 2'"/>
                        </do_if>

                        <do_if value="Ch3_LocateHiddenStation.state == cuestate.waiting">
                          <add_player_choice section="skipper_chapter_covops_selected" choiceparam="'ch_3'" text="'CovOps: Chapter 3'"/>
                        </do_if>

                        <do_if value="Ch4_CovertOperations.state == cuestate.waiting">
                          <add_player_choice section="skipper_chapter_covops_selected" choiceparam="'ch_4'" text="'CovOps: Chapter 4'"/>
                        </do_if>

                        <do_if value="Ch5_DataHeist.state == cuestate.waiting">
                          <add_player_choice section="skipper_chapter_covops_selected" choiceparam="'ch_5'" text="'CovOps: Chapter 5'"/>
                        </do_if>

                        <do_if value="Ch6_Covert_Debrief.state == cuestate.waiting">
                          <add_player_choice section="skipper_chapter_covops_selected" choiceparam="'ch_6'" text="'CovOps: Chapter 6'"/>
                        </do_if>

                        <add_player_choice_return text="'Back'"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Conversation_Chapter_Selected" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_chapter_covops_selected"/>
                      </conditions>
                      <actions>
                        <!-- Always reset the currently running chapter first. We want to leave the child cues of previously completed chapters running, so we don't reset them. -->
                        <do_for_each in="$ChapterCues" name="$Chapter">
                          <do_if value="$Chapter.state == cuestate.complete">
                            <set_value name="$RunningChapter" exact="$Chapter"/>
                          </do_if>
                          <do_elseif value="$Chapter.state == cuestate.waiting">
                            <do_if value="$RunningChapter?">
                              <reset_cue cue="$RunningChapter"/>
                            </do_if>
                            <break/>
                          </do_elseif>
                        </do_for_each>

                        <do_if value="event.param2 == 'ch_1'">
                          <force_cue cue="Ch1_Force"/>
                        </do_if>

                        <do_if value="event.param2 == 'ch_2'">
                          <force_cue cue="Ch2_Force"/>
                        </do_if>

                        <do_if value="event.param2 == 'ch_3'">
                          <force_cue cue="Ch3_Force"/>
                        </do_if>

                        <do_if value="event.param2 == 'ch_4'">
                          <force_cue cue="Ch4_Force"/>
                        </do_if>

                        <do_if value="event.param2 == 'ch_5'">
                          <force_cue cue="Ch5_Force"/>
                        </do_if>

                        <do_if value="event.param2 == 'ch_6'">
                          <force_cue cue="Ch6_Force"/>
                        </do_if>

                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Conversation_Reputation" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_reputation_covops"/>
                          <event_conversation_returned_to_section actor="$SkipperActor" section="skipper_reputation_covops"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <add_player_choice_sub section="skipper_reputation_covops_selected" choiceparam="'10'" text="'Terran rep 10'"/>
                        <add_player_choice_sub section="skipper_reputation_covops_selected" choiceparam="'15'" text="'Terran rep 15'"/>
                        <add_player_choice_sub section="skipper_reputation_covops_selected" choiceparam="'20'" text="'Terran rep 20'"/>
                        <add_player_choice_return text="'Back'"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Conversation_Reputation_Selected" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_reputation_covops_selected"/>
                      </conditions>
                      <actions>
                        <do_if value="event.param2 == '10'">
                          <set_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.01"/>
                        </do_if>
                        <do_elseif value="event.param2 == '15'">
                          <set_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.032"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == '20'">
                          <set_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.1"/>
                        </do_elseif>
                        <add_player_choice_return text="'Back'"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Conversation_Credits" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_credits"/>
                      </conditions>
                      <actions>
                        <reward_player money="500000000Cr"/>
                        <add_player_choice_return text="'Back'"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>
          </cues>
        </cue>

        <!-- *** STORY REMINDERS *** -->

        <library name="Story_Reminder">
          <params>
            <param name="Actor"/>
            <param name="CutsceneKey"/>
            <param name="Lines"/>
            <param name="CancelCue"                comment="If this cue gets activated, the reminder gets cancelled."/>
            <param name="Delay"    default="15min" comment="The inital delay for the first reminder."/>
            <param name="Interval" default="30min" comment="The time that's added to the interval between reminders each time."/>
            <param name="Limit"    default="2h"    comment="If the interval between reminders gets this long, we take it as a hint to cancel the reminder altogether."/>
          </params>
          <cues>

            <cue name="Story_Reminder_Delay">
              <delay exact="$Delay"/>
              <actions>
                <signal_cue cue="Story_Reminder_Speak_Actor"/>
              </actions>
            </cue>

            <cue name="Story_Reminder_Speak_Actor">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Story_Reminder_Speak_Actor_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Actor"/>
                  <param name="CutsceneKey"       value="$CutsceneKey"/>
                  <param name="Lines"             value="$Lines"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="Story_Reminder_Speak_Actor_Finished"/>
                </cue>

                <cue name="Story_Reminder_Speak_Actor_Finished">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$Delay ge $Limit">
                      <signal_cue cue="Story_Reminder_Cancel"/>
                    </do_if>
                    <do_else>
                      <set_value name="$Delay" exact="$Interval" operation="add"/>
                      <reset_cue cue="Story_Reminder_Delay"/>
                      <reset_cue cue="Story_Reminder_Speak_Actor"/>
                    </do_else>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Story_Reminder_Cancel">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_cue_activated cue="$CancelCue"/>
                </check_any>
              </conditions>
              <actions>
                <cancel_cue cue="parent"/>
              </actions>
            </cue>

          </cues>
        </library>

        <!-- *** OWEN'S FRAMEWORK CUES *** -->

        <cue name="Initialise">
          <actions>
            <set_value name="$CurrentChapterCue" exact="null"/>

            <!--Append chapter cues to a list so they can be reset when forcing another chapter - keep in order-->
            <set_value name="$ChapterCues" exact="[]"/>
            <append_to_list name="$ChapterCues" exact="Ch0_Covert_Setup"/>
            <append_to_list name="$ChapterCues" exact="Ch1_Covert_Intro"/>
            <append_to_list name="$ChapterCues" exact="Ch2_RepairBait"/>
            <append_to_list name="$ChapterCues" exact="Ch3_LocateHiddenStation"/>
            <append_to_list name="$ChapterCues" exact="Ch4_CovertOperations"/>
            <append_to_list name="$ChapterCues" exact="Ch5_DataHeist"/>
            <append_to_list name="$ChapterCues" exact="Ch6_Covert_Debrief"/>

            <!--Trigger the first Chapter-->
            <!--<signal_cue cue="$ChapterCues.{1}"/>-->

            <signal_cue cue="CovOps_Story_Activation_Manager"/>
          </actions>
        </cue>

        <!--event.param = Forced Chapter cue-->
        <cue name="Force_Chapter" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$ForcedCue" exact="event.param"/>
            <assert value="not $CurrentChapterCue or $ChapterCues.indexof.{$CurrentChapterCue} le $ChapterCues.indexof.{$ForcedCue}" text="'Forced Chapter ' + $ForcedCue + ' takes place before the current Chapter ' + $CurrentChapterCue + ' - may result in odd behaviour [Owen]'"/>
            <do_if value="$ChapterCues.indexof.{$ForcedCue}">
              <do_if value="$CurrentChapterCue">
                <!--You can clean up things from a running Chapter here-->
                <!--<do_if value="$CurrentChapterCue == $ForcedCue">
                 <remove_offer cue="Start"/>
                </do_if> -->
              </do_if>

              <!--Reset all Chapter cues-->
              <do_all exact="$ChapterCues.count" counter="$i">
                <reset_cue cue="$ChapterCues.{$i}"/>
              </do_all>
            </do_if>
          </actions>
          <cues>
            <cue name="Force_Chapter_Signal">
              <actions>
                <debug_text text="'Forcing ' + $ForcedCue + ' to be the active Chapter. Currently running Chapter: ' + $CurrentChapterCue"/>
                <signal_cue cue="$ForcedCue"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- *** STORY MANAGER INTERACTION *** -->

        <cue name="CovOps_Story_Activation_Manager">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <!-- Cues checking preconditions, if any -->

            <cue name="Activate_Immediately" onfail="cancel">
              <conditions>
                <check_all>
                  <check_value value="md.Story_Yaki.Ch9_Clean_Up_Secret_Service_Contact_Mission.state == cuestate.cancelled"/>
                  <check_value value="@md.X4Ep1_Mentor_Subscriptions.Start.$BoronMet"/>
                  <check_value value="not $HasCustomGamestartSkip"/>
                </check_all>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <!-- Cue which activates the story (all preconditions met) -->

            <cue name="Check_For_Terran_IntroChapter_Ending_Conditions">
              <conditions>
                <check_any>
                  <check_all>
                    <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.First_Meeting"/>
                    <check_value value="md.Story_Yaki.Ch9_Clean_Up_Secret_Service_Contact_Mission.state == cuestate.cancelled"/>
                  </check_all>
                  <check_all>
                    <event_cue_cancelled cue="md.Story_Yaki.Ch9_Clean_Up_Secret_Service_Contact_Mission"/>
                    <check_value value="@md.X4Ep1_Mentor_Subscriptions.Start.$BoronMet"/>
                  </check_all>
                </check_any>
                <check_value value="not $HasCustomGamestartSkip"/>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <cue name="Activate_Story">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="Setup_Remember_SecretService_Yaki_Story"/>

                <signal_cue cue="Ch0_Covert_Setup"/>
                <signal_cue cue="SecretServiceActor_Dialog_Option_Story"/>
                <cancel_cue cue="CovOps_Story_Activation_Manager"/>
              </actions>
            </cue>

            <cue name="Handle_Custom_Gamestart_Skip" onfail="cancel">
              <conditions>
                <check_value value="$HasCustomGamestartSkip"/>
              </conditions>
              <cues>
                <cue name="Handle_Custom_Gamestart_Skip_Activate" checkinterval="50ms" version="2">
                  <conditions>
                    <check_value value="@md.$PersistentCharacters.$DalBusta.exists"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Setup_Remember_Diplomacy_Plot"/>
                    <!--Note: $SecretServiceActor may not be placed in their room if the Yaki story is not in a completed state-->

                    <!--Story completed states-->
                    <do_if value="$story_covert_ops_war">
                      <signal_cue cue="Argon_Side_Impact"/>
                    </do_if>
                    <do_elseif value="$story_covert_ops_argon_schism">
                      <signal_cue cue="Terran_Side_Impact"/>
                    </do_elseif>
                    <do_elseif value="$story_covert_ops_neutral">
                      <!-- Clear story-specific faction pairing locks for the involved factions -->
                      <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.antigone" flags="dlc2_1"/>
                      <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.terran" flags="dlc2_1"/>
                      <clear_faction_diplomacy_exclusion faction="faction.terran" otherfaction="faction.antigone" flags="dlc2_1"/>
                    </do_elseif>
                  </actions>
                  <patch sinceversion="2" state="complete">
                    <!-- Clear story-specific faction pairing locks for the involved factions -->
                    <set_value name="$Terran_Diplomacy_AllFactions_Patch"/>
                  </patch>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Secret Service Contact Story Interaction -->
        <cue name="SecretServiceActor_Dialog_Option_Story">
          <conditions>
            <check_any>
              <event_cue_signalled/>
            </check_any>
          </conditions>
          <cues>
            <cue name="SecretServiceActor_Section_Story_Covert_Operations" instantiate="true">
              <conditions>
                <event_conversation_started actor="$SecretServiceActor"/>
                <check_value value="(player.entity.room == $SecretServiceActor.room)"/>
              </conditions>
              <actions>
                <add_player_choice section="story_covert_operations" selectable="true"
                                   text="{30227,30227001}" comment="'Covert Oprations'"/>
                <add_player_choice section="main" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
              </actions>
            </cue>
          </cues>
        </cue>


        <!-- Story Briefing Cutscenes -->

        <!--These cues handle the briefing presentations e.g. Holomap or cutscene render targets (depending on the mission)
                note: play_cutscene action should not be in the actions of the cue with a event_briefing_submission_selected condition. It must be delayed-->
        <cue name="BriefingStarted_General">
          <conditions>
            <check_any>
              <event_briefing_started cue="$MissionCue"/>
              <event_briefing_submission_selected cue="$MissionCue"/>
            </check_any>
            <check_value value="Ch_6_DecisionsDialogue.state != cuestate.complete"/>
          </conditions>
          <actions>
            <set_value name="$RenderTarget" exact="event.param.{1}"/>
            <set_value name="$StartBriefingCutscene"/>
            <debug_text text="'Briefing started'" chance="$DebugChance"/>
          </actions>
          <cues>
            <cue name="DisplayCutscene_General" onfail="cancel">
              <conditions>
                <check_value value="$StartBriefingCutscene?"/>
              </conditions>
              <actions>
                <set_value name="$BriefingCutsceneStarted"/>
                <set_value name="$CutsceneKey" exact="'ShowCharacterInEnvironment'"/>
                <play_cutscene key="$CutsceneKey" rendertarget="$RenderTarget">
                  <param name="npcref" object="$SecretServiceActor"/>
                </play_cutscene>
              </actions>
            </cue>

            <cue name="BriefingStopped_General">
              <conditions>
                <check_any>
                  <event_briefing_cancelled cue="$MissionCue"/>
                  <event_briefing_submission_unselected cue="$MissionCue"/>
                </check_any>
              </conditions>
              <actions>
                <do_if value="$BriefingCutsceneStarted?">
                  <!--Temp value. This is used to identify if a cutscene for this mission is still playing.-->
                  <remove_value name="$BriefingCutsceneStarted"/>
                  <stop_cutscene key="$CutsceneKey"/>
                </do_if>

                <do_if value="$HoloMap?">
                  <remove_holomap />
                  <remove_value name="$HoloMap"/>
                </do_if>

                <debug_text text="'Briefing canceled'" chance="$DebugChance"/>
                <reset_cue cue="BriefingStarted_General"/>
              </actions>
            </cue>
          </cues>
        </cue>
        
        <!-- *** STORY CHAPTERS *** -->

        <!-- 
        <t id="100">(Cast)</t>
        <t id="1000">(Chapter 1 - Intro)</t>
        <t id="1001">(Title)</t>
        <t id="1002">(Description)</t>
        <t id="1003">(Objective)</t>
        <t id="2000">(Chapter 2 - ...)</t>
        -->

        <!-- Chapter 0: Pointing Player towards HAT plot  in dialogue-->

        <cue name="Ch0_Covert_Setup">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="1ms"/>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <do_if value="md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete">
              <debug_text text="'Diplomatic Story already completed, skipping to next Chapter'" chance="$DebugChance"/>
              <signal_cue cue="Ch0_Diplomatic_Story_Complete"/>
              <set_value name="$PrerequisitesConversationFinished" exact="true"/>
            </do_if>
            <do_elseif value="md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.waiting">
              <set_value name="$CurrentChapterCue" exact="this"/>
              <set_value name="$CurrentPartCue" exact="this"/>
              <set_value name="$ObjectiveStep" exact="1"/>
              <set_value name="$PrerequisitesConversationFinished" exact="false"/>
              <signal_cue cue="Ch0_Initiation_Email"/>
            </do_elseif>
          </actions>
          <cues>
            <cue name="Ch0_Initiation_Email">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="10s"/>
              <actions>
                <write_incoming_message title="{30227,10001}" text="{30227,10002}" source="$SecretServiceActor" highpriority="true" object="$SecretServiceActor" comment="email about starting cov ops" interaction="guidance"/>
              </actions>
            </cue>

            <cue name="Ch0_SecretServiceActor_Conversation">
              <conditions>
                <event_conversation_started actor="$SecretServiceActor"/>
                <check_value value="$PrerequisitesConversationFinished" exact="false"/>
              </conditions>
              <cues>
                <cue name="Ch0_SecretServiceActor_Prerequisite_Conversation" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SecretServiceActor" section="story_covert_operations"/>
                  </conditions>
                  <actions>
                    <do_if value="not $PrerequisitesConversationFinished">
                      <allow_conversation_escape enabled="false"/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true">
                        <text line="30227001" comment="Through your service on the Xenon front, you have proved yourself to be a valuable asset to the Terran people."/>
                        <text line="30227002" comment="We might have another task for you. This one will require a softer touch, though."/>
                        <text line="30227003" comment="Having someone in our corner, and who is familiar with diplomacy, especially back room deals, is essential for that task's success."/>
                        <text line="30227004" comment="Our agents have been watching an analyst going by the name Dal Busta."/>
                        <text line="30227005" comment="He is currently negotiating on behalf of the Hatikvah Free League."/>
                        <text line="30227006" comment="Reach out to Busta and get a feel for the political situation outside the solar system."/>
                      </add_npc_line>
                    </do_if>
                    <do_else>
                      <add_npc_line line="30227006" delay="1s" hidechoices="true" comment="Reach out to Busta and get a feel for the political situation outside the solar system."/>
                    </do_else>
                  </actions>
                  <cues>
                    <cue name="Ch0_SecretServiceActor_Prerequisite_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$SecretServiceActor"/>
                        <check_value value="$PrerequisitesConversationFinished" exact="false"/>
                      </conditions>
                      <actions>
                        <set_value name="$PrerequisitesConversationFinished" exact="true"/>

                        <create_mission cue="$MissionCue" name="{30227,901}" description="{30227,902}" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="{30225,108}" rewardtext="{30227,906}">
                          <briefing>
                            <objective step="$ObjectiveStep" action="objective.investigate" text="{30227,903}"/>
                          </briefing>
                        </create_mission>
                        <set_value name="$HatPlotStation" exact="md.Story_Diplomacy_Intro.Start.$Hat_Station"/>
                        <do_if value="$HatPlotStation.isoperational">
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30227,903}" updatebriefing="true" object="$HatPlotStation.sector"/>
                        </do_if>
                        <do_else>
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30227,903}" updatebriefing="true"/>
                        </do_else>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch0_Diplomatic_Story_Complete">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_cue_completed cue="md.Story_Diplomacy_Intro.Pt11_End"/>
                </check_any>
              </conditions>
              <actions>
                <debug_text text="'Diplomatic Story completed, proceeding to next Chapter'" chance="$DebugChance"/>
                <remove_mission cue="$MissionCue" type="completed"/>
                <signal_cue cue="Setup_Remember_Diplomacy_Plot"/>
                <signal_cue_instantly cue="Ch1_Covert_Intro"/>
              </actions>
            </cue>
          </cues>
        </cue>



        <!-- Chapter 1: TER Exposition and first meeting with the ANT Official -->

        <cue name="Ch1_Force">
          <actions>
            <!-- Special setup when you "fast-forward" into a chapter (skipping earlier ones) -->
          </actions>
          <force name="Ch1_Covert_Intro">
            <signal_cue_instantly cue="Debug_Setup_Terran_SSC"/>
            <signal_cue_instantly cue="Debug_Setup_HQ" check="false"/>
            <signal_cue cue="Setup_Remember_Diplomacy_Plot"/>
            <signal_cue cue="SecretServiceActor_Dialog_Option_Story"/>
            <signal_cue cue="Ch1_Covert_Intro"/>
          </force>
        </cue>

        <cue name="Ch1_Covert_Intro" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="2s"/>
          <actions>
            <cancel_cue cue="Ch0_Covert_Setup"/>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>
            <set_value name="$DalInviteConversationFinished" exact="false" comment="Used to determine Dal invite the first time"/>
            <set_value name="$BriefingFinished" exact="false"/>
            <signal_cue cue="StoryOffer"/>
          </actions>
          <patch sinceversion="2" state="cancelled">
            <!-- Ch1 Cleanup -->
            <do_if value="md.$MissionDND.indexof.{md.Story_Covert_Operations.Ch1_Argon_Police_Control_Event}">
              <remove_from_list name="md.$MissionDND" exact="Ch1_Argon_Police_Control_Event"/>
              <debug_text text="'Patch - Cleaning up md.$MissionDND'"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Ch1_Loop_Offer_Story_Start">
              <cues>
                <cue name="Ch1_Loop_Offer_Story">
                  <delay exact="90s"/>
                  <actions>
                    <do_if value="not $CovertStoryOfferedSuccessfully?">
                      <do_if value="Dal_Offer_Call.state == cuestate.waiting">
                        <signal_cue cue="Dal_Offer_Call"/>
                      </do_if>
                      <reset_cue cue="this"/>
                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="StoryOffer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="StoryRemove">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CovertStoryOfferedSuccessfully"/>
                  </actions>
                </cue>

                <cue name="StoryReminder" instantiate="true">
                  <!-- Prevents the story from being offered multiple times -->
                  <conditions>
                    <event_cue_signalled cue="Start"/>
                    <check_value value="event.param == 'trigger_reminder'"/>
                    <check_value value="Dal_Offer_Call.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Dal_Offer_Call"/>
                  </actions>
                </cue>

                <!-- Interaction Cutscene
                 Failed to accept the call, RESET: Dal_Offer_Call
                 Accepted Call,
                  - g_Cancel,   RESET: Dal_Offer_Call
                  - accept,     SIGNAL: StoryRemove, Ch1
                  - decline,    SIGNAL: StoryRemove, 
                                SET: $PlayerDeclined
            -->
                <cue name="Dal_Offer_Call" comment="resets on Fail_To_Interact/ESC, otherwise signals StoryRemove">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="$DalInviteConversationFinished" exact="false"/>
                    <check_value value="not (player.entity.room == $DalBusta.room)"/>
                  </conditions>
                  <cues>
                    <cue name="Dal_Wait_For_Fullscreen" checkinterval="5s">
                      <conditions>
                        <check_value value="not player.isinfullscreenmenu"/>
                        <check_value value="not player.isinconversation"/>
                        <check_value value="not player.isscreenshotmode"/>
                        <check_value value="not md.$MissionDND.count"/>
                      </conditions>
                      <actions>
                        <!-- Offer Call and at HQ -->
                        <play_cutscene key="$DalCutsceneKey.$key" result="parent.$CutsceneID" targetmonitor="true" timeout="20s">
                          <interaction text="{30220,1004}" param="$DalBusta" param2="'covops_accept_interaction'"/>
                          <param name="npcref" object="$DalBusta" />
                          <param name="room"   object="$DalBusta.room" />
                        </play_cutscene>
                      </actions>
                      <cues>

                        <cue name="Dal_Call_Speak">
                          <conditions>
                            <event_cutscene_started cutscene="parent.parent.$CutsceneID"/>
                            <check_value value="event.param2" comment="So that we're not listening for null before the cutscene starts"/>
                          </conditions>
                          <actions>
                            <speak actor="$DalBusta" priority="90">
                              <text line="30227101" delay="0.6s" comment="It’s Dal. We need to talk."/>
                            </speak>
                          </actions>
                        </cue>

                        <!-- Accept the call -->
                        <cue name="Dal_Call_Interact">
                          <conditions>
                            <event_player_interaction param="$DalBusta" param2="'covops_accept_interaction'"/>
                          </conditions>
                          <actions>
                            <stop_cutscene cutscene="parent.parent.$CutsceneID"/>
                            <signal_cue cue="Invite_Trigger_Dal_Conversation"/>
                          </actions>
                        </cue>

                        <cue name="Dal_Call_Cutscene_Stopped">
                          <conditions>
                            <event_cutscene_stopped cutscene="parent.parent.$CutsceneID"/>
                          </conditions>
                          <actions>
                            <do_if value="Dal_Call_Interact.state == cuestate.waiting">
                              <reset_cue cue="parent.parent" comment="Remind Later"/>
                            </do_if>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch_1_Dal_Section_Covert_Ops" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="($HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ} and (player.entity.room == $DalBusta.room) and $DalInviteConversationFinished == false)"/>
                  </conditions>
                  <actions>
                    <add_player_choice section="dal_terran_invite" selectable="true"
                                       text="{30227,30227001}"/>

                    <add_player_choice section="main" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                  </actions>
                </cue>

                <cue name="Invite_Trigger_Dal_Conversation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="not player.isinconversation">
                      <start_conversation actor="$DalBusta" conversation="dal_terran_invite" priority="100"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Invite_Dal_Conversation_Start_v2" version="2">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section section="dal_terran_invite"/>
                      <event_conversation_returned_to_section section="dal_terran_invite" />
                      <event_conversation_started actor="$DalBusta" conversation="dal_terran_invite"/>
                    </check_any>
                  </conditions>
                  <actions>

                    <add_npc_line speaker="$DalBusta" hidechoices="true">
                      <text line="30227102" comment="Someone just reached out to me. Said you were a mutual friend."/>
                      <text line="30227103" comment="Have you been freelancing for the Terran government without keeping me in the loop?"/>
                      <text line="30227104" delay="0.5s" comment="Well, it doesn't really matter now. Suppose we all have our secrets."/>
                      <text line="30227105" comment="The contact said she wanted to meet to get the ball rolling, but she refused to discuss the particulars over the comms."/>
                      <text line="30227106" comment="You interested?"/>
                    </add_npc_line>

                    <add_player_choice position="top_right" text="{30227,30227002}" section="terran_invite_followup" choiceparam="'continue'" highlighted="true" comment="Yes,Im always up for some covert operations."/>
                    <add_player_choice position="bottom_right" text="{30227,30227003}" section="terran_invite_abort" comment="I'm too busy at the moment."/>
                  </actions>
                  <patch sinceversion="2" state="complete">
                    <do_if value="$DalInviteConversationFinished == false">
                      <reset_cue cue="this"/>
                    </do_if>
                  </patch>
                  <cues>

                    <cue name="Invite_Dal_Conversation_Escape_v3">
                      <conditions>
                        <event_conversation_finished actor="$DalBusta"/>
                      </conditions>
                      <actions>
                        <do_if value="$DalInviteConversationFinished == false">
                          <reset_cue cue="parent"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Invite_Dal_Conversation_Section_Followup_v3">
                      <conditions>
                        <event_conversation_next_section actor="$DalBusta" section="terran_invite_followup"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Dal conversation choice made.'" chance="$DebugChance"/>
                        <allow_conversation_escape enabled="false"/>

                        <do_if value="event.param2 == 'continue'">
                          <add_npc_line line="30227107" delay=" 0.5s" hidechoices="true" comment="OK. I'm sending you the details."/>
                          <add_npc_line line="30227108" hidechoices="true" comment="Best not keep someone like her waiting for too long." delay="1s"/>
                          <signal_cue cue="Ch1_Covert_Intro_Invite_Mission"/>
                          <set_value name="$DalInviteConversationFinished" exact="true"/>
                          <write_incoming_message title="{30227,10501}" text="{30227,10502}" source="$SecretServiceActor" highpriority="true" object="$SecretServiceActor" comment="email invite reminder for covert operations" interaction="guidance"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Invite_Dal_Conversation_Section_Abort_v3">
                      <conditions>
                        <event_conversation_next_section actor="$DalBusta" section="terran_invite_abort"/>
                      </conditions>
                      <actions>
                        <add_npc_line line="30227109" hidechoices="true" comment="Ah, that’s alright. If you feel like picking this up later, you can always find her at the Special Operations Command Center."/>
                        <set_value name="$DalInviteConversationFinished" exact="true"/>
                        <write_incoming_message title="{30227,10501}" text="{30227,10502}" source="$SecretServiceActor" highpriority="true" object="$SecretServiceActor" comment="email invite reminder for covert operations" interaction="guidance"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Covert_Intro_Invite_Mission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_mission cue="$MissionCue" name="{30227,1001}" description="{30227,1002}" rewardtext="{30227,906}" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="{30225,108}">
                  <briefing>
                    <objective step="$ObjectiveStep" action="objective.custom" customaction="{30227,1003}" object="$SecretServiceActor" text="$SecretServiceActor.knownname"/>
                  </briefing>
                </create_mission>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30227,1003}" object="$SecretServiceActor" text="$SecretServiceActor.knownname"/>
              </actions>
            </cue>

            <cue name="Ch1_Covert_Intro_SecretServiceActor_Briefing" instantiate="true">
              <conditions>
                <event_conversation_next_section actor="$SecretServiceActor" section="story_covert_operations"/>
              </conditions>
              <actions>
                <set_value name="$selectable" exact="true"/>
                <do_if value="not $BriefingFinished">
                  <set_value name="$DalInviteConversationFinished" exact="true" comment="No more Terran Dal invite"/>
                  <allow_conversation_escape enabled="false"/>

                  <add_npc_line speaker="$SecretServiceActor" hidechoices="true"  lookat="player.entity">
                    <text line="30227101" comment="We approached you with this operation because you have proved yourself to be a loyal and capable ally to the Terran cause."/>
                    <text line="30227102" comment="While it would be tempting to focus solely on the Xenon threat, neglecting all other dangers would prove to be foolish."/>
                  </add_npc_line>

                  <add_player_choice position="top_left" text="{30227,30227101}" section="story_covert_conv_intro" choiceparam="'continue'"/>
                </do_if>
                <do_else>
                  <add_npc_line line="30227118" hidechoices="true" comment="What are you waiting for, agent? Get out there, Terran security is at stake!"/>
                </do_else>
              </actions>
              <cues>
                <cue name="Ch1_Covert_Intro_SecretServiceActor_Briefing_Conversation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$SecretServiceActor" section="story_covert_conv_intro"/>
                      <event_conversation_next_section actor="$SecretServiceActor" section="terran_arg_followup"/>
                    </check_any>
                  </conditions>
                  <actions>


                    <do_if value="event.param == 'story_covert_conv_intro'">
                      <add_npc_line line="30227103" hidechoices="true" comment="(#angry#)We cannot ever forget the Argon betrayal!"/>
                    </do_if>

                    <do_if value="event.param == 'terran_arg_followup'">
                      <set_value name="$selectable" exact="false"/>
                      <allow_conversation_escape enabled="false"/>
                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true">
                        <text line="30227104" comment="The Federation destroyed the Torus, earth’s main line of defence."/>
                        <text line="30227105" comment="Their terrorist act killed Terran citizens, and caused our Government damages in the trillions!"/>
                        <text line="30227106" comment="It was a grave humiliation, not only on the grander political stage, but it was also a blow to the Terran citizens's morale!"/>
                        <text line="30227107" comment="All of this over their absurdly tolerant stance on using AGI technology!"/>
                      </add_npc_line>
                    </do_if>

                    <add_player_choice position="bottom_right" text="{30227,30227102}" section="terran_continue" highlighted="true"/>
                    <add_player_choice position="top_left" text="{30227,30227103}" section="terran_arg_followup" selectable="$selectable"/>
                  </actions>
                </cue>

                <cue name="Ch1_Covert_Intro_SecretServiceActor_Briefing_Continue">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$SecretServiceActor" section="terran_continue"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$SecretServiceActor" hidechoices="true">
                      <text line="30227108" comment="The majority of our resources are tied up in the ongoing campaign against the Xenon, but that should not stop us from pre-emptively undermining enemies of democracy."/>
                      <text line="30227109" comment="Technically both the Argon government and the Terran Protectorate have agreed to a truce, and the Secret Service’s directive is to not engage Argon forces directly."/>
                      <text line="30227110" comment="This is why we approached you for this."/>
                      <text line="if (player.entity.race == race.terran) then 30227112 else 30227111" comment="(While you are a Terran citizen, you have no documented ties to the Terran Secret Service.) or (As a third party, you are not a citizen of the Terran government.)"/>
                      <text line="30227113" comment="Without a tenable connection to us, operating in Argon space as a free agent will raise less suspicion than one of our own would."/>
                      <text line="30227114" comment="Our own agents are continuously working on finding opportunities to undermine the Argon Federation."/>
                      <text line="30227115" comment="We have identified an Antigone Republic Civil Servant we believe is willing to sell confidential Argon information to the highest bidder. "/>
                      <text line="30227116" comment="You are to meet the asset, and, should his intel prove to be legit, obtain said information for us."/>
                      <text line="30227117" comment="It is at this point that I have to inform you that this is a strictly covert operation."/>
                    </add_npc_line>

                  </actions>
                </cue>

                <cue name="Ch1_Covert_Intro_SecretServiceActor_Briefing_Finished">
                  <conditions>
                    <event_conversation_finished actor="$SecretServiceActor"/>
                    <check_value value="not $BriefingFinished"/>
                  </conditions>
                  <actions>
                    <set_value name="$BriefingFinished" exact="true"/>
                    <signal_cue cue="Ch1_Covert_Intro_Gate_Encounter"/>
                  </actions>
                  <cues>
                    <cue name="Ch1_Story_Reminder">
                      <cues>
                        <cue name="Ch1_Story_Reminder_Ref" ref="Story_Reminder">
                          <param name="Actor"       value="$SecretServiceActor"/>
                          <param name="CutsceneKey" value="$SecretServiceCutsceneKey"/>
                          <param name="Lines"       value="[[30227126]]"/>
                          <param name="CancelCue"   value="Ch1_Conversation_Exit"/>
                          <param name="Delay"       value="30min"/>
                          <!--(Slightly annoyed)Agent, you still have not meet with the Antigone contact. What is going on?-->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_Covert_Intro_BosoBowsOut_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="DelayInitial"      value="8s"/>
                      <param name="Lines"             value="[[30227001],[30227002],[30227003]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch1_SignalGateSetup"/>
                      <!--
                        I am not sure whether my skills are well suited to an undertaking of this particular nature.
                        Besides, I have a hard time identifying any scientific benefit in helping to destabilise these governments.
                        As such, I would like to shift my focus towards the pursuit of more fruitful and constructive projects.
                      -->
                    </cue>

                    <cue name="Ch1_SignalGateSetup">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch1_Loop_Offer_Story_Start"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Covert_Intro_Gate_Encounter">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
              </actions>
              <cues>
                <cue name="Ch1_Covert_Intro_Gate_Encounter_Setup" version="3">
                  <actions>
                    <create_list name="$ApproachHandlers"/>

                    <find_sector name="$ANT_Sectors" space="player.galaxy" owner="faction.antigone" multiple="true" sortbygatedistanceto="player.entity"/>

                    <do_if value="$ANT_Sectors.count">
                      <do_all exact="$ANT_Sectors.count" counter="$i">
                        <debug_text text="$i + ' ANT_Sectors: ' + $ANT_Sectors.{$i}.knownname" chance="$DebugChance"/>
                      </do_all>

                      <do_for_each in="$ANT_Sectors" name="$s">
                        <signal_cue_instantly cue="Ch1_Argon_Police_Control_Check_Sector" param="$s"/>
                      </do_for_each>
                      <do_if value="not $MissionCue.hasmission">

                        <create_mission cue="$MissionCue" name="{30227,1001}" description="{30227,1002}" rewardtext="{30227,906}" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname">
                          <briefing>
                            <objective step="$ObjectiveStep" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                          </briefing>
                        </create_mission>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$SecretServiceActor" text="$SecretServiceActor.knownname"/>
                      </do_if>

                      <update_mission cue="$MissionCue" description="{30227,1004}"/>
                      <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                      <set_value name="$ANT_Num" exact="1"/>
                      <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.flyto" object="$ANT_Sectors.{$ANT_Num}" text="{30227,1005}" updatebriefing="true"/>
                    </do_if>
                    <do_else>
                      <find_station_by_true_owner name="$ANT_Stations" space="player.galaxy" sortbygatedistanceto="player.entity" faction="faction.antigone" multiple="true"/>
                      <do_if value="$ANT_Stations.count">
                        <set_value name="$ANT_Sectors" exact="[$ANT_Stations.{1}.sector]"/>
                      </do_if>
                      <do_else>
                        <find_sector name="$ANT_Sectors" macro="macro.cluster_27_sector001_macro"  required="true"  multiple="true"/>
                      </do_else>
                      
                      <do_if value="$ANT_Sectors.count">
                        <do_all exact="$ANT_Sectors.count" counter="$i">
                          <debug_text text="$i + ' ANT_Sectors: ' + $ANT_Sectors.{$i}.knownname" chance="$DebugChance"/>
                        </do_all>

                        <do_for_each in="$ANT_Sectors" name="$s">
                          <signal_cue_instantly cue="Ch1_Argon_Police_Control_Check_Sector" param="$s"/>
                        </do_for_each>
                        <do_if value="not $MissionCue.hasmission">

                          <create_mission cue="$MissionCue" name="{30227,1001}" description="{30227,1002}" rewardtext="{30227,906}" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname">
                            <briefing>
                              <objective step="$ObjectiveStep" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                            </briefing>
                          </create_mission>
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$SecretServiceActor" text="$SecretServiceActor.knownname"/>
                        </do_if>

                        <update_mission cue="$MissionCue" description="{30227,1004}"/>
                        <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                        <set_value name="$ANT_Num" exact="1"/>
                        <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.flyto" object="$ANT_Sectors.{$ANT_Num}" text="{30227,1005}" updatebriefing="true"/>
                      </do_if>
                    </do_else>
                  </actions>
                  <patch sinceversion="3">
                    <do_if value="not $MissionCue.hasmission">
                      <create_mission cue="$MissionCue" name="{30227,1001}" description="{30227,1002}" rewardtext="{30227,906}" type="missiontype.plot" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname">
                        <briefing>
                          <objective step="1" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                          <objective step="2" action="objective.flyto" text="{30227,1005}" object="$ANT_Sectors.{$ANT_Num}" />
                        </briefing>
                      </create_mission>
                      <set_value name="$ObjectiveStep" exact="2"/>
                      <do_if value="Ch1_Dal_Objective_Trigger.state == cuestate.complete">
                        <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                        <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,1006}" group="$ArgonPatrol" updatebriefing="true"/>
                      </do_if>

                      <do_if value="Ch1_Escape_Trigger.state == cuestate.complete">
                        <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                        <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,1007}" updatebriefing="true"/>
                      </do_if>

                      <do_if value="Ch1_Deploy_Satellite.state == cuestate.complete">
                        <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                        <set_value name="$TargetSector" exact="$MeetStation.sector"/>
                        <create_position name="$TargetOffset" object="$MeetStation" space="$MeetStation.sector"/>
                        <set_value name="$TargetRadius" exact="4km"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.deploy" text="{20201,20401}" object="$TargetSector" offset="$TargetOffset" radius="$TargetRadius" updatebriefing="true"/>
                      </do_if>

                      <do_if value="Ch1_Asset_Meeting_Setup.state == cuestate.complete">
                        <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                        <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,1008}" text="{30227,102}" object="$SamanActor" updatebriefing="true"/>
                      </do_if>

                      <do_if value="$Ch1_SamanDialogueDone?">
                        <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                        <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.undock" text="$MeetStation.knownname" updatebriefing="true"/>
                      </do_if>

                    </do_if>
                  </patch>
                  <cues>

                    <cue name="Ch1_Encounter_Character_Setup">
                      <actions>
                        <create_cue_actor name="$Argon_Police_Pilot" cue="namespace" macro="character_argon_male_dyn_uniform_crew_01_macro">
                          <page exact="10101"/>
                          <owner exact="faction.argon"/>
                          <skills>
                            <skill type="management"  exact="2"/>
                            <skill type="morale"      exact="5"/>
                            <skill type="piloting"    exact="8"/>
                            <skill type="engineering" exact="5"/>
                            <skill type="boarding"    exact="6"/>
                          </skills>
                        </create_cue_actor>
                        <set_entity_traits entity="$Argon_Police_Pilot" missionactor="true" customhandler="true" subtitlename="true"/>

                        <create_cue_actor name="$Pirate_Commander" cue="namespace" group="teladi.shadyguy">
                          <page exact="10556"/>
                          <owner exact="faction.scaleplate"/>
                          <skills>
                            <skill type="management"  exact="3"/>
                            <skill type="morale"      exact="4"/>
                            <skill type="piloting"    exact="7"/>
                            <skill type="engineering" exact="3"/>
                            <skill type="boarding"    exact="7"/>
                          </skills>
                        </create_cue_actor>
                        <set_entity_traits entity="$Pirate_Commander" missionactor="true" customhandler="true" subtitlename="true"/>

                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_Covert_Intro_ANT_Exposition" checkinterval="5s">
                  <conditions>
                    <check_all>
                      <check_value value="$ANT_Sector? and not $ANT_Exposition?"/>
                      <check_value value="not player.entity.hascontext.{$SecretServiceStation}"/>
                    </check_all>
                  </conditions>
                  <actions>
                    <set_value name="$ANT_Exposition" exact="true"/>
                    <do_if value="player.entity.ship.ammostorage.{macro.eq_arg_satellite_02_macro}.count ge 1">
                      <set_value name="$HasSatellite"/>
                    </do_if>
                  </actions>
                  <cues>

                    <cue name="Ch1_Covert_Intro_ANT_Exposition_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="DelayInitial"      value="10s"/>
                      <param name="Lines"             value="[[30227110],[30227111],[30227112],[30227113],[30227114],[30227115],[30227116],[30227117],[30227118], [30227119], [if $HasSatellite? then null else 30227140], [if $HasSatellite? then null else 30227141]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="SpeechPriority"    value="95"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        I guess you would want some information about the political landscape you are about to mess with:
                        The Antigone Republic is a fairly new sovereign faction, that established itself during the shutdown.
                        Their capital is Antigone Memorial, a system which became disconnected from the central Argon federal government, and subsequently seceded.
                        When the Jump Gates took up function again, the Republic expanded and claimed another handful of newly discovered systems, before re-establishing contact with the Argon. 
                        Naturally, things were tense for a while, but it's been sorted out.
                        With that being said, the Terran Secret Service's angle makes sense.
                        The Antigone Republic likely has access to all sorts of Argon communication, but they aren’t under strict Argon supervision.
                        If you factor in the inevitable dose of human greed, given enough time, critical information will leak eventually.
                        Still, I can’t shake the feeling that there is more to this than simply bribing some government employee for intel.
                        Best keep your wits about you.
                       (As if he almost forgot)Oh, by the way, make sure to grab an advanced satellite on the way.
                       Looking at the Terran briefing you will need it later!
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_Argon_Police_Control_Check_Sector" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ANT_Sector" exact="event.param"/>
                    <append_to_list name="$ApproachHandlers" exact="this"/>
                  </actions>
                  <cues>

                    <cue name="Ch1_Argon_Police_Control_ReachedTargetSector_Ref" ref="md.LIB_Generic.ReachedSector">
                      <param name="TargetObject"      value="player.entity"/>
                      <param name="TargetSector"      value="$ANT_Sector"/>
                      <param name="SuccessSignalCue"  value="Ch1_Argon_Police_Control_Event_Check"/>
                    </cue>

                  </cues>
                </cue>
                <cue name="Ch1_Argon_Police_Control_Event_Check" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="not player.zone.isclass.highway">
                      <signal_cue cue="Ch1_Argon_Police_Control_Event"/>
                    </do_if>
                    <do_else>
                      <do_if value="$ANT_Num lt $ANT_Sectors.count">
                        <set_value name="$ANT_Num" operation="add" exact="1"/>
                      </do_if>
                      <do_else>
                        <set_value name="$ANT_Num" exact="1"/>
                      </do_else>
                      <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.flyto" object="$ANT_Sectors.{$ANT_Num}" text="{30227,1005}" updatebriefing="false"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_Argon_Police_Control_Event">
                  <conditions>
                    <check_all>
                      <event_cue_signalled/>
                    </check_all>
                  </conditions>
                  <actions>

                    <set_objective cue="$MissionCue" action="objective.wait"/>
                    <!--Disable Mission Calls for the interview  -->
                    <append_to_list name="md.$MissionDND" exact="Ch1_Argon_Police_Control_Event"/>

                    <set_value name="$playership" exact="player.entity.ship"/>
                    <create_position name="$playershippos" object="$playership" space="$playership.sector" x="0km" y="0km" z="1km"/>

                    <!-- Stop the Ship -->
                    <stop_player_autopilot />
                    <create_order id="'MoveWait'" immediate="true" object="$playership" name="$WaitOrder">
                      <param name="destination" value="[$playership.sector, $playershippos]"/>
                      <param name="timeout" value="30min"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                    <force_player_speed speed="0"/>

                    <!-- Turn player invincible while dialogue inescapable -->
                    <set_object_min_hull object="$playership" exact="$playership.hullpercentage"/>
                    <set_object_min_shield object="$playership" exact="$playership.shieldpercentage"/>

                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <!-- Abort Approach Handlers-->
                    <do_all exact="$ApproachHandlers.count" counter="$ah">
                      <do_if value="$ApproachHandlers.{$ah}.exists">
                        <cancel_cue cue="$ApproachHandlers.{$ah}"/>
                      </do_if>
                    </do_all>
                    <remove_value name="$ApproachHandlers"/>

                    <create_position name="$PoliceShipPos" object="$playership" space="$playership.sector" x="0km" y="110m" z="2.7km"/>

                    <get_safe_pos result="$SCAShipPos" object="$playership" sector="$playership.sector" x="8km" y="150m" z="5km"/>

                    <create_rotation  name="$FacePlayer"
                                      pitch="$playership.rotation.pitch - 10deg"
                                      roll="$playership.rotation.roll"
                                      yaw="$playership.rotation.yaw - 180deg"/>

                    <get_ship_definition reference="$LeadPoliceShipDef" size="class.ship_m" faction="faction.argon" tags="tag.military"/>
                    <get_ship_definition reference="$PoliceShipEscortDef" size="class.ship_s" faction="faction.argon" tags="tag.military"/>

                    <create_ship name="$LeadPoliceShip" sector="$playership.sector" commandeerable="false" capturable="false" missioncue="namespace" ref="$LeadPoliceShipDef">
                      <owner exact="faction.argon" overridenpc="true"/>
                      <pilot actor="$Argon_Police_Pilot"/>
                      <position x="$PoliceShipPos.x" y="$PoliceShipPos.y" z="$PoliceShipPos.z"/>
                      <rotation value="$FacePlayer"/>
                    </create_ship>

                    <set_object_name object="$LeadPoliceShip" page="30227" line="201" comment="Argon Border Patrol"/>
                    <add_to_group groupname="$ArgonPatrol" object="$LeadPoliceShip"/>

                    <create_order id="'Wait'" object="$LeadPoliceShip" immediate="true">
                      <param name="noattackresponse" value="true"/>
                    </create_order>

                    <create_order id="'Wait'" object="$LeadPoliceShip" default="true"/>

                    <do_all exact="4">
                      <create_ship name="$CurrentShip" commandeerable="false" capturable="false" sector="$playership.sector" missioncue="namespace" ref="$PoliceShipEscortDef">
                        <owner exact="faction.argon" overridenpc="true" />
                        <pilot>
                          <select faction="faction.argon" tags="tag.elitepilot"/>
                        </pilot>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                        <safepos value="$PoliceShipPos" min="50m" max="300m"/>
                        <rotation value="$FacePlayer"/>
                      </create_ship>

                      <add_to_group groupname="$ArgonPatrol" object="$CurrentShip"/>

                      <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                        <param name="commander" value="$LeadPoliceShip"/>
                        <param name="assignment" value="assignment.defence"/>
                        <param name="cancelorders" value="true"/>
                      </create_order>
                    </do_all>

                    <create_ship name="$PirateAmbushShip" sector="$playership.sector" capturable="false" missioncue="namespace" macro="ship_arg_l_destroyer_01_a_macro">
                      <owner exact="faction.scaleplate" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.scaleplate" tags="tag.fighterpilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <people ref="teladi_elite_military_crew"/>
                      <orientation refobject="$LeadPoliceShip" orientation="look_at"/>
                      <position value="$SCAShipPos"/>
                    </create_ship>

                    <create_position name="$PiratePos" x="0" z="-3.5" space="$PirateAmbushShip.controlroom"/>
                    <create_rotation name="$PirateRot" yaw="0deg"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $Pirate_Commander, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $PirateAmbushShip.controlroom,
                                                                                                                                      $position = $PiratePos,
                                                                                                                                      $rotation = $PirateRot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>


                    <signal_objects object="player.galaxy" param="'Cover'" param2="[$PirateAmbushShip, faction.antigone]"/>
                    <get_safe_pos result="$SafePos" object="$LeadPoliceShip" sector="$playership.sector" min="0.5km" max="1km"/>

                    <create_order id="'Wait'" object="$PirateAmbushShip" default="true"/>

                    <create_order object="$PirateAmbushShip" id="'MoveGeneric'" name="$order" immediate="true">
                      <param name="destination" value="$playership.sector"/>
                      <param name="position" value="$SafePos"/>
                      <param name="precise" value="false"/>
                      <param name="noboost" value="true"/>
                    </create_order>

                    <signal_cue_instantly cue="Ch1_Argon_Police_Conversation"/>
                  </actions>
                </cue>

                <cue name="Ch1_Argon_Police_Conversation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch1_Objects_Destroyed">
                      <conditions>
                        <check_any>
                          <event_object_destroyed object="$PirateAmbushShip"/>
                          <event_object_destroyed group="$ArgonPatrol"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch1_Argon_Police_Conversation_Ambush"/>
                        <signal_cue cue="Ch1_Escape_Trigger" check="false"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Argon_Police_Conversation_Trigger" checkinterval="1s">
                      <conditions>
                        <check_value value="not player.isinconversation"/>
                      </conditions>
                      <actions>
                        <start_conversation actor="$Argon_Police_Pilot" conversation="patrol_encounter" priority="100" missioncue="$MissionCue"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Argon_Police_Conversation_Start">
                      <conditions>
                        <event_conversation_started actor="$Argon_Police_Pilot" conversation="patrol_encounter"/>
                      </conditions>
                      <actions>

                        <!-- The Argon Guard questions the player-->
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$Argon_Police_Pilot" hidechoices="true">
                          <text line="30227101" comment="Halt!"/>
                          <text line="30227102" comment="This is a Jump Gate border check, conducted by Argon Police!"/>
                          <text line="30227103" comment="Remain calm and disengage your weapons systems."/>
                        </add_npc_line>

                        <add_npc_line speaker="$DalBusta" hidechoices="true">
                          <text line="30227120" delay="0.5s" comment="Wait, why would Argon forces be responsible for patrolling Antigone space?"/>
                          <text line="30227121" comment="This is not good. Stay on your toes."/>
                        </add_npc_line>

                        <add_npc_line speaker="$Argon_Police_Pilot" line="30227104" delay="2s" hidechoices="true" comment="Our scans have repeatedly picked up your ship’s signature going into and out of Sol space. As such, we have cause to question you."/>
                        <add_npc_line speaker="$Argon_Police_Pilot" line="30227105" hidechoices="false" comment="What was the cause of your stay?"/>

                        <add_player_choice text="{30227,30227104}" section="answer_trader" position="top_left"/>
                        <add_player_choice text="{30227,30227105}" section="answer_fighter" position="top_right"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Dal_Objective_Trigger">
                      <conditions>
                        <event_speak_finished actor="$DalBusta" line="30227120" comment="This is not good. Stay on your toes."/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                        <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,1006}" group="$ArgonPatrol" updatebriefing="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Argon_Police_Conversation_Trader">
                      <conditions>
                        <event_conversation_next_section actor="$Argon_Police_Pilot" section="answer_trader"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <do_if value="(player.ship.primarypurpose == purpose.fight)">
                          <add_npc_line speaker="$Argon_Police_Pilot" line="30227107" hidechoices="true" comment="A trader at the helm of a combat ship such as this? Not very likely..."/>
                          <set_value name="$RewardCredits" exact="$RewardCredits * 9 / 10ct / 10 * 10" comment="Taking 10% reward credits for being conspicuous"/>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$Argon_Police_Pilot" line="30227106" hidechoices="true" comment="Please allow us access to your trade logs for verification purposes..."/>
                        </do_else>
                        <create_position name="$ApproachPos" object="$playership" space="$playership.sector" x="0km" y="50m" z="1.3km" />
                        <create_position name="$LookAtPos" object="player.entity" space="$playership.sector"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <cancel_all_orders object="$LeadPoliceShip"/>
                        <create_order id="'MoveGeneric'" object="$LeadPoliceShip" immediate="true">
                          <param name="destination" value="$playership.sector"/>
                          <param name="position" value="$ApproachPos"/>
                          <param name="lookat" value="$LookAtPos"/>
                          <param name="noboost" value="true"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch1_Argon_Police_Conversation_Mercenary">
                      <conditions>
                        <event_conversation_next_section actor="$Argon_Police_Pilot" section="answer_fighter"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <do_if value="(player.ship.primarypurpose == purpose.fight)">
                          <add_npc_line speaker="$Argon_Police_Pilot" line="30227108" hidechoices="true" comment="You will disclose your client, now, or we will not permit you entry into Antigone Republic space."/>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$Argon_Police_Pilot" line="30227109" hidechoices="true" comment="Then how come a mercenary such as yourself is not operating a combat ship?"/>
                          <set_value name="$RewardCredits" exact="$RewardCredits * 9 / 10ct / 10 * 10" comment="Taking 10% reward credits for being conspicuous"/>
                        </do_else>
                        <create_position name="$ApproachPos" object="$playership" space="$playership.sector" x="0km" y="100m" z="1.3km" />
                        <create_position name="$LookAtPos" object="player.entity" space="$playership.sector"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <cancel_all_orders object="$LeadPoliceShip"/>
                        <create_order id="'MoveGeneric'" object="$LeadPoliceShip" immediate="true">
                          <param name="destination" value="$playership.sector"/>
                          <param name="position" value="$ApproachPos"/>
                          <param name="lookat" value="$LookAtPos"/>
                          <param name="noboost" value="true"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>

                      </actions>
                    </cue>

                    <cue name="Ch1_Argon_Police_Questioning_Finished">
                      <conditions>
                        <check_any>
                          <event_speak_finished actor="$Argon_Police_Pilot" line="30227106" comment="initial supply"/>
                          <event_speak_finished actor="$Argon_Police_Pilot" line="30227107" comment="initial supply"/>
                          <event_speak_finished actor="$Argon_Police_Pilot" line="30227108" comment="initial supply"/>
                          <event_speak_finished actor="$Argon_Police_Pilot" line="30227109" comment="initial supply"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <start_conversation actor="$Argon_Police_Pilot" conversation="ambush" priority="100" missioncue="$MissionCue"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Argon_Police_Conversation_Ambush">
                      <conditions>
                        <event_conversation_started actor="$Argon_Police_Pilot" conversation="ambush"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line delay="1.5s" speaker="$DalBusta" line="30227122" hidechoices="true" comment="Looks like they aren’t buying your story. This is bad."/>

                        <add_npc_line speaker="$Argon_Police_Pilot" hidechoices="true">
                          <text line="30227110" delay="0.5s" comment="Hold on."/>
                          <text line="30227111" delay="1s" comment="Command, I am picking up some suspicious readings (surprise missile impacts interrupts)"/>
                        </add_npc_line>
                      </actions>
                      <cues>
                        <cue name="Ch1_ArgonPoliceDialogueFinished">
                          <conditions>
                            <event_speak_finished actor="$Argon_Police_Pilot" line="30227110" comment="Hold on."/>
                          </conditions>
                          <actions>
                            <start_conversation actor="$Pirate_Commander" conversation="patrol_announcement" priority="100" missioncue="$MissionCue"/>
                          </actions>
                        </cue>

                        <cue name="Ch1_PirateAnnouncement">
                          <conditions>
                            <event_conversation_started actor="$Pirate_Commander" conversation="patrol_announcement"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch1_PirateInitiatesAttack"/>
                            <add_npc_line speaker="$Pirate_Commander" hidechoices="true">
                              <text line="30227101" comment="This is a Scale Plate raid!"/>
                              <text line="30227102" comment="Drop your cargo and surrender your ships!"/>
                            </add_npc_line>
                          </actions>
                          <cues>

                            <cue name="Ch1_PirateDialogueFinished">
                              <conditions>
                                <event_speak_finished actor="$Pirate_Commander" line="30227101" comment="This is a Scale Plate raid!"/>
                              </conditions>
                              <actions>
                                <set_value name="$PirateSpoke" exact="true"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch1_PlayerRunning" checkinterval="1s">
                      <conditions>
                        <check_value value="($LeadPoliceShip.isoperational) and (player.entity.distanceto.{$LeadPoliceShip} gt 5km) and (not $PatrolDistracted?)"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch1_Argon_Police_Conversation_Ambush"/>

                        <set_object_min_hull object="$playership" exact="0"/>
                        <set_object_min_shield object="$playership" exact="0"/>

                        <set_relation_boost object="$LeadPoliceShip" silent="true" otherobject="player.entity" value="-1.0" decay="0.02" delay="540s" />

                        <create_order object="$LeadPoliceShip" id="'Attack'" name="$ARGattackorder" immediate="true">
                          <param name="primarytarget" value="$playership"/>
                          <param name="allowothertargets" value="false"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                        <signal_cue cue="Ch1_PirateInitiatesAttack"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_PirateInitiatesAttack">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Pirate attack recognised'" chance="$DebugChance"/>

                        <set_cover_owner object="$PirateAmbushShip" faction="null"/>
                        <cancel_all_orders object="$PirateAmbushShip"/>
                        <create_order object="$PirateAmbushShip" id="'Attack'" name="$SCAattackorder" immediate="true">
                          <param name="primarytarget" value="$LeadPoliceShip"/>
                          <param name="secondarytargets" value="$ArgonPatrol"/>
                          <param name="allowothertargets" value="false"/>
                          <param name="pursuetargets" value="false"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                      </actions>
                    </cue>


                    <cue name="Ch1_Patrol_Attacked">
                      <conditions>
                        <event_object_attacked group="$ArgonPatrol"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch1_Argon_Police_Conversation_Ambush"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <do_if value="not event.param.isplayerowned">
                          <set_value name="$PatrolDistracted"/>
                        </do_if>
                        <cancel_conversation actor="$Argon_Police_Pilot" force="true"/>

                        <do_if value="$PirateSpoke?">
                          <cancel_all_orders object="$LeadPoliceShip"/>
                          <add_to_group groupname="$SecondaryTargets" object="$playership"/>
                          <create_order object="$LeadPoliceShip" id="'Attack'" name="$ARGattackorder" immediate="true">
                            <param name="primarytarget" value="$PirateAmbushShip"/>
                            <param name="secondarytargets" value="$SecondaryTargets"/>
                            <param name="allowothertargets" value="false"/>
                            <param name="pursuetargets" value="false"/>
                            <param name="checkrelation" value="false"/>
                          </create_order>
                        </do_if>
                        <do_elseif value="event.param.isplayerowned">
                          <create_order object="$LeadPoliceShip" id="'Attack'" name="$ARGattackorder" immediate="true">
                            <param name="primarytarget" value="event.param"/>
                            <param name="allowothertargets" value="true"/>
                            <param name="pursuetargets" value="true"/>
                            <param name="checkrelation" value="false"/>
                          </create_order>
                        </do_elseif>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <signal_cue cue="Ch1_Escape_Trigger"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Escape_Trigger">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="0.1s"/>
                      <actions>
                        <!--Disable Mission Calls for the interview  -->
                        <remove_from_list name="md.$MissionDND" exact="Ch1_Argon_Police_Control_Event"/>

                        <!-- Turn player vulnerable again-->
                        <set_object_min_hull object="$playership" exact="0"/>
                        <set_object_min_shield object="$playership" exact="0"/>

                        <do_if value="Ch1_Deploy_Satellite_Setup.state != cuestate.complete" comment="If this triggers after Ch1_Escaped_Argon_Police it might overwrite the ">
                          <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                          <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,1007}" updatebriefing="true"/>
                          <do_if value="$PirateSpoke?">
                            <set_value name="$Ch1_EscapeLines" exact="[[30227123],[30227124]]"/>
                          </do_if>
                          <do_else>
                            <set_value name="$Ch1_EscapeLines" exact="[[30227124]]"/>
                          </do_else>
                        </do_if>
                      </actions>
                      <cues>
                        <cue name="Ch1_EscapeTriggerComplete">
                          <conditions>
                            <event_cue_completed cue="Ch1_Escape_Trigger"/>
                            <check_value value="Ch1_Deploy_Satellite_Setup.state != cuestate.complete"/>
                          </conditions>
                          <cues>
                            <cue name="Ch1_Dal_Escape_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="DelayInitial"      value="1s"/>
                              <param name="Lines"             value="$Ch1_EscapeLines"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                Pirates! This is our opportunity.
                                Slip away now, while the Argon patrol is distracted!
                              -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_Escaped_Argon_Police" checkinterval="5s">
                      <conditions>
                        <check_any>
                          <check_value value="not $LeadPoliceShip.isoperational or not $PirateAmbushShip.isoperational"/>
                          <check_value value="player.ship.distanceto.{$LeadPoliceShip} gt 50km and player.ship.distanceto.{$PirateAmbushShip} gt 50km"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="not $PatrolDistracted?">
                          <cancel_all_orders object="$LeadPoliceShip"/>
                          <create_order object="$LeadPoliceShip" id="'Patrol'" name="$order" default="true"/>
                        </do_if>
                        <interrupt_speak actor="$Argon_Police_Pilot" priority="99"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $Pirate_Commander,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = 'disconnect',
                                                                                                      $slottags = [tag.stand],
                                                                                                      $priority = 110,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                        <set_object_min_hull object="$playership" exact="0"/>
                        <set_object_min_shield object="$playership" exact="0"/>

                        <signal_cue cue="Ch1_Deploy_Satellite_Setup"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_No_ANT_Sectors" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- No longer required -->
              <delay exact="5min"/>
              <actions>
                <signal_cue cue="Ch1_Covert_Intro_Gate_Encounter"/>
              </actions>
              <patch sinceversion="2">
                <do_if value="not $ANT_Sectors.count">
                  <signal_cue cue="Ch1_Covert_Intro_Gate_Encounter"/>
                </do_if>
              </patch>
            </cue>

            <cue name="Ch1_Deploy_Satellite_Setup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                <set_objective cue="$MissionCue" action="objective.wait"/>

                <cancel_cue cue="Ch1_Argon_Police_Control_Event"/>
                <find_station_by_true_owner name="$MeetStation" faction="faction.antigone" space="player.sector" checkoperational="true" canclaimownership="true" sortbydistanceto="player.entity" multiple="true">
                  <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                  <match_distance object="player.entity" min="20km"/>
                </find_station_by_true_owner>
                <do_if value="not $MeetStation.{1}.isoperational">
                  <find_station_by_true_owner name="$MeetStation" faction="faction.antigone" canclaimownership="true" sortbygatedistanceto="player.entity" space="player.galaxy" checkoperational="true">
                    <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                  </find_station_by_true_owner>
                </do_if>
                <do_else>
                  <set_value name="$MeetStation" exact="$MeetStation.{1}"/>
                </do_else>
                <do_if value="$MeetStation.isoperational">
                  <signal_cue cue="Ch1_ListenTo_StationDestruction"/>
                  <signal_cue cue="Ch1_MeetStation_Found"/>
                </do_if>
                <do_else>
                  <debug_text text="'No fitting Station found. Resetting Setup Cue'"/>
                  <signal_cue cue="Ch1_MeetStation_DelayedReset"/>
                  <reset_cue cue="this"/>
                </do_else>
              </actions>
            </cue>

            <cue name="Ch1_MeetStation_DelayedReset" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="5min"/>
              <actions>
                <signal_cue cue="Ch1_Deploy_Satellite_Setup"/>
              </actions>
            </cue>

            <cue name="Ch1_MeetStation_Found">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="22s"/>
              <actions>
                <signal_cue cue="Ch1_Deploy_Satellite"/>
              </actions>
              <cues>

                <cue name="Ch1_SCA_Exposition" onfail="cancel">
                  <conditions>
                    <check_value value="$PirateSpoke? == true"/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_SCA_DalExposition_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="SpeechPriority"    value="100"/>
                      <param name="Lines"             value="[[30227125],[30227126],[30227127]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        Dal:
                        Close call.
                        We are lucky they attacked when they did, but I wonder why they operate this far into guarded Antigone territory.
                        I suppose it matches the reports about an increased pirate activity putting pressure on the Federation.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_Deploy_Satellite_Exposition_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="DelayInitial"      value="2s"/>
                  <param name="Lines"             value="[[30227119],[30227120],[30227121],[30227122],[30227123],[30227124],[30227125]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="Ch1_Briefing_Information"/>
                  <!--
                        SSC:
                        Ah, I see that you have made your way into Antigone space, despite the unforeseen complications.
                        The informer you are about to contact goes by the name of Salman Red. 
                        He is a Public Servant in the Antigone Republic Defence Department.
                        You are to bribe him for the information, but be subtle about it.
                        In order to be able to transmit the data to us, you have to set up a satellite in close proximity to the station.
                        To properly encrypt and secure that traffic, you will have to use an advanced satellite.
                        Sending Dal the pertinent information now.
                    -->
                </cue>
                <cue name="Ch1_Briefing_Information">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <write_incoming_message title="{30227,10011}" text="{30227,10012}" source="$SecretServiceActor" highpriority="false" object="$SamanActor" comment="email about meeting Saman" interaction="guidance"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Deploy_Satellite" version="5">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="$ResetStationDestruction_Listener?" comment="Reset StationDestruction_Listener">
                  <reset_cue cue="Ch1_ListenTo_StationDestruction"/>
                </do_if>
                <set_value name="$TargetSector" exact="$MeetStation.sector"/>
                <create_position name="$TargetOffset" object="$MeetStation" space="$MeetStation.sector"/>
                <set_value name="$TargetRadius" exact="4km"/>
                <set_value name="$TargetCount" exact="1"/>
                <set_value name="$DeployableCategory" exact="deployablecategory.satellite"/>
                <set_value name="$SatHintTime" exact="player.age"/>
              </actions>
              <patch sinceversion="4">
                <!--Reset the RML to match it with the new $MeetStation if it was destroyed and patched -->
                <do_if value="Ch1_Satellite_Deployed.state == cuestate.waiting">
                  <set_value name="$TargetSector" exact="$MeetStation.sector"/>
                  <create_position name="$TargetOffset" object="$MeetStation" space="$MeetStation.sector"/>
                  <set_value name="$TargetRadius" exact="4km"/>
                  <set_value name="$TargetCount" exact="1"/>
                  <set_value name="$ObjectiveStep" exact="5"/>
                  <set_value name="$DeployableCategory" exact="deployablecategory.satellite"/>
                  <set_value name="$SatHintTime" exact="player.age"/>
                  <reset_cue cue="DeployInPlace_Ref"/>
                </do_if>
              </patch>
              <patch sinceversion="5">
                <do_if value="not $BribeAttempt?">
                  <signal_cue cue="Ch1_MeetStation_Destroyed"/>
                </do_if>
              </patch>
              <cues>
                <cue name="Ch1_Deploy_Satellite_Signal_StationDestructionListener" onfail="cancel">
                  <conditions>
                    <check_value value="$ResetStationDestruction_Listener?"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch1_ListenTo_StationDestruction"/>
                    <remove_value name="$ResetStationDestruction_Listener"/>
                  </actions>
                </cue>

                <cue name="DeployInPlace_Ref" ref="md.RML_DeployInPlace.DeployInPlace">
                  <!-- always pass these -->
                  <param name="EndSignalCue"                  value="Ch1_Satellite_Deployed"/>
                  <param name="MissionCue"                    value="$MissionCue"/>
                  <param name="StartStep"                     value="$ObjectiveStep" comment="Briefing step to start the mission on"/>
                  <param name="UpdateBriefing"                value="true" comment="Update the briefing objective step when the objective is updated"/>
                  <param name="DebugChance"                   value="$DebugChance"/>
                  <param name="ObjectiveText"                 value="{20201,20401}"/>
                  <param name="ObjectiveText_Plural"          value="{20201,20401}"/>
                  <param name="ObjectiveText_InRange"         value="{20201,20401}"/>
                  <param name="ObjectiveText_InRange_Plural"  value="{20201,20401}"/>

                  <!-- mission-related parameters -->
                  <param name="TargetSector"        value="$TargetSector"/>
                  <param name="TargetOffset"        value="$TargetOffset"/>
                  <param name="TargetRadius"        value="$TargetRadius"/>
                  <param name="TargetCount"         value="$TargetCount"/>
                  <param name="DeployableCategory"  value="$DeployableCategory"/>
                  <param name="DeployableMacros"    value="[macro.eq_arg_satellite_02_macro]"/>
                  <param name="Faction"             value="faction.civilian"/>
                </cue>

                <cue name="Ch1_Wrong_Satellite" instantiate="true">
                  <conditions>
                    <check_all>
                      <event_satellite_launched space="$TargetSector"/>
                      <check_value value="event.param2.isplayerowned and event.param2.distanceto.{$MeetStation} le 4km"/>
                      <check_value value="event.param2.macro != macro.eq_arg_satellite_02_macro"/>
                      <check_value value="player.age gt $SatHintTime + 60s"/>
                    </check_all>
                  </conditions>
                  <actions>
                    <set_value name="$SatHintTime" exact="player.age"/>
                  </actions>
                  <cues>
                    <cue name="Ch1_Wrong_Satellite_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30227128]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                          This is the wrong deployable. We need an advanced satellite to make this work.
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Satellite_Deployed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch1_Deploy_Satellite_Deployed_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30227129],[30227130]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch1_Asset_Meeting_Setup"/>
                      <!--
                          The satellite made the connection. 
                          Now let’s see this Salman Red.
                          -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Asset_Meeting_Setup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="$ResetStationDestruction_Listener?" comment="Resignal StationDestruction_Listener">
                  <reset_cue cue="Ch1_ListenTo_StationDestruction"/>
                </do_if>
                <set_value name="$Saman_OfficeMacro" exact="macro.room_gen_managersoffice_01_macro"/>
                <get_room_definition macro="$Saman_CorridorMacro" doors="$InteriorDoors" race="race.argon" tags="tag.corridor" />
                <set_value name="$Hat_Door" exact="if $InteriorDoors.count ge 3 then $InteriorDoors.{3} else $InteriorDoors.{1}"/>
                <set_value name="$OpinionSmalltalk" exact="false"/>
                <remove_value name="$InteriorDoors"/>

                <create_dynamic_interior interiorname="$Saman_Office_Interior" corridorname="$Saman_Office_Corridor" roomname="$SamanActor_Office_Room"
                                 object="$MeetStation" room="$Saman_OfficeMacro" corridor="$Saman_CorridorMacro" door="$Hat_Door"
                                 name="'{20007,3061}'" persistent="true" private="true"/>

                <set_value name="$SamanRotation" exact="rotation.[20deg, 0deg, 0deg]"/>
                <set_value name="$SamanPosition" exact="position.[-3.5m, 0.09m, -6.0m]"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SamanActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $SamanActor_Office_Room,
                                                                                                      $rotation = $SamanRotation,
                                                                                                      $position = $SamanPosition,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,1008}" text="{30227,102}" object="$SamanActor" updatebriefing="true"/>
              </actions>
              <cues>
                <cue name="Ch1_Asset_Meeting_Signal_StationDestructionListener" onfail="cancel">
                  <conditions>
                    <check_value value="$ResetStationDestruction_Listener?"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch1_ListenTo_StationDestruction"/>
                    <remove_value name="$ResetStationDestruction_Listener"/>
                  </actions>
                </cue>

                <cue name="Ch1_Asset_Meeting_Conversation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$SamanActor"/>
                      <event_conversation_next_section actor="$SamanActor" section="conv_questions"/>
                      <event_conversation_next_section actor="$SamanActor" section="conv_bribe"/>
                      <event_conversation_next_section actor="$SamanActor" section="exit"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.name == 'event_conversation_started'">
                      <do_if value="not $Ch1_SamanDialogueDone?">
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line line="30227101" speaker="$SamanActor" hidechoices="true" comment="Hello, who are you?"/>
                        <add_player_choice text="{30227,30227106}" section="conv_questions"/>
                      </do_if>
                      <do_else>
                        <add_npc_line line="30227122" speaker="$SamanActor" hidechoices="true" comment="(Suspicious)What, back again?"/>
                      </do_else>
                    </do_if>
                    <do_else>
                      <do_if value="event.param == 'conv_questions'">
                        <allow_conversation_escape enabled="false"/>
                        <do_if value="event.param2 == 'choice_antigone'">
                          <add_npc_line speaker="$SamanActor" hidechoices="true">
                            <text line="30227105" delay="1s" comment="The Antigone Republic is a shining example of self-determination."/>
                            <text line="30227106" comment="Looking at everything we have achieved, I can’t help but be proud of its people."/>
                            <text line="30227107" comment="We have risen above petty squabbles and have put the interests of the public first."/>
                            <text line="30227108" comment="To see a faction of this considerable power, both economically and politically, arise from what was undoubtedly a stressful and divisive time in history, gives me hope for the future."/>
                          </add_npc_line>
                          <set_value name="$OpinionSmalltalk" exact="true"/>
                        </do_if>
                        <do_elseif value="event.param2 == 'choice_argon'">
                          <add_npc_line speaker="$SamanActor" hidechoices="true">
                            <text line="30227109" delay="1s" comment="The Argon government and us have had our differences in the past."/>
                            <text line="30227110" comment="Initially, they wanted us back in the fold. "/>
                            <text line="30227111" comment="Antigone Memorial, our home system, was significant to them, due to its location and its importance to their data infrastructure."/>
                            <text line="30227112" comment="After lengthy talks we came to terms, largely because the Jump Gate shutdown had changed the gate connections, making Antigone Memorial’s current position less valuable to the Argon."/>
                            <text line="30227113" comment="Both parties realised that there was no way of putting the genie back in the bottle, and that neither one had anything to gain from fighting amongst ourselves."/>
                            <text line="30227114" comment="Not when there are actual enemies at our gates."/>
                            <text line="30227115" comment="Now, we look out for each other. Politics isn’t a zero-sum game, after all."/>
                          </add_npc_line>
                          <allow_conversation_escape enabled="false"/>
                          <set_value name="$OpinionSmalltalk" exact="true"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'choice_terran'">
                          <add_npc_line speaker="$SamanActor" hidechoices="true">
                            <text line="30227116" delay="1s" comment="The Terran arrogance will come back to haunt us all."/>
                            <text line="30227117" comment="It is no secret that historically, relations between the Argon Federation and the Terrans have been tense."/>
                            <text line="30227118" comment="And more recently, the Terrans have displayed a blatant disregard of Antigone sovereignty as well. "/>
                            <text line="30227119" comment="Should things escalate, it would pain me to see my people caught in the crossfire between the two parties."/>
                          </add_npc_line>
                          <allow_conversation_escape enabled="false"/>
                          <set_value name="$OpinionSmalltalk" exact="true"/>
                        </do_elseif>
                        <do_if value="not $SamanIntroduction?">

                          <add_npc_line speaker="$SamanActor" hidechoices="true">
                            <text line="30227102" delay="1s" comment="Hold on."/>
                            <text line="30227103" comment="Ah, forgive me, my schedule is quite busy."/>
                            <text line="30227104" comment="So, what can I do for you?"/>
                          </add_npc_line>
                          <add_npc_line speaker="$DalBusta" delay="0.5s" line="30227131" hidechoices="true" comment="Before you try to bribe him, perhaps you should feel him out on some related topics."/>
                          <set_value name="$SamanIntroduction"/>

                        </do_if>
                        <add_player_choice text="{30227,30227107}" choiceparam="'choice_antigone'" section="conv_questions"/>
                        <add_player_choice text="{30227,30227108}" choiceparam="'choice_argon'" section="conv_questions"/>
                        <add_player_choice text="{30227,30227109}" choiceparam="'choice_terran'" section="conv_questions"/>
                        <do_if value="$OpinionSmalltalk">
                          <add_player_choice text="{30227,30227110}" highlighted="true" section="conv_bribe" position="bottom_right" selectable="true"/>
                        </do_if>
                        <do_else>
                          <add_player_choice text="{30227,30227110}" highlighted="true" section="conv_bribe" position="bottom_right" selectable="false"/>
                        </do_else>
                      </do_if>
                      <do_elseif value="event.param == 'conv_bribe'">
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$DalBusta" hidechoices="true">
                          <text line="30227132" delay="1s" comment="The Terran arrogance will come back to haunt us all."/>
                          <text line="30227133" comment="The satellite has intercepted some encrypted communications between this office and the Argon Counterespionage department."/>
                          <text line="30227134" comment="It took me some time to make sense of what I have here, but this is definitely some sort of sting."/>
                          <text line="30227135" comment="(Worried tone)This guy isn't looking to sell intelligence; he wants to catch Terran interference!"/>
                          <text line="30227136" comment="(Panicked tone)We messed up! Abort this operation!"/>
                        </add_npc_line>

                        <add_npc_line delay="0.5s" speaker="$SamanActor" line="30227120" hidechoices="false" comment="Yes, what is it? You were saying?"/>

                        <add_player_choice text="{30227,30227111}" highlighted="true" section="exit" position="bottom_right"/>

                        <set_value name="$BribeAttempt"/>
                      </do_elseif>
                      <do_elseif value="event.param == 'exit'">
                        <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                        <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.undock" text="$MeetStation.knownname" updatebriefing="true"/>
                        <add_npc_line delay="1s" speaker="$SamanActor" line="30227121" hidechoices="true" comment="Are you alright? Leaving already?"/>
                        <set_value name="$Ch1_SamanDialogueDone"/>
                        <signal_cue cue="Ch1_Conversation_Exit"/>
                      </do_elseif>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_Meeting_Done" checkinterval="3s">
                  <conditions>
                    <check_value value="(not player.entity.hascontext.{$MeetStation}) and $BribeAttempt?"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SamanActor, 
                                                                                                                      table[
                                                                                                                      $requestercue = namespace,
                                                                                                                      $location = 'disconnect',
                                                                                                                      $priority = 100,
                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                      $debugcaller = if $DeepDebugChance == 100 then this else null]
                                                                                                                      ]"/>


                    <remove_mission cue="$MissionCue" type="completed"/>
                    <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.003" reason="relationchangereason.missioncompleted"/>

                    <do_if value="$PirateAmbushShip.isoperational">
                      <create_order id="'MoveDie'" object="$PirateAmbushShip" immediate="true">
                        <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                      </create_order>
                    </do_if>
                    <do_all exact="$ArgonPatrol.count" counter="$i">
                      <do_if value="$ArgonPatrol.{$i}.isoperational">
                        <create_order id="'MoveDie'" object="$ArgonPatrol.{$i}" immediate="true">
                          <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                        </create_order>
                      </do_if>
                    </do_all>
                  </actions>
                  <delay exact="15s"/>
                  <actions>
                    <signal_cue cue="Ch2_RepairBait"/>
                    <cancel_cue cue="Ch1_Covert_Intro"/>
                  </actions>
                  <cues>

                  </cues>
                </cue>

                <cue name="Ch1_Conversation_Exit" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="5.5s"/>
                  <actions>
                    <unlock_achievement name="COH_PLOT_COVERT_1"/>
                  </actions>
                  <cues>
                    <cue name="Ch1_Dal_ExitConversation_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="DelayInitial"      value="5s"/>
                      <param name="Lines"             value="[[30227137]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                          Oh, this was a close one. I think it is best if we don’t stick around!
                          -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_ListenTo_StationDestruction">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch1_MeetStation_DockDestroyed" checkinterval="61s">
                  <conditions>
                    <check_value value="$MeetStation.exists and $MeetStation.isrealclass.station"/>
                    <count_object_components object="$MeetStation" class="class.walkablemodule" checkoperational="true" haswalkableroom="false"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="Ch1_MeetStation_Destroyed"/>
                  </actions>
                </cue>


                <cue name="Ch1_MeetStation_Destroyed">
                  <conditions>
                    <check_any>
                      <event_object_destroyed object="$MeetStation"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <cues>

                    <cue name="Ch1_Reset_MeetStation">
                      <actions>
                        <find_station_by_true_owner name="$MeetStation" faction="faction.antigone" space="player.sector" checkoperational="true" canclaimownership="true">
                          <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                        </find_station_by_true_owner>
                        <do_if value="not $MeetStation.isoperational">
                          <find_station_by_true_owner name="$MeetStation" faction="faction.antigone" sortbygatedistanceto="player.entity" space="player.galaxy" checkoperational="true">
                            <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                          </find_station_by_true_owner>
                        </do_if>
                        <do_if value="$MeetStation.isoperational">
                          <!-- To save us some headaches, we will always reset back to the step of deloying the advanced satellite (also makes more sense in the lore) -->
                          <reset_cue cue="Ch1_Deploy_Satellite"/>
                          <set_value name="$ResetCue" exact="Ch1_Deploy_Satellite"/>
                          <set_value name="$ResetStationDestruction_Listener"/>
                          <reset_cue cue="Ch1_Asset_Meeting_Setup"/>

                          <do_if value="$SamanActor.exists">
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SamanActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = 'disconnect',
                                                                                                      $rotation = $SamanRotation,
                                                                                                      $position = $SamanPosition,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                          </do_if>
                          <signal_cue cue="Ch1_NewStation_Found_Dialogue"/>
                        </do_if>
                        <do_else>
                          <debug_text text="'No fitting Station found. Resetting Setup Cue'" chance="$DebugChance"/>
                          <signal_cue cue="Ch1_MeetStation_DelayedReset"/>
                          <reset_cue cue="Ch1_Deploy_Satellite"/>
                          <reset_cue cue="Ch1_Asset_Meeting_Setup"/>
                          <reset_cue cue="Ch1_ListenTo_StationDestruction"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch1_NewStation_Found_Dialogue">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch1_Dal_NewMeetstation_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30227138],[30227139]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="$ResetCue"/>
                          <!--
                            It appears the station you were meant to meet the contact at just got destroyed.
                            The operation is still on, I'm sending the updated information.
                          -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Chapter 2: Creating a fake mission offer to bait ARG into giving relay station location away -->

        <cue name="Ch2_Force">
          <actions>
            <!-- Special setup when you "fast-forward" into a chapter (skipping earlier ones) -->
          </actions>
          <force name="Ch2_RepairBait">
            <signal_cue_instantly cue="Debug_Setup_Terran_SSC"/>
            <signal_cue_instantly cue="Debug_Setup_HQ" check="false"/>
            <signal_cue cue="Setup_Remember_Diplomacy_Plot"/>
            <signal_cue cue="SecretServiceActor_Dialog_Option_Story"/>
            <signal_cue cue="Ch2_RepairBait"/>
          </force>
        </cue>

        <cue name="Ch2_RepairBait">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="5s"/>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>
            <signal_cue cue="Ch2_AcquireMission_Setup"/>

            <!-- Ch1 Cleanup -->
            <do_if value="md.$MissionDND.indexof.{md.Story_Covert_Operations.Ch1_Argon_Police_Control_Event}">
              <remove_from_list name="md.$MissionDND" exact="Ch1_Argon_Police_Control_Event"/>
            </do_if>
          </actions>
          <cues>

            <cue name="Ch2_AcquireMission_Setup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="(player.entity.inventory.{ware.inv_securitydecryptionsystem}.count ge 1) and (player.entity.inventory.{ware.bomb_player_limpet_emp_01_mk1}.count ge 1) and (player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.count ge 1)">
                  <set_value name="$AlreadyAcquired"/>
                </do_if>
              </actions>
              <cues>
                <cue name="Ch2_Story_Reminder">
                  <cues>
                    <cue name="Ch2_Story_Reminder_Ref" ref="Story_Reminder">
                      <param name="Actor"       value="$DalBusta"/>
                      <param name="CutsceneKey" value="$DalCutsceneKey"/>
                      <param name="Lines"       value="[[30227228],[30227229]]"/>
                      <param name="CancelCue"   value="Ch_2_Cleanup"/>
                      <param name="Delay"       value="60min"/>
                      <!--
                      We still need to work on finding that Relay Station. 
                      Terrans are not known for their unending patience.
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_RepairBait_Mission_Briefing_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$SecretServiceActor, $DalBusta, $SecretServiceActor]"/>
                  <param name="CutsceneKey"       value="[$SecretServiceCutsceneKey, $DalCutsceneKey, $SecretServiceCutsceneKey]"/>
                  <param name="Lines"             value="[
                                                          [[30227201],[30227202],[30227203]],
                                                          [[30227201],[30227202]],
                                                          [[30227204],[30227205],[30227206],[30227207],[30227208],[30227209],[30227210],[30227211],[30227212],[if $AlreadyAcquired? then 30227214 else 30227213]]
                                                          ]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="[null, null, Ch2_Acquire_Bypass_System]"/>
                  <!--
                  SSC:
                  Thank you for verifying that this lead was a dead end.
                  It would have been to risky to send one of our own agents, but we had to be sure nontheless.
                  Dal:
                  They suspected something was off!
                  (#angry#)She would have let us take the fall without a word of warning?!
                  SSC:
                  Now, since we did not obtain any useful intelligence, we will have to approach this from a different angle.
                  Even though the Antigone Memorial system now belongs to the Republic, its major planet, Sandwell, is still governed by the Argon.
                  Sandwell is host to the biggest data archive in the Argon Federation, and accessing it could unearth invaluable strategic information.
                  It is understandable, then, that security is very tight.
                  Luckily, we won’t have to access the planetary archive itself.
                  According to our reports, the Antigone Republic is operating a relay station with direct access to the Sandwell Archives.
                  It was set up at an undisclosed location to establish contact between the planetary archives and distant Argon fleets. 
                  You will help us find that station.
                  Doing so will require a Security Decryption System, to hack into Argon systems, as well as an EMP(pronounced E.M.P.) bomb, and a bomb launcher.
                  Once you manage to get your hands on all of the required items, we will be able to manipulate the Argon workforce database.
                  -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch2_Acquire_Bypass_System">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_mission cue="$MissionCue" name="{30227,2001}" description="{30227,2002}" rewardtext="{30227,906}" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname">
                  <briefing>
                    <objective step="2" action="objective.acquire_ware" text="{20201, 12301}" encyclopedia="ware.bomb_player_limpet_emp_01_mk1"/>
                    <objective step="1" action="objective.acquire_ware" text="{29105, 1201}" encyclopedia="ware.weapon_gen_spacesuit_demolition_01_mk1"/>
                    <objective step="3" action="objective.acquire_ware" text="{20201, 11301}" encyclopedia="ware.inv_securitydecryptionsystem"/>
                  </briefing>
                </create_mission>

                <set_value name="$InventoryTable" exact="table[{ware.inv_securitydecryptionsystem} = 1, {ware.bomb_player_limpet_emp_01_mk1} = 1, {ware.weapon_gen_spacesuit_demolition_01_mk1} = 1]"/>

                <do_if value="player.entity.inventory.{ware.inv_securitydecryptionsystem}.count ge 1">
                  <set_value name="$Lines" exact="[[30227207],[30227208]]"/>
                </do_if>
                <do_else>
                  <set_value name="$Lines" exact="[[30227203],[30227204],[30227205],[30227207],[30227208]]"/>
                </do_else>
              </actions>
              <cues>

                <cue name="Ch2_Acquire_Bypass_System_Ref" ref="md.RML_Collect_Inventory.CollectInventory">
                  <param name="EndSignalCue" value="Ch2_Bypass_System_Acquired"/>
                  <param name="MissionCue" value="$MissionCue"/>
                  <param name="StartStep" value="$ObjectiveStep"/>
                  <param name="Objective" value="objective.acquire_ware"/>
                  <param name="WaresParam" value="$InventoryTable"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </cue>

                <cue name="Ch2_AcquireItem_Info_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="DelayInitial"      value="2s"/>
                  <param name="Lines"             value="$Lines"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                  Dal:
                  These Security Decryption Systems are quite rare.
                  Sometimes you can find them in the wreckage of destroyed ships, or cou can craft one yourself, if you've got the right resources.
                  To craft one you will need five AGI Heuristic Cores, a Decryption Module, and an Interface Unit.
                  Be careful, though. Most factions don’t really tolerate such hacking equipment, so don't let yourself get caught with one of them.
                  (Weary)From what we’ve seen so far, we shouldn’t expect our Terran friends to have our backs out here.
                  -->
                </cue>

                <cue name="Ch2_Bypass_System_Acquired">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.wait"/>
                    <set_value name="$ObjectiveStep" operation="add" exact="3"/>
                  </actions>
                  <delay exact="28s"/>
                  <actions>
                    <signal_cue cue="Ch2_Hack_Station"/>
                  </actions>
                  <cues>
                    <cue name="Ch2_StationHack_Mission_Briefing_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$SecretServiceActor, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$SecretServiceCutsceneKey, $DalCutsceneKey]"/>
                      <param name="DelayInitial"      value="[2s, 0.5s]"/>
                      <param name="Lines"             value="[
                                                              [[30227215],[30227216],[30227217],[30227218],[30227219]],
                                                              [[30227209],[30227210],[30227211],[30227212],[30227213]],
                                                              ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[null, null]"/>
                      <!--
                      SSC:
                      The Security Decryption System makes it possible for us to access the station-internal workforce database, in order to rewrite job offers. 
                      We might not know on which station acts as the relay, but someone on the Federation's payroll definitely does.
                      The Argon would not leave maintenance to any external services, so if we believably fabricate a distress call, their response will give away the location.
                      I'm sending the relevant information now.
                      Let Dal have a look.
                      Dal:
                      (Slightly worried)You know, the Argon Federation is careful about disclosing that Relay station’s location for a reason.
                      The Sandwell Archives hold information on Argon tech, message logs, payroll information, business transactions. The likes.
                      Those servers being stationed in Republic space has been responsible for heated political stand-offs on more than one occasion.
                      Access to the Archives isn’t being held hostage exactly, but the Republic guaranteeing security and data integrity is a powerful incentive for peaceful co-existence.
                      Should the Terrans manage to breach their security, not only could the obtained intel be used to weaken the Argon, but the political fallout resulting from a leak could potentially be even more severe.
                      -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch2_Hack_Station">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <update_mission cue="$MissionCue" description="{30227,2003}"/>
                <find_station_by_true_owner name="$TempRelayStation" faction="faction.antigone" space="player.galaxy" sortbydistanceto="$AntigoneMemorial" multiple="false" checkoperational="true">
                  <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                  <match_gate_distance object="$AntigoneMemorial" min="0"/>
                </find_station_by_true_owner>
                <do_if value="$TempRelayStation.isoperational">
                  <set_value name="$TempPosition" exact="$TempRelayStation"/>
                </do_if>
                <do_else>
                  <set_value name="$TempPosition" exact="player.entity"/>
                </do_else>

                <find_station_by_true_owner groupname="$PotentialHackStations" faction="faction.argon" sortbygatedistanceto="$AntigoneMemorial" space="player.galaxy" checkoperational="true" multiple="true" sortlimit="30">
                  <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                </find_station_by_true_owner>

                <do_if value="not player.ship">
                  <find_ship_by_true_owner name="$ClosestPlayerShip" faction="faction.player" space="player.sector" sortbydistanceto="player.entity"/>
                </do_if>

                <set_value name="$LowestTravelTime" exact="2h"/>
                <do_all exact="$PotentialHackStations.count" counter="$i">
                  <estimate_travel_time result="$EstimatedTravelTime" start="$PotentialHackStations.{$i}" ship="if player.ship then player.ship else $ClosestPlayerShip" target="$TempRelayStation"/>
                  <do_if value="$EstimatedTravelTime lt $LowestTravelTime">
                    <create_group groupname="$HackStation"/>
                    <add_to_group groupname="$HackStation" object="$PotentialHackStations.{$i}"/>
                    <set_value name="$LowestTravelTime" exact="$EstimatedTravelTime"/>
                    <debug_text text="'shortest travel time: ' +  $LowestTravelTime + ' Station: ' + $HackStation.{1}.knownname"/>
                  </do_if>
                </do_all>
                <remove_value name="$TempRelayStation"/>
                <remove_value name="$PotentialHackStations"/>
                <do_if value="$HackStation.count">
                  <signal_cue cue="Ch2_HackStation_Found"/>
                </do_if>
                <do_else>
                  <signal_cue cue="Ch2_HackStation_DelayedReset"/>
                  <reset_cue cue="this"/>
                </do_else>
              </actions>
              <cues>

                <cue name="Ch2_HackStation_Destroyed" instantiate="true">
                  <conditions>
                    <event_object_destroyed group="$HackStation"/>
                  </conditions>
                  <actions>
                    <debug_text text="$HackStation.{1}.knownname + ' has been destroyed. Resetting'"/>
                  </actions>
                  <cues>

                    <cue name="Ch2_Reset_HackStation" instantiate="true" checkinterval="4min" onfail="cancel">
                      <conditions>
                        <check_value value="not $HackStation.count"/>
                      </conditions>
                      <actions>
                        <find_station_by_true_owner groupname="$TempRelayStation" faction="faction.antigone" space="$AntigoneMemorial" multiple="false" checkoperational="true"/>
                        <find_station_by_true_owner groupname="$HackStation" faction="faction.argon" sortbygatedistanceto="if $TempRelayStation.count then $TempRelayStation.{1} else player.entity" space="player.galaxy" multiple="false" checkoperational="true">
                          <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                        </find_station_by_true_owner>
                        <remove_value name="$TempRelayStation"/>
                        <do_if value="$HackStation.count">
                          <set_value name="$ResetCue" exact="Ch2_Hack_Station"/>
                          <signal_cue cue="Ch2_NewStation_Found_Dialogue"/>
                          <reset_cue cue="Ch2_Hack_Station"/>
                        </do_if>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch2_HackStation_Found">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_room name="$PotentialHackRooms" object="$HackStation.{1}" roomtype="roomtype.security" multiple="true" />
                <do_all exact="$PotentialHackRooms.count" counter="$r">
                  <set_dynamic_interior_private object="$HackStation.{1}" room="$PotentialHackRooms.{$r}" private="true"/>
                  <debug_text text="'Setting relevant rooms to private'"/>
                </do_all>
              </actions>
              <cues>

                <cue name="Ch2_PlayerDocked_HackStation">
                  <conditions>
                    <event_object_docked_at group="$HackStation" />
                    <check_value value="global.$PlayerOccupiedShipGroup.indexof.{event.param}"/>
                  </conditions>
                  <cues>

                    <cue name="Ch2_Dal_DockedAtStation_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30227214]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                      The terminal you are looking for should be located in the Security Office.
                      -->
                    </cue>

                  </cues>
                </cue>

                <!-- Trigger the RML, which will check the win/lose conditions and report back -->
                <cue name="Ch2_HackPanel_Ref" ref="md.RML_Hack_Object.HackObjects">
                  <!-- always pass these -->
                  <param name="EndSignalCue"      value="Ch2_Station_Hacked"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="StartStep"         value="$ObjectiveStep" comment="Briefing step to start the mission on"/>
                  <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                  <param name="DebugChance"       value="$DebugChance"/>
                  <!-- mission-related parameters -->
                  <!--param name="ObjectiveText"     value="$TextTable.$objective"/-->

                  <param name="Targets_Param"     value="$HackStation"/>
                  <param name="PanelType"         value="controlpaneltype.hack_engineer"/>
                </cue>

                <cue name="Ch2_Wrong_HackType" instantiate="true">
                  <conditions>
                    <event_player_hacked_object/>
                  </conditions>
                  <actions>
                    <set_value name="$WrongType" exact="false"/>
                    <debug_text text="'Controlpanel Type: ' + event.param3"/>
                    <do_if value="player.entity.hascontext.{$HackStation.{1}} and (event.param3 != controlpaneltype.hack_engineer) and (event.param3 != null)">
                      <set_value name="$WrongType" exact="true"/>
                      <signal_cue cue="Ch_2_HackWarningn_Signal" check="false"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch_2_HackWarningn_Signal">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                  </actions>
                  <cues>

                    <cue name="Ch_2_HackWarning" onfail="cancel">
                      <conditions>
                        <check_value value="$WrongType" exact="true"/>
                      </conditions>
                      <cues>
                        <cue name="Ch2_Dal_WrongPanel_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30227220]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch2_HackWarning_Reset"/>
                          <!--
                              You hacked into the wrong interface. Look for the repair panel.
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_HackWarning_Reset">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="60s"/>
                      <actions>
                        <reset_cue cue="Ch_2_HackWarningn_Signal"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_Station_Hacked">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="this.$EndFeedbackValue ge 1">
                      <set_value name="$SignalStation" exact="$HackStation.{1}"/>
                      <do_if value="$PotentialHackRooms?">
                        <do_all exact="$PotentialHackRooms.count" counter="$r">
                          <set_dynamic_interior_private object="$SignalStation" room="$PotentialHackRooms.{$r}" private="false"/>
                        </do_all>
                      </do_if>
                    </do_if>
                  </actions>
                  <delay exact="4s"/>
                  <actions>
                    <do_if value="this.$EndFeedbackValue ge 1">
                      <signal_cue cue="Ch2_Station_Hacked_Dialogue"/>
                    </do_if>
                    <do_else>
                      <reset_cue cue="Ch2_HackStation_Found"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Ch2_Station_Hacked_Dialogue" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch2_UndockStation"/>
                      </actions>
                      <cues>

                        <cue name="Ch2_StationHacked__Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30227215],[30227216],[30227217],[30227218],[30227219]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Good work!
                            I can see the repair request in their internal system, but in order to get it to actually register as a job offer, we'll have to force their hand.
                            First, get out of here before someone spots you.
                            Then, create a signal for one of their repair teams to find.
                            That leak will get them to notice the job offer.
                          -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch2_HackStation_DelayedReset" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="5min"/>
              <actions>
                <signal_cue cue="Ch2_Hack_Station"/>
              </actions>
            </cue>

            <cue name="Ch2_UndockStation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!--<cancel_cue cue="Ch2_Hack_Station"/>-->
                <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.undock" text="$SignalStation.knownname" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch2_UndockStation_Destroyed">
                  <conditions>
                    <event_object_destroyed object="$SignalStation"/>
                  </conditions>
                  <actions>
                    <debug_text text="$SignalStation.knownname + ' has been destroyed. Resetting'"/>
                  </actions>
                  <cues>

                    <cue name="Ch2_Reset_UndockStation" instantiate="true" checkinterval="4min">
                      <conditions>
                        <check_value value="not $SignalStation.isoperational"/>
                      </conditions>
                      <actions>
                        <find_station_by_true_owner groupname="$TempRelayStation" faction="faction.antigone" space="$AntigoneMemorial" multiple="true" checkoperational="true"/>
                        <find_station_by_true_owner name="$SignalStation" faction="faction.argon" sortbygatedistanceto="if $TempRelayStation.count then $TempRelayStation.{1} else player.entity" space="player.galaxy" multiple="false" checkoperational="true">
                          <match_content class="class.walkablemodule" checkoperational="true" haswalkableroom="true"/>
                        </find_station_by_true_owner>
                        <remove_value name="$TempRelayStation"/>
                        <do_if value="$SignalStation.isoperational">
                          <set_value name="$ResetCue" exact="Ch2_UndockStation"/>
                          <signal_cue cue="Ch2_NewStation_Found_Dialogue"/>
                          <reset_cue cue="Ch2_UndockStation"/>
                        </do_if>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_HackStation_Undocked" checkinterval="2s">
                  <conditions>
                    <check_value value="(not player.entity.hascontext.{$SignalStation})"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch2_FlyTo_Outside_Hull"/>
                  </actions>
                </cue>

                <cue name="Ch2_FlyTo_Outside_Hull">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>

                    <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                    <create_position name="$OutsideStationPos" object="$SignalStation" space="$SignalStation.sector" min="10m" max="100m"/>

                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto" text="{30227,2004}" updatebriefing="true" object="$SignalStation.sector" offset="$OutsideStationPos" comment="Outside Hull"/>
                  </actions>
                  <cues>
                    <cue name="Ch2_FlyTo_Outside_Hull_Finished" checkinterval="1s">
                      <conditions>
                        <check_value value="player.sector == $SignalStation.sector and player.ship.distanceto.[$SignalStation.sector, $OutsideStationPos] lt 1km"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch2_UseSpacesuit"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_UseSpacesuit">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="player.ship.isclass.spacesuit">
                      <signal_cue cue="Ch2_Create_Leak_Setup"/>
                    </do_if>
                    <do_else>
                      <find_player_transporter_slot name="$TransporterSlot" object="player.entity.room"/>
                      <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.usespacesuit" slot="$TransporterSlot" updatebriefing="true" insert="true" comment="Use Spacesuit"/>
                      <signal_cue cue="HackStation_Activate_Spacesuit_Check"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="HackStation_Activate_Spacesuit_Check">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="HackStation_Spacesuit_Check">
                      <conditions>
                        <event_object_changed_room object="player.entity"/>
                        <check_value value="player.ship.isclass.spacesuit"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch2_Create_Leak_Setup"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_Create_Leak_Setup">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch2_HackStation_Found"/>

                    <!-- Ensuring the player cannot die -->
                    <set_value name="$PlayerSpacesuit" exact="player.ship"/>
                    <set_object_min_hull object="$PlayerSpacesuit" exact="20"/>

                    <create_group groupname="$SignalStationSignalLeaks"/>
                  </actions>
                  <cues>
                    <cue name="HackStation_EMP_Dal_Speak">
                      <actions>
                        <set_value name="$SpeakInProgress"/>
                      </actions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_330_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220331 else 30220330], [30227222, 2s], [30227223]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            Dal:
                            Now, use an EMP(pronounced E.M.P.) to create a breach, and then scan it.
                            (spoken to female player){10111,30220330}
                            Oh, and make sure there is no Station Security around!
                            You would not be able to put up much of a fight in your flimsy space suit.
                          -->
                        </cue>
                        <cue name="HackStation_EMP_Dal_Speak_Finished">
                          <actions>
                            <remove_value name="$SpeakInProgress"/>
                            <signal_cue cue="HackStation_EMP_Update_Objective"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="HackStation_EMP_Update_Objective">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.launch" object="$SignalStation" text="{30220,3007}" updatebriefing="true" insert="true" comment="Launch: EMP to Create Signal Leak"/>
                        <add_to_group groupname="$PlayerWeaponsGroup" list="player.ship.weapons.operational.list"/>
                      </actions>
                      <cues>

                        <cue name="HackStation_Wrong_Ammo">
                          <conditions>
                            <event_player_bomb_attached/>
                            <check_value value="event.param.macro != macro.bomb_player_limpet_emp_01_mk1_macro"/>
                            <check_value value="event.param.hascontext.{$SignalStation}"/>
                          </conditions>
                          <cues>
                            <cue name="Ch2_Speak_Dal_WrongAmmo_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor" value="$DalBusta"/>
                              <param name="CutsceneKey" value="$DalCutsceneKey"/>
                              <param name="Lines" value="[[30227224], [30227225]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="HackStation_Wrong_Ammo_Delay"/>

                              <!--
                                We don't want to damage the station's hull, just breach their systems.
                                Try using an EMP instead.
                              -->
                            </cue>
                            <cue name="HackStation_Wrong_Ammo_Delay">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="20s"/>
                              <actions>
                                <reset_cue cue="HackStation_Wrong_Ammo"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="HackStation_BombAttacked" instantiate="true">
                      <conditions>
                        <event_object_attacked object="$SignalStation" method="killmethod.hitbybomb"/>
                      </conditions>
                      <cues>

                        <cue name="HackStation_RegisteredAttack">
                          <conditions>
                            <event_object_signalled object="$SignalStation.sector" param="'station_bombed'"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Player was caught detonnating EMP'" />
                            <set_value name="$PlayerAttackRegistered"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="HackStation_EMP_Check_For_Breach">
                      <conditions>
                        <event_player_created_signal_leaks/>
                        <check_value value="event.param.{1}.object == $SignalStation"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="HackStation_Wrong_Ammo"/>
                        <do_for_each in="event.param" name="$CurrentElement">
                          <add_to_group groupname="$SignalStationSignalLeaks" object="$CurrentElement"/>
                        </do_for_each>
                        <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" group="$SignalStationSignalLeaks" text="{30220,3008}" insert="true" updatebriefing="true" comment="Scan: Signal Leak"/>

                      </actions>
                      <cues>

                        <cue name="HackStation_Surveillance_EMP_Check_For_Further_Breaches" instantiate="true">
                          <conditions>
                            <event_player_created_signal_leaks/>
                            <check_value value="event.param.{1}.object == $SignalStation"/>
                          </conditions>
                          <actions>
                            <do_for_each in="event.param" name="$CurrentElement">
                              <add_to_group groupname="$SignalStationSignalLeaks" object="$CurrentElement"/>
                            </do_for_each>
                            <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" group="$SignalStationSignalLeaks" text="{30220,3008}" silent="true" updatebriefing="true" comment="Scan: Signal Leak"/>
                          </actions>
                        </cue>
                        <cue name="HackStation_Surveillance_EMP_Leaks_Destroyed">
                          <conditions>
                            <event_object_destroyed group="$SignalStationSignalLeaks"/>
                            <check_value value="$SignalStationSignalLeaks.count == 1"/>
                          </conditions>
                          <actions>
                            <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.launch" object="$SignalStation" text="{30220,3007}" updatebriefing="true" comment="Launch: EMP to Create Signal Leak"/>
                            <reset_cue cue="HackStation_EMP_Check_For_Breach"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>
                    <cue name="Ch2_HackStation_Hack_Finished">
                      <conditions>
                        <check_any>
                          <event_player_repaired_signal_leak/>
                          <event_player_signal_unlock_impossible/>
                          <event_player_signal_unlock_finished/>
                        </check_any>
                        <check_value value="$SignalStationSignalLeaks.indexof.{event.param} and player.ship.isclass.spacesuit"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="HackStation_Surveillance_EMP_Leaks_Destroyed" comment="If we don't cancel the check for the leaks to be destroyed, that check will trigger when they despawn later."/>
                        <create_list name="$Dal_Lines_Ch2_StationHacked"/>

                        <do_if value="$PlayerAttackRegistered?">
                          <append_to_list name="$Dal_Lines_Ch2_StationHacked" exact="[30227226]"/>
                        </do_if>

                        <append_to_list name="$Dal_Lines_Ch2_StationHacked" exact="[30227227]"/>

                        <get_safe_pos result="$LeakPos" object="event.param" max="120m" sector="$SignalStation.sector"/>
                      </actions>
                      <cues>


                        <cue name="Ch2_Dal_Retreat_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor" value="$DalBusta"/>
                          <param name="CutsceneKey" value="$DalCutsceneKey"/>
                          <param name="Lines" value="$Dal_Lines_Ch2_StationHacked"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch_2_Cleanup"/>

                          <!--
                          Dal:
                          Security didn't like that.
                          Best fall back while I finisht things up.
                          -->
                        </cue>
                        <cue name="Ch_2_Cleanup">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <remove_mission cue="$MissionCue" type="completed"/>

                            <signal_cue cue="Ch3_LocateHiddenStation"/>
                            <cancel_cue cue="Ch2_RepairBait"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch2_NewStation_Found_Dialogue" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch2_Dal_NewHackStation_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="DelayInitial"      value="1s"/>
                  <param name="Lines"             value="[[30227230],[30227231]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="$ResetCue"/>
                  <!--
                      The station you were meant to hack into was destroyed.
                      I am sending you another suitable target now.
                  -->
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>


        <!-- Chapter 3: Locate server room on relay station -->

        <cue name="Ch3_Force">
          <actions>
            <!-- Special setup when you "fast-forward" into a chapter (skipping earlier ones) -->
          </actions>
          <force name="Ch3_LocateHiddenStation">
            <signal_cue_instantly cue="Debug_Setup_HQ" check="false"/>
            <signal_cue cue="Setup_Remember_Diplomacy_Plot"/>
            <signal_cue_instantly cue="Debug_Setup_Terran_SSC"/>
            <signal_cue cue="SecretServiceActor_Dialog_Option_Story"/>
            <find_station_by_true_owner name="$TempRelayStation" faction="faction.antigone" space="$AntigoneMemorial" multiple="false" checkoperational="true" canclaimownership="true"/>
            <find_station_by_true_owner name="$SignalStation" faction="faction.argon" sortbygatedistanceto="if $TempRelayStation? then $TempRelayStation else player.entity" space="player.galaxy" multiple="false" checkoperational="true"/>
            <get_safe_pos result="$LeakPos" sector="$SignalStation.sector" object="$SignalStation" min="300m" max="500m"/>
            <signal_cue cue="Ch3_LocateHiddenStation"/>
          </force>
        </cue>

        <cue name="Ch3_LocateHiddenStation" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>
            <signal_cue cue="Setup_Ch3_RelayStation" check="false"/>
          </actions>
          <patch sinceversion="2">
            <!-- Station could have potentially destroyed or become inacessible -->
            <do_if value="$RelayStation.isoperational">
              <find_object_component groupname="$DockingComponents" object="$RelayStation" class="class.walkablemodule" haswalkableroom="true" multiple="true"/>
              <do_if value="$DockingComponents.count == 0">
                <remove_dynamic_interior interior="$ServerRoom_Interior" object="$RelayStation"/>
                <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                  <param name="Object" value="$RelayStation"/>
                  <param name="RequesterCue" value="Setup_Ch3_Relay_Station_Interior"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>

                <do_if value="Ch3_Locate_ServerRoom.state == cuestate.complete">
                  <reset_cue cue="Ch3_Locate_ServerRoom"/>
                </do_if>
                <reset_cue cue="Setup_Ch3_RelayStation"/>
                <set_value name="$Patch_LocateServerRoom"/>
              </do_if>
            </do_if>
            <do_else>
              <do_if value="Ch3_Locate_ServerRoom.state == cuestate.complete">
                <reset_cue cue="Ch3_Locate_ServerRoom"/>
              </do_if>
              <reset_cue cue="Setup_Ch3_RelayStation"/>
              <set_value name="$Patch_LocateServerRoom"/>
            </do_else>
          </patch>
          <cues>

            <cue name="Ch3_Story_Reminder">
              <cues>
                <cue name="Ch3_Story_Reminder_Ref" ref="Story_Reminder">
                  <param name="Actor"       value="$DalBusta"/>
                  <param name="CutsceneKey" value="$DalCutsceneKey"/>
                  <param name="Lines"       value="[[30227228],[30227229]]"/>
                  <param name="CancelCue"   value="Ch3_PlayerFoundServers"/>
                  <param name="Delay"       value="40min"/>
                  <!--
                  We still need to work on finding that Relay Station. 
                  Terrans are not known for their unending patience.
                  -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch_3_SSC_HackSuccess_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
              <param name="Actor"             value="$SecretServiceActor"/>
              <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
              <param name="DelayInitial"      value="5s"/>
              <param name="Lines"             value="[[30227220],[30227221]]"/>
              <param name="MissionCue"        value="$MissionCue"/>
              <param name="EndSignalCue"      value="null"/>
              <!--
                SSC:
                (Pleased)I see things are progressing as planned!
                Now we wait for a repair crew to take the bait.
              -->
            </cue>

            <cue name="Ch3_RepairShip_Setup" version="2">
              <delay exact="3s"/>
              <actions>
                <debug_text text="'Creating Repair Ship'" chance="$DebugChance"/>

                <get_ship_definition reference="$RepairShipDef" size="class.ship_m" faction="faction.argon" tags="tag.trader"/>
                <find_object_component name="$SignalStationDocks" object="$SignalStation" multiple="true" state="componentstate.operational">
                  <match_dock storage="true" size="tag.dock_m"/>
                </find_object_component>
                <do_if value="$SignalStationDocks.count">

                  <create_ship name="$RepairShip" ref="$RepairShipDef" dock="$SignalStationDocks.random" capturable="false" missioncue="namespace">
                    <owner exact="faction.argon" overridenpc="true" />
                    <pilot>
                      <select faction="faction.argon" tags="[tag.commander]"/>
                    </pilot>
                    <ammo>
                      <macro ref="macro.eq_arg_satellite_01_macro">
                        <fillamount exact="10"/>
                      </macro>
                    </ammo>
                  </create_ship>
                </do_if>

                <do_if value="not $RepairShip.isoperational">
                  <create_ship name="$RepairShip" ref="$RepairShipDef" sector="$SignalStation.sector" capturable="false" missioncue="namespace">
                    <owner exact="faction.argon" overridenpc="true" />
                    <pilot>
                      <select faction="faction.argon" tags="[tag.commander]"/>
                    </pilot>
                    <ammo>
                      <macro ref="macro.eq_arg_satellite_01_macro">
                        <fillamount exact="10"/>
                      </macro>
                    </ammo>
                    <safepos object="$SignalStation" min="2km" max="3km"/>
                  </create_ship>
                </do_if>
                  
                <set_value name="$RepairShip.pilot.$noattackresponse" exact="true"/>
                <set_object_name object="$RepairShip" page="30227" line="205"/>
                <signal_cue cue="Ch3_Fall_back"/>
                <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                  <param name="Object" value="$RepairShip"/>
                  <param name="RequesterCue" value="namespace"/>
                  <param name="MinHull" value="100"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>
                <cancel_all_orders object="$RepairShip"/>
                <create_order object="$RepairShip" id="'Wait'"/>
              </actions>
              <patch sinceversion="2">
                <!--The Repair Ship could actually die inbetween mission steps, so we have to recover in that case, and set it to invulnerable -->
                <do_if value="Ch3_Locate_ServerRoom.state == cuestate.waiting">
                  <do_if value="not $RepairShip.isoperational">
                    <get_ship_definition reference="$RepairShipDef" size="class.ship_m" faction="faction.argon" tags="tag.trader"/>
                    <create_list name="$SignalStationDocks"/>
                    <find_object_component name="$SignalStationDocks" object="$SignalStation" multiple="true" state="componentstate.operational">
                      <match_dock storage="true" size="tag.dock_m"/>
                    </find_object_component>
                    
                    <do_if value="$SignalStationDocks.count">
                      <create_ship name="$RepairShip" ref="$RepairShipDef" dock="$SignalStationDocks.random" capturable="false" missioncue="namespace">
                        <owner exact="faction.argon" overridenpc="true" />
                        <pilot>
                          <select faction="faction.argon" tags="[tag.commander]"/>
                        </pilot>
                        <ammo>
                          <macro ref="macro.eq_arg_satellite_01_macro">
                            <fillamount exact="10"/>
                          </macro>
                        </ammo>
                      </create_ship>
                    </do_if>

                    <do_if value="not $RepairShip.isoperational">
                      <create_ship name="$RepairShip" ref="$RepairShipDef" sector="$SignalStation.sector" capturable="false" missioncue="namespace">
                        <owner exact="faction.argon" overridenpc="true" />
                        <pilot>
                          <select faction="faction.argon" tags="[tag.commander]"/>
                        </pilot>
                        <ammo>
                          <macro ref="macro.eq_arg_satellite_01_macro">
                            <fillamount exact="10"/>
                          </macro>
                        </ammo>
                        <safepos object="$SignalStation" min="2km" max="3km"/>
                      </create_ship>
                    </do_if>
                  </do_if>
                  <set_object_name object="$RepairShip" page="30227" line="205"/>
                  <cancel_all_orders object="$RepairShip"/>
                  <create_order object="$RepairShip" id="'Wait'"/>
                </do_if>
                <do_if value="Ch3_FollowShip.state == cuestate.waiting">
                  <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                    <param name="Object" value="$RepairShip"/>
                    <param name="RequesterCue" value="namespace"/>
                    <param name="MinHull" value="100"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>
                </do_if>
              </patch>
            </cue>
            <cue name="Ch3_Fall_back">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <get_safe_pos result="$ObservationPos" sector="$SignalStation.sector" object="$SignalStation" min="16km" max="18km" radius="1km"/>

                <create_mission cue="$MissionCue" name="{30227,3001}" description="{30227,3002}" rewardtext="{30227,3007}" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname">
                  <briefing>
                    <objective step="$ObjectiveStep" action="objective.flyto" text="{30227,3003}"/>
                  </briefing>
                </create_mission>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto" text="{30227,3003}" updatebriefing="true" object="$SignalStation.sector" offset="$ObservationPos" radius="1.5km"/>
              </actions>
              <delay exact="2s"/>
              <actions>
                <!-- Return vulnerability to spacesuit -->
                <do_if value="$PlayerSpacesuit?">
                  <set_object_min_hull object="$PlayerSpacesuit" exact="0"/>
                </do_if>
              </actions>
              <cues>
                <cue name="Ch3_Raid_Setup">
                  <actions>
                    <get_jump_path component="$jumppath" multiple="true" uselocalhighways="true">
                      <start object="$RepairShip"/>
                      <end object="$RelayStation.sector"/>
                    </get_jump_path>
                    <debug_text text="'Jump Gates count: ' + $jumppath.count"/>
                    <do_if value="$jumppath.count ge 3">
                      <set_value name="$HalfwayGate" exact="$jumppath.count/2"/>
                      <set_value name="$HalfwayGate" exact="1000 - (1000 - $HalfwayGate)i" comment="Round up to nearest integer" />
                      <debug_text text="'$HalfwayGate ' + $HalfwayGate"/>
                      <set_value name="$AmbushSector" exact="$jumppath.{$HalfwayGate}.sector"/>
                      <debug_text text="'Ambush Sector: ' + $AmbushSector.knownname"/>
                    </do_if>
                    <remove_value name="$jumppath"/>
                    <remove_value name="$HalfwayGate"/>
                  </actions>
                </cue>

                <cue name="Ch3_RepairShip_Leak">
                  <actions>
                    <cancel_all_orders object="$RepairShip"/>

                    <create_order object="$RepairShip" id="'MoveWait'" name="$scanorder" immediate="true">
                      <param name="destination" value="[$SignalStation.sector, $LeakPos]"/>
                      <param name="precise" value="false"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                  </actions>
                  <cues>
                    <cue name="Ch3_RepairShip_InCloseProximityToLeak" checkinterval="1s">
                      <conditions>
                        <check_value value="$RepairShip.distanceto.{[$SignalStation.sector, $LeakPos]} lt 900m"/>
                      </conditions>
                      <actions>
                        <cancel_all_orders object="$RepairShip"/>
                        <create_order object="$RepairShip" id="'MoveWait'" name="$precisescanorder" immediate="true">
                          <param name="destination" value="[$SignalStation.sector, $LeakPos]"/>
                          <param name="precise" value="true"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>
                      </actions>
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch3_Fall_Back_Finished" checkinterval="1s">
                  <conditions>
                    <check_all>
                      <check_value value="player.sector == $SignalStation.sector and player.ship.distanceto.[$SignalStation.sector, $ObservationPos] lt 1.5km"/>
                      <check_value value="player.ship"/>
                    </check_all>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.await" text="{30227,205}"/>
                  </actions>
                  <cues>

                    <cue name="Ch3_Repair_Ship_Undocked" checkinterval="1s">
                      <conditions>
                        <check_value value="not $RepairShip.hascontext.{$SignalStation}"/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" action="objective.observe" object="$RepairShip" text="$RepairShip.knownname"/>
                      </actions>
                      <cues>

                        <cue name="Ch3_Dal_RepairShip_Spotted_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor" value="$DalBusta"/>
                          <param name="CutsceneKey" value="$DalCutsceneKey"/>
                          <param name="Lines" value="[[30227301],[if $RepairShip.distanceto.{$LeakPos} gt 2200m then 30227302 else null]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"  value="Ch_3_ApproachingLeak"/>
                          <!--
                          There they are!
                          Looks like they are heading for the leak.
                          -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch_3_ApproachingLeak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch_3_Scan_FallBack">
                          <delay exact="60s"/>
                          <actions>
                            <!--Ship likely got stuck, forcing continue -->
                            <warp object="$RepairShip" sector="$RepairShip.sector">
                              <safepos object="$SignalStation" max="2km" radius="200m"/>
                            </warp>
                            <set_value name="$ScanFallback"/>
                          </actions>
                        </cue>

                        <cue name="Ch_3_Check_RepairShipDistance" checkinterval="1s">
                          <conditions>
                            <check_value value="($RepairShip.distanceto.{[$SignalStation.sector, $LeakPos]} lt 150m) or $ScanFallback?"/>
                          </conditions>
                          <actions>
                            <cancel_cue cue="Ch_3_Scan_FallBack"/>
                          </actions>
                          <delay exact="2s"/>
                          <actions>
                            <cancel_all_orders object="$RepairShip"/>
                            <create_order object="$RepairShip" id="'DockAndWait'" name="$dockorder" default="true">
                              <param name="destination" value="$RelayStation"/>
                            </create_order>

                            <debug_text text="'Ordered ' + $RepairShip + ' ' + $RepairShip.knownname + ' to move to ' + $RelayStation.knownname" chance="$DebugChance"/>
                          </actions>
                          <cues>

                            <cue name="Ch3_Dal_Start_Following_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor" value="$DalBusta"/>
                              <param name="CutsceneKey" value="$DalCutsceneKey"/>
                              <param name="Lines" value="[[30227303],[30227304]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"  value="Ch3_FollowShip"/>
                              <!--
                              The database just confirmed they accepted the repair request.
                              Follow them, but keep a distance and they will lead us right to the station in question.
                              -->
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_FollowShip">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Make RepairShip vulnerable again -->
                <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                  <param name="Object" value="$RepairShip"/>
                  <param name="RequesterCue" value="namespace"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>
                <set_value name="$RepairShip.pilot.$noattackresponse" exact="false"/>

                <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.track" object="$RepairShip" updatebriefing="true" text="$RepairShip.knownname"/>
                <set_value name="$ShipTooFar" exact="0"/>
                <set_value name="$ShipTooClose" exact="0"/>
                <create_list name="$ApproachHandlers"/>
                <set_value name="$XenonRaid" exact="false"/>
              </actions>
              <cues>
                <cue name="Ch3_CheckRepairShipOrder" onfail="cancel">
                  <conditions>
                    <check_value value="($RepairShip.order.id == 'MoveWait')"/>
                  </conditions>
                  <actions>
                    <cancel_all_orders object="$RepairShip"/>
                    <create_order object="$RepairShip" id="'DockAndWait'" name="$dockorder" default="true">
                      <param name="destination" value="$RelayStation"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch3_Xenon_Raid_Check_Sector" onfail="cancel">
                  <conditions>
                    <check_value value="$AmbushSector?"/>
                  </conditions>
                  <actions>
                    <do_if value="player.sector == $AmbushSector">
                      <set_value name="$AmbushDistanceMin" exact="40km"/>
                      <set_value name="$AmbushDistanceMax" exact="80km"/>
                      <signal_cue cue="Ch3_Xenon_Raid_Trigger"/>
                    </do_if>
                    <do_else>
                      <set_value name="$AmbushDistanceMin" exact="4km"/>
                      <set_value name="$AmbushDistanceMax" exact="7km"/>
                      <append_to_list name="$ApproachHandlers" exact="this"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="CCh3_Xenon_Raid_Check_Sector_ReachedTargetSector_Ref" ref="md.LIB_Generic.ReachedSector">
                      <param name="TargetObject"      value="player.entity"/>
                      <param name="TargetSector"      value="$AmbushSector"/>
                      <param name="SuccessSignalCue"  value="Ch3_Xenon_Raid_Trigger"/>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_RepairShip_Followed_Arrived">
                  <conditions>
                    <event_object_docking_started dock="$RelayStation" object="$RepairShip"/>
                  </conditions>
                  <actions>
                    <do_if value="player.ship.distanceto.{$RepairShip} lt 110km">
                      <signal_cue cue="Ch3_StationIdentified"/>
                    </do_if>
                    <do_else>
                      <signal_cue_instantly cue="Ch3_Failed" param="'lost'"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch3_StationIdentified">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch_3_SSC_StationFound_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30227308],[30227309]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch3_Locate_ServerRoom"/>
                      <!--
                      Impressive work, Agent!
                      Now we know which station hosts their relay servers.
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_TraversedGate" instantiate="true">
                  <conditions>
                    <event_object_changed_cluster object="$RepairShip"/>
                  </conditions>
                  <actions>
                    <set_value name="$TraverseCooldown"/>
                  </actions>
                  <delay exact="20s"/>
                  <actions>
                    <remove_value name="$TraverseCooldown"/>
                  </actions>
                </cue>

                <cue name="Ch3_RepairShip_DistanceCheck" checkinterval="3s" instantiate="true">
                  <conditions>
                    <check_value value="$RepairShip.isoperational and ($XenonRaid == false) and (player.ship.distanceto.{$RelayStation} gt 40km) and (not $TraverseCooldown?)"/>
                  </conditions>
                  <actions>
                    <debug_text text="'checking distance'" chance="$DebugChance"/>
                    <do_if value="player.ship.distanceto.{$RepairShip} lt 80km or $RepairShip.zone.isclass.highway">
                      <set_value name="$ShipTooFar" exact="0"/>
                    </do_if>
                    <do_elseif value="($ShipTooFar ge 14 and $XenonRaid == false) or ($ShipTooFar ge 18 and $XenonRaid == true)">
                      <signal_cue_instantly cue="Ch3_Failed" param="'lost'" check="false"/>
                      <debug_text text="'Long Distance Lost ' + $ShipTooFar" chance="$DebugChance"/>
                    </do_elseif>
                    <do_else>
                      <set_value name="$ShipTooFar" operation="add" exact="1"/>
                      <debug_text text="'Long Distance Add ' + $ShipTooFar" chance="$DebugChance"/>
                    </do_else>
                    <do_if value="player.ship.distanceto.{$RepairShip} gt 12km">
                      <set_value name="$ShipTooClose" exact="0"/>
                    </do_if>
                    <do_elseif value="$ShipTooClose ge 6">
                      <signal_cue_instantly cue="Ch3_RepairShip_TooClose" check="false"/>
                      <debug_text text="'Short Distance Lost ' + $ShipTooClose" chance="$DebugChance"/>
                    </do_elseif>
                    <do_else>
                      <set_value name="$ShipTooClose" operation="add" exact="1"/>
                      <debug_text text="'Short Distance Add ' + $ShipTooClose" chance="$DebugChance"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Ch_3_DistanceWarning" onfail="cancel">
                      <conditions>
                        <check_any>
                          <check_value value="$ShipTooFar == 1"/>
                          <check_value value="$ShipTooClose == 1"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="$ShipTooFar == 1">
                          <set_value name="$WarningLine" exact="[30227308, 30227309].random"/>
                        </do_if>
                        <do_else>
                          <set_value name="$WarningLine" exact="[30227305, 30227306].random"/>
                        </do_else>
                      </actions>
                      <cues>

                        <cue name="Ch3_Dal_Warning_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor" value="$DalBusta"/>
                          <param name="CutsceneKey" value="$DalCutsceneKey"/>
                          <param name="Lines" value="[[$WarningLine]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="SpeechPriority"    value="90"/>
                          <param name="EndSignalCue"  value="null"/>
                          <!--
                          Too far:
                          They are getting away!
                          If we get too far away, we'll loose them!
                          
                          Too close:
                          Don't get too close to them!
                          Woah, back off! If you spook them this will have been for nothing!
                          -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_RepairShip_TooClose">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_relation_boost object="$RepairShip" silent="true" otherobject="player.entity" value="-1.0" decay="0.02" delay="540s" />
                    <cancel_all_orders object="$RepairShip"/>
                    <do_if value="$SignalStation.isoperational">
                      <create_order object="$RepairShip" id="'DockAndWait'" name="$dockorder" default="true">
                        <param name="destination" value="$SignalStation"/>
                      </create_order>
                    </do_if>
                    <do_else>
                      <create_order id="'Patrol'" object="$RepairShip" default="true">
                        <param name="space" value="$RepairShip.sector"/>
                      </create_order>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Ch3_Dal_LostShip_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor" value="$DalBusta"/>
                      <param name="CutsceneKey" value="$DalCutsceneKey"/>
                      <param name="Lines" value="[[30227307]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"  value="Ch3_Failed"/>
                      <!--
                      (Dissapointed)Looks like you spooked them. Let's get out of here.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_Xenon_Raid_Trigger">
                  <conditions>
                    <check_all>
                      <event_cue_signalled/>
                      <check_value value="$AmbushSector == $RepairShip.sector and $XenonRaid == false"/>
                    </check_all>
                  </conditions>
                  <actions>
                    <debug_text text="'Xenon Raid Triggered'" chance="$DebugChance"/>
                    <set_value name="$playership" exact="player.ship"/>

                    <!-- Abort Approach Handlers-->
                    <do_all exact="$ApproachHandlers.count" counter="$ah">
                      <do_if value="$ApproachHandlers.{$ah}.exists">
                        <cancel_cue cue="$ApproachHandlers.{$ah}"/>
                      </do_if>
                    </do_all>

                    <!-- Xenon squad that disrupts the player's effort -->
                    <set_value name="$XenonRaidComposition" exact="[
                          [ macro.ship_xen_s_fighter_02_a_macro, 1 ],
                          [ macro.ship_xen_s_fighter_01_a_macro, 1 ],
                          [ macro.ship_xen_s_fighter_01_a_macro, 1 ]
                          ]" />

                    <do_all exact="$XenonRaidComposition.count" counter="$m">
                      <do_all exact="$XenonRaidComposition.{$m}.{2}" counter="$a">
                        <create_ship name="$CurrentShip" macro="$XenonRaidComposition.{$m}.{1}" commandeerable="false" capturable="false" missioncue="namespace" sector="$AmbushSector">
                          <owner exact="faction.xenon" overridenpc="true"/>
                          <pilot>
                            <select faction="faction.xenon" tags="tag.fighterpilot"/>
                          </pilot>
                          <loadout>
                            <level exact="1.0"/>
                          </loadout>
                          <drop ref="ship_small_xenon"/>
                          <orientation refobject="$playership" orientation="look_at"/>
                          <safepos object="$RepairShip" min="$AmbushDistanceMin" max="$AmbushDistanceMax"/>
                        </create_ship>

                        <cancel_all_orders object="$CurrentShip"/>

                        <create_order id="'Attack'" object="$CurrentShip" immediate="true">
                          <param name="primarytarget" value="$playership"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="allowothertargets" value="false"/>
                          <param name="checkrelation" value="false"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>

                        <add_to_group groupname="$XenonRaidGroup" object="$CurrentShip"/>
                      </do_all>
                    </do_all>

                  </actions>
                  <cues>
                    <cue name="Ch3_Move_XenonShips_LeftBehind" instantiate="true">
                      <conditions>
                        <event_object_changed_sector object="player.entity"/>
                        <check_value value="($XenonRaid == false) and ($RepairShip.sector == player.sector)"/>
                      </conditions>
                      <actions>
                        <do_if value="event.param2 == $AmbushSector" comment="Attack did not happen, one more chance">
                          <do_all exact="$XenonRaidGroup.count" counter="$i">
                            <warp object="$XenonRaidGroup.{$i}" sector="player.sector">
                              <safepos object="event.param" min="6km" max="15" radius="3km"/>
                              <orientation orientation="look_at" refobject="player.entity"/>
                            </warp>
                          </do_all>
                        </do_if>
                        <do_else>
                          <do_all exact="$XenonRaidGroup.count" counter="$i">
                            <create_order id="'MoveDie'" object="$XenonRaidGroup.{$i}" immediate="true">
                              <param name="mintime" value="60s" comment="stay alive for specified time, then die"/>
                            </create_order>
                          </do_all>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch3_Xenon_In_Proximity">
                      <conditions>
                        <event_object_attacked object="$playership"/>
                        <check_value value="$XenonRaidGroup.indexof.{event.param}"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Xenon Attack initiated'" chance="$DebugChance"/>
                        <set_value name="$XenonRaid"/>
                        <set_value name="$XenonRaidTimer" exact="player.age"/>
                      </actions>
                      <cues>

                        <cue name="Ch_3_Dal_XenonAttackStart_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30227310],[30227311]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          Oh no, a Xenon raid!
                          Shake them of, or deal with them, quickly! We can't affort to lose the repair ship!
                          -->
                        </cue>
                        <cue name="Ch3_Escaped_Xenon" checkinterval="2s">
                          <conditions>
                            <check_all>
                              <check_value value="player.age gt $XenonRaidTimer + 30s and $XenonRaid == true"/>
                              <check_all exact="$XenonRaidGroup.count" counter="$i">
                                <check_value value="$playership.distanceto.{$XenonRaidGroup.{$i}} gt 40km and $playership.sector == $XenonRaidGroup.{$i}.sector"/>
                              </check_all>
                            </check_all>
                          </conditions>
                          <actions>
                            <do_all exact="$XenonRaidGroup.count" counter="$i">
                              <create_order id="'MoveDie'" object="$XenonRaidGroup.{$i}" immediate="true">
                                <param name="mintime" value="60s" comment="stay alive for specified time, then die"/>
                              </create_order>
                            </do_all>
                            <signal_cue cue="Ch_3_Raid_Done" check="false"/>
                          </actions>
                        </cue>
                        <cue name="Ch3_Xenon_Ship_Destroyed" instantiate="true">
                          <conditions>
                            <event_object_destroyed group="$XenonRaidGroup"/>
                            <check_value value="$XenonRaid == true"/>
                          </conditions>
                          <actions>
                            <do_if value="$XenonRaidGroup.count lt 1">
                              <signal_cue cue="Ch_3_Raid_Done" check="false"/>
                            </do_if>
                          </actions>
                        </cue>
                        <cue name="Ch_3_Raid_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>

                            <cue name="Ch_3_SSC_XenonAttackFinished_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$SecretServiceActor"/>
                              <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                              <param name="Lines"             value="[[30227306],[30227307]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="Ch_3_Continue_Follow"/>
                              <!--
                              (Disgusted at the displayed incompetence)Incredible. These naive fools just yield their space to the Xenon without any effort to contain the threat.
                              Just goes to show how their complacency puts the entirety of the human species at risk.
                              -->
                            </cue>
                            <cue name="Ch_3_Continue_Follow">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_value name="$XenonRaid" exact="false"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_Dropped_Satellite" checkinterval="2s">
                  <conditions>
                    <check_value value="$RepairShip.isoperational and (player.sector == $RepairShip.sector) and ($RepairShip.distanceto.{$SignalStation} ge 50km) and (player.entity.distanceto.{$RepairShip} lt 80km) and $XenonRaid == false"/>
                  </conditions>
                  <delay exact="1ms"/>
                  <actions>
                    <do_if value="not $RepairShip.zone.isclass.highway">
                      <signal_cue cue="Drop_Satellite"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Wait_For_HighwayExit"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Wait_For_HighwayExit">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Left_Highway">
                          <conditions>
                            <event_object_changed_zone object="$RepairShip"/>
                            <check_value value="not $RepairShip.zone.isclass.highway"/>
                          </conditions>
                          <delay exact="10s"/>
                          <actions>
                            <signal_cue cue="Drop_Satellite"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>
                    <cue name="Drop_Satellite">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Dropping Satellite'" chance="$DebugChance"/>
                        <create_position name="$SatellitePos" object="$RepairShip" space="$RepairShip.sector"/>
                        <create_order object="$RepairShip" id="'DeployObjectAtPosition'" immediate="true" >
                          <param name="destination" value="[$RepairShip.sector, $SatellitePos]"/>
                          <param name="objectstodeploy" value="[macro.eq_arg_satellite_01_macro]"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>
                      </actions>
                      <cues>

                        <cue name="Satellite_Dropped">
                          <conditions>
                            <event_object_launched_satellite object="$RepairShip"/>
                          </conditions>
                          <actions>
                            <set_value name="$RepairSat" exact="event.param"/>
                            <create_group groupname="$ObjectiveGroup"/>
                            <add_to_group groupname="$ObjectiveGroup" object="$RepairSat"/>
                            <add_to_group groupname="$ObjectiveGroup" object="$RepairShip"/>

                            <set_value name="$SatTooClose" exact="0"/>
                            <set_objective cue="$MissionCue" action="objective.track" silent="true" group="$ObjectiveGroup" text="$RepairShip.knownname"/>
                            <do_if value="$SatelliteExposition?">
                              <signal_cue cue="Enable_ProximityCheck" check="false"/>
                            </do_if>
                          </actions>
                          <cues>
                            <cue name="Satellite_Exposition" onfail="cancel">
                              <conditions>
                                <check_value value="not $SatelliteExposition?"/>
                              </conditions>
                              <cues>

                                <cue name="Ch3_Dal_SatelliteInitialWarning_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor" value="$DalBusta"/>
                                  <param name="CutsceneKey" value="$DalCutsceneKey"/>
                                  <param name="Lines" value="[[30227312],[30227313]]"/>
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="SpeechPriority"  value="90"/>
                                  <param name="EndSignalCue"  value="Enable_ProximityCheck"/>
                                  <!--
                                    Looks like the Maintenance Vessel just dropped a satellite.
                                    Best steer clear, you wouldn't want to end up on their radar.
                                  -->
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Enable_ProximityCheck">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_value name="$SatelliteExposition"/>
                                <set_value name="$SatFar" exact="0"/>
                              </actions>
                              <cues>

                                <cue name="Satellite_Proximity_Check" instantiate="true" checkinterval="2s">
                                  <conditions>
                                    <check_value value="$XenonRaid == false and player.ship.distanceto.{$RelayStation} gt 40km and not $RepairShip.isclass.highway"/>
                                  </conditions>
                                  <actions>
                                    <debug_text text="'checking distance to satellite'" chance="$DebugChance"/>
                                    <do_if value="player.ship.distanceto.{$RepairSat} ge 10km">
                                      <set_value name="$SatTooClose" exact="0"/>
                                    </do_if>
                                    <do_elseif value="$SatTooClose ge 9">
                                      <set_value name="$SatFar" exact="0"/>
                                      <signal_cue_instantly cue="Ch3_RepairShip_TooClose" check="false"/>
                                      <debug_text text="'Short Distance Lost ' + $SatTooClose" chance="$DebugChance"/>
                                    </do_elseif>
                                    <do_else>
                                      <set_value name="$SatTooClose" operation="add" exact="1"/>
                                      <debug_text text="'Short Distance Add ' + $SatTooClose" chance="$DebugChance"/>
                                    </do_else>
                                    <do_if value="(player.ship.distanceto.{$RepairSat} gt 60km) or ($RepairShip.distanceto.{$RepairSat} gt 130km)">
                                      <set_value name="$SatFar" operation="add" exact="1"/>
                                    </do_if>
                                    <do_if value="$SatFar ge 3 or ($RepairSat.sector != player.ship.sector)">

                                      <signal_cue cue="Avoided_Satellite"/>
                                    </do_if>
                                  </actions>
                                  <cues>

                                    <cue name="Sat_Warning" onfail="cancel">
                                      <conditions>
                                        <check_value value="$SatTooClose == 1"/>
                                      </conditions>
                                      <cues>

                                        <cue name="Ch3_Dal_SatelliteWarning_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                          <param name="Actor" value="$DalBusta"/>
                                          <param name="CutsceneKey" value="$DalCutsceneKey"/>
                                          <param name="Lines" value="[[30227314]]"/>
                                          <param name="MissionCue"        value="$MissionCue"/>
                                          <param name="SpeechPriority"  value="95"/>
                                          <param name="EndSignalCue"  value="null"/>
                                          <!--
                                            Put some distance between you and the satellite!
                                          -->
                                        </cue>

                                      </cues>
                                    </cue>

                                  </cues>
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Disable_GuidanceOnHighway" instantiate="true">
                              <conditions>
                                <event_object_changed_zone object="$RepairShip"/>
                                <check_value value="event.param.isclass.highway"/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue" action="objective.track" object="$RepairShip"  text="$RepairShip.knownname" silent="true"/>
                              </actions>
                              <cues>
                                <cue name="Reenable_Guidance">
                                  <conditions>
                                    <event_object_changed_zone object="$RepairShip"/>
                                    <check_value value="event.param2.isclass.highway and not event.param.isclass.highway and ($RepairSat.sector == player.ship.sector)"/>
                                  </conditions>
                                  <delay exact="8s"/>
                                  <actions>
                                    <do_if value="Avoided_Satellite.state == cuestate.waiting" comment="if satellite is still a threat, reenable guidance">
                                      <set_objective cue="$MissionCue" action="objective.track" silent="true" group="$ObjectiveGroup" text="$RepairShip.knownname"/>
                                    </do_if>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Avoided_Satellite">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue" action="objective.track" object="$RepairShip"  text="$RepairShip.knownname" silent="true"/>
                                <set_value name="$RandomDelay" min="40s" max="150s"/>
                                <cancel_cue cue="Enable_ProximityCheck"/>
                              </actions>
                              <delay exact="$RandomDelay"/>
                              <actions>
                                <debug_text text="'Resetting Satellite Cue'"/>
                                <reset_cue cue="Ch3_Dropped_Satellite"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>
                <cue name="Ch3_Failed">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_destroyed object="$RepairShip"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="$RepairShip.isoperational" comment="Do an exception if the Ship was destroyed (likely outside the player's control)">
                      <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="-0.002" reason="relationchangereason.missionfailed"/>
                    </do_if>
                    <set_value name="$RewardCredits" exact="$RewardCredits * 8 / 10ct / 10 * 10" comment="Taking 20% reward credits for being conspicuous"/>

                    <!-- Abort Approach Handlers-->
                    <do_all exact="$ApproachHandlers.count" counter="$ah">
                      <do_if value="$ApproachHandlers.{$ah}.exists">
                        <cancel_cue cue="$ApproachHandlers.{$ah}"/>
                      </do_if>
                    </do_all>

                    <set_objective cue="$MissionCue" action="objective.wait"/>
                    <do_if value="event.param == 'lost'">
                      <set_value name="$lost"/>
                    </do_if>
                    <set_value name="$FollowingFailed"/>
                  </actions>
                  <cues>

                    <cue name="Ch_3_SSC_Failed_Follow_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"             value="[[30227301],[30227302],[if $lost? then 30227303 else 30227304],[30227305]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch3_Locate_ServerRoom"/>
                      <!--
                      SSC:
                      You lost the ship.
                      Well, I suppose this is the downside of sending untrained personell.
                      I wasn't sure if you were up for the task, so I had another agent follow the ship, too.
                      Luckily we were able to intercept some close range tansmissions that gave away where they were heading.
                      Always have a contingency.
                      -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Patch_Signal_LocateServerRoom" onfail="cancel">
              <conditions>
                <check_value value="$Patch_LocateServerRoom?"/>
              </conditions>
              <actions>
                <reset_cue cue="Setup_Ch3_Relay_Station_Interior"/>
                <signal_cue_instantly cue="Setup_Ch3_RelayStation"/>
              </actions>
              <delay exact="5s"/>
              <actions>
                <signal_cue cue="Ch3_Locate_ServerRoom"/>
              </actions>
            </cue>

            <cue name="Ch3_Locate_ServerRoom">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_value name="$ApproachHandlers"/>

                <cancel_cue cue="Ch3_FollowShip"/>
                <debug_text text="'Relay Station ' + $RelayStation.knownname + ' located.'" chance="$DebugChance"/>

                <signal_cue cue="Setup_Ch3_Relay_Station_Interior"/>

                <!-- Set New Name -->
                <set_value name="$RelayStationName" exact="$RelayStation.knownname"/>
                <set_value name="$AddedStationName" exact="$RelayStationName + '/ ' + {30227,501}"/>
                <set_object_name object="$RelayStation" name="$AddedStationName"/>

                <set_value name="$current_playership" exact="player.entity.ship"/>

                <!-- create temporary Security presence-->
                <get_ship_definition reference="$AntigonePoliceShipDef" size="class.ship_m" faction="faction.antigone" tags="tag.military"/>
                <create_group groupname="$TempAntigonePoliceSquad"/>
                <do_all exact="4" counter="$i">
                  <set_value name="$dock"/>
                  <find_dockingbay name="$dock" object="$RelayStation" walkable="true">
                    <match_dock size="tag.dock_m" free="true" storage="false" />
                  </find_dockingbay>
                  <do_if value="$dock.isoperational">
                    <create_ship name="$AntigonePoliceSquadShip" ref="$AntigonePoliceShipDef" dock="$dock" capturable="false">
                      <owner exact="faction.antigone" overridenpc="true" />
                      <pilot group="argon.pilot"/>
                    </create_ship>
                    <add_to_group groupname="$TempAntigonePoliceSquad" object="$AntigonePoliceSquadShip"/>

                    <create_order id="'DockAndWait'" object="$AntigonePoliceSquadShip" default="true">
                      <param name="destination" value="$RelayStation" comment="stay docked"/>
                    </create_order>
                  </do_if>
                </do_all>

              </actions>
              <delay exact="3s"/>
              <actions>
                <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30227,3004}" object="$ArgonGuardActor" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch_3_SSC_FindServerRoom_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30227310],[30227311]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      We still need you to dock, and do some reconnaissance work.
                      See if you can pinpoint the location of the Server Room, but be inconspicuous about it.
                  -->
                </cue>
                <cue name="Ch_3_Docked" checkinterval="2s">
                  <conditions>
                    <check_value value="player.entity.hascontext.{$RelayStation}"/>
                  </conditions>
                  <delay exact="5s"/>
                  <actions>
                    <cancel_cue cue="Ch3_FollowShip"/>
                  </actions>
                  <cues>
                    <cue name="Ch_3_Player_Left_Ship">
                      <conditions>
                        <event_object_changed_object object="player.entity" newobject="$RelayStation"/>
                      </conditions>
                      <cues>
                        <cue name="Ch_3_Dal_Docked_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="DelayInitial"      value="2s"/>
                          <param name="Lines"             value="[[30227316]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          That is a lot of military ships they keep at the ready here.
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>


                <cue name="Ch3_PlayerFoundServers">
                  <conditions>
                    <event_object_changed_room object="player.entity" room="$ServerRoom_Corridor"/>
                  </conditions>
                  <delay exact="2s"/>
                  <actions>
                    <start_conversation actor="$ArgonGuardActor" conversation="warning" missioncue="$MissionCue"/>
                  </actions>
                  <cues>
                    <cue name="GuardWarning_Conversation_Started">
                      <conditions>
                        <event_conversation_started actor="$ArgonGuardActor" conversation="warning"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$ArgonGuardActor" hidechoices="true" lookat="player.entity">
                          <text line="30227301" comment="Entry only for authorized personnel."/>
                          <text line="30227302" comment="I need you to leave, now."/>
                        </add_npc_line>
                      </actions>
                    </cue>
                    <cue name="GuardWarning_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$ArgonGuardActor" outcome="warning"/>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <signal_cue cue="Ch3_Debrief"/>
                        <remove_mission cue="$MissionCue" type="completed"/>
                        <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.003" reason="relationchangereason.missioncompleted"/>
                        <signal_cue cue="Generic_Responses_Handler"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch3_Debrief">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch_3_Debrief_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$DalBusta, $SecretServiceActor]"/>
                      <param name="CutsceneKey"       value="[$DalCutsceneKey, $SecretServiceCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                              [[30227315]],
                                                              [[30227312],[30227313],[30227314],[30227315],[30227316],[30227317]]
                                                              ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[null, Ch3_Move_On_To_Prep]"/>
                      <!--
                      Dal:
                      Looks like we won't be able to just waltz right in and snoop around.
                      
                      SSC:
                      Unsurprisingly, this station's security is tight.
                      I am confident that we can get you through, though.
                      Give us some time to set things up.
                      We need to move a few of our assets into place, and work on fabricating a security clearance.
                      While we prepare the infiltration, we want you to run some tasks for us.
                      They will help to weaken the Argon Federation’s position without showing our hand.
                      -->
                    </cue>
                    <cue name="Ch3_Move_On_To_Prep">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="$RepairShip.isoperational">
                          <create_order id="'MoveDie'" object="$RepairShip" immediate="true">
                            <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                          </create_order>
                        </do_if>
                        <do_all exact="$TempAntigonePoliceSquad.count" counter="$s">
                          <create_order id="'MoveDie'" object="$TempAntigonePoliceSquad.{$s}" immediate="true">
                            <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                          </create_order>
                        </do_all>
                        <signal_cue cue="Ch4_CovertOperations"/>
                      </actions>
                      <delay exact="3min"/>
                      <actions>
                        <cancel_cue cue="Ch3_LocateHiddenStation"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Generic_Responses_Handler">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>
            <cue name="Generic_Guard_Response_v2" instantiate="true">
              <conditions>
                <event_conversation_started actor="$ArgonGuardActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$ArgonGuardActor" hidechoices="true">
                  <text line="30227302" comment="I need you to leave, now."/>
                </add_npc_line>
              </actions>
            </cue>
            <cue name="Generic_Additional_Guard_Response_v2" instantiate="true">
              <conditions>
                <event_conversation_started actor="$AddititionalGuardActor"/>
              </conditions>
              <actions>
                <add_npc_line speaker="$AddititionalGuardActor" hidechoices="true">
                  <text line="2014" comment="We have nothing to say to you."/>
                </add_npc_line>
              </actions>
            </cue>
          </cues>
        </cue>


        <!-- Chapter 4: Several smaller tasks to undermine the ARG government -->

        <cue name="Ch4_Force">
          <actions>
            <!-- Special setup when you "fast-forward" into a chapter (skipping earlier ones) -->
          </actions>
          <force name="Ch4_CovertOperations">
            <signal_cue_instantly cue="Debug_Setup_Terran_SSC"/>
            <signal_cue_instantly cue="Debug_Setup_HQ" check="false"/>
            <signal_cue cue="SecretServiceActor_Dialog_Option_Story"/>
            <signal_cue cue="Setup_Remember_Diplomacy_Plot"/>
            <signal_cue cue="Setup_Ch3_RelayStation" check="false"/>
            <signal_cue cue="Setup_Ch3_Relay_Station_Interior"/>
            <signal_cue cue="Ch4_CovertOperations"/>
          </force>
        </cue>

        <cue name="Ch4_CovertOperations">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="2s"/>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <set_value name="$StationBuilt" exact="false"/>
            <set_value name="$ShipDelivered" exact="false"/>

            <create_mission_thread cue="$MissionCue" name="{30227,4001}" description="{30227,4002}" rewardtext="{30227,906}"
                                   type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname" threadtype="parallel"/>

            <find_cluster name="$ArgonPrime" macro="macro.cluster_14_macro" required="true" comment="Argon Prime"/>
            <signal_cue cue="Setup_Character_ScaleplateLieutenant"/>
            <signal_cue cue="Ch_4_Build_Competetive_Station"/>
            <signal_cue cue="Ch_4_Deliver_SCAShip"/>
          </actions>
          <delay exact="2s"/>
          <actions>
            <signal_cue cue="Ch_4_Briefing_Dialogue"/>
          </actions>
          <cues>
            <cue name="Ch_4_Briefing_Dialogue">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch4_Story_Reminder">
                  <cues>
                    <cue name="Ch4_Story_Reminder_Ref" ref="Story_Reminder">
                      <param name="Actor"       value="$SecretServiceActor"/>
                      <param name="CutsceneKey" value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"       value="[[30227403]]"/>
                      <param name="CancelCue"   value="Ch_4_Covert_Ops_Done"/>
                      <param name="Delay"       value="50min"/>
                      <!--
                      Our preparations are going as planned, but you need to keep working on destabilising the Argon Federation, as well.
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch_4_SSC_Briefing_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$SecretServiceActor"/>
                  <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                  <param name="Lines"             value="[[30227318],[30227319],[30227320],[30227321],[30227322],[30227323]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                      We have been running a program to fund and arm organisations opposing the Federation, and we intend for them to play a part in the next stage of our operation.
                      You will supply them with whatever they need to aid our undertaking.
                      In addition, we also want to undermine the Federation’s economic position.
                      Set up a station that undercuts their most profitable exported wares, and the ensuing financial losses will help bleed them.
                      Death by a thousand cuts.
                      We are sending Dal the detailed information as we speak.
                  -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch_4_Build_CompetetiveStation_Patch" onfail="cancel">
              <conditions>
                <check_value value="$Ch_4_Build_Competetive_Station_Patching?"/>
              </conditions>
              <actions>
                <reset_cue cue="Ch_4_Build_Competetive_Station"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="Ch_4_Build_Competetive_Station"/>
              </actions>
            </cue>

            <cue name="Ch_4_Build_Competetive_Station" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <patch sinceversion="2">
                <do_if value="Ch_4_Build_Station_Build_Station_Complete.state == cuestate.complete and Ch_4_StationDone.state == cuestate.waiting">
                  <set_value name="$Ch_4_Build_Competetive_Station_Patching"/>
                </do_if>
              </patch>
              <cues>

                <cue name="Ch_4_BuildStation_Setup" version="2">
                  <delay exact="4s"/>
                  <actions>

                    <do_if value="faction.argon.relationto.{player.entity} gt faction.argon.relation.kill.min">
                      <find_sector name="$ArgonSector" space="player.galaxy" owner="faction.argon" sortbygatedistanceto="$ArgonPrime"/>
                      <debug_text text="'Argon Federation not hostile to player, sector: ' + $ArgonSector.knownname" chance="$DebugChance"/>
                    </do_if>
                    <do_else>
                      <!-- Find all neutral factions -->
                      <get_factions_by_relation result="$NeutralFactions" relation="neutral" faction="faction.player"/>
                      <remove_from_list name="$NeutralFactions" exact="faction.ownerless"/>

                      <!--Note that min distance has to be 0, or else the first sector found can be unconnected to the current cluster-->
                      <find_sector name="$PotentialSectors" space="player.galaxy" owner="$NeutralFactions" sortbygatedistanceto="$ArgonPrime" multiple="true">
                        <match_gate_distance object="$ArgonPrime" min="0"/>
                      </find_sector>

                      <do_all exact="$PotentialSectors.count" counter="$s">
                        <do_if value="$PotentialSectors.{$s}.owner.relationto.{player.entity} gt $PotentialSectors.{$s}.owner.relation.kill.min">
                          <set_value name="$ArgonSector" exact="$PotentialSectors.{$s}"/>
                          <debug_text text="'Argon Federation is hostile to player, new sector: ' + $ArgonSector.knownname" chance="$DebugChance"/>
                          <break/>
                        </do_if>
                      </do_all>
                    </do_else>

                    <set_value name="$Page" exact="30210"/>
                    <set_value name="$TextOffset" exact="105000"/>
                    <set_value name="this.$TextTable" exact="table[]"/>

                    <set_value name="$Difficulty" exact="level.medium"/>
                    <set_value name="$MissionLevel" exact="1"/>

                    <find_gate name="$Gate" space="$ArgonSector"/>
                    <do_if value="$Gate.exists">
                      <set_value name="$OffsetObject" exact="$Gate"/>
                    </do_if>
                    <do_else>
                      <set_value name="$OffsetObject" exact="$ArgonSector"/>
                    </do_else>

                    <get_safe_pos result="$TargetOffset" sector="$ArgonSector" object="$OffsetObject" min="40km" max="60km" radius="30km" includeplotbox="true" allowyaxis="false"/>
                    <set_value name="$PlotOffset" exact="position.[$TargetOffset.x, 0m, $TargetOffset.z]" comment="Engine limitation, build station near ecliptic (y=0)"/>

                    <set_value name="$PlotRange"     exact="10km"/>
                    <set_value name="$PlotSize"      exact="vector.[5km,5km,5km]"/>
                    <set_value name="$StationCurrentStep" exact="1"/>

                    <!-- check what ware is most common in Argon sector -->
                    <set_value name="$WareList" exact="[]"/>
                    <append_to_list name="$WareList" exact="ware.hullparts"/>
                    <append_to_list name="$WareList" exact="ware.smartchips"/>
                    <append_to_list name="$WareList" exact="ware.advancedelectronics"/>

                    <find_sell_offer tradepartner="player.headquarters" wares="ware.hullparts" space="$ArgonSector" result="$HullSelloffers" multiple="true" usereservations="false" />
                    <find_sell_offer tradepartner="player.headquarters" wares="ware.smartchips" space="$ArgonSector" result="$ChipsSelloffers" multiple="true" usereservations="false"/>
                    <find_sell_offer tradepartner="player.headquarters" wares="ware.advancedelectronics" space="$ArgonSector" result="$AdvElSelloffers" multiple="true" usereservations="false"/>

                    <debug_text text="'Hullpart offers: ' + $HullSelloffers.count + ', Chip Offers: ' + $ChipsSelloffers.count + ', Adv. Electronics Offers: ' + $AdvElSelloffers.count"/>

                    <do_if value="($HullSelloffers.count + $ChipsSelloffers.count + $AdvElSelloffers.count) ge 1">
                      <do_if value="$HullSelloffers.count ge $ChipsSelloffers.count and $HullSelloffers.count ge $AdvElSelloffers.count">

                        <debug_text text="'Most Sold: Hullparts - Setting Macros Accordingly'" chance="$DebugChance"/>
                        <set_value name="$CompetitionWare" exact="ware.hullparts"/>
                        <set_value name="$StationProduction" exact="[  [ 2, ware.hullparts ], [ 1, ware.energycells ] ]"/>
                      </do_if>
                      <do_elseif value="($ChipsSelloffers.count ge $HullSelloffers.count) and ($ChipsSelloffers.count ge $AdvElSelloffers.count)">

                        <set_value name="$StationProduction" exact="[  [ 2, ware.smartchips ],  [ 1, ware.siliconwafers ] ]"/>
                        <debug_text text="'Most Sold: SmartChips - Setting Macros Accordingly'" chance="$DebugChance"/>
                        <set_value name="$CompetitionWare" exact="ware.smartchips"/>
                      </do_elseif>
                      <do_elseif value="($AdvElSelloffers.count ge $HullSelloffers.count) and ($AdvElSelloffers.count ge $ChipsSelloffers.count)">

                        <set_value name="$StationProduction" exact="[  [ 2, ware.advancedelectronics ], [ 1, ware.microchips ]  ]"/>
                        <debug_text text="'Most Sold: Advanced Ellectronics - Setting Macros Accordingly'" chance="$DebugChance"/>
                        <set_value name="$CompetitionWare" exact="ware.advancedelectronics"/>
                      </do_elseif>
                    </do_if>
                    <do_else>

                      <debug_text text="'None Were Sold, Falling back to Hullparts'" chance="$DebugChance"/>
                      <set_value name="$CompetitionWare" exact="ware.hullparts"/>
                      <set_value name="$StationProduction" exact="[  [ 2, ware.hullparts ], [ 1, ware.energycells ]  ]"/>
                    </do_else>


                    <!-- Ware offered at most stations has been found - Continuing with set up -->
                    <set_value name="$StationSpecs" exact="table[
                                       $containedmacros = [ [ 1, macro.storage_arg_l_container_01_macro ] ],       
                                       
                                      $products = $StationProduction,
                               
                                      $containedclasses = [
                                                          [   1, class.dockarea,        {30120,103}, {30120,104}],
                                                          [   1, class.pier,            {30120,111}, {30120,112}],]
                                                          ]"/>

                    <run_actions ref="md.GM_BuildStation.ConstructRequirementsText" result="$RequirementsText">
                      <param name="PlotSector"              value="$ArgonSector" />
                      <param name="PlotSize"                value="$PlotSize" />
                      <param name="StationSpecs"            value="$StationSpecs" />
                      <param name="DestinationDBString"     value="$ArgonSector.knownname" />
                    </run_actions>

                    <set_value name="this.$TextTable.$description" exact="{30227,4004}"/>
                    <set_value name="this.$TextTable.$description" exact="this.$TextTable.$description + '\n\n' + $RequirementsText + '\n\n' + {1026,4217}"/>

                    <set_value name="$MissionCue_Ch4_BuildStation" exact="this"/>
                    <create_mission cue="$MissionCue_Ch4_BuildStation" name="{30227,4003}" description="this.$TextTable.$description" rewardtext="{30227,906}" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname" missionthread="$MissionCue">
                      <briefing>
                        <objective step="1" action="objective.buy" text="{30227,4005}"/>
                        <objective step="2" action="objective.build_station"  text="{30227,4006}"/>
                        <objective step="3" action="objective.custom" customaction="{30227,4007}"/>
                      </briefing>
                    </create_mission>

                    <set_value name="$ResultTable" exact="table[]"/>

                    <!-- checking to see if the player is already selling that ware in that sector -->
                    <find_station_by_true_owner name="$PlayerStations" faction="faction.player" space="$ArgonSector" multiple="true"/>
                    <do_if value="$PlayerStations.count">
                      <do_all exact="$PlayerStations.count" counter="$s">
                        <set_value name="$StationProducts" exact="$PlayerStations.{$s}.products.list"/>
                        <do_if value="$StationProducts.indexof.{$CompetitionWare}">
                          <set_value name="$PlayerStation" exact="$PlayerStations.{$s}"/>
                          <signal_cue_instantly cue="Ch_4_StationDone" param="'Existing'"/>
                          <break/>
                        </do_if>
                      </do_all>
                      <do_if value="not $PlayerStation?">
                        <signal_cue cue="Ch_4_Build_Station_Claim_Plot"/>
                      </do_if>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch_4_Build_Station_Claim_Plot"/>
                    </do_else>

                  </actions>
                  <patch sinceversion="2">
                    <do_if value="(Ch_4_Build_Station_Claim_Plot.state == cuestate.waiting) and (Ch_4_Build_Station_Claim_Plot_Done.state == cuestate.waiting) and (Ch_4_StationDone.state == cuestate.waiting)">
                      <reset_cue cue="Ch_4_BuildStation_Setup"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch_4_Build_Station_Station_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_station name="$DebugStation" macro="macro.station_gen_factory_base_01_macro" owner="faction.player" sector="$ArgonSector" state="componentstate.operational" constructionplan="'arg_tradestation'">
                      <safepos x="$PlotOffset.x" y="$PlotOffset.y" z="$PlotOffset.z"/>
                    </create_station>
                  </actions>
                </cue>

                <cue name="Ch_4_Build_Station_Claim_Plot">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch_4_Build_Station_Claim_Plot_Ref" ref="md.RML_ClaimPlot.ClaimPlot">
                      <!-- mandatory parameters -->
                      <param name="EndSignalCue"      value="Ch_4_Build_Station_Claim_Plot_Done" comment="RML returns $StationBuilt in this cue"/>
                      <param name="MissionCue"        value="$MissionCue_Ch4_BuildStation"/>
                      <param name="StartStep"         value="$StationCurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="$DebugChance"/>
                      <!-- mission-specific parameters -->
                      <param name="Faction"           value="$Faction"/>
                      <param name="PlotSector"        value="$ArgonSector"/>
                      <param name="PlotOffset"        value="$PlotOffset"/>
                      <param name="PlotRange"         value="$PlotRange"/>
                      <param name="PlotSize"          value="$PlotSize"/>
                      <param name="ObjectiveText"     value="{30227,4005}" comment="Plot at Specified Location"/>
                    </cue>

                    <cue name="Ch_4_Build_Station_Claim_Plot_KeepAlive">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch_4_Build_Station_Claim_Plot_Done">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$StationCurrentStep" operation="add"/>
                    <set_value name="$CutsceneObject" exact="Ch_4_Build_Station_Claim_Plot_Done.$StationBuilt" />
                    <set_value name="$RML_Result_Table" exact="table[]"/>
                    <reset_cue cue="Ch_4_Build_Station_Claim_Plot" comment="can be signalled again if the station becomes invalid"/>
                  </actions>
                  <cues>

                    <cue name="Ch_4_Build_Station_Build_Station_Ref" ref="md.RML_BuildStation.BuildStation">
                      <!-- always pass these -->
                      <param name="EndSignalCue"      value="Ch_4_Build_Station_Build_Station_Complete"/>
                      <param name="MissionCue"        value="$MissionCue_Ch4_BuildStation"/>
                      <param name="StartStep"         value="$StationCurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="$DebugChance"/>
                      <!-- mission-related parameters -->
                      <param name="Station"           value="Ch_4_Build_Station_Claim_Plot_Done.$StationBuilt"/>
                      <param name="StationSpecs"      value="$StationSpecs"/>
                      <param name="Faction"           value="faction.player"/>
                      <param name="PlotSector"        value="$ArgonSector"/>
                      <param name="PlotOffset"        value="$PlotOffset"/>
                      <param name="PlotRange"         value="$PlotRange"/>
                      <param name="PlotSize"          value="$PlotSize"/>
                      <param name="ObjectiveText"     value="{30227,4006}"/>
                      <!--param name="ResultTable"       value="$RML_Result_Table"/-->
                    </cue>

                    <cue name="Ch_4_Build_Station_Build_Station_Complete">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!--Station plot was destroyed, or moved outside the specified position - restart the claim plot objective-->
                        <do_if value="(this.$EndFeedbackValue lt 1)">
                          <debug_text text="'Restart claimplot objective'"/>
                          <set_value name="$StationCurrentStep" operation="subtract"/>
                          <set_value name="Ch_4_Build_Station_Claim_Plot_Done.$StationBuilt" exact="null"/>
                          <signal_cue cue="Ch_4_Build_Station_Claim_Plot"/>
                          <reset_cue cue="Ch_4_Build_Station_Claim_Plot_Done"/>
                        </do_if>
                        <!-- Success case -->
                        <do_else>
                          <debug_text text="'Completed station as specified'"/>
                          <set_value name="$PlayerStation" exact="Ch_4_Build_Station_Build_Station_Complete.$StationBuilt" comment="return-value from rml_buildstation"/>
                          <signal_cue cue="Ch_4_StationDone"/>
                        </do_else>
                      </actions>
                    </cue>

                  </cues>
                </cue>
                <cue name="Ch_4_StationDone">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_list name="$Dal_Lines_Ch4_StationDone"/>

                    <append_to_list name="$Dal_Lines_Ch4_StationDone" exact="[30227409, 0]"/>

                    <!-- Determie Sell Price -->
                    <set_value name="$CompetitionPrice" exact="((($CompetitionWare.minprice)f * 1.15f)/100)Cr"/>

                    <do_if value="event.param == 'Existing'">
                      <set_value name="$StationCurrentStep" exact="2"/>
                      <append_to_list name="$Dal_Lines_Ch4_StationDone" exact="[30227410, 0]"/>
                    </do_if>
                    <do_else>
                      <append_to_list name="$Dal_Lines_Ch4_StationDone" exact="[30227411, 0]"/>
                    </do_else>

                    <debug_text text="'$PlayerStation: ' + $PlayerStation + ' $CompetitionWare: ' + $CompetitionWare"/>
                    <find_sell_offer result="$PlayerStationOffer" seller="$PlayerStation" wares="$CompetitionWare" excludeempty="true" />
                    <do_if value="$PlayerStationOffer.exists">
                      <debug_text text="'1 ' + $CompetitionWare + ' Minprice: ' +  $CompetitionPrice + ' Station SellPrice ' + $PlayerStationOffer.unitprice"/>

                      <do_if value="$PlayerStationOffer.unitprice le $CompetitionPrice">
                        <append_to_list name="$Dal_Lines_Ch4_StationDone" exact="[30227412, 0]"/>
                        <append_to_list name="$Dal_Lines_Ch4_StationDone" exact="[30227417, 0]"/>

                        <remove_mission cue="$MissionCue_Ch4_BuildStation" type="completed"/>
                        <set_value name="$StationBuilt" exact="true"/>
                      </do_if>
                      <do_else>
                        <append_to_list name="$Dal_Lines_Ch4_StationDone" exact="[30227413, 0]"/>
                      </do_else>
                    </do_if>
                    <do_else>
                      <append_to_list name="$Dal_Lines_Ch4_StationDone" exact="[30227413, 0]"/>
                    </do_else>
                  </actions>
                  <cues>
                    <cue name="Ch_4_Dal_FinishedStation_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="$Dal_Lines_Ch4_StationDone"/>
                      <param name="MissionCue"        value="$MissionCue_Ch4_BuildStation"/>
                      <param name="EndSignalCue"      value="if $StationBuilt == true then Ch_4_Covert_Task_Done else Ch_4_Finished_Dal_Dialogue"/>
                      <!--
                      Dal:
                      Good news!
                      Being the entrepeuneur that you are, you already own a station producing these goods in Argon space.
                      Construction of your station in Argon space just finished.
                      Plus, you've been undercutting Argon prices all along. Not bad!
                      Now you just have to sell your wares for cheaper than the competition.
                      The market analysis report we received from the Terran Operatives turned out to be accurate.
                      -->
                    </cue>

                    <cue name="Ch_4_Finished_Dal_Dialogue">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>

                        <set_value name="$StationCurrentStep" operation="add"/>

                        <substitute_text text="$ObjectiveText" source="{30227,4008}" comment="Set price: $WARENAME$ - $SELLPRICE$">
                          <replace string="'$WARENAME$'" with="$CompetitionWare.name" />
                          <replace string="'$SELLPRICE$'" with="($CompetitionPrice).formatted.default" />
                        </substitute_text>

                        <set_objective cue="$MissionCue_Ch4_BuildStation" step="$StationCurrentStep" action="objective.custom" customaction="$ObjectiveText" object="$PlayerStation" updatebriefing="true"/>
                      </actions>
                      <cues>

                        <cue name="Ch_4_Check_for_SalesPrice" checkinterval="3s">
                          <conditions>
                            <check_value value="$PlayerStation.sellprices.{$CompetitionWare} le $CompetitionPrice"/>
                            <check_value value="Ch_4_Salesprice_Low.state == cuestate.waiting"/>
                          </conditions>
                          <actions>
                            <do_if value="not $PlayerStation.cargo.{$CompetitionWare}.count">
                              <!-- The ware is not currently being produced so we need to tell the player to wait until it is -->
                              <set_value name="$StationCurrentStep" operation="add"/>

                              <substitute_text text="$ObjectiveText" source="{30227,4020}" comment="Wait until production is finished: $WARENAME$">
                                <replace string="'$WARENAME$'" with="$CompetitionWare.name" />
                              </substitute_text>

                              <set_objective cue="$MissionCue_Ch4_BuildStation" step="$StationCurrentStep" action="objective.custom" customaction="$ObjectiveText" object="$PlayerStation" updatebriefing="true"/>
                            </do_if>
                          </actions>
                          <cues>

                            <cue name="Ch4_Check_for_WareInStorage" checkinterval="3s">
                              <conditions>
                                <check_value value="$PlayerStation.products.{$CompetitionWare}.exists"/>
                                <check_value value="$PlayerStation.cargo.{$CompetitionWare}.count"/>
                                <check_value value="Ch_4_Salesprice_Low.state == cuestate.waiting"/>
                              </conditions>
                              <actions>
                                <!-- Wait for the station to sell a ware -->
                                <set_value name="$StationCurrentStep" operation="add"/>

                                <substitute_text text="$ObjectiveText" source="{30227,4019}" comment="Wait until production is finished: $WARENAME$">
                                  <replace string="'$WARENAME$'" with="$CompetitionWare.name" />
                                </substitute_text>

                                <set_objective cue="$MissionCue_Ch4_BuildStation" step="$StationCurrentStep" action="objective.custom" customaction="$ObjectiveText" object="$PlayerStation" updatebriefing="true"/>
                              </actions>
                            </cue>
                            
                          </cues>
                        </cue>

                        <cue name="Ch_4_Check_for_Sales" checkinterval="5s" instantiate="true">
                          <conditions>
                            <check_value value="Ch_4_Salesprice_Low.state == cuestate.waiting"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <find_sell_offer seller="$PlayerStation" wares="$CompetitionWare" result="$PlayerStationOffer"/>
                            <do_if value="$PlayerStationOffer.exists">
                              <debug_text text="'2 ' + $CompetitionWare  + ' Minprice: ' +  $CompetitionPrice + ' Station SellPrice ' + $PlayerStationOffer.unitprice" chance="$DebugChance"/>
                              <do_if value="$PlayerStationOffer.unitprice le $CompetitionPrice">
                                <signal_cue cue="Ch_4_Salesprice_Low"/>
                              </do_if>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Ch_4_Salesprice_Low">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="2s"/>
                          <actions>
                            <do_if value="$MissionCue_Ch4_BuildStation.hasguidance">
                              <set_value name="$MissionThreadCue" exact="$MissionCue_Ch4_DeliverShip"/>
                            </do_if>
                            <remove_mission cue="$MissionCue_Ch4_BuildStation" type="completed"/>
                            <set_value name="$StationBuilt" exact="true"/>
                          </actions>
                          <cues>

                            <cue name="Ch_4_Dal_StationTrading_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="DelayInitial"      value="60s"/>
                              <param name="Lines"             value="[[30227414],[30227415],[30227416],[30227417]]"/>
                              <param name="IsInMission"       value="false"/>
                              <param name="EndSignalCue"      value="Ch_4_Covert_Task_Done"/>
                              <!--
                              Dal:
                              The market analysis report we received from the Terran Operatives turned out to be accurate.
                              We are already registering an increase in sales, and the Federation will be forced to adjust their prices downward if they want to keep being competetive.
                              Long live the free market, eh?
                              Well done!
                              -->
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch_4_Deliver_SCAShip">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch_4_Deliver_SCAShip_Setup">
                  <delay exact="4.3s"/>
                  <actions>
                    <do_if value="not $Delivering?">
                      <debug_text text="'SCA Ship delivery set up'"/>
                      <!-- ~ 2 mil credits-->
                      <set_value name="$Fleet" exact="[
                          table[
                            $macro = macro.ship_arg_m_bomber_01_b_macro,
                            $amount = 1,
                            $equipment = [macro.engine_arg_m_combat_01_mk2_macro, macro.shield_arg_m_standard_01_mk2_macro, macro.thruster_gen_m_combat_01_mk2_macro, macro.turret_arg_m_gatling_01_mk1_macro, macro.weapon_gen_m_laser_01_mk2_macro],
                            $ammo = table[{macro.ship_gen_xs_lasertower_01_a_macro} = 20, {macro.weapon_gen_mine_03_macro} = 10],
                            $wares = table[{ware.missilecomponents} = 100, {ware.weaponcomponents} = 20, {ware.dronecomponents} = 10]
                          ],
                         ]"/>

                      <!-- Set $TextTable variables for GM briefing generation. -->
                      <set_value name="this.$TextTable" exact="table[]"/>

                      <set_value name="this.$TextTable.$objective"           exact="{30227,4012}"/>
                      <set_value name="this.$TextTable.$objective_transfer"  exact="{30227,4012}"/>
                      <set_value name="this.$TextTable.$progressbar"         exact="{30227,4013}"/>
                      <set_value name="this.$TextTable.$accept_transfer"     exact="{30004,5312}"/>
                      <set_value name="this.$TextTable.$reject_transfer"     exact="{30227,4015}"/>

                      <!-- Set $ShipCount variable so that GenerateTextTable doesn't complain. -->
                      <do_all exact="$Fleet.count" counter="$i">
                        <set_value name="$ShipCount" exact="$Fleet.{$i}.$amount" operation="add"/>
                      </do_all>

                      <run_actions ref="md.GM_GetExactFleet.ConstructFleetRequirementsText" result="$FleetText">
                        <param name="Fleet" value="$Fleet"/>
                      </run_actions>

                      <set_value name="this.$TextTable.$description" exact="{30227,4010} + '\n' + $FleetText + '\n' + {30227,4011}"/>
                      <!-- Determine a delivery location closish to the Scaleplate Station -->

                      <find_station_by_true_owner name="$SCAStation" faction="faction.scaleplate" checkoperational="true" sortbygatedistanceto="$ArgonPrime" space="player.galaxy"/>

                      <do_if value="$SCAStation">
                        <set_value name="$DeliveryTargetSector" exact="$SCAStation.sector"/>

                        <create_position name="$SCAStationPos" object="$SCAStation" space="$DeliveryTargetSector"/>
                        <set_value name="$DeliveryTargetOffset" exact="position.[$SCAStationPos.x, $SCAStationPos.y, $SCAStationPos.z]" comment="Engine limitation, build station near ecliptic (y=0)"/>

                        <set_value name="$DeliveryTargetRadius" exact="15km"/>
                        <set_value name="$FleetDeliveryClient" exact="$ScalePlateActor"/>
                        <set_value name="$FleetDeliveryFaction" exact="faction.scaleplate"/>

                        <set_value name="$MissionCue_Ch4_DeliverShip" exact="this"/>
                        <create_mission cue="$MissionCue_Ch4_DeliverShip" name="{30227,4009}" rewardtext="{30227,906}" description="this.$TextTable.$description" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname" missionthread="$MissionCue">
                          <briefing>
                            <objective step="1" action="objective.deliver" text="{30227,4012}"/>
                          </briefing>
                        </create_mission>

                        <set_value name="$ShipCurrentStep" exact="1"/>
                        <signal_cue cue="Ch_4_Deliver_Fleet_Mission"/>
                      </do_if>
                      <do_else>
                        <debug_text text="'No active Scaleplate Station in the universe.'"/>
                        <signal_cue cue="Ch4_SCAStation_DelayedReset"/>
                      </do_else>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch4_SCAStation_DelayedReset" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="5min"/>
                  <actions>
                    <do_if value="$StationBuilt" comment="the other mission has completed, force spawn a station at this point">
                      <signal_cue_instantly cue="Ch_4_SpawnScaleplate_Station"/>
                    </do_if>
                    <reset_cue cue="Ch_4_Deliver_SCAShip_Setup"/>
                  </actions>
                </cue>

                <cue name="Ch_4_SpawnScaleplate_Station">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_sector name="$FallbackScalePlateSector" macro="macro.cluster_01_sector002_macro"/>
                    <create_station name="$Invincible_ScalePlateStation" macro="macro.station_gen_piratebase_base_01_macro" owner="faction.scaleplate" sector="$FallbackScalePlateSector" state="componentstate.operational" constructionplan="'gen_piratedock'">
                      <safepos x="250km" z="-200km" space="$FallbackScalePlateSector"/>
                    </create_station>
                    <signal_objects object="player.galaxy" param="'init station'" param2="$Invincible_ScalePlateStation" param3="false"/>
                  </actions>
                </cue>

                <cue name="Ch_4_Deliver_Fleet_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch4_SCAStation_DelayedReset"/>
                    <set_value name="$Delivering"/>
                  </actions>
                  <cues>

                    <cue name="Ch_4_SCA_Station_Destroyed" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_destroyed  object="$SCAStation"/>
                          <event_cue_signalled/>
                        </check_any>
                        <check_value value="$MissionCue_Ch4_DeliverShip.hasmission" comment="We only want this cue to fire if this mission was not completed yet"/>
                      </conditions>
                      <actions>
                        <debug_text text="$SCAStation.knownname + ' has been destroyed. Resetting'"/>
                      </actions>
                      <cues>

                        <cue name="Ch4_Reset_SCAstation" instantiate="true" checkinterval="4min" onfail="cancel">
                          <conditions>
                            <check_value value="not $SCAStation.isoperational"/>
                          </conditions>
                          <actions>
                            <find_station_by_true_owner name="$SCAStation" faction="faction.scaleplate" checkoperational="true" sortbygatedistanceto="$ArgonPrime" space="player.galaxy"/>
                            <do_if value="$SCAStation.isoperational">
                              <reset_cue cue="Ch_4_Deliver_SCAShip_Setup"/>
                              <set_value name="$ResetCue" exact="Ch_4_Deliver_SCAShip_Setup"/>
                              <remove_value name="$Delivering"/>
                              <signal_cue cue="Ch4_SCAStation_Found_Dialogue"/>
                              <reset_cue cue="Ch_4_Deliver_Fleet_Mission"/>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Ch4_SCAStation_Found_Dialogue" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>

                            <cue name="Ch4_Dal_SCAStation_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="DelayInitial"      value="1s"/>
                              <param name="Lines"             value="[[30227408],[30227139]]"/>
                              <param name="MissionCue"        value="$MissionCue_Ch4_BuildStation"/>
                              <param name="EndSignalCue"      value="$ResetCue"/>
                              <!--
                                The station we were supposed to supply has been destroyed. Sending you the updated info.
                                The operation is still on, I'm sending the updated information.
                              -->
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch_4_Deliver_Fleet_Ref" ref="md.RML_Deliver_Fleet.DeliverFleet">
                      <param name="EndSignalCue"            value="Ch_4_Deliver_Fleet_Mission_Completed"/>
                      <param name="MissionCue"              value="$MissionCue_Ch4_DeliverShip"/>
                      <param name="StartStep"               value="$ShipCurrentStep"                comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"          value="true"                            comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"             value="$DebugChance"/>

                      <param name="Text_MissionName"        value="{30227,4009}"/>
                      <param name="Text_Objective_Get"      value="Ch_4_Deliver_SCAShip_Setup.$TextTable.$objective"           comment="Objective text to get ships"/>
                      <param name="Text_Objective_Transfer" value="Ch_4_Deliver_SCAShip_Setup.$TextTable.$objective_transfer"  comment="Objective text to transfer ownership"/>
                      <param name="Text_AcceptTransfer"     value="Ch_4_Deliver_SCAShip_Setup.$TextTable.$accept_transfer"     comment="Player choice text to initiate transfer"/>
                      <param name="Text_RejectTransfer"     value="Ch_4_Deliver_SCAShip_Setup.$TextTable.$reject_transfer"     comment="Player choice text to reject transfer"/>
                      <param name="Text_ProgressBar"        value="Ch_4_Deliver_SCAShip_Setup.$TextTable.$progressbar"         comment="Progress bar text for multiple ships"/>
                      <param name="Fleet"                   value="$Fleet"                          comment="The specific fleet we are looking for"/>
                      <param name="Transfer"                value="true"                            comment="Mission ends with a transfer of ownership to $Faction. Otherwise ends when ships are in position."/>
                      <param name="Faction"                 value="$FleetDeliveryFaction"           comment="The faction to which it needs to be delivered. Required if $Transfer is true"/>
                      <param name="Client"                  value="$FleetDeliveryClient"            comment="client who wants the fleet. Required if $Transfer is true"/>
                      <param name="TargetSector"            value="$DeliveryTargetSector"                   comment="Sector to which to deliver the fleet"/>
                      <param name="TargetOffset"            value="$DeliveryTargetOffset"                   comment="Location to which to deliver the fleet"/>
                      <param name="TargetRadius"            value="$DeliveryTargetRadius"                   comment="Radius around location in which we need to put the fleet"/>
                      <param name="CriteriaResultCue"       value="null"                            comment="Cue to signal with a table of ships with the result of the most recent processing of 'CheckMissionStatus'"/>
                      <param name="AdditionCheckCue"        value="null"                            comment="Cue to signal instantly to run additional checks on the object. event.param = [namespace, $ship]. Result saved to namespace.$CheckCueResult"/>
                      <param name="ReturnFleetShips"        value="true"/>
                      <param name="VoiceTable"              value="table[$CustomNotification = 30227401]"/>
                      <param name="GenerateLoadout"         value="true" comment="generate loadout from .$equipment-table (to get a preset loadout in the UI)"/>
                    </cue>

                    <cue name="Ch_4_Deliver_Fleet_Mission_Completed">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="this.$EndFeedbackValue != 1">
                          <debug_text text="'Fleet transfer declined. Resetting mission.'" chance="$DebugChance"/>
                          <reset_cue cue="Ch_4_Deliver_Fleet_Ref"/>
                          <reset_cue cue="Ch_4_Deliver_Fleet_Mission_Completed"/>
                        </do_if>
                        <do_else>
                          <set_value name="$DeliveryShip" exact="Ch_4_Deliver_Fleet_Mission_Completed.$FleetShips.{1}"/>
                          <do_if value="$MissionCue_Ch4_DeliverShip.hasguidance">
                            <set_value name="$MissionThreadCue" exact="$MissionCue_Ch4_BuildStation"/>
                          </do_if>
                          <remove_mission cue="$MissionCue_Ch4_DeliverShip" type="completed"/>
                          <set_value name="$ShipDelivered" exact="true"/>
                          <signal_cue cue="Ch_4_SCA_Dialogue_Trigger"/>
                          <create_order id="'DockAndWait'" object="$DeliveryShip" immediate="true">
                            <param name="destination" value="$SCAStation"/>
                          </create_order>
                          <signal_cue cue="Ch_4_Delayed_DockingRelease"/>
                        </do_else>
                      </actions>
                    </cue>
                    <cue name="Ch_4_Delayed_DockingRelease">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="1min"/>
                      <actions>
                        <cancel_all_orders object="$DeliveryShip"/>
                      </actions>
                    </cue>


                    <cue name="Ch_4_SCA_Dialogue_Trigger">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch_4_Scaleplate_DeliveryDone_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$ScalePlateActor, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$ScalePlateActorCutsceneKey, $DalCutsceneKey]"/>
                          <param name="Lines"             value="[
                                                                  [[30227402],[30227403],[30227404],[30227405],[30227406],[30227407],[30227408]],
                                                                  [[30227401, 2s],[30227402],[30227403],[30227404],[30227405],[30227406],[30227407]]
                                                                  ]"/>
                          <param name="IsInMission"       value="false"/>
                          <param name="EndSignalCue"      value="[null, Ch_4_Covert_Task_Done]"/>
                          <!--
                          SCA Lieutenant 
                          Hey, wait! I thought I recognised you!
                          You were involved in the Hatvikah messs.
                          I see you are still an errand boy, only now you seem to have chosen a more powerful massster.
                          You should thank me for untethering you from that fool, Busta! 
                          He always thought he knew more than he actually did.
                          Anyway, these suppliesss will go a long way in sustaining our raids in Argon space.
                          Many thanksss.
                          
                          Dal:
                          I can’t believe it. 
                          No, actually, scratch that.
                          Supplying the Scale Plate Pact with weapons and ships makes perfect sense, if you want to destabilise the Federation.
                          I’m just having a hard time adjusting to the fact that we are in league with these people.
                          I know that you need to leave notions of morality at the door if you want to play on this level, but still, this scumbag tried to have me killed!
                          Hard to get over that, you know? 
                          Well, at least it seems like the Scaleplate Pact still thinks I'm dead.
                          -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch_4_Covert_Task_Done" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch_4_Covert_Task_Reminder" onfail="cancel">
                  <conditions>
                    <check_value value="(($ShipDelivered == true) and ($StationBuilt == false)) or (($ShipDelivered == false) and ($StationBuilt == true))"/>
                  </conditions>
                  <cues>

                    <cue name="Ch_4_Dal_Task_Reminder_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30227418]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch_4_ActivateSecondMission"/>
                      <!--
                      Dal:
                      That's one we can cross off. Now, let's see about the other one.
                      -->
                    </cue>

                    <cue name="Ch_4_ActivateSecondMission">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="$MissionThreadCue?">
                          <activate_mission cue="$MissionThreadCue"/>
                          <remove_value name="$MissionThreadCue"/>
                        </do_if>
                      </actions>
                    </cue>

                  </cues>
                </cue>
                <cue name="Ch_4_Covert_Ops_Done" onfail="cancel">
                  <conditions>
                    <check_value value="($ShipDelivered == true) and ($StationBuilt == true)"/>
                  </conditions>
                  <cues>

                    <cue name="Ch_4_BothDone_SecretServiceActor_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$SecretServiceActor"/>
                      <param name="CutsceneKey"       value="$SecretServiceCutsceneKey"/>
                      <param name="DelayInitial"      value="20s"/>
                      <param name="Lines"             value="[[30227401],[30227402]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch_4_SecretServiceActor_Dialogue_Done_v2"/>
                      <!--
                      Our intelligence officers have concluded their preparations.
                      Agent, I request you join up for the final briefing.
                      -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>


            <cue name="Ch_4_SecretServiceActor_Dialogue_Done_v2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="1s"/>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.003" reason="relationchangereason.missioncompleted"/>

                <signal_cue cue="Ch5_DataHeist"/>
                <!--</actions>
                      <delay exact="15s"/>
                      <actions>-->
                <write_incoming_message title="{30227,10101}" text="{30227,10102}" source="{30227,10103}" highpriority="false" comment="email about Argon economy"/>
                <!--</actions>
                      <delay exact="80s"/>
                      <actions>-->
                <cancel_cue cue="Ch4_CovertOperations"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Chapter 5: Breaking into relay station under cover of SCA attack -->

        <cue name="Ch5_Force">
          <actions>
            <!-- Special setup when you "fast-forward" into a chapter (skipping earlier ones) -->
          </actions>
          <force name="Ch5_DataHeist">
            <signal_cue_instantly cue="Debug_Setup_Terran_SSC"/>
            <signal_cue_instantly cue="Debug_Setup_HQ" check="false"/>
            <signal_cue cue="Setup_Remember_Diplomacy_Plot"/>
            <signal_cue cue="SecretServiceActor_Dialog_Option_Story"/>
            <signal_cue cue="Setup_Character_ScaleplateLieutenant"/>
            <signal_cue cue="Setup_Ch3_RelayStation" check="false"/>
            <signal_cue cue="Setup_Ch3_Relay_Station_Interior"/>
            <signal_cue cue="Ch5_DataHeist"/>
          </force>
        </cue>

        <cue name="Ch5_DataHeist" version="3">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <do_if value="faction.antigone.headquarters == $RelayStation">
              <set_value name="md.$Disable_ANT_Invite"/>
            </do_if>
            <signal_cue_instantly cue="Setup_Ch5_SecretServiceActorShip"/>
          </actions>
          <patch sinceversion="3">
            <do_if value="not $SecretServiceActorShip.exists">            
              <signal_cue cue="Setup_Ch5_SecretServiceActorShip"/>
              <reset_cue cue="Ch_5_SecretServiceActor_SCA_Actor_Placement"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Ch_5_SecretServiceActor_SCA_Actor_Placement">
              <delay exact="4s"/>
              <actions>

                <create_position name="$SecretServicePos" x="0.8" z="-2.5" y="0.72" space="$SecretServiceActorShip.controlroom"/>
                <create_rotation name="$SecretServiceRot" yaw="-170.0deg"/>

                <create_position name="$SCAPiratePos" x="-1.2" z="-2.7" y="0.72" space="$SecretServiceActorShip.controlroom"/>
                <create_rotation name="$SCAPirateRot" yaw="110.0deg"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SecretServiceActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $SecretServiceActorShip.controlroom,
                                                                                                      $position = $SecretServicePos,
                                                                                                      $rotation = $SecretServiceRot,
                                                                                                      $priority = 110,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $ScalePlateActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $SecretServiceActorShip.controlroom,
                                                                                                      $position = $SCAPiratePos,
                                                                                                      $rotation = $SCAPirateRot,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                <create_position name="$SecretServiceActorPos" space="$SecretServiceActorShip.controlroom" object="$SecretServiceActor" comment="Temporary"/>
                <debug_text text="'SecretServiceActorPos: ' + $SecretServiceActorPos" chance="$DebugChance"/>
                <signal_cue cue="Ch_5_Briefing" check="false" comment="Already complete in case of patch v2 or v3, so don't check"/>
              </actions>
            </cue>

            <cue name="Ch_5_Pirate_Fleet_Setup">
              <actions>
                <set_value name="$StationSpace" exact="$RelayStation.sector"/>

                <get_safe_pos result="$StagingPosition" object="$RelayStation" space="$StationSpace" sector="$StationSpace" x="16km" y="5km" z="0km" radius="3km"/>

                <!-- Scale Plate Flag Ship -->
                <create_ship name="$SCAFlagship" macro="ship_tel_l_destroyer_02_a_macro" commandeerable="false" capturable="false" sector="$StationSpace">
                  <owner exact="faction.scaleplate" overridenpc="true"/>
                  <pilot>
                    <select faction="faction.scaleplate" tags="tag.elitepilot"/>
                  </pilot>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <people ref="teladi_elite_military_crew"/>
                  <orientation refobject="$RelayStation" orientation="look_at"/>
                  <position value="$StagingPosition"/>
                </create_ship>

                <set_object_name object="$SCAFlagship" page="30227" line="202" comment="Invisible Hand"/>
                <set_value name="$SCAFlagship.pilot.$donotscan" comment="Prevents police from uncovering the ship."/>

                <create_order id="'Wait'" object="$SCAFlagship" immediate="true">
                  <param name="holdfire" value="true"/>
                </create_order>

                <!-- Make Scaleplate Flagship invincible, so that the mission still works even if the player approaches very late -->
                <set_object_min_shield object="$SCAFlagship" exact="20"/>
                <set_object_min_hull object="$SCAFlagship" exact="30"/>

                <add_to_group groupname="$ScaleplateFleet" object="$SCAFlagship"/>

                <do_all exact="4" counter="$i">

                  <!-- Surround the station -->
                  <do_if value="$i == 2">
                    <get_safe_pos result="$StagingPosition" object="$RelayStation" space="$StationSpace" sector="$StationSpace" x="-16km" y="5km" z="0km" radius="3km"/>
                  </do_if>
                  <do_elseif value="$i == 3">
                    <get_safe_pos result="$StagingPosition" object="$RelayStation" space="$StationSpace" sector="$StationSpace" x="0km" y="5km" z="18km" radius="3km"/>
                  </do_elseif>
                  <do_elseif value="$i == 4">
                    <get_safe_pos result="$StagingPosition" object="$RelayStation" space="$StationSpace" sector="$StationSpace" x="0km" y="5km" z="-18km" radius="3km"/>
                  </do_elseif>

                  <set_value name="$ScaleplateFleetComposition"   exact="[
                   [ macro.ship_arg_l_destroyer_02_a_macro],
                           
                   [ macro.ship_arg_m_bomber_02_a_macro],
                                                       
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   ]" />

                  <do_all exact="$ScaleplateFleetComposition.count" counter="$f">
                    <create_ship name="$CurrentShip" macro="$ScaleplateFleetComposition.{$f}.{1}" commandeerable="false" capturable="false" sector="$StationSpace">
                      <owner exact="faction.scaleplate" overridenpc="true" />
                      <pilot>
                        <select faction="faction.scaleplate" tags="tag.elitepilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <orientation refobject="$RelayStation" orientation="look_at"/>
                      <safepos value="$StagingPosition" min="200m" max="500m"/>
                    </create_ship>

                    <add_to_group groupname="$ScaleplateFleet" object="$CurrentShip"/>
                    <set_value name="$CurrentShip.pilot.$donotscan" comment="Prevents police from uncovering the ship."/>

                    <do_if value="$f == 1">
                      <set_value name="$Groupleader" exact="$CurrentShip"/>
                      <set_value name="$Commander" exact="$SCAFlagship"/>

                      <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                        <param name="commander" value="$Commander"/>
                        <param name="assignment" value="assignment.attack"/>
                        <param name="cancelorders" value="true"/>
                      </create_order>

                      <create_order id="'Wait'" object="$CurrentShip" immediate="true">
                        <param name="holdfire" value="true"/>
                      </create_order>

                    </do_if>
                    <do_else>
                      <set_value name="$Commander" exact="$Groupleader"/>

                      <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                        <param name="commander" value="$Commander"/>
                        <param name="assignment" value="assignment.defence"/>
                        <param name="cancelorders" value="true"/>
                      </create_order>
                    </do_else>

                  </do_all>

                </do_all>

                <debug_text text="'ScaleplateFleet: ' + $ScaleplateFleet"/>
                <do_for_each in="$ScaleplateFleet" name="$ship">
                  <signal_objects object="player.galaxy" param="'Cover'" param2="[$ship, faction.argon]"/>
                  <debug_text text="'Setting cover faction for: ' + $ship.idcode + '  ' + $ship.knownname + '\nCurrent order: ' + $ship.order.name" chance="$DebugChance"/>
                </do_for_each>

                <add_to_group groupname="$All_hostile_ships" group="$ScaleplateFleet"/>

                <set_value name="$ReinforcementComposition"   exact="[
                   [ macro.ship_arg_l_destroyer_02_a_macro],
                           
                   [ macro.ship_arg_m_bomber_02_a_macro],
                   [ macro.ship_arg_m_bomber_02_a_macro],
                                                       
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   [ macro.ship_tel_s_fighter_01_a_macro],
                   ]" />

                <get_safe_pos result="$ReinforcementsPosition" object="$RelayStation" space="$StationSpace" sector="$StationSpace" x="9km" y="-6km" z="-15km" radius="3km"/>

                <do_all exact="$ReinforcementComposition.count" counter="$f">
                  <create_ship name="$CurrentShip" macro="$ReinforcementComposition.{$f}.{1}" commandeerable="false" capturable="false" sector="$StationSpace">
                    <owner exact="faction.scaleplate" overridenpc="true" />
                    <pilot>
                      <select faction="faction.scaleplate" tags="tag.elitepilot"/>
                    </pilot>
                    <loadout>
                      <level exact="1.0"/>
                    </loadout>
                    <orientation refobject="$RelayStation" orientation="look_at"/>
                    <safepos value="$ReinforcementsPosition" min="1km" max="3km"/>
                  </create_ship>

                  <add_to_group groupname="$Reinforcements" object="$CurrentShip"/>
                  <set_value name="$CurrentShip.pilot.$donotscan" comment="Prevents police from uncovering the ship."/>

                  <do_if value="$f == 1">
                    <set_value name="$SCAReinforcementLeader" exact="$CurrentShip"/>

                    <create_order id="'Wait'" object="$CurrentShip" immediate="true">
                      <param name="holdfire" value="true"/>
                    </create_order>

                  </do_if>
                  <do_else>
                    <set_value name="$Commander" exact="$SCAReinforcementLeader"/>

                    <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                      <param name="commander" value="$Commander"/>
                      <param name="assignment" value="assignment.attack"/>
                      <param name="cancelorders" value="true"/>
                    </create_order>
                  </do_else>

                </do_all>
                <do_for_each in="$Reinforcements" name="$ship">
                  <signal_objects object="player.galaxy" param="'Cover'" param2="[$ship, faction.argon]"/>
                  <debug_text text="'Setting cover faction for: ' + $ship.idcode + '  ' + $ship.knownname + '\nCurrent order: ' + $ship.order.name" chance="$DebugChance"/>
                </do_for_each>
                <add_to_group groupname="$All_hostile_ships" group="$Reinforcements"/>
              </actions>
            </cue>

            <cue name="Ch_5_Argon_Reinforcements">
              <actions>
                <get_safe_pos result="$ArgonFleetPosition" object="$RelayStation" space="$StationSpace" sector="$StationSpace" x="13km" y="-8km" z="25km" radius="3km"/>

                <!-- Argon Reinforcement Ship -->
                <create_ship name="$Argon_Flagship" macro="ship_arg_l_destroyer_02_a_macro" commandeerable="false" capturable="false" sector="$StationSpace">
                  <owner exact="faction.argon" overridenpc="true"/>
                  <pilot>
                    <select faction="faction.argon" tags="tag.elitepilot"/>
                  </pilot>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <people ref="argon_elite_military_crew"/>
                  <orientation refobject="$RelayStation" orientation="look_at"/>
                  <position value="$ArgonFleetPosition"/>
                </create_ship>

                <create_order id="'Wait'" object="$Argon_Flagship" immediate="true">
                  <param name="holdfire" value="true"/>
                </create_order>

                <add_to_group groupname="$ArgonFleet" object="$Argon_Flagship"/>

                <set_value name="$ArgonFleetComposition"   exact="[
                           
                   [ macro.ship_arg_m_bomber_01_a_macro],
                   [ macro.ship_arg_m_bomber_01_a_macro],
                   [ macro.ship_arg_m_bomber_01_a_macro],
                                                       
                   [ macro.ship_arg_s_fighter_01_a_macro],
                   [ macro.ship_arg_s_fighter_01_a_macro],
                   [ macro.ship_arg_s_fighter_01_a_macro],
                   [ macro.ship_arg_s_fighter_01_a_macro],
                   [ macro.ship_arg_s_fighter_01_a_macro],
                   ]" />

                <do_all exact="$ArgonFleetComposition.count" counter="$f">
                  <create_ship name="$CurrentShip" macro="$ArgonFleetComposition.{$f}.{1}" commandeerable="false" capturable="false" sector="$StationSpace">
                    <owner exact="faction.argon" overridenpc="true" />
                    <pilot>
                      <select faction="faction.argon" tags="tag.elitepilot"/>
                    </pilot>
                    <loadout>
                      <level exact="1.0"/>
                    </loadout>
                    <orientation refobject="$RelayStation" orientation="look_at"/>
                    <safepos value="$ArgonFleetPosition" min="200m" max="500m"/>
                  </create_ship>

                  <add_to_group groupname="$ArgonFleet" object="$CurrentShip"/>

                  <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                    <param name="commander" value="$Argon_Flagship"/>
                    <param name="assignment" value="assignment.attack"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>
                </do_all>
              </actions>
            </cue>

            <cue name="Ch_5_Briefing" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_mission cue="$MissionCue" name="{30227,5001}" description="{30227,5002}" rewardtext="{30227,5007}" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname">
                  <briefing>
                    <objective step="$ObjectiveStep" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                  </briefing>
                </create_mission>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" object="$SecretServiceActor" action="objective.talkto" text="$SecretServiceActor.knownname"/>
              </actions>
              <patch sinceversion="2">
                <!-- Ch5 could be signalled before cancelling Ch4, which resulted in the Ch5 Mission being removed -->
                <do_if value="$MissionCue.hasmission == 0">
                  <create_mission cue="$MissionCue" name="{30227,5001}" description="{30227,5002}" rewardtext="{30227,5007}" type="missiontype.plot" faction="faction.terran" difficulty="level.medium" abortable="false" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname">
                    <briefing>
                      <objective step="1" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                    </briefing>
                  </create_mission>
                  <do_if value="$ObjectiveStep == 1">
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" object="$SecretServiceActor" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                  </do_if>
                  <do_elseif value="$ObjectiveStep == 2">
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto" text="{30227,5003}" updatebriefing="true" object="$StationSpace" offset="$StagingAreaPos" radius="3km" comment="Outside Relay Station"/>
                  </do_elseif>
                  <do_elseif value="$ObjectiveStep == 3">
                    <update_mission cue="$MissionCue">
                      <briefing>
                        <objective step="1" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                        <objective step="2" action="objective.flyto" text="{30227,5003}"/>
                      </briefing>
                    </update_mission>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.await" text="{30227,5004}" updatebriefing="true" group="$ObjectiveGroup"/>
                  </do_elseif>
                  <do_elseif value="$ObjectiveStep == 4">
                    <update_mission cue="$MissionCue">
                      <briefing>
                        <objective step="1" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                        <objective step="2" action="objective.flyto" text="{30227,5003}"/>
                        <objective step="3" action="objective.await" text="{30227,5004}"/>
                      </briefing>
                    </update_mission>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.dockat" updatebriefing="true" object="$RelayStation" comment="Dock at: Relay Station"/>
                  </do_elseif>
                  <do_elseif value="$ObjectiveStep == 5">
                    <update_mission cue="$MissionCue">
                      <briefing>
                        <objective step="1" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                        <objective step="2" action="objective.flyto" text="{30227,5003}"/>
                        <objective step="3" action="objective.await" text="{30227,5004}"/>
                        <objective step="4" action="objective.dockat" object="$RelayStation"/>
                      </briefing>
                    </update_mission>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" object="$RelayStation_ServerRoom" offset="$ServerRoomOffset" action="objective.custom" customaction="{30227,5005}" updatebriefing="true" comment="Access Relay Servers"/>
                  </do_elseif>
                  <do_elseif value="$ObjectiveStep == 6">
                    <update_mission cue="$MissionCue">
                      <briefing>
                        <objective step="1" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                        <objective step="2" action="objective.flyto" text="{30227,5003}"/>
                        <objective step="3" action="objective.await" text="{30227,5004}"/>
                        <objective step="4" action="objective.dockat" object="$RelayStation"/>
                        <objective step="5" action="objective.custom" customaction="{30227,5005}"/>
                      </briefing>
                    </update_mission>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.undock" updatebriefing="true" object="$RelayStation"/>
                  </do_elseif>
                  <do_elseif value="$ObjectiveStep == 7">
                    <update_mission cue="$MissionCue">
                      <briefing>
                        <objective step="1" action="objective.talkto" text="$SecretServiceActor.knownname"/>
                        <objective step="2" action="objective.flyto" text="{30227,5003}"/>
                        <objective step="3" action="objective.await" text="{30227,5004}"/>
                        <objective step="4" action="objective.dockat" object="$RelayStation"/>
                        <objective step="5" action="objective.custom" customaction="{30227,5005}"/>
                        <objective step="6" action="objective.undock" object="$RelayStation"/>
                      </briefing>
                    </update_mission>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30227,5006}" updatebriefing="true"/>
                  </do_elseif>
                </do_if>
              </patch>
              <cues>
                <cue name="Ch5_Story_Reminder">
                  <cues>
                    <cue name="Ch5_Story_Reminder_Ref" ref="Story_Reminder">
                      <param name="Actor"       value="$SecretServiceActor"/>
                      <param name="CutsceneKey" value="$SecretServiceCutsceneKey"/>
                      <param name="Lines"       value="[[30227519]]"/>
                      <param name="CancelCue"   value="Ch_5_Escape"/>
                      <param name="Delay"       value="45min"/>
                      <!--
                      (Curious but annoyed)Any progress to show for the relay station hack? Did you get your hands on something useful yet?
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch_5_Briefing_Cutscene" checkinterval="50ms">
                  <conditions>
                    <check_value value="player.room == $SecretServiceActorShip.controlroom and player.entity.distanceto.[$SecretServiceActorShip.controlroom, $SecretServiceActorPos] lt 4.1m"/>
                  </conditions>
                  <actions>
                    <set_value name="$CutsceneKey" exact="'story_terran_covert_ops'"/>

                    <create_position name="$PlayerPos" x="0.1m" y="2.3m" z="-4m" space="$SecretServiceActorShip.controlroom"/>

                    <!--Warp player to different position-->
                    <add_actor_to_room actor="player.entity" object="$SecretServiceActorShip.controlroom">
                      <position value="$PlayerPos" space="$SecretServiceActorShip.controlroom"/>
                      <rotation yaw="25.0deg"/>
                    </add_actor_to_room>

                    <fade_screen fadeout="0s" fadein="1.4s" realtime="true"/>
                    <play_cutscene key="$CutsceneKey" result="this.$CutsceneID" abortable="true">
                      <param name="target_agent"      object="$SecretServiceActor"/>
                      <param name="target_pirate"     object="$ScalePlateActor"/>
                      <param name="target_player"     object="player.entity"/>
                    </play_cutscene>
                  </actions>
                  <cues>
                    <cue name="Ch_5_Briefing_Conversation">
                      <conditions>
                        <event_cutscene_started cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <delay exact="1.5s"/>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_UseCases.UseCase" param="table[ $name = '$CovOps_Briefing_Scene_1', $actors = table[ $SecretServiceActor = $SecretServiceActor, $ScalePlateActor = $ScalePlateActor], $debugchance = $DebugChance ]" />
                      </actions>
                      <cues>

                        <cue name="Ch5_SecretService_Turn">
                          <conditions>
                            <event_speak_finished actor="$SecretServiceActor" line="30227505"/>
                          </conditions>
                          <delay exact="1.5s"/>
                          <actions>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence1Done'"/>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence2Start'"/>
                          </actions>
                        </cue>

                        <cue name="Ch5_SecretServiceActor_Instructions">
                          <conditions>
                            <event_speak_finished actor="$ScalePlateActor" line="30227502"/>
                          </conditions>
                          <delay exact="2s"/>
                          <actions>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence2Done'"/>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence3Start'"/>
                          </actions>
                        </cue>

                        <cue name="Ch5_SCA_Actor_Player_Warning">
                          <conditions>
                            <event_speak_finished actor="$SecretServiceActor" line="30227510"/>
                          </conditions>
                          <delay exact="1.5s"/>
                          <actions>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence3Done'"/>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence4Start'"/>
                          </actions>
                        </cue>

                        <cue name="Ch5_SecretServiceActor_EndConversation">
                          <conditions>
                            <event_speak_finished actor="$ScalePlateActor" line="30227507"/>
                          </conditions>
                          <delay exact="3s"/>
                          <actions>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence4Done'"/>
                            <cutscene_event key="$CutsceneKey" event="'TriggerSequence5Start'"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch5_Briefing_Cutscene_Stop">
                      <conditions>
                        <event_speak_finished actor="$SecretServiceActor" line="30227513"/>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <cutscene_event key="$CutsceneKey" event="'TriggerSequence4Done'"/>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_MovingToNext_Objective">
                      <conditions>
                        <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" exact="1" operation="add"/>

                        <set_value name="$SecretServiceActorShip.pilot.$freezeinstancedNPCs" exact="false"/>
                        <signal_objects object="$SecretServiceActorShip.pilot" param="'npc_state_reinit'"/>

                        <signal_cue cue="Ch_5_Get_in_Position"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>

                        <add_inventory ware="ware.inv_sandwell_archive_pass" exact="1" />
                        <show_notification text="{1015,90} + '\n' + ware.inv_sandwell_archive_pass.name" sound="notification_generic" comment="Pass received"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch_5_AfterBriefing_SCADialogue" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$ScalePlateActor"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$ScalePlateActor" hidechoices="true">
                      <text line="30227508" comment="(Arrogant)Run along now, errand boy. We have an attack to prepare."/>
                    </add_npc_line>
                  </actions>
                </cue>

                <cue name="Ch_5_AfterBriefing_SecretServiceDialogue" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$SecretServiceActor"/>
                  </conditions>
                  <cues>
                    <cue name="Ch_5_AfterBriefing_SecretServiceDialogue_Selected">
                      <conditions>
                        <event_conversation_next_section actor="$SecretServiceActor" section="story_covert_operations"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$SecretServiceActor" hidechoices="true">
                          <text line="30227514" comment="(Tense)Better get ready. This is going to be the most crucial part of this entire operation. "/>
                        </add_npc_line>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch_5_Undocked_Ship" checkinterval="2s">
                  <conditions>
                    <check_value value="not player.entity.hascontext.{$SecretServiceActorShip} and Ch5_Briefing_Cutscene_Stop.state == cuestate.complete"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $SecretServiceActor, $MissionCue]"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $ScalePlateActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $SCAFlagship.controlroom,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <set_value name="$ScalePlateActorCutsceneKey"       exact="table[ $key = 'ShowNPCFace']"/>
                  </actions>
                  <cues>

                    <cue name="Ch_5_Dal_Prepare_Raid_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="DelayInitial"      value="3s"/>
                      <param name="Lines"             value="[[30227501],[30227502],[30227503],[30227504],[30227505]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                              Dal:
                              Things are getting pretty serious.
                              Cooperating with the Scale Plate Pact still doesn’t sit right with me.
                              Let me cautiously put out my feelers. 
                              I will see if I could establish contact with the Antigone Republic, just in case.
                              You keep going along with this, I just want to make sure we keep all our options open.
                      -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch_5_Get_in_Position">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <get_safe_pos result="$StagingAreaPos" sector="$StationSpace" object="$RelayStation" radius="8km" min="35km" max="45km" allowyaxis="false"/>
                <set_object_docking_enabled object="$RelayStation" enabled="false"/>

                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto" text="{30227,5003}" updatebriefing="true" object="$StationSpace" offset="$StagingAreaPos" radius="3km" comment="Outside Relay Station"/>
                <set_value name="$DockLineCooldown" exact="player.age"/>
              </actions>
              <cues>

                <cue name="Ch_5_Premautre_Docking_Attempt">
                  <conditions>
                    <check_any>
                      <check_all>
                        <event_object_docking_denied group="global.$PlayerOccupiedShipGroup"/>
                        <check_value value="event.param == $RelayStation"/>
                      </check_all>
                      <check_all>
                        <event_object_docking_impossible group="global.$PlayerOccupiedShipGroup"/>
                        <check_value value="event.param == $RelayStation"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <cues>

                    <cue name="Ch_5_Dal_DockingImpossible_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="DelayInitial"      value="3s"/>
                      <param name="Lines"             value="[[30227510],[30227511]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch_5_Voiceline_Reset"/>
                      <!--
                      Looks like they are on high alert. They must know something is up. 
                      We will have to wait for the attack before we can try to slip through.
                      -->
                    </cue>
                    <cue name="Ch_5_Voiceline_Reset">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="60s"/>
                      <actions>
                        <reset_cue cue="Ch_5_Premautre_Docking_Attempt"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch_5_Reached_Staging_Area" checkinterval="2s">
                  <conditions>
                    <check_value value="player.entity.distanceto.{[$StationSpace, $StagingAreaPos]} lt 3km"/>
                  </conditions>
                  <actions>
                    <!--Disable Mission Calls for the finale -->
                    <append_to_list name="md.$MissionDND" exact="Ch_5_Reached_Staging_Area"/>

                    <play_music music="'terran_music_covert_ops_raid_1'" comment="220s"/>

                    <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                    <add_to_group groupname="$ObjectiveGroup" object="$RelayStation"/>
                    <add_to_group groupname="$ObjectiveGroup" group="$ScaleplateFleet"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.await" text="{30227,5004}" updatebriefing="true" group="$ObjectiveGroup"/>
                    <set_value name="$ReturnObjective" exact="objective.flyto"/>

                    <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                      <param name="Object" value="$SecretServiceActorShip"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                    
                    <create_order object="$SecretServiceActorShip" id="'MoveDie'" immediate="true">
                      <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                    </create_order>
                    <signal_cue cue="Ch_5_Pirates_Move_In_Position"/>

                    <!-- Remove Guarding Marines -->
                    <cancel_cue cue="Generic_Responses_Handler"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $ArgonGuardActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location =  'disconnect',
                                                                                                                                      $position = $GuardPos,
                                                                                                                                      $rotation = $GuardRot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $AddititionalGuardActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location =  'disconnect',
                                                                                                                                      $position = $AdditionalGuardPos,
                                                                                                                                      $rotation = $GuardRot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                    <!-- create Security Response-->
                    <find_dockingbay name="$RelayStationInternalDock" object="$RelayStation" multiple="true" required="true">
                      <match_dock storage="true" size="tag.dock_m"/>
                    </find_dockingbay>
                    <do_all exact="10" counter="$i">
                      <get_ship_definition reference="$AntigonePoliceShipDef" size="class.ship_m" faction="faction.antigone" tags="tag.military"/>
                      <do_if value="$RelayStationInternalDock.count">
                        <create_ship name="$AntigonePoliceSquadShip" ref="$AntigonePoliceShipDef" dock="$RelayStationInternalDock.random" capturable="false">
                          <owner exact="faction.antigone" overridenpc="true" />
                          <pilot group="argon.pilot"/>
                        </create_ship>
                        <add_to_group groupname="$AntigonePoliceSquad" object="$AntigonePoliceSquadShip"/>
                      </do_if>
                    </do_all>
                  </actions>
                  <cues>

                    <cue name="Ch_5_Check_For_Player_Leaving" checkinterval="3s">
                      <conditions>
                        <check_value value="player.entity.distanceto.{$RelayStation} gt 28km or player.entity.distanceto.{$RelayStation} le 25km"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Player has left the Staging Area'"/>
                        <set_value name="$objectivestep" operation="add" exact="1"/>
                      </actions>
                      <cues>
                        <cue name="FlyToStagingArea_Ref" ref="md.RML_FlyTo.FlyTo">
                          <param name="MissionCue" value="$MissionCue"/>
                          <param name="StartStep" value="null" comment="do not update briefing"/>
                          <param name="UpdateBriefing" value="false"/>

                          <param name="Target" value="$StationSpace"/>
                          <param name="TargetAlias" value="{30227,5003}"/>
                          <param name="Radius" value="3km"/>
                          <param name="Distance" value="3km"/>
                          <param name="Offset" value="$StagingAreaPos"/>
                          <param name="FlyToObjective" value="$ReturnObjective"/>

                          <param name="EndOnCompletion" value="false" comment="End this RML when the player has reached the destination. WARNING: If false, the caller must end the library."/>
                          <param name="ReachedTargetSignalCue" value="AtDestination" comment="Cue to be signalled when player reaches the destination"/>
                          <param name="DebugChance" value="$DebugChance"/>
                        </cue>
                        <cue name="AtDestination" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_objective cue="$MissionCue" action="objective.await" text="{30227,5004}" group="$ObjectiveGroup"/>
                          </actions>
                        </cue>
                        <cue name="LeftDestination" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_objective cue="$MissionCue" action="objective.flyto" text="{30227,5003}" object="$StationSpace" offset="$StagingAreaPos" radius="3km"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>


                    <cue name="Ch_5_Dal_InPosition_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$DalBusta, $ScalePlateActor ,$DalBusta]"/>
                      <param name="CutsceneKey"       value="[$DalCutsceneKey, $ScalePlateActorCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                              [[30227506]],
                                                              [[30227509, 2s]],
                                                              [[30227507, 4s]]
                                                              ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[null, null, null]"/>
                      <!--
                          Dal:
                          Okay, I let them know we are in position.
                          Pirate:
                          Everybody, keep your cover active until we are in close range.
                          Dal:
                          Here come the Scale Plate ships.
                      -->
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch_5_Pirates_Move_In_Position">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <get_safe_pos result="$AttackPos" object="$RelayStation" sector="$StationSpace" x="1" y="3km" z="1"/>
                    <cancel_all_orders object="$SCAFlagship"/>

                    <debug_text text="'Moving Scaleplate Fleet in Position'" chance="$DebugChance"/>
                    <create_order id="'MoveWait'" object="$SCAFlagship" immediate="true">
                      <param name="destination" value="[$StationSpace, $AttackPos]"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch_5_Pirates_In_Position" checkinterval="2s">
                  <conditions>
                    <check_value value="($SCAFlagship.distanceto.{$RelayStation} le 12km) and $SCAFlagship.sector == $StationSpace and player.entity.distanceto.{[$StationSpace, $StagingAreaPos]} lt 3km and (player.sector == $StationSpace)"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <cancel_cue cue="Ch_5_Premautre_Docking_Attempt"/>
                    <create_order id="'Wait'" object="$SCAFlagship" immediate="true">
                      <param name="holdfire" value="true"/>
                    </create_order>

                  </actions>
                  <cues>

                    <cue name="Ch_5_Dal_PirateAttack_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$ScalePlateActor, $ScalePlateActor, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$ScalePlateActorCutsceneKey, $ScalePlateActorCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                              [[30227510]],
                                                              [[30227511, 2s],[30227512, 1s]],
                                                              [[30227508],[30227509, 1s]]
                                                              ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[Ch_5_Drop_Cover, Ch_5_SCA_Attack, null]"/>
                      <!--
                      Scaleplate Pirate:
                      That's it. Drop cover!
                      This is a Scaleplate Pact Raid. Disengage defences and allow us on board!
                      Light them up! Fire!
                      
                      Dal:
                      They are attacking! That’s our cue!
                      Now or never, go!
                      -->
                    </cue>

                    <cue name="Ch_5_Drop_Cover">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>

                        <do_for_each in="$ScaleplateFleet" name="$ship">
                          <set_cover_owner object="$ship" faction="null"/>
                          <set_relation_boost object="$ship" silent="true" otherobject="player.entity" value="-1.0" decay="0.02" delay="540s" />
                          <set_relation_boost object="$RelayStation" silent="true" otherobject="$ship" value="-1.0" decay="0.02" delay="540s" />
                          <debug_text text="'Setting cover faction for: ' + $ship.knownname" chance="$DebugChance"/>
                        </do_for_each>

                      </actions>
                    </cue>
                    <cue name="Ch_5_SCA_Attack">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch_5_Check_For_Player_Leaving"/>
                        <cancel_cue cue="FlyToStagingArea_Ref"/>

                        <!-- The Pirates Attack -->
                        <add_to_group groupname="$Primarytargets" object="$RelayStation"/>

                        <add_to_group groupname="$Secondarytargets" group="$AntigonePoliceSquad"/>
                        <add_to_group groupname="$Secondarytargets" object="player.entity.ship"/>

                        <cancel_all_orders object="$SCAFlagship"/>

                        <create_order id="'Attack'" name="$attackOrder" object="$SCAFlagship" immediate="true">
                          <param name="primarytarget" value="$RelayStation"/>
                          <param name="secondarytargets" value="$Secondarytargets"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="allowothertargets" value="false"/>
                          <param name="checkrelation" value="false"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <!-- Police Squad Activation follows shortly after-->
                        <do_all exact="$AntigonePoliceSquad.count" counter="$i">
                          <cancel_all_orders object="$AntigonePoliceSquad.{$i}"/>
                          <create_order object="$AntigonePoliceSquad.{$i}" id="'Attack'" immediate="true">
                            <param name="primarytarget" value="$SCAFlagship"/>
                            <param name="secondarytargets" value="$ScaleplateFleet"/>
                            <param name="pursuetargets" value="true"/>
                            <param name="allowothertargets" value="false"/>
                            <param name="checkrelation" value="false"/>
                            <param name="debugchance" value="$DeepDebugChance"/>
                          </create_order>
                        </do_all>
                        <signal_cue cue="Ch_5_Dock_At_Station"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch_5_Dock_At_Station">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                <set_object_docking_enabled object="$RelayStation" enabled="true"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.dockat" updatebriefing="true" object="$RelayStation" comment="Dock at: Relay Station"/>

                <set_value name="$ExplosionDelay" min="5s" max="20s"/>
              </actions>
              <delay exact="9s"/>
              <actions>
                <set_alert_level object="$RelayStation" level="red" comment="attack noticed"/>
                <speak actor="$ArgonGuardActor" line="30227503" broadcast="true" backgroundcomm="true" comment="(Panicked)The Relay Station is under attack!"/>
              </actions>
              <delay exact="15s"/>
              <actions>
                <speak actor="$ScalePlateActor" line="30227513" broadcast="true" backgroundcomm="true" comment="(Commanding)Keep up the pressure!"/>
              </actions>
              <delay exact="10s"/>
              <actions>
                <speak actor="$ArgonGuardActor" line="30227505" broadcast="true" backgroundcomm="true" comment="(Forceful)Return fire!"/>
              </actions>
              <delay exact="8s"/>
              <actions>
                <speak actor="$ArgonGuardActor" line="30227504" broadcast="true" backgroundcomm="true" comment="(Worried)Send Argon reinforcements now!"/>
              </actions>
              <cues>

                <cue name="Ch_5_Explosion_Effect">
                  <cues>
                    <cue name="Ch_5_Explosion_Loop" instantiate="true" checkinterval="20s">
                      <delay exact="$ExplosionDelay"/>
                      <actions>
                        <set_value name="$ExplosionDelay" min="5s" max="15s"/>
                        <set_value name="$ExplosionAmount" min="1" max="3"/>
                        <do_all exact="$ExplosionAmount">
                          <add_effect object="$RelayStation" effect="'ref_explosion_station_explosion01'"/>
                        </do_all>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch_5_Player_Has_Docked" checkinterval="1s">
                  <conditions>
                    <check_value value="player.entity.hascontext.{$RelayStation}"/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                    <set_object_docking_enabled object="$RelayStation" enabled="true"/>

                    <set_triggers_locked object="$RelayStation_ServerRoom" group="tag.door_01" locked="false" comment="Unlock the Server Room"/>
                    <create_position name="$ServerRoomOffset" space="$RelayStation_ServerRoom" x="-1m" z="-9m" y="0.3m"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" object="$RelayStation_ServerRoom" offset="$ServerRoomOffset" action="objective.custom" customaction="{30227,5005}" updatebriefing="true" comment="Access Relay Servers"/>

                    <debug_text text="'SCA Reinforcements on the way'" chance="$DebugChance"/>

                    <cancel_all_orders object="$SCAReinforcementLeader"/>
                    <create_order id="'Attack'" name="$ScaleplateAttackOrder" object="$SCAReinforcementLeader">
                      <param name="primarytarget" value="$RelayStation"/>
                      <param name="secondarytargets" value="$Secondarytargets"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="allowothertargets" value="false"/>
                      <param name="checkrelation" value="false"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>

                    <get_safe_pos result="$SCAAttackPos" object="$RelayStation" sector="$StationSpace" min="22km" max="26km"/>
                    <create_order id="'MoveWait'" object="$SCAReinforcementLeader" name="$MoveOrder" immediate="true">
                      <param name="destination" value="[$StationSpace, $SCAAttackPos]"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                    <debug_text text="$SCAReinforcementLeader.idcode + '  ' + $SCAReinforcementLeader.knownname + '\nCurrent order: ' + $SCAReinforcementLeader.order.name" chance="$DebugChance"/>

                    <cancel_all_orders object="$Argon_Flagship"/>

                    <do_for_each in="$All_hostile_ships" name="$currentship" reverse="true">
                      <do_if value="not $currentship.isoperational">
                        <remove_from_group group="$All_hostile_ships" object="$currentship"/>
                      </do_if>
                    </do_for_each>
                    <create_order id="'Attack'" name="$ArgonAttackOrder" object="$Argon_Flagship">
                      <param name="primarytarget" value="$SCAFlagship"/>
                      <param name="secondarytargets" value="$All_hostile_ships"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="allowothertargets" value="false"/>
                      <param name="checkrelation" value="false"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                  </actions>
                  <cues>

                    <cue name="Ch_5_Player_Left_Ship">
                      <conditions>
                        <event_object_changed_object object="player.entity" newobject="$RelayStation"/>
                      </conditions>
                      <cues>
                        <cue name="Ch_5_Dal_Docked_Relaystation_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30227512],[30227513]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          Good, we made it this far!
                          Keep your wits about you!
                      -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch_5_In_ServerRoom">
                      <conditions>
                        <event_object_changed_room object="player.entity" room="$ServerRoom_Corridor"/>
                      </conditions>
                      <delay exact="45s"/>
                      <actions>
                        <speak actor="$ScalePlateActor" line="30227514" broadcast="true" backgroundcomm="true"/>
                      </actions>
                      <cues>

                        <cue name="Ch_5_Dal_Entering_ServerRoom_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30227514],[30227515],[30227516]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch_5_Reinforcements"/>
                          <!--
                          It looks like the marines really did clear out.
                          Look for the console.
                          Get moving, though. Our associates won’t be able to sustain an attack this intense for much longer.
                          -->
                        </cue>

                        <cue name="Ch_5_Reinforcements">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="8s"/>
                          <actions>
                            <speak actor="$ArgonGuardActor" line="30227506" broadcast="true" backgroundcomm="true" comment="(Trying to remain calm, but failing)Every marine to their designated position!"/>
                          </actions>
                        </cue>

                        <cue name="Ch_5_Interacted_ServerTrigger">
                          <conditions>
                            <event_player_activated_platform_trigger component="$RelayStation_ServerRoom" group="tag.console_01" />
                          </conditions>
                          <actions>
                            <set_value name="$DownloadProgress" exact="0"/>
                            <set_objective cue="$MissionCue" action="objective.wait" text="{30224,6025}" comment="Downloading Data...">
                              <progress  progress="$DownloadProgress" max="100"/>
                            </set_objective>
                          </actions>
                          <cues>
                            <cue name="Ch_5_Downloading_Data" checkinterval="400ms" instantiate="true">
                              <actions>
                                <set_value name="$DownloadProgress" operation="add" exact="1"/>
                                <set_objective cue="$MissionCue" action="objective.wait" text="{30224,6025}" comment="Downloading Data..." silent="true">
                                  <progress progress="$DownloadProgress" max="100"/>
                                </set_objective>
                                <do_if value="$DownloadProgress ge 100">
                                  <set_objective cue="$MissionCue" action="objective.wait" text="{30224,6026}" comment="Download Complete..." silent="true">
                                    <progress  progress="100" max="100"/>
                                  </set_objective>
                                  <signal_cue cue="Ch5_Interact_ServerPanel"/>
                                </do_if>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Interact_ServerPanel">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch_5_Downloading_Data"/>
                        <add_inventory ware="ware.inv_encrypted_espionagedocument" exact="1" />
                        <remove_inventory ware="ware.inv_sandwell_archive_pass"/>
                        <show_notification text="{1015,90} + '\n' + ware.inv_encrypted_espionagedocument.name" sound="notification_generic" comment="Document received"/>
                      </actions>
                      <cues>
                        <cue name="Ch_5_Dal_DataAccessed_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30227517],[30227518],[30227519]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch_5_Escape_Station"/>
                          <!--
                                (Very relieved, happy)We got it!
                                (Admiringly, heavy emphasis on "lot")Oh, that's a lot of data.
                                Good work. Now, let's get out of here before anyone sees us.
                              -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch_5_Escape_Station">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" exact="1" operation="add"/>

                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.undock" updatebriefing="true" object="$RelayStation"/>
                      </actions>
                      <delay exact="8s"/>
                      <actions>
                        <cancel_cue cue="Setup_Ch3_Relay_Station_Interior"/>
                        <cancel_cue cue="Setup_Ch3_RelayStation"/>
                        <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                          <param name="Object" value="$RelayStation"/>
                          <param name="RequesterCue" value="Setup_Ch3_RelayStation"/>
                          <param name="DebugChance" value="$DebugChance"/>
                        </run_actions>
                      </actions>
                      <cues>

                        <cue name="Ch_5_Player_Undocks" checkinterval="1s">
                          <conditions>
                            <check_value value="not player.entity.hascontext.{$RelayStation}"/>
                          </conditions>
                          <delay exact="6s"/>
                          <actions>
                            <play_music music="'terran_music_covert_ops_raid_2'" comment="128s"/>

                            <cancel_cue cue="Ch_5_Explosion_Effect"/>
                            <set_value name="$ObjectiveStep" exact="1" operation="add"/>

                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30227,5006}" updatebriefing="true"/>
                            <set_relation_boost object="$RelayStation" silent="true" otherobject="player.entity" value="-1.0" decay="0.02" delay="540s" />
                            <do_all exact="$AntigonePoliceSquad.count" counter="$i">
                              <set_relation_boost object="$AntigonePoliceSquad.{$i}" silent="true" otherobject="player.entity" value="-1.0" decay="0.02" delay="540s" />

                              <cancel_all_orders object="$AntigonePoliceSquad.{$i}"/>
                              <create_order object="$AntigonePoliceSquad.{$i}" id="'Attack'" immediate="true">
                                <param name="primarytarget" value="player.entity.ship"/>
                                <param name="secondarytargets" value="$ScaleplateFleet"/>
                                <param name="pursuetargets" value="true"/>
                                <param name="allowothertargets" value="false"/>
                                <param name="checkrelation" value="false"/>
                                <param name="debugchance" value="$DeepDebugChance"/>
                              </create_order>
                            </do_all>

                            <do_for_each in="$ArgonFleet" name="$argonship">
                              <set_relation_boost object="$argonship" silent="true" otherobject="player.entity" value="-1.0" decay="0.02" delay="540s"/>
                            </do_for_each>

                            <cancel_all_orders object="$Argon_Flagship"/>
                            <do_for_each in="$All_hostile_ships" name="$currentship" reverse="true">
                              <do_if value="not $currentship.isoperational">
                                <remove_from_group group="$All_hostile_ships" object="$currentship"/>
                              </do_if>
                            </do_for_each>

                            <add_to_group groupname="$CompleteTargetGroup" object="player.entity.ship"/>
                            <add_to_group groupname="$CompleteTargetGroup" group="$All_hostile_ships"/>

                            <create_order id="'Attack'" name="$AttackOrder" object="$Argon_Flagship">
                              <param name="primarytarget" value="$SCAFlagship"/>
                              <param name="secondarytargets" value="$CompleteTargetGroup"/>
                              <param name="pursuetargets" value="true"/>
                              <param name="allowothertargets" value="false"/>
                              <param name="checkrelation" value="false"/>
                              <param name="debugchance" value="$DeepDebugChance"/>
                            </create_order>

                            <signal_cue cue="Ch_5_Escape"/>
                          </actions>
                          <cues>

                            <cue name="Ch_5_Dal_Player_Undocked_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                              <param name="Actor"             value="[$ArgonGuardActor, $DalBusta]"/>
                              <param name="CutsceneKey"       value="[$ArgonGuardActorCutsceneKey, $DalCutsceneKey]"/>
                              <param name="Lines"             value="[
                                                                      [[30227501],[30227502]],
                                                                      [[30227520],[30227521],[30227522]]
                                                                      ]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="[null, null]"/>
                              <!--
                              Guard:
                              That pilot was not authorised to dock! 
                              Shoot the ship down!
                              Dal:
                              It seems like our breach did raise some red flags after all.
                              Guards are on their way to intercept us.
                              Best floor it! Suffice to say, it would be really bad if we got caught now!
                              -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch_5_Escape">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch_5_Check_Escaped" checkinterval="2s">
                  <conditions>
                    <check_value value="player.age gt Ch_5_Escape.time + 30s"/>
                    <check_value value="not $RelayStation.exists or player.sector != $StationSpace or player.entity.distanceto.{$RelayStation} gt 35km"/>
                    <check_all counter="$i">
                      <check_value value="$AntigonePoliceSquad.{$i}.sector != player.sector or $AntigonePoliceSquad.{$i}.distanceto.{player.entity} gt 35km"/>
                    </check_all>
                  </conditions>
                  <cues>

                    <cue name="Ch_5_Dal_Player_Escaped_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$SecretServiceActor, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$SecretServiceCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                              [[30227515],[30227516],[30227517],[30227518]], 
                                                              [[30227523, 4s],[30227524],[30227525]] 
                                                              ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[Ch_5_Chapter_Finished, Ch_5_CancelChapter]"/>
                      <!--
                          SSC:
                          Word just got back that you managed to escape the station.
                          I hope you picked up enough data to really cripple the Argon.
                          We will sort the details out together.
                          Meet me for the final debrief. Bring whatever data you gathered.
                          Dal:
                          Hold up there, partner!
                          Before you hand over everything that we’ve just lifted off those servers, we really have to meet, too.
                          There are a few things we have to talk through. In person.
                          -->
                    </cue>
                    <cue name="Ch_5_Chapter_Finished">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- reenable mission calls -->
                        <remove_from_list name="md.$MissionDND" exact="Ch_5_Reached_Staging_Area"/>

                        <!-- Remove Relay Station Name -->
                        <do_if value="$RelayStationName?">
                          <set_object_name object="$RelayStation" name="$RelayStationName"/>
                        </do_if>
                        <remove_dynamic_interior interior="$ServerRoom_Interior" object="$RelayStation"/>

                        <remove_mission cue="$MissionCue" type="completed"/>
                        <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.006" reason="relationchangereason.missioncompleted"/>

                        <do_if value="md.$Disable_ANT_Invite?">
                          <remove_value name="md.$Disable_ANT_Invite"/>
                        </do_if>
                        <signal_cue cue="Ch6_Covert_Debrief"/>
                      </actions>
                    </cue>
                    <cue name="Ch_5_CancelChapter">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="1min"/>
                      <actions>
                        <do_all exact="$AntigonePoliceSquad.count" counter="$i">
                          <do_if value="$AntigonePoliceSquad.{$i}.isoperational">
                            <cancel_all_orders object="$AntigonePoliceSquad.{$i}"/>
                            <create_order object="$AntigonePoliceSquad.{$i}" id="'MoveDie'" immediate="true">
                              <param name="mintime" value="160s" comment="stay alive for specified time, after it docks"/>
                            </create_order>
                          </do_if>
                        </do_all>
                        <do_all exact="$All_hostile_ships.count" counter="$i">
                          <do_if value="$All_hostile_ships.{$i}.isoperational">
                            <cancel_all_orders object="$All_hostile_ships.{$i}"/>
                            <create_order object="$All_hostile_ships.{$i}" id="'MoveDie'" immediate="true">
                              <param name="mintime" value="160s" comment="stay alive for specified time, after it docks"/>
                            </create_order>
                          </do_if>
                        </do_all>
                        <do_all exact="$ArgonFleet.count" counter="$i">
                          <do_if value="$ArgonFleet.{$i}.isoperational">
                            <cancel_all_orders object="$ArgonFleet.{$i}"/>
                            <create_order object="$ArgonFleet.{$i}" id="'MoveDie'" immediate="true">
                              <param name="mintime" value="160s" comment="stay alive for specified time, after it docks"/>
                            </create_order>
                          </do_if>
                        </do_all>

                        <cancel_cue cue="Ch5_DataHeist"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Chapter 6: Handing over the stolen information and covering up/expsosing conspiracy-->

        <cue name="Ch6_Force">
          <actions>
            <!-- Special setup when you "fast-forward" into a chapter (skipping earlier ones) -->
          </actions>
          <force name="Ch6_Covert_Debrief">
            <signal_cue_instantly cue="Debug_Setup_Terran_SSC"/>
            <signal_cue_instantly cue="Debug_Setup_HQ" check="false"/>
            <signal_cue cue="Setup_Remember_Diplomacy_Plot"/>
            <signal_cue cue="SecretServiceActor_Dialog_Option_Story"/>
            <signal_cue cue="Ch6_Covert_Debrief"/>
          </force>
        </cue>

        <cue name="Ch6_Covert_Debrief">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

          </actions>
          <delay exact="5s"/>
          <actions>
            <create_mission cue="$MissionCue" name="{30227,6001}" description="{30227,6002}" rewardtext="{30227,6018}" type="missiontype.plot" group="missiongroup.story_covert_operations" faction="faction.terran" difficulty="level.hard" abortable="false" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.knownname">
              <briefing>
                <objective step="$ObjectiveStep" action="objective.talkto" object="$DalBusta"/>
              </briefing>
            </create_mission>
            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$DalBusta"/>
            <signal_cue cue="Ch_6_DecisionsDialogue"/>
          </actions>
          <cues>

            <cue name="ANT_Fleet_Setup" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_sector name="$Closest_ANT_Sector" owner="faction.antigone" sortbygatedistanceto="player.entity"/>
                <create_cue_actor name="$AntShip_Pilot" cue="namespace" group="argon.pilot.male">
                  <page exact="10101"/>
                  <owner exact="faction.antigone"/>
                  <skills>
                    <skill type="management"  exact="3"/>
                    <skill type="morale"      exact="5"/>
                    <skill type="piloting"    exact="6"/>
                    <skill type="engineering" exact="1"/>
                    <skill type="boarding"    exact="3"/>
                  </skills>
                </create_cue_actor>

                <get_ship_definition reference="$ANTactorShipDef" size="class.ship_l" faction="faction.antigone" tags="tag.military"/>
                <get_safe_pos result="$SectorSafePos" sector="$Closest_ANT_Sector" max="150km" radius="30km" allowyaxis="false" comment="big radius to have the ship be isolated"/>
                <set_value name="$ShipOffset" exact="position.[$SectorSafePos.x, 0, $SectorSafePos.z]"/>

                <create_ship name="$ANTActorShip" sector="$Closest_ANT_Sector" capturable="false" ref="$ANTactorShipDef">
                  <owner exact="faction.antigone" overridenpc="true"/>
                  <pilot actor="$AntShip_Pilot"/>
                  <position value="$ShipOffset"/>
                </create_ship>
                <set_object_name object="$ANTActorShip" page="30227" line="204"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SamanActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $ANTActorShip,
                                                                                                      $slottags = [tag.stand],
                                                                                                       $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                <create_order id="'Patrol'" object="$ANTActorShip" immediate="true">
                  <param name="space" value="$Closest_ANT_Sector"/>
                </create_order>

                <set_object_min_hull object="$ANTActorShip" exact="60"/>

                <do_if value ="$PlayerChose == 'Protectorate'">
                  <set_value name="$ProtectionFleetComposition"   exact="[
                        [ macro.ship_arg_m_bomber_01_b_macro],
                        [ macro.ship_arg_m_bomber_01_b_macro],
                        
                        [ macro.ship_arg_s_heavyfighter_02_a_macro],
                        [ macro.ship_arg_s_fighter_03_a_macro],
                        [ macro.ship_arg_s_fighter_03_a_macro],
                        [ macro.ship_arg_s_fighter_03_a_macro],
                        ]" />

                </do_if>
                <do_else>
                  <set_value name="$ProtectionFleetComposition"   exact="[
                        [ macro.ship_arg_m_bomber_01_b_macro],
                        
                        [ macro.ship_arg_s_fighter_03_a_macro],
                        [ macro.ship_arg_s_fighter_03_a_macro],
                        ]" />
                </do_else>

                <do_all exact="$ProtectionFleetComposition.count" counter="$f">
                  <create_ship name="$CurrentShip" macro="$ProtectionFleetComposition.{$f}.{1}" commandeerable="false" capturable="false" sector="$Closest_ANT_Sector">
                    <owner exact="faction.antigone" overridenpc="true" />
                    <pilot>
                      <select faction="faction.antigone" tags="tag.elitepilot"/>
                    </pilot>
                    <loadout>
                      <level exact="1.0"/>
                    </loadout>
                    <safepos value="$ShipOffset" min="200m" max="500m"/>
                    <!--rotation value="$FacingRelayStation"/-->
                  </create_ship>

                  <add_to_group groupname="$AntigoneFleet" object="$CurrentShip"/>

                  <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                    <param name="commander" value="$ANTActorShip"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>
                </do_all>
              </actions>
              <patch sinceversion="2">
                <do_if value="Ch_6_Assassinate_Saman.state != cuestate.complete and Ch_6_Pirate_Setup.state != cuestate.complete">
                  <do_if value="$ANTActorShip.isoperational">
                    <set_object_min_hull object="$ANTActorShip" exact="60"/>
                  </do_if>
                </do_if>
              </patch>
            </cue>

            <cue name="Ch_6_DecisionsDialogue">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch6_Story_Reminder">
                  <cues>
                    <cue name="Ch6_Story_Reminder_Ref" ref="Story_Reminder">
                      <param name="Actor"       value="$DalBusta"/>
                      <param name="CutsceneKey" value="$DalCutsceneKey"/>
                      <param name="Lines"       value="[[30227659]]"/>
                      <param name="CancelCue"   value="Ch_6_Cancel_Chapter"/>
                      <param name="Delay"       value="35min"/>
                      <!--
                      (Curious)How are things going? If we don't make sure we are covered on this Terran business, it will come back and bite us.
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch_6_Dal_Section_Covert_Ops" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="($HQ? and (player.entity.room == $DalBusta.room) and not $PlayerChose?)"/>
                  </conditions>
                  <actions>
                    <add_player_choice section="story_covert_operations" selectable="true"
                                       text="{30227,30227001}"/>

                    <add_player_choice section="main" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                  </actions>
                </cue>

                <cue name="Ch_6_Dal_Player_Conversation_Started">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                </cue>

                <cue name="Ch_6_Dal_Choose_Side_Dialog" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section section="story_covert_operations"/>
                      <event_conversation_returned_to_section section="story_covert_operations" />
                    </check_any>
                    <check_value value="event.object == $DalBusta"/>
                  </conditions>
                  <actions>
                    <!-- Voice Lines -->
                    <do_if value="not $ShowPlayerChoices?">
                    </do_if>
                    <do_if value="event.param2 == null and @$ShowPlayerChoices != 'decision'">
                      <do_if value="Ch_6_Dal_Player_Conversation_Started.state == cuestate.waiting">
                        <signal_cue cue="Ch_6_Dal_Player_Conversation_Started"/>
                      </do_if>
                      <set_value name="$ShowPlayerChoices" exact="'main'"/>
                      <do_if value="not $Ch_6FirstTimeDone?">
                        <add_npc_line speaker="$DalBusta" hidechoices="true">
                          <text line="30227601" comment="While you were getting here, I reviewed all our options."/>
                          <text line="30227602" comment="This is a political minefield we got ourselves involved in here, and I felt we needed an accurate picture."/>
                          <text line="30227603" comment="We could hand over the information to the Terran government. After all, we were contracted by them."/>
                          <text line="30227604" comment="Alternatively, we could turn towards the Antigone Republic, let them know what has happened, and return the evidence."/>
                          <text line="30227605" comment="Finally, I could destroy this information. Back out and pretend this whole mess never happened."/>
                        </add_npc_line>
                        <set_value name="$Ch_6FirstTimeDone"/>
                      </do_if>
                      <do_else>
                        <add_npc_line speaker="$DalBusta" hidechoices="true">
                          <text line="30227601" comment="While you were getting here, I reviewed all our options."/>
                        </add_npc_line>
                      </do_else>
                    </do_if>
                    <do_elseif value="event.param2 == 'ch6_main'">
                      <set_value name="$ShowPlayerChoices" exact="'main'"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch6_ter_question'">
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30227606" comment="We would adhere to the initial plan."/>
                        <text line="30227607" comment="You meet with the Terran Secret Service Contact, and you hand over the evidence."/>
                        <text line="30227608" comment="The Terran Protectorate gains their leverage and we get paid."/>
                        <text line="30227609" comment="From what I have gathered they will use the information to sow distrust between the Argon Federation and the Antigone Republic."/>
                        <text line="30227610" comment="The created tension would lead to all cessation of trade between Argon and Antigone, but the Protectorate will not use this information to escalate the situation."/>
                        <text line="30227611" comment="The Terran’s first priority is still the Xenon, so this leverage is more of a long-term insurance to keep their rivals weak."/>
                      </add_npc_line>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch6_ant_question'">
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30227612" comment="We contact Saman Red, the Antigone Republic Official."/>
                        <text line="30227613" comment="He is already involved in investigating the Terrans, so all we need to do is hand over the evidence."/>
                        <text line="30227614" comment="The Terran Protectorate won’t be happy, but I think I can twist this so that they won't trace the leak back to us."/>
                        <text line="30227615" comment="The Antigone Republic and the Argon Federation will remain close allies."/>
                        <text line="30227616" comment="Should Saman go public with this, I cannot imagine the Federation taking such Terran interference lightly."/>
                        <text line="30227617" comment="There is a good chance these tensions will escalate into open war."/>
                        <text line="30227618" comment="Some would argue it is the right thing to do, but we wouldn't get paid, and the ensuing open conflict would be unpredictable, and result in many lost lives."/>
                      </add_npc_line>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch6_neut_question'">
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30227619" comment="It's easy."/>
                        <text line="30227620" comment="The Terrans don’t know for certain that we managed to access the servers, just that we managed to dock at the station."/>
                        <text line="30227621" comment="All we have to do is tell them we did not get anything off the servers, and quietly erase all the data we managed to get our hands on."/>
                        <text line="30227622" comment="Sure, we won’t get paid, and the Terrans will likely just hire someone else to do their dirty work, but we come out clean."/>
                        <text line="30227623" comment="More importantly, the relations between factions won't change, for better or for worse. Business as usual."/>
                      </add_npc_line>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch6_ter'">
                      <set_value name="$ShowPlayerChoices" exact="'done'"/>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30227625" comment="Okay."/>
                        <text line="30227626" comment="Just follow through with the final debrief."/>
                        <text line="30227627" comment="I hope you made the right choice."/>
                      </add_npc_line>
                      <signal_cue_instantly cue="Ch_6_Debrief_Decision" param="'Protectorate'"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch6_ant'">
                      <set_value name="$ShowPlayerChoices" exact="'done'"/>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30227628" comment="You will need to meet with the Antigone Republic Official, then."/>
                        <text line="30227629" comment="I will call in advance and set things up."/>
                        <text line="30227630" comment="I’ll tell the Terrans their Sandwell Archive Pass didn't manage to pull of any info."/>
                        <text line="30227631" comment="Hold on for dear life, we are about to blow this thing wide open."/>
                      </add_npc_line>
                      <signal_cue_instantly cue="Ch_6_Debrief_Decision" param="'Republic'"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch6_neut'">
                      <set_value name="$ShowPlayerChoices" exact="'done'"/>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30227632" comment="Let me take these files off your hands."/>
                        <text line="30227633" comment="You know, for what it’s worth, I think this might have been for the best. "/>
                        <text line="30227634" comment="Let me make some calls."/>
                        <text line="30227630" comment="I’ll tell the Terrans their Sandwell Archive Pass didn't manage to pull of any info."/>
                      </add_npc_line>
                      <signal_cue_instantly cue="Ch_6_Debrief_Decision" param="'Neutral'"/>
                    </do_elseif>

                    <!-- (Back) out of Player Choices -->
                    <do_if value="($ShowPlayerChoices == 'main')">
                      <add_player_choice section="stories" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                      <add_player_choice section="story_covert_operations" choiceparam="'ch6_ter_question'"          highlighted="false" text="{30227,30227601}" comment="Siding with the Protectorate?"/>
                      <add_player_choice section="story_covert_operations" choiceparam="'ch6_ant_question'" highlighted="false" text="{30227,30227602}" comment="Siding with the Federation?"/>
                      <add_player_choice section="story_covert_operations" choiceparam="'ch6_neut_question'"             highlighted="false" text="{30227,30227603}" comment="Destroying Evidence?"/>
                      <add_player_choice_sub section="story_covert_operations_decision_briefing"    highlighted="true"  text="{30227,30227604}" comment="(Player Choice)I have decided"/>
                    </do_if>
                    <do_elseif value="($ShowPlayerChoices == 'decision')">
                      <do_if value="md.$DLCBoronFactions? and md.$DLCBoronFactions.count ge 1" comment="Boron DLC active?">
                        <do_if value="md.Setup_DLC_Boron.Boron_Gates_Open_KingdomEnd.state != cuestate.waiting
                                      and md.Story_Boron.Diplomacy_Update_Argon.state != cuestate.waiting
                                      and  md.$DLCBoronFactions.{1}.hasrelation.friend.{faction.argon}">
                          <set_value name="$Ch6_BoronQueendomUnlocked"/>
                        </do_if>
                      </do_if>
                      
                      <add_player_choice section="story_covert_operations" choiceparam="'ch6_main'" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                      <add_player_choice section="story_covert_operations" choiceparam="'ch6_ter'"              highlighted="true"  text="{30227,30227605}" tooltip="{30227,6021}" comment="(Player Choice)Support Terrans"/>
                      <add_player_choice section="story_covert_operations" choiceparam="'ch6_ant'"            highlighted="true"  text="{30227,30227606}" tooltip="if $Ch6_BoronQueendomUnlocked? then {30227,6024} else {30227,6022}" comment="(Player Choice)Support Argon"/>
                      <add_player_choice section="story_covert_operations" choiceparam="'ch6_neut'"            highlighted="true"  text="{30227,30227607}" tooltip="{30227,6023}" comment="(Player Choice)Destroy the evidence"/>
                      <remove_value name="$Ch6_BoronQueendomUnlocked"/>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Ch_6_Dal_Choose_Side_Dialog_Briefing" instantiate="true" version="2">
                  <!-- Show the Mission Briefing -->
                  <conditions>
                    <event_conversation_next_section section="story_covert_operations_decision_briefing"/>
                    <check_value value="event.object == $DalBusta"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$DalBusta" hidechoices="true">
                      <text line="30227624" comment="So, what are we going to do?"/>
                    </add_npc_line>

                    <update_mission cue="$MissionCue" description="{30227,6005} + '\n\n\n' + {30227,6006} + '\n\n' + {30227,6007} + '\n\n' + {30227,6008}"/>

                    <do_if value="not @$SecretServiceActorShip.isoperational">
                      <signal_cue cue="Setup_Ch5_SecretServiceActorShip"/>
                    </do_if>

                    <open_conversation_menu menu="MissionBriefingMenu" param="[0, 0, $MissionCue, false]" />
                    <set_value name="$ShowPlayerChoices" exact="'decision'"/>
                  </actions>
                  <patch sinceversion="2">
                    <find_object name="$DuplicateSweetJacks" multiple="true" macro="macro.ship_arg_l_trans_container_01_a_macro" space="player.galaxy" trueowner="faction.terran"/>
                    <do_all exact="$DuplicateSweetJacks.count" counter="$i" reverse="true">
                      <do_if value="not ($SecretServiceActor.hascontext.{$DuplicateSweetJacks.{$i}})">
                        <set_object_min_hull object="$DuplicateSweetJacks.{$i}" exact="0"/>
                        <destroy_object object="$DuplicateSweetJacks.{$i}"/>
                      </do_if>
                      <do_else>
                        <set_value name="$SecretServiceActorShip" exact="$DuplicateSweetJacks.{$i}"/>
                      </do_else>
                    </do_all>
                  </patch>
                  <cues>
                    <cue name="BriefingStarted">
                      <conditions>
                        <check_any>
                          <event_briefing_started cue="$MissionCue"/>
                          <event_briefing_submission_selected cue="$MissionCue"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <set_value name="$RenderTarget" exact="event.param.{1}"/>

                        <set_value name="$OpenHolomap"/>
                        <set_value name="$HolomapReplay" exact="false"/>

                        <set_value name="$MapTarget" exact="$SecretServiceSector"/>


                        <debug_text text="'Briefing started'" chance="$DebugChance"/>
                      </actions>
                      <cues>
                        <cue name="DisplayHolomap" onfail="cancel">
                          <conditions>
                            <check_value value="$OpenHolomap?"/>
                          </conditions>
                          <actions>
                            <do_if value="not $HoloMap?">
                              <add_holomap name="$HoloMap" rendertarget="$RenderTarget"/>
                            </do_if>
                            <remove_value name="$OpenHolomap" />
                          </actions>
                          <cues>
                            <cue name="HolomapRef" ref="md.LIB_HolomapTarget.Start">
                              <param name="EndSignalCue" value="HolomapEnd"/>

                              <param name="HoloMap" value="$HoloMap" />
                              <param name="Components" value="[player.entity, $Closest_ANT_Sector, $SecretServiceStation]"/>
                              <param name="ShowUnknown" value="true"/>
                              <param name="PanTime" value="3s"/>
                              <param name="ZoomTime" value="3s"/>
                              <param name="IsReplay" value="true"/>

                              <param name="verbosedebugchance" value="$DebugChance"/>
                            </cue>
                            <cue name="HolomapEnd">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <debug_text text="'Holomap animation end'" chance="$DebugChance"/>
                              </actions>
                              <cues>
                                <cue name="PlayBriefingCutscene" onfail="cancel">
                                  <actions>
                                    <do_if value="$HoloMap?">
                                      <remove_holomap />
                                      <remove_value name="$HoloMap"/>
                                    </do_if>

                                    <set_value name="$BriefingCutsceneStarted"/>

                                    <set_value name="$CutsceneKey" exact="'OrbitIndefinitely'"/>
                                    <play_cutscene key="$CutsceneKey" rendertarget="$RenderTarget">
                                      <param name="targetobject" object="player.zone"/>
                                    </play_cutscene>

                                  </actions>
                                  <cues>
                                    <cue name="ReplayHoloMap">
                                      <delay exact="12s"/>
                                      <actions>
                                        <!--Temp value. This is used to identify if a cutscene for this mission is still playing.-->
                                        <remove_value name="$BriefingCutsceneStarted"/>

                                        <stop_cutscene key="$CutsceneKey"/>

                                        <set_value name="$HolomapReplay" exact="true"/>
                                        <set_value name="$OpenHolomap"/>
                                        <reset_cue cue="DisplayHolomap"/>
                                      </actions>
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="BriefingStopped">
                          <conditions>
                            <check_any>
                              <event_briefing_cancelled cue="$MissionCue"/>
                              <event_briefing_submission_unselected cue="$MissionCue"/>
                            </check_any>
                          </conditions>
                          <actions>

                            <do_if value="$HoloMap?">
                              <remove_holomap />
                              <remove_value name="$HoloMap"/>
                            </do_if>

                            <do_if value="$BriefingCutsceneStarted?">
                              <!--Temp value. This is used to identify if a cutscene for this mission is still playing.-->
                              <remove_value name="$BriefingCutsceneStarted"/>

                              <stop_cutscene key="$CutsceneKey"/>
                            </do_if>

                            <debug_text text="'Briefing canceled'" chance="$DebugChance"/>
                            <reset_cue cue="BriefingStarted"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>


                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Patch_Reset_ANTFleet" onfail="cancel">
              <conditions>
                <check_value value="$Patch_Ch6_ResetAntFleet?"/>
              </conditions>
              <actions>
                <signal_cue cue="ANT_Fleet_Setup"/>
                <signal_cue cue="Patch_ResetGuidance" check="false"/>
              </actions>
            </cue>

            <cue name="Patch_Reset_TERShip" onfail="cancel">
              <conditions>
                <check_value value="$Patch_Ch6_ResetTERShip?"/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="Setup_Ch5_SecretServiceActorShip"/>

                <create_position name="$SecretServicePos" x="0.8" z="-2.5" y="0.72" space="$SecretServiceActorShip.controlroom"/>
                <create_rotation name="$SecretServiceRot" yaw="-170.0deg"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SecretServiceActor,
                                                                                                      table[
                                                                                                      $requestercue = $MissionCue,
                                                                                                      $location = $SecretServiceActorShip.controlroom,
                                                                                                      $position = $SecretServicePos,
                                                                                                      $rotation = $SecretServiceRot,
                                                                                                      $priority = 110,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                <remove_value name="$Patch_Ch6_ResetTERShip"/>
                <signal_cue cue="Patch_ResetGuidance" check="false"/>
              </actions>
            </cue>

            <cue name="Patch_ResetGuidance" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="3s"/>
              <actions>
                <do_if value="$PlayerChose == 'Republic'">
                  <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,6011}" text="$SamanActor.knownname" object="$SamanActor" updatebriefing="true"/>
                </do_if>
                <do_else>
                  <do_if value="Ch_6_Assassinate_Saman.state == cuestate.complete and Ch_6_TER_Debrief.state != cuestate.complete">
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.kill" object="$SamanActor" encyclopedia="$SamanActor.container" updatebriefing="true"/>
                  </do_if>
                  <do_else>
                    <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,6009}" object="$SecretServiceActor" updatebriefing="true"/>
                  </do_else>
                </do_else>
                <remove_value name="$Patch_Ch6_ResetAntFleet"/>
              </actions>
              <patch sinceversion="2">
                <do_if value="$PlayerChose == 'Protectorate'">
                  <do_if value="Ch_6_Assassinate_Saman.state == cuestate.complete and Ch_6_TER_Debrief.state != cuestate.complete">
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.kill" object="$SamanActor" encyclopedia="$SamanActor.container" updatebriefing="true"/>
                  </do_if>
                  <do_else>
                    <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,6009}" object="$SecretServiceActor" updatebriefing="true"/>
                  </do_else>
                </do_if>
              </patch>
            </cue>

            <cue name="Ch_6_Debrief_Decision" version="3">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!--cutscene cleanup-->
                <do_if value="$HoloMap?">
                  <remove_holomap />
                  <remove_value name="$HoloMap"/>
                </do_if>

                <do_if value="$BriefingCutsceneStarted?">
                  <!--Temp value. This is used to identify if a cutscene for this mission is still playing.-->
                  <remove_value name="$BriefingCutsceneStarted"/>

                  <stop_cutscene key="$CutsceneKey"/>

                  <do_if value="$CutsceneCluster.exists">
                    <destroy_object object="$CutsceneCluster"/>
                  </do_if>
                  <do_if value="$CutsceneShip.exists">
                    <destroy_object object="$CutsceneShip"/>
                  </do_if>
                </do_if>

                <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                <set_value name="$PlayerChose" exact="event.param"/>

                <do_if value="$PlayerChose != 'Neutral'">
                  <create_position name="$SecretServicePos" x="0.8" z="-2.5" y="0.72" space="$SecretServiceActorShip.controlroom"/>
                  <create_rotation name="$SecretServiceRot" yaw="-170.0deg"/>

                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SecretServiceActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $SecretServiceActorShip.controlroom,
                                                                                                      $position = $SecretServicePos,
                                                                                                      $rotation = $SecretServiceRot,
                                                                                                      $priority = 110,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                </do_if>
                
                <set_value name="$PlayerContainer" exact="player.entity.container"/>
                <do_if value="$PlayerChose == 'Protectorate'">
                  <update_mission cue="$MissionCue" description="{30227,6004}" type="missiontype.plot" icon="'briefing_deliah_shiratori_01'" iconcaption="$SecretServiceActor.knownname"/>
                  <signal_cue_instantly cue="ANT_Fleet_Setup"/>
                  <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,6009}" object="$SecretServiceActorShip" updatebriefing="true"/>
                  <set_value name="$ObjectiveShip" exact="$SecretServiceActorShip"/>
                  <set_userdata storystate="'story_covert_ops_argon_schism'" value="1"/>
                </do_if>
                <do_elseif value="$PlayerChose == 'Republic'">
                  <update_mission cue="$MissionCue" description="{30227,6003}" type="missiontype.plot" icon="'briefing_saman_red_01'" faction="faction.antigone" iconcaption="$SamanActor.knownname"/>
                  <signal_cue_instantly cue="ANT_Fleet_Setup"/>
                  <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,6010}" object="$ANTActorShip" updatebriefing="true"/>
                  <set_value name="$ObjectiveShip" exact="$ANTActorShip"/>
                  <set_userdata storystate="'story_covert_ops_war'" value="1"/>
                </do_elseif>
                <do_elseif value="$PlayerChose == 'Neutral'">
                  <remove_inventory ware="ware.inv_encrypted_espionagedocument"/>
                  <remove_mission cue="$MissionCue" type="completed"/>
                  <set_userdata storystate="'story_covert_ops_neutral'" value="1"/>
                  <cancel_cue cue="SecretServiceActor_Dialog_Option_Story"/>
                </do_elseif>
              </actions>
              <patch sinceversion="2">
                <debug_text text="'Patching to check for dead Saman'" chance="$DebugChance"/>
                <do_if value="(not ($SecretServiceActorShip.isoperational) and ((Ch_6_ANT_CleanUp.state != cuestate.complete) or (Ch_6_TER_Debrief.state != cuestate.complete))) and ($PlayerChose != 'Neutral')">
                  <set_value name="$Patch_Ch6_ResetTERShip"/>
                </do_if>

                <do_if value="($PlayerChose == 'Republic') and (Ch_6_Meeting_Finished.state != cuestate.complete)">
                  <debug_text text="'Meeing not yet finished'" chance="$DebugChance"/>
                  <do_if value="not $ANTActorShip.isoperational">
                    <debug_text text="'Saman has been destroyed'" chance="$DebugChance"/>
                    <do_all exact="$AntigoneFleet.count" counter="$i" reverse="true">
                      <create_order id="'MoveDie'" object="$AntigoneFleet.{$i}" immediate="true">
                        <param name="mintime" value="10s"/>
                      </create_order>
                      <remove_from_group group="$AntigoneFleet" object="$AntigoneFleet.{$i}"/>
                    </do_all>
                    <reset_cue cue="ANT_Fleet_Setup"/>
                    <set_value name="$Patch_Ch6_ResetAntFleet"/>
                  </do_if>
                </do_if>
                <do_elseif value="($PlayerChose == 'Protectorate') and (Ch_6_Assassinate_Saman.state != cuestate.complete)">
                  <debug_text text="'You have not yet been ordered to kill Saman'" chance="$DebugChance"/>
                  <do_if value="not $ANTActorShip.isoperational">
                    <debug_text text="'Ship has been destroyed'" chance="$DebugChance"/>
                    <do_all exact="$AntigoneFleet.count" counter="$i" reverse="true">
                      <create_order id="'MoveDie'" object="$AntigoneFleet.{$i}" immediate="true">
                        <param name="mintime" value="10s"/>
                      </create_order>
                      <remove_from_group group="$AntigoneFleet" object="$AntigoneFleet.{$i}"/>
                    </do_all>
                    <reset_cue cue="ANT_Fleet_Setup"/>
                    <set_value name="$Patch_Ch6_ResetAntFleet"/>
                  </do_if>
                </do_elseif>
              </patch>
              <patch sinceversion="3">
                <!-- The Neutral Ending would place but not remove the Secret Service Actor on the Sweet Jack -->
                <do_if value="$PlayerChose == 'Neutral'">
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $SecretServiceActor, $MissionCue]"/>
                </do_if>
              </patch>
              <cues>

                <cue name="Ch_6_Player_Undocked" checkinterval="1s">
                  <conditions>
                    <check_value value="not player.entity.hascontext.{$PlayerContainer}"/>
                  </conditions>
                  <actions>
                    <do_if value ="$PlayerChose == 'Neutral'">
                      <signal_cue cue="Ch_6_Neutral_Dialogue"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch_6_MoveTo_Objective"/>
                    </do_else>
                  </actions>
                </cue>
                <cue name="Ch_6_Neutral_Dialogue" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="6s"/>
                  <actions>
                    <unlock_achievement name="COH_PLOT_COVERT_NONE"/>
                    <write_incoming_message title="{30227,10401}" text="{30227,10402}" source="{30227,10403}" highpriority="false" comment="Neutral Wrap Email"/>
                    <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                      <param name="Object" value="$SecretServiceActorShip"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                    <create_order object="$SecretServiceActorShip" id="'MoveDie'" immediate="true">
                      <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                    </create_order>

                    <!-- Clear story-specific faction pairing locks for the involved factions -->
                    <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.antigone" flags="dlc2_1"/>
                    <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.terran" flags="dlc2_1"/>
                    <clear_faction_diplomacy_exclusion faction="faction.terran" otherfaction="faction.antigone" flags="dlc2_1"/>
                  </actions>
                  <patch sinceversion="2" state="complete">
                    <!-- Clear story-specific faction pairing locks for the involved factions -->
                    <set_value name="$Terran_Diplomacy_AllFactions_Patch"/>
                  </patch>
                  <patch sinceversion="2" state="cancelled">
                    <!-- Clear story-specific faction pairing locks for the involved factions -->
                    <set_value name="$Terran_Diplomacy_AllFactions_Patch"/>
                  </patch>
                  <cues>

                    <cue name="Ch_6_NeutralChoice_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$SecretServiceActor, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$SecretServiceCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                              [[30227608],[30227609],[30227610],[30227611],[30227612]],
                                                              [[30227636],[30227637]]
                                                              ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[null, Ch_6_Cancel_Chapter]"/>
                      <!--
                          SSC:
                          Dal just reached out to us.
                          It is regretable this operation did not pan out.
                          For now we have recalled all of our field agents, and are analysing what cause this operation to go wrong.
                          After carrying out many tasks for us, the risk of someone connecting you to our government increases with each passing time.
                          We will not approach you for further operations targeting the Argon Federation.
                          Dal:
                          Looks like they bought it.
                          Nontheless, perhaps it would be wise to watch your back for a bit. You never know.
                          -->
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch_6_MoveTo_Objective">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch_6_InSameSector" checkinterval="2s">
                  <conditions>
                    <check_any>
                      <check_value value="player.ship.sector == $ANTActorShip.sector"/>
                      <check_value value="(player.ship.gatedistance.{$ObjectiveShip.sector} ge 0) and (player.ship.gatedistance.{$ObjectiveShip.sector} le 1)" comment="disconnected sector returns -1"/>
                    </check_any>
                  </conditions>
                  <cues>

                    <cue name="Ch_6_ProtectorateChoice_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$SecretServiceActor, if $PlayerChose == 'Protectorate' then $SecretServiceActor else $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$SecretServiceCutsceneKey, if $PlayerChose == 'Protectorate' then $SecretServiceCutsceneKey else $DalCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                              [[30227601],[30227602],[30227603],[30227604],[30227605],[30227606]],
                                                              [[if $PlayerChose == 'Protectorate' then 30227607 else 30227635]]
                                                              ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[Ch_6_ANT_Assassination, null]"/>
                      <!--
                          SSC:
                          One of our agents embedded in the Republic institutions uncovered a slight complication.
                          That nosey Antigone Republic official, Saman Red, has made some connections he should not have. 
                          I knew we should have played it closer to our chest.
                          He is on his way to meet with the Argon Federation Counterespionage department to reveal what he knows.
                          We need to ensure that under no circumstances does he make it to that meeting. 
                          If they realise the Secret Service’s role in this operation, we won’t be able to leverage the stolen information.
                          [if TER Choice] Take him out.
                          [if ANT Choice] Dal: Oh no, we need to hurry.
                          -->
                    </cue>

                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch_6_ANT_Assassination">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch_6_Mission_Setup">
                  <actions>
                    <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                    <do_if value="$PlayerChose == 'Republic'">
                      <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,6011}" text="$SamanActor.knownname" object="$SamanActor" updatebriefing="true"/>
                      <signal_cue cue="Ch_6_Protect_Saman"/>
                    </do_if>
                    <do_elseif value="$PlayerChose == 'Protectorate'">
                      <signal_cue cue="Ch_6_Assassinate_Saman"/>
                    </do_elseif>
                  </actions>
                </cue>
                <cue name="Ch_6_Protect_Saman">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch_6_Saman_Meeting_Conversation" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$SamanActor"/>
                      </conditions>
                      <actions>
                        <do_if value="not $SamanChapter6_Conv?">
                          <allow_conversation_escape enabled="false"/>
                          <add_npc_line speaker="$SamanActor" hidechoices="true">
                            <text line="30227604" comment="So, we meet again."/>
                            <text line="30227605" comment="The way we left things last time did not sit right with me, so I started digging."/>
                            <text line="30227606" comment="(Tense)Turns out I was right to do so, this conspiracy goes deep."/>
                            <text line="30227607" comment="(Teacherly scolding)You should be ashamed for the part you played in all of this."/>
                            <text line="30227608" comment="(More amenable)However, without your help I would not be able to prove the Protectorate's involvement."/>
                            <text line="30227609" comment="In exchange for handing over the evidence that allows me to prove the Terran meddling, I will keep your name out of our reports."/>
                            <text line="30227610" comment="Now, you best stay vigilant while I send word to the Argon Federation."/>
                          </add_npc_line>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$SamanActor" hidechoices="true">
                            <text line="30227611" comment="(Tense)Get out there! Keep them busy while I notify the Argon."/>
                          </add_npc_line>
                        </do_else>

                      </actions>
                      <cues>

                        <cue name="Ch_6_Pirate_Setup" onfail="cancel">
                          <conditions>
                            <check_value value="not $SamanChapter6_Conv?"/>
                          </conditions>
                          <delay exact="0.5s"/>
                          <actions>
                            <set_object_min_hull object="$ANTActorShip" exact="0"/>
                            
                            <get_safe_pos result="$PirateAmbushPos" sector="$ANTActorShip.sector" object="$ANTActorShip" min="40km" max="45km"  radius="5km"/>

                            <create_ship name="$SCAFlagship" macro="ship_tel_l_destroyer_02_a_macro" commandeerable="false" capturable="false" sector="$ANTActorShip.sector">
                              <owner exact="faction.scaleplate" overridenpc="true"/>
                              <pilot>
                                <select faction="faction.scaleplate" tags="tag.elitepilot"/>
                              </pilot>
                              <loadout>
                                <level exact="1.0"/>
                              </loadout>
                              <people ref="teladi_elite_military_crew"/>
                              <orientation refobject="$ANTActorShip" orientation="look_at"/>
                              <position value="$PirateAmbushPos"/>
                            </create_ship>

                            <create_order object="$SCAFlagship" id="'Follow'" immediate="true">
                              <param name="target" value="$ANTActorShip"/>
                            </create_order>

                            <create_group groupname="$ScaleplateFleet"/>
                            <add_to_group groupname="$ScaleplateFleet" object="$SCAFlagship"/>

                            <set_value name="$ScaleplateFleetComposition"   exact="[
                                                [ macro.ship_arg_l_destroyer_02_a_macro],
                                                [ macro.ship_arg_m_bomber_02_a_macro],
                                                [ macro.ship_arg_m_bomber_02_a_macro],
                                                       
                                                [ macro.ship_tel_s_fighter_01_a_macro],
                                                [ macro.ship_tel_s_fighter_01_a_macro],
                                                [ macro.ship_tel_s_fighter_01_a_macro],
                                                [ macro.ship_tel_s_fighter_01_a_macro]
                                                ]" />

                            <do_all exact="$ScaleplateFleetComposition.count" counter="$f">
                              <create_ship name="$CurrentShip" macro="$ScaleplateFleetComposition.{$f}.{1}" commandeerable="false" capturable="false" sector="$ANTActorShip.sector">
                                <owner exact="faction.scaleplate" overridenpc="true" />
                                <pilot>
                                  <select faction="faction.scaleplate" tags="tag.elitepilot"/>
                                </pilot>
                                <loadout>
                                  <level exact="1.0"/>
                                </loadout>
                                <orientation refobject="$ANTActorShip" orientation="look_at"/>
                                <safepos value="$PirateAmbushPos" min="2m" max="4km" radius="600m"/>
                              </create_ship>

                              <add_to_group groupname="$ScaleplateFleet" object="$CurrentShip"/>

                              <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                                <param name="commander" value="$SCAFlagship"/>
                                <param name="assignment" value="assignment.attack"/>
                                <param name="cancelorders" value="true"/>
                              </create_order>
                            </do_all>

                            <set_relation_boost object="$ANTActorShip" otherobject="$SCAFlagship" value="-1" silent="true"/>

                            <do_all exact="$ScaleplateFleet.count" counter="$i">
                              <set_relation_boost object="$ScaleplateFleet.{$i}" faction="faction.player" value="-1" silent="true" decay="0.000000001"/>
                            </do_all>
                          </actions>
                        </cue>

                      </cues>
                    </cue>
                    <cue name="Ch_6_Meeting_Finished">
                      <conditions>
                        <event_conversation_finished actor="$SamanActor"/>
                      </conditions>
                      <actions>
                        <set_value name="$SamanChapter6_Conv"/>
                        <remove_inventory ware="ware.inv_encrypted_espionagedocument"/>
                      </actions>
                      <delay exact="4s"/>
                      <actions>
                        <!-- Disable MissionDND: Defend Saman -->
                        <append_to_list name="md.$MissionDND" exact="Ch_6_Meeting_Finished"/>
                        <signal_cue cue="Ch_6_PirateAttack"/>
                      </actions>
                      <cues>

                        <cue name="Ch_6_PirateApproach_Dal_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30227646],[30227647],[30227648],[if $FollowingFailed? then 30227649 else null], [30227650],[30227651]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          Dal:
                          He’s right.
                          I am picking up several Scale Plate ships heading straight towards us.
                          Looks like the Terrans didn’t trust us to clean this up right, so they sent reinforcements. 
                          You need to get out there and shoot those guys down to shut them up.
                          If they get word back to the Terran Secret Service, they will connect us to Saman.
                          -->
                        </cue>
                        <cue name="Ch_6_PirateAttack" version="2">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="3s"/>
                          <actions>
                            <cancel_all_orders object="$SCAFlagship"/>
                            <create_order id="'Patrol'" object="$SCAFlagship" default="true">
                              <param name="space" value="$SCAFlagship.sector"/>
                            </create_order>
                            <create_order id="'Attack'" name="$attackOrder" object="$SCAFlagship" immediate="true">
                              <param name="primarytarget" value="$ANTActorShip"/>
                              <param name="secondarytargets" value="null" />
                              <param name="pursuetargets" value="true"/>
                              <param name="allowothertargets" value="false"/>
                              <param name="checkrelation" value="false"/>
                              <param name="debugchance" value="$DeepDebugChance"/>
                            </create_order>

                            <cancel_all_orders object="$ANTActorShip"/>
                            <create_order id="'Attack'" name="$attackOrder" object="$ANTActorShip" immediate="true">
                              <param name="primarytarget" value="$SCAFlagship"/>
                              <param name="secondarytargets" value="$ScaleplateFleet"/>
                              <param name="pursuetargets" value="true"/>
                              <param name="allowothertargets" value="false"/>
                              <param name="checkrelation" value="false"/>
                              <param name="debugchance" value="$DeepDebugChance"/>
                            </create_order>

                            <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.protect" text="{30227,6012}" group="$ScaleplateFleet" updatebriefing="true"/>
                          </actions>

                          <patch sinceversion="2">
                            <!-- remove additional pirates that were spawned through instantiation error-->
                            <find_ship_by_true_owner name="$ScalePlateShips" multiple="true" space="$ANTActorShip.sector" faction="faction.scaleplate">
                              <match_distance object="$ANTActorShip" max="100km"/>
                            </find_ship_by_true_owner>
                            <do_all exact="$ScalePlateShips.count" counter="$f" reverse="true">
                              <do_if value="not $ScaleplateFleet.indexof.{$ScalePlateShips.{$f}}">
                                <destroy_object object="$ScalePlateShips.{$f}"/>
                              </do_if>
                            </do_all>
                            <do_if value="$ScaleplateFleet.count gt 8">
                              <do_all exact="$ScaleplateFleet.count - 8" counter="$f" reverse="true">
                                <destroy_object object="$ScaleplateFleet.{$f}"/>
                              </do_all>
                            </do_if>
                            <do_if value="$ANTActorShip.isoperational">
                              <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.protect" text="{30227,6012}" group="$ScaleplateFleet" updatebriefing="true"/>
                            </do_if>
                            <do_else>
                              <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.kill" text="{30227,6013}" group="$ScaleplateFleet" updatebriefing="true"/>
                            </do_else>
                          </patch>
                          <cues>
                            <cue name="Ch_6_Saman_Death">
                              <conditions>
                                <event_object_destroyed object="$ANTActorShip"/>
                              </conditions>
                              <actions>
                                <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.kill" text="{30227,6013}" group="$ScaleplateFleet" updatebriefing="true"/>
                              </actions>
                              <cues>

                                <cue name="Ch_6_SamanDied_Dal_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$DalBusta"/>
                                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                  <param name="DelayInitial"      value="2s"/>
                                  <param name="Lines"             value="[[30227652],[30227653]]"/>
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="null"/>
                                  <!--
                                  Dal:
                                  Oh no, they got him.
                                  You still need to make sure this Scaleplate scum can't get word of our involvement back to the Terran Protectorate.
                                  -->
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Ch_6_PirateShips_InstantVictory" onfail="cancel">
                              <conditions>
                                <check_value value="$ScaleplateFleet.count == 0"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch_6_PirateShips_Check"/>
                              </actions>
                            </cue>

                            <cue name="Ch_6_PirateShips_Check">
                              <conditions>
                                <check_any>
                                  <check_all>
                                    <event_object_destroyed group="$ScaleplateFleet"/>
                                    <check_value value="$ScaleplateFleet.count == 1" comment="last one destroyed"/>
                                  </check_all>
                                  <event_cue_signalled/>
                                </check_any>
                              </conditions>
                              <actions>
                                <do_if value="$ANTActorShip.isoperational">
                                  <signal_cue cue="Ch_6_SamanLived_Debrief"/>
                                </do_if>
                                <do_else>
                                  <signal_cue cue="Ch_6_SamanDied_Debrief"/>
                                </do_else>
                              </actions>
                            </cue>

                            <cue name="Ch_6_SamanLived_Debrief">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>

                                <cue name="Ch_6_BattleFinished_Dal_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$SamanActor"/>
                                  <param name="CutsceneKey"       value="$SamanCutsceneKey"/>
                                  <param name="DelayInitial"      value="5s"/>
                                  <param name="Lines"             value="[[30227612],[30227613],[30227614],[30227615],[30227616]]"/>
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="Ch_6_ANT_CleanUp"/>
                                </cue>

                              </cues>
                            </cue>


                            <cue name="Ch_6_SamanDied_Debrief">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>

                                <cue name="Ch_6_SamanDead_Dal_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$DalBusta"/>
                                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                  <param name="DelayInitial"      value="3s"/>
                                  <param name="Lines"             value="[[30227654],[30227655]]"/>
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="Ch_6_ANT_CleanUp"/>
                                </cue>

                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch_6_ANT_CleanUp" version="2">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- Enable MissionDND: Defend Saman -->
                            <remove_from_list name="md.$MissionDND" exact="Ch_6_Meeting_Finished"/>

                            <unlock_achievement name="COH_PLOT_COVERT_ARGON"/>
                            <add_faction_relation faction="faction.antigone" otherfaction="faction.player" value="0.01" reason="relationchangereason.missioncompleted"/>
                            <add_faction_relation faction="faction.argon" otherfaction="faction.player" value="0.01" reason="relationchangereason.missioncompleted"/>

                            <substitute_text text="$PaintModRewardText" source="{30004,10001}">
                              <replace string="'$MODNAME$'" with="ware.paintmod_0105.name"/>
                            </substitute_text>

                            <show_notification text="{1015,90} + '\n' + $PaintModRewardText" sound="notification_achievement" comment="Reward received"/>
                            <add_inventory entity="player.entity" ware="ware.paintmod_0105" exact="10"/>
                          </actions>
                          <delay exact="10s"/>
                          <actions>
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SamanActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = 'disconnect',
                                                                                                      $slottags = [tag.stand],
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                            <do_if value="$ANTActorShip.isoperational">
                              <create_order id="'MoveDie'" object="$ANTActorShip" immediate="true">
                                <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                              </create_order>
                            </do_if>

                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $SecretServiceActor, $MissionCue]"/>
                            <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                              <param name="Object" value="$SecretServiceActorShip"/>
                              <param name="RequesterCue" value="namespace"/>
                              <param name="DebugChance" value="$DebugChance"/>
                            </run_actions>
                            <cancel_all_orders object="$SecretServiceActorShip"/>
                            <create_order id="'MoveDie'" object="$SecretServiceActorShip" immediate="true">
                              <param name="mintime" value="60s" comment="stay alive for specified time, after it docks"/>
                            </create_order>
                            <remove_mission cue="$MissionCue" type="completed"/>
                            <signal_cue cue="Argon_Side_Impact"/>
                            <cancel_cue cue="SecretServiceActor_Dialog_Option_Story"/>
                            <signal_cue cue="Ch_6_Cancel_Chapter"/>
                          </actions>
                          <patch sinceversion="2" state="cancelled">
                            <find_object name="$DuplicateSweetJacks" multiple="true" macro="macro.ship_arg_l_trans_container_01_a_macro" space="player.galaxy" trueowner="faction.terran"/>
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $SecretServiceActor, $MissionCue]"/>
                            <do_all exact="$DuplicateSweetJacks.count" counter="$i">
                              <do_if value="not ($SecretServiceActor.hascontext.{$DuplicateSweetJacks.{$i}})">
                                <set_object_min_hull object="$DuplicateSweetJacks.{$i}" exact="0"/>
                                <destroy_object object="$DuplicateSweetJacks.{$i}"/>
                              </do_if>
                              <do_else>
                                <set_value name="$SecretServiceActorShip" exact="$DuplicateSweetJacks.{$i}"/>
                              </do_else>
                            </do_all>
                          </patch>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>
                <cue name="Ch_6_Assassinate_Saman">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_object_min_hull object="$ANTActorShip" exact="0"/>
                    <add_to_group groupname="$TargetGroup" object="$SamanActor" />
                  </actions>
                  <cues>

                    <cue name="Ch_6_Saman_Hostile_Conversation" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$SamanActor"/>
                      </conditions>
                      <actions>

                        <add_npc_line speaker="$SamanActor" hidechoices="true">
                          <text line="30227601" comment="(Disgusted)I know what you are doing!"/>
                        </add_npc_line>
                        <set_value name="$HostileSaman_Conv"/>

                      </actions>
                    </cue>

                    <cue name="SamanSpeaks_OnAttack_Speak">
                      <conditions>
                        <event_object_attacked object="$ANTActorShip"/>
                        <check_value value="event.param.isplayerowned"/>
                      </conditions>
                      <actions>
                        <!--Disable MissionDND: Saman Attacked-->
                        <append_to_list name="md.$MissionDND" exact="SamanSpeaks_OnAttack_Speak"/>
                      </actions>
                      <cues>

                        <cue name="Ch_6_TargetEncountered_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$SamanActor"/>
                          <param name="CutsceneKey"       value="$SamanCutsceneKey"/>
                          <param name="DelayInitial"      value="3s"/>
                          <param name="Lines"             value="[[if not $HostileSaman_Conv? then 30227601 else null],[30227602]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          Saman:
                          I know what you are doing!
                          You will not get away with this!
                          -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="SamanDying_Speak" checkinterval="1s">
                      <conditions>
                        <check_value value="$ANTActorShip.hullpercentage le 30"/>
                      </conditions>
                      <cues>

                        <cue name="Ch_6_TargeDying_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$SamanActor"/>
                          <param name="CutsceneKey"       value="$SamanCutsceneKey"/>
                          <param name="Lines"             value="[[30227603]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          Saman:
                          Stop, please! The people have to know!
                          -->
                        </cue>

                      </cues>
                    </cue>

                    <cue name="DestroyEntities_Ref" ref="md.RML_Destroy_Entities.DestroyEntities">
                      <param name="EndSignalCue" value="Ch_6_Saman_Killed"/>
                      <param name="MissionCue" value="$MissionCue"/>
                      <param name="StartStep" value="$ObjectiveStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing" value="true" comment="Update the briefing objective step when the objective is updated"/>

                      <param name="Targets_Param" value="$TargetGroup" />

                      <param name="DebugChance" value="$DebugChance"/>
                    </cue>
                    <cue name="Ch_6_Saman_Killed">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch_6_TargetEliminated_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$DalBusta, $SecretServiceActor, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$DalCutsceneKey, $SecretServiceCutsceneKey, $DalCutsceneKey]"/>
                          <param name="DelayInitial"      value="[6s, 1s, 2s]"/>
                          <param name="Lines"             value="[
                                                                  [[30227638]],
                                                                  [[30227613],[30227614],[30227615]],
                                                                  [[30227639],[30227640]]
                                                                  ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[null, Ch_6_TER_Debrief, null]"/>
                          <!--
                          Dal:
                          Target eliminated. The sanners are not picking up any life signs.
                          SSC:
                          Do not shed tears over the death of an enemy of the Terran Protectorate.
                          Had we not intervened, all of this would have been for naught.
                          Now, meet me on my ship to hand off the information.
                          Dal:
                          Just goes to show that it is doesn't pay to be too curious.
                          Let's go meet our client.
                          -->
                        </cue>

                        <cue name="Ch_6_TER_Debrief">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!--Enable MissionDND: Saman Attacked-->
                            <remove_from_list name="md.$MissionDND" exact="SamanSpeaks_OnAttack_Speak"/>
                            <signal_objects object="$SecretServiceActorShip" param="'LoseCover'" param2="false"/>

                            <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                            <set_objective step="$ObjectiveStep" cue="$MissionCue" action="objective.custom" customaction="{30227,6009}" object="$SecretServiceActor" updatebriefing="true"/>
                          </actions>
                          <cues>

                            <cue name="Ch_6_SecretServiceActor_Conversation" instantiate="true">
                              <conditions>
                                <event_conversation_started actor="$SecretServiceActor"/>
                              </conditions>
                              <cues>

                                <cue name="Ch_6_SecretServiceActor_Prerequisite_Conversation" instantiate="true">
                                  <conditions>
                                    <event_conversation_next_section actor="$SecretServiceActor" section="story_covert_operations"/>
                                  </conditions>
                                  <actions>
                                    <do_if value="not $Ch6_SSC_DebriefDone?">
                                      <allow_conversation_escape enabled="false"/>
                                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true">
                                        <text line="30227616" comment="I have to say, I am surprised you managed to pull this off. Quite frankly, I had my doubts."/>
                                        <text line="30227617" comment="The Terran Protectorate thanks you for your service, we will take it from here."/>
                                        <text line="30227618" comment="Naturally, your deeds will never be acknowledged by the Terran government, but you have an ally in us nonetheless."/>
                                      </add_npc_line>
                                      <set_value name="$Ch6_SSC_DebriefDone"/>
                                    </do_if>
                                    <do_else>
                                      <add_npc_line speaker="$SecretServiceActor" hidechoices="true">
                                        <text line="30227619" comment="We have nothing further to discuss. You are dismissed."/>
                                      </add_npc_line>
                                    </do_else>
                                  </actions>
                                  <cues>

                                    <cue name="Ch_6_SecretServiceActor_Prerequisite_Conversation_Finished" version="2">
                                      <conditions>
                                        <event_conversation_finished actor="$SecretServiceActor"/>
                                      </conditions>
                                      <actions>
                                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $SecretServiceActor, $MissionCue]"/>
                                        <unlock_achievement name="COH_PLOT_COVERT_TERRAN"/>
                                        <reward_player money="$RewardCredits" />

                                        <substitute_text text="$PaintModRewardText" source="{30004,10001}">
                                          <replace string="'$MODNAME$'" with="ware.paintmod_0107.name"/>
                                        </substitute_text>

                                        <add_inventory entity="player.entity" ware="ware.paintmod_0107" exact="10"/>
                                        <show_notification text="{1015,90} + '\n' + $PaintModRewardText" sound="notification_achievement" comment="Reward received"/>
                                        <add_faction_relation faction="faction.terran" otherfaction="faction.player" value="0.05" reason="relationchangereason.missioncompleted"/>

                                        <remove_inventory ware="ware.inv_encrypted_espionagedocument"/>
                                        <run_actions ref="md.LIB_Generic.RequestObjectVulnerability" comment="Ship no longer required for story">
                                          <param name="Object" value="$SecretServiceActorShip"/>
                                          <param name="RequesterCue" value="namespace"/>
                                          <param name="DebugChance" value="$DebugChance"/>
                                        </run_actions>
                                        <remove_mission cue="$MissionCue" type="completed"/>
                                        <signal_cue cue="Terran_Side_Impact"/>
                                        <cancel_cue cue="SecretServiceActor_Dialog_Option_Story"/>
                                      </actions>
                                      <patch sinceversion="2" state="cancelled">
                                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $SecretServiceActor, $MissionCue]"/>
                                        <find_object name="$DuplicateSweetJacks" multiple="true" macro="macro.ship_arg_l_trans_container_01_a_macro" space="player.galaxy" trueowner="faction.terran"/>
                                        <do_all exact="$DuplicateSweetJacks.count" counter="$i">
                                          <do_if value="not ($SecretServiceActor.hascontext.{$DuplicateSweetJacks.{$i}})">
                                            <set_object_min_hull object="$DuplicateSweetJacks.{$i}" exact="0"/>
                                            <destroy_object object="$DuplicateSweetJacks.{$i}"/>
                                          </do_if>
                                          <do_else>
                                            <set_value name="$SecretServiceActorShip" exact="$DuplicateSweetJacks.{$i}"/>
                                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $SecretServiceActor, $MissionCue]"/>
                                          </do_else>
                                        </do_all>
                                      </patch>
                                      <cues>

                                        <cue  name="Ch_6_PlayerLeft_Cleanup" checkinterval="2s">
                                          <conditions>
                                            <check_value value="not player.entity.hascontext.{$SecretServiceActorShip}"/>
                                          </conditions>
                                          <actions>
                                            <cancel_all_orders object="$SecretServiceActorShip"/>
                                            <create_order id="'MoveDie'" object="$SecretServiceActorShip" immediate="true">
                                              <param name="mintime" value="60s" comment="stay alive for specified time, after it docks"/>
                                            </create_order>
                                            <signal_cue cue="Ch_6_Cancel_Chapter"/>
                                          </actions>
                                        </cue>

                                      </cues>
                                    </cue>

                                  </cues>
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch_6_Cancel_Chapter" version="3">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <cancel_cue cue="Ch6_Covert_Debrief"/>
              </actions>
              <patch sinceversion="2" state="cancelled">
                <do_if value="$SecretServiceActorShip.isoperational">
                  <cancel_all_orders object="$SecretServiceActorShip"/>
                  <create_order id="'MoveDie'" object="$SecretServiceActorShip" immediate="true">
                    <param name="mintime" value="60s" comment="stay alive for specified time, after it docks"/>
                  </create_order>
                </do_if>
              </patch>
              <patch sinceversion="3" state="cancelled">
                <!-- Catch All to see if Delilah is placed nowhere after the plot finished -->
                <do_if value="not $SecretServiceActor.exists">
                  <set_value name="$ResetSecretServiceActor"/>
                </do_if>
                <do_else>
                  <do_if value="$SecretServiceActor.hascontext.{$SecretServiceActorShip}">
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $SecretServiceActor, namespace]"/>
                  </do_if>
                </do_else>
              </patch>
            </cue>
          </cues>
        </cue>

        <!-- Replace the SecretServiceActor -->
        <cue name="Patch_Revive_SecretServiceActor" onfail="cancel">
          <conditions>
            <check_value value="$ResetSecretServiceActor?"/>
          </conditions>
          <actions>

            <!--Find the Secret Service Bureau -->
            <find_station_by_true_owner name="$TerranStationsList" faction="faction.terran" space="player.galaxy" multiple="true"/>
            <find_object_component name="$SecretServiceRoom" object="$TerranStationsList" macro="macro.room_gen_intelligenceoffice_01_macro" class="class.room"  multiple="false"/>
            <remove_value name="$TerranStationsList"/>
            <do_if value="$SecretServiceRoom">

              <!-- Find specific slot to place actor on. -->
              <find_npc_slot name="$PotentialSlots" excludefilled="false" object="$SecretServiceRoom" multiple="true"/>
              <do_for_each in="$PotentialSlots" name="$Slot">
                <do_if value="$Slot.name == 'con_control01'">
                  <set_value name="this.$SecretServiceSlot" exact="$Slot"/>
                </do_if>
              </do_for_each>
              <!-- Slot failsafe. -->
              <do_if value="not this.$SecretServiceSlot?">
                <set_value name="this.$SecretServiceSlot" exact="$PotentialSlots.random"/>
              </do_if>

              <!-- Place actor. -->
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SecretServiceActor, table[
                                                                                                                                      $requestercue = namespace,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = this.$SecretServiceSlot,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

              <!-- Update actor cutscene key. -->
              <set_value name="$SecretServiceCutsceneKey" exact="table[$key = 'ShowNPCFace']"/>
              
              <!-- If the Yaki story currently wants to point to Delilah, update the objective -->
              <do_if value="md.Story_Yaki.Start.$SubMissionCue_A?">
                <do_if value="md.Story_Yaki.Start.$CurrentStep_A == 2">
                  <set_objective cue="md.Story_Yaki.Start.$SubMissionCue_A" action="objective.talkto" object="$SecretServiceActor" silent="true" step="2" />
                </do_if>
              </do_if>
            </do_if>
          </actions>
          <delay exact="3min"/>
          <actions>
            <!-- If no station could be found, e.g. because all docks were currently inoperable, try again after a delay. -->
            <do_if value="not $SecretServiceRoom?">
              <reset_cue cue="this"/>
            </do_if>
          </actions>
        </cue>

        <cue name="Terran_Side_Impact" version="3">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="md.$ArgonAllianceFailed"/>
          </actions>
          <delay exact="if $HasCustomGamestartSkip then 0s else 5min"/>
          <actions>
            <debug_text text="'Previous Antigone Police Faction was: ' + faction.antigone.policefaction" chance="$DebugChance"/>
            <set_faction_relation faction="faction.antigone" otherfaction="faction.argon" value="-0.032"/>

            <set_faction_police faction="faction.antigone" policefaction="faction.antigone"/>

            <debug_text text="'New Antigone Police Faction: ' + faction.antigone.policefaction" chance="$DebugChance"/>
            <do_if value="not $HasCustomGamestartSkip">
              <signal_cue cue="TER_RelationsChangeDialogue"/>
            </do_if>
          </actions>
          <delay exact="if $HasCustomGamestartSkip then 0s else 2min"/>
          <actions>
            <!-- Clear story-specific faction pairing locks for the involved factions -->
            <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.antigone" flags="dlc2_1"/>
            <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.terran" flags="dlc2_1"/>
            <clear_faction_diplomacy_exclusion faction="faction.terran" otherfaction="faction.antigone" flags="dlc2_1"/>
            
            <write_incoming_message title="{30227,10201}" text="{30227,10202}" source="{30227,10203}" highpriority="false" comment="Terran Wrap Email"/>
            <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_covert_operations_medal"/>
          </actions>
          <patch sinceversion="2">
            <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_covert_operations_medal"/>
          </patch>
          <patch sinceversion="3">
            <!-- Clear story-specific faction pairing locks for the involved factions -->
            <set_value name="$Terran_Diplomacy_AllFactions_Patch"/>
          </patch>
          <cues>

            <cue name="TER_RelationsChangeDialogue">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch_6_TERResult_Dal_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30227641],[30227642],[30227643],[30227644],[30227645]]"/>
                  <param name="IsInMission"       value="false"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                  Dal:
                  Tons of Argon data just leaked, and it appears the Federation balme the Antigone Republic.
                  Things are moving faster than expected. Relations between the Republic and the Federation are deteriorating rapidly.
                  I bet the Terran Protectorate is gleefully watching from the sidelines, as both factions grow weaker.
                  The Argon will never know who is truly responsible.
                  A job well done.
                  -->
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Argon_Side_Impact" version="6">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="if $HasCustomGamestartSkip then 0s else 5min"/>
          <actions>
            <set_faction_relation faction="faction.argon" otherfaction="faction.terran" value="-0.1"/>
            <set_faction_relation faction="faction.terran" otherfaction="faction.antigone" value="-0.1"/>
            <do_if value="not $HasCustomGamestartSkip">
              <signal_cue cue="ARG_RelationsChange_Dialogue"/>
            </do_if>
          </actions>
          <delay exact="if $HasCustomGamestartSkip then 0s else 2min"/>
          <actions>
            <write_incoming_message title="{30227,10301}" text="{30227,10302}" source="{30227,10303}" highpriority="false" comment="Argon Wrap Email"/>
            <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_covert_operations_medal"/>

            <!-- Clear story-specific faction pairing locks for the involved factions -->
            <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.antigone" flags="dlc2_1"/>
            <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.terran" flags="dlc2_1"/>
            <clear_faction_diplomacy_exclusion faction="faction.terran" otherfaction="faction.antigone" flags="dlc2_1"/>
          </actions>
          <patch sinceversion="2">
            <set_faction_relation faction="faction.argon" otherfaction="faction.terran" value="-0.1"/>
            <set_faction_relation faction="faction.terran" otherfaction="faction.antigone" value="-0.08"/>
          </patch>
          <patch sinceversion="3">
            <set_faction_relation faction="faction.terran" otherfaction="faction.antigone" value="-0.1"/>
          </patch>
          <patch sinceversion="5">
            <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_covert_operations_medal"/>
          </patch>
          <patch sinceversion="6">
            <!-- Clear story-specific faction pairing locks for the involved factions -->
            <set_value name="$Terran_Diplomacy_AllFactions_Patch"/>
          </patch>
          <cues>

            <cue name="ARG_RelationsChange_Dialogue">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch_6_ANTResult_Dal_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30227656],[30227657],[30227658]]"/>
                  <param name="IsInMission"       value="false"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                  Dal:
                  The Argon Federation is mobilising their fleets.
                  It seems like after all the tensions between the Argon and Terran governments, this incident was the spark that ignited the powder keg.
                  There should be plenty business opportunities here, for anyone shrewd enough to seize the moment...
                  -->
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

      </cues>
    </cue>

    <cue name="PatchCue_Check_ClearDiplomacyChanges_ClearAllFactions" onfail="cancel">
      <conditions>
        <check_value value="md.Diplomacy.Start.state == cuestate.complete"/>
      </conditions>
      <actions>
        <signal_cue cue="PatchCue_ClearDiplomacyChanges_ClearAllFactions" check="false"/>
      </actions>
    </cue>
    <cue name="PatchCue_ClearDiplomacyChanges_ClearAllFactions">
      <conditions>
        <check_any>
          <event_cue_completed cue="md.Diplomacy.Start"/>
          <event_cue_signalled/>
        </check_any>
        <check_value value="md.Story_Covert_Operations.Start.$Terran_Diplomacy_AllFactions_Patch?"/>
      </conditions>
      <actions>
        <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.antigone" flags="dlc2_1"/>
        <clear_faction_diplomacy_exclusion faction="faction.argon" otherfaction="faction.terran" flags="dlc2_1"/>
        <clear_faction_diplomacy_exclusion faction="faction.terran" otherfaction="faction.antigone" flags="dlc2_1"/>
      </actions>
    </cue>

    <cue name="Patch_Userdata" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
      </conditions>
      <actions>
        <do_if value="Start.$PlayerChose?">
          <do_if value="Start.$PlayerChose == 'Protectorate'">
            <set_userdata storystate="'story_covert_ops_argon_schism'" value="1"/>
          </do_if>
          <do_elseif value="Start.$PlayerChose == 'Republic'">
            <set_userdata storystate="'story_covert_ops_war'" value="1"/>
          </do_elseif>
          <do_elseif value="Start.$PlayerChose == 'Neutral'">
            <set_userdata storystate="'story_covert_ops_neutral'" value="1"/>
          </do_elseif>
        </do_if>
      </actions>
    </cue>
  </cues>
</mdscript>
