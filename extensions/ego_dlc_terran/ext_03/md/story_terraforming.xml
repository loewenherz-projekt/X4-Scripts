<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Story_Terraforming" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="Start" namespace="this" mapeditor="false" version="5">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
        <check_value value="player.galaxy.macro.ismacro.{macro.xu_ep2_universe_macro}" comment="only in main-galaxy"/>
      </conditions>
      <actions>
        <set_value name="$DebugChance"                exact="100"/>
        <set_value name="$DeepDebugChance"            exact="0"     comment="for AI scripts and similar external code"/>
        <set_value name="$MissionCue"                 exact="this"/>
        <set_value name="$Page"                       exact="30224"/>

        <create_list name="$HeadScientistSaid" comment="list of lines the Character already said which should not be repeated"/>
        <create_list name="$YakiScientistSaid" comment=""/>
        <create_list name="$BosoTaSaid" comment=""/>
        <create_list name="$PoliceSaid"/>

        <!--Custom gamestart flags-->
        <set_value name="$story_terraforming" exact="gamestart.storystate.story_terraforming"/>
        <set_value name="$ForceCompleted" exact="gamestart.storystate.story_terraforming"/>

        <create_group groupname="$ResearchShipGroup"/>

        <debug_text text="'Initializing Terraforming Story'" chance="$DebugChance"/>
      </actions>
      <patch sinceversion="2">
        <create_group groupname="$ResearchShipGroup"/>
      </patch>
      <patch sinceversion="3">
        <set_value name="$ForceCompleted" exact="false"/>
      </patch>
      <patch sinceversion="4">
        <set_value name="$story_terraforming" exact="$ForceCompleted"/>
      </patch>
      <patch sinceversion="5">
        <do_if value="$MissionCue.hasmissionoffer">
          <update_offer cue="$MissionCue" group="missiongroup.story_terraforming"/>
          <set_value name="$PatchedMissionGroup_Offer"/>
        </do_if>
        <do_if value="$MissionCue.hasmission">
          <update_mission cue="$MissionCue" group="missiongroup.story_terraforming"/>
          <set_value name="$PatchedMissionGroup"/>
        </do_if>
      </patch>
      <cues>

        <cue name="MissionCue_2" comment="required for a parallel mission">
          <actions>
            <set_value name="$MissionCue_2" exact="this"/>
          </actions>
        </cue>

        <cue name="Setup">
          <cues>
            <cue name="Setup_HQ">
              <!--Signalled by Activate_Story once the HQ exists-->
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
                <set_value name="$BosoCutsceneKey"      exact="table[ $key = 'ShowCharacterBoron']"/>

                <assert value="$BosoTa != null" text="'BosoTa is null'"/>
              </actions>
            </cue>

            <cue name="Setup_Character_HeadScientist">
              <actions>
                <signal_cue_instantly cue="md.Setup_DLC_Terran.Setup_PersistentCharacters_Pioneers_ChiefScientistActor"/>
                <set_value name="$HeadScientistActor" exact="md.$PersistentCharacters.$ChiefScientistActor"/>
                <set_value name="$HeadScientistActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
              </actions>
            </cue>

            <cue name="Setup_Character_SecurityServiceContactActor">
              <conditions>
                <event_cue_completed cue="Setup_Values_GS_Information"/>
                <check_value value="$Terran_Cadet_GS" comment="only required on Terran GS 1"/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.Setup_DLC_Terran.Setup_PersistentCharacters_Terran_SecretServiceActor"/>
                <set_value name="$SecurityServiceContactActor" exact="md.$PersistentCharacters.$SecretServiceActor"/>
                <set_value name="$SecurityServiceContactActorCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
              </actions>
            </cue>

            <cue name="Setup_Dal">
              <cues>
                <cue name="Set_Dal_Immediately" onfail="cancel">
                  <conditions>
                    <check_value value="md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Check_For_Diplomatic_Mentor_Ending"/>
                  </actions>
                </cue>

                <cue name="Check_For_Diplomatic_Mentor_Ending">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_cue_completed cue="md.Story_Diplomacy_Intro.Pt11_End"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
                    <!--<set_value name="$DalCutsceneKey"       exact="table[ $key = 'ShowCharacterDal']"/>-->
                    <set_value name="$DalCutsceneKey"       exact="table[ $key = 'ShowNPCFace']"/>

                    <assert value="$DalBusta != null" text="'DalBusta is null'"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Setup_Character_Police_Patrols" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_list name="$PoliceMaleActors_Report"/>
                <create_list name="$PoliceMaleActors_Response"/>
                <create_list name="$PoliceFemaleActors_Report"/>
                <create_list name="$PoliceFemaleActors_Response"/>

                <do_all exact="2">
                  <create_cue_actor name="$PoliceMaleActor" cue="namespace" group="terran.pilot.male">
                    <page exact="10155"/>
                    <owner exact="faction.terran"/>
                  </create_cue_actor>
                  <set_entity_traits entity="$PoliceMaleActor" missionactor="true" customhandler="true" subtitlename="true"/>
                  <set_entity_overrides entity="$PoliceMaleActor" icon="'factionrepresentative'" title="'{30224,151}'"/>
                  <append_to_list name="$PoliceMaleActors_Report" exact="$PoliceMaleActor"/>

                  <create_cue_actor name="$PoliceFemaleActor" cue="namespace" group="terran.pilot.female">
                    <page exact="10108"/>
                    <owner exact="faction.terran"/>
                  </create_cue_actor>
                  <set_entity_traits entity="$PoliceFemaleActor" missionactor="true" customhandler="true" subtitlename="true"/>
                  <set_entity_overrides entity="$PoliceFemaleActor" icon="'factionrepresentative'" title="'{30224,152}'"/>
                  <append_to_list name="$PoliceFemaleActors_Report" exact="$PoliceFemaleActor"/>


                  <create_cue_actor name="$PoliceMaleActor" cue="namespace" group="terran.manager.male">
                    <page exact="10155"/>
                    <owner exact="faction.terran"/>
                  </create_cue_actor>
                  <set_entity_traits entity="$PoliceMaleActor" missionactor="true" customhandler="true" subtitlename="true"/>
                  <set_entity_overrides entity="$PoliceMaleActor" icon="'factionrepresentative'" title="'{30224,151}'"/>
                  <append_to_list name="$PoliceMaleActors_Response" exact="$PoliceMaleActor"/>

                  <!--TODO @Owen better group?-->
                  <create_cue_actor name="$PoliceFemaleActor" cue="namespace" group="terran.manager.female">
                    <page exact="10108"/>
                    <owner exact="faction.terran"/>
                  </create_cue_actor>
                  <set_entity_traits entity="$PoliceFemaleActor" missionactor="true" customhandler="true" subtitlename="true"/>
                  <set_entity_overrides entity="$PoliceFemaleActor" icon="'factionrepresentative'" title="'{30224,152}'"/>
                  <append_to_list name="$PoliceFemaleActors_Response" exact="$PoliceFemaleActor"/>

                </do_all>
                <set_value name="$PoliceReporterCutsceneKey"   exact="table[ $key = 'ShowPilot']"/>
                <set_value name="$PoliceResponseCutsceneKey"   exact="table[ $key = 'ShowPilot']"/>

                <signal_cue cue="Setup_Character_Police_Patrols_Reset_Actors"/>
              </actions>
              <patch sinceversion="2">
                <clear_list list="$PoliceFemaleActors_Report"/>
                <create_cue_actor name="$PoliceFemaleActor" cue="namespace" group="terran.pilot.female">
                  <page exact="10108"/>
                  <owner exact="faction.terran"/>
                </create_cue_actor>
                <set_entity_traits entity="$PoliceFemaleActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$PoliceFemaleActor" icon="'factionrepresentative'" title="'{30224,152}'"/>
                <append_to_list name="$PoliceFemaleActors_Report" exact="$PoliceFemaleActor"/>
              </patch>
            </cue>

            <cue name="Setup_Character_Police_Patrols_Reset_Actors" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$PoliceActor_Reporter" exact="$PoliceFemaleActors_Report.random"/>
                <set_value name="$PoliceActor_Response" exact="$PoliceFemaleActors_Response.random"/>
                <do_any>
                  <set_value name="$PoliceActor_Reporter" exact="$PoliceMaleActors_Report.random"/>
                  <set_value name="$PoliceActor_Response" exact="$PoliceMaleActors_Response.random"/>
                </do_any>
              </actions>
            </cue>

            <cue name="Setup_Locations" version="2">
              <actions>
                <find_sector macro="macro.Cluster_01_Sector001_macro"   required="true" name="$GrandExchangeI"/>
                <find_sector macro="macro.Cluster_27_Sector001_macro"   required="true" name="$TheVoid"/>
                <find_sector macro="macro.Cluster_114_Sector001_macro"  required="true" name="$GaianProphecy"/>
                <find_sector macro="macro.Cluster_113_Sector001_macro"  required="true" name="$Segaris"/>
                <!-- ToDo: Terraform World -->
                <find_sector name="$TerranSectors" extension="'ego_dlc_terran'" multiple="true" comment="contains segarian and savage sectors"/>

                <!-- Sectors of Sol -->
                <find_sector macro="macro.cluster_104_sector001_macro"  required="true" name="$Earth"/>
                <find_sector macro="macro.cluster_104_sector002_macro"  required="true" name="$Moon"/>
                <find_sector macro="macro.cluster_106_sector001_macro"  required="true" name="$Mercury"/>
                <find_sector macro="macro.cluster_102_sector001_macro"  required="true" name="$Venus"/>
                <find_sector macro="macro.cluster_101_sector001_macro"  required="true" name="$Mars"/>
                <find_sector macro="macro.cluster_100_sector001_macro"  required="true" name="$AsteroidBelt"/>

                <set_value name="$SolSectors" exact="[$Earth, $Moon, $Mercury, $Venus, $Mars, $AsteroidBelt]"/>

                <find_sector name="$BaseSectors"  multiple="true" extension="''"/>

                <find_sector name="$GetsuFune" macro="macro.cluster_48_sector001_macro" comment="Getsu Fune"/>

              </actions>
              <patch sinceversion="2">
                <destroy_object object="$EarthTorus.engineer" comment="prevent engineer from auto-repairing any switches"/>
              </patch>
              <cues>
                <cue name="Setup_Torus" version="2">
                  <delay exact="1s" comment="TODO: small delay as a workaround for events firing in different order when loading an existing savegame"/>
                  <actions>
                    <!-- TODO: Property -->
                    <set_value name="$SwitchHullMax" exact="100"/>
                    <set_value name="$SwitchHullMin" exact="98"/>


                    <!-- earth torus -->
                    <find_object name="$EarthTorus" space="$Earth" macro="macro.torus_maze_macro" recursive="true" required="true"/>
                    <destroy_object object="$EarthTorus.engineer" comment="prevent engineer from auto-repairing any switches. Also, destroying a control entity RESETS the set_object_relation_behaviour!"/>
                    <set_object_relation_behaviour object="$EarthTorus" disable="true" comment="Do this AFTER destroying control entities!" />

                    <find_object_component groupname="this.$EarthTorusDoorControls" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" required="true"/>
                    <do_for_each name="this.$switch" in="this.$EarthTorusDoorControls">
                      <set_object_min_hull object="this.$switch" exact="$SwitchHullMin" comment="don't allow destruction of switches"/>
                    </do_for_each>

                    <find_object_component name="$EarthTorusDoorControls_01" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_1" required="true" comment="Entrydoor control"/>
                    <set_object_min_hull object="$EarthTorusDoorControls_01" exact="$SwitchHullMax" comment="entry-door switch indestructible and at full hull (repaired/green), until chapter 6.1 is active"/>

                    <add_to_group groupname="md.Signal_Leaks.Manager.$ExcludedObjects" object="$EarthTorus"/>
                    <add_to_group groupname="md.GenericMissions.Manager.$ExcludedOfferObjects" object="$EarthTorus"/>
                  </actions>
                </cue>
              </cues>
            </cue>


            <cue name="Setup_Character_YakiScientist" version="2">
              <actions>
                <debug_text text="'Creating Yaki Scientist'" chance="$DebugChance"/>

                <create_cue_actor name="$YakiScientistActor" cue="namespace" macro="character_yaki_paranid_plot_scientist_macro">
                  <page exact="10353"/>
                  <owner exact="faction.civilian"/>
                  <skills>
                    <skill type="management"  exact="4"/>
                    <skill type="morale"      exact="15"/>
                    <skill type="piloting"    exact="5"/>
                    <skill type="engineering" exact="15"/>
                    <skill type="boarding"    exact="6"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$YakiScientistActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$YakiScientistActor" icon="'factionrepresentative'" title="'{30224,153}'"/>
                <set_value name="md.$PersistentCharacters.$YakiScientistActor" exact="$YakiScientistActor"/>
                <set_value name="$YakiScientistActorCutsceneKey"   exact="table[ $key = 'ShowCharacter']"/>
                <set_value name="$AddStoryMentors_YakiScientistActor"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$AddStoryMentors_YakiScientistActor"/>
              </patch>
              <cues>
                <cue name="PATCH_AddStoryMentors_YakiScientistActor" onfail="cancel">
                  <conditions>
                    <check_value value="$AddStoryMentors_YakiScientistActor?"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$YakiScientistActor]"/>
                  </actions>
                </cue>
                <!--<cue name="DEBUG_PLACEMENT" onfail="cancel">
                  <conditions>
                    <check_value value="$BosoTa?"/>
                  </conditions>
                  <actions>
                    -->
                <!-- DEBUG: Conversing with Disconnected Actors is currently broken TODO @Heinrich Remove -->
                <!--
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $YakiScientistActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $BosoTa.room,
                                                                                                                                      $position = position.[3.177m, 0.00m, -9.395m],
                                                                                                                                      $rotation = rotation.[225deg, 0deg, 0deg],
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </actions>
                </cue>-->
              </cues>
            </cue>

            <cue name="Setup_Betty">
              <actions>
                <set_value name="$BettyFaction_Init" exact="faction.civilian"/>
              </actions>
              <cues>
                <cue name="Setup_Character_BettyActor">
                  <actions>
                    <debug_text text="'Creating Betty Actor'" chance="$DebugChance"/>

                    <create_cue_actor name="$BettyActor" cue="$MissionCue">
                      <select race="race.drone"/>
                      <owner exact="$BettyFaction_Init"/>
                      <page exact="10002"/>
                      <name name="'{30224,101}'"/>
                    </create_cue_actor>
                    <set_entity_traits entity="$BettyActor" missionactor="true" customhandler="true" subtitlename="true"/>
                    <set_entity_overrides entity="$BettyActor" icon="'factionrepresentative'" title="'{30224,154}'"/>
                    <set_value name="md.$PersistentCharacters.$BettyActor" exact="$BettyActor"/>
                    <set_value name="$BettyActorCutsceneKey"   exact="table[ $key = 'ShowComputerBetty']"/>
                  </actions>
                </cue>

                <cue name="Setup_Character_BettyPilotActor" version="2">
                  <actions>
                    <debug_text text="'Creating Betty Pilot Actor'" chance="$DebugChance"/>

                    <create_cue_actor name="$BettyPilotActor" cue="$MissionCue">
                      <select race="race.drone"/>
                      <owner exact="$BettyFaction_Init"/>
                      <page exact="10002"/>
                      <name name="'{30224,101}'"/>
                    </create_cue_actor>
                    <set_entity_traits entity="$BettyPilotActor" missionactor="true" customhandler="true" subtitlename="true"/>
                    <set_entity_overrides entity="$BettyPilotActor" icon="'factionrepresentative'" title="'{30224,154}'"/>

                    <set_value name="$BettyPilotActor.$noattackresponse"/>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$BettyPilotActor.$noattackresponse"/>
                  </patch>
                </cue>
              </cues>
            </cue>

            <cue name="Setup_Character_Torus">
              <actions>
                <debug_text text="'Creating Torus Actor'" chance="$DebugChance"/>

                <create_cue_actor name="$TorusActor" cue="$MissionCue">
                  <select race="race.drone"/>
                  <owner exact="faction.ownerless"/>
                  <page exact="10098"/>
                  <name name="'{30224,102}'"/>
                </create_cue_actor>

                <!--<create_cue_actor name="$TorusActor" cue="namespace" macro="character_argon_female_plot_buccaneer_macro">
                  <page exact="10451"/>
                  <owner exact="faction.civilian"/>
                  <skills>
                    <skill type="management"  exact="15"/>
                    <skill type="morale"      exact="15"/>
                    <skill type="piloting"    exact="5"/>
                    <skill type="engineering" exact="1"/>
                    <skill type="boarding"    exact="6"/>
                  </skills>
                </create_cue_actor>-->
                <set_entity_traits entity="$TorusActor" missionactor="true" customhandler="true" subtitlename="true"/>
                <set_entity_overrides entity="$TorusActor" icon="'factionrepresentative'" title="'{30224,155}'"/>
                <set_value name="md.$PersistentCharacters.$TorusActor" exact="$TorusActor"/>
                <set_value name="$TorusActorCutsceneKey"   exact="table[ $key = 'ShowComputerTorus']"/>
              </actions>
            </cue>

            <cue name="Setup_Values_GS_Information">
              <actions>
                <set_value name="$Terran_DLC_GS"    exact="false"/>
                <set_value name="$Terran_Cadet_GS"  exact="false"/>
                <set_value name="$Segarian_GS"      exact="false"/>

                <do_if value="player.module == 'x4ep1_gamestart_terran1'">
                  <set_value name="$Terran_DLC_GS" exact="true"/>
                  <set_value name="$Terran_Cadet_GS" exact="true"/>
                </do_if>
                <do_elseif value="player.module == 'x4ep1_gamestart_terran2'">
                  <set_value name="$Terran_DLC_GS" exact="true"/>
                  <set_value name="$Segarian_GS" exact="true"/>
                </do_elseif>
              </actions>
            </cue>

            <cue name="Setup_Values_Relation">
              <actions>
                <set_value name="$RelationBoostDocking" exact="faction.player.relation.dock.min + 0.001"
                           comment="otherwise docking is barely not allowed"/>
              </actions>
            </cue>

            <cue name="Ch1_Setup_ResearchShip" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>

                <do_if value="md.Story_HQ_Discovery.Start.$ScientistShip? and md.Story_HQ_Discovery.Start.$ScientistShip.exists">
                  <set_value name="$ResearchShip" exact="md.Story_HQ_Discovery.Start.$ScientistShip"/>
                  <warp object="$ResearchShip" sector="$HQ.sector">
                    <safepos value="position.[0km,25km,-25km]" object="$HQ"/>
                  </warp>
                </do_if>
                <do_else>
                  <create_ship name="$ResearchShip" capturable="false" missioncue="namespace" macro="ship_ter_l_research_01_a_macro" sector="$HQ.sector" commandeerable="false">
                    <owner exact="faction.pioneers"/>
                    <paint ware="ware.paintmod_0122"/>
                    <!--<loadout loadout="$loadout_Missile_Rattlesnake"/>-->
                    <pilot>
                      <select faction="faction.pioneers" tags="tag.fighterpilot"/>
                    </pilot>
                    <people ref="pioneers_freighter_crew">
                      <fillpercent exact="100"/>
                    </people>
                    <position x="0km" y="25km" z="-25km" object="$HQ" space="$HQ.sector"/>
                    <rotation roll="180deg"/>
                  </create_ship>
                </do_else>
                <add_to_group groupname="$ResearchShipGroup" object="$ResearchShip"/>

                <create_order id="'Wait'" object="$ResearchShip" default="true" comment="stay put">
                  <param name="noattackresponse" value="true"/>
                </create_order>

                <set_object_radar_visible object="$ResearchShip" visible="false"/>
                <set_object_relation_behaviour object="$ResearchShip" disable="true"/>

                <set_object_name object="$ResearchShip" page="30224" line="202" comment="Oberth"/>

                <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                  <param name="Object" value="$ResearchShip"/>
                  <param name="RequesterCue" value="namespace"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>


                <set_entity_traits entity="$ResearchShip.pilot" missionactor="true" customhandler="true"/>

                <!--Place $HeadScientist on ship-->
                <signal_cue cue="Setup_ChiefScientist_Position"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <!-- Warping the ship into the correct sector takes a bit of time and we don't want Cues waiting for completion saving the wrong ship.sector -->
              </actions>
              <patch sinceversion="2">
                <do_if value="$ResearchShip.exists">
                  <add_to_group groupname="$ResearchShipGroup" object="$ResearchShip"/>
                </do_if>
              </patch>
            </cue>

            <cue name="Setup_ResearchShip_Recovery">
              <!-- Despite being invincible the Research Ship is able to disappear prematurely. Recovery for those player saves -->
              <cues>

                <cue name="Debug_ResearchShip_Assert" instantiate="true">
                  <conditions>
                    <event_game_loaded/>
                  </conditions>
                  <actions>
                    <assert value="not $ResearchShip_Debug?" text="'Invincible Mission ship got destroyed (before this save), check $ResearchShip_Debug for event_object_destroyed params. [Owen/Heinrich]' + $ResearchShip_Debug"/>
                  </actions>
                </cue>

                <cue name="ResearchShip_WaitForFirstSpawn" onfail="cancel">
                  <conditions>
                    <!-- Case 1: ResearchShip has not yet been spawned, wait for initial spawn. -->
                    <check_value value="Ch1_Setup_ResearchShip.state != cuestate.complete"/>
                  </conditions>
                  <cues>
                    <cue name="ResearchShip_FirstSpawned">
                      <conditions>
                        <event_cue_completed cue="Ch1_Setup_ResearchShip"/>
                      </conditions>
                      <actions>
                        <reset_cue cue="ResearchShip_Catch_Disappearance"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="ResearchShip_Catch_Disappearance" onfail="cancel">
                  <conditions>
                    <check_value value="Ch1_Setup_ResearchShip.state == cuestate.complete"/>
                    <!-- Case 2: We did not complete the story yet. Track the ship to catch disappearances. -->
                    <check_value value="Cleanup_ReasearchShip_ReachedSector.state != cuestate.complete"/>
                  </conditions>
                  <cues>

                    <cue name="ResearchShip_MoveDie" comment="Tracking Completed">
                      <conditions>
                        <event_cue_completed cue="Cleanup_ReasearchShip_ReachedSector"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="parent"/>
                      </actions>
                    </cue>

                    <cue name="ResearchShipDestroyed" onfail="cancel">
                      <conditions>
                        <check_value value="not $ResearchShipGroup.count"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="ResearchShip_Respawn"/>
                      </actions>
                    </cue>

                    <cue name="ResearchShipExists" onfail="cancel">
                      <conditions>
                        <check_value value="$ResearchShipGroup.count"/>
                      </conditions>
                      <cues>
                        <cue name="ResearchShip_Lost_Log">
                          <conditions>
                            <event_object_destroyed group="$ResearchShipGroup"/>
                            <check_value value="Cleanup_ReasearchShip_ReachedSector.state != cuestate.complete" comment="Sets MoveDie"/>
                          </conditions>
                          <actions>
                            <remove_from_group object="event.object" group="$ResearchShipGroup"/>
                            <do_if value="not $ResearchShip_Debug?" comment="Don't override older entries">
                              <create_list name="$ResearchShip_Debug"/>
                            </do_if>
                            <append_to_list name="$ResearchShip_Debug" exact="'Killer: ' + event.param"/>
                            <do_if value="event.param != null">
                              <append_to_list name="$ResearchShip_Debug" exact="'Killer Name: ' + event.param.knownname"/>
                            </do_if>

                            <do_if value="event.param.container?">
                              <append_to_list name="$ResearchShip_Debug" exact="'Killer Container: ' + event.param.container + ' ' + event.param.container.knownname"/>
                            </do_if>
                            <append_to_list name="$ResearchShip_Debug" exact="'Kill method: ' + event.param2"/>
                            <append_to_list name="$ResearchShip_Debug" exact="'Time: ' + player.age"/>
                            <do_if value="event.param != null">
                              <append_to_list name="$ResearchShip_Debug" exact="'Killer Sector: ' + event.param.sector"/>
                            </do_if>
                            <assert value="false" text="'Invincible Mission ship got destroyed, check $ResearchShip_Debug for event_object_destroyed params. [Owen/Heinrich]' + $ResearchShip_Debug"/>

                            <signal_cue cue="ResearchShip_Respawn"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="ResearchShip_Respawn">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$RespawningResearchShip" exact="player.age"/>

                        <!-- Spawn Positions: HQ, Earth-->
                        <do_if value="Ch3_Deliver_Research.state != cuestate.cancelled">
                          <set_value name="$position"  exact="position.[0km,25km,-25km]"/>
                          <set_value name="$posObject" exact="$HQ"/>
                          <set_value name="$posSpace"  exact="$HQ.sector"/>
                        </do_if>
                        <do_else>
                          <create_position name="$position" object="$Earth" space="$Earth" value="position.[100km,0km,0km]"/>
                          <set_value name="$posObject" exact="$Earth"/>
                          <set_value name="$posSpace"  exact="$Earth"/>
                        </do_else>

                        <create_ship name="$ResearchShip" capturable="false" missioncue="namespace" macro="ship_ter_l_research_01_a_macro" sector="$posSpace" commandeerable="false">
                          <owner exact="faction.pioneers"/>
                          <paint ware="ware.paintmod_0122"/>
                          <pilot>
                            <select faction="faction.pioneers" tags="tag.fighterpilot"/>
                          </pilot>
                          <people ref="pioneers_freighter_crew">
                            <fillpercent exact="100"/>
                          </people>
                          <safepos x="$position.x" y="$position.y" z="$position.z" object="$posObject" space="$posSpace"/>
                          <rotation roll="180deg"/>
                        </create_ship>
                        <add_to_group groupname="$ResearchShipGroup" object="$ResearchShip"/>

                        <set_object_relation_behaviour object="$ResearchShip" disable="true"/>
                        <set_object_name object="$ResearchShip" page="30224" line="202" comment="Oberth"/>
                        <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                          <param name="Object" value="$ResearchShip"/>
                          <param name="RequesterCue" value="namespace"/>
                          <param name="DebugChance" value="$DebugChance"/>
                        </run_actions>
                        <set_entity_traits entity="$ResearchShip.pilot" missionactor="true" customhandler="true"/>

                        <!-- Move Order: Cleanup after End, Move to Gaia after Ch7, Stay put before that-->
                        <do_if value="Cleanup_ReasearchShip_ReachedSector.state == cuestate.complete">
                          <cancel_all_orders object="$ResearchShip"/>
                          <create_order id="'MoveDie'" object="$ResearchShip" immediate="true"/>
                        </do_if>
                        <!-- Move Order after Ch7 -->
                        <do_elseif value="(Ch7_PlayerReachedLocation_Success.state == cuestate.cancelled)
                                       or (Ch7_PlayerReachedLocation_Success.state == cuestate.complete)">
                          <!-- Move Research Ship to Gaian Prophecy -->
                          <create_position name="$TargetPos" object="$GaianProphecy" space="$GaianProphecy"/>
                          <cancel_all_orders object="$ResearchShip"/>
                          <create_order id="'MoveWait'" object="$ResearchShip" immediate="true">
                            <param name="destination" value="[$GaianProphecy, $TargetPos]"/>
                            <param name="debugchance" value="$DeepDebugChance"/>
                          </create_order>
                        </do_elseif>
                        <do_else>
                          <create_order id="'Wait'" object="$ResearchShip" default="true" comment="stay put">
                            <param name="noattackresponse" value="true"/>
                          </create_order>
                        </do_else>

                        <!-- Visibility disabled in the beginning -->
                        <do_if value="(Ch1_Mysterious_Ship_Found.state != cuestate.complete)
                                  and (Ch1_Mysterious_Ship_Found.state != cuestate.cancelled)">
                          <reset_cue cue="Ch1_Mysterious_Ship_Search"/>
                          <set_object_radar_visible object="$ResearchShip" visible="false"/>
                        </do_if>

                        <!-- Trade Offer in Ch1_3_Trade_Wares_Ref continues to the next mission if the ship is destroyed,
                             but skips the LIB_Dialog explaining the player what to do. -->

                        <reset_cue cue="Setup_ChiefScientist_Position"/>
                        <reset_cue cue="Ch1_Setup_ResearchShip_Relation"/>
                        <reset_cue cue="Ch1_Setup_ResearchShip_Comm_Pilot"/>
                        <do_if     value="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit.state == cuestate.complete">
                          <reset_cue cue="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit"/>
                          <set_value name="$ResearchShip_Debug_ResettingPursuit"/>
                        </do_if>
                        <do_if     value="Ch1_Setup_ResearchShip_Scan.state == cuestate.complete">
                          <reset_cue cue="Ch1_Setup_ResearchShip_Scan"/>
                          <set_value name="$ResearchShip_Debug_ResettingScan"/>
                        </do_if>
                        <set_value name="$Delay_RespawnRick" exact="2s"/>
                      </actions>
                      <delay exact="$Delay_RespawnRick"/>
                      <actions>
                        <signal_cue cue="Setup_ChiefScientist_Position"/>
                        <force_cue cue="Ch1_Setup_ResearchShip_Relation"/>
                        <force_cue cue="Ch1_Setup_ResearchShip_Comm_Pilot"/>
                        <do_if     value="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit.state == cuestate.waiting">
                          <force_cue cue="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit"/>
                        </do_if>
                        <do_if     value="Ch1_Setup_ResearchShip_Scan.state == cuestate.waiting">
                          <force_cue cue="Ch1_Setup_ResearchShip_Scan"/>
                          <set_value name="$ResearchShip_Debug_ResettingScan"/>
                        </do_if>

                        <!-- Updating Objective. Objectives with a group="" setting don't seem to update if new objects are added to the group, so they need to be reset. -->
                        <do_if value="Ch1_Mysterious_Ship_Found.state == cuestate.complete">
                          <do_if value="Ch1_3_Delivery.state == cuestate.waiting">
                            <set_objective cue="$MissionCue_2" step="$ObjectiveStep" group="$ResearchShipGroup" action="objective.find" text="{30224,1056}" updatebriefing="true"/>
                          </do_if>
                        </do_if>
                        <!-- Killing the actor and replacing them doesn't fix guidance "Talk to: Rick" not guiding you anywhere -->
                        <do_if value="(Ch2_HQ_Attack.state == cuestate.complete)
                                    and (Ch2_1_SignalLeak.state == cuestate.waiting)">
                          <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>
                        </do_if>


                        <do_if value="Ch7_Rendezvous.state == cuestate.complete">
                          <reset_cue cue="Ch7_Patch_Reset_Objective"/>
                        </do_if>

                        <!-- Resetting ResearchShip Recovery Manager to catch&fix more issues -->
                      </actions>
                      <delay exact="10ms"/>
                      <actions>
                        <!-- Reset Conversation Listeners -->
                        <do_if value="Ch0_Reporting_To_ChiefScientist.state == cuestate.complete">
                          <reset_cue cue="Ch0_Reporting_To_ChiefScientist"/>
                        </do_if>
                        <reset_cue cue="Ch1_Conversation_HeadScientist"/>
                        <reset_cue cue="Ch2_Converastion_HeadScientist"/>
                        <remove_value name="$Ch3_2_Deliver_Item_Reset"/>
                        <do_if value="(Ch3_2_Deliver_Item.state == cuestate.complete)">
                          <reset_cue cue="Ch3_2_Deliver_Item"/>
                          <set_value name="$Ch3_2_Deliver_Item_Reset"/>
                        </do_if>
                        <reset_cue cue="Ch4_Conv_HeadScientist"/>
                        <reset_cue cue="Ch7_Conv_ChiefScientist_Intro"/>
                        <reset_cue cue="Ch7_Conv_ChiefScientist_Main"/>
                        <reset_cue cue="Ch7_Conversation_ChiefScientist_Choices"/>
                        <reset_cue cue="Ch7_Conversation_ChiefScientist_Choices"/>
                        <reset_cue cue="Ch7_Conv_CS_Freelancer"/>
                        <reset_cue cue="Ch7_Conv_CS_Now"/>
                        <reset_cue cue="Ch7_Conv_CS_Station"/>
                        <reset_cue cue="Ch7_Conv_CS_Terraforming"/>
                        <reset_cue cue="Ch7_Conv_CS_Terraforming"/>

                        <reset_cue cue="ResearchShipExists"/>
                      </actions>
                      <delay exact="1ms"/>
                      <actions>
                        <do_if value="$Ch3_2_Deliver_Item_Reset?">
                          <signal_cue cue="Ch3_2_Deliver_Item"/>
                        </do_if>
                        <signal_cue cue="Ch0_Reporting_To_ChiefScientist" check="false"/>
                        <reset_cue cue="this"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Setup_ResearchShip_Relation">
              <conditions>
                <event_cue_completed cue="Ch1_Setup_ResearchShip"/>
              </conditions>
              <cues>
                <cue name="Ch1_Setup_ResearchShip_Reset_Relation" instantiate="true">
                  <conditions>
                    <event_player_relation_changed />
                    <check_value value="event.object == $ResearchShip.pilot"/>
                    <check_value value="event.param2.{1} lt $RelationBoostDocking" comment="Only if the relation drops below docking relations"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Relation Reset Triggered for $ResearchShip'" chance="$DebugChance"/>
                    <set_relation_boost object="$ResearchShip" faction="faction.player" value="$RelationBoostDocking" comment="Boost Reset" decay="0"/>
                  </actions>
                </cue>

                <!--<cue name="Ch1_Setup_ResearchShip_Reset_Terran_Relation" instantiate="true">
                  <conditions>
                    <event_object_attacked object="$ResearchShip"/>
                    <check_value value="event.param.owner == faction.terran"/>
                  </conditions>
                  <actions>
                    <set_relation_boost object="$ResearchShip" otherobject="event.param" value="$RelationBoostDocking" comment="Boost Reset" decay="0"/>
                    <set_relation_boost object="$ResearchShip" faction="faction.terran" value="$RelationBoostDocking" comment="Boost Reset" decay="0"/>
                  </actions>
                </cue>-->

              </cues>
            </cue>

            <cue name="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit">
              <conditions>
                <event_cue_completed cue="Ch1_Setup_ResearchShip"/>
              </conditions>
              <cues>
                <cue name="Ch1_Setup_Order_Init">
                  <actions>
                    <do_if value="$ResearchShip.sector != $HQ.sector">
                      <signal_cue cue="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit_Order"/>
                    </do_if>
                  </actions>
                </cue>
                <cue name="Ch1_Setup_Order_Event" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_object_changed_sector object="$HQ"/>
                      <event_object_changed_sector object="$ResearchShip"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit_Order"/>
                  </actions>
                </cue>

                <cue name="Ch1_Setup_ResearchShip_Pursuit_Bulletproofing">
                  <delay exact="30s"/>
                  <actions>
                    <do_if value="$ResearchShip.sector != $HQ.sector">
                      <signal_cue cue="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit_Order"/>
                    </do_if>
                    <do_if value="Ch4_Mission_Ship.state == cuestate.waiting">
                      <reset_cue cue="this"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit_Order" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="Ch4_Mission_Ship.state == cuestate.waiting"/>
                    <check_value value="Ch5_Evade_Patrols.state == cuestate.waiting"/>
                    <check_value value="Ch6_Torus.state == cuestate.waiting"/>
                    <check_value value="Ch7_Escape.state == cuestate.waiting"/>
                    <check_value value="Ch8_Terraforming.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <debug_text text="'HQ Warp detected, ResearchShip starting Pursuit'" chance="$DebugChance"/>
                    <create_position name="$TargetPos" x="0km" y="25km" z="-25km" object="$HQ" space="$HQ.sector"/>
                    <cancel_all_orders object="$ResearchShip"/>
                    <create_order id="'MoveWait'" object="$ResearchShip" immediate="true">
                      <param name="destination" value="[$HQ.sector, $TargetPos]"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Setup_Align_ResearchShip">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Move $ResearchShip to Earth for Ch7 -->
                <create_position name="$TargetPos" object="$EarthTorus.sector" space="$EarthTorus.sector"/>
                <cancel_all_orders object="$ResearchShip"/>
                <create_order id="'MoveWait'" object="$ResearchShip" immediate="true">
                  <param name="destination" value="[$EarthTorus.sector, $TargetPos]"/>
                  <param name="debugchance" value="$DeepDebugChance"/>
                </create_order>
              </actions>
              <cues>
                <cue name="Ch4_Setup_Align_ResearchShip_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                  <param name="ApproachObject"    value="$ResearchShip"/>
                  <param name="ApproachSector"    value="$EarthTorus.sector"/>
                  <param name="ApproachOffset"    value="$TargetPos"/>
                  <param name="ApproachDistance"  value="25km"/>
                  <param name="SuccessSignalCue"  value="Ch4_Setup_Warp_Conditions"/>
                </cue>

                <cue name="Ch4_Setup_Warp_Conditions">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Setup_Warp_Conditions_Check" checkinterval="5s">
                      <conditions>
                        <check_value value="not player.isinfullscreenmenu"/>
                        <check_value value="player.entity.distanceto.{$ResearchShip} gt 20km"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch4_Warp_ResearchShip"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Warp_ResearchShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_all_orders object="$ResearchShip"/>
                    <create_position name="$TargetPos" x="0km" y="0km" z="0km" object="$ResearchShip" space="$ResearchShip.sector"/>
                    <!-- Align the Ship to have Earth in the Scientist's Targetmonitor Shot -->
                    <warp object="$ResearchShip" sector="$ResearchShip.sector">
                      <safepos value="$TargetPos"/>
                      <rotation pitch="0deg" roll="0deg" yaw="0deg"/>
                    </warp>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Cleanup_ResearchShip">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Cleanup_ReasearchShip_InSector">
                  <actions>
                    <do_if value="$ResearchShip.sector == $GaianProphecy">
                      <signal_cue cue="Cleanup_ReasearchShip_ReachedSector"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Cleanup_ReasearchShip_ReachedSector">
                  <!-- Multiple checks whether this is complete. Never cancel. -->
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_changed_sector group="$ResearchShipGroup" sector="$GaianProphecy"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                      <param name="Object" value="$ResearchShip"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                    <cancel_cue cue="Ch1_Setup_ResearchShip_Relation"/>
                    <cancel_all_orders object="$ResearchShip"/>
                    <create_order id="'MoveDie'" object="$ResearchShip" immediate="true"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $HeadScientistActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Setup_ResearchShip_Comm_Pilot">
              <!-- Player Comms the pilot of the weird ship and will be redirected to a conversation with the Head Scientist where they can accept the mission -->
              <conditions>
                <event_cue_completed cue="Ch1_Setup_ResearchShip"/>
              </conditions>
              <cues>
                <cue name="Ch1_Conversation_Cancel_Destroyed_v2">
                  <conditions>
                    <event_object_destroyed group="$ResearchShipGroup"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="parent"/>
                  </actions>
                </cue>
                <cue name="Ch1_Conversation_Cancel_Destroyed_Patch" onfail="cancel">
                  <conditions>
                    <check_value value="not $ResearchShip.exists"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="parent"/>
                  </actions>
                </cue>

                <cue name="Ch1_Conversation_ResearchShip_Pilot_v2" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$ResearchShipGroup.{1}.pilot"/>
                  </conditions>
                  <actions>
                    <do_if value="player.entity.room == $ResearchShip.pilot.room">
                      <add_npc_line speaker="$ResearchShip.pilot" hidechoices="true">
                        <text line="2003" comment="(Greeting - enemy)Whta do you want?"/>
                      </add_npc_line>
                    </do_if>
                    <do_else>
                      <add_npc_line speaker="$ResearchShip.pilot" hidechoices="true">
                        <text line="2005" comment="(Greeting - over comms)Comms channel open."/>
                      </add_npc_line>
                    </do_else>

                    <do_if value="not $HeadScientistSaid.indexof.{30224111}">
                      <add_player_choice text="{30224,30224101}"      section="rs_pilot"/>
                    </do_if>
                    <do_elseif value="Ch3_Deliver_Research_Ref.state != cuestate.complete" comment="during the inventory delivery don't allow talking remotely as the item delivery conversation doesn't pick it up">
                      <add_player_choice text="{30224,30224102}"      section="rs_pilot"/>
                    </do_elseif>
                    <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel"/>
                  </actions>
                </cue>

                <cue name="Ch1_Conversation_ResearchShip_Pilot_Refer" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$ResearchShip.pilot" section="rs_pilot"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$ResearchShip.pilot" hidechoices="true">
                      <text line="5039" comment="One moment please."/>
                    </add_npc_line>
                  </actions>
                  <cues>
                    <cue name="Ch1_Conversation_ResearchShip_Pilot_Completed">
                      <conditions>
                        <event_conversation_finished actor="$ResearchShip.pilot"/>
                      </conditions>
                      <actions>
                        <do_if value="$MissionCue_2.hasmission">
                          <start_conversation actor="$HeadScientistActor" conversation="HS_Conv" missioncue="$MissionCue_2"/>
                        </do_if>
                        <do_else>
                          <start_conversation actor="$HeadScientistActor" conversation="HS_Conv"/>
                        </do_else>
                        <!--<set_entity_traits entity="$ResearchShip.pilot" customhandler="false" missionactor="true"/>-->
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Setup_ChiefScientist_Position">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!--Place $HeadScientist on ship-->
                <!--<create_position name="$SciPos" x="1.556" z="-1.09" y="0.0"/>
                
                                                                                                      $position = position.[-2.3m, 0.0m, -1.9m],-->
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $HeadScientistActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $ResearchShipGroup.{1}.controlroom,
                                                                                                      $priority = 100,
                                                                                                      $position = position.[2.9m, 0.0m, -3.1m],
                                                                                                      $rotation = rotation.[135deg, 0deg, 0deg],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Ch4_Setup_MissionShip">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>

                <!-- Find safe pos in Hazardous Region -->

                <!-- ToDo: Rewrite nicer once <get_regions> and <get_safe_pos_in_region or something like that is supported -->
                <create_list name="$HazardousLocations"/>
                <do_all exact="20" counter="$x">
                  <do_all exact="20" counter="$z">
                    <!-- Checking in steps of 10km from -90km  to +100km in X and Z direction-->
                    <get_safe_pos result="$pos" value="position.[(10*$x)km - 100km, 0km, (10*$z)km - 100km]" sector="$TheVoid" space="$TheVoid" ignoredangerousregions="true"/>
                    <!--<debug_text text="$pos" chance="$DebugChance"/>-->
                    <do_if value="$TheVoid.hashazardousregionat.{$pos}">
                      <set_value name="$BackupHazardousRegion" exact="$pos" comment="in case we do not find one with a hazardous neighbourhood"/>

                      <!-- Check if the neighbourhood is also hazardous -->
                      <create_position name="$pos_N" x="$pos.x" y="0" z="$pos.z + 10km"/>
                      <create_position name="$pos_S" x="$pos.x" y="0" z="$pos.z - 10km"/>
                      <create_position name="$pos_W" x="$pos.x - 10km" y="0" z="$pos.z"/>
                      <create_position name="$pos_E" x="$pos.x + 10km" y="0" z="$pos.z" />

                      <set_value name="$positions" exact="[$pos_N, $pos_S, $pos_W, $pos_E]"/>

                      <set_value name="$Hazardous" exact="true"/>
                      <do_for_each in="$positions" name="$p">
                        <do_if value="not $TheVoid.hashazardousregionat.{$p}">
                          <!--<debug_text text="'Found safe location closeby'" chance="$DebugChance"/>-->
                          <set_value name="$Hazardous" exact="false"/>
                        </do_if>
                      </do_for_each>
                      <do_if value="$Hazardous">
                        <debug_text text="'Found Hazardous Region at ' + $pos" chance="$DebugChance"/>
                        <append_to_list name="$HazardousLocations" exact="$pos"/>
                      </do_if>
                    </do_if>
                  </do_all>
                </do_all>
                <debug_text text="'Found ' + $HazardousLocations.count + ' hazardous regions with hazards +-10km in x/z directions'" chance="$DebugChance"/>

                <do_if value="(not $HazardousLocations.count) and (not $BackupHazardousRegion?)">
                  <assert value="true" text="'[Heinrich] No Hazardous Regions found'"/>
                  <get_safe_pos result="$BackupHazardousRegion" value="position.[0,0,0]" sector="$TheVoid"/>
                </do_if>

                <set_value name="$HazardousSafePos" exact="if ($HazardousLocations.count) then $HazardousLocations.random else $BackupHazardousRegion"/>


                <set_value name="$RandomPitch" min="0deg" max="360deg"/>
                <set_value name="$RandomRoll" min="0deg" max="360deg"/>
                <set_value name="$RandomYaw" min="0deg" max="360deg"/>

                <create_loadout result="$loadout_Yaki_Ship" comment="BettyShip Loadout">
                  <macros>
                    <engine macro="engine_par_s_combat_01_mk3_macro" path="../con_engine_02"/>
                    <engine macro="engine_par_s_combat_01_mk3_macro" path="../con_engine_01"/>
                    <weapon macro="weapon_gen_s_beam_01_mk2_macro" path="../con_weapon_02"/>
                    <weapon macro="weapon_gen_s_burst_01_mk2_macro" path="../con_weapon_04"/>
                    <weapon macro="weapon_gen_s_burst_01_mk2_macro" path="../con_weapon_03"/>
                    <weapon macro="weapon_gen_s_beam_01_mk2_macro" path="../con_weapon_01"/>
                    <shield macro="shield_par_s_standard_01_mk3_macro" path="../con_shield_01"/>
                  </macros>
                  <ammunition>
                    <ammunition macro="env_deco_nav_beacon_t1_macro" exact="2"/>
                    <ammunition macro="ship_gen_xs_lasertower_01_a_macro"/>
                    <ammunition macro="eq_arg_satellite_02_macro"/>
                    <ammunition macro="weapon_gen_mine_03_macro"/>
                    <ammunition macro="countermeasure_flares_01_macro" exact="4"/>
                  </ammunition>
                  <software>
                    <software ware="software_dockmk1"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk1"/>
                    <software ware="software_scannerobjectmk1"/>
                    <software ware="software_targetmk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_s_combat_01_mk3_macro"/>
                  </virtualmacros>
                </create_loadout>

                <!-- ship_yak_s_fighter_01_a_macro is not ready yet - insufficient scanner  ship_ter_s_scout_01_a_macro -->
                <create_ship name="$BettyShip" capturable="false" commandeerable="false" sellable="false"
                             missioncue="namespace" macro="ship_yak_s_fighter_01_a_macro" sector="$TheVoid">
                  <owner exact="$BettyFaction_Init"/>
                  <loadout loadout="$loadout_Yaki_Ship"/>
                  <pilot actor="$BettyPilotActor"/>
                  <!--<select race="race.drone" tags="tag.aipilot"/>                            
                          </pilot>-->
                  <people>
                    <fillpercent exact="0"/>
                  </people>
                  <paint ware="ware.paintmod_0115"/>

                  <position x="$HazardousSafePos.x" y="$HazardousSafePos.y" z="$HazardousSafePos.z"/>
                  <rotation pitch="$RandomPitch" roll="$RandomRoll" yaw="$RandomYaw"/>
                </create_ship>
                <set_object_relation_behaviour object="$BettyShip" disable="true"/>
                <set_ship_safepos_allowed ship="$BettyShip" allow="false"/>
                <set_object_npc_assignment_restricted object="$BettyShip" restricted="false"/>

                <set_value name="$ShowBettyShipCutscene" exact="true" comment="(not player.ship) or (player.ship != $BettyShip)"/>

                <create_position name="$ShipPos" object="$BettyShip" space="$BettyShip.sector"/>
                <do_if value="$TheVoid.hashazardousregionat.{$ShipPos}">
                  <debug_text text="'BettyShip is in a Hazard as intended [Heinrich]'" chance="$DebugChance"/>
                </do_if>
                <do_else>
                  <debug_text text="'BettyShip is Not in a Hazard! [Heinrich]'" chance="$DebugChance"/>
                </do_else>

                <!--<set_ship_safepos_allowed ship="$BettyShip" allow="false"/>-->
                <cancel_all_orders object="$BettyShip"/>
                <create_order id="'Wait'" object="$BettyShip" default="true">
                  <param name="noattackresponse" value="true"/>
                </create_order>

                <set_object_radar_visible object="$BettyShip" visible="false"/>
                <set_object_name object="$BettyShip" page="30226" line="236" comment="Expedition Ship"/>
                <!--
                30224 201 Expedition Ship
                30226	236	Geometric Owl-->

                <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                  <param name="Object" value="$BettyShip"/>
                  <param name="RequesterCue" value="namespace"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>

                <set_object_hull object="$BettyShip" exact="95"/>
                <set_object_docking_enabled object="$BettyShip" enabled="false"/>
              </actions>
            </cue>

            <cue name="Ch5_Setup_BettyShip_Behaviour" comment="activated when the player first docks">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Patch_Ch4_MissionShip" onfail="cancel" comment="parent cancelled if the story is over and invincibility removed">
                  <conditions>
                    <check_value value="$BettyShip.exists"/>
                    <check_value value="player.ship != $BettyShip"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                      <param name="Object" value="$BettyShip"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="Setup_BettyShip_Player_Init">
                  <actions>
                    <signal_cue cue="Setup_BettyShip_Player_Inside"/>
                    <!--<signal_cue cue="Setup_BettyShip_Player_Outside"/>-->
                    <signal_cue cue="Setup_Bettyship_CoverOwner_Set"/>
                  </actions>
                </cue>

                <cue name="Setup_Betty_Invincibility">
                  <!-- Handler for BettyShip invulnerability while docking at vulnerable places -->
                  <actions>
                    <create_group groupname="$BettyShip_DockingGroup"/>
                    <add_to_group groupname="$BettyShip_DockingGroup" object="$BettyShip"/>

                    <create_group groupname="$BettyShip_DockingGroup_InvulnerableContainers" comment="No purpose, except for later debugging"/>
                  </actions>
                  <cues>

                    <cue name="Setup_BettyInvincibility_PopulateGroup" instantiate="true">
                      <conditions>
                        <event_object_docked group="$BettyShip_DockingGroup"/>
                        <debug_text text="event.object.knownname + ' ' + event.object" debugchance="$DebugChance"/>
                        <check_any>
                          <check_value value="event.object == $BettyShip" comment="S"/>
                          <check_value value="event.object == $BettyShip.container" comment="M"/>
                          <check_value value="event.object == $BettyShip.container.container" comment="L - stop here as stations don't dock (yet)"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Before: ' + $BettyShip_DockingGroup.count + $BettyShip_DockingGroup" chance="$DebugChance"/>

                        <!-- event.object.container == event.param (returns the ship, not the dock) -->
                        <add_to_group groupname="$BettyShip_DockingGroup" object="event.param" comment="worst case: M"/>

                        <do_if value="@event.param.container" comment="worst case: L ship">
                          <add_to_group groupname="$BettyShip_DockingGroup" object="event.param.container"/>

                          <do_if value="@event.param.container.container" comment="worst case: station">
                            <add_to_group groupname="$BettyShip_DockingGroup" object="event.param.container.container"/>
                          </do_if>

                        </do_if>

                        <do_if value="$BettyShip != player.ship">
                          <signal_cue cue="Setup_Betty_Invincibility_Request_Invulnerability_Group"/>
                        </do_if>

                        <debug_text text="'After: ' + $BettyShip_DockingGroup.count + $BettyShip_DockingGroup" chance="$DebugChance"/>
                      </actions>
                    </cue>

                    <cue name="Setup_Betty_Invincibility_Undocking" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_undocked group="$BettyShip_DockingGroup"/>
                          <event_cue_signalled/>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Before: ' + $BettyShip_DockingGroup.count + $BettyShip_DockingGroup" chance="$DebugChance"/>

                        <signal_cue_instantly cue="Setup_Betty_Invincibility_Request_Vulnerability_" param="event.param"/>
                        <remove_from_group group="$BettyShip_DockingGroup" object="event.param"/>

                        <do_if value="@event.param.container" comment="worst case: L ship">
                          <signal_cue_instantly cue="Setup_Betty_Invincibility_Request_Vulnerability_" param="event.param.container"/>
                          <remove_from_group group="$BettyShip_DockingGroup" object="event.param.container"/>

                          <do_if value="@event.param.container.container" comment="worst case: station">
                            <signal_cue_instantly cue="Setup_Betty_Invincibility_Request_Vulnerability_" param="event.param.container.container"/>
                            <remove_from_group group="$BettyShip_DockingGroup" object="event.param.container.container"/>
                          </do_if>

                        </do_if>

                        <debug_text text="'After: ' + $BettyShip_DockingGroup.count + $BettyShip_DockingGroup" chance="$DebugChance"/>
                      </actions>
                    </cue>

                    <cue name="Setup_Betty_Invincibility_Request_Invulnerability_Group" instantiate="true">
                      <!-- Signalled when the player leaves $BettyShip -->
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="''" chance="$DebugChance"/>
                        <do_for_each in="$BettyShip_DockingGroup" name="$Object">
                          <do_if value="$BettyShip != $Object">
                            <signal_cue_instantly cue="Setup_Betty_Invincibility_Request_Invulnerability" param="$Object"/>
                          </do_if>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="Setup_Betty_Invincibility_Request_Vulnerability_Group" instantiate="true">
                      <!-- Signalled when the player is in $BettyShip after a timeout after entering -->
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="''" chance="$DebugChance"/>
                        <do_for_each in="$BettyShip_DockingGroup" name="$Object" comment="Either a ship or a station">
                          <do_if value="$BettyShip != $Object">
                            <signal_cue_instantly cue="Setup_Betty_Invincibility_Request_Vulnerability_" param="$Object"/>
                          </do_if>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="Setup_Betty_Invincibility_Request_Invulnerability" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'' + event.param.knownname" chance="$DebugChance"/>
                        <add_to_group groupname="$BettyShip_DockingGroup_InvulnerableContainers" object="event.param"/>
                        <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                          <param name="Object" value="event.param"/>
                          <param name="RequesterCue" value="namespace"/>
                          <param name="ReachedThresholdSignalCue" value="Setup_Betty_Invulnerability_Rescue"/>
                          <param name="DebugChance" value="$DebugChance"/>
                        </run_actions>
                      </actions>
                    </cue>

                    <cue name="Setup_Betty_Invincibility_Request_Vulnerability_" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'' + event.param.knownname" chance="$DebugChance"/>
                        <remove_from_group group="$BettyShip_DockingGroup_InvulnerableContainers" object="event.param"/>
                        <do_if value="event.param != $ResearchShip">
                          <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                            <param name="Object" value="event.param"/>
                            <param name="RequesterCue" value="namespace"/>
                            <param name="DebugChance" value="$DebugChance"/>
                            <param name="CheckObjectPresence" value="false"/>
                          </run_actions>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Setup_Betty_Invulnerability_Rescue" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="''" chance="$DebugChance"/>
                        <signal_cue_instantly cue="Setup_Betty_Invincibility_Undocking" param="$BettyShip.container" comment="Undock and set all ships vulnerable"/>

                        <!-- Warp Ship breaking docking? -->
                        <signal_cue cue="Setup_BettyShip_Msg_DangerContainerCritical" check="false"/>
                        <warp object="$BettyShip" sector="$BettyShip.sector">
                          <safepos object="$BettyShip" space="$BettyShip.sector"/>
                        </warp>
                      </actions>
                    </cue>

                    <cue name="Debug_BettyShip_DockingGroup" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_object_docked group="$BettyShip_DockingGroup"/>
                          <event_object_undocked group="$BettyShip_DockingGroup"/>
                          <event_object_destroyed group="$BettyShip_DockingGroup"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="event.name != 'event_cue_signalled'">
                          <debug_text text="'Betty Docking Group Event: ' + event.name + ' ' + event.object.knownname" chance="$DebugChance"/>
                        </do_if>
                        <do_for_each in="$BettyShip_DockingGroup" name="$object">
                          <do_if value="$object.isclass.ship">
                            <debug_text text="$object.knownname + ' is inv: ' + $object.isindestructible" chance="$DebugChance"/>
                          </do_if>
                          <do_else>
                            <check_object result="$IsIndestructible" object="$object">
                              <match_child class="class.module" indestructible="true"/>
                            </check_object>
                            <debug_text text="$object.knownname + ' is inv: ' + $IsIndestructible" chance="$DebugChance"/>
                          </do_else>
                        </do_for_each>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Setup_BettyShip_PlayerDestroyed">
                  <cues>
                    <cue name="Setup_BettyShip_KillPlayer_Event">
                      <conditions>
                        <event_object_destroyed object="$BettyShip"/>
                      </conditions>
                      <actions>
                        <do_if value="(cuestate.complete == Ch6_Torus.state) and $TorusComputerActivated?">
                          <signal_cue_instantly cue="Setup_BettyShip_PlayerDestroyed_TorusMessage"/>
                        </do_if>
                        <do_else>
                          <signal_cue_instantly cue="Setup_BettyShip_PlayerDestroyed_BettyMessage"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Setup_BettyShip_PlayerDestroyed_TorusMessage">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Setup_BettyShip_PlayerDestroyed_TorusMessage_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$TorusActor"/>
                          <param name="WaitForFullscreen" value="false"/>
                          <param name="Cutscene"          value="false"/>
                          <param name="CutsceneKey"       value="$TorusActorCutsceneKey"/>
                          <param name="Lines"             value="[[[30224643], [30224644]].random]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--                      
                           <t id="30224643">You will not leave.</t>
                           <t id="30224644">Intrusion disposal complete.</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Setup_BettyShip_PlayerDestroyed_BettyMessage">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Setup_BettyShip_PlayerDestroyed_BettyMessage_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="WaitForFullscreen" value="false"/>
                          <param name="Cutscene"          value="false"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[[30224714], [30224708]].random]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--                      
                           <t id="30224714">Farewell, Pilot #3.(# spoken as 'number')</t>
                           <t id="30224708">Farewell, creator.</t>
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Setup_BettyShip_Messages">
                  <cues>
                    <cue name="BettyShip_Stop_Messages">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$Stop_BettyShip_Messages"/>
                        <cancel_cue cue="Setup_BettyShip_Player_Inside"/>
                        <!--<cancel_cue cue="Setup_BettyShip_Player_Outside"/>-->
                      </actions>
                      <delay exact="10s"/>
                      <actions>
                        <cancel_cue cue="Ch5_Setup_BettyShip_Behaviour"/>
                      </actions>
                    </cue>

                    <cue name="Setup_BettyShip_Msg_WeaponsOperational" instantiate="false" comment="run only once at a time, don't queue up">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Stop_BettyShip_Messages?"/>
                        <check_value value="player.ship == $BettyShip"/>
                        <check_any>
                          <check_value value="not md.$MissionDND.count"/>
                          <check_all>
                            <check_value value="(1 == md.$MissionDND.count)"/>
                            <check_value value="md.$MissionDND.{1} == md.Story_Terraforming.Ch6_Setup_Deactivate_Chatter_Near_Torus"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <cues>
                        <cue name="Setup_BettyShip_Msg_WeaponsOperational_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224421]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Setup_BettyShip_Msg_WeaponsOperational_Reset"/>
                          <!--                      
                      <t id="	30224421	">Weapons operational.	</t>
                      -->
                        </cue>
                        <cue name="Setup_BettyShip_Msg_WeaponsOperational_Reset">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <reset_cue cue="Setup_BettyShip_Msg_WeaponsOperational"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Setup_BettyShip_Msg_DangerContainerCritical" instantiate="false" comment="run only once at a time, don't queue up">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Stop_BettyShip_Messages?"/>
                        <check_any>
                          <check_value value="not md.$MissionDND.count"/>
                          <check_all>
                            <check_value value="(1 == md.$MissionDND.count)"/>
                            <check_value value="md.$MissionDND.{1} == md.Story_Terraforming.Ch6_Setup_Deactivate_Chatter_Near_Torus"/>
                          </check_all>
                        </check_any>
                        <check_value value="player.ship != $BettyShip"/>
                      </conditions>
                      <cues>
                        <cue name="Setup_BettyShip_Msg_DangerContainerCritical_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[4], [60]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Setup_BettyShip_Msg_DangerContainerCritical_Reset"/>
                          <!--                      
                           <t id="4">Alert!</t>
                           <t id="60">Explosion imminent.</t>
                      -->
                        </cue>
                        <cue name="Setup_BettyShip_Msg_DangerContainerCritical_Reset">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <reset_cue cue="Setup_BettyShip_Msg_DangerContainerCritical"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Setup_BettyShip_Msg_AwaitingPilot" instantiate="false" comment="run only once at a time, don't queue up">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Stop_BettyShip_Messages?"/>
                        <check_value value="not md.$MissionDND.count"/>
                        <check_value value="player.ship != $BettyShip"/>
                      </conditions>
                      <cues>
                        <cue name="Setup_BettyShip_Msg_AwaitingPilot_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224618]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Setup_BettyShip_Msg_AwaitingPilot_Reset"/>
                          <!--                      
                      <t id="	30224618	">Awaiting pilot.	</t>
                      -->
                        </cue>
                        <cue name="Setup_BettyShip_Msg_AwaitingPilot_Reset">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <reset_cue cue="Setup_BettyShip_Msg_AwaitingPilot"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Setup_BettyShip_Msg_CommandRejected" instantiate="false" comment="run only once at a time, don't queue up">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$BettyShip.pilot != player"/>
                        <check_any>
                          <check_value value="not md.$MissionDND.count"/>
                          <check_all>
                            <check_value value="(1 == md.$MissionDND.count)"/>
                            <check_value value="md.$MissionDND.{1} == md.Story_Terraforming.Ch6_Setup_Deactivate_Chatter_Near_Torus"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <cues>
                        <cue name="Setup_BettyShip_Msg_CommandRejected_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="WaitForFullscreen" value="false"/>
                          <param name="Cutscene"          value="not player.isinfullscreenmenu"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224722], [277], [30224724]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Setup_BettyShip_Msg_CommandRejected_Reset"/>
                          <!--
                              <text line="30224722" comment="Pilot not recognised."/>
                              <text line="277" comment="Access denied."/>
                              <text line="30224724" comment="Awaiting pilot #3."/>
                              
                          <t id="508">Lifeform detected.</t>
                          
                          <t id="277">Access denied.</t>
                          <t id="133">Command rejected.</t>
                          <t id="	30224618	">Awaiting pilot.	</t>
                          -->
                        </cue>
                        <cue name="Setup_BettyShip_Msg_CommandRejected_Reset">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="$BettyShip.pilot != player.entity">
                              <signal_objects object="$BettyShip.pilot" param="'npc__leave_post'"/>
                            </do_if>
                            <reset_cue cue="Setup_BettyShip_Msg_CommandRejected"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Setup_BettyShip_Msg_WelcomePilot__Delayed" instantiate="false">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Stop_BettyShip_Messages?"/>
                        <check_any>
                          <check_value value="not md.$MissionDND.count"/>
                          <check_all>
                            <check_value value="(1 == md.$MissionDND.count)"/>
                            <check_value value="md.$MissionDND.{1} == md.Story_Terraforming.Ch6_Setup_Deactivate_Chatter_Near_Torus"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <signal_cue cue="Setup_BettyShip_Msg_WelcomePilot"/>
                        <reset_cue cue="this"/>
                      </actions>
                    </cue>

                    <cue name="Setup_BettyShip_Msg_WelcomePilot" instantiate="false" comment="run only once at a time, don't queue up">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Stop_BettyShip_Messages?"/>
                        <check_any>
                          <check_value value="not md.$MissionDND.count"/>
                          <check_all>
                            <check_value value="(1 == md.$MissionDND.count)"/>
                            <check_value value="md.$MissionDND.{1} == md.Story_Terraforming.Ch6_Setup_Deactivate_Chatter_Near_Torus"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <cues>
                        <cue name="Setup_BettyShip_Msg_WelcomePilot_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224415]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Setup_BettyShip_Msg_WelcomePilot_Reset"/>
                          <!--                      
                           <t id="	30224415	">Welcome, Pilot #3.(# spoken as 'number')	</t>
                           -->
                        </cue>
                        <cue name="Setup_BettyShip_Msg_WelcomePilot_Reset">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <reset_cue cue="Setup_BettyShip_Msg_WelcomePilot"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Setup_BettyShip_Msg_GoodbyePilot" instantiate="false" comment="run only once at a time, don't queue up">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Stop_BettyShip_Messages?"/>
                        <check_any>
                          <check_value value="not md.$MissionDND.count"/>
                          <check_all>
                            <check_value value="(1 == md.$MissionDND.count)"/>
                            <check_value value="md.$MissionDND.{1} == md.Story_Terraforming.Ch6_Setup_Deactivate_Chatter_Near_Torus"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <cues>
                        <cue name="Setup_BettyShip_Msg_GoodbyePilot_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224720], [30224721]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Setup_BettyShip_Msg_GoodbyePilot_Reset"/>
                          <!--                      
                           <t id="30224720">Piloting access restricted.</t>
                           <t id="30224721">Logging off pilot #3.(speak # as "number")</t>
                           -->
                        </cue>
                        <cue name="Setup_BettyShip_Msg_GoodbyePilot_Reset">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <reset_cue cue="Setup_BettyShip_Msg_GoodbyePilot"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Setup_Bettyship_Coverowner_Test">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$AcquiredTerranScan"/>
                  </actions>
                </cue>

                <cue name="Setup_Bettyship_CoverOwner_Set" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$AcquiredTerranScan?">
                      <set_object_npc_assignment_restricted object="$BettyShip" restricted="true"/>
                      <signal_cue_instantly cue="md.Cover.TriggerCover" param="[$BettyShip, faction.terran]"/>

                      <!--<do_if value="Ch5_Evade_Patrols.state == cuestate.complete">
                        <signal_cue cue="Ch5_Hint_BettyShip_ID_Masked"/>
                      </do_if>-->
                    </do_if>
                  </actions>
                </cue>


                <cue name="Setup_BettyShip_Hacked" instantiate="true" checkinterval="4s">
                  <!--
                  Prevent the ship from following any orders
                  -->
                  <conditions>
                    <check_value value="player.entity.object != $BettyShip"/>
                  </conditions>
                  <actions>
                    <find_object_component name="$Weapons" multiple="true" object="$BettyShip" class="class.weapon"/>
                    <do_for_each name="$Weapon" in="$Weapons">
                      <set_object_hacked object="$Weapon" duration="5s"/>
                    </do_for_each>
                    <find_object_component name="$Engines" multiple="true" object="$BettyShip" class="class.engine"/>
                    <do_for_each name="$Engine" in="$Engines">
                      <set_object_hacked object="$Engine" duration="5s"/>
                    </do_for_each>
                  </actions>
                </cue>

                <cue name="Setup_BettyShip_PlayerGaveOrder" instantiate="true">
                  <conditions>
                    <event_object_order_ready object="$BettyShip"/>
                    <check_value value="$BettyShip.pilot"/>
                  </conditions>
                  <actions>
                    <cancel_all_orders object="$BettyShip"/>
                    <!--<debug_text text="'Cancelling Orders for BettyShip [Heinrich]'" chance="$DebugChance"/>-->
                    <signal_cue cue="Setup_BettyShip_Msg_CommandRejected" check="false"/>
                  </actions>
                </cue>

                <cue name="Setup_BettyShip_Player_Inside" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_object_changed_object object="player.entity"/>
                      <event_cue_signalled/>
                    </check_any>
                    <check_value value="player.ship == $BettyShip"/>
                  </conditions>
                  <actions>
                    <set_emergency_eject_active active="false"/>
                    <set_object_radar_visible object="$BettyShip" visible="true"/>
                    <dismiss_control_entity actor="$BettyPilotActor" object="$BettyShip"/>
                    <remove_actor_from_room actor="$BettyPilotActor"/>

                    <signal_cue cue="Setup_BettyShip_Msg_WelcomePilot__Delayed" check="false"/>
                    <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                      <param name="Ship" value="$BettyShip"/>
                      <param name="Faction" value="faction.player"/>
                    </run_actions>

                    <!-- Objectives to get back to the Ship -->
                    <do_if value="Ch5_Evade_Patrols.state == cuestate.complete">
                      <!-- Set the correct objective // Ch5 Missions -->
                      <do_if value="$CurrentObjective == 'ScanLeak'">
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$TargetStation" updatebriefing="true" silent="true"/>
                      </do_if>
                      <do_elseif value="$CurrentObjective == 'ScanLeak_Leak'">
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$SignalLeak" updatebriefing="true" silent="true"/>
                      </do_elseif>
                      <do_elseif value="$CurrentObjective == 'FlyToTorus'" comment="Avoid military patrols. Fly to: Torus.knownname">
                        <signal_cue cue="Ch5_Objective_FlyToTorus"/>
                      </do_elseif>
                      <do_elseif value="$CurrentObjective == 'LeavePoliceRadarRange'" comment="Signature Mask Failing - Leave Terran Radar Range">
                        <signal_cue cue="Ch5_Objective_LeavePoliceRadarRange"/>
                      </do_elseif>
                      <do_elseif value="$CurrentObjective == 'LeaveCoreSector'" comment="Leave: Terran Space">
                        <signal_cue cue="Ch5_Objective_LeaveCoreSector"/>
                      </do_elseif>
                      <do_else>
                        <set_objective cue="$MissionCue" action="objective.wait"/>
                      </do_else>
                    </do_if>
                    <do_elseif value="Ch7_Rendezvous.state == cuestate.complete">
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.dockat" group="$ResearchShipGroup" updatebriefing="true"/>
                      <do_if value="player.ship != $BettyShip">
                        <do_if value="$BettyShip.dock">
                          <set_objective cue="$MissionCue" action="objective.embark" object="$BettyShip"/>
                        </do_if>
                        <do_else>
                          <set_objective cue="$MissionCue" action="objective.dockat" object="$BettyShip"/>
                        </do_else>
                      </do_if>
                    </do_elseif>

                    <!-- Hack Weapons so they cannot be abused during invulnerability -->
                    <set_value name="$InvulnerabilityDuration" exact="10s"
                               comment="time between the player entering and invulnerability being removed"/>
                    <find_object_component name="$Weapons" multiple="true" object="$BettyShip" class="class.weapon"/>
                    <do_for_each name="$Weapon" in="$Weapons">
                      <set_object_hacked object="$Weapon" duration="$InvulnerabilityDuration"/>
                    </do_for_each>

                    <signal_cue cue="Setup_Bettyship_CoverOwner_Set"/>

                    <signal_cue cue="Setup_BettyShip_Inside_Vulnerability"/>
                  </actions>
                  <cues>
                    <cue name="Setup_BettyShip_Player_Outside">
                      <conditions>
                        <event_object_changed_object object="player.entity"/>
                        <check_value value="player.entity.object != $BettyShip"/>
                      </conditions>
                      <actions>
                        <set_emergency_eject_active active="true"/>
                        <do_if value="Ch5_Evade_Patrols.state == cuestate.complete">
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.dockat" object="$BettyShip" updatebriefing="true"/>
                          <signal_cue cue="Setup_BettyShip_Msg_AwaitingPilot" check="false"/>
                        </do_if>
                        <do_elseif value="Ch7_Rendezvous.state == cuestate.complete">
                          <do_if value="$BettyShip.dock">
                            <set_objective cue="$MissionCue" action="objective.embark" object="$BettyShip"/>
                          </do_if>
                          <do_else>
                            <set_objective cue="$MissionCue" action="objective.dockat" object="$BettyShip"/>
                          </do_else>
                          <signal_cue cue="Setup_BettyShip_Msg_AwaitingPilot" check="false"/>
                        </do_elseif>

                        <cancel_all_orders object="$BettyShip"/>
                        <create_order id="'Wait'" object="$BettyShip" default="true" comment="stay put">
                          <param name="noattackresponse" value="true"/>
                        </create_order>

                        <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                          <param name="Object" value="$BettyShip"/>
                          <param name="RequesterCue" value="namespace"/>
                          <param name="DebugChance" value="$DebugChance"/>
                        </run_actions>
                        <signal_cue_instantly cue="Setup_Betty_Invincibility_Request_Invulnerability_Group"/>
                        <!--<set_object_min_hull object="$BettyShip" exact="1"/>-->
                      </actions>
                      <delay exact="3s"/>
                      <actions>
                        <do_if value="player.ship != $BettyShip">
                          <do_if value="Ch6_Torus.state != cuestate.complete">
                            <signal_cue_instantly cue="Setup_BettyShip_Msg_GoodbyePilot" check="false"/>
                          </do_if>
                        </do_if>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Setup_BettyShip_Inside_Vulnerability" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="player.entity.object == $BettyShip" comment="catch players who left again"/>
                  </conditions>
                  <delay exact="$InvulnerabilityDuration" comment="Give the player time to take control and fly out of immediate danger"/>
                  <actions>
                    <!-- <set_object_min_hull object="$BettyShip" exact="0"/> -->
                    <do_if value="player.entity.object == $BettyShip">
                      <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                        <param name="Object" value="$BettyShip"/>
                        <param name="RequesterCue" value="namespace"/>
                        <param name="DebugChance" value="$DebugChance"/>
                      </run_actions>
                      <signal_cue_instantly cue="Setup_Betty_Invincibility_Request_Vulnerability_Group"/>
                      <signal_cue cue="Setup_BettyShip_Msg_WeaponsOperational" check="false"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch5_Hint_BettyShip_ID_Masked" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch5_Hint_BettyShip_ID_Masked_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224503]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--                      
                      <t id="	30224503	">	{10002,30224502}(Ship ID) masked.	</t>
                      -->
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch5_Hint_BettyShip_ID_Lost" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch5_Hint_BettyShip_ID_Lost_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224504]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--                      
                      <t id="	30224504	">	{10002,30224502}(Ship ID) reset.	</t>
                      -->
                    </cue>
                  </cues>
                </cue>


                <cue name="Setup_BettyShip_Relation">
                  <cues>
                    <cue name="Setup_BettyShip_Reset_Relation" instantiate="true">
                      <conditions>
                        <event_player_relation_changed />
                        <check_any>
                          <check_value value="event.object == $BettyShip"/>
                          <check_value value="event.object == $BettyShip.pilot"/>
                        </check_any>
                        <check_value value="event.param2.{1} lt $RelationBoostDocking" comment="Only if the relation drops below docking relations"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Relation Reset Triggered for $BettyShip'" chance="$DebugChance"/>
                        <set_relation_boost object="$BettyShip" faction="faction.player" value="$RelationBoostDocking" comment="Boost Reset" decay="0"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_Setup_Deactivate_Chatter_Near_Torus">
              <conditions>
                <check_any>
                  <event_cue_signalled cue="Ch6_Torus"/>
                  <event_cue_completed cue="Ch6_Torus"/>
                </check_any>
              </conditions>
              <cues>

                <cue name="Ch6_Torus_InRange">
                  <cues>
                    <cue name="Ch6_Torus_InRange_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="player.entity"/>
                      <param name="ApproachTarget"    value="$EarthTorus"/>
                      <param name="ApproachDistance"  value="15km"/>
                      <param name="SuccessSignalCue"  value="Ch6_Deactivate_Chatter"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Deactivate_Chatter">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="cuestate.waiting == Ch6_Setup_Reactivate_Chatter_Near_Torus.state"/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressChatter_AddCue">
                      <param name="Cue" value="Ch6_Setup_Deactivate_Chatter_Near_Torus"/>
                    </run_actions>
                    <set_value name="$Ch6_Deactivate_Chatter"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_Torus_OutOfRange" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="player.entity"/>
                      <param name="ApproachTarget"    value="$EarthTorus"/>
                      <param name="ApproachDistance"  value="15km"/>
                      <param name="Invert"            value="true" comment="Check for the player leaving the vicinity"/>
                      <param name="SuccessSignalCue"  value="Ch6_Reactivate_Chatter"/>
                    </cue>

                    <cue name="Ch6_Reactivate_Chatter">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="cuestate.waiting == Ch6_Setup_Reactivate_Chatter_Near_Torus.state"/>
                      </conditions>
                      <actions>
                        <reset_cue cue="Ch6_Deactivate_Chatter"/>
                        <run_actions ref="md.LIB_Generic.SuppressChatter_RemoveCue">
                          <param name="Cue" value="Ch6_Setup_Deactivate_Chatter_Near_Torus"/>
                        </run_actions>
                        <remove_value name="$Ch6_Deactivate_Chatter"/>
                        <reset_cue cue="Ch6_Torus_InRange"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Setup_Reactivate_Chatter_Near_Torus">
                  <conditions>
                    <event_cue_signalled cue="Ch7_Rendezvous"/>
                  </conditions>
                  <actions>
                    <do_if value="$Ch6_Deactivate_Chatter?">
                      <run_actions ref="md.LIB_Generic.SuppressChatter_RemoveCue">
                        <param name="Cue" value="Ch6_Setup_Deactivate_Chatter_Near_Torus"/>
                      </run_actions>
                    </do_if>
                    <cancel_cue cue="Ch6_Torus_InRange"/>
                    <cancel_cue cue="Ch6_Deactivate_Chatter"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Debug">
          <cues>
            <cue name="Debug_Destroy_ResearchShip" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <destroy_object object="$ResearchShip" explosion="true"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Story_TF" onfail="cancel">
              <conditions>
                <check_value value="player.debug" comment="skipper only in debug builds"/>
              </conditions>
              <cues>

                <cue name="Debug_SkipperShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.Debug_Setup_SkipperShip_Create"/>
                  </actions>
                </cue>

                <cue name="Debug_SkipperShip_Completed">
                  <conditions>
                    <event_cue_completed cue="md.Setup.Debug_Setup_SkipperShip_Create_Completed"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="Debug_Skipper_CreateActor"/>
                    <signal_cue cue="Debug_Skipper_Spawn"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_CreateActor">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_cue_actor name="$SkipperActor" cue="$MissionCue" macro="character_yaki_paranid_plot_scientist_macro">
                      <owner exact="faction.civilian"/>
                      <name name="'Story Terraforming Skipper'"/>
                    </create_cue_actor>
                    <set_entity_type entity="$SkipperActor" type="entitytype.crowd"/>
                    <set_entity_traits entity="$SkipperActor" missionactor="true" customhandler="true"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Spawn" instantiate="true" comment="placed by SkipperShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$SkipperPos" x="12.5" y="-2.8m" z="-0.8"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = md.Setup.Debug_Setup_SkipperShip.$SkipperShip.controlroom,
                                                                                                                                      $position = $SkipperPos,
                                                                                                                                      $rotation = rotation.[250deg, 0deg, 0deg],
                                                                                                                                      $debugchance = 0,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Disconnect" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation">
                  <conditions>
                    <event_cue_completed cue="Debug_Skipper_CreateActor"/>
                  </conditions>
                  <cues>

                    <cue name="Debug_Skipper_Despawn" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_despawn"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Debug_Skipper_Disconnect"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Conversation_Start" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$SkipperActor"/>
                      </conditions>
                      <actions>
                        <add_player_choice highlighted="true" section="skipper_main" text="'PLEASE SAVE YOUR GAME'"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Conv_Main" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_main"/>
                      </conditions>
                      <actions>
                        <add_player_choice_sub section="skipper_chapter_tf" text="'Skip to Story Terraforming Chapter'"/>
                        <add_player_choice_sub section="skipper_antimatter" text="'Add Antimatter to Player.Ship'" selectable="false"/>
                        <add_player_choice_sub section="skipper_suit" text="'Arm Spacesuit'"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Antimatter" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_antimatter"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Debug_Ch1_Add_DeliveryWares_Antimatter"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Suit" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_suit"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Debug_Arm_Spacesuit"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Chapters" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$SkipperActor" section="skipper_chapter_tf"/>
                      </conditions>
                      <actions>
                        <add_player_choice_sub section="skipper_ch1" text="'Skip to TF Ch 1'"/>
                        <add_player_choice_sub section="skipper_ch2" text="'Skip to TF Ch 2'"/>
                        <add_player_choice_sub section="skipper_ch4" text="'Skip to TF Ch 4'"/>
                        <add_player_choice_sub section="skipper_ch5" text="'Skip to TF Ch 5'" selectable="true"/>
                        <add_player_choice_sub section="skipper_ch6" text="'Skip to TF Ch 6'"/>
                        <add_player_choice_sub section="skipper_ch7" text="'Skip to TF Ch 7'"/>
                      </actions>
                    </cue>

                    <cue name="Debug_Skipper_Force_Chapter" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_ch1"/>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_ch2"/>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_ch3"/>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_ch4"/>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_ch5"/>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_ch6"/>
                          <event_conversation_next_section actor="$SkipperActor" section="skipper_ch7"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="event.param != 'skipper_ch1'">
                          <cancel_cue cue="Ch1_Intro"/>
                        </do_if>

                        <do_if value="event.param == 'skipper_ch1'">
                          <force_cue cue="Ch1_Force"/>
                        </do_if>
                        <do_elseif value="event.param == 'skipper_ch2'">
                          <force_cue cue="Ch2_Force"/>
                        </do_elseif>
                        <do_elseif value="event.param == 'skipper_ch3'">
                          <force_cue cue="Ch3_Force"/>
                        </do_elseif>
                        <do_elseif value="event.param == 'skipper_ch4'">
                          <force_cue cue="Ch4_Force"/>
                        </do_elseif>
                        <do_elseif value="event.param == 'skipper_ch5'">
                          <force_cue cue="Ch5_Force"/>
                        </do_elseif>
                        <do_elseif value="event.param == 'skipper_ch6'">
                          <force_cue cue="Ch6_Force"/>
                        </do_elseif>
                        <do_elseif value="event.param == 'skipper_ch7'">
                          <force_cue cue="Ch7_Force"/>
                        </do_elseif>
                      </actions>
                    </cue>
                  </cues>
                </cue>


              </cues>
            </cue>

            <cue name="Debug_Delete_Khaak_Xenon">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_ship_by_true_owner faction="faction.khaak" multiple="true" space="player.galaxy" groupname="$DebuggingPests"/>
                <find_ship_by_true_owner faction="faction.xenon" multiple="true" space="player.galaxy" groupname="$DebuggingPests"/>
                <destroy_group group="$DebuggingPests"/>
              </actions>
            </cue>

            <cue name="Debug_Switch_Set_Object_Hull_Unrepairable">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_object_component name="$EarthTorusDoorControls_30" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_30" required="true"/>
              </actions>
              <cues>

                <cue name="Debug_Switch_Set_Unrepairable" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_object_hull_unrepairable object="$EarthTorusDoorControls_30" unrepairable="true"/>
                    <debug_text text="'Set Unrepairable'"/>
                  </actions>
                </cue>

                <cue name="Debug_Switch_Set_Repairable" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_object_hull_unrepairable object="$EarthTorusDoorControls_30" unrepairable="false"/>
                    <debug_text text="'Set Repairable'"/>
                  </actions>
                </cue>

                <cue name="Debug_Switch_Test_MAXHULL" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_object_hull object="$EarthTorusDoorControls_30" exact="$SwitchHullMax"/>
                    <debug_text text="'Set Max Hull'"/>
                  </actions>
                </cue>

                <cue name="Debug_Switch_Test_MINHULL" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_object_hull object="$EarthTorusDoorControls_30" exact="$SwitchHullMin"/>
                    <debug_text text="'Set Min Hull'"/>
                  </actions>
                </cue>
              </cues>
            </cue>


            <cue name="Debug_Set_ResearchShip_Radar_Visible">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_object_radar_visible object="$ResearchShip" visible="true"/>
              </actions>
            </cue>

            <cue name="Debug_Setup_HQ">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <cancel_cue cue="md.X4Ep1_Mentor_Subscriptions.Phase_SignalLeak"/>
              </actions>
              <cues>
                <cue name="Debug_Spawn_HQ">
                  <delay exact="5ms"/>
                  <actions>
                    <do_if value="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors.state == cuestate.waiting and not md.X4Ep1_Mentor_Subscriptions.Start.$HQ?">
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors" param="true"/>
                    </do_if>
                    <do_elseif value="md.X4Ep1_Mentor_Subscriptions.Start.$HQ? and not md.X4Ep1_Mentor_Subscriptions.Start.$HQ.isplayerowned">
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors" param="true"/>
                    </do_elseif>
                    <signal_cue cue="Set_Persistent_Characters"/>
                  </actions>
                </cue>
                <cue name="Set_Persistent_Characters">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <set_value name="$DalBusta"   exact="md.$PersistentCharacters.$DalBusta"/>
                    <assert value="$DalBusta != null" text="'Dal is null'"/>

                    <signal_cue_instantly cue="Setup_HQ"/>

                    <!-- Debug Dal Placement, he disappeared with recent commits TODO: @Owen -->
                    <!--<create_position name="$DalPos" x="-3.17" y="0.05m" z="-5.0"/>
                    <create_rotation name="$DalRot" yaw="90.0deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $DalBusta,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $BosoTa.room,
                                                                                                      $rotation = $DalRot,
                                                                                                      $position = $DalPos,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>-->
                    <signal_cue_instantly cue="md.Story_Diplomacy_Intro.Pt11_End" param="table[$forced = true]" check="false"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Debug_Setup_Dal_Only">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors" check="false"/>
              </actions>
              <delay exact="2s"/>
              <actions>
                <set_value name="$DalBusta"   exact="md.$PersistentCharacters.$DalBusta"/>
                <!-- Debug Dal Placement, he disappeared with recent commits TODO: @Owen -->
                <create_position name="$DalPos" x="-3.17" y="0.05m" z="-5.0"/>
                <create_rotation name="$DalRot" yaw="90.0deg"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $DalBusta,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $BosoTa.room,
                                                                                                      $rotation = $DalRot,
                                                                                                      $position = $DalPos,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                <signal_cue_instantly cue="md.Story_Diplomacy_Intro.Pt11_End" param="table[$forced = true]"/>
              </actions>
            </cue>

            <cue name="Debug_Arm_Spacesuit">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.engine_gen_spacesuit_01_mk2"     exact="2"/>
                <add_inventory ware="ware.weapon_gen_spacesuit_demolition_01_mk1"     exact="2"/>
                <add_inventory ware="ware.weapon_gen_spacesuit_laser_01_mk1"          exact="2"/>
                <add_inventory ware="ware.weapon_gen_spacesuit_laser_02_mk1"     exact="1"/>
                <add_inventory ware="ware.weapon_gen_spacesuit_repairlaser_01_mk1"    exact="2"/>
                <add_inventory ware="ware.bomb_player_limpet_mine_01_mk1"             exact="123"/>
                <add_inventory ware="ware.bomb_player_limpet_emp_01_mk1"              exact="123"/>
                <debug_text text="'Armed Spacesuit'"/>
              </actions>
            </cue>

            <cue name="Debug_Ch1_Add_DeliveryWares_Antimatter" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="player.entity.ship?">
                  <set_value name="$DeliveryWare" exact="ware.antimattercells"/>
                  <set_value name="$DeliveryAmount" exact="10"/>
                  <debug_text text="'Adding wares to player ship'"/>
                  <add_cargo object="player.entity.ship" ware="$DeliveryWare" exact="$DeliveryAmount"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Debug_Ch1_Add_DeliveryWares_AntimatterConv" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="player.entity.ship?">
                  <set_value name="$DeliveryWare" exact="ware.antimatterconverters"/>
                  <set_value name="$DeliveryAmount" exact="1"/>
                  <debug_text text="'Adding wares to player ship'"/>
                  <add_cargo object="player.entity.ship" ware="$DeliveryWare" exact="$DeliveryAmount"/>
                </do_if>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- *** STORY MANAGER INTERACTION *** -->

        <cue name="Story_Activation_Manager">
          <cues>

            <cue name="Activate_Immediately" onfail="cancel">
              <conditions>
                <check_value value="md.X4Ep1_Mentor_Subscriptions.UnlockResearch.state == cuestate.complete"/>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <cue name="Check_For_Scientific_Mentor_Ending">
              <conditions>
                <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.UnlockResearch"/>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <!-- Cue which activates the story (all preconditions met) -->

            <cue name="Activate_Story">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="not $ForceCompleted">
                  <signal_cue cue="Ch1_Intro"/>
                </do_if>
                <signal_cue cue="Setup_HQ" comment="$HQ and $BosoTa can now be set"/>
                <cancel_cue cue="Story_Activation_Manager"/>
              </actions>
            </cue>

            <cue name="Handle_Custom_Gamestart_Skip" onfail="cancel">
              <conditions>
                <check_value value="$ForceCompleted"/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_terraforming_oberth"/>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_terraforming_torus"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Cutscene Briefing Handling -->
        <!--These cues handle the briefing presentations e.g. Holomap or cutscene render targets (depending on the mission)
                note: play_cutscene action should not be in the actions of the cue with a event_briefing_submission_selected condition. It must be delayed-->
        <cue name="BriefingStarted">
          <conditions>
            <check_any>
              <event_briefing_started cue="$MissionCue"/>
              <event_briefing_submission_selected cue="$MissionCue"/>
            </check_any>
          </conditions>
          <actions>
            <set_value name="$RenderTarget" exact="event.param.{1}"/>
            <set_value name="$StartBriefingCutscene"/>
            <debug_text text="'Briefing started'" chance="$DebugChance"/>
          </actions>
          <cues>
            <cue name="DisplayCutscene" onfail="cancel">
              <conditions>
                <check_value value="$StartBriefingCutscene?"/>
              </conditions>
              <actions>
                <set_value name="$BriefingCutsceneStarted"/>
                <set_value name="$CutsceneKey" exact="'OrbitIndefinitelySlower'"/>
                <play_cutscene key="$CutsceneKey" rendertarget="$RenderTarget">
                  <param name="targetobject" object="$ResearchShip"/>
                </play_cutscene>
              </actions>
            </cue>

            <cue name="BriefingStopped">
              <conditions>
                <check_any>
                  <event_briefing_cancelled cue="$MissionCue"/>
                  <event_briefing_submission_unselected cue="$MissionCue"/>
                </check_any>
              </conditions>
              <actions>
                <do_if value="$BriefingCutsceneStarted?">
                  <!--Temp value. This is used to identify if a cutscene for this mission is still playing.-->
                  <remove_value name="$BriefingCutsceneStarted"/>
                  <stop_cutscene key="$CutsceneKey"/>
                </do_if>

                <do_if value="$HoloMap?">
                  <remove_holomap />
                  <remove_value name="$HoloMap"/>
                </do_if>

                <debug_text text="'Briefing canceled'" chance="$DebugChance"/>
                <reset_cue cue="BriefingStarted"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- *** STORY CHAPTERS *** -->

        <cue name="Ch0_Reporting_To_Superiors">
          <!-- Terran GS players which decide to go back and report to the Chief Scientist/Terran Secret Service-->
          <conditions>
            <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.Phase_Terranborn"/>
          </conditions>
          <actions>
            <do_if value="md.$PersistentCharacters.$PioneerHeadScientist?">
              <set_value name="$HeadScientistActor" exact="md.$PersistentCharacters.$PioneerHeadScientist"/>
            </do_if>
            <do_if value="md.Story_Yaki.Start.$SecretServiceActor?">
              <set_value name="$SecurityServiceContactActor" exact="md.Story_Yaki.Start.$SecretServiceActor"/>
            </do_if>
          </actions>
          <cues>
            <cue name="Ch0_Reporting_Init">
              <actions>
                <signal_cue cue="Ch0_Reporting_To_ChiefScientist" check="false"/>
                <signal_cue cue="Ch0_Reporting_To_SSC" check="false"/>
              </actions>
            </cue>
            <cue name="Ch0_Reporting_To_ChiefScientist">
              <conditions>
                <check_any>
                  <event_cue_completed cue="Setup_Character_HeadScientist"/>
                  <event_cue_completed cue="Setup_Values_GS_Information"/>
                  <event_cue_signalled/>
                </check_any>
                <check_value value="cuestate.complete == Setup_Character_HeadScientist.state"/>
                <check_value value="cuestate.complete == Setup_Values_GS_Information.state"/>
                <check_value value="$Terran_DLC_GS"/>
              </conditions>
              <cues>
                <cue name="Ch0_Conversation_ChiefScientist" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$HeadScientistActor"/>
                  </conditions>
                  <actions>
                    <do_if value="$PlayerReportedToHS?">
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224003" comment="What is it now?"/>
                      </add_npc_line>
                      <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel"/>
                    </do_if>
                    <do_else>
                      <allow_conversation_escape enabled="false"/>
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224001" comment="Greetings"/>
                      </add_npc_line>
                      <do_if value="$Terran_DLC_GS">
                        <set_value name="$PlayerReportedToHS" comment="Player reported to the Head Scientist, always also set CS_Recognised"/>
                        <append_to_list name="$HeadScientistSaid" exact="'CS_Recognised'" comment="Always set this when setting $PlayerReportedToHS"/>
                        <do_if value="$Segarian_GS">
                          <do_if value="player.name == readtext.{1021}.{1002}" comment="didn't rename from Najia Takio">
                            <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                              <text line="30224112" comment="Wait, Najia Takio? Is it really you?(Player name from Terran Game Start 2)"/>
                              <text line="30224113" comment="I am fairly glad that you made it."/>
                            </add_npc_line>
                          </do_if>
                          <do_else>
                            <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                              <text line="30224114" comment="Wait, I know you, don't I?"/>
                              <text line="30224113" comment="I am fairly glad that you made it."/>
                            </add_npc_line>
                          </do_else>
                        </do_if>
                        <do_elseif value="$Terran_Cadet_GS">
                          <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                            <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                              <text line="30224114" comment="Wait, I know you, don't I?"/>
                              <text line="30224115" comment="Mr. Hariken? Is it really you?(Player name from the Terran Game Start 1)"/>
                              <text line="30224116" comment="You worked for us at the station!"/>
                            </add_npc_line>
                          </do_if>
                          <do_else>
                            <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                              <text line="30224114" comment="Wait, I know you, don't I?"/>
                              <text line="30224116" comment="You worked for us at the station!"/>
                            </add_npc_line>
                          </do_else>
                        </do_elseif>
                        <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                          <text line="30224101" comment="Wha.. what happened?"/>
                          <text line="30224102" comment="Where did you go? What happened to the station?"/>
                        </add_npc_line>
                        <add_player_choice text="{30224,30224001}" comment="We ended up in another system."      section="cs_other_system"/>
                        <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel" selectable="false"/>
                      </do_if>
                    </do_else>

                  </actions>
                </cue>

                <cue name="Ch0_Conversation_Chief_Scientist_What_Happened">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="cs_other_system"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224103" comment="The whole station moved with you?"/>
                      <text line="30224104" comment="Was there any identifiable cause for this spontaneous transportation?"/>
                    </add_npc_line>
                    <add_player_choice text="{30224,30224002}" comment="A Boron was experimenting there."      section="cs_cause_boron"/>
                    <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel" selectable="false"/>
                  </actions>
                </cue>

                <cue name="Ch0_Conversation_Chief_Scientist_Identifiable_Cause">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="cs_cause_boron"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224105" comment="I see. Theft."/>
                      <text line="30224106" comment="We will prepare an expedition in order to reclaim our station from the Boron."/>
                      <text line="30224107" comment="If you can, keep an eye on that Boron until we arrive."/>
                      <text line="30224108" comment="If you excuse me, I need to get working on that."/>
                    </add_npc_line>
                    <add_faction_relation faction="faction.player" otherfaction="faction.pioneers" value="0.0016" reason="relationchangereason.smalltalkreward"/>
                  </actions>
                </cue>

                <cue name="Ch0_Conversation_Chief_Scientist_End">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="g_cancel" />
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224004" comment="Farewell."/>
                    </add_npc_line>
                  </actions>
                </cue>

              </cues>
            </cue>
            <cue name="Ch0_Reporting_To_SSC">
              <conditions>
                <!-- ToDo: Make sure it does not interfere with other plots / Only on Terran GS 1-->
                <check_any>
                  <event_cue_completed cue="Setup_Character_SecurityServiceContactActor"/>
                  <event_cue_completed cue="Setup_Values_GS_Information"/>
                  <event_cue_signalled/>
                </check_any>
                <check_value value="cuestate.complete == Setup_Character_SecurityServiceContactActor.state"/>
                <check_value value="cuestate.complete == Setup_Values_GS_Information.state"/>
                <check_value value="$Terran_Cadet_GS"/>
              </conditions>
              <cues>

                <cue name="Ch0_SSC_Mail_1">
                  <!-- Post Warp Situation, after event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.Phase_Terranborn"-->
                  <delay exact="20min"/>
                  <actions>

                    <set_value name="$EmailText" exact="readtext.{30224}.{12003}"/>
                    <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                      <set_value name="$EmailText" exact="readtext.{30224}.{12002}"/>
                    </do_if>

                    <write_incoming_message source="{30225,108}" highpriority="false"
                                            object="$SecurityServiceContactActor" interaction="guidance"
                                            title="{30224,12001}"
                                             text="$EmailText"
                                            comment="Order #494 - Requesting Immediate Report"/>
                    <signal_cue cue="Ch0_SSC_Mail_2"/>
                  </actions>
                </cue>

                <cue name="Ch0_SSC_Mail_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="40min"/>
                  <actions>

                    <set_value name="$EmailText" exact="readtext.{30224}.{12103}"/>
                    <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                      <set_value name="$EmailText" exact="readtext.{30224}.{12102}"/>
                    </do_if>

                    <write_incoming_message source="{30225,108}" highpriority="false"
                                            object="$SecurityServiceContactActor" interaction="guidance"
                                            title="{30224,12101}"
                                             text="$EmailText"
                                            comment="Order #510 - Summons for Immediate Report"/>
                  </actions>
                </cue>

                <cue name="Ch0_SSC_Mail_3_PlotDelay">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch0_HQ_Plot_Done" onfail="cancel">
                      <conditions>
                        <check_value value="Ch5_Evade_Patrols.state == cuestate.complete"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch0_SSC_Mail_3"/>
                      </actions>
                    </cue>
                    <cue name="Ch0_HQ_Plot_Done_Event">
                      <conditions>
                        <event_cue_completed cue="Ch5_Evade_Patrols"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch0_SSC_Mail_3"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch0_SSC_Mail_3">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="140min"/>
                  <actions>

                    <set_value name="$EmailText" exact="readtext.{30224}.{12203}"/>
                    <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                      <set_value name="$EmailText" exact="readtext.{30224}.{12202}"/>
                    </do_if>

                    <write_incoming_message source="{30225,108}" highpriority="false"
                                            title="{30224,12201}"
                                             text="$EmailText"
                                            comment="Order #533 - Investigations into Boso Ta"/>
                  </actions>
                </cue>

                <cue name="Ch0_SSC_Mail_4">
                  <conditions>
                    <event_cue_signalled/>
                    <!-- TODO: After all stories with this character are done -->
                  </conditions>
                  <actions>

                    <set_value name="$EmailText" exact="readtext.{30224}.{12303}"/>
                    <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                      <set_value name="$EmailText" exact="readtext.{30224}.{12302}"/>
                    </do_if>

                    <write_incoming_message source="{30225,108}" highpriority="false"
                                            title="{30224,12301}"
                                             text="$EmailText"
                                            comment="Order #722 - Termination"/>
                    <!-- Compensation has been promised -->
                  </actions>
                </cue>

                <cue name="Ch0_Conversation_SSC_Started" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$SecurityServiceContactActor"/>
                  </conditions>
                  <actions>
                    <do_if value="not $PlayerReportedToSSC?">
                      <add_player_choice text="{30224,1}" comment="Project Genesis"      section="ssc_reporting"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch0_Conversation_SSC">
                  <conditions>
                    <event_conversation_next_section actor="$SecurityServiceContactActor" section="ssc_reporting"/>
                  </conditions>
                  <actions>
                    <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                      <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                        <text line="30224001" comment="Agent Hariken!"/>
                      </add_npc_line>
                    </do_if>
                    <do_else>
                      <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                        <text line="30226601" comment="Operative."/>
                      </add_npc_line>
                    </do_else>

                    <do_if value="$PlayerReportedToSSC?">
                      <signal_cue cue="Ch0_Conv_SSC_Anything_To_Report"/>
                    </do_if>
                    <do_else>
                      <allow_conversation_escape enabled="false"/>
                      <cancel_cue cue="Ch0_SSC_Mail_1"/>
                      <cancel_cue cue="Ch0_SSC_Mail_2"/>
                      <set_value name="$PlayerReportedToSSC" comment="Player reported to the Secret Service Contact"/>
                      <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                        <!--<text line="30224002" comment="I am very glad to see you."/>-->
                        <text line="30224003" comment="We were under the impression that you went AWOL and issued an investigation into your disappearance."/>
                        <text line="30224004" comment="I will update your personal dossier before you run into trouble."/>
                        <text line="30224005" comment="Let's take your statement." delay="1s"/>
                        <text line="30224006" comment="I hereby am informing you that you are being recorded." delay="1s"/>
                      </add_npc_line>
                      <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                        <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                          <text line="30224007" comment="Reporting Cadet: Raibu Hariken, Dispatched to observe Project Genesis.(Project Genesis same as {30224,1})" delay="1s"/>
                        </add_npc_line>
                      </do_if>
                      <do_else>
                        <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                          <text line="30226601" comment="Operative."/>
                        </add_npc_line>
                      </do_else>
                      <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                        <text line="30224008" comment="You may begin."/>
                      </add_npc_line>
                      <add_player_choice text="{30224,30224010}" comment="The station moved to another system!"      section="ssc_station_moved"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch0_Conv_SSC_Anything_To_Report" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                      <text line="30224022" comment="Is there anything else to report? New intel on Project Genesis?(Project Genesis same as {30224,1})"/>
                    </add_npc_line>
                    <add_player_choice text="{30224,30224012}" comment="No, Ma'am."      section="ssc_no_report"/>
                  </actions>
                </cue>

                <cue name="Ch0_Conv_SSC_Nothing_To_Report" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SecurityServiceContactActor" section="ssc_no_report"/>
                  </conditions>
                  <actions>
                    <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                      <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                        <text line="30224030" comment="Thank you, Agent Hariken."/>
                      </add_npc_line>
                    </do_if>
                    <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                      <text line="30224031" comment="You stand relieved."/>
                    </add_npc_line>
                    <add_faction_relation faction="faction.player" otherfaction="faction.terran" value="0.0016" reason="relationchangereason.smalltalkreward"/>
                  </actions>
                </cue>

                <cue name="Ch0_Conv_SSC_Station_Moved">
                  <conditions>
                    <event_conversation_next_section actor="$SecurityServiceContactActor" section="ssc_station_moved"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                      <text line="30224010" comment="(In Disbelief)The Segaris Pioneers are capable of moving stations?(Faction name same as {20203,2901})"/>
                    </add_npc_line>
                    <add_player_choice text="{30224,30224011}" comment="No, a Boron was experimenting there."      section="ssc_boron_experimenting"/>
                  </actions>
                </cue>

                <cue name="Ch0_Conv_SSC_Boron_Experimenting">
                  <conditions>
                    <event_conversation_next_section actor="$SecurityServiceContactActor" section="ssc_boron_experimenting"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$SecurityServiceContactActor" hidechoices="true">
                      <text line="30224020" comment="Third party involvement?"/>
                      <text line="30224021" comment="I see. We will investigate this Boron."/>
                    </add_npc_line>
                    <signal_cue cue="Ch0_Conv_SSC_Anything_To_Report"/>
                    <signal_cue cue="Ch0_SSC_Mail_3_PlotDelay"/>
                  </actions>
                </cue>

              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Ch1_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch1_Terraforming_Intro">
            <!-- Special setup actions when you "fast-forward" into a chapter (skipping earlier ones) -->
          </force>
          <cues>
            <cue name="Ch1_Check_HQ">
              <actions>
                <do_if value="not $HQ?">
                  <signal_cue cue="Debug_Setup_HQ"/>
                </do_if>
                <signal_cue cue="Ch1_Force_Delay"/>
              </actions>
            </cue>
            <cue name="Ch1_Force_Delay">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="10s"/>
              <actions>
                <force_cue cue="Ch1_Intro"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="Ch1_Setup_ResearchShip"/>
                <cancel_cue cue="Ch0_Reporting_To_ChiefScientist"/>
                <cancel_cue cue="Ch1_Sector_Check"/>
                <signal_cue cue="Ch1_Mysterious_Ship_Mission"/>
              </actions>
            </cue>
          </cues>
        </cue>


        <!-- Chapter 1:
              - Player Delivers Antimatter to a Ship
              - Player Places Ships at specific position for a long range scan (Optional)
        -->

        <cue name="Ch1_Intro">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <set_value name="$EvasionWarpCounter" exact="0"/>
            <set_value name="$Current_Submission" exact="'Mission_Not_Offered'"/>

            <set_value name="$Ch1_Delay" exact="22min" comment="22min - Player out of Boso.sector before Boso calls and the mission is set up"/>
            <set_value name="$DeniedDelay" exact="2h" comment="15min before Boso tries to call again after the first call was ignored"/>
            <set_value name="$DeniedDelay_Add" exact="30min" comment="30min added to the call delay everytime the call is ignored"/>
            <set_value name="$DeniedDelay_Cap" exact="6h"  comment="6h maximum delay between boso calls"/>
            <!-- Boso calls stop once the player enters $Boso.sector and Ch1_Story_Hints_Done is played. -->
            <!-- After Ch1_Story_Hints_Done Reminders play until the player accepts the Antimatter mission and Boso comments on it. -->
            <set_value name="$StoryReminderDelay_1" exact="6h" comment="20min"/>
            <set_value name="$StoryReminderDelay_2" exact="6h" comment="25min"/>
            <!-- TODO: A Lib_Dialog Reminder can be cueued up right before Boso starts a Lib_Dialog talk which is a condition to stop reminders.
                       1 - Reminder: Checks for Talk to be complete, it is not. The Lib is called and waits to start.
                       2 - Talk: Starts after a Conversation with ChiefScientist is done, a Lib_Dialog completes.
                       3 - Reminder plays afterwards when ideally it should not, as the Talk is now complete. -->
          </actions>
          <cues>

            <cue name="Ch1_Setup_ResearchShip_Scan">
              <conditions>
                <event_cue_completed cue="Ch1_Setup_ResearchShip"/>
              </conditions>
              <!-- While the player is in sector, add scan effect to $ResearchShip
                   else wait for the player to enter the sector (again) -->
              <cues>
                <cue name="Ch1_Research_Ship_Sector_ReachedSector_Ref" ref="md.LIB_Generic.ReachedSector">
                  <param name="TargetSector" value="$ResearchShipGroup.{1}.sector"/>
                  <param name="SuccessSignalCue" value="Ch1_Scan_Player_In_Sector"/>
                </cue>
                <cue name="Ch1_Update_ResearchShipSector" instantiate="true">
                  <conditions>
                    <event_object_changed_sector group="$ResearchShipGroup"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Ch1_Research_Ship_Sector_ReachedSector_Ref"/>
                    <reset_cue cue="Ch1_Scan_Player_In_Sector"/>
                  </actions>
                </cue>

                <cue name="Ch1_Scan_Player_In_Sector">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch1_Scan_Player_Left_Sector">
                      <conditions>
                        <event_object_changed_sector object="player.entity"/>
                      </conditions>
                      <actions>
                        <reset_cue cue="Ch1_Research_Ship_Sector_ReachedSector_Ref"/>
                        <reset_cue cue="Ch1_Scan_Player_In_Sector"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Research_Ship_Scan_Effect_Periodically">
                      <delay min="2s" max="14s"/>
                      <actions>
                        <reset_cue cue="this"/>
                        <do_if value="(player.sector == $ResearchShip.sector)
                                  and (player.entity.distanceto.{$ResearchShip} lt 400km)
                                  and (player.entity.distanceto.{$ResearchShip} gt 5km)
                                  and ($ResearchShip.sector == $HQ.sector)" comment="flashes at ~480km so better not to create at such distances">
                          <add_effect object="player.zone" effect="'scfx_wave_02'" comment="long range scan effect">
                            <position object="$ResearchShip"/>
                            <rotation value="$ResearchShip.rotation"/>
                          </add_effect>
                        </do_if>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Sector_Check">
              <actions>
                <!-- 
                Once the Player left $HQ.sector,
                wait for $Ch1_Delay before trying to set up the mission.
                If the player re-enters $HQ.sector, reset the countdown and wait for the player to leave before starting it again. -->
              </actions>
              <cues>

                <cue name="Ch1_Player_Out_Of_Sector">
                  <cues>
                    <cue name="Ch1_Player_OOS_Check">
                      <actions>
                        <do_if value="player.entity.sector != $HQ.sector">
                          <signal_cue cue="Ch1_Player_Out_Of_Sector_Event"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch1_Player_Out_Of_Sector_Event">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_object_changed_sector object="player.entity" previous="$HQ.sector"/>
                          <event_object_changed_sector object="$HQ" previous="player.entity.sector"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch1_Countdown"/>
                        <debug_text text="'Starting Story Countdown'" chance="$DebugChance"/>
                      </actions>
                      <cues>
                        <cue name="Ch1_Reset_Countdown">
                          <conditions>
                            <check_any>
                              <event_object_changed_sector object="player.entity" sector="$HQ.sector"/>
                              <event_object_changed_sector object="$HQ" sector="player.entity.sector"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <debug_text text="'Resetting Story Countdown'" chance="$DebugChance"/>
                            <reset_cue cue="Ch1_Countdown"/>
                            <reset_cue cue="Ch1_Player_Out_Of_Sector_Event"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Countdown">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="$Ch1_Delay"/>
                  <actions>
                    <cancel_cue cue="Ch1_Sector_Check"/>
                    <cancel_cue cue="Ch0_Reporting_To_ChiefScientist"/>
                    <signal_cue cue="Ch1_Offer_Call"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Offer_Call">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch1_Hint_Denied_Retry">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="$DeniedDelay" comment="15min"/>
                  <actions>
                    <do_if value="Ch1_Story_Hints_Done.state != cuestate.complete">
                      <set_value name="$DeniedDelay" exact="$DeniedDelay_Add" comment="30min" operation="add"/>
                      <do_if value="$DeniedDelay gt $DeniedDelay_Cap">
                        <set_value name="$DeniedDelay" exact="$DeniedDelay_Cap"/>
                      </do_if>
                      <reset_cue cue="Ch1_Hint_Wait"/>
                      <reset_cue cue="this"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch1_Hint_Wait" checkinterval="10s">
                  <conditions>
                    <check_value value="not player.isinfullscreenmenu"/>
                    <check_value value="not player.isinconversation"/>
                    <check_value value="not player.isscreenshotmode"/>
                    <check_value value="not md.$MissionDND.count"/>
                    <check_value value="player.sector != $HQ.sector"/>
                    <check_value value="player.age ge (md.$LastMentorSpeak + 30min)"/>
                  </conditions>
                  <actions>
                    <set_value name="$CutsceneCaption" exact="{10002,22} + {1001,120} + ' ' + $BosoTa.knownname"/>
                    <!-- no active mission for mission cue attribute -->
                    <play_cutscene key="$BosoCutsceneKey.$key" result="parent.$CutsceneID" caption="$CutsceneCaption" targetmonitor="true" timeout="20s">
                      <interaction text="$CutsceneCaption" param="$BosoTa" param2="'accept_interaction_story_tf_ch1'"/>
                      <param name="npcref"  object="$BosoTa" />
                    </play_cutscene>
                    <run_actions ref="md.LIB_Generic.SuppressChatter_AddCue">
                      <param name="Cue" value="Ch1_Offer_Call"/>
                    </run_actions>
                  </actions>
                  <cues>

                    <cue name="Ch1_Call_Timeout" comment="mantis#1311 has Cutscene_Stopped on waiting">
                      <delay exact="21s" comment="timeout of cutscene"/>
                      <actions>
                        <signal_cue cue="Ch1_Call_Cutscene_Stopped" check="false"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Call_Greeting">
                      <conditions>
                        <event_cutscene_started cutscene="parent.parent.$CutsceneID"/>
                        <check_value value="event.param2" comment="So that we're not listening for null before the cutscene starts"/>
                      </conditions>
                      <actions>
                        <do_if value="not $BosoTaSaid.indexof.{30200002}">
                          <append_to_list name="$BosoTaSaid" exact="30200002"/>
                          <speak actor="$BosoTa" priority="90">
                            <text line="if player.entity.isfemale then 30200003 else 30200002" delay="0.6s" comment="I am terribly sorry to disrupt your magnificent focus."/>
                          </speak>
                        </do_if>
                        <do_else>
                          <do_any>
                            <speak actor="$BosoTa" priority="90">
                              <text line="if player.entity.isfemale then 30200011 else 30200010" delay="0.6s" comment="Assistant!"/>
                            </speak>
                            <speak actor="$BosoTa" priority="90">
                              <text line="if player.entity.isfemale then 30202101 else 30202100" delay="0.6s" comment="Captain, this is Boso Ta."/>
                            </speak>

                            <!-- Starting a Boso conversation already triggers a "Hello there." outside of this story, so after accepting Boso will say "Hello there" -->
                            <!--<speak actor="$BosoTa" priority="90">
                              <text line="2001" delay="0.6s" comment="Hello there."/>
                            </speak>
                            <speak actor="$BosoTa" priority="90">
                              <text line="2002" delay="0.6s" comment="Hello."/>
                            </speak>-->
                          </do_any>
                        </do_else>
                        <signal_cue cue="Ch1_Setup_ResearchShip" check="false"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <signal_cue cue="Ch1_Hint_Completed" check="false"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Call_Interact">
                      <conditions>
                        <event_player_interaction param="$BosoTa" param2="'accept_interaction_story_tf_ch1'"/>
                      </conditions>
                      <!-- TODO: Make Boso tell you what it's about and add a conversation option to set the objective or not -->
                      <actions>
                        <stop_cutscene cutscene="parent.parent.$CutsceneID"/>
                        <signal_cue cue="Ch1_Hint"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Call_Cutscene_Stopped">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_cutscene_stopped cutscene="parent.parent.$CutsceneID"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="Ch1_Call_Interact.state == cuestate.waiting">
                          <run_actions ref="md.LIB_Generic.SuppressChatter_RemoveCue">
                            <param name="Cue" value="Ch1_Offer_Call"/>
                          </run_actions>
                          <signal_cue cue="Ch1_Hint_Denied_Retry" check="false"/>
                        </do_if>
                        <!--<signal_cue cue="Ch1_Setup_ResearchShip"/>-->
                        <!-- 
                        The player could reach the sector during the call and witness an ugly ship spawn,
                        but it is highly unlikely and not trivial to solve. -->
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Hint" comment="Boso / Dal hint towards the ship">
              <conditions>
                <event_cue_signalled/>
                <!-- $MissionDND is still active at this point -->
              </conditions>
              <cues>
                <cue name="Ch1_1_BosoHint_Conv_Start">
                  <actions>
                    <do_if value="$MissionCue.hasmission">
                      <start_conversation actor="$BosoTa" conversation="ch1_bosohint" missioncue="$MissionCue_2"/>
                    </do_if>
                    <do_else>
                      <start_conversation actor="$BosoTa" conversation="ch1_bosohint"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_1_BosoHint_Conv">
                  <conditions>
                    <event_conversation_started actor="$BosoTa" conversation="ch1_bosohint"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$BosoTa" hidechoices="true">
                      <text line="30224102" delay="0.6s" comment="A pesky ship completed its travels right in this sector."/>
                      <text line="30224103" delay="0.6s" comment="Somehow it manages to distort the station's sensors, preventing me from witnessing a solar event in the Great Reef Nebula."/>
                      <text line="30224104"	comment="I suggest you take care of this annoyance before it manages to disrupt even more observations!"/>
                    </add_npc_line>
                    <do_if value="$DalBusta?">
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30224101" comment="Yeah, it looks like we got a visitor going about their business in our neighbourhood."/>
                        <text line="30224102"	comment="I'm not quite sure what this ship is trying to achieve here."/>
                        <text line="30224103"	comment="You might want to take a closer look at that one for a quick threat assessment."/>
                      </add_npc_line>
                    </do_if>

                    <add_player_choice text="{30224,30224003}" comment="I'm on my way!" section="peskyship_setactive"/>
                    <add_player_choice text="{30224,30224004}" comment="I don't have time for this." section="peskyship_setinactive"/>
                  </actions>
                  <cues>
                    <cue name="Patch_MANTIS_1311" onfail="cancel">
                      <!-- player save: Ch1_1_BosoHint_Conv_End waiting resulting in SuppressChatter still being occupied -->
                      <conditions>
                        <cue_is_waiting cue="Ch1_1_BosoHint_Conv_End"/>
                        <check_value value="not player.isinconversation"/>
                      </conditions>
                      <actions>
                        <set_value name="$Patch_MANTIS_1311"/>
                        <signal_cue cue="Ch1_1_BosoHint_Conv_End"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_1_BosoHint_Conv_End">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_conversation_finished actor="$BosoTa"/>
                      <event_conversation_next_section actor="$BosoTa" section="peskyship_setactive"/>
                      <event_conversation_next_section actor="$BosoTa" section="peskyship_setinactive"/>
                      <event_conversation_next_section actor="$BosoTa" section="g_cancel"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.param == 'peskyship_setactive'">

                      <!-- OLD: -->
                      <activate_mission cue="$MissionCue_2"/>

                      <!-- NEW: -->
                      <!--<create_mission cue="$MissionCue_2" offercue="$MissionCue_2" abortable="false" comment="Ch1_Mysterious_Ship_Mission"/>
                      <remove_offer cue="$MissionCue_2"/>-->
                    </do_if>
                    <!--<signal_cue cue="Ch1_Hint_Completed"/>-->
                    <run_actions ref="md.LIB_Generic.SuppressChatter_RemoveCue">
                      <param name="Cue" value="Ch1_Offer_Call"/>
                    </run_actions>
                  </actions>
                </cue>

              </cues>
            </cue>
            <cue name="Ch1_Hint_Completed">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$Current_Submission" exact="'Ch1_Mysterious_Ship_Mission'"/>
                <do_if value="$ResearchShip.sector == $HQ.sector" comment="Catch HQ warp during the Hint Speech">
                  <signal_cue cue="Ch1_Mysterious_Ship_Mission"/>
                </do_if>
                <do_else>
                  <signal_cue cue="Ch1_Mysterious_Ship_Mission_HQ_Warp_Reset"/>
                  <debug_text text="'HQ changed before Mission started.'" chance="$DebugChance"/>
                </do_else>
              </actions>
              <cues>

                <cue name="Ch1_Story_Hints_Done_Init" onfail="cancel">
                  <conditions>
                    <check_value value="$BosoTa.sector == player.entity.sector"/>
                    <check_value value="$BosoTa.sector == $ResearchShip.sector"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch1_Story_Hints_Done"/>
                  </actions>
                </cue>

                <cue name="Ch1_Story_Hints_Done">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_changed_sector object="player.entity" sector="$BosoTa.sector"/>
                      <event_object_changed_sector object="$BosoTa" sector="player.entity.sector"/>
                    </check_any>
                    <check_value value="$BosoTa.sector == $ResearchShip.sector"/>
                  </conditions>
                  <cues>
                    <cue name="Ch1_Story_Hints_Done_Timeout">
                      <delay exact="10s"/>
                      <actions>
                        <do_if value="cuestate.complete == Ch1_1_BosoHint_Conv.state">
                          <signal_cue cue="Ch1_Story_Hint_Done_Boso"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch1_Story_Hint_Explain"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch1_Story_Hint_Explain">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_1_BosoHint_v2" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30224101], [30224102, 1.2s], [30224103, 1.2s], [30224104, 1.2s]]" comment="x"/>
                          <param name="MissionCue"        value="if $MissionCue_2.hasmission then $MissionCue_2 else null"/>
                          <param name="IsInMission"       value="$MissionCue_2.hasmission"/>
                          <param name="EndSignalCue"      value="Ch1_1_DalHint_Check_v2"/>
                          <!--
                  <t id="	30224	101	">	Assistant!(Addressing player, player gender)	</t>
                  <t id="	30224	102	">	A pesky ship completed its travels right in this sector.	</t>
                  <t id="	30224	103	">	Somehow it manages to distort the station's sensors, preventing me from witnessing a solar event in the Great Reef Nebula.	</t>
                  <t id="	30224	104	">	I suggest you take care of this annoyance before it manages to disrupt even more observations!	</t>
                  -->
                        </cue>

                        <cue name="Ch1_1_DalHint_Check_v2">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="$DalBusta?">
                              <signal_cue cue="Ch1_1_DalHint_v2"/>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Ch1_1_DalHint_v2">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch1_1_DalHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30224101], [30224102], [30224103]]" comment="x"/>
                              <param name="MissionCue"        value="if $MissionCue_2.hasmission then $MissionCue_2 else null"/>
                              <param name="IsInMission"       value="$MissionCue_2.hasmission"/>
                              <!--
                      <t id="	30224	101	">	Yeah, it looks like we got a visitor going about their business in our neighbourhood.	</t>
                      <t id="	30224	102	">	I'm not quite sure what this ship is trying to achieve here.	</t>
                      <t id="	30224	103	">	You might want to take a closer look at that one for a quick threat assessment.	</t>
                      -->
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch1_Story_Hint_Done_Boso">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_Story_Hint_Done_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"         value="$BosoTa"/>
                          <param name="CutsceneKey"   value="$BosoCutsceneKey"/>
                          <param name="Lines"         value="[[30224110],[30224111, 1s]]"/>
                          <param name="MissionCue"        value="if $MissionCue_2.hasmission then $MissionCue_2 else null"/>
                          <param name="IsInMission"       value="$MissionCue_2.hasmission"/>
                          <!--  <t id="	30224	110	">	How wonderful, you are here to deal with the sensor distorting ship!	</t>
                            <t id="	30224	111	">	Your much-anticipated arrival fills me with quite some relief and delight!	</t>
                            -->
                        </cue>
                      </cues>
                    </cue>


                    <cue name="Ch1_Conversation_Pesky_Ship">
                      <!-- In case the player did not notice the mission nor tried to go to the ship,
                           a Boso conversation allows to activate the mission -->
                      <cues>
                        <cue name="Ch1_Conversation_Deactivate">
                          <conditions>
                            <event_cue_completed cue="Ch1_3_Delivery_Lines_Antimatter"/>
                          </conditions>
                          <actions>
                            <cancel_cue cue="parent"/>
                          </actions>
                        </cue>

                        <cue name="Ch1_BosoHint_2_Conv_Start" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$BosoTa"/>
                            <check_value value="Ch1_3_Delivery_Lines_Antimatter.state != cuestate.complete"/>
                          </conditions>
                          <actions>
                            <add_player_choice text="{30224,30224005}" comment="You mentioned an irksome ship?" section="peskyship_setactive_2"/>
                          </actions>
                        </cue>

                        <cue name="Ch1_BosoHint_2_Conv_End" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_conversation_next_section actor="$BosoTa" section="peskyship_setactive_2"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$BosoTa" hidechoices="true">
                              <text line="30221261" delay="0.6s" comment="Yes, yes. Exactly!"/>
                              <text line="30224103" delay="0.6s" comment="Somehow it manages to distort the station's sensors, preventing me from witnessing a solar event in the Great Reef Nebula."/>
                              <text line="30224104"	comment="I suggest you take care of this annoyance before it manages to disrupt even more observations!"/>
                            </add_npc_line>
                          </actions>
                          <cues>
                            <cue name="Ch1_BosoHint_2_Conv_End_Completed">
                              <conditions>
                                <event_conversation_finished actor="$BosoTa"/>
                              </conditions>
                              <actions>
                                <activate_mission cue="$MissionCue_2"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_Story_Reminders">
              <conditions>
                <check_any>
                  <event_cue_completed cue="Ch1_Story_Hint_Done_Boso"/>
                  <event_cue_completed cue="Ch1_1_DalHint_Check_v2"/>
                </check_any>
              </conditions>
              <cues>
                <cue name="Ch1_Story_Reminders_1">
                  <delay exact="$StoryReminderDelay_1"/>
                  <actions>
                    <signal_cue cue="Ch1_Story_Reminder1_Boso_LastSpeak"/>
                  </actions>
                  <cues>

                    <cue name="Ch1_Story_Reminder1_Boso_LastSpeak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_Story_Reminder1_Boso_LastSpeakCheck">
                          <delay exact="5min"/>
                          <actions>
                            <do_if value="(player.age ge (md.$LastMentorSpeak + 30min)) and (not player.isinconversation) and (not md.$MissionDND.count) and (not player.isinfullscreenmenu) and (not player.isscreenshotmode)">
                              <signal_cue cue="Ch1_Story_Reminder_Boso_1"/>
                            </do_if>
                            <do_else>
                              <reset_cue cue="this"/>
                            </do_else>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_Story_Reminder_Boso_1">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="Ch1_3_Delivery_Lines_Antimatter.state != cuestate.complete"/>
                        <check_value value="$EvasionWarpCounter le 0"/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_Story_Reminder_Boso_1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"         value="$BosoTa"/>
                          <param name="CutsceneKey"   value="$BosoCutsceneKey"/>
                          <param name="Lines"         value="[[30224105],[30224106]]"/>
                          <param name="MissionCue"        value="if $MissionCue_2.hasmission then $MissionCue_2 else null"/>
                          <param name="IsInMission"       value="$MissionCue_2.hasmission"/>
                          <param name="EndSignalCue"  value="Ch1_Story_Reminders_2"/>
                          <!--  <t id="	30224105	">	Assistant! The Great Reef Nebula is still evading my sensors.	</t>
                            <t id="	30224106	">	Do I need to explain to you the grand importance and far-reaching consequences reliant on the success of such galactic observations?	</t>-->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Story_Reminders_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="$StoryReminderDelay_2"/>
                  <actions>
                    <signal_cue cue="Ch1_Story_Reminder2_Boso_LastSpeak"/>
                  </actions>
                  <cues>

                    <cue name="Ch1_Story_Reminder2_Boso_LastSpeak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_Story_Reminder2_Boso_LastSpeakCheck">
                          <delay exact="5min"/>
                          <actions>
                            <do_if value="(player.age ge (md.$LastMentorSpeak + 30min)) and (not player.isinconversation) and (not md.$MissionDND.count) and (not player.isinfullscreenmenu) and (not player.isscreenshotmode)">
                              <signal_cue cue="Ch1_Story_Reminder_Boso_2"/>
                            </do_if>
                            <do_else>
                              <reset_cue cue="this"/>
                            </do_else>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_Story_Reminder_Boso_2">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="Ch1_3_Delivery_Lines_Antimatter.state != cuestate.complete"/>
                        <check_value value="$EvasionWarpCounter le 0"/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_Story_Reminder_Boso_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"         value="$BosoTa"/>
                          <param name="CutsceneKey"   value="$BosoCutsceneKey"/>
                          <param name="Lines"         value="[[30224107],[30224108],[30224109]]"/>
                          <param name="MissionCue"        value="if $MissionCue_2.hasmission then $MissionCue_2 else null"/>
                          <param name="IsInMission"       value="$MissionCue_2.hasmission"/>
                          <param name="EndSignalCue"  value="Ch1_Story_Reminder_Dal_2"/>
                          <!--  
                          Boso	<t id="	30224	107	">	Assistant, hurry up!	</t>
                          Boso	<t id="	30224	108	">	I already quadrouple-checked the configuraitons of the station sensors, confirmed the location of the Great Reef Nebula, and payed a lawyer to look into this observatorial disturbance! 	</t>
                          Boso	<t id="	30224	109	">	There is not much more I can do to get this observation started.	</t>-->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch1_Story_Reminder_Dal_2">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$DalBusta?"/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_Story_Reminder_Dal_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"         value="$DalBusta"/>
                          <param name="CutsceneKey"   value="$DalCutsceneKey"/>
                          <param name="Lines"         value="[[30224104],[30224105]]"/>
                          <param name="MissionCue"        value="if $MissionCue_2.hasmission then $MissionCue_2 else null"/>
                          <param name="IsInMission"       value="$MissionCue_2.hasmission"/>
                          <!-- 
                          Dal	<t id="	30224	104	">	I hate to bug you on that, but his excitement about looking at some fog aside, Boso seems to be unreasonably nervous about this visitor.	</t>
                          Dal	<t id="	30224	105	">	You might want to prioritise looking into this ship.	</t>-->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>
            <cue name="Ch1_HQ_Evasion_Warp_Lines">
              <cues>
                <cue name="Ch1_Hint_Boso_HQ_Evasion" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch1_Hint_Boso_HQ_Evasion_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"         value="$BosoTa"/>
                      <param name="CutsceneKey"   value="$BosoCutsceneKey"/>
                      <param name="Cutscene"      value="$BosoTa.room != player.entity.room"/>
                      <param name="Lines"         value="[[if ($EvasionWarpCounter le 1) then 30224112 else 30224113],[30224114],[30224115]]"/>
                      <param name="MissionCue"        value="if $MissionCue_2.hasmission then $MissionCue_2 else null"/>
                      <param name="IsInMission"       value="$MissionCue_2.hasmission"/>
                      <!--  
                          <t id="	30224112	">	This is not the solution I had it mind, but it is a problem solved.	</t>
                          <t id="	30224113	">	Once again not the solution I had it mind, but it is a problem solved. For now.	</t>
                          <t id="	30224114	">	After some adjustments to the sensor orientation I will be able to observe the Great Reef Nebula after all.	</t>
                          <t id="	30224115	">	Well done, Assistant!	</t>
                            -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Hint_Boso_ResearchShip_Returned" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch1_Hint_Boso_ResearchShip_Returned_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"         value="$BosoTa"/>
                      <param name="CutsceneKey"   value="$BosoCutsceneKey"/>
                      <param name="Cutscene"      value="$BosoTa.room != player.entity.room"/>
                      <param name="Lines"         value="[[30224116],[30224117],[30224118]]"/>
                      <param name="MissionCue"        value="if $MissionCue_2.hasmission then $MissionCue_2 else null"/>
                      <param name="IsInMission"       value="$MissionCue_2.hasmission"/>
                      <param name="EndSignalCue"  value="Ch1_Hint_Boso_ResearchShip_Returned_Confession_Ref"/>
                      <!--  
                          Boso	<t id="	30224	116	">	Assistant! The pesky ship returned to the station!	</t>
                          Boso	<t id="	30224	117	">	It is again blocking the sensors!	</t>
                          Boso	<t id="	30224	118	">	I urge you to deal with it!	</t>
                            -->
                    </cue>
                    <cue name="Ch1_Hint_Boso_ResearchShip_Returned_Confession_Ref">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$DalBusta?"/>
                        <check_value value="not $BosoConfession?"/>
                      </conditions>
                      <actions>
                        <set_value name="$BosoConfession"/>
                      </actions>
                      <cues>
                        <cue name="Ch1_ResearchShip_Returned_Boso_Confession_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"         value="[$DalBusta, $BosoTa, $DalBusta]"/>
                          <param name="CutsceneKey"   value="[$DalCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey]"/>
                          <param name="Cutscene"      value="[$DalBusta.room != player.entity.room,
                                                              $BosoTa.room != player.entity.room,
                                                              $DalBusta.room != player.entity.room]"/>
                          <param name="Lines"         value="[
                                                                   [[30224106],[30224107],[30224108]],
                                                                   [[30224119]],
                                                                   [[30224109],[30224110],[30224111]]
                                                                 ]"/>
                          <param name="MissionCue"        value="if $MissionCue_2.hasmission then $MissionCue_2 else null"/>
                          <param name="IsInMission"       value="$MissionCue_2.hasmission"/>
                          <!--                          
                              Dal	<t id="	30224106	">	That is barely a coincidence.	</t>
                              Dal	<t id="	30224107	">	It's rather unlikely that they followed us here for the view.	</t>
                              Dal	<t id="	30224108	">	Boso, would you happen to know why they would be following the station?	</t>
                              Boso	<t id="	30224119	">	(Speaking meek, quickly and silently)They might be the original owners of the station we are in and looking for a way to get it back.	</t>
                              Dal	<t id="	30224109	">	Okay, well, that is very bad.	</t>
                              Dal	<t id="	30224110	">	Let's try and resolve this in a way which doesn't lead to us being evicted.	</t>
                              Dal	<t id="	30224111	">	You better deal with this rather earlier than later before they get some ideas about taking the station back.	</t>
                              -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Mysterious_Ship_Mission_HQ_Warp_Reset">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Ch1_Hint_Boso_HQ_Evasion" comment="TODO: Check so that it doesn't conflict with warp voices"/>
                <set_value name="$EvasionWarpCounter" exact="1" operation="add"/>
                <debug_text text="'HQ Evasion Detected'" chance="$DebugChance"/>
              </actions>
              <cues>
                <cue name="Ch1_Ship_Returned_To_HQ">
                  <conditions>
                    <event_object_changed_sector group="$ResearchShipGroup" sector="$HQ.sector"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="parent"/>
                    <signal_cue cue="Ch1_Hint_Boso_ResearchShip_Returned"/>

                    <do_if value="$Current_Submission == 'Ch1_Mysterious_Ship_Mission'">
                      <signal_cue cue="Ch1_Mysterious_Ship_Mission"/>
                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Mysterious_Ship_Mission">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="''" chance="$DebugChance"/>
                <set_value name="$radius" exact="25km"/>
                <create_position name="$Offset" object="$ResearchShip" max="$radius" space="$ResearchShip.sector"/>

                <!-- OLD -->
                <create_mission comment="Mission: Seize and Desist" group="missiongroup.story_terraforming"
                                name="{30224,1001}" description="{30224,1002}" rewardtext="{30224,1020}"
                                icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name"
                                faction="faction.player" difficulty="level.trivial" activate="false"
                                cue="$MissionCue_2" abortable="false" type="missiontype.plot">
                  <briefing>
                    <objective step="$ObjectiveStep" action="objective.find" text="{30224,1051}" object="$ResearchShip.sector" offset="$Offset" radius="$radius"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing cue="$MissionCue_2" step="$ObjectiveStep"/>

                <!-- NEW: -->
                <!--<create_offer comment="Mission: Seize and Desist"
                                name="{30224,1001}" description="{30224,1002}" rewardtext="{30224,1020}"
                                icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name"
                                faction="faction.player" difficulty="level.trivial"
                                cue="$MissionCue_2" abortable="false" type="missiontype.plot">
                  <briefing>
                    <objective step="$ObjectiveStep" action="objective.find" text="{30224,1051}" object="$ResearchShip.sector" offset="$Offset" radius="$radius"/>
                  </briefing>
                </create_offer>-->
              </actions>
              <cues>
                <cue name="Ch1_Mysterious_Ship_HQ_Left_Sector">
                  <conditions>
                    <event_object_changed_sector object="$HQ" previous="$ResearchShipGroup.{1}.sector"/>
                  </conditions>
                  <actions>
                    <remove_mission cue="$MissionCue_2" type="completed"/>
                    <reset_cue cue="Ch1_Mysterious_Ship_Mission"/>
                    <signal_cue cue="Ch1_Mysterious_Ship_Mission_HQ_Warp_Reset"/>
                  </actions>
                </cue>

                <cue name="Ch1_Mysterious_Ship_Update_Objective" checkinterval="5s" instantiate="true">
                  <conditions>
                    <check_value value="Ch1_Mysterious_Ship_Found.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <create_position name="$Position" object="$ResearchShip" space="$ResearchShip.sector"/>
                    <do_if value="$Position.distanceto.{$Offset} gt $radius">
                      <create_position name="$Offset" object="$ResearchShip" max="$radius" space="$ResearchShip.sector"/>
                      <set_objective cue="$MissionCue_2" step="$ObjectiveStep" action="objective.find" text="{30224,1051}" object="$ResearchShip.sector" offset="$Offset" radius="$radius"
                                     silent="true"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch1_Mysterious_Ship_Search" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="player.entity"/>
                  <param name="ApproachTarget"    value="$ResearchShip"/>
                  <param name="ApproachDistance"  value="10km"/>
                  <param name="SuccessSignalCue"  value="Ch1_Mysterious_Ship_Found"/>
                </cue>

                <cue name="Ch1_Mysterious_Ship_Found">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch1_Mysterious_Ship_HQ_Left_Sector"/>
                    <set_object_radar_visible object="$ResearchShip" visible="true"/>
                    <set_objective cue="$MissionCue_2" step="$ObjectiveStep" group="$ResearchShipGroup" action="objective.find" text="{30224,1056}" updatebriefing="true"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Setup_ResearchShip_MissionOffer">
              <conditions>
                <event_cue_completed cue="Ch1_Mysterious_Ship_Found" comment="Mysterious_Ship_Mission creates a mission which will be cleaned up in this cue"/>
              </conditions>
              <cues>

                <cue name="Ch1_Mission_Offer_Sector_Init" onfail="cancel">
                  <conditions>
                    <check_value value="player.sector == $ResearchShip.sector"/>
                    <check_value value="player.sector == $HQ.sector"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch1_Mission_Offer_Sector_Changed"/>
                  </actions>
                </cue>

                <!-- Same Sector -->
                <cue name="Ch1_Mission_Offer_Sector_Changed" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_changed_sector object="$ResearchShip"/>
                      <event_object_changed_sector object="$HQ"/>
                      <event_object_changed_sector object="player.entity"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="($ResearchShip.sector == $HQ.sector)
                           and ($ResearchShip.sector == player.entity.sector)">
                      <debug_text text="'Attempting to Create Mission Offer (Sector Condition Fulfilled)'" chance="$DebugChance"/>
                      <signal_cue cue="Ch1_Mission_Offer_Create" check="false"/>
                    </do_if>
                    <do_else>
                      <debug_text text="'Removing Mission Offer if existent'" chance="$DebugChance"/>
                      <signal_cue cue="Ch1_Mission_Offer_Remove" check="false"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_Mission_Offer_Create">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>

                    <set_value name="$DeliveryAmount" exact="10"/>
                    <set_value name="$DeliveryWare" exact="ware.antimattercells"/>
                    <substitute_text text="$ObjectiveText" source="readtext.{1004}.{1007}">
                      <replace string="'$AMOUNT$'" with="$DeliveryAmount" />
                      <replace string="'$WARE$'"  with="$DeliveryWare" />
                    </substitute_text>

                    <create_offer comment="Mission: Gravimetric Studies" location="$ResearchShip" actor="$HeadScientistActor" space="$ResearchShip.sector"
                                  group="missiongroup.story_terraforming"
                                    name="{30224,1101}" description="{30224,1102}" rewardtext="{30224,1120}"
                                    icon="'briefing_dr_rick_feynman_01'" iconcaption="$HeadScientistActor.name"
                                    faction="faction.pioneers" difficulty="level.easy"
                                    cue="$MissionCue" abortable="false" type="missiontype.plot">
                      <briefing>
                        <objective step="1" action="objective.deliver" object="$ResearchShip" text="$ObjectiveText"/>
                      </briefing>
                    </create_offer>

                  </actions>
                  <cues>

                    <cue name="Ch1_Mission_Offer_Accepted">
                      <conditions>
                        <event_object_signalled object="$HeadScientistActor" param="'accept'" comment="Accepting on BB"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Accepted mission'" chance="$DebugChance"/>

                        <!-- Remove Boso's Mission to investigate the ship -->
                        <remove_mission cue="$MissionCue_2" type="completed"/>
                        <write_to_logbook category="missions" faction="faction.player" title="{30224,1021}" text="{30224,1022}"/>


                        <create_mission cue="$MissionCue" offercue="$MissionCue" abortable="false"/>
                        <remove_offer cue="$MissionCue"/>

                        <cancel_cue cue="Ch1_Setup_ResearchShip_MissionOffer"/>

                        <signal_cue cue="Ch1_3_Delivery"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Mission_Offer_Remove">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_offer cue="$MissionCue"/>
                        <reset_cue cue="Ch1_Mission_Offer_Create"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Conversation_HeadScientist">
              <cues>
                <cue name="Ch1_Conv_HS_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started               actor="$HeadScientistActor"/>
                      <event_conversation_started               actor="$HeadScientistActor" conversation="HS_Conv"/>
                      <event_conversation_next_section          actor="$HeadScientistActor" section="hs_main"/>
                      <event_conversation_returned_to_section   actor="$HeadScientistActor" section="hs_main"/>
                      <event_cue_signalled                      comment="returning from sections with no player choices"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.name == 'event_conversation_started'">
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224001" comment="\033MGreetings."/>
                      </add_npc_line>
                      <do_if value="Ch1_Hint_Set_Objective.state == cuestate.complete" comment="LRS Task Briefing Done">
                        <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                          <text line="30224144" comment="\We still are waiting for ships to join us in a synchronised long range scan.."/>
                          <text line="30224251" comment="\Please do not slack on this task.."/>
                        </add_npc_line>
                      </do_if>
                      <do_elseif value="Ch1_3_Delivery.state == cuestate.complete" comment="AM Delivery Task Briefing Done">
                        <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                          <text line="30224140" comment="\We are still waiting for Antimatter Cells(translate same as 20201,201) to complete our observations.."/>
                          <text line="30224141" comment="\It seems the Terrans or maybe even the station's occupant are obstructing any deliveries to halt our progress.."/>
                          <text line="30224142" comment="\If you can organise a delivery, please do so.."/>
                          <text line="30224143" comment="\It will greatly advance our timetable.."/>
                        </add_npc_line>
                      </do_elseif>
                    </do_if>
                    <do_else>
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224002" comment="\033MAnything else?"/>
                      </add_npc_line>
                    </do_else>

                    <do_if  value="(not $HeadScientistSaid.indexof.{30224111})">
                      <signal_cue cue="Ch1_Conv_HS_Introduction"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch1_Conv_HS_Choices"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_Conv_HS_Introduction" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <append_to_list name="$HeadScientistSaid" exact="30224111"/>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224111" comment="\033MI am Dr. Rick Feynman, Chief Scientist of the Oberth(Oberth is the ship's name) and in charge of the Genesis Project."/>
                    </add_npc_line>

                    <do_if value="$Terran_DLC_GS">
                      <signal_cue cue="Ch1_Conv_HS_Recognise_Terran_DLC"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch1_Conv_HS_Current_Research_Task"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_Conv_HS_Recognise_Terran_DLC" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="not $HeadScientistSaid.indexof.{'CS_Recognised'}">
                      <append_to_list name="$HeadScientistSaid" exact="'CS_Recognised'"/>
                      <do_if value="$Segarian_GS">
                        <!-- CS recognises Segarian Player -->
                        <do_if value="player.name == readtext.{1021}.{1002}" comment="didn't rename from Najia Takio">
                          <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                            <text line="30224112" comment="Wait, Najia Takio? Is it really you?(Player name from Terran Game Start 2)"/>
                            <text line="30224113" comment="I am fairly glad that you made it."/>
                          </add_npc_line>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                            <text line="30224114" comment="Wait, I know you, don't I?"/>
                            <text line="30224113" comment="I am fairly glad that you made it."/>
                          </add_npc_line>
                        </do_else>
                      </do_if>
                      <do_else comment="$Terran_Cadet_GS">
                        <!-- CS recognises Terran Player -->
                        <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                          <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                            <text line="30224114" comment="Wait, I know you, don't I?"/>
                            <text line="30224115" comment="Mr. Hariken? Is it really you?(Player name from the Terran Game Start 1)"/>
                            <text line="30224116" comment="You worked for us at the station!"/>
                          </add_npc_line>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                            <text line="30224114" comment="Wait, I know you, don't I?"/>
                            <text line="30224116" comment="You worked for us at the station!"/>
                          </add_npc_line>
                        </do_else>
                      </do_else>
                      <!-- Shared Lines -->
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224117" comment="We did not expect biological matter to have survived this transition."/>
                      </add_npc_line>
                      <signal_cue cue="Ch1_Conv_HS_Current_Research_Task"/>
                    </do_if>
                    <do_elseif value="$PlayerReportedToHS? and (not $HeadScientistSaid.indexof.{'Nemesis_Report'})">
                      <!-- Player previously seeked out CS and told them about Boso-->
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224005" comment="Oh, it is you."/>
                        <text line="30224124" comment="I am glad to see you being fit and well."/>
                        <text line="30224125" comment="How is our Boron nemesis doing?"/>
                      </add_npc_line>
                      <add_player_choice text="{30224,30224103}" comment="He is mostly researching."   section="hs_nemesis_report"/>
                    </do_elseif>
                    <do_else>
                      <debug_text text="'[Heinrich] Unintended Conversation Case'" chance="$DebugChance"/>
                      <signal_cue cue="Ch1_Conv_HS_Current_Research_Task"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_Conv_HS_Update_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <update_mission cue="$MissionCue" description="{30224,1103}"/>
                  </actions>
                </cue>

                <cue name="Ch1_Conv_HS_Current_Research_Task" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$Terran_DLC_GS">
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224118" comment="As I was saying, we are looking into how this station got here."/>
                      </add_npc_line>
                      <signal_cue cue="Ch1_Conv_HS_Update_Mission" check="false"/>
                    </do_if>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224127" comment="\033MOur research vessel is currently observing anomalies and gravimetric shears in this region."/>
                    </add_npc_line>
                    <signal_cue cue="Ch1_Conv_HS_Choices"/>
                  </actions>
                </cue>

                <cue name="Ch1_Conv_HS_Choices" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="Ch1_Hint_Set_Objective.state == cuestate.complete" comment="LRS Task Briefing Done">

                    </do_if>
                    <do_elseif value="Ch1_3_Delivery.state == cuestate.complete" comment="AM Delivery Task Briefing Done">
                      <add_player_choice text="{30224,30224110}" comment="The Genesis Project?"       section="hs_project"/>
                      <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel"/>
                    </do_elseif>
                    <do_else comment="not tasked to AM Deliver or LRS scan yet">
                      <add_player_choice text="{30224,30224110}" comment="The Genesis Project?"       section="hs_project"/>
                      <do_if value="$Terran_DLC_GS">
                        <add_player_choice text="{30224,30224112}" comment="What do you need?"   section="hs_need"/>
                      </do_if>
                      <do_else>
                        <add_player_choice text="{30224,30224111}" comment="How long will that take?"   section="hs_need"/>
                      </do_else>
                      <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_Conv_HS_Nemesis" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="hs_nemesis_report"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224126" comment="Very well."/>
                    </add_npc_line>
                    <append_to_list name="$HeadScientistSaid" exact="'Nemesis_Report'"/>
                    <signal_cue cue="Ch1_Conv_HS_Current_Research_Task"/>
                  </actions>
                </cue>

                <cue name="Ch1_Conv_HS_Project" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="hs_project"/>
                  </conditions>
                  <actions>
                    <do_if value="$Terran_DLC_GS">
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224119" comment="I am sorry to inform you that you currently lack the required clearance to access this information."/>
                      </add_npc_line>
                    </do_if>
                    <do_else>
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224120" comment="\033MOh, it's just part of our gravimetric studies."/>
                        <text line="30224121" comment="\033MFor now it is just a bulk of data from our sensors, but we will publish our research once it is concluded."/>
                      </add_npc_line>
                    </do_else>

                    <signal_cue_instantly cue="Ch1_Conv_HS_Main" comment="back to main without forcing the player to click 'back'"/>
                    <!--<add_player_choice_return text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>-->
                  </actions>
                </cue>

                <cue name="Ch1_Conv_HS_Need" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="hs_need"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224122" comment="\033MWe are currently lacking Antimatter Cells(translate same as 20201,201) to complete our observations."/>
                      <text line="30224123" comment="\033MIf you can organise a delivery to this vessel, we will be able to greatly advance our timetable."/>
                    </add_npc_line>
                    <!--<add_player_choice_return text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>-->
                  </actions>
                  <cues>
                    <cue name="Ch1_Conv_HS_Plan_Objective">
                      <conditions>
                        <event_conversation_finished actor="$HeadScientistActor"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch1_Conversation_HS_Completed"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Conversation_HS_Completed" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="cuestate.complete != Ch1_Mission_Offer_Accepted.state"/>
                  </conditions>
                  <actions>
                    <!-- TODO: Only show the conversation option for the mission if the conditions are fulfilled so we do not create the offer at this point -->
                    <signal_cue_instantly cue="Ch1_Mission_Offer_Create" check="false"/>
                    <signal_objects object="$HeadScientistActor" param="'accept'"/>
                    <!--<signal_cue_instantly cue="Ch1_Conv_HS_Main" comment="back to main without forcing the player to click 'back'"/>-->
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch1_3_Delivery">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_trade_offer buyer="$ResearchShip" object="$ResearchShip" ware="$DeliveryWare" amount="$DeliveryAmount" missioncue="namespace" name="$TradeOffer" playeronly="true" price="$DeliveryWare.minprice / 2"/>
                <debug_text text="'Attempting to create trade offer on ship ' + $ResearchShip.knownname" chance="$DebugChance"/>
              </actions>
              <cues>
                <cue name="Ch1_3_Delivery_Reminder">
                  <cues>
                    <cue name="Ch1_3_Delivery_Reminder_Timer">
                      <delay exact="30min"/>
                      <actions>
                        <signal_cue cue="Ch1_3_Delivery_Reminder_Event"/>
                      </actions>
                    </cue>
                    <cue name="Ch1_3_Delivery_Reminder_Event">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="Ch1_3_TradeOffer_Complete.state != cuestate.complete"/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_3_Delivery_Reminder_Event_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$HeadScientistActor"/>
                          <param name="CutsceneKey"       value="$HeadScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224140],[30224141],[30224142],[30224143]]" comment="x"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                          <text line="30224140" comment="\We are still waiting for Antimatter Cells(translate same as 20201,201) to complete our observations.."/>
                          <text line="30224141" comment="\It seems the Terrans or maybe even the station's occupant are obstructing any deliveries to halt our progress.."/>
                          <text line="30224142" comment="\If you can organise a delivery, please do so.."/>
                          <text line="30224143" comment="\It will greatly advance our timetable.."/>
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_3_Trade_Wares_Ref" ref="md.RML_Trade_Wares.TradeWares">
                  <param name="EndSignalCue"    value="Ch1_3_TradeOffer_Complete" />
                  <param name="MissionCue"      value="$MissionCue"/>
                  <param name="StartStep"       value="1"                       comment="Briefing step to start the mission on." />
                  <param name="TradeOffers"     value="[$TradeOffer]" />
                </cue>

                <cue name="Ch1_3_Delivery_Lines_Antimatter">
                  <actions>
                    <set_value name="$lines" exact="[[30224130],[30224131, 1.2s]]"/>
                    <do_if value="not $BosoConfession?">
                      <append_to_list name="$lines" exact="[30224133, 1.2s]"/>
                    </do_if>
                  </actions>
                  <cues>

                    <cue name="Ch1_3_Boso_Delivery_Lines_Antimatter_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="$lines" comment="x"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch1_3_Dal_Delivery_Lines_Antimatter"/>
                      <!--
                    Boso	<t id="	30224130	">	It appears that they are researching the same anomaly which brought the station over.	</t>
                    Boso	<t id="	30224131	">	Most of the gravimetric charge dispersed during that event, but they brought quite the equipment to examine the traces.	</t>
                not confessed    Boso	<t id="	30224133	">	Let us hope that this satisfies their curiosity and leads to them leaving.	</t>
                    -->
                    </cue>

                    <cue name="Ch1_3_Dal_Delivery_Lines_Antimatter">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$DalBusta?"/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_3_Dal_Delivery_Lines_Antimatter_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"         value="[$DalBusta, $BosoTa]"/>
                          <param name="CutsceneKey"   value="[$DalCutsceneKey, $BosoCutsceneKey]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="Lines"         value="[  [[30224130]], [[30224132]] ]"/>
                          <!--
                          Dal	  <t id="	30224130	">	Will they be able to utilise those traces?	</t>
                          Boso	<t id="	30224132	">	Barely, this examination proves most useful for reconstructing the events of the electrical discharge.	</t>
                          -->
                        </cue>
                      </cues>
                    </cue>


                  </cues>
                </cue>

                <cue name="Ch1_3_TradeOffer_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="''"/>
                    <set_objective cue="$MissionCue" action="objective.wait"/>
                    <remove_trade_offer object="$ResearchShip" tradeoffer="$TradeOffer"/>
                  </actions>
                  <cues>
                    <cue name="Ch1_3_PlayerLeavesFullScreenMode" checkinterval="1s">
                      <!-- Trying to avoid Mission Updates while docked,
                           TODO: mmight need intermediary 'Wait' in case the player checks the mission manager directly -->
                      <conditions>
                        <check_value value="not player.isinfullscreenmenu"/>
                      </conditions>
                      <delay exact="if $Delay_RespawnRick? then ($Delay_RespawnRick + 1s) else 0s" comment="If the ship was destroyed and negative feedback leads to the next mission, we need a delay to respawn Rick so the Lib_Dialog runs at all."/>
                      <actions>
                        <signal_cue cue="Ch1_Long_Range_Scan"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Long_Range_Scan">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" exact="1" operation="add"/>

                <set_value name="$MaxDistance" exact="10km"/>

              </actions>
              <cues>

                <cue name="Ch1_Long_Range_Scan_Locations">
                  <actions>
                    <!-- Find 2 locations for scanning-->

                    <!--<create_position name="$ShipPos" object="$ResearchShip" space="$ResearchShip.sector"/>-->
                    <create_position name="$TargetPos" x="0km" y="25km" z="-25km" object="$HQ" space="$HQ.sector" comment="Target Position for the ResearchShip"/>
                    <set_value name="$ScanSector" exact="$HQ.sector" comment="Safe this sector to leave the mission here even if the station moves again"/>

                    <!-- Scan Location 1 -->
                    <set_value name="$RandomDirection" min="0deg" max="360deg"/>
                    <set_value name="$RandomDistance"  min="0km" max="10km"/>

                    <create_position name="$RandomPos1" x="$TargetPos.x + sin($RandomDirection) * $RandomDistance"
                                                        z="$TargetPos.z + cos($RandomDirection) * $RandomDistance"
                                                        y="0"/>

                    <get_safe_pos result="$ScanLoc1" value="$RandomPos1" allowyaxis="false" radius="1 * $MaxDistance" sector="$ScanSector" space="$ScanSector"/>
                    <create_object name="$Beacon1" macro="macro.env_deco_nav_beacon_t1_mission_macro" owner="faction.pioneers" sector="$ScanSector">
                      <position object="$ScanSector" space="$ScanSector" value="$ScanLoc1"/>
                    </create_object>
                    <!--<set_object_min_hull object="$Beacon1" exact="100" comment="indestructible (destroy later)"/>-->
                    <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                      <param name="Object" value="$Beacon1"/>
                      <param name="RequesterCue" value="Ch1_Long_Range_Scan"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>

                    <!-- Scan Location 2-->
                    <set_value name="$RandomDirection" min="0deg" max="360deg"/>
                    <set_value name="$Distance"  exact="2.1 * $MaxDistance"/>

                    <create_position name="$RandomPos2" x="$ScanLoc1.x + sin($RandomDirection) * $Distance"
                                                        z="$ScanLoc1.z + cos($RandomDirection) * $Distance"
                                                        y="0"/>

                    <set_value name="$DistanceOkay" exact="false"/>
                    <set_value name="$DistanceAttemptCounter"  exact="0"/>
                    <do_while value="(not $DistanceOkay)">
                      <set_value name="$DistanceAttemptCounter" exact="1" operation="add"/>
                      <get_safe_pos result="$ScanLoc2" value="position.[$RandomPos2.x, 0, $RandomPos2.z]" allowyaxis="false" radius="$MaxDistance" sector="$ScanSector" space="$ScanSector"/>
                      <do_if value="$ScanLoc1.distanceto.{$ScanLoc2} gt $MaxDistance">
                        <set_value name="$DistanceOkay" exact="true"/>
                      </do_if>
                      <do_if value="$DistanceAttemptCounter gt 1200">
                        <break/>
                      </do_if>
                    </do_while>
                    <debug_text text="'2 DistanceAttempts: ' + $DistanceAttemptCounter + ' ' + $DistanceOkay"/>
                    <create_object name="$Beacon2" macro="macro.env_deco_nav_beacon_t1_mission_macro" owner="faction.pioneers" sector="$ScanSector">
                      <position object="$ScanSector" space="$ScanSector" value="$ScanLoc2"/>
                    </create_object>
                    <!--<set_object_min_hull object="$Beacon2" exact="100" comment="indestructible (destroy later)"/>-->
                    <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                      <param name="Object" value="$Beacon2"/>
                      <param name="RequesterCue" value="Ch1_Long_Range_Scan"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>

                    <!-- Scan Location 3-->
                    <create_position name="$RandomPos3" x="$ScanLoc2.x + sin($RandomDirection) * $Distance"
                                                        z="$ScanLoc2.z + cos($RandomDirection) * $Distance"
                                                        y="0"/>

                    <set_value name="$DistanceOkay" exact="false"/>
                    <set_value name="$DistanceAttemptCounter"  exact="0"/>
                    <do_while value="(not $DistanceOkay)">
                      <set_value name="$DistanceAttemptCounter" exact="1" operation="add"/>
                      <get_safe_pos result="$ScanLoc3" value="position.[$RandomPos3.x, 0, $RandomPos3.z]" allowyaxis="false" radius="$MaxDistance" sector="$ScanSector" space="$ScanSector"/>
                      <do_if value="$ScanLoc2.distanceto.{$ScanLoc3} gt $MaxDistance">
                        <set_value name="$DistanceOkay" exact="true"/>
                      </do_if>
                      <do_if value="$DistanceAttemptCounter gt 1200">
                        <break/>
                      </do_if>
                    </do_while>
                    <debug_text text="'3 DistanceAttempts: ' + $DistanceAttemptCounter + ' ' + $DistanceOkay"/>
                    <create_object name="$Beacon3" macro="macro.env_deco_nav_beacon_t1_mission_macro" owner="faction.pioneers" sector="$ScanSector">
                      <position object="$ScanSector" space="$ScanSector" value="$ScanLoc3"/>
                    </create_object>
                    <!--<set_object_min_hull object="$Beacon3" exact="100" comment="indestructible (destroy later)"/>-->
                    <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                      <param name="Object" value="$Beacon3"/>
                      <param name="RequesterCue" value="Ch1_Long_Range_Scan"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>


                    <!-- Scan Locations Done -->
                    <assert value="$ScanLoc1.distanceto.{$ScanLoc2} gt $MaxDistance" text="'Scan Locations Overlap! [Heinrich]'"/>

                    <create_group groupname="$ScanLocations"/>
                    <add_to_group groupname="$ScanLocations" list="[$Beacon1, $Beacon2, $Beacon3]"/>

                  </actions>
                  <cues>
                    <cue name="Ch1_Hint_HS_LRS">
                      <actions>
                        <do_if value="$HeadScientistSaid.indexof.{30224111}">
                          <set_value name="$lines" exact="[[if $Terran_DLC_GS then 30224134 else 30224133], [30224150], [30224152], [30224153]]"/>
                          <!--                    
                         <t id="30224133">Our research team thanks you for your cooperation.</t>
                         <t id="30224134">Thank you for your continued assisstance.</t>                         
                         -->
                        </do_if>
                        <do_else comment="'Player did not yet talk to the Segarian in this plot'">
                          <set_value name="$lines" exact="[[30224001], [30224111]]"/>
                          <append_to_list name="$HeadScientistSaid" exact="30224111"/>
                          <!--
                            30224001 Greetings.
                            30224111 I am Dr. Rick Feynman, Chief Scientist of the Oberth(Oberth is the ship's name) and in charge of Project Genesis.(Project Genesis same as {30224,1})
                          -->
                          <do_if value="$Terran_DLC_GS and (not $HeadScientistSaid.indexof.{'CS_Recognised'})">

                            <append_to_list name="$HeadScientistSaid" exact="'CS_Recognised'"/>
                            <do_if value="$Segarian_GS">
                              <do_if value="player.name == readtext.{1021}.{1002}" comment="didn't rename from Najia Takio">
                                <append_to_list name="$lines" exact="[30224112]" comment="Wait, Najia Takio? Is it really you?(Player name from the Project Genesis  game start)"/>
                              </do_if>
                              <do_else>
                                <append_to_list name="$lines" exact="[30224114]" comment="Wait, I know you, don't I?"/>
                              </do_else>
                              <append_to_list name="$lines" exact="[30224113]" comment="I am fairly glad that you made it."/>
                            </do_if>
                            <do_else comment="$Terran_Cadet_GS">
                              <append_to_list name="$lines" exact="[30224114]" comment="Wait, I know you, don't I?"/>
                              <do_if value="player.name == readtext.{1021}.{902}" comment="didn't rename from Raibu Hariken">
                                <append_to_list name="$lines" exact="[30224115]" comment="Mr. Hariken? Is it really you?(Player name from the Terran Cadet game start)"/>
                              </do_if>
                              <append_to_list name="$lines" exact="[30224116]" comment="You worked for us at the station!"/>
                            </do_else>
                            <append_to_list name="$lines" exact="[30224117]" comment="We did not expect biological matter to have survived this transition."/>
                            <append_to_list name="$lines" exact="[30224118]" comment="As I was saying, we are looking into how this station got here."/>
                          </do_if>
                          <do_elseif value="$Terran_DLC_GS and $PlayerReportedToHS?">
                            <append_to_list name="$lines" exact="[30224005]" comment="Oh, it is you."/>
                            <append_to_list name="$lines" exact="[30224124]" comment="I am glad to see you being fit and well."/>
                          </do_elseif>

                          <append_to_list name="$lines" exact="[30224150]" comment="We do need your help in putting this Antimatter to good use."/>
                          <append_to_list name="$lines" exact="[30224152]" comment="We will need ships at the specified locations to initiate a synchronised long range scan."/>
                          <append_to_list name="$lines" exact="[30224153]" comment="We will be enlisting, but if you have any friends to fill those spots, that would be a good time."/>
                          <!--  x   <t id="30224151">Please place your ship at the specified location and prepare to initiate a long range scan.</t>-->
                        </do_else>

                      </actions>
                      <cues>
                        <cue name="Ch1_Hint_HS_LRS_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$HeadScientistActor"/>
                          <param name="CutsceneKey"       value="$HeadScientistActorCutsceneKey"/>
                          <param name="Lines"             value="$lines" comment="x"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch1_Hint_Set_Objective"/>
                        </cue>
                        <!--                    
                    <t id="30224133">Our research team thanks you for your cooperation.</t>
                    <t id="30224134">Thank you for your continued assisstance.</t>
                    
                    <t id="30224150">We do need your help in putting this Antimatter to good use.</t>
                 x   <t id="30224151">Please place your ship at the specified location and prepare to initiate a long range scan.</t>
                    <t id="30224152">We will need ships at the specified locations to initiate a synchronised long range scan.</t>
                    <t id="30224153">We will be enlisting, but if you have any friends to fill those spots, that would be a good time.</t>
                    -->

                        <cue name="Ch1_Hint_Set_Objective">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- Customaction: Position Ships at specified locations -->
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,1052}" text="{30224,1053}" group="$ScanLocations" radius="$MaxDistance" updatebriefing="true"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_Long_Range_Scan_Ship_1" checkinterval="2s">
                      <conditions>
                        <count_ships result="$PlayerShipsLoc1" owner="faction.player" space="$ScanSector" min="1" masstraffic="false" checkoperational="true" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
                          <match_distance max="$MaxDistance" object="$Beacon1"/>
                        </count_ships>
                      </conditions>
                      <actions>
                        <debug_text text="$PlayerShipsLoc1"/>
                        <signal_cue cue="Ch1_Long_Range_Scan_Check"/>
                        <remove_from_group object="$Beacon1" group="$ScanLocations"/>
                      </actions>
                      <cues>
                        <cue name="Ch1_Joint_LRS_Ship1_Left" checkinterval="2s">
                          <conditions>
                            <count_ships result="$PlayerShipsLoc1" owner="faction.player" space="$ScanSector" exact="0" masstraffic="false" checkoperational="true" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
                              <match_distance max="$MaxDistance" object="$Beacon1"/>
                            </count_ships>
                          </conditions>
                          <actions>
                            <debug_text text="'Lost Ships at Loc 1'"/>
                            <add_to_group object="$Beacon1" groupname="$ScanLocations"/>

                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,1052}" text="{30224,1053}" group="$ScanLocations" radius="$MaxDistance" updatebriefing="true" silent="1"/>
                            <reset_cue cue="parent"/>
                            <reset_cue cue="Ch1_Long_Range_Scan_Ready"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_Long_Range_Scan_Ship_2" checkinterval="2s">
                      <conditions>
                        <count_ships result="$PlayerShipsLoc2" owner="faction.player" space="$ScanSector" min="1" masstraffic="false" checkoperational="true" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
                          <match_distance max="$MaxDistance" object="$Beacon2"/>
                        </count_ships>
                      </conditions>
                      <actions>
                        <debug_text text="$PlayerShipsLoc2"/>
                        <signal_cue cue="Ch1_Long_Range_Scan_Check"/>
                        <remove_from_group object="$Beacon2" group="$ScanLocations"/>
                      </actions>
                      <cues>
                        <cue name="Ch1_Joint_LRS_Ship2_Left" checkinterval="2s">
                          <conditions>
                            <count_ships result="$PlayerShipsLoc2" owner="faction.player" space="$ScanSector" exact="0" masstraffic="false" checkoperational="true" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
                              <match_distance max="$MaxDistance" object="$Beacon2"/>
                            </count_ships>
                          </conditions>
                          <actions>
                            <debug_text text="'Lost Ships at Loc 2'"/>
                            <add_to_group object="$Beacon2" groupname="$ScanLocations"/>

                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,1052}" text="{30224,1053}" group="$ScanLocations" radius="$MaxDistance" updatebriefing="true" silent="1"/>
                            <reset_cue cue="parent"/>
                            <reset_cue cue="Ch1_Long_Range_Scan_Ready"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_Long_Range_Scan_Ship_3" checkinterval="2s">
                      <conditions>
                        <count_ships result="$PlayerShipsLoc3" owner="faction.player" space="$ScanSector" min="1" masstraffic="false" checkoperational="true" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
                          <match_distance max="$MaxDistance" object="$Beacon3"/>
                        </count_ships>
                      </conditions>
                      <actions>
                        <debug_text text="$PlayerShipsLoc3"/>
                        <signal_cue cue="Ch1_Long_Range_Scan_Check"/>
                        <remove_from_group object="$Beacon3" group="$ScanLocations"/>
                      </actions>
                      <cues>
                        <cue name="Ch1_Joint_LRS_Ship3_Left" checkinterval="2s">
                          <conditions>
                            <count_ships result="$PlayerShipsLoc3" owner="faction.player" space="$ScanSector" exact="0" masstraffic="false" checkoperational="true" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]">
                              <match_distance max="$MaxDistance" object="$Beacon3"/>
                            </count_ships>
                          </conditions>
                          <actions>
                            <debug_text text="'Lost Ships at Loc 3'"/>
                            <add_to_group object="$Beacon3" groupname="$ScanLocations"/>

                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,1052}" text="{30224,1053}" group="$ScanLocations" radius="$MaxDistance" updatebriefing="true" silent="1"/>
                            <reset_cue cue="parent"/>
                            <reset_cue cue="Ch1_Long_Range_Scan_Ready"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_Long_Range_Scan_Check" instantiate="true">
                      <!-- Signalled by either location if a ship is nearby-->
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$PlayerShipsLoc1? and $PlayerShipsLoc1.count"/>
                        <check_value value="$PlayerShipsLoc2? and $PlayerShipsLoc2.count"/>
                        <check_value value="$PlayerShipsLoc3? and $PlayerShipsLoc3.count"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch1_Hint_HS_LRS_Ready"  check="false"/>
                        <signal_cue cue="Ch1_Long_Range_Scan_Ready" check="false"/>
                      </actions>
                    </cue>

                    <cue name="Ch1_Hint_HS_LRS_Ready">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch1_Hint_HS_LRS_Ready_v2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$HeadScientistActor"/>
                          <param name="CutsceneKey"       value="$HeadScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224154], [30224155], [30224190]]" comment="x"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--    
                      <t id="30224154">It looks like you are positioning your ship for the synchronised scan.</t>
                      <t id="30224155">Make sure to be precise, we do not want to introduce junk and clutter files into our database.</t>
                      <t id="	30224	190	">	Once you initiate the scan from your ship, the other captains will follow your lead.	</t>
                      -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_LRS_Not_Ready">
                      <conditions>
                        <event_long_range_scan_sent group="global.$PlayerContainerGroup"/>
                        <check_any comment="missing ships at at least one required location">
                          <check_value value="not ($PlayerShipsLoc1? and $PlayerShipsLoc1.count)"/>
                          <check_value value="not ($PlayerShipsLoc2? and $PlayerShipsLoc2.count)"/>
                          <check_value value="not ($PlayerShipsLoc3? and $PlayerShipsLoc3.count)"/>
                        </check_any>
                        <check_any comment="player using LRS unrelated to mission">
                          <check_value value="$PlayerShipsLoc1? and $PlayerShipsLoc1.indexof.{player.ship}"/>
                          <check_value value="$PlayerShipsLoc2? and $PlayerShipsLoc2.indexof.{player.ship}"/>
                          <check_value value="$PlayerShipsLoc3? and $PlayerShipsLoc3.indexof.{player.ship}"/>
                        </check_any>
                      </conditions>
                      <cues>
                        <cue name="Ch1_LRS_Not_Ready_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$HeadScientistActor"/>
                          <param name="CutsceneKey"       value="$HeadScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224192], [30224193], [30224190], [30224194]]" comment="x"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--    
                          <t id="	30224	192	">	You apparently misunderstood our task here.	</t>
                          <t id="	30224	193	">	We require ships at all specified locations to simultaneously initiate a long range scan.	</t>
                          <t id="	30224	194	">	Let's try that again.	</t>
                      -->
                          <param name="EndSignalCue"      value="Ch1_LRS_Not_Ready_Reset"/>
                        </cue>
                        <cue name="Ch1_LRS_Not_Ready_Reset">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="60s"/>
                          <actions>
                            <reset_cue cue="Ch1_LRS_Not_Ready"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>


                    <!-- ToDo: Players can probably move out of position again and it would still work (Probably not anymore but test before removing this) -->

                    <cue name="Ch1_Long_Range_Scan_Ready">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Awaiting LRS'"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep + 1" action="objective.custom" customaction="{30224,1054}" text="{30224,1055}" comment="Joint Long Range Scan: Long Range Scan now" updatebriefing="true"/>

                      </actions>
                      <cues>
                        <cue name="Ch1_Long_Range_Scan_Player">
                          <conditions>
                            <event_long_range_scan_sent group="global.$PlayerContainerGroup"/>
                          </conditions>
                          <actions>
                            <debug_text text="'LRS Sent'"/>

                            <add_effect object="player.zone" effect="'scfx_wave_02'" comment="long range scan effect">
                              <position object="$ResearchShip"/>
                            </add_effect>
                            <do_for_each in="$PlayerShipsLoc1" name="$ship">
                              <do_if value="$ship != player.ship">
                                <add_effect object="player.zone" effect="'scfx_wave_02'" comment="long range scan effect">
                                  <position object="$ship"/>
                                </add_effect>
                              </do_if>
                            </do_for_each>
                            <do_for_each in="$PlayerShipsLoc2" name="$ship">
                              <do_if value="$ship != player.ship">
                                <add_effect object="player.zone" effect="'scfx_wave_02'" comment="long range scan effect">
                                  <position object="$ship"/>
                                </add_effect>
                              </do_if>
                            </do_for_each>
                            <do_for_each in="$PlayerShipsLoc3" name="$ship">
                              <do_if value="$ship != player.ship">
                                <add_effect object="player.zone" effect="'scfx_wave_02'" comment="long range scan effect">
                                  <position object="$ship"/>
                                </add_effect>
                              </do_if>
                            </do_for_each>

                            <cancel_cue cue="Ch1_Long_Range_Scan_Ship_1"/>
                            <cancel_cue cue="Ch1_Long_Range_Scan_Ship_2"/>
                            <cancel_cue cue="Ch1_Long_Range_Scan_Ship_3"/>
                            <signal_cue cue="Ch1_Joint_Long_Range_Scan_Complete"/>

                          </actions>
                        </cue>


                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch1_Joint_Long_Range_Scan_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch1_Setup_ResearchShip_Scan"/>
                    <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                      <param name="Object" value="$Beacon1"/>
                      <param name="RequesterCue" value="Ch1_Long_Range_Scan"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                    <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                      <param name="Object" value="$Beacon2"/>
                      <param name="RequesterCue" value="Ch1_Long_Range_Scan"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                    <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                      <param name="Object" value="$Beacon3"/>
                      <param name="RequesterCue" value="Ch1_Long_Range_Scan"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>
                  </actions>
                  <delay exact="10s"/>
                  <actions>
                    <destroy_object object="$Beacon1" explosion="true"/>
                    <destroy_object object="$Beacon2" explosion="true"/>
                    <destroy_object object="$Beacon3" explosion="true"/>
                  </actions>
                  <cues>
                    <cue name="Ch1_Hint_HS_LRS_Complete_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$HeadScientistActor"/>
                      <param name="CutsceneKey"       value="$HeadScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224167], [30224170], [30224171], [30224180, 2s], [if $Terran_DLC_GS then 30224182 else 30224181]]" comment="x"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--    
                      <t id="30224167">Very good, we are receiving the data stream.</t>
                      <t id="30224168">(Euphoric)Success!</t>
                      <t id="30224169">(Euphoric)Yes!</t>
                      <t id="30224170">(Euphoric)We got what we were after.</t>
                      <t id="30224171">(Euphoric)Thank you for your support!</t>
                      
                      <t id="30224180">We are far from home, short on hands and have additional tasks which need doing.</t>
                      <t id="30224181">If you are interested, please meet me on our ship.</t>
                      <t id="30224182">Please meet me on our ship to discuss our next steps.</t>
                      -->
                      <param name="EndSignalCue"      value="Ch1_Complete"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="''"/>
                <remove_mission cue="$MissionCue" type="completed"/>
                <add_faction_relation faction="faction.player" otherfaction="faction.pioneers" value="0.0032" reason="relationchangereason.missioncompleted"/>

                <write_to_logbook category="missions" faction="faction.player" title="{30224,1121}" text="{30224,1122}"/>
                <cancel_cue cue="parent"/>
                <signal_cue cue="Ch2_HQ_Attack"/>
              </actions>
            </cue>
          </cues>
        </cue>


        <cue name="Ch2_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch2_Terraforming">
            <cancel_cue cue="Ch1_Intro"/>
            <!-- Special setup actions when you "fast-forward" into a chapter (skipping earlier ones) -->
          </force>
          <cues>
            <cue name="Ch2_Check_HQ">
              <actions>
                <do_if value="not $HQ?">
                  <signal_cue cue="Debug_Setup_HQ"/>
                </do_if>
                <signal_cue cue="Ch2_Force_Delay"/>
              </actions>
            </cue>
            <cue name="Ch2_Force_Delay">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="10s"/>
              <actions>
                <force_cue cue="Ch2_HQ_Attack"/>
                <signal_cue cue="Ch1_Setup_ResearchShip" check="false"/>
              </actions>
              <delay exact="2s"/>
              <actions>
                <set_object_radar_visible object="$ResearchShip" visible="true"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- Chapter 2:
              - Player Scans a Leak (?) 
              - Player Scans a Leak at HQ
        -->

        <cue name="Ch2_HQ_Attack">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <create_mission comment="Mission: Reclaiming What Was Lost" group="missiongroup.story_terraforming"
                            name="{30224,2001}" description="{30224,2002}" rewardtext="{30224,2020}"
                            icon="'briefing_dr_rick_feynman_01'" iconcaption="$HeadScientistActor.name"
                            faction="faction.pioneers" difficulty="level.trivial"
                            cue="$MissionCue" abortable="false" type="missiontype.plot">
              <briefing>
                <objective step="$ObjectiveStep" action="objective.talkto" object="$HeadScientistActor"/>
              </briefing>
            </create_mission>
            <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>

          </actions>
          <cues>

            <cue name="Debug_Conversation" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_list name="$HeadScientistSaid" comment="resetting everything"/>
                <cancel_conversation actor="$HeadScientistActor"/>
              </actions>
            </cue>

            <cue name="Ch2_Converastion_HeadScientist">
              <cues>
                <cue name="Ch2_Conv_HS_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started               actor="$HeadScientistActor"/>
                      <event_conversation_started               actor="$HeadScientistActor" conversation="HS_Conv"/>
                      <event_conversation_next_section          actor="$HeadScientistActor" section="hs_main"/>
                      <event_conversation_returned_to_section   actor="$HeadScientistActor" section="hs_main"/>
                      <event_cue_signalled                      comment="returning from sections with no player choices"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.name == 'event_conversation_started'">
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224001" comment="\033MGreetings."/>
                      </add_npc_line>
                      <do_if value="Ch2_1_SignalLeak.state == cuestate.complete" comment="LRS Task Briefing Done">
                        <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                          <text line="30224250" comment="\We need you to plant the malware on the station.."/>
                          <text line="30224251" comment="\Please do not slack on this task.."/>
                        </add_npc_line>
                      </do_if>

                    </do_if>
                    <do_else>
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224002" comment="\033MAnything else?"/>
                      </add_npc_line>
                    </do_else>

                    <do_if value="not $HeadScientistSaid.indexof.{'HQ_Lost_Explained'}">
                      <signal_cue cue="Ch2_Conv_HS_HQ"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch2_Conv_HS_Main_Choices"/>
                    </do_else>

                  </actions>
                </cue>

                <cue name="Ch2_Conv_HS_Main_Choices" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel"/>
                    <add_player_choice text="{30224,30224201}"      section="hs_plan" highlighted="true"/>
                    <add_player_choice text="{30224,30224202}"      section="hs_what_happened"/>
                    <do_if value="$HeadScientistSaid.indexof.{'HQ_What_Happened'}">
                      <add_player_choice text="{30224,30224203}"      section="hs_information"/>
                      <add_player_choice text="{30224,30224204}"      section="hs_negotiate"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch2_Conv_HS_HQ" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <append_to_list name="$HeadScientistSaid" exact="'HQ_Lost_Explained'"/>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224210" comment="\033MThe event which prompted this expedition was us losing access to our research facility."/>
                    </add_npc_line>
                    <do_if value="$Terran_DLC_GS">
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224211" comment="\033MYou of course witnessed this first hand."/>
                      </add_npc_line>
                    </do_if>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224212" comment="\033MNow we have not only located our facility, but also taken precautions."/>
                      <text line="30224213" comment="\033MIf it disappears from under our nose again, we won't be having such a hard time tracking it down."/>
                    </add_npc_line>
                    <signal_cue cue="Ch2_Conv_HS_Main_Choices"/>
                  </actions>
                </cue>

                <cue name="Ch2_Conv_HS_Update_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <update_mission cue="$MissionCue" description="{30224,2003}"/>
                  </actions>
                </cue>

                <cue name="Ch2_Conv_HS_Plan" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="hs_plan"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224214" comment="We have prepared a software which will help us regain access, but our ship is not exactly inconspicuous enough to plant it on our station."/>
                      <text line="30224215" comment="The malware should not provoke the current occupant into action."/>
                      <text line="30224216" comment="It will be your job to plant it at this location our analyst has identified."/>
                      <text line="30224217" comment="Judging by the station plans there should be a signal leak next to what looks like either a valve or a window, but you'll find out when you get there."/>
                    </add_npc_line>
                    <signal_cue cue="Ch2_Conv_HS_Update_Mission" check="false"/>
                  </actions>
                  <cues>
                    <cue name="Ch2_Conv_HS_Plan_Objective">
                      <conditions>
                        <event_conversation_finished actor="$HeadScientistActor"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch2_1_SignalLeak" check="false"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_Conv_HS_What_Happened" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="hs_what_happened"/>
                  </conditions>
                  <actions>
                    <append_to_list name="$HeadScientistSaid" exact="'HQ_What_Happened'"/>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224220" comment="You surely heard stories about the Boron, once known as a wise and noble people."/>
                    </add_npc_line>
                    <do_if value="not (md.$DLCBoronFactions? and md.$DLCBoronFactions.count)">
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224221" comment="The Community of Planets hasn't heard anything from them in quite a while, so we don't know what happened to them after the Gate shutdown or even if there are any left out there."/>
                        <text line="30224222" comment="However, one of them is still among us, and from what we could gather he is an outlier and turned criminal."/>
                        <text line="30224223" comment="Can't really blame him. Were I trapped amidst societies of Argnu for decades, I'd, too, be tempted to take advantage one way or the other."/>
                      </add_npc_line>
                    </do_if>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224224" comment="This subject chose to take our station to reside in there."/>
                    </add_npc_line>
                    <signal_cue cue="Ch2_Conv_HS_Main"/>
                  </actions>
                </cue>

                <cue name="Ch2_Conv_HS_Information" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="hs_information"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224240" comment="After Segarian Intelligence identified the Boron as perpetrator in this incident, we had them dig deeper."/>
                      <text line="30224241" comment="He had connections to Split criminals. They, however, went off the grid and remain quite the mystery."/>
                    </add_npc_line>
                    <do_if value="md.Story_Paranid.Sinks_Escalation_Stage_1.state == cuestate.complete">
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224242" comment="He also had contact to a Paranid Duke(Duke same as {30220,113}) who maintains some sort of private army by the name of Duke's Buccaneers.(Duke's Buccaneers same as {20203,2401})"/>
                      </add_npc_line>
                    </do_if>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224243" comment="Either way, the Boron is well connected among and backed by various shady characters."/>
                      <text line="30224244" comment="His own technical proficiency paired with the criminal network he built around himself make him quite capable of anything."/>
                      <text line="30224245" comment="Do not underestimate this criminal."/>
                    </add_npc_line>
                    <signal_cue cue="Ch2_Conv_HS_Main"/>
                  </actions>
                </cue>

                <cue name="Ch2_Conv_HS_Negotiate" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="hs_negotiate"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224230" comment="Despite the noble reputation the Boron hold, this specimen clearly displayed his intention by stealing a station."/>
                      <text line="30224231" comment="As we can not fathom what else he might be capable of, it is imperative to not make us his enemy."/>
                      <text line="30224232" comment="We cannot risk making him aware of our intent, otherwise we won't stand a chance against any measures he decides to take."/>
                      <text line="30224234" comment="Proceed with caution and do not allow any intel to be leaked to the Boron."/>
                    </add_npc_line>
                    <signal_cue cue="Ch2_Conv_HS_Main"/>
                  </actions>
                </cue>

              </cues>
            </cue>


            <cue name="Ch2_1_SignalLeak">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" exact="1" operation="add"/>
              </actions>
              <cues>

                <cue name="Ch2_Hint_Boso_Comment">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch2_Hint_Boso" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30224201], [30224202], [30224203], [30224204]]" comment="x"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch2_Hint_Dal_Comment"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_Hint_Dal_Comment">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="$DalBusta?"/>
                  </conditions>
                  <cues>
                    <cue name="Ch2_Hint_Dal" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$DalBusta]"/>
                      <param name="CutsceneKey"       value="[$DalCutsceneKey]"/>
                      <param name="Lines"             value="[[[30224201]]]" comment="x"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                    </cue>
                  </cues>
                </cue>


                <cue name="Ch2_1_HQ_Attention_Check_Init">
                  <actions>
                    <signal_cue cue="Ch2_1_HQ_Attention_Check"/>
                  </actions>
                </cue>

                <cue name="Ch2_1_HQ_Attention_Check" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_changed_attention object="$HQ"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="$HQ.attention ge attention.nearby">
                      <!-- Creating a SignalLeak required Active Physics 
                           External View could also count -->
                      <signal_cue cue="Ch2_1_Create_Leak" check="false"/>
                    </do_if>
                    <do_else>
                      <do_if value="@$SignalLeak.exists">
                        <destroy_object object="$SignalLeak"/>
                      </do_if>
                      <reset_cue cue="Ch2_1_Create_Leak"/>
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$HQ" updatebriefing="true" silent="true"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch2_1_Create_Leak" version="3">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <patch sinceversion="2" state="complete">
                    <do_if value="Ch2_1_Scan_Leak.state == cuestate.waiting">
                      <debug_text text="'Attempt to recreate signal leak at better location'" filter="savegame"/>
                      <do_if value="$SignalLeak.exists">
                        <destroy_object object="$SignalLeak"/>
                      </do_if>
                      <reset_cue cue="Ch2_1_Create_Leak_Resetter"/>
                    </do_if>
                  </patch>
                  <patch sinceversion="3">
                    <do_if value="Ch2_1_Scan_Leak.state == cuestate.waiting">
                      <do_if value="$SignalLeak? and $SignalLeak.exists">
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$SignalLeak" updatebriefing="true"/>
                      </do_if>
                      <do_else>
                        <reset_cue cue="Ch2_1_Create_Leak_Resetter"/>
                      </do_else>
                    </do_if>
                  </patch>
                  <cues>
                    <cue name="Ch2_1_Create_Leak_Resetter" comment="Retry if @$SurfacePos fails">
                      <delay exact="1s"/>
                      <actions>
                        <set_value name="$SignalLeak" exact="null"/>
                        <do_if value="$HQ.isphysicsready">
                          <set_value name="$LeakObject" exact="$HQ"/>
                          <include_actions ref="md.Signal_Leaks.GetLeakSlots"/>

                          <do_for_each in="$LeakLocations" name="$leak" reverse="true">
                            <do_if value="$leak.name == 'con_info004'" comment="Leak on the Asteroid looks weird">
                              <remove_from_list name="$LeakLocations" exact="$leak"/>
                            </do_if>
                          </do_for_each>

                          <shuffle_list list="$LeakLocations"/>
                          <set_value name="$MissionLeakMacro" exact="macro.signalleak_s_standard_01_macro" />
                          <do_for_each name="$SignalLeakLocation" in="$LeakLocations">
                            <find_object_surface posname="$SurfacePos" rotname="$SurfaceRot" object="$SignalLeakLocation.component" height="$MissionLeakMacro.boundingbox.max.y - $MissionLeakMacro.boundingbox.center.y" tolerateneighbour="false">
                              <position value="$SignalLeakLocation.offset" />
                              <!-- the rotation created by the normal would look away from the surface, we want a rotation that's looking parallel to the surface -->
                              <offsetrotation pitch="-90deg" />
                            </find_object_surface>

                            <do_if value="@$SurfacePos">
                              <create_signal_leak name="$SignalLeak" groupname="$Leaks" macro="$MissionLeakMacro" type="signalleaktype.mission" object="$SignalLeakLocation.component">
                                <position value="$SurfacePos" />
                                <rotation value="$SurfaceRot" />
                                <!--<voice page="$SignalLeakActor.page" lines="[1000003, 1000004, 1000005]"/>-->
                              </create_signal_leak>
                              <create_position name="$SignalLeakPos" object="$SignalLeak" space="$SignalLeak.sector"/>

                              <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$SignalLeak" updatebriefing="true"/>
                              <signal_cue cue="Ch2_Hint_Boso_Comment" check="false"/>

                              <break/>
                            </do_if>
                            <debug_text text="'Unable to place leak at ' + $SignalLeakLocation" chance="$DebugChance"/>
                          </do_for_each>
                        </do_if>

                        <do_if value="not $SignalLeak.exists">
                          <debug_text text="'SurfacePos for SignalLeak failed'" chance="$DebugChance"/>
                          <reset_cue cue="this"/>
                        </do_if>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_1_Scan_Leak">
                  <conditions>
                    <event_player_signal_unlock_finished signal="$SignalLeak"/>
                  </conditions>
                  <actions>
                    <remove_value name="$SignalLeak"/>
                    <do_if value="@$SignalLeak.exists">
                      <destroy_object object="$SignalLeak" explosion="false"/>
                    </do_if>
                    <cancel_cue cue="Ch2_1_SignalLeak"/>
                    <signal_cue cue="Ch2_Complete"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch2_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30224,2021}" text="{30224,2022}"/>
                <cancel_cue cue="parent"/>
                <signal_cue cue="Ch3_Deliver_Research"/>
              </actions>
            </cue>
          </cues>
        </cue>


        <cue name="Ch3_Force">
          <force name="Ch3_Terraforming_Intro">
            <!-- Special setup actions when you "fast-forward" into a chapter (skipping earlier ones) -->
            <do_if value="not $HQ?">
              <signal_cue cue="Debug_Setup_HQ"/>
            </do_if>

            <force_cue cue="Ch3_Deliver_Research"/>
          </force>
        </cue>

        <!-- Chapter 3:
              - Player gets item from Safe Deposit and delivers it to Neps
        -->

        <cue name="Ch3_Deliver_Research">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <create_mission comment="Mission: Double Assistant" group="missiongroup.story_terraforming"
                            name="{30224,3001}" description="{30224,3002}" rewardtext="{30224,3020}"
                            icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name"
                            faction="faction.player" difficulty="level.trivial"
                            cue="$MissionCue" abortable="false" type="missiontype.plot">
              <briefing>
              </briefing>
            </create_mission>

          </actions>
          <cues>

            <cue name="Ch3_Hint_Boso_Comment">
              <cues>
                <cue name="Ch3_Hint_Boso" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                  <param name="Lines"             value="[[30224305], [30224301, 1s, Ch3_1_Uploading_Item], [30224304], [30224303]]" comment="x"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                  <t id="	30224	305	">	Assistant! I have indeed fabulous news!	</t>
                  <t id="	30224	301	">	I took a look at their malware and am quite sure that I have figured out what the Segarian researchers are after.	</t>
                  not used <t id="	30224	302	">	You can find a file I prepared for them in the Safe Deposit Storage in my office.	</t>
                  <t id="	30224	304	">	I am sending you the file I prepared for them.	</t>
                  <t id="	30224	303	">	Please deliver it to their Chief Scientist with my best regards.	</t>                  
                  -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch3_1_SafeDeposit">
              <!-- Currently not used cue, skipped to Ch3_2_Deliver_Item -->
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- Get Item from Safe Deposit -->
              <actions>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.pickup" text="{30224,3051}" object="$BosoTa" updatebriefing="true"/>
                <!-- Code to put inventory into the Safe Deposit / InventoryConsole in the Boron's Office -->
              </actions>
              <cues>
                <cue name="Ch3_1_SafeDeposit_Get">
                  <conditions>
                    <event_conversation_started actor="$BosoTa"/>
                  </conditions>
                  <actions>
                    <add_inventory ware="ware.inv_segarian_research"/>
                    <show_notification text="{1015,90} + '\n' + ware.inv_segarian_research.name" sound="notification_generic" comment="Document received"/>
                    <signal_cue cue="Ch3_2_Deliver_Item"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch3_1_Uploading_Item">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$EstablishingConnection" exact="0"/>
                <set_value name="$DownloadProgress" exact="0"/>
                <set_value name="$DownloadStuck" exact="0"/>
              </actions>
              <cues>
                <cue name="Ch3_Upload_In_Progress">
                  <delay exact="0.13s"/>
                  <actions>
                    <set_value name="$DownloadText" exact="readtext.{30224}.{3100}" comment="Establishing Connection"/>
                    <set_value name="$EstablishingConnection" operation="add" exact="1"/>

                    <do_if value="$EstablishingConnection ge 10">
                      <set_value name="$DownloadText" exact="readtext.{30224}.{3101}" comment="Connection Established"/>
                    </do_if>
                    <do_if value="$EstablishingConnection ge 20">
                      <set_value name="$DownloadProgress" operation="add" exact="1"/>

                      <do_if value="$DownloadProgress ge 54">
                        <set_value name="$DownloadStuck" exact="1" operation="add"/>
                        <do_if value="($DownloadStuck le 40) and (not [26,27,28,29,36].indexof.{$DownloadStuck})">
                          <set_value name="$DownloadProgress" operation="subtract" exact="1"/>
                        </do_if>
                      </do_if>
                    </do_if>

                    <!-- Update download text throughout percentiles -->
                    <do_if value="$DownloadProgress ge 1 and $DownloadProgress le 9">
                      <set_value name="$DownloadText" exact="readtext.{30224}.{3102}" comment="Downloading Preliminary Studies"/>
                      <do_if value="$DownloadProgress == 5">
                        <!-- Rapid Succession Text Updates -->
                        <set_value name="$DownloadText" exact="readtext.{30224}.{3110}" comment="Project Genesis Viability Study"/>
                      </do_if>
                      <do_elseif value="$DownloadProgress == 6">
                        <set_value name="$DownloadText" exact="readtext.{30224}.{3111}" comment="Project Genesis Team Evaluation"/>
                      </do_elseif>
                      <do_elseif value="$DownloadProgress == 7">
                        <set_value name="$DownloadText" exact="readtext.{30224}.{3112}" comment="Project Genesis Security Measures"/>
                      </do_elseif>
                    </do_if>
                    <do_elseif value="$DownloadProgress le 39">
                      <set_value name="$DownloadText" exact="readtext.{30224}.{3103}" comment="Downloading Empirical Findings"/>
                    </do_elseif>
                    <do_elseif value="$DownloadProgress le 45">
                      <set_value name="$DownloadText" exact="readtext.{30224}.{3113}" comment="Downloading Quantitative Data"/>
                    </do_elseif>
                    <do_elseif value="$DownloadProgress le 52">
                      <set_value name="$DownloadText" exact="readtext.{30224}.{3104}" comment="Downloading Result Evaluation"/>
                    </do_elseif>
                    <do_elseif value="$DownloadProgress le 81">
                      <set_value name="$DownloadText" exact="readtext.{30224}.{3105}" comment="Downloading Engineering Blueprints"/>
                    </do_elseif>
                    <do_elseif value="$DownloadProgress le 92">
                      <set_value name="$DownloadText" exact="readtext.{30224}.{3106}" comment="Downloading Control Software"/>
                    </do_elseif>
                    <do_elseif value="$DownloadProgress le 95">
                      <set_value name="$DownloadText" exact="readtext.{30224}.{3107}" comment="Encrypting"/>
                    </do_elseif>
                    <do_elseif value="$DownloadProgress le 100">
                      <set_value name="$DownloadText" exact="readtext.{30224}.{3108}" comment="Finalising"/>
                    </do_elseif>

                    <set_objective cue="$MissionCue" action="objective.await" text="$DownloadText" silent="true">
                      <progress progress="$DownloadProgress" max="100"/>
                    </set_objective>

                    <do_if value="$DownloadProgress ge 100">
                      <signal_cue cue="Ch3_Upload_Complete"/>
                    </do_if>
                    <do_else>
                      <reset_cue cue="this"/>
                    </do_else>
                  </actions>
                </cue>


                <cue name="Ch3_Upload_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <add_inventory ware="ware.inv_segarian_research"/>
                    <signal_cue cue="Ch3_2_Deliver_Item"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch3_2_Deliver_Item">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch3_Conv_HS_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started               actor="$HeadScientistActor"/>
                      <event_conversation_started               actor="$HeadScientistActor" conversation="HS_Conv"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.name == 'event_conversation_started'">
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224003" comment="\033MWhat is it now?"/>
                      </add_npc_line>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch3_Deliver_Research_Ref" ref="md.RML_Deliver_Inventory.Deliver_Inventory">
                  <param name="EndSignalCue"    value="Ch3_Delivered_Conversation"/>
                  <param name="MissionCue"      value="$MissionCue"/>
                  <param name="StartStep"       value="$ObjectiveStep"           comment="Briefing step to start the mission on"/>
                  <param name="UpdateBriefing"  value="true"        comment="Update the briefing objective step when the objective is updated"/>

                  <!--Delivery params-->
                  <param name="WaresTableParam"         value="table[{ware.inv_segarian_research} = 1]"/>
                  <param name="DeliveryNPC"             value="$HeadScientistActor"      comment="The NPC to which the items should be delivered." />
                  <param name="DeliveryObject"          value="$ResearchShip"  comment="The object on which to point to before the NPC is placed. Also used to create the interior with the below parameters" />
                  <param name="ProgressBarText"         value="{30004,1054}" comment="Text to be displayed next to the ware delivery progress bar e.g. ('Delivered')"/>
                  <param name="ConversationOptionText"  value="{30224,30224301}" comment="(Player Choice)Sir, the Boron gave me this."/>
                  <param name="ConversationTipText"     value="{30221,2152}" comment="(Tooltip for an unselectable Player Choice)Insufficient Inventory"/>
                  <!--<param name="DeliveryNPCLine"         value="30221256"/>-->
                  <param name="PlaceNPC"                value="false" comment="we place them ourselves now"/>
                  <param name="DebugChance"             value="$DeepDebugChance"/>
                </cue>

                <cue name="Ch3_Delivered_Conversation_Started" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$HeadScientistActor"/>
                    <check_value value="$Ch3_Delivered_Conversation?"/>
                    <check_value value="not $Ch3_Delivered_Conversation_YakiCallEnd?"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch3_Delivered_Conversation"/>
                  </actions>
                </cue>

                <cue name="Ch3_Delivered_Conversation" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Ch3_Delivered_Conversation"/>

                    <set_objective cue="$MissionCue" action="objective.talkto" object="$HeadScientistActor" silent="true"/>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224301" comment="\033MWhat is this?"/>
                      <text line="30224302" comment="\033MHe.. he gave you our research?(in disbelief)"/>
                      <text line="30224303" comment="\033MUnbelievable!(Dumbfounded)"/>
                      <text line="30224307" comment="\033MBut you were supposed to plant software, how did that happen?"/>
                    </add_npc_line>
                    <add_player_choice text="{30224,30224305}"             section="hs_uploaded"/>
                    <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel" selectable="false"/>
                  </actions>
                </cue>

                <cue name="Ch3_Delivered_Uploaded" version="2" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="hs_uploaded"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224308" comment="\033MI clearly underestimated this Boron and his capabilities."/>
                      <text line="30224304" comment="\033MI suppose this means we can continue with Project Genesis, it is our uttermost priority."/>
                      <text line="30224305" comment="\033MWe better do not to make an enemy of the Boron and leave him with our station for the time being."/>
                      <text line="30224306" comment="\033MWe will have to come back for our station better prepared."/>
                    </add_npc_line>
                    <add_player_choice text="{30224,30224302}"             section="hs_now"/>
                    <!-- No need to cancel as conv_escape is disabled -->
                    <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel" selectable="false"/>

                    <create_position name="$TargetPos" object="$AsteroidBelt" space="$AsteroidBelt"/>
                    <cancel_cue cue="Ch1_Setup_ResearchShip_HQ_Warp_Pursuit"/>
                    <cancel_all_orders object="$ResearchShip"/>
                    <create_order id="'MoveWait'" object="$ResearchShip" immediate="true">
                      <param name="destination" value="[$AsteroidBelt, $TargetPos]"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                  </actions>
                  <patch sinceversion="2">
                    <!-- Recover for players who escaped out of this conversation (otherwise they couldn't save with *_Completed in waiting) -->
                    <do_if value="(cuestate.complete == Ch3_Delivered_Uploaded.state)
                              and (cuestate.waiting == Ch3_Conv_HS_Completed.state)">
                      <force_cue cue="Ch3_Conv_HS_Completed"/>
                      <set_value name="$Forcing_Ch3_Conv_HS_Completed"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch3_Conv_HS_Now" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_cue_signalled comment="returning from other sections without player choice"/>
                      <event_conversation_next_section section="hs_now"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <do_if value="not $HeadScientistSaid.indexof.{30224310}">
                      <append_to_list name="$HeadScientistSaid" exact="30224310"/>
                      <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                        <text line="30224310" comment="\033MI did not expect us to make progress this fast."/>
                        <text line="30224311" comment="\033MEither way, we can use your assistance further along the way."/>
                        <text line="30224313" comment="\033MYou will assist one of our associates in acquiring research vital to Project Genesis."/>
                      </add_npc_line>
                    </do_if>
                    <add_player_choice text="{30224,30224303}"                                                section="hs_task"/>
                    <add_player_choice text="{30224,30224304}"                                                section="hs_who" highlighted="true"/>
                    <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" section="g_cancel" selectable="false"/>
                  </actions>
                </cue>

                <cue name="Ch3_Conv_HS_Task" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="hs_task"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224314" comment="\033MTo keep it short: Our future."/>
                      <text line="30224315" comment="\033MThe Segaris Pioneers aspire to step up as a community."/>
                      <text line="30224316" comment="\033MProject Genesis will help us build a foundation for our new future."/>
                    </add_npc_line>
                    <signal_cue cue="Ch3_Conv_HS_Now"/>
                  </actions>
                </cue>

                <cue name="Ch3_Conv_HS_Who" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="hs_who"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224317" comment="\033MAn independent scientist. Let me contact them.(Paranid Gender)"/>
                    </add_npc_line>
                    <add_npc_line speaker="$YakiScientistActor" hidechoices="true" recipient="$HeadScientistActor">
                      <text line="30224417" comment="*** Sigh of Disappointment ***"/>
                    </add_npc_line>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true" recipient="$YakiScientistActor">
                      <text line="30224318" comment="\033MGreetings."/>
                      <text line="30224319" comment="\033MWe are sending you the pilot you requested.(Referring to Player)"/>
                    </add_npc_line>
                    <do_if value="player.entity.race == race.paranid">
                      <add_npc_line speaker="$YakiScientistActor" hidechoices="true" recipient="$HeadScientistActor">
                        <text line="30224310" comment="Is this one qualified?(Referring to Player)"/>
                      </add_npc_line>
                    </do_if>
                    <do_else>
                      <add_npc_line speaker="$YakiScientistActor" hidechoices="true" recipient="$HeadScientistActor">
                        <text line="30224309" comment="Is this creature qualified?(Referring to non-Paranid Player)"/>
                      </add_npc_line>
                    </do_else>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true" recipient="$YakiScientistActor">
                      <text line="30224320" comment="Yes, no, no, don't worry. This one is at least a two star pilot.(Referring to Player Gender)"/>
                    </add_npc_line>
                    <add_npc_line speaker="$YakiScientistActor" hidechoices="true" recipient="$HeadScientistActor">
                      <text line="30224311" comment="Expecting [mp:him|fp:her] at the experiment site."/>
                    </add_npc_line>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true" recipient="$YakiScientistActor">
                      <text line="30224321" comment="Okay, [mp:he|fp:she] is heading your way."/>
                    </add_npc_line>
                  </actions>
                  <cues>
                    <cue name="Ch3_Conv_HS_End_Yaki_Call">
                      <conditions>
                        <event_conversation_finished actor="$HeadScientistActor"/>
                      </conditions>
                      <actions>
                        <!--<cancel_conversation actor="$HeadScientistActor"/>-->
                        <cancel_cue cue="Ch3_Conv_HS_Main"/>
                        <set_value name="$Ch3_Delivered_Conversation_YakiCallEnd"/>
                        <start_conversation actor="$HeadScientistActor" conversation="ch3_done" missioncue="$MissionCue"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_Conv_HS_End" version="2">
                      <conditions>
                        <event_conversation_started actor="$HeadScientistActor" conversation="ch3_done"/>
                      </conditions>
                      <actions>
                        <remove_value name="$Ch3_Delivered_Conversation_YakiCallEnd"/>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                          <text line="30224322" comment="That's settled. Report to Kuromanckami."/>
                          <text line="30224323" comment="They are experimenting with a phenomenon in The Void(same as sector name) and will instruct you on your part once you get there."/>
                          <text line="30224324" comment="This might sound unaffiliated at first, but be assured: You are helping mold our future."/>
                        </add_npc_line>

                        <!-- Give player Space Suit Equipment if missing  / Laser Repair Laser required -->
                        <do_if value="(not player.entity.inventory.{ware.weapon_gen_spacesuit_laser_02_mk1}.exists) or
                                      (not player.entity.inventory.{ware.weapon_gen_spacesuit_repairlaser_01_mk1}.exists) or
                                      (not player.entity.inventory.{ware.engine_gen_spacesuit_01_mk2}.exists)">

                          <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                            <text line="30224330" comment="It seem that you are missing crucial spacesuit equipment."/>
                            <!--<text line="30224331" comment="Take this Hand Laser, it will become useful later on."/>-->
                            <text line="30224332" comment="Take this with you, it will become useful later on.(Giving Player Hand Laser/Repair Laser/Bomb Launcher/Bombs if missing)"/>
                          </add_npc_line>
                          <!--<do_if value="not player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.exists">
                            <add_inventory ware="ware.weapon_gen_spacesuit_demolition_01_mk1"     exact="1"/>
                          </do_if>-->
                          <do_if value="not player.entity.inventory.{ware.weapon_gen_spacesuit_laser_02_mk1}.exists">
                            <add_inventory ware="ware.weapon_gen_spacesuit_laser_02_mk1"     exact="1"/>
                            <show_notification text="{1015,90} + '\n' + ware.weapon_gen_spacesuit_laser_02_mk1.name" sound="notification_generic" comment="Document received"/>
                          </do_if>
                          <do_if value="not player.entity.inventory.{ware.weapon_gen_spacesuit_repairlaser_01_mk1}.exists">
                            <add_inventory ware="ware.weapon_gen_spacesuit_repairlaser_01_mk1"     exact="1"/>
                            <show_notification text="{1015,90} + '\n' + ware.weapon_gen_spacesuit_repairlaser_01_mk1.name" sound="notification_generic" comment="Document received"/>
                          </do_if>
                          <do_if value="not player.entity.inventory.{ware.engine_gen_spacesuit_01_mk2}.exists">
                            <add_inventory entity="player.entity" ware="ware.engine_gen_spacesuit_01_mk2" exact="1" />
                            <show_notification text="{1015,90} + '\n' + ware.engine_gen_spacesuit_01_mk2.name" sound="notification_generic" comment="Document received"/>
                          </do_if>
                        </do_if>


                        <reset_cue cue="Ch3_Conv_HS_Main"/>
                      </actions>
                      <patch sinceversion="2">
                        <!-- Recover for players who escaped out of this conversation (otherwise they couldn't save with *_Completed in waiting) -->
                        <do_if value="Ch3_Conv_HS_Completed.state == cuestate.waiting">
                          <force_cue cue="Ch3_Conv_HS_Completed"/>
                          <set_value name="$Forcing_Ch3_Conv_HS_Completed"/>
                        </do_if>
                      </patch>
                      <cues>
                        <cue name="Ch3_Conv_HS_End_Completed">
                          <conditions>
                            <event_conversation_finished actor="$HeadScientistActor"/>
                          </conditions>
                          <actions>
                            <remove_value name="$Ch3_Delivered_Conversation"/>
                            <signal_cue cue="Ch3_Conv_HS_Completed"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_Conv_HS_Completed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <add_faction_relation faction="faction.player" otherfaction="faction.pioneers" value="0.0064" reason="relationchangereason.missioncompleted"/>
                  </actions>
                  <cues>
                    <cue name="Ch3_Comment_Dal_Check">
                      <actions>
                        <do_if value="$DalBusta?">
                          <signal_cue cue="Ch3_Hint_TF_Dal"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch3_Hint_TF_Boso"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch3_Hint_TF_Dal">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Hint_TF_Dal_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30224301]]" comment="x"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch3_Hint_TF_Boso"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch3_Hint_TF_Boso">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Hint_TF_Boso_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30224310], [30224311], [30224312]]" comment="x"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch3_Complete"/>
                          <!--     <t id="30224310">\033MThey are hoping to colonise a planet as a new home for their people.</t>
                            <t id="30224311">\033MThe Terrans once meddled with such terraforming technology which resulted in the creation of the Xenon.</t>
                            <t id="30224312">\033MLet us hope that the Segaris Pioneers are not repeating their mistake.(Segaris Pioneers same as Faction {20203,2901})</t>
                            -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_Complete" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_terraforming_oberth"/>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30224,3021}" text="{30224,3022}"/>
                <cancel_cue cue="parent"/>
                <signal_cue cue="Ch4_Mission_Ship"/>
              </actions>
              <patch sinceversion="2" state="complete">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_terraforming_oberth"/>
              </patch>
              <patch sinceversion="2" state="cancelled">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_terraforming_oberth"/>
              </patch>
            </cue>
          </cues>
        </cue>


        <cue name="Ch4_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch4_Terraforming_Intro">
            <cancel_cue cue="Ch1_Intro"/>
          </force>
          <cues>
            <cue name="Ch4_Check_HQ">
              <actions>
                <do_if value="not $HQ?">
                  <signal_cue cue="Debug_Setup_HQ"/>
                </do_if>
                <signal_cue cue="Ch4_Force_Delay"/>
                <signal_cue cue="Debug_Arm_Spacesuit"/>
              </actions>
            </cue>
            <cue name="Ch4_Force_Delay">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="10s"/>
              <actions>
                <signal_cue cue="Ch1_Setup_ResearchShip" check="false"/>
              </actions>
              <delay exact="2s"/>
              <actions>
                <set_object_radar_visible object="$ResearchShip" visible="true"/>
                <signal_cue cue="Ch4_Setup_Align_ResearchShip" check="false"/>
                <force_cue cue="Ch4_Mission_Ship"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- Chapter 4:
              - Player places Satellites near hazardous zone
              - Player repairs Mission Ship, Docks
        -->

        <cue name="Ch4_Mission_Ship">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <signal_cue cue="Ch4_Setup_MissionShip"/>

            <create_mission comment="Mission: Second Assistant" group="missiongroup.story_terraforming"
                            name="{30224,4001}" description="{30224,4002}" rewardtext="{30224,4020}"
                            icon="'briefing_kuromanckami_01'" iconcaption="$YakiScientistActor.name"
                            faction="faction.pioneers" difficulty="level.medium"
                            cue="$MissionCue" abortable="false" type="missiontype.plot">
              <briefing>
                <objective step="$ObjectiveStep" action="objective.talkto" text="{30224,153}"/>
              </briefing>
            </create_mission>
            <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>
          </actions>
          <cues>

            <cue name="Ch4_Init_Variables">
              <actions>
                <create_group groupname="$Satellites"/>
              </actions>
            </cue>

            <cue name="Ch4_Conv_HeadScientist">
              <cues>
                <cue name="Ch4_Conv_HeadScientist_Started" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$HeadScientistActor"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224350" comment="The independent scientist, Kuromanckami, awaits you at the experiment site."/>
                      <text line="30224351" comment="Report there for further instructions."/>
                    </add_npc_line>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Boso_Ship_Done">
              <cues>
                <cue name="Ch4_Hint_Boso_Ship_Done_Init">
                  <actions>
                    <do_if value="$ResearchShip.sector != $BosoTa.sector">
                      <signal_cue cue="Ch4_Hint_Boso_Ship_Done" check="false"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch4_Hint_Boso_Ship_Done">
                  <conditions>
                    <check_any>
                      <event_object_changed_sector object="$ResearchShip" previous="$BosoTa.sector"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Hint_Boso_Ship_Done_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"         value="$BosoTa"/>
                      <param name="CutsceneKey"   value="$BosoCutsceneKey"/>
                      <param name="Lines"         value="[[30224313],[30224115]]"/>
                      <!--  <t id="	30224	110	">	The ship is gone! finally! The Great Reef Nebula isn't cloistering itself anymore behind the weird radiaiton!	</t>
                            <t id="	30224	111	">	Well done, Assistant!	</t>
                            -->
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"  value="Unlock_Achievement_Great_Reef_Nebula"/>
                    </cue>
                    <cue name="Unlock_Achievement_Great_Reef_Nebula">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <unlock_achievement name="COH_PLOT_TF_2" comment="A Glimpse of Home"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch4_Setup_Yaki_Location">
              <conditions>
                <event_cue_completed cue="Ch4_Setup_MissionShip"/>
              </conditions>
              <actions>
                <!-- TODO place in NON_Hazardous area ! -->
                <set_value name="$inHazardous" exact="true"/>
                <set_value name="$inHazardousLoopCounter" exact="0"/>

                <do_while value="$inHazardous">
                  <set_value name="$inHazardousLoopCounter" exact="1" operation="add"/>
                  <set_value name="$randomZ" min="260km" max="280km"/>
                  <get_safe_pos result="$safePos" value="position.[$BettyShip.position.x, $BettyShip.position.y + 42km, $BettyShip.position.z - $randomZ]" sector="$TheVoid"/>
                  <do_if value="not $TheVoid.hashazardousregionat.{$safePos}">
                    <set_value name="$inHazardous" exact="false"/>
                  </do_if>
                  <do_if value="$inHazardousLoopCounter gt 1000">
                    <break/>
                  </do_if>
                </do_while>
                <do_if value="$inHazardousLoopCounter gt 1">
                  <debug_text text="'Attempts to find a YakiBeaconPos outside of Bettyrange 101km and in non-hazardous space ' + $inHazardousLoopCounter" chance="$DebugChance"/>
                </do_if>
                <do_if value="$inHazardous">
                  <debug_text text="'@Heinrich: Yaki beacon is in hazardous zone and should not be.'"/>
                </do_if>
                <debug_text text="'yaki beacon distance to betty: ' + $BettyShip.distanceto.{$safePos}"/>


                <do_if value="md.PlacedObjects.Place_DataVaults.$TorusVaults.count">
                  <set_value name="$YakiBeacon" exact="md.PlacedObjects.Place_DataVaults.$TorusVaults.{1}"/>
                  <set_value name="$TorusDataVaultBeacon"/>
                </do_if>
                <do_else>
                  <create_object name="$YakiBeacon" macro="macro.eq_arg_satellite_02_macro" owner="faction.ownerless" sector="$TheVoid">
                    <position object="$TheVoid" space="$TheVoid" value="$safePos"/>
                  </create_object>
                  <!--<set_object_name object="$YakiBeacon" page="30224" line="203" comment="Communication Relay Orbiter"/>-->
                  <set_object_radar_visible object="$YakiBeacon" visible="false"/>
                  <!--<set_object_min_hull object="$YakiBeacon" exact="100" comment="indestructible"/>-->
                  <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                    <param name="Object" value="$YakiBeacon"/>
                    <param name="RequesterCue" value="namespace"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>
                </do_else>

                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" text="{30224,153}" object="$YakiBeacon" updatebriefing="true" comment="Object Known"/>
              </actions>
              <cues>
                <cue name="Ch4_PlayerReachedLocation_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="player.entity"/>
                  <param name="ApproachTarget"    value="$YakiBeacon"/>
                  <param name="ApproachDistance"  value="20km"/>
                  <param name="SuccessSignalCue"  value="Ch4_1_Meet_Yaki"/>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_1_Meet_Yaki">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch4_1_Meet_Yaki_Speech" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$YakiScientistActor, $BosoTa]"/>
                  <param name="CutsceneKey"       value="[$YakiScientistActorCutsceneKey, $BosoCutsceneKey]"/>
                  <param name="Lines"             value="[[[30224401], [30224402], [30224403], [30224410, 1s, Ch4_2_Scan_Beacons], [30224404, 1.2s], [30224405], [30224406], [30224407], [30224408], [30224409]],
                                                         [[30224401], [30224402]]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="[Ch4_2_Update_Beacon_Objective, Ch4_1_Meet_Yaki_Speech_Completed]"/>
                  <!--
                    <t id="30224401">Oh, welcome!</t>
                    <t id="30224402">You must be the new assistant.</t>
                    <t id="30224403">Let us put you right to work!</t>
                    <t id="30224410">Take notice of the locational information I transmit to you.</t>   
                    <t id="30224404">My other assistant, going forward your colleague of sorts, is currently testing a new alloy composition with magnetic shielding which should protect her from the hazardous zone she is currently in.</t>
                    <t id="30224405">However, she seems to have trouble with other board systems and was not able to escape the caustic cloud yet.</t>
                    <t id="30224406">Apparently the radiation messes with the navigation or the engine which had to be downgraded for this purpose, otherwise she would have simply left in any direction.</t>
                    <t id="30224407">Do not worry, her supplies are quite sufficient to hold out for quite some time.</t>
                    <t id="30224408">If she complied with her task, she should have left navigational beacons around the hazardous zone before conducting this experiment.</t>
                    <t id="30224409">Find them to find out what frequencies she is monitoring in order to establish contact.</t>
                     
                      <t id="30224401">A rescue mission! I can barely contain my excitement!</t>
                      <t id="30224402">We should hurry to save the research findings and the assistant(female assistant) from their unfortunate position!</t>
                      <t id="30224403">I am also very intrigued by the electromagnetic resistance our new friend incorporated into the ship.</t>
                      <t id="30224404">I do wonder if the polarisation is...(fading into mumbling, e.g. "accounting for shielding the electronic components against the radiation...")</t>

                  -->
                </cue>

                <cue name="Ch4_1_Meet_Yaki_Speech_Completed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <update_mission cue="$MissionCue" description="{30224,4003}"/>
                    <signal_cue cue="Ch4_2_Update_Beacon_Objective"/>
                    <!--<signal_cue cue="Ch4_1_Dal"/>-->
                  </actions>
                </cue>

                <cue name="Ch4_1_Dal">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="$DalBusta?"/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_1_Dal_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30224401], [30224402]]" comment="x"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--<t id="	30224	401	">	Yeah, we all wonder about that.	</t>
                          <t id="	30224	402	">	Let's go rescue the assistant.(female assistant)	</t>-->
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch4_2_Scan_Beacons" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Ch4_Setup_Align_ResearchShip" check="false"/>

                <set_value name="$ObjectiveObject" exact="$YakiBeacon"/>
                <set_value name="$ObjectiveRadius" exact="100km"/>

                <!-- Find safe positions close to $BettyShip which are not in hazardous zones-->
                <create_list name="$BeaconPositions"/>
                <set_value name="$LoopCounter" exact="0"/>

                <set_value name="$MaxBeaconsToScan" exact="3" comment="Only 3 out of the 5 need to be scanned"/>

                <do_while value="$BeaconPositions.count lt 5">

                  <!-- Break Condition -->
                  <set_value name="$LoopCounter" exact="1" operation="add"/>
                  <do_if value="$LoopCounter ge 1000">
                    <assert value="false" text="'Failed to fill $BeaconPositions [Heinrich]'"/>
                    <break/>
                  </do_if>

                  <!-- Find Non-Hazardous Safe Pos -->
                  <get_safe_pos result="$pos" max="50km" object="$BettyShip" sector="$TheVoid" space="$TheVoid" comment="Position relative to Sector"/>
                  <do_if value="not $TheVoid.hashazardousregionat.{$pos}">
                    <append_to_list name="$BeaconPositions" exact="$pos"/>
                  </do_if>

                </do_while>

                <set_value name="$BeaconFaction"          exact="faction.ownerless"/>
                <set_value name="$BeaconFactionHostile"   exact="faction.criminal"/>
                <set_value name="$BeaconSector"   exact="$TheVoid"/>
                <set_value name="$BeaconMacros"   exact="[macro.env_deco_nav_beacon_t1_mission_macro, 
                                                          macro.env_deco_nav_beacon_t2_mission_macro, 
                                                          macro.env_deco_nav_beacon_t3_mission_macro, 
                                                          macro.env_deco_nav_beacon_t4_mission_macro, 
                                                          macro.env_deco_nav_beacon_t5_mission_macro]"/>

                <create_group groupname="$DerelictBeaconGroup"/>
                <set_value name="$BeaconScanRange" comment="Save Beacon to process scan range"/>

                <set_value name="$DerelictBeaconDefenseTable" exact="table[]"/>
                <create_group groupname="$DerelictBeaconMines"/>

                <set_value name="$HostilityChance" exact="0" comment="will be set after finding the first set"/>

                <do_all exact="$BeaconPositions.count" counter="$i">

                  <create_object name="$DerelictBeacon" macro="$BeaconMacros.random" owner="$BeaconFaction" sector="$BeaconSector">
                    <position value="$BeaconPositions.{$i}" object="$BeaconSector" comment="get_safe_pos returned coordinates relative to the sector"/>
                  </create_object>
                  <add_to_group groupname="$DerelictBeaconGroup" object="$DerelictBeacon"/>
                  <set_object_radar_visible object="$DerelictBeacon" visible="false"/>
                  <!--<set_object_min_hull object="$DerelictBeacon" exact="100" comment="indestructible"/>-->
                  <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                    <param name="Object" value="$DerelictBeacon"/>
                    <param name="RequesterCue" value="namespace"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>

                  <!-- reserve a table (with a group of mines and lasers) for each beacon. Additionally contains a bool to see if 'player nearby' was triggered-->
                  <set_value name="$DerelictBeaconDefenseTable.{$DerelictBeacon}" exact="table[$lasers = [], $mines = [], $setVisible = false, $setHostileAttempt = false]"/>

                  <!-- lasertowers -->
                  <do_all exact="[2,3,4].random">
                    <create_ship name="$LasersBeacon" macro="[macro.ship_gen_s_lasertower_01_a_macro, macro.ship_gen_xs_lasertower_01_a_macro].random" zone="$DerelictBeacon.zone">
                      <pilot>
                        <select race="race.drone"/>
                      </pilot>
                      <owner exact="$BeaconFaction"/>
                      <safepos object="$DerelictBeacon" min="100m" max="500m"/>
                    </create_ship>
                    <add_to_group groupname="$DerelictBeaconDefenseTable.{$DerelictBeacon}.$lasers" object="$LasersBeacon"/>
                    <add_to_group groupname="$BeaconLasertowers" object="$LasersBeacon"/>
                    <set_object_radar_visible object="$LasersBeacon" visible="false"/>
                  </do_all>
                  <!-- mines -->
                  <do_all exact="[2,4,6].random">
                    <create_object name="$MinesBeacon" macro="[macro.weapon_gen_mine_03_macro].random" owner="$BeaconFaction" zone="$DerelictBeacon.zone">
                      <safepos object="$DerelictBeacon" min="250m" max="750m"/>
                    </create_object>
                    <set_object_relation_behaviour object="$MinesBeacon" disable="true" />
                    <add_to_group groupname="$DerelictBeaconDefenseTable.{$DerelictBeacon}.$mines" object="$MinesBeacon"/>
                    <add_to_group groupname="$DerelictBeaconMines" object="$MinesBeacon"/>
                    <set_object_radar_visible object="$MinesBeacon" visible="false"/>
                  </do_all>
                  <!-- satellites -->
                  <!--<create_object name="$SatellitesBeacon" macro="[macro.eq_arg_satellite_01_macro].random" owner="$BeaconFaction" zone="$DerelictBeacon.zone">
                    <safepos object="$DerelictBeacon" min="5m" max="25m"/>
                  </create_object>
                  <add_to_group groupname="$DerelictBeaconDefenseTable.{$DerelictBeacon}.$satellites" object="$SatellitesBeacon"/>
                  <add_to_group groupname="$DerelictBeaconSatellites" object="$SatellitesBeacon"/>
                  <set_object_radar_visible object="$SatellitesBeacon" visible="false"/>-->

                </do_all>

              </actions>
              <patch sinceversion="2">
                <set_value name="$BeaconFactionHostile"   exact="faction.criminal"/>
              </patch>
              <cues>

                <cue name="Ch4_2_Init_Objective">
                  <actions>
                    <signal_cue cue="Ch4_2_Update_Beacon_Objective"/>
                  </actions>
                </cue>

                <cue name="Ch4_2_Update_Beacon_Objective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="not $BettyFound?" comment="don't overwrite objective, if we already found the ship"/>
                  </conditions>
                  <actions>
                    <do_if value="$ObjectiveObject == $BettyShip" comment="all beacons investigated">
                      <cancel_cue cue="Ch4_2_Beacon_Distance_Check"/>
                      <signal_cue cue="Ch4_3_Place_Satellites"/>
                    </do_if>
                    <do_else comment="more beacons remaining">

                      <!-- Set the $radius as distance from $BettyShip to the furthest Beacon -->
                      <set_value name="$radius" exact="20km"/>
                      <do_for_each in="$DerelictBeaconGroup" name="$b">
                        <do_if value="$b.distanceto.{$BettyShip} gt $radius">
                          <set_value name="$radius" exact="$b.distanceto.{$BettyShip} + 10km"/>
                        </do_if>
                      </do_for_each>
                      <debug_text text="'Beacon Search Radius Set to: ' + $radius" chance="$DebugChance"/>

                      <create_position name="$DistractionLocation" object="$BettyShip" space="$BettyShip.sector"/>
                      <do_if value="Ch4_1_Meet_Yaki_Speech_Completed.state == cuestate.waiting">
                        <set_objective cue="$MissionCue" action="objective.flyto" offset="$DistractionLocation" object="$BettyShip.sector" radius="$radius" silent="true">
                          <progress progress="$BeaconPositions.count - $DerelictBeaconGroup.count" max="$MaxBeaconsToScan"/>
                        </set_objective>
                      </do_if>
                      <do_else>
                        <set_objective cue="$MissionCue" action="objective.find" offset="$DistractionLocation" object="$BettyShip.sector" radius="$radius" text="{30224,4053}" silent="true">
                          <progress progress="$BeaconPositions.count - $DerelictBeaconGroup.count" max="$MaxBeaconsToScan"/>
                        </set_objective>
                      </do_else>
                      <signal_cue cue="Ch4_LRS_Hint_Check" check="false"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch4_LRS_Hint_Check">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_LRS_Hint_Check_PlayerReachedLocation_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                      <param name="ApproachSector"    value="$TheVoid"/>
                      <param name="ApproachOffset"    value="$DistractionLocation"/>
                      <param name="ApproachDistance"  value="$radius * 1.1"/>
                      <param name="SuccessSignalCue"  value="Ch4_Hint_Use_LRS"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_2_Beacon_Distance_Check" checkinterval="0.5s" instantiate="true">
                  <actions>
                    <do_if value="player.entity.sector == $BeaconSector">

                      <!-- Loop over all Beacons -->
                      <do_all exact="$DerelictBeaconGroup.count" counter="$i">
                        <set_value name="this.$BeaconNear" exact="$DerelictBeaconGroup.{$i}"/>
                        <do_if value="(this.$BeaconNear != null)">

                          <!-- Beacon Nearby: Set Beacon, Laser Tower and Mines Visible -->
                          <do_if value="(player.entity.distanceto.{this.$BeaconNear} lt 7km)">
                            <do_if value="(not $DerelictBeaconDefenseTable.{this.$BeaconNear}.$setVisible)">
                              <set_object_radar_visible object="this.$BeaconNear" visible="true"/>
                              <set_value name="this.$lasers" exact="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$lasers"/>
                              <do_all exact="this.$lasers.count" counter="$i">
                                <set_object_radar_visible object="this.$lasers.{$i}" visible="true"/>
                              </do_all>
                              <set_value name="this.$mines" exact="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$mines"/>
                              <do_all exact="this.$mines.count" counter="$i">
                                <set_object_radar_visible object="this.$mines.{$i}" visible="true"/>
                              </do_all>
                              <!--<set_object_radar_visible object="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$satellites.{1}" visible="true"/>-->
                              <set_value name="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$setVisible" exact="true"/>
                              <do_if value="Ch4_Hint_Yaki_First_Beacon_Found.state == cuestate.waiting">
                                <set_value name="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$setHostileAttempt" exact="true" comment="First Batch will not be hostile"/>
                                <set_value name="$HostilityChance" exact="100"/>
                                <signal_cue cue="Ch4_Hint_Yaki_First_Beacon_Found" check="false" comment="Only on the first occasion"/>
                              </do_if>
                            </do_if>
                          </do_if>
                          <do_else>
                            <continue/>
                          </do_else>

                          <!-- Beacon Nearby: one-time chance to get a relation-drop (lasertower becomes enemy) -->
                          <do_if value="(player.entity.distanceto.{this.$BeaconNear} lt 1km)">
                            <do_if value="not $Ch4_Hint_Yaki_Beacon_Find_Wreck_Active?">

                              <remove_value name="$PlayerShipWeaponsActive"/>
                              <do_for_each in="player.ship.weapons.operational.list" name="$weapon">
                                <do_if value="$weapon.isactive">
                                  <set_value name="$PlayerShipWeaponsActive"/>
                                  <break/>
                                </do_if>
                              </do_for_each>
                              <do_if value="$PlayerShipWeaponsActive? and (not $DerelictBeaconDefenseTable.{this.$BeaconNear}.$setHostileAttempt)">
                                <set_value name="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$setHostileAttempt" exact="true"/>
                                <set_value name="this.$lasers"  exact="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$lasers"/>
                                <set_value name="this.$mines"   exact="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$mines"/>

                                <set_value name="$Hostile" exact="false"/>
                                <set_value name="$Hostile" exact="true" chance="$HostilityChance"/>

                                <do_if value="$Hostile">
                                  <signal_cue cue="Ch4_Hint_Yaki_Beacon_Random_Activation" check="false"/>
                                  <do_all exact="this.$lasers.count" counter="$i">
                                    <set_relation_boost object="this.$lasers.{$i}" value="-1" faction="faction.player" silent="true" decay="0"/>
                                    <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                                      <param name="Ship" value="this.$lasers.{$i}"/>
                                      <param name="Faction" value="$BeaconFactionHostile"/>
                                    </run_actions>
                                    <create_order id="'Attack'" object="this.$lasers.{$i}" immediate="true">
                                      <param name="primarytarget" value="player.ship"/>
                                      <param name="checkrelation" value="false"/>
                                    </create_order>
                                  </do_all>
                                  <do_all exact="this.$mines.count" counter="$i">
                                    <add_to_group groupname="$HostileMines" object="this.$mines.{$i}"/>
                                    <set_object_foe_list object="this.$mines.{$i}" factions="[faction.player]"/>
                                    <set_owner object="this.$mines.{$i}" faction="$BeaconFactionHostile"/>
                                    <!--<set_relation_boost object="this.$mines.{$i}" value="-1" faction="faction.player" silent="true" decay="0"/>-->
                                  </do_all>
                                </do_if>
                              </do_if>
                            </do_if>
                          </do_if>
                          <do_else>
                            <continue/>
                          </do_else>

                          <!-- Beacon Nearby: Scanning Progress -->
                          <set_value name="$BeaconScanRange_MaxDistance" exact="750m"/>
                          <do_if value="(player.entity.distanceto.{this.$BeaconNear} lt $BeaconScanRange_MaxDistance)">
                            <set_value name="this.$BeaconScanRangeOld" exact="$BeaconScanRange"/>
                            <set_value name="$BeaconScanRange" exact="this.$BeaconNear"/>


                            <!-- New Beacon in Range -->
                            <do_if value="(this.$BeaconScanRangeOld == null) and ($BeaconScanRange != null)" comment="new beacon in rage">
                              <set_value name="$BeaconTimer" exact="player.age"/>
                            </do_if>
                            <!-- Beacon Remains in Range-->
                            <do_elseif value="(this.$BeaconScanRangeOld == $BeaconScanRange) and ($BeaconScanRange != null)" comment="beacon remains in range">

                              <set_objective cue="$MissionCue" action="objective.wait" text="{30224,4051}" object="$BeaconScanRange" radius="$BeaconScanRange_MaxDistance" silent="true">
                                <progress progress="(player.age - $BeaconTimer)i" max="(30s)i"/>
                              </set_objective>
                              <do_if value="(player.age - $BeaconTimer) gt 30s">

                                <!--<do_if value="not $BeaconScanned?">
                                <set_value name="$BeaconScanned" exact="true"/>
                                <signal_cue cue="Ch4_Duke_PlayerNearBeacon_Boso_Dialog"/>
                              </do_if>-->

                                <!--<set_owner object="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$satellites.{1}" faction="faction.player"/>-->
                                <!--<set_owner object="$BeaconScanRange" faction="faction.player"/>-->
                                <remove_from_group group="$DerelictBeaconGroup" object="$BeaconScanRange"/>
                                <do_if value="$DerelictBeaconGroup.count le 3">
                                  <signal_cue cue="Ch4_Create_Wreckages" check="false"/>
                                </do_if>
                                <!--<set_object_min_hull object="$BeaconScanRange" exact="0" comment="destructible"/>-->
                                <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                                  <param name="Object" value="$BeaconScanRange"/>
                                  <param name="RequesterCue" value="namespace"/>
                                  <param name="DebugChance" value="$DebugChance"/>
                                </run_actions>
                                <create_position name="$BeaconScanRangePosition" object="$BeaconScanRange" space="$BeaconScanRange.sector"/>
                                <set_value name="$BeaconSector" exact="$BeaconScanRange.sector"/>
                                <destroy_object object="$BeaconScanRange" explosion="false"/>
                                <create_object name="$BeaconCollectable" macro="macro.env_deco_nav_beacon_t1_macro" owner="faction.player" sector="$BeaconSector">
                                  <position object="$BeaconSector" space="$BeaconSector" value="$BeaconScanRangePosition"/>
                                </create_object>

                                <signal_cue cue="Ch4_2_Update_Beacon_Objective"/>
                                <do_if value="($BeaconPositions.count - $DerelictBeaconGroup.count) ge $MaxBeaconsToScan" comment="point to exact location">
                                  <set_value name="$ObjectiveRadius" exact="0"/>
                                  <set_value name="$ObjectiveObject" exact="$BettyShip"/>
                                </do_if>
                                <do_else>
                                  <set_value name="$ObjectiveRadius" exact="$ObjectiveRadius / $BeaconPositions.count" operation="subtract"/>
                                </do_else>
                              </do_if>

                            </do_elseif>
                            <!-- Beacon Left Range (Or was Scanned) -->
                            <do_else>
                              <set_value name="$BeaconTimer" exact="0"/>
                              <signal_cue cue="Ch4_2_Update_Beacon_Objective"/>
                            </do_else>

                            <break comment="Progress on only 1 beacon at a time (even if due to chance multiple are in range)"/>
                          </do_if>
                          <do_else>
                            <set_value name="$BeaconScanRange" exact="null"/>
                            <continue/>
                          </do_else>

                        </do_if>
                      </do_all>

                    </do_if>
                  </actions>
                </cue>

                <!-- TODO: Cleanup Objects -->

                <cue name="Ch4_Hint_Use_LRS">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Hint_Use_LRS_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224451]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--451 Use your Long Range Scan to locate the Nav Beacons, but be careful to stay clear of the hazarous region.
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Hint_Yaki_First_Beacon_Found">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Hint_Yaki_First_Beacon_Found_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224411], [30224412], [30224413], [30224414], [30224415]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--
                      <t id="30224411">It seems your colleague was exceptionally cautious and I advise you to be the same.</t>
                      <t id="30224412">She installed protective measures to deter meddling Terrans and other criminals.</t>
                      <t id="30224413">As long as you appear non-threatening no harm should befall your mechanical nor your biological vessel.</t>
                      <t id="30224414">If you lack Nav Beacons and find such, you better pick them up.</t>
                      <t id="30224415">We will need them later to establish a link to your colleague.</t> 
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Hint_Yaki_Beacon_Random_Activation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Hint_Yaki_Beacon_Random_Activation_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224416], [30224417], [30224418], [30224419], [30224420]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--
                      <t id="	30224	416	">	Appear non-threatening I said!	</t>
                      <t id="30224417">*** Sigh of Disappointment ***</t>
                      <t id="30224418">It can not be helped.</t>
                      <t id="30224419">Deal with the counter measures evasively or violently as you see fit.</t>
                      <t id="30224420">I will bill our Segarian contractee with the equipment cost.</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Hint_Yaki_Hurry_Up_Timeout">
                  <delay exact="45min"/>
                  <actions>
                    <signal_cue cue="Ch4_Hint_Yaki_Hurry_Up_Meet"/>
                  </actions>
                </cue>

                <cue name="Ch4_Hint_Yaki_Hurry_Up_Meet">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="not $YakiScientistSaid.indexof.{'BettyMeetupDone'}"/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Hint_Yaki_Hurry_Up_Meet_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224429], [30224430]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--
                      <t id="	30224429	">	Hurry up, assistant!	</t>
                      <t id="	30224	430	">	The earlier you two meet up, the earlier you can get to the next task.	</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Create_Wreckages" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Create Wreckage on the other 3 locations for the player to find, delete it on the other 2 once it's found -->
                    <create_list name="$Wreckages"/>
                    <do_for_each in="$DerelictBeaconGroup" name="$beacon">
                      <create_object name="$Wreckage" macro="macro.env_debris_debris_m_07_macro" owner="$BeaconFaction" zone="$beacon.zone">
                        <safepos object="$beacon" min="30m" max="100m"/>
                      </create_object>
                      <set_wreck_persistence object="$Wreckage" persistent="true"/>
                      <!--<set_object_min_hull object="$Wreckage" exact="1"/>-->
                      <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                        <param name="Object" value="$Wreckage"/>
                        <param name="RequesterCue" value="namespace"/>
                        <param name="DebugChance" value="$DebugChance"/>
                      </run_actions>
                      <append_to_list name="$Wreckages" exact="$Wreckage"/>
                    </do_for_each>
                    <set_value name="$Ch4_Hint_Yaki_Beacon_Find_Wreck_Active"/>
                    <signal_cue cue="Ch4_Approach_Wreck_Handlers"/>
                  </actions>
                  <patch sinceversion="2" state="cancelled">
                    <do_for_each in="$Wreckages" name="$w">
                      <do_if value="$w.exists">
                        <set_wreck_persistence object="$w" persistent="true"/>
                      </do_if>
                    </do_for_each>
                  </patch>
                </cue>

                <cue name="Ch4_Approach_Wreck_Handlers">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$WreckageApproachDistance" exact="850m"/>
                  </actions>
                  <cues>
                    <cue name="Ch5_Wreck_01_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$Wreckages.{1}"/>
                      <param name="ApproachDistance"  value="$WreckageApproachDistance"/>
                      <param name="SuccessSignalCue"  value="Ch4_Hint_Yaki_Beacon_Find_Wreck"/>
                    </cue>
                    <cue name="Ch5_Wreck_02_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$Wreckages.{2}"/>
                      <param name="ApproachDistance"  value="$WreckageApproachDistance"/>
                      <param name="SuccessSignalCue"  value="Ch4_Hint_Yaki_Beacon_Find_Wreck"/>
                    </cue>
                    <cue name="Ch5_Wreck_03_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$Wreckages.{3}"/>
                      <param name="ApproachDistance"  value="$WreckageApproachDistance"/>
                      <param name="SuccessSignalCue"  value="Ch4_Hint_Yaki_Beacon_Find_Wreck"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Hint_Yaki_Beacon_Find_Wreck">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_for_each in="$Wreckages" name="$wreck">
                      <do_if value="$wreck != event.param" comment="param from LIB_Generic.ApproachObject_Handler SuccessSignalCue">
                        <!-- Remove from invincibility handling -->
                        <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                          <param name="Object" value="$wreck"/>
                          <param name="RequesterCue" value="namespace"/>
                          <param name="DebugChance" value="$DebugChance"/>
                        </run_actions>
                        <destroy_object object="$wreck" explosion="false"/>
                      </do_if>
                    </do_for_each>
                  </actions>
                  <cues>
                    <cue name="Ch4_Hint_Yaki_Beacon_Find_Wreck_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224421], [30224422], [30224423], [30224424]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch4_Hint_Yaki_Beacon_Find_Wreck_Ref_End"/>
                      <!--
                      <t id="30224421">This wreckage before you is what is left of your predecessor's ship(male predecessor).</t>
                      <t id="30224422">As you can see, he was not proficient enough to navigate this dangerous space.</t>
                      <t id="30224423">Needless to say he was relieved of his duties after that incident, and sent to join a maintenance crew.</t>
                      <t id="30224424">Let this be a cautionary tale to you, assistant, for you will need to avoid his mistakes if you do not wish to share his fate.</t>
                      -->
                    </cue>
                    <cue name="Ch4_Hint_Yaki_Beacon_Find_Wreck_Ref_End">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_value name="$Ch4_Hint_Yaki_Beacon_Find_Wreck_Active"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_NavBeacons_CleanUp">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_for_each in="$DerelictBeaconGroup" name="$Beacon">
                      <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                        <param name="Object" value="$Beacon"/>
                        <param name="RequesterCue" value="namespace"/>
                        <param name="DebugChance" value="$DebugChance"/>
                      </run_actions>
                    </do_for_each>

                    <do_if value="not $TorusDataVaultBeacon?">
                      <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                        <param name="Object" value="$YakiBeacon"/>
                        <param name="RequesterCue" value="namespace"/>
                        <param name="DebugChance" value="$DebugChance"/>
                      </run_actions>
                      <destroy_object object="$YakiBeacon" explosion="true"/>
                    </do_if>
                    <destroy_group group="$DerelictBeaconGroup" explosion="true"/>
                    <destroy_group group="$BeaconLasertowers" explosion="true"/>
                    <destroy_group group="$DerelictBeaconMines" explosion="true"/>
                  </actions>
                </cue>

                <cue name="Ch4_NavBeacons_Visible_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_for_each in="$DerelictBeaconGroup" name="$b">
                      <set_object_radar_visible object="$b" visible="true"/>
                    </do_for_each>
                  </actions>
                </cue>

                <cue name="Ch4_NavBeacons_Find_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.investigate" text="'NavBeacon-group'" group="$DerelictBeaconGroup"/>
                  </actions>
                </cue>
                <cue name="Ch4_Lasertowers_Find_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.investigate" text="'Lasertowers-group'" group="$BeaconLasertowers"/>
                  </actions>
                </cue>
                <cue name="Ch4_Mines_Find_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.investigate" text="'Mines-group'" group="$DerelictBeaconMines"/>
                  </actions>
                </cue>
              </cues>
            </cue>


            <cue name="Ch4_Found_Betty_Prematurely">
              <conditions>
                <event_cue_signalled cue="Ch4_2_Scan_Beacons"/>
              </conditions>
              <cues>
                <cue name="Ch4_Found_Betty_Prematurely_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="player.entity"/>
                  <param name="ApproachTarget"    value="$BettyShip"/>
                  <param name="ApproachDistance"  value="7km"/>
                  <param name="SuccessSignalCue"  value="Ch4_Hint_Found_Betty_Prematurely"/>
                </cue>

                <cue name="Ch4_Hint_Found_Betty_Prematurely">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="Ch4_3_Place_Satellites.state == cuestate.waiting"/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Hint_Found_Betty_Prematurely_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224694], [30224695]]" comment="x"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--<t id="	30224694	">	You found your colleague!(female colleague) However, believe it or not but she won't be able to see you.	</t>
                     <t id="	30224695	">	We will need to find her Nav Beacons to find out which frequencies she is monitoring before we can help her escape this unfortunate situation.	</t>-->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>


            <cue name="Ch4_3_Place_Satellites">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>

                <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.await" text="{30220,3014}" comment="(objective.await)Further Instructions from Paranid Story Page 30220" updatebriefing="true"/>
                <!-- TODO Use proper satellite Range - .maxradarrange -->

                <set_value name="$CurrentBettyTarget" exact="null"/>


                <find_object groupname="$SatellitesInArea" deployablecategory="deployablecategory.navbeacon" multiple="true" space="$TheVoid" owner="faction.player">
                  <!--<match_distance object="$BettyShip" max="$BettyShip.maxradarrange"/>-->
                </find_object>

              </actions>
              <cues>

                <cue name="Ch4_Player_Add_Satellites" instantiate="true">
                  <conditions>
                    <!--<event_satellite_launched space="$TheVoid"/>-->
                    <event_navbeacon_launched space="$TheVoid"/>
                  </conditions>
                  <actions>
                    <add_to_group groupname="$SatellitesInArea" object="event.param2"/>
                  </actions>
                </cue>

                <cue name="Ch4_Hint_Yaki_StayClear_Of_Lasertowers" checkinterval="5s">
                  <conditions>
                    <!--macro.-->
                    <count_ships result="$Hostiles_In_Range" owner="$BeaconFactionHostile" space="player.sector" exact="0" masstraffic="false" checkoperational="true"  macro="[macro.ship_gen_s_lasertower_01_a_macro, macro.ship_gen_xs_lasertower_01_a_macro]">
                      <match_distance max="5km" object="player.entity"/>
                    </count_ships>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch4_Hint_Yaki_Satellite_Explanation"/>
                  </actions>
                </cue>

                <cue name="Ch4_Hint_Yaki_Satellite_Explanation">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="$BettyShip.isinhazardousregion"/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Hint_Yaki_Satellite_Explanation_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224425], [30224426], [30224427], [30224428]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch4_Deploy_Objective"/>
                      <!--
                      <t id="30224425">Very well, we know now what frequency she is looking for to find her way out.</t>
                      <t id="30224426">It would be nice if you could send a couple of calibrated satellites her way which she will use as fix points to navigate out of this caustic cloud.</t>
                      <t id="30224427">Push a satellite into the hazardous area and your colleague should be able to receive the signal.</t>
                      <t id="30224428">Be wary that your satellites will probably suffer corrosion themselves, so it might take a few attempts.</t>
                      -->
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch4_Deploy_Objective">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="$BettyShip.isinhazardousregion"/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.deploy" text="{30224,4052}" object="$BettyShip" radius="100km" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch4_Satellites_Distance_Check" checkinterval="1s" instantiate="true">
                  <actions>
                    <do_if value="not $BettyShip.isinhazardousregion">
                      <cancel_cue cue="Ch4_Satellites_Distance_Check"/>
                      <signal_cue cue="Ch4_Betty_Out_Of_Hazard_Zone" check="false"/>
                      <set_value name="$Ch4_BettyLeftHazardousRegion"/>
                    </do_if>
                    <do_else>
                      <do_for_each in="$SatellitesInArea" name="$CurrentSatellite">

                        <!--<do_if value="$BettyShip.distanceto.{$CurrentSatellite} gt $BettyShip.maxradarrange">
                          <continue comment="Skip Satellites out of range"/>
                        </do_if>
                        No player indication of betty range...
                        -->
                        <do_if value="not $CurrentSatellite.exists">
                          <remove_from_group object="$CurrentSatellite" group="$SatellitesInArea"/>
                          <do_if value="$CurrentBettyTarget == $CurrentSatellite">
                            <set_value name="$CurrentBettyTarget" exact="null"/>
                          </do_if>
                          <continue comment="Skip destroyed Satellites"/>
                        </do_if>
                        <do_if value="not $CurrentSatellite.isactive">
                          <do_if value="$CurrentBettyTarget == $CurrentSatellite">
                            <set_value name="$CurrentBettyTarget" exact="null"/>
                          </do_if>
                          <continue comment="Skip deativated Satellites"/>
                        </do_if>

                        <create_position name="$pos" object="$CurrentSatellite" space="$CurrentSatellite.sector"/>
                        <do_if value="not $TheVoid.hashazardousregionat.{$pos}">
                          <do_if value="$CurrentBettyTarget == $CurrentSatellite">
                            <set_value name="$CurrentBettyTarget" exact="null"/>
                          </do_if>
                          <continue comment="Skip Satellites which are not in the hazardous region"/>
                        </do_if>

                        <!-- Satellites which exist, are active & in the hazardous region as requested: -->
                        <add_effect object="$CurrentSatellite" effect="'signal_leak_discharge_effect'"/>
                        <set_object_hull object="$CurrentSatellite" exact="[($CurrentSatellite.hullpercentage - 2), 0].max"/>
                        <!-- 50s -->

                        <!-- Destroy Satellites -->
                        <do_if value="$CurrentSatellite.hullpercentage le 0">

                          <do_if value="$CurrentBettyTarget == $CurrentSatellite">
                            <!-- Target Lost - Stop Betty Movement -->
                            <set_value name="$CurrentBettyTarget" exact="null"/>
                            <cancel_all_orders object="$BettyShip"/>
                            <set_object_radar_visible object="$BettyShip" visible="false"/>

                            <signal_cue cue="Ch4_Hint_Betty_Satellite_Lost"/>
                            <continue/>
                          </do_if>

                          <destroy_object object="$CurrentSatellite" comment="also removes from group" explosion="true"/>
                          <remove_from_group object="$CurrentSatellite" group="$SatellitesInArea"/>
                        </do_if>

                        <!-- Acquire Target in Hazardous Region & Start Betty Movement towards it -->
                        <do_if value="(not $CurrentBettyTarget.exists) and $CurrentSatellite.exists">
                          <set_value name="$CurrentBettyTarget" exact="$CurrentSatellite"/>

                          <signal_cue cue="Ch4_Hint_Betty_Satellite_Found"/>

                          <cancel_all_orders object="$BettyShip"/>


                          <!-- Create a position behind $Ch4BettySafePos which is outside the hazardousregion -->
                          <set_value name="$Ch4BettySafePos" exact="null"/>
                          <do_all exact="200" counter="$i">
                            <get_safe_pos result="$safepos" max="$i * 100m" object="$CurrentBettyTarget" sector="$TheVoid" space="$TheVoid" comment="Position relative to sector"/>
                            <do_if value="not $TheVoid.hashazardousregionat.{$safepos}">
                              <set_value name="$Ch4BettySafePos" exact="$safepos"/>
                              <debug_text text="'Found SafePos as BettyShip Target Pos'" chance="$DebugChance"/>
                              <break/>
                            </do_if>
                          </do_all>
                          <do_if value="not $Ch4BettySafePos">
                            <debug_text text="'Did not find SafePos as BettyShip Target Pos'" chance="$DebugChance"/>
                            <create_position name="$Ch4BettySafePos" object="$CurrentBettyTarget" space="$CurrentBettyTarget.sector"/>
                          </do_if>

                          <create_order id="'MoveWait'" object="$BettyShip" immediate="true">
                            <param name="destination" value="[$CurrentBettyTarget.sector, $Ch4BettySafePos]"/>
                            <param name="debugchance" value="$DeepDebugChance"/>
                          </create_order>
                          <set_object_radar_visible object="$BettyShip" visible="false"/>
                        </do_if>

                      </do_for_each>
                    </do_else>

                  </actions>
                </cue>

                <cue name="Ch4_Hint_Betty_Satellite_Found" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$RandomLines" exact="[1,2,3].random"/>
                    <do_if value="$RandomLines == 1">
                      <set_value name="$SecondActor"            exact="$YakiScientistActor"/>
                      <set_value name="$SecondActorCutsceneKey" exact="$YakiScientistActorCutsceneKey"/>
                      <set_value name="$SecondActorLines"       exact="[[30224431], [30224435]]"/>
                      <!--
                      <t id="30224431">Very good!</t>
                      <t id="30224432">Well done, assistants!(Plural, addressing both assistants)</t>
                      <t id="30224435">She is able to move out of this radiating zone!</t>
                      -->
                    </do_if>
                    <do_elseif value="$RandomLines == 2">
                      <set_value name="$SecondActor"            exact="$YakiScientistActor"/>
                      <set_value name="$SecondActorCutsceneKey" exact="$YakiScientistActorCutsceneKey"/>
                      <set_value name="$SecondActorLines"       exact="[[30224432]]"/>
                      <!--
                      <t id="30224431">Very good!</t>
                      <t id="30224432">Well done, assistants!(Plural, addressing both assistants)</t>
                      <t id="30224435">She is able to move out of this radiating zone!</t>
                      -->
                    </do_elseif>
                    <do_else>
                      <set_value name="$SecondActor"            exact="$BosoTa"/>
                      <set_value name="$SecondActorCutsceneKey" exact="$BosoCutsceneKey"/>
                      <set_value name="$SecondActorLines"       exact="[[30224411], [30224410]]"/>
                      <!--    
                      <t id="30224410">Your fellow assistant is using your satellite to navigate out of the hazardeous zone!</t>
                      <t id="30224411">Well done, assistant!</t>
                      -->
                    </do_else>
                  </actions>
                  <cues>
                    <cue name="Ch4_Hint_Betty_Satellite_Found_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224401]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--
                      <t id="30224401">Target Acquired</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Hint_Betty_Satellite_Lost" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Hint_Betty_Satellite_Lost_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224402]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[Ch4_Hint_Yaki_Satellite_Lost, Ch4_Hint_Boso_Satellite_Lost].random"/>
                      <!--
                      <t id="30224402">Target Lost</t>
                      -->
                    </cue>

                    <cue name="Ch4_Hint_Yaki_Satellite_Lost">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Ch4_BettyLeftHazardousRegion?"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Hint_Yaki_Satellite_Lost_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224433],[30224434]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--<t id="	30224433	">	It looks like the Nav Beacon reached the end of it's lifetime.('Nav Beacon' same as {20201,20801})	</t>	no
                              <t id="	30224434	">	To allow your fellow assistant(female assistant) to escape her misfortune you will need to send in another Nav Beacon.('Nav Beacon' same as {20201,20801})	</t>	no
                      -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_Hint_Boso_Satellite_Lost">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Ch4_BettyLeftHazardousRegion?"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Hint_Boso_Satellite_Lost_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30224412],[30224413]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--Boso	<t id="	30224412	">	It appears that the Nav Beacon you sent is decommissioned.	</t>
                              Boso	<t id="	30224413	">	You will need to send in another one for her to find her way out.	</t>
                      -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_Betty_Out_Of_Hazard_Zone">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <append_to_list name="$YakiScientistSaid" exact="'BettyMeetupDone'"/>
                    <set_object_radar_visible object="$BettyShip" visible="true"/>
                    <set_object_hull object="$BettyShip" exact="95"/>
                    <signal_cue cue="Ch4_Repair_Betty"/>
                    <cancel_all_orders object="$BettyShip"/>
                    <create_order id="'Wait'" object="$BettyShip" immediate="true">
                      <param name="noattackresponse" value="true"/>
                      <param name="skipalignment" value="true"/>
                    </create_order>
                  </actions>
                  <cues>
                    <cue name="Ch4_Hint_Yaki_Betty_Out_Of_Hazard_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224438], [30224437], [30224439], [30224446], [30224440]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--
                      x <t id="30224436">Well done!</t>
                      <t id="30224438">This experiment was a thorough success!</t>
                      <t id="30224437">The alloy composition protected the systems inside from any damage!</t>
                      <t id="30224439">The minor navigational issues should not be any problem once you join my assistant as pilot.</t>  
                      <t id="30224446">Once you are ready for adventure, leave your ship somewhere safe and join my other assistant!</t>                    
                      <t id="30224440">The two of you will make a splendiferous expedition team!</t>
                      -->
                    </cue>

                    <cue name="Ch4_Betty_Bumped_Back_Into_Hazard_Zone" checkinterval="10s" instantiate="true">
                      <conditions>
                        <check_value value="$BettyShip.isinhazardousregion"/>
                        <check_value value="$Ch4_BettyLeftHazardousRegion?" comment="Storywise BettyShip left the region already"/>
                      </conditions>
                      <actions>
                        <do_if value="$BettyShip.hullpercentage lt 95">
                          <set_object_hull object="$BettyShip" exact="95"/>
                        </do_if>

                        <cancel_all_orders object="$BettyShip" comment="Don't interrupt the own move order on short intervals"/>
                        <create_order id="'MoveWait'" object="$BettyShip" immediate="true">
                          <param name="destination" value="[$TheVoid, $Ch4BettySafePos]"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>

                        <set_value name="$Ch4_Debug_BettyBumpedBackIntoHazardZone"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Repair_Betty">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Docking Denied -> Repair -> Dock to meet 2nd assistant -->
                <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.dockat" object="$BettyShip" updatebriefing="true"/>
                <update_mission cue="$MissionCue" description="{30224,4004}"/>

              </actions>
              <cues>

                <cue name="Ch4_Player_In_Space_Suit_Init">
                  <actions>
                    <do_if value="@player.controlled.isclass.spacesuit">
                      <signal_cue cue="Ch4_Player_In_Space_Suit"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch4_Mail_Repair_Betty">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <write_incoming_message source="$BettyActor.knownname" highpriority="true"
                                            object="$BettyShip" interaction="guidance"
                                            title="{30224,13001}"
                                             text="{30224,13002}"
                                            comment="Subject: Repair Request">
                      <cutscene key="'OrbitIndefinitely'" param="$BettyShip" />
                    </write_incoming_message>
                  </actions>
                  <delay exact="90s"/>
                  <actions>
                    <set_objective action="objective.repair" object="$BettyShip" cue="$MissionCue" comment="Repair Ship"/>
                  </actions>
                </cue>

                <cue name="Ch4_Player_In_Space_Suit">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <check_all>
                        <event_player_teleport_successful/>
                        <check_value value="@player.controlled.isclass.spacesuit"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Betty_Docking_Denied" instantiate="true">
                      <conditions>
                        <event_object_docking_denied group="global.$PlayerControlledGroup "/>
                        <check_value value="player.controlled.isclass.spacesuit"/>
                      </conditions>
                      <actions>
                        <do_if value="Ch4_Betty_Docking_Attempt.state == cuestate.waiting">
                          <debug_text text="'event_object_Docking_Denied fired'"/>
                          <signal_cue cue="Ch4_Betty_Docking_Attempt" check="false"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch4_Betty_Targetted" instantiate="true" checkinterval="3s">
                      <conditions>
                        <check_value value="player.target == $BettyShip" comment="Needs to be selected to request docking per right click"/>
                        <check_value value="$BettyShip.hullpercentage lt 99"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch4_Betty_Docking_Attempt" check="false"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_Betty_Docking_Attempt">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch4_Mail_Repair_Betty" check="false"/>
                      </actions>
                      <cues>
                        <!-- TODO: Make a different recipient speak or something -->
                        <cue name="Ch4_Betty_Docking_Attempt_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[[30224410,30224410,30224410,30224411].random]]"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch4_Betty_Docking_Attempt_Reset"/>
                          <!-- 
                          <t id="55">Hull damaged.</t>
                          <t id="30224410">\033M{10002,55}(Hull damaged.)</t>
                          <t id="30224411">\033MHu-hull da-damaged.(Broken Computer trying to say 'Hull Damaged')</t>
                          -->
                        </cue>
                        <cue name="Ch4_Betty_Docking_Attempt_Reset">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <debug_text text="'Ch4_Betty_Docking_Attempt Resetter'"/>
                            <reset_cue cue="parent"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Repair_Betty_Event" instantiate="true">
                  <conditions>
                    <event_object_hull_repaired object="$BettyShip"/>
                    <check_value value="event.param.hullpercentage ge 99"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch4_Player_Docked" check="false"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Player_Docked">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_object_docking_enabled object="$BettyShip" enabled="true"/>
                <!--<write_incoming_message source="$BettyActor.knownname" highpriority="true"
                                        title="{30224,13101}"
                                         text="{30224,13102}"
                                        comment="Subject: Access Update Report">
                  <cutscene key="'OrbitIndefinitely'" param="$BettyShip" />
                </write_incoming_message>-->
              </actions>
              <cues>
                <cue name="Ch4_Hint_Betty_Welcome">
                  <conditions>
                    <event_object_changed_object object="player.entity" newobject="$BettyShip"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch4_NavBeacons_CleanUp"/>
                    <signal_cue cue="Ch5_Setup_BettyShip_Behaviour"/>
                  </actions>
                  <delay exact="3s"/>
                  <actions>
                    <signal_cue cue="Ch4_Complete"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30224,4021}" text="{30224,4022}"/>
                <cancel_cue cue="parent"/>
                <signal_cue cue="Ch5_Evade_Patrols"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Ch5_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch5_Terraforming_Intro">
            <cancel_cue cue="Ch1_Intro"/>
          </force>
          <cues>
            <cue name="Ch5_Check_HQ">
              <actions>
                <do_if value="not $HQ?">
                  <signal_cue cue="Debug_Setup_HQ"/>
                </do_if>
                <signal_cue cue="Ch5_Force_Delay"/>
                <signal_cue cue="Ch4_Setup_MissionShip" check="false"/>
                <signal_cue cue="Debug_Arm_Spacesuit"/>
              </actions>
            </cue>
            <cue name="Ch5_Force_Delay">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="10s"/>
              <actions>
                <signal_cue cue="Ch1_Setup_ResearchShip" check="false"/>

                <signal_cue cue="Ch5_Setup_BettyShip_Behaviour"/>
                <set_object_radar_visible object="$BettyShip" visible="true"/>
                <warp object="$BettyShip" sector="$GetsuFune">
                  <safepos value="position.[0,0,0]"/>
                </warp>
                <set_known object="$GetsuFune" known="true"/>
                <teleport_player object="$BettyShip" instant="true" force="true" control="false"/>

              </actions>
              <delay exact="2s"/>
              <actions>
                <set_object_radar_visible object="$ResearchShip" visible="true"/>
                <warp object="$ResearchShip" sector="$Earth">
                  <safepos value="position.[0,0,100km]"/>
                </warp>
                <signal_cue cue="Ch4_Setup_Align_ResearchShip" check="false"/>
                <force_cue cue="Ch5_Evade_Patrols"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- Chapter 5:
              - Player scans Signal Leak
              - Player evades Patrols
        -->

        <cue name="Ch5_Evade_Patrols">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>
            <set_value name="$CurrentObjective" exact="'Wait'"/>
            <set_value name="$WarningInProgress" exact="false"/>

            <create_mission comment="Mission: Terran Pests" group="missiongroup.story_terraforming"
                            name="{30224,5001}" description="{30224,5002} + '\n\n' + {30224,5003} " rewardtext="{30224,5020}"
                            icon="'briefing_kuromanckami_01'" iconcaption="$YakiScientistActor.name"
                            faction="faction.pioneers" difficulty="level.medium"
                            cue="$MissionCue" abortable="false" type="missiontype.plot">
              <briefing>
                <objective step="$ObjectiveStep" action="objective.wait"/>
              </briefing>
            </create_mission>
            <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>
          </actions>
          <cues>

            <cue name="Ch5_Hazardous_Warning_Check" instantiate="true" checkinterval="2s">
              <conditions>
                <check_value value="$BettyShip.isinhazardousregion"/>
                <check_value value="$BettyShip.sector == $TheVoid"/>
              </conditions>
              <actions>
                <cancel_cue cue="Ch5_Hazardous_Warning_Check"/>
                <signal_cue cue="Ch5_Hazardous_Warning" check="false"/>
              </actions>
            </cue>

            <cue name="Ch5_Hazardous_Warning">
              <conditions>
                <event_cue_signalled/>
                <check_value value="Ch5_2_Evade_Patrols.state == cuestate.waiting"/>
              </conditions>
              <cues>
                <cue name="Ch4_Hint_Yaki_Hazardous_Warning_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$YakiScientistActor"/>
                  <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                  <param name="Lines"             value="[[30224491], [30224492], [30224493]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <!--
                  <t id="	30224491	">	Do not try to test your colleague's shield in the hazardous zone.	</t>
                  <t id="	30224492	">	You will need it in the mission to come, so it won't be activated unnecessarily.	</t>
                  <t id="	30224493	">	I suggest you get out before I am forced to find yet another assistant for the job.	</t>
                      -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_Hint_Get_ID">
              <cues>
                <cue name="Ch5_Hint_Get_ID_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$YakiScientistActor, $BettyActor, $YakiScientistActor]"/>
                  <param name="Cutscene"          value="[true, $ShowBettyShipCutscene, true]"/>
                  <param name="CutsceneKey"       value="[$YakiScientistActorCutsceneKey, $BettyActorCutsceneKey, $YakiScientistActorCutsceneKey]"/>
                  <param name="Lines"             value="[
                                                         [[30224501]],
                                                         [[30224501]],
                                                         [[30224410, 1s, Ch5_1_SignalLeak_Station], [30224441], [30224442], [30224443], [30224444], [30224445], [30224502], [30224503], [30224504,1s,Ch5_Hint_Get_ID_ShowObjective], [30224505]]
                                                         ]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="[null, null, if ($DalBusta?) then Ch5_Hint_Dal_Torus else null]"/>
                  <!--
                  Yaki	<t id="	30224	501	">	Very good, it appears you two are ready for the next field test!	</t>
                  Betty	<t id="	30224	501	">	{10002,131}(Affirmative.)	</t>
                  
                  <t id="30224410">Take notice of the locational information I transmit to you.</t>
                      <t id="30224441">This ship, you see, was built for an archaeological purpose.</t>
                      <t id="30224442">It will survive the odd radiations inside the Torus wreckage.</t>
                      <t id="30224443">Additionally the systems inside are built to interface with the old terran hard- and software.</t>
                      <t id="30224444">The modified Mk7 Computational Unit will be able to extract the terraforming data our common researcher friend is yearning for!</t>
                      <t id="30224445">Be warned, that the Terrans might not be fond of us rummaging in their forgotten garbage pile.</t>
                  
                  Yaki	<t id="	30224	502	">	I purchased a forged ship ID which will allow you two to reach the Torus wreckage with no questions asked.	</t>
                  Yaki	<t id="	30224	503	">	If you can avoid a couple patrols that is.	</t>
                  Yaki	<t id="	30224	504	">	You can download the forged id at a station to apply it directly to the ship.	</t>
                  Yaki	<t id="	30224	505	">	My business partner, you see, was very eager for anonymity.	</t>
                  -->
                </cue>

                <cue name="Ch5_Hint_Get_ID_ShowObjective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                </cue>

                <cue name="Ch5_Hint_Dal_Torus">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch5_Hint_Dal_Torus_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30224403], [30224404], [30224405]]" comment="x"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--<t id="	30224	403	">	This Paranid has been preparing a Torus wreckage exploration!	</t>
                       <t id="	30224	404	">	The Terrans have always been technologically ahead of the other civilisations.	</t>
                       <t id="	30224	405	">	There could be a wealth of interesting tech to salvage in this old piece of a Terran station!	</t>
                        -->
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch5_1_SignalLeak_Station">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- Find a station for the Signal Leak, Reset if the station dies, handle faction-has-no-station -->
              <actions>

                <signal_cue cue="Ch5_Hint_Yaki_Hurry_Up_Timer"/>

              </actions>
              <cues>

                <cue name="Ch5_1_Set_SignalLeak_Station">
                  <actions>
                    <remove_value name="$PossibleTargetContainers"/>
                    <find_station space="player.galaxy" name="$PossibleTargetContainers" multiple="true" sortbygatedistanceto="$GetsuFune">
                      <match_dock size="[tag.dock_s, tag.dock_m]"/>
                      <match_context class="class.sector" extension="''"/>
                      <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                    </find_station>
                    <set_value name="$ClosestTargetStations" exact="[$PossibleTargetContainers.{1}, $PossibleTargetContainers.{2}, $PossibleTargetContainers.{3}, $PossibleTargetContainers.{4}, $PossibleTargetContainers.{5}]"/>

                    <set_value name="$TargetStation" exact="$ClosestTargetStations.random" comment="Should be .random, .{2} is for debugging"/>

                    <remove_value name="$PossibleTargetContainers"/>

                    <!-- Objective Handling in case the Player leaves the Mission Ship -->
                    <set_value name="$CurrentObjective" exact="'ScanLeak'"/>
                    <do_if value="player.entity.object == $BettyShip">
                      <do_if value="Ch5_Hint_Get_ID_ShowObjective.state == cuestate.complete">
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$TargetStation" updatebriefing="true" silent="true"/>
                      </do_if>
                      <do_else>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto" object="$TargetStation" updatebriefing="true" silent="true"/>
                      </do_else>
                    </do_if>
                  </actions>
                  <cues>
                    <cue name="Ch5_1_Set_SignalLeak_Station_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$TargetStation"/>
                      </conditions>
                      <actions>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>


                <cue name="Ch5_1_SignalLeak">
                  <conditions>
                    <event_cue_completed cue="Ch5_1_Set_SignalLeak_Station"/>
                  </conditions>
                  <cues>
                    <cue name="Ch5_1_Station_Attention_Check_Init">
                      <actions>
                        <signal_cue cue="Ch5_1_Station_Attention_Check"/>
                      </actions>
                    </cue>

                    <cue name="AttentionCheckEventUnreliabilityWorkaround" instantiate="true" checkinterval="1s">
                      <conditions>
                        <check_value value="$TargetStation.attention ge attention.nearby"/>
                      </conditions>
                      <actions>
                        <set_value name="$AttenionCheckUnreliabilityCaught"/>
                        <!--<debug_text text="$TargetStation.attention"/>-->
                        <signal_cue cue="Ch5_1_Station_Attention_Check"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Station_Attention_Check" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_object_changed_attention object="$TargetStation"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Attention Check: ' + $TargetStation.knownname + ' ' + $TargetStation.attention" chance="$DebugChance"/>
                        <do_if value="$TargetStation.attention ge attention.nearby">
                          <!-- Creating a SignalLeak required Active Physics 
                           External View could also count -->
                          <signal_cue cue="Ch5_1_Create_Leak" check="false"/>
                        </do_if>
                        <do_else>
                          <do_if value="@$SignalLeak.exists">
                            <destroy_object object="$SignalLeak"/>
                          </do_if>
                          <reset_cue cue="Ch5_1_Create_Leak"/>
                          <!-- Objective Handling in case the Player leaves the Mission Ship -->
                          <set_value name="$CurrentObjective" exact="'ScanLeak'"/>
                          <do_if value="player.entity.object == $BettyShip">
                            <do_if value="Ch5_Hint_Get_ID_ShowObjective.state == cuestate.complete">
                              <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$TargetStation" updatebriefing="true" silent="true"/>
                            </do_if>
                            <do_else>
                              <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto" object="$TargetStation" updatebriefing="true" silent="true"/>
                            </do_else>
                          </do_if>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch5_1_Create_Leak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch5_1_Create_Leak_Resetter" comment="Retry if @$SurfacePos fails">
                          <actions>
                            <!--Clear signal leak from previous chapter or previous attempt-->
                            <remove_value name="$SignalLeak"/>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <debug_text text="'Resetting'" chance="$DebugChance"/>

                            <do_if value="$TargetStation.isphysicsready">
                              <set_value name="$LeakObject" exact="$TargetStation"/>
                              <remove_value name="$LeakLocations"/>
                              <remove_value name="$SignalLeakLocation"/>
                              <remove_value name="$SurfacePos"/>
                              <include_actions ref="md.Signal_Leaks.GetLeakSlots"/>

                              <shuffle_list list="$LeakLocations"/>
                              <set_value name="$MissionLeakMacro" exact="macro.signalleak_s_standard_01_macro" />

                              <do_for_each name="$SignalLeakLocation" in="$LeakLocations">
                                <debug_text text="'Attention Create' + $LeakObject.knownname + ' ' + $TargetStation.knownname" chance="$DebugChance"/>
                                <debug_text text="'Attention Create' + $LeakObject.attention + ' ' + $TargetStation.attention" chance="$DebugChance"/>
                                <find_object_surface posname="$SurfacePos" rotname="$SurfaceRot" object="$SignalLeakLocation.component" height="$MissionLeakMacro.boundingbox.max.y - $MissionLeakMacro.boundingbox.center.y">
                                  <position value="$SignalLeakLocation.offset" />
                                  <!-- the rotation created by the normal would look away from the surface, we want a rotation that's looking parallel to the surface -->
                                  <offsetrotation pitch="-90deg" />
                                </find_object_surface>

                                <do_if value="$SurfacePos">
                                  <create_signal_leak name="$SignalLeak" groupname="$Leaks" macro="$MissionLeakMacro" type="signalleaktype.mission" object="$SignalLeakLocation.component">
                                    <position value="$SurfacePos" />
                                    <rotation value="$SurfaceRot" />
                                    <!--<voice page="$SignalLeakActor.page" lines="[1000003, 1000004, 1000005]"/>-->
                                  </create_signal_leak>
                                  <create_position name="$SignalLeakPos" object="$SignalLeak" space="$SignalLeak.sector"/>

                                  <!-- Objective Handling in case the Player leaves the Mission Ship -->
                                  <set_value name="$CurrentObjective" exact="'ScanLeak_Leak'"/>
                                  <do_if value="player.entity.object == $BettyShip">
                                    <do_if value="Ch5_Hint_Get_ID_ShowObjective.state == cuestate.complete">
                                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.scan" object="$SignalLeak" updatebriefing="true" silent="true"/>
                                    </do_if>
                                    <do_else>
                                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto" object="$SignalLeak" updatebriefing="true" silent="true"/>
                                    </do_else>
                                  </do_if>
                                  <break/>
                                </do_if>
                              </do_for_each>
                            </do_if>

                            <do_if value="not @$SignalLeak.exists">
                              <debug_text text="'SurfacePos for SignalLeak failed'" chance="$DebugChance"/>
                              <do_if value="player.age ge Ch5_1_Create_Leak.time + 10s">
                                <reset_cue cue="Ch5_1_SignalLeak"/>
                                <reset_cue cue="Ch5_1_Set_SignalLeak_Station"/>
                              </do_if>
                              <do_else>
                                <reset_cue cue="Ch5_1_Create_Leak_Resetter"/>
                              </do_else>
                            </do_if>
                          </actions>
                          <cues>
                            <cue name="Ch5_1_SignalLeak_Exists" checkinterval="1s">
                              <conditions>
                                <check_value value="$SignalLeak?"/>
                                <check_value value="not $SignalLeak.exists"/>
                                <cue_is_complete cue="parent"/>
                              </conditions>
                              <delay exact="1s"/>
                              <actions>
                                <debug_text text="'Signal Leak lost - Resetting'" chance="$DebugChance"/>
                                <do_if value="$SignalLeak? and (not $SignalLeak.exists)">
                                  <reset_cue cue="parent"/>
                                </do_if>
                                <do_else>
                                  <reset_cue cue="this"/>
                                </do_else>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_1_Scan_Leak">
                      <conditions>
                        <event_player_signal_unlock_finished signal="$SignalLeak"/>
                      </conditions>
                      <actions>
                        <destroy_object object="$SignalLeak" explosion="false"/>
                        <cancel_cue cue="Ch5_1_SignalLeak_Station"/>
                        <!--<reset_cue cue="Setup_BettyShip_Player_Init" comment="will signal $CurrentMissionCue / dockat Betty if not inside"/>
                        now also responsible for "welcome pilot" which we don't want to happen after the scan. -->

                        <!--<signal_cue cue="Setup_BettyShip_Player_Outside"/>-->

                        <!-- Apply Cover -->
                        <signal_cue cue="Ch5_2_Evade_Patrols"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_2_Evade_Patrols" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                <set_value name="$SignatureMaskMax" exact="120"/>
                <set_value name="$SignatureMaskMaxSecondTry" exact="$SignatureMaskMax * 1.5"/>
                <set_value name="$SignatureMask"    exact="$SignatureMaskMax"/>
                <set_value name="$SignatureMask_Update_Notification" exact="true"/>
                <set_value name="$AcquiredTerranScan"/>
                <set_object_npc_assignment_restricted object="$BettyShip" restricted="true"/>
                <set_value name="$LeaveRadarRangeCounter" exact="0"/>
                <set_value name="$Betty_In_Patrol_Range" exact="false"/>
                <signal_cue cue="Setup_Bettyship_CoverOwner_Set"/>
                <show_notification text="{30224,5080}" comment="Signature masked" sound="notification_generic"/>

                <signal_cue cue="Setup_Character_Police_Patrols"/>

                <reset_cue cue="Ch5_Hint_Yaki_Hurry_Up_Timer"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="Ch5_Hint_Yaki_Hurry_Up_Timer"/>
              </actions>
              <patch sinceversion="2" state="active">
                <do_if value="(Ch7_Hint_Betty_Farewell_Completed.state == cuestate.waiting) or 
                              (Ch7_Hint_Betty_Farewell_Completed.state == cuestate.disabled)">
                  <set_object_npc_assignment_restricted object="$BettyShip" restricted="true"/>
                </do_if>
              </patch>
              <patch sinceversion="2" state="complete">
                <do_if value="(Ch7_Hint_Betty_Farewell_Completed.state == cuestate.waiting) or 
                              (Ch7_Hint_Betty_Farewell_Completed.state == cuestate.disabled)">
                  <set_object_npc_assignment_restricted object="$BettyShip" restricted="true"/>
                </do_if>
              </patch>
              <patch sinceversion="2" state="cancelled">
                <do_if value="(Ch7_Hint_Betty_Farewell_Completed.state == cuestate.waiting) or 
                              (Ch7_Hint_Betty_Farewell_Completed.state == cuestate.disabled)">
                  <set_object_npc_assignment_restricted object="$BettyShip" restricted="true"/>
                </do_if>
              </patch>
              <cues>

                <cue name="Ch5_Hints">
                  <cues>
                    <cue name="Ch5_Hint_Yaki_Patrols_Delay">
                      <delay exact="5s"/>
                      <actions>
                        <signal_cue cue="Ch5_Hint_Yaki_Patrols"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_Hint_Yaki_Patrols">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch5_Hint_Yaki_Patrols_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224506], [30224511], [30224512], [30224508], [30224510]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch5_Hint_Patrol_Warning_Hints"/>
                          <!--
                      <t id="	30224506	">	Very well, now you two should pass as Terran agricultural worker or whatever they do these days.	</t>
                      30224511	">	However, you will still need to avoid Terran military patrols.
                      <t id="	30224512	">	The larger ships in particular are equipped to recognise odd signature readings at sensor range.	</t>	no
                      <t id="	30224508	">	Let's say that not all of the modules you are equipped with are exactly legal in this space.	</t>
                      <t id="	30224510	">	But, please, do reach the Torus wreckage eventually.	</t>
                      
                      not used: <t id="	30224507	">	However, you will still need to avoid Terran police patrols.	</t>
                      not used <t id="	30224509	">	Especially the police patrols are equipped to recognise odd signature readings at sensor range.	</t>
                      -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Hint_Patrol_Warning_Hints">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch5_Hint_Patrol_Warning_Init">
                          <actions>
                            <do_if value="$SolSectors.indexof.{$BettyShip.sector}">
                              <signal_cue cue="Ch5_Hint_Patrol_Warning"/>
                            </do_if>
                          </actions>
                        </cue>
                        <cue name="Ch5_Hint_Patrol_Warning">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <check_all>
                                <event_object_changed_sector object="$BettyShip"/>
                                <check_value value="$SolSectors.indexof.{event.param}"/>
                                <check_value value="event.param.owner == faction.terran"/>
                              </check_all>
                            </check_any>
                            <!-- ToDo: Check if actual Police Ships are in there / The sector is still Terran owned @Heinrich -->
                          </conditions>
                          <cues>
                            <!--<cue name="Ch5_Hint_Patrol_Warning_Ref" ref="md.LIB_Dialog.Speak_Actors">
                              <param name="Actor"             value="[$YakiScientistActor, $BettyActor, $YakiScientistActor]"/>
                              <param name="CutsceneKey"       value="[$YakiScientistActorCutsceneKey, $BettyActorCutsceneKey, $YakiScientistActorCutsceneKey]"/>
                              <param name="Lines"             value="[
                                                         [[30224520], [30224521]],
                                                         [[30224513]],
                                                         [[30224522], [30224523], [30224524]]
                                                         ]"/>-->
                            <!--
                              Yaki	<t id="	30224520	">	Be wary, there are terran bogeys in this sector.	</t>
                              Yaki	<t id="	30224521	">	Assistant, load patrol roster.	</t>
                              Betty	<t id="	30224512	">	Loading Terran patrol roster.</t>
                              Betty	<t id="	30224513	">	Loading Terran Police Roster.</t>
                              Yaki	<t id="	30224522	">	Your colleague will warn you should you get to close to their patrol ships.	</t>
                              Yaki	<t id="	30224523	">	Avoid getting in their scanner range alltogether.	</t>
                              Yaki	<t id="	30224524	">	Best case they kick you out, worst case they start shooting.	</t>
                              -->
                            <!--</cue>-->
                            <cue name="Ch5_Hint_Patrol_Warning_v2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$YakiScientistActor"/>
                              <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                              <param name="Lines"             value="
                                                         [[30224520], [30224523], [30224524]]
                                                         "/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <!--
                                    <t id="30224520">Be wary, there are Terran pests in this sector.</t>
                              Yaki	<t id="	30224522	">	Your colleague will warn you should you get to close to their patrol ships.	</t>
                              Yaki	<t id="	30224523	">	Avoid getting in their scanner range alltogether.	</t>
                              Yaki	<t id="	30224524	">	Best case they kick you out, worst case they start shooting.	</t>
                              -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_2_Patrols_SignatureMask_Handler" checkinterval="1s" instantiate="true">
                  <conditions>
                    <check_value value="$CurrentObjective != 'LeaveCoreSector'"/>
                    <check_value value="$SolSectors.indexof.{$BettyShip.sector}"/>
                    <check_value value="$BettyShip.sector.owner == faction.terran"/>
                    <count_ships result="$TerranShips" owner="faction.terran" space="$BettyShip.sector"
                                 min="0" checkoperational="true" masstraffic="false" primarypurpose="purpose.fight"
                                 class="[class.ship_l, class.ship_xl]">
                      <match excluded="$BettyShip"/>
                    </count_ships>
                  </conditions>
                  <actions>
                    <!-- Find Ships in Radar Range -->
                    <create_group groupname="$Ships_In_Radar_Range"/>
                    <do_for_each in="$TerranShips" name="$Ship">
                      <do_if value="$Ship.distanceto.{$BettyShip} le $Ship.maxradarrange">
                        <add_to_group groupname="$Ships_In_Radar_Range" object="$Ship"/>
                      </do_if>
                    </do_for_each>

                    <!-- Signal LIB_Dialog PatrolChatter on InRange/LeftRange change -->
                    <do_if value="$Ships_In_Radar_Range.count">
                      <signal_cue_instantly cue="Ch5_Hint_Play_Hint" param="'InRange'"/>
                      <do_if value="not $Betty_In_Patrol_Range">
                        <set_value name="$Betty_In_Patrol_Range" exact="true"/>
                      </do_if>
                    </do_if>
                    <do_else comment="0 == $Ships_In_Radar_Range.count">
                      <do_if value="$Betty_In_Patrol_Range">
                        <set_value name="$Betty_In_Patrol_Range" exact="false"/>
                        <signal_cue_instantly cue="Ch5_Hint_Play_Hint" param="'LeftRange'"/>
                      </do_if>
                    </do_else>

                    <do_if value="($SignatureMask le 0)">
                      <!-- Objective: Leave Core Sector -->
                      <signal_cue cue="Ch5_Objective_LeaveCoreSector"/>
                      <signal_cue cue="Ch5_2_SignatureMask_Failed"/>
                    </do_if>
                    <do_else>

                      <do_if value="$Ships_In_Radar_Range.count">
                        <!-- Objective: Leave Police Radar Range-->
                        <signal_cue cue="Ch5_Objective_LeavePoliceRadarRange"/>
                        <signal_cue cue="Ch5_2_SignatureMask_Failing"/>
                      </do_if>
                      <do_else comment="not $Ships_In_Radar_Range.count">
                        <!-- Objective: Fly undetected to Torus -->
                        <signal_cue cue="Ch5_Objective_FlyToTorus"/>
                        <set_value name="$SignatureMask_Update_Notification" exact="true"/>
                        <set_value name="$LeaveRadarRangeCounter" exact="0"/>
                      </do_else>

                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch5_2_SignatureMask_Updates">
                  <cues>
                    <cue name="Ch5_Coverowner_Failed" instantiate="true">
                      <conditions>
                        <event_object_changed_owner object="$BettyShip" owner="faction.player" previous="faction.terran"/>
                        <check_value value="$AcquiredTerranScan?"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="md.Cover.TriggerCover" param="[$BettyShip, faction.terran]"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_2_SignatureMask_Failing" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$SignatureMask"/>
                      </conditions>
                      <actions>
                        <!-- Subtract -->
                        <set_value name="$SignatureMask" exact="1" operation="subtract"/>

                        <!-- Notification -->
                        <do_if value="$SignatureMask_Update_Notification">
                          <show_notification text="{30224,5081}" comment="Signature mask failing" sound="notification_generic" priority="7"/>
                        </do_if>
                        <set_value name="$SignatureMask_Update_Notification" exact="not $SignatureMask_Update_Notification"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_2_SignatureMask_Failed" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!--<signal_cue cue="Ch5_Hint_Patrol_Chatter_Mask_Failed"/>-->
                        <signal_cue_instantly cue="Ch5_Hint_Play_Hint" param="'InRange'"/>
                        <!-- Notification -->
                        <show_notification text="{30224,5082}" comment="Signature mask failed" sound="notification_generic" priority="7"/>
                        <set_value name="$SignatureMask_Update_Notification" exact="true"/>
                        <!-- Lose Cover -->
                        <remove_value name="$AcquiredTerranScan"/>
                        <signal_objects object="$BettyShip" param="'LoseCover'"/>
                        <!-- Populate $terranHostileShips -->
                        <get_suitable_job result="$terranPoliceJobs"    faction="faction.terran" tags="tag.police" exceedquota="true" multiple="true"/>
                        <get_suitable_job result="$terranMilitaryJobs"  faction="faction.terran" tags="tag.military" exceedquota="true" multiple="true"/>

                        <do_for_each in="$terranPoliceJobs" name="$jobname">
                          <find_ship job="$jobname" multiple="true" groupname="$terranHostileShips" space="player.galaxy"/>
                        </do_for_each>
                        <do_for_each in="$terranMilitaryJobs" name="$jobname">
                          <find_ship job="$jobname" multiple="true" groupname="$terranHostileShips" space="player.galaxy"/>
                        </do_for_each>

                        <!-- Set $terranHostileShips hostile -->
                        <do_for_each in="$terranHostileShips" name="$ship">
                          <do_if value="($SolSectors.indexof.{$ship.sector})
                                 and ($ship.sector.owner == faction.terran)">
                            <set_relation_boost object="$ship" otherobject="$BettyShip" value="-1.0" decay="0"/>
                            <do_for_each in="$ship.subordinates" name="$subordinate" comment="workaround, request relation boost for subordinates">
                              <set_relation_boost object="$subordinate" otherobject="$BettyShip" value="-1.0" decay="0"/>
                              <do_for_each in="$subordinate.subordinates" name="$sub_subordinate">
                                <set_relation_boost object="$sub_subordinate" otherobject="$BettyShip" value="-1.0" decay="0"/>
                                <do_for_each in="$sub_subordinate.subordinates" name="$sub_sub_subordinate">
                                  <set_relation_boost object="$sub_sub_subordinate" otherobject="$BettyShip" value="-1.0" decay="0"/>
                                </do_for_each>
                              </do_for_each>
                            </do_for_each>
                          </do_if>
                          <do_else>
                            <remove_from_group group="$terranHostileShips" object="$ship"/>
                          </do_else>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="Ch5_Signature_Mask_Reset" instantiate="true">
                      <conditions>
                        <event_object_changed_sector object="$BettyShip"/>
                        <check_value value="event.param != null"  comment="New Sector can be null while traversing the super highway"/>
                        <check_value value="not $SolSectors.indexof.{event.param}"/>
                        <check_value value="$SolSectors.indexof.{event.param2}"/>
                        <check_value value="$SignatureMask lt $SignatureMaskMax"/>
                        <check_value value="not $Ch5_Signature_Mask_Reset?"/>
                      </conditions>
                      <actions>
                        <set_value name="$Ch5_Signature_Mask_Reset"/>
                      </actions>
                      <cues>
                        <cue name="Ch5_Hint_Betty_ID_Masked_Reset_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224539], [30224543, 0.5s, Ch5_Signature_Mask_Reset_Complete], [30224544, 0.5s], [30224503]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--                      
                          <t id="	30224	539	">	Initiating Reconfiguration.	</t>
                          <t id="	30224	543	">	50%.	</t>
                          <t id="	30224	544	">	Reconfiguration completed.	</t>
                          <t id="	30224503	">	Ship ID masked.	</t>                      
                          not used: <t id="	30224	542	">	Reconfiguring.	</t>
                          not used: <t id="	30224	547	">	Ship ID generated.	</t>
                          not used: <t id="	30224	548	">	Agricultural Ship ID generated.	</t>
                          -->
                        </cue>
                        <cue name="Ch5_Signature_Mask_Reset_Complete">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <remove_value name="$Ch5_Signature_Mask_Reset"/>

                            <show_notification text="{30224,5080}" comment="Signature masked" sound="notification_generic"/>
                            <set_value name="$SignatureMaskMax" exact="$SignatureMaskMaxSecondTry" comment="Upgrade once"/>
                            <set_value name="$SignatureMask"    exact="$SignatureMaskMax"/>
                            <set_value name="$CurrentObjective" exact="'FlyToTorus'" comment="required to reset after leave objective"/>
                            <signal_cue cue="Ch5_Objective_FlyToTorus"/>
                            <set_value name="$AcquiredTerranScan"/>
                            <signal_cue cue="Setup_Bettyship_CoverOwner_Set"/>

                            <do_if value="$terranHostileShips?">
                              <do_for_each in="$terranHostileShips" name="$ship">
                                <reset_relation_boost object="$ship" otherobject="$BettyShip"/>
                                <do_for_each in="$ship.subordinates" name="$subordinate" comment="workaround, request relation boost for subordinates">
                                  <reset_relation_boost object="$subordinate" otherobject="$BettyShip"/>
                                  <do_for_each in="$subordinate.subordinates" name="$sub_subordinate">
                                    <reset_relation_boost object="$sub_subordinate" otherobject="$BettyShip"/>
                                    <do_for_each in="$sub_subordinate.subordinates" name="$sub_sub_subordinate">
                                      <reset_relation_boost object="$sub_sub_subordinate" otherobject="$BettyShip"/>
                                    </do_for_each>
                                  </do_for_each>
                                </do_for_each>
                              </do_for_each>
                            </do_if>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_Objectives">
                  <cues>
                    <cue name="Ch5_Objective_FlyToTorus_Init">
                      <actions>
                        <signal_cue cue="Ch5_Objective_FlyToTorus"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_Objective_FlyToTorus" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$CurrentObjective != 'LeaveCoreSector'"/>
                        <check_any>
                          <check_all>
                            <check_value value="not $SolSectors.indexof.{$BettyShip.sector}"/>
                          </check_all>
                          <check_all>
                            <check_value value="$SolSectors.indexof.{$BettyShip.sector}"/>
                            <check_value value="$BettyShip.sector.owner == faction.terran"/>
                            <check_value value="(not $Ships_In_Radar_Range.count?) or not $Ships_In_Radar_Range.count"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <!-- Objective Handling in case the Player leaves the Mission Ship -->
                        <set_value name="$CurrentObjective" exact="'FlyToTorus'"/>
                        <do_if value="player.ship == $BettyShip">
                          <set_objective cue="$MissionCue" step="$ObjectiveStep"
                                         action="objective.custom" customaction="{30224,5051}"
                                         text="$EarthTorus.knownname" object="$EarthTorus" updatebriefing="true" silent="true"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch5_Objective_LeavePoliceRadarRange" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$CurrentObjective != 'LeaveCoreSector'"/>
                        <check_value value="$Ships_In_Radar_Range.count"/>
                      </conditions>
                      <actions>
                        <set_value name="$LeaveRadarRangeCounter" operation="add" exact="1"/>

                        <!-- Objective Handling in case the Player leaves the Mission Ship -->
                        <set_value name="$CurrentObjective" exact="'LeavePoliceRadarRange'"/>
                        <do_if value="player.ship == $BettyShip">
                          <do_if value="$LeaveRadarRangeCounter ge 5">
                            <set_value name="$LeaveRadarRangeCounter" exact="0"/>
                          </do_if>
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,5061}" text="{30224,5062}" updatebriefing="true" group="$Ships_In_Radar_Range" radius="$Ships_In_Radar_Range.{1}.maxradarrange" silent="$LeaveRadarRangeCounter">
                            <progress progress="$SignatureMask" max="$SignatureMaskMax"/>
                          </set_objective>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch5_Objective_LeaveCoreSector" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <create_group groupname="$Ships_In_Radar_Range" comment="Clearing the group"/>
                        <!-- Objective Handling in case the Player leaves the Mission Ship -->
                        <set_value name="$CurrentObjective" exact="'LeaveCoreSector'"/>
                        <do_if value="player.ship == $BettyShip">
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,5071}" text="{30224,5072}" updatebriefing="true" object="$GetsuFune"/>
                        </do_if>
                      </actions>
                    </cue>

                  </cues>
                </cue>



                <!--
                Signalled Cues
                Ch5_Hint_Patrol_Chatter_Mask_Failing // Signature Mask below 50
                Ch5_Hint_Patrol_Chatter_Mask_Failed // Set to Leave Sector
                Ch5_Hint_Patrols_Betty_Alert // Distance Warning 
                Ch5_Hint_Patrol_Chatter_Left_Range // Left Distance Message
                -->


                <cue name="Ch5_Hint_Escape_Patrols">
                  <cues>
                    <cue name="Ch5_Hint_Play_Hint" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $WarningInProgress"/>
                      </conditions>
                      <actions>
                        <set_value name="$Hint" exact="event.param"/>

                        <!-- In Range-->
                        <do_if value="$Hint == 'InRange'">

                          <!-- In Range > 50% -->
                          <do_if value="$SignatureMask gt ($SignatureMaskMax / 2)">
                            <do_if value="not $PoliceSaid.indexof.{30224513}">
                              <signal_cue cue="Ch5_Hint_Patrol_Chatter_1"/>
                            </do_if>
                            <do_elseif value="not $PoliceSaid.indexof.{30224514}">
                              <signal_cue cue="Ch5_Hint_Patrol_Chatter_2"/>
                            </do_elseif>
                          </do_if>

                          <!-- In Range <= 50$ -->
                          <do_elseif value="$SignatureMask ge 1">

                            <do_if value="not $PoliceSaid.indexof.{30224522}">
                              <signal_cue cue="Ch5_Hint_Patrol_Chatter_Mask_Failing"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch5_Hint_Patrol_Chatter_Mask_Failing_Reentered"/>
                            </do_else>
                          </do_elseif>
                          <!-- In Range 0%-->
                          <do_else>
                            <do_if value="not $PoliceSaid.indexof.{30224534}">
                              <signal_cue cue="Ch5_Hint_Patrol_Chatter_Mask_Failed"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch5_Hint_Patrol_Engaging"/>
                            </do_else>
                          </do_else>

                        </do_if>

                        <!-- Out of Range -->
                        <do_elseif value="$Hint == 'LeftRange'">

                          <!-- Out of Range > 50% -->
                          <do_if value="$SignatureMask gt ($SignatureMaskMax / 2)">
                            <signal_cue cue="Ch5_Hint_Patrol_Chatter_Left_Range"/>
                          </do_if>
                          <!-- Out of Range 0% -->
                          <do_else>
                            <signal_cue cue="Ch5_Hint_Patrol_Chatter_Failed_Lost"/>
                          </do_else>

                        </do_elseif>

                      </actions>
                    </cue>

                    <cue name="Ch5_Completed_WarningInProgress" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Setup_Character_Police_Patrols_Reset_Actors"/>
                      </actions>
                      <delay exact="6s"/>
                      <actions>
                        <set_value name="$WarningInProgress" exact="false"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_Hint_Patrols_Betty_Alert" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $WarningInProgress"/>
                      </conditions>
                      <cues>
                        <cue name="Ch5_Hint_Patrols_Betty_Alert_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224514]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                          <t id="	30224514	">	Patrol detected.</t> // Abort Autopilot?
                          -->
                        </cue>

                      </cues>
                    </cue>


                    <cue name="Ch5_Hint_Patrol_Chatter_1" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $WarningInProgress"/>
                        <check_value value="Ch5_Hint_Patrol_Warning_v2_Ref.state == cuestate.cancelled"/>
                      </conditions>
                      <actions>
                        <set_value name="$WarningInProgress" exact="true"/>
                        <append_to_list name="$PoliceSaid" exact="30224513"/>
                      </actions>
                      <cues>
                        <cue name="Ch5_Hint_Patrol_Chatter_1_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BettyActor, $PoliceActor_Reporter, 
                                                                  $PoliceActor_Response, $PoliceActor_Reporter]"/>
                          <param name="Cutscene"       value="[$ShowBettyShipCutscene, true, true, true]"/>
                          <param name="CutsceneCaption"   value="[true, {30224,4030}, {30224,4030}, {30224,4030}]"/>
                          <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $PoliceReporterCutsceneKey, 
                                                                  $PoliceResponseCutsceneKey, $PoliceResponseCutsceneKey]"/>
                          <param name="Lines"             value="[
                                                         [[30224521]],
                                                         [[30224510],[30224511]],
                                                         [[30224512]],
                                                         [[30224513]]
                                                         ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                              <t id="	30224521	">	Intercepting Transmission.	</t>
                              <t id="	30224	523	">	End of Transmission.	</t>
                              -->
                          <!--
                              <t id="	30224	510	">	Command, I'm getting odd readings here.	</t>
                              <t id="	30224	511	">	Shouldn't gate patrol have reported Xenon presence?	</t>
                              <t id="	30224	512	">	Negative, no Xenon incursion passed the gate.	</t>
                              <t id="	30224	513	">	Might be a hickup in that old program, I'll run sanity checks.	</t>
                              -->
                          <param name="EndSignalCue"    value="[null, null, null, Ch5_Completed_WarningInProgress]"/>
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch5_Hint_Patrol_Chatter_2" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $WarningInProgress"/>
                      </conditions>
                      <actions>
                        <set_value name="$WarningInProgress" exact="true"/>
                        <append_to_list name="$PoliceSaid" exact="30224514"/>
                      </actions>
                      <cues>
                        <cue name="Ch5_Hint_Patrol_Chatter_2_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BettyActor, $PoliceActor_Reporter, 
                                                                  $PoliceActor_Response]"/>
                          <param name="Cutscene"       value="[$ShowBettyShipCutscene, true, true]"/>
                          <param name="CutsceneCaption"   value="[true, {30224,4030}, {30224,4030}]"/>
                          <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $PoliceReporterCutsceneKey, 
                                                                  $PoliceResponseCutsceneKey]"/>
                          <param name="Lines"             value="[
                                                         [[30224521]],
                                                         [[30224514]],
                                                         [[30224515]]
                                                         ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                              <t id="	30224521	">	Intercepting Transmission.	</t>
                              <t id="	30224	523	">	End of Transmission.	</t>
                              -->
                          <!--
                              <t id="	30224514	">	Command, picking up signatures.. are there Xenon I should know about?	</t>
                              <t id="	30224515	">	Negative.	</t>
                              -->
                          <param name="EndSignalCue"    value="[null, null, Ch5_Completed_WarningInProgress]"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Hint_Patrol_Chatter_Left_Range" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $WarningInProgress"/>
                      </conditions>
                      <actions>
                        <set_value name="$WarningInProgress" exact="true"/>
                        <set_value name="$var1" exact="[[30224516]]"/>
                        <set_value name="$var2" exact="[[30224517],[30224518]]"/>
                        <set_value name="$var3" exact="[[30224519],[30224520]]"/>
                        <!--
                            <t id="	30224	516	">	Nothing to report, must have been a fluke.	</t>
                            <t id="	30224	517	">	Readings nominal.	</t>
                            <t id="	30224	518	">	Whatever it was, it got lost in the background noise.	</t>
                            <t id="	30224	519	">	Yeah, that's what I thought.	</t>
                            <t id="	30224	520	">	A system error, nothing to report.	</t>
                            <t id="	30224	521	">	Tell the quartermasters our scanners need a complete overhaul.	</t>
                            -->
                        <set_value name="$PoliceLines" exact="[$var1, $var2, $var3].random"/>
                        <do_if value="not $PoliceSaid.indexof.{30224521}">
                          <append_to_list name="$PoliceSaid" exact="30224521"/>
                          <append_to_list name="$PoliceLines" exact="[30224521]"/>
                        </do_if>
                      </actions>
                      <cues>
                        <cue name="Ch5_Hint_Patrol_Chatter_Left_Range_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BettyActor, $PoliceActor_Reporter]"/>
                          <param name="Cutscene"       value="[$ShowBettyShipCutscene, true]"/>
                          <param name="CutsceneCaption"   value="[true, {30224,4030}]"/>
                          <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $PoliceReporterCutsceneKey]"/>
                          <param name="Lines"             value="[
                                                         [[30224521]],
                                                         $PoliceLines
                                                         ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[null, Ch5_Completed_WarningInProgress]"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Hint_Patrol_Chatter_Mask_Failing" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $WarningInProgress"/>
                      </conditions>
                      <actions>
                        <set_value name="$WarningInProgress" exact="true"/>
                        <do_any>
                          <set_value name="$PoliceLines"          exact="[[30224522],[30224523]]"/>
                          <set_value name="$PoliceLines"          exact="[[30224522],[30224524]]"/>
                          <set_value name="$PoliceLines"          exact="[[30224522],[30224525]]"/>
                        </do_any>
                        <do_if value="not $PoliceSaid.indexof.{30224522}">
                          <append_to_list name="$PoliceSaid" exact="30224522"/>
                        </do_if>
                        <!--
                            <t id="	30224	522	">	Command, reporting signature readings in violation of penal code 2-0-2-5 AGI Act.(Firm professional alarm raising, speak A-G-I seperately, speak numerals seperately, don't speak dash)	</t>
                            <t id="	30224	523	">	Must have smuggled through the noise at the gate.	</t>
                            <t id="	30224	524	">	Still looking for the source, it can't be far.	</t>
                            <t id="	30224	525	">	Attempting to locate.	</t>
                            -->
                      </actions>
                      <cues>
                        <cue name="Ch5_Hint_Patrol_Chatter_Mask_Failing_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BettyActor, $PoliceActor_Reporter]"/>
                          <param name="Cutscene"          value="[$ShowBettyShipCutscene, true]"/>
                          <param name="CutsceneCaption"   value="[true, {30224,4030}]"/>
                          <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $PoliceReporterCutsceneKey]"/>
                          <param name="Lines"             value="[
                                                         [[30224528], [30224521]],
                                                         $PoliceLines
                                                         ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[null, Ch5_Completed_WarningInProgress]"/>
                          <!--
                              521 - Intercepting Transmission
                              not used: <t id="	30224	525	">	Alert.	</t>
                              <t id="	30224	528	">	Signature Mask Failing.	</t>
                              -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch5_Hint_Patrol_Chatter_Mask_Failed" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$WarningInProgress" exact="true"/>
                        <append_to_list name="$PoliceSaid" exact="30224534"/>

                        <set_value name="$YakiLines" exact="[[30224525]]"/>
                        <do_if value="player.sector.owner == faction.terran">
                          <append_to_list name="$YakiLines" exact="[30224526]"/>
                        </do_if>
                      </actions>
                      <cues>
                        <cue name="Ch5_Hint_Patrol_Chatter_Mask_Failed_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BettyActor, $PoliceActor_Reporter, $PoliceActor_Response, $YakiScientistActor]"/>
                          <param name="Cutscene"       value="[$ShowBettyShipCutscene, true, true, true]"/>
                          <param name="CutsceneCaption"   value="[true, {30224,4030}, {30224,4030}, true]"/>
                          <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $PoliceReporterCutsceneKey, $PoliceResponseCutsceneKey, $YakiScientistActorCutsceneKey]"/>
                          <param name="Lines"             value="[
                                                         [[30224530], [30224534], [30224521]],
                                                         [[30224533]], 
                                                         [[30224534],[30224535],[30224536],[30224537]],
                                                         $YakiLines
                                                         ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"    value="[null, null, null, Ch5_Completed_WarningInProgress]"/>
                          <!--
                              Betty:
                              <t id="	30224	530	">	Signature Mask Failed.	</t>
                              <t id="	30224	534	">	Vacate Core Space Immediately.	</t>
                              not used: <t id="	30224	531	">	Vacate.	</t>
                              not used: <t id="	30224	535	">	Vacate Immediately.	</t>
                              <t id="	30224	521	">	Intercepting Transmission.	</t>
                              <t id="	30224	523	">	End of Transmission.	</t>
                              
                              
                              <t id="	30224	533	">	Located a ship responsible for the signature, transmitting the ID.	</t>
                              <t id="	30224	534	">	Local patrols we have a ship in violation of 2-0-2-5 AGI Act presenting as civilian vessel.	</t>
                              <t id="	30224	535	">	Reporting ID to military command to suspend their sector priviliges.	</t>
                              <t id="	30224	536	">	We do not know what this one is capable of and we do not intend to find out.	</t>
                              <t id="	30224	537	">	Engage on sight.	</t>
                              
                              Yaki	<t id="	30224	525	">	Get out and let your collegue reconfigure the ship signature before you try again.	</t>
    	                        Yaki  <t id="	30224	526	">	You are strongly advised to leave Terran space.	</t>
                              
                              -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Hint_Patrol_Chatter_Mask_Failing_Reentered" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $WarningInProgress"/>
                      </conditions>
                      <actions>
                        <set_value name="$WarningInProgress" exact="true"/>
                        <do_any>
                          <set_value name="$PoliceLines" exact="[[30224530]]"/>
                          <!--<set_value name="$PoliceLines" exact="[[30224531]]"/>-->
                          <set_value name="$PoliceLines" exact="[[30224532]]"/>
                          <!--
                          30224530	">	Command, reporting readings on our 2-0-2-5.
                          30224531	">	Command, reading our 2-0-2-5 again.
                          30224532	">	Command, reporting 2-0-2-5 signature readings.
                          
                           <t id="30224524">Still looking for the source. It can't be far.</t>
                           <t id="30224525">Attempting to locate.</t>-->
                        </do_any>
                        <do_any>
                          <append_to_list name="$PoliceLines" exact="[30224524]"/>
                          <append_to_list name="$PoliceLines" exact="[30224525]"/>
                        </do_any>
                      </actions>
                      <cues>
                        <cue name="Ch5_Hint_Patrol_Chatter_Mask_Failing_Reentered_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BettyActor, $PoliceActor_Reporter]"/>
                          <param name="Cutscene"       value="[$ShowBettyShipCutscene, true]"/>
                          <param name="CutsceneCaption"   value="[true, {30224,4030}]"/>
                          <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $PoliceReporterCutsceneKey]"/>
                          <param name="Lines"             value="[
                                                         [[30224521]],
                                                         $PoliceLines
                                                         ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[null, Ch5_Completed_WarningInProgress]"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Hint_Patrol_Chatter_Failed_Lost" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $WarningInProgress"/>
                      </conditions>
                      <actions>
                        <set_value name="$WarningInProgress" exact="true"/>
                      </actions>
                      <!--
                          Misc.	<t id="	30224526	">	Can't find a culprit, lost the signal.	</t>
                          Misc.	<t id="	30224527	">	I'll run diagnostics to see if we can salvage the readings.	</t>
                          Misc. 2	<t id="	30224528	">	Local patrols we have a possible signal in violation of penal 2-0-2-5 AGI Act, I repeat,    possible        violation    of      2-0-2-5.	</t>
                          Misc. 2	<t id="	30224529	">	Adjust your radars and report any suspicious readings immediately.	</t>
                      -->
                      <cues>
                        <cue name="Ch5_Hint_Patrol_Chatter_Failed_Lost_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BettyActor, $PoliceActor_Reporter, $PoliceActor_Response]"/>
                          <param name="Cutscene"       value="[$ShowBettyShipCutscene, true, true]"/>
                          <param name="CutsceneCaption"   value="[true, {30224,4030}, {30224,4030}]"/>
                          <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $PoliceReporterCutsceneKey, $PoliceReporterCutsceneKey]"/>
                          <param name="Lines"             value="[
                                                         [[30224521]],
                                                         [[30224526],[30224527]],
                                                         [[30224528],[30224529]]
                                                         ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[null,null, Ch5_Completed_WarningInProgress]"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Hint_Patrol_Engaging" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $WarningInProgress"/>
                      </conditions>
                      <actions>
                        <set_value name="$WarningInProgress" exact="true"/>
                        <do_any>
                          <set_value name="$PoliceLines"          exact="[[30224538],[30224540]]"/>
                          <set_value name="$PoliceLines"          exact="[[30224539],[30224540]]"/>
                          <!--
                          <t id="30224538">(#angry#)Located 2-0-2-5.(speak numerals separately, don't speak dash)</t>
                          <t id="30224539">(#angry#)2-0-2-5 in sight.(speak numerals separately, don't speak dash)</t>
                          <t id="30224540">(#angry#)Engaging.</t>
                          -->
                        </do_any>
                      </actions>
                      <cues>
                        <cue name="Ch5_Hint_Patrol_Engaging_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BettyActor, $PoliceActor_Reporter]"/>
                          <param name="Cutscene"          value="[$ShowBettyShipCutscene, true]"/>
                          <param name="CutsceneCaption"   value="[true, {30224,4030}]"/>
                          <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $PoliceReporterCutsceneKey]"/>
                          <param name="Lines"             value="[
                                                         [[30224531], [30224521]],
                                                         $PoliceLines
                                                         ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[null, Ch5_Completed_WarningInProgress]"/>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch5_Approach_Torus">
                  <cues>

                    <cue name="Ch5_Torus_Player_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="$BettyShip"/>
                      <param name="ApproachTarget"    value="$EarthTorus"/>
                      <param name="ApproachDistance"  value="75km"/>
                      <param name="SuccessSignalCue"  value="Ch5_Player_At_Torus"/>
                      <!--<param name="FailureSignalCue"  value="Ch5_Ship_Destroyed"/>-->
                    </cue>

                    <cue name="Ch5_Player_At_Torus">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="parent"/>
                        <signal_cue cue="Ch5_Complete"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch5_Hint_Yaki_Hurry_Up_Timer">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="60min"/>
              <actions>
                <signal_cue cue="Ch5_Hint_Yaki_Hurry_Up_Segarian" check="false"/>
              </actions>
              <cues>
                <cue name="Ch5_Hint_Yaki_Hurry_Up_Abort">
                  <conditions>
                    <event_object_changed_sector object="$BettyShip" sector="$EarthTorus.sector"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="parent"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_Hint_Yaki_Hurry_Up_Segarian">
              <conditions>
                <event_cue_signalled/>
                <check_value value="$EarthTorus.sector != $BettyShip.sector"/>
              </conditions>
              <cues>
                <cue name="Ch5_Hint_Yaki_Hurry_Up_Segarian_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$YakiScientistActor"/>
                  <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                  <param name="Lines"             value="[[30224429], [30224450]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <!--
                      <t id="	30224	429	">	Hurry up, assistant!	</t>
                      <t id="	30224	450	">	Our Segarian contractee is eagerly awaiting this expedition's results.	</t>
                      -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30224,5021}" text="{30224,5022}"/>
                <cancel_cue cue="parent"/>
                <signal_cue cue="Ch6_Torus"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Ch6_Force" version="2">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <force name="Ch6_Terraforming_Intro">
            <cancel_cue cue="Ch1_Intro"/>
          </force>
          <cues>
            <cue name="Ch6_Check_HQ">
              <actions>
                <do_if value="not $HQ?">
                  <signal_cue cue="Debug_Setup_HQ"/>
                </do_if>
                <signal_cue cue="Ch6_Force_Delay"/>
                <signal_cue cue="Ch4_Setup_MissionShip" check="false"/>
                <signal_cue cue="Debug_Arm_Spacesuit"/>
                <set_value name="$AcquiredTerranScan"/>
              </actions>
            </cue>
            <cue name="Ch6_Force_Delay">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="10s"/>
              <actions>
                <!--<signal_cue cue="Setup_Bettyship_CoverOwner_Set"/>-->
                <signal_cue cue="Ch1_Setup_ResearchShip" check="false"/>

                <signal_cue cue="Ch5_Setup_BettyShip_Behaviour"/>
                <set_object_radar_visible object="$BettyShip" visible="true"/>
                <warp object="$BettyShip" sector="$Earth">
                  <safepos value="position.[0,0,0]"/>
                </warp>
                <set_known object="$Earth" known="true"/>
                <teleport_player object="$BettyShip" instant="true" force="true" control="false"/>

              </actions>
              <delay exact="2s"/>
              <actions>
                <set_object_radar_visible object="$ResearchShip" visible="true"/>
                <warp object="$ResearchShip" sector="$Earth">
                  <safepos value="position.[0,0,100km]"/>
                </warp>
                <signal_cue cue="Ch4_Setup_Align_ResearchShip" check="false"/>
                <force_cue cue="Ch6_Torus"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- Chapter 6:
              - Player breaks into the Torus
        -->

        <cue name="Ch6_Torus" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <precache_hint target="$EarthTorus"/>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <set_value name="$MissionCue" exact="namespace" comment="TODO: HACK"/>

            <create_mission comment="Mission: Torus Aeternal" group="missiongroup.story_terraforming"
                            name="{30224,6001}" description="{30224,6002}" rewardtext="{30224,6020}"
                            icon="'briefing_kuromanckami_01'" iconcaption="$YakiScientistActor.name"
                            faction="faction.pioneers" difficulty="level.medium"
                            cue="$MissionCue" abortable="false" type="missiontype.plot">
              <briefing>
                <objective step="$ObjectiveStep" action="objective.explore" object="$EarthTorus"/>
              </briefing>
            </create_mission>

            <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>

            <!-- Reset Ch5 Hostility if we made it -->
            <create_group groupname="$terranHostileShips_ResetRelation"/>
            <do_if value="$terranHostileShips?">
              <do_for_each in="$terranHostileShips" name="$ship">
                <reset_relation_boost object="$ship" otherobject="$BettyShip"/>
                <add_to_group groupname="$terranHostileShips_ResetRelation" object="$ship"/>
                <do_for_each in="$ship.subordinates" name="$subordinate" comment="workaround, request relation boost for subordinates">
                  <reset_relation_boost object="$subordinate" otherobject="$BettyShip"/>
                  <do_for_each in="$subordinate.subordinates" name="$sub_subordinate">
                    <reset_relation_boost object="$sub_subordinate" otherobject="$BettyShip"/>
                    <do_for_each in="$sub_subordinate.subordinates" name="$sub_sub_subordinate">
                      <reset_relation_boost object="$sub_sub_subordinate" otherobject="$BettyShip"/>
                    </do_for_each>
                  </do_for_each>
                </do_for_each>
              </do_for_each>
            </do_if>
          </actions>
          <patch sinceversion="2" state="cancelled">
            <!-- Reset Ch5 Hostility if we made it -->
            <create_group groupname="$terranHostileShips_ResetRelation"/>
            <do_if value="$terranHostileShips?">
              <do_for_each in="$terranHostileShips" name="$ship">
                <reset_relation_boost object="$ship" otherobject="$BettyShip"/>
                <add_to_group groupname="$terranHostileShips_ResetRelation" object="$ship"/>
                <do_for_each in="$ship.subordinates" name="$subordinate" comment="workaround, request relation boost for subordinates">
                  <reset_relation_boost object="$subordinate" otherobject="$BettyShip"/>
                  <do_for_each in="$subordinate.subordinates" name="$sub_subordinate">
                    <reset_relation_boost object="$sub_subordinate" otherobject="$BettyShip"/>
                    <do_for_each in="$sub_subordinate.subordinates" name="$sub_sub_subordinate">
                      <reset_relation_boost object="$sub_sub_subordinate" otherobject="$BettyShip"/>
                    </do_for_each>
                  </do_for_each>
                </do_for_each>
              </do_for_each>
            </do_if>
          </patch>
          <patch sinceversion="2" state="complete">
            <!-- Reset Ch5 Hostility if we made it -->
            <create_group groupname="$terranHostileShips_ResetRelation"/>
            <do_if value="$terranHostileShips?">
              <do_for_each in="$terranHostileShips" name="$ship">
                <reset_relation_boost object="$ship" otherobject="$BettyShip"/>
                <add_to_group groupname="$terranHostileShips_ResetRelation" object="$ship"/>
                <do_for_each in="$ship.subordinates" name="$subordinate" comment="workaround, request relation boost for subordinates">
                  <reset_relation_boost object="$subordinate" otherobject="$BettyShip"/>
                  <do_for_each in="$subordinate.subordinates" name="$sub_subordinate">
                    <reset_relation_boost object="$sub_subordinate" otherobject="$BettyShip"/>
                    <do_for_each in="$sub_subordinate.subordinates" name="$sub_sub_subordinate">
                      <reset_relation_boost object="$sub_sub_subordinate" otherobject="$BettyShip"/>
                    </do_for_each>
                  </do_for_each>
                </do_for_each>
              </do_for_each>
            </do_if>
          </patch>
          <cues>

            <!--<cue name="Debug_Ch6_Open_All_Doors">
              <actions>
                <find_object_component name="$EarthTorusDoorControls_01" groupname="$EarthTorus_DebugSwitches" object="$EarthTorus"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_1" required="true"/>

                <find_object_component name="$EarthTorusDoorControls_02" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_2" required="true" comment="First airlock control"/>
                <find_object_component name="$EarthTorusDoorControls_03" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_3" required="true" comment="Second airlock control"/>
                <find_object_component name="$EarthTorusDoorControls_19" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_19" required="true" comment="Auto-opening maintenance door"/>
                <find_object_component name="$EarthTorusDoorControls_04" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_4" required="true" comment="Sphere control (visible when you enter)"/>
                <find_object_component name="$EarthTorusDoorControls_05" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_5" required="true" comment="Sphere control (90 ccw from entry)"/>
                <find_object_component name="$EarthTorusDoorControls_06" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_6" required="true" comment="Sphere control (180 ccw from entry (opposite from where you enter)"/>
                <find_object_component name="$EarthTorusDoorControls_07" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_7" required="true" comment="Sphere control (270 ccw from entry"/>
                <find_object_component name="$EarthTorusDoorControls_08" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_8" required="true" comment="Opens maintenance entry for 2nd airlock"/>
                <find_object_component name="$EarthTorusDoorControls_09" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_9" required="true" comment="Opens door for 2nd airlock"/>
                <find_object_component name="$EarthTorusDoorControls_10" object="$EarthTorus" groupname="$EarthTorus_DebugSwitches"
                                       macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_10" required="true" comment="Opens door to exit the battle-room"/>
              </actions>
              <cues>
                <cue name="Set_8" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_for_each in="$EarthTorus_DebugSwitches" name="$switch">
                      <set_object_min_hull object="$EarthTorusDoorControls_01" exact="8"/>
                      <set_object_hull object="$EarthTorusDoorControls_01" exact="8"/>
                    </do_for_each>
                  </actions>
                </cue>
                <cue name="Set_100" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_for_each in="$EarthTorus_DebugSwitches" name="$switch">
                      <set_object_hull object="$EarthTorusDoorControls_01" exact="100"/>
                    </do_for_each>
                  </actions>
                </cue>

              </cues>
            </cue>-->

            <!--<cue name="Ch6_DrainShield" checkinterval="3s" instantiate="true">
              <conditions>
                <check_value value="$EarthTorus.distanceto.{$BettyShip} le 15km"/>
              </conditions>
              <actions>
                <set_object_shield object="$BettyShip" exact="0"/>
              </actions>
            </cue>-->

            <cue name="Ch6_Abort_TravelDrive" instantiate="true">
              <conditions>
                <check_any>
                  <event_player_travelmode_charge_started/>
                  <event_player_travelmode_started/>
                  <event_player_boost_charging_started/>
                  <event_player_boost_started/>
                </check_any>
                <check_value value="player.ship == $BettyShip"/>
                <check_value value="$EarthTorus.distanceto.{$BettyShip} le 15km"/>
              </conditions>
              <actions>
                <find_object_component name="$Engines" object="$BettyShip" class="[class.engine]" multiple="true"/>
                <do_if value="$Engines.{1}.travel.active">
                  <force_player_speed speed="$BettyShip.maxspeed"/>
                  <debug_text text="'Aborting Travel Drive near the Torus'" chance="$DebugChance"/>
                  <signal_cue_instantly cue="Ch6_Hint_BettyShip_CommandRejected" param="'TravelDrive'"/>
                </do_if>
                <do_if value="($Engines.{1}.boost.active) or ($Engines.{2}.boost.active)">
                  <stop_boost object="$BettyShip"/>
                  <signal_cue_instantly cue="Ch6_Hint_BettyShip_CommandRejected" param="'Boost'"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Ch6_Hint_BettyShip_CommandRejected" instantiate="true">
              <conditions>
                <event_cue_signalled/>
                <check_value value="not $CommandRejected?"/>
              </conditions>
              <actions>
                <set_value name="$CommandRejected"/>

                <set_value name="$AbortingLine" exact="30224658"/>
                <do_if value="event.param == 'Boost'">
                  <set_value name="$AbortingLine" exact="30224725"/>
                </do_if>
              </actions>
              <cues>
                <cue name="Ch6_Hint_BettyShip_CommandRejected_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BettyActor"/>
                  <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                  <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                  <param name="Lines"             value="[[133], [$AbortingLine]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="Ch6_Hint_BettyShip_CommandRejected_Reset"/>
                  <!--
                    <t id="30224658">Travel Mode aborted.(same as {1015,171})</t>
                    <t id="30224725">Boost aborted.("Boost" same as {10190,4007})</t>
                    <t id="133">Command rejected.</t>
                    <t id="135">Cancelled.</t> 
                    <t id="30224652">Computing at capacity.</t>
                    <t id="252">Insufficient energy.</t>
                          -->
                </cue>
                <cue name="Ch6_Hint_BettyShip_CommandRejected_Reset">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="5s"/>
                  <actions>
                    <remove_value name="$CommandRejected"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Setup" version="2">
              <actions>
                <find_object_component name="$EarthTorusMarker_01" groupname="$EarthTorusMarkers1_temp" object="$EarthTorus" macro="macro.positiondummy1_macro"  required="true" comment="real entrance"/>
                <find_object_component name="$EarthTorusMarker_02"                                      object="$EarthTorus" macro="macro.positiondummy2_macro"  required="true" comment="hallway1"/>
                <find_object_component name="$EarthTorusMarker_03"                                      object="$EarthTorus" macro="macro.positiondummy3_macro"  required="true" comment="hallway1"/>
                <find_object_component name="$EarthTorusMarker_04"                                      object="$EarthTorus" macro="macro.positiondummy4_macro"  required="true" comment="circleswitch-room"/>
                <find_object_component name="$EarthTorusMarker_05"                                      object="$EarthTorus" macro="macro.positiondummy5_macro"  required="true" comment="hallway2"/>
                <find_object_component name="$EarthTorusMarker_06"                                      object="$EarthTorus" macro="macro.positiondummy6_macro"  required="true" comment="hallway2"/>
                <find_object_component name="$EarthTorusMarker_07"                                      object="$EarthTorus" macro="macro.positiondummy7_macro"  required="true" comment="hallway2"/>
                <find_object_component name="$EarthTorusMarker_08"                                      object="$EarthTorus" macro="macro.positiondummy8_macro"  required="true" comment="room2"/>
                <find_object_component name="$EarthTorusMarker_09"                                      object="$EarthTorus" macro="macro.positiondummy9_macro"  required="true" comment="room2"/>
                <find_object_component name="$EarthTorusMarker_10"                                      object="$EarthTorus" macro="macro.positiondummy10_macro" required="true" comment="room3"/>
                <find_object_component name="$EarthTorusMarker_11"                                      object="$EarthTorus" macro="macro.positiondummy11_macro" required="true" comment="room3"/>
                <find_object_component name="$EarthTorusMarker_12"                                      object="$EarthTorus" macro="macro.positiondummy12_macro" required="true" comment="room3"/>
                <find_object_component name="$EarthTorusMarker_13"                                      object="$EarthTorus" macro="macro.positiondummy13_macro" required="true" comment="exit"/>
                <find_object_component name="$EarthTorusMarker_14"                                      object="$EarthTorus" macro="macro.positiondummy14_macro" required="true" comment="behind 2nd door"/>
                <find_object_component name="$EarthTorusMarker_15" groupname="$EarthTorusMarkers1_temp" object="$EarthTorus" macro="macro.positiondummy15_macro" required="true" comment="dead entrance"/>
                <find_object_component name="$EarthTorusMarker_16" groupname="$EarthTorusMarkers1_temp" object="$EarthTorus" macro="macro.positiondummy16_macro" required="true" comment="dead entrance"/>
                <find_object_component name="$EarthTorusMarker_17" groupname="$EarthTorusMarkers1_temp" object="$EarthTorus" macro="macro.positiondummy17_macro" required="true" comment="dead entrance"/>
                <find_object_component name="$EarthTorusMarker_18"                                      object="$EarthTorus" macro="macro.positiondummy18_macro" required="true" comment="one-but-last hallway (near exit)"/>
                <find_object_component name="$EarthTorusMarker_19"                                      object="$EarthTorus" macro="macro.positiondummy19_macro" required="true" comment="last hallway (exit)"/>
                <find_object_component name="$EarthTorusMarker_20"                                      object="$EarthTorus" macro="macro.positiondummy20_macro" required="true" comment="center hallway1"/>
                <find_object_component name="$EarthTorusMarker_21"                                      object="$EarthTorus" macro="macro.positiondummy21_macro" required="true" comment="Outside torus exit"/>
              </actions>
              <patch sinceversion="2">
                <find_object_component name="$EarthTorusMarker_21"                                      object="$EarthTorus" macro="macro.positiondummy21_macro" required="true" comment="Outside torus exit"/>
              </patch>
            </cue>

            <cue name="Ch6_WarpOwl_Fix" onfail="cancel" comment="special case fix">
              <conditions>
                <check_value value="$EarthTorus.exists and player.ship.exists and (player.sector == $EarthTorus.sector)"/>
              </conditions>
              <actions>
                <!--create_position name="$OwlPos" space="$EarthTorus" object="player.ship" /-->
                <create_position name="$OwlPos" x="-7760.572266m" y="437.635986m" z=" -389.948242m"/>
                <do_if value="player.ship.distanceto.[$EarthTorus, $OwlPos] lt 1m and (Ch6_7_DataDownload.state == cuestate.complete) and (Ch6_8_EscapeTunnel.state == cuestate.waiting)">
                  <warp object="$BettyShip" sector="$Earth">
                    <position object="$EarthTorusMarker_10" comment="Turret room complete, warp to entrance riddle-room"/>
                    <rotation yaw="-90deg" pitch="0deg"/>
                  </warp>
                  <set_playership_throttle value="0" comment="stop to avoid crashing"/>
                  <force_player_speed speed="0"/>
                  <stop_player_autopilot/>
                </do_if>
              </actions>
            </cue>

            <cue name="Ch6_WarpOwl" checkinterval="10s" instantiate="true">
              <conditions>
                <check_value value="$BettyShip.distanceto.{$EarthTorus} gt 20km"/>
                <check_value value="$BettyShip.sector == $EarthTorus.sector"/>
                <check_value value="not $BettyShip.dock"/>
              </conditions>
              <actions>
                <include_actions ref="Ch6_WarpOwl_Library"/>
              </actions>
            </cue>

            <cue name="Ch6_WarpOwl_ResetOnTeleport" instantiate="true">
              <!-- If the Owl ship is not actually cut off from the puzzle, this will not be detected and it will be warped regardless -->
              <!-- If the player is close enough to dock but teleports instead, the Owl will not(?) be warped -->
              <conditions>
                <event_object_changed_object object="player.entity"/>
                <check_any>
                  <check_all>
                    <!-- Reset Owl Position if: Player teleports into anything except Spacesuit/BettyShip -->
                    <check_value value="not event.param.isclass.spacesuit"/>
                    <check_value value="event.param != $BettyShip"/>
                  </check_all>
                  <!-- Reset Owl Position if: Player teleports into BettyShip from anything except Spacesuit,
                                 we don't need the reverse case as you cannot teleport out of the cover ship -->
                  <check_all>
                    <check_value value="event.param == $BettyShip"/>
                    <check_value value="not event.param2.isclass.spacesuit"/>
                  </check_all>
                  <check_all>
                    <!-- Reset Owl Position if: Player teleports from Spacesuit into BettyShip but is not in docking range-->
                    <check_value value="event.param == $BettyShip"/>
                    <check_value value="event.param2.isclass.spacesuit"/>
                    <check_value value="not ($BettyShip_DistanceTo_PlayerSuit le (($SpaceSuitMaxSpeed / 10) + 10m))" comment="check if NOT in docking range, boost.maxspeed / 10 as we check every 0.1s; 10m as the docking for the Moreya happened at about 7m"/>
                  </check_all>
                </check_any>
              </conditions>
              <actions>
                <do_if value="not $Ch6_WarpOwl_ResetOnTeleport?">
                  <set_value name="$Ch6_WarpOwl_ResetOnTeleport" exact="0"/>
                </do_if>
                <set_value name="$Ch6_WarpOwl_ResetOnTeleport" exact="1" operation="add"/>
                <debug_text text="'Teleport detected'" chance="$DebugChance"/>
                <include_actions ref="Ch6_WarpOwl_Library"/>
              </actions>
            </cue>

            <cue name="BettyShip_DistanceTo_PlayerSpaceSuit" checkinterval="0.1s" instantiate="true">
              <conditions>
                <check_value value="player.sector == $BettyShip.sector"/>
                <check_value value="player.ship.isclass.spacesuit"/>
              </conditions>
              <actions>
                <set_value name="$SpaceSuitMaxSpeed" exact="player.ship.boost.maxspeed"/>
                <set_value name="$BettyShip_DistanceTo_PlayerSuit" exact="$BettyShip.distanceto.{player.ship}"/>
              </actions>
            </cue>

            <library name="Ch6_WarpOwl_Library">
              <actions>
                <set_value name="this.$warped" exact="false"/>
                <do_if value="$BettyShip.dock">
                  <!-- don't teleport if Owl is docked; Errorous behaviour (ship pushed around) -->
                </do_if>
                <do_elseif value="Ch6_8_EscapeTunnel.state == cuestate.complete">
                  <warp object="$BettyShip" sector="$Earth">
                    <position object="$EarthTorusMarker_11" comment="Riddle room complete, warp facing escape hallway"/>
                    <rotation yaw="-90deg" pitch="0deg"/>
                  </warp>
                  <set_value name="this.$warped" exact="true"/>
                </do_elseif>
                <do_elseif value="Ch6_7_DataDownload.state == cuestate.complete">
                  <warp object="$BettyShip" sector="$Earth">
                    <position object="$EarthTorusMarker_10" comment="Turret room complete, warp to entrance riddle-room"/>
                    <rotation yaw="-90deg" pitch="0deg"/>
                  </warp>
                  <set_value name="this.$warped" exact="true"/>
                </do_elseif>
                <do_elseif value="Ch6_6_TurretRoom.state == cuestate.complete">
                  <warp object="$BettyShip" sector="$Earth">
                    <position object="$EarthTorusMarker_07" comment="Second airlock complete, warp to downward entrance into turret room"/>
                    <rotation yaw="0deg" pitch="-45deg"/>
                  </warp>
                  <set_value name="this.$warped" exact="true"/>
                </do_elseif>
                <do_elseif value="Ch6_5_Airlock2.state == cuestate.complete">
                  <warp object="$BettyShip" sector="$Earth">
                    <position object="$EarthTorusMarker_04" comment="Roundroom complete, warp to roundroom but facing exit hallway"/>
                    <rotation yaw="-90deg" pitch="0deg"/>
                  </warp>
                  <set_value name="this.$warped" exact="true"/>
                </do_elseif>
                <do_elseif value="Ch6_4_Sphere.state == cuestate.complete">
                  <warp object="$BettyShip" sector="$Earth">
                    <position object="$EarthTorusMarker_04" comment="Airlock riddle complete, warp to inside of round-room"/>
                    <rotation yaw="180deg" pitch="0deg"/>
                  </warp>
                  <set_value name="this.$warped" exact="true"/>
                </do_elseif>
                <do_elseif value="Ch6_3_AirLock.state == cuestate.complete">
                  <warp object="$BettyShip" sector="$Earth">
                    <position object="$EarthTorusMarker_20" comment="Just behind the entrance-door, facing the 'outer airlock' door"/>
                    <rotation yaw="180deg" pitch="0deg"/>
                  </warp>
                  <set_value name="this.$warped" exact="true"/>
                </do_elseif>
                <do_elseif value="Ch6_2_Entry.state == cuestate.complete">
                  <!-- no need to warp -->
                </do_elseif>

                <do_if value="this.$warped">
                  <debug_text text="'Warping Geometric Owl to fixed Torus Position'" chance="$DebugChance"/>
                  <set_playership_throttle value="0" comment="stop to avoid crashing"/>
                  <force_player_speed speed="0"/>
                  <stop_player_autopilot/>
                </do_if>
              </actions>
            </library>

            <cue name="Setup_Lights" comment="outside of the subchapters intentionally">
              <cues>

                <cue name="Ch6_1_Lights_Setup">
                  <actions>
                    <find_object_component name="$EarthTorusLight_001_pos" object="$EarthTorus" macro="macro.lightpositiondummy001_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_002_pos" object="$EarthTorus" macro="macro.lightpositiondummy002_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_003_pos" object="$EarthTorus" macro="macro.lightpositiondummy003_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_004_pos" object="$EarthTorus" macro="macro.lightpositiondummy004_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_005_pos" object="$EarthTorus" macro="macro.lightpositiondummy005_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_001" object="$EarthTorus" macro="macro.torus_switchlight001_macro" recursive="true" required="true" />
                    <find_object_component name="$EarthTorusLight_002" object="$EarthTorus" macro="macro.torus_switchlight002_macro" recursive="true" required="true" />
                    <find_object_component name="$EarthTorusLight_003" object="$EarthTorus" macro="macro.torus_switchlight003_macro" recursive="true" required="true" />
                    <find_object_component name="$EarthTorusLight_004" object="$EarthTorus" macro="macro.torus_switchlight004_macro" recursive="true" required="true" />
                    <find_object_component name="$EarthTorusLight_005" object="$EarthTorus" macro="macro.torus_switchlight005_macro" recursive="true" required="true" />
                    <!-- enable logic -->
                    <signal_cue_instantly cue="LightRandomFlicker" param="[$EarthTorusLight_001_pos, $EarthTorusLight_001, 0, 0]"/>
                    <signal_cue_instantly cue="LightRandomFlicker" param="[$EarthTorusLight_002_pos, $EarthTorusLight_002, 0, 0]"/>
                    <signal_cue_instantly cue="LightRandomFlicker" param="[$EarthTorusLight_003_pos, $EarthTorusLight_003, 0, 0]"/>
                    <signal_cue_instantly cue="LightRandomFlicker" param="[$EarthTorusLight_004_pos, $EarthTorusLight_004, 0, 0]"/>
                    <signal_cue_instantly cue="LightRandomFlicker" param="[$EarthTorusLight_005_pos, $EarthTorusLight_005, 0, 0]"/>
                  </actions>
                </cue>

                <cue name="Ch6_5_Lights_Setup">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_object_component name="$EarthTorusLight_006_pos"  object="$EarthTorus" macro="macro.lightpositiondummy006_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_007_pos"  object="$EarthTorus" macro="macro.lightpositiondummy007_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_008_pos"  object="$EarthTorus" macro="macro.lightpositiondummy008_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_009_pos"  object="$EarthTorus" macro="macro.lightpositiondummy009_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_010_pos"  object="$EarthTorus" macro="macro.lightpositiondummy010_macro" required="true"/>
                    <find_object_component name="$EarthTorusLight_006"      object="$EarthTorus" macro="macro.torus_switchlight006_macro" recursive="true" required="true" />
                    <find_object_component name="$EarthTorusLight_007"      object="$EarthTorus" macro="macro.torus_switchlight007_macro" recursive="true" required="true" />
                    <find_object_component name="$EarthTorusLight_008"      object="$EarthTorus" macro="macro.torus_switchlight008_macro" recursive="true" required="true" />
                    <find_object_component name="$EarthTorusLight_009"      object="$EarthTorus" macro="macro.torus_switchlight009_macro" recursive="true" required="true" />
                    <find_object_component name="$EarthTorusLight_010"      object="$EarthTorus" macro="macro.torus_switchlight010_macro" recursive="true" required="true" />
                    <!-- enable logic -->
                    <signal_cue_instantly cue="LightProximitySensor" param="[$EarthTorusLight_006_pos, $EarthTorusLight_006, 125m, 0]"/>
                    <signal_cue_instantly cue="LightProximitySensor" param="[$EarthTorusLight_007_pos, $EarthTorusLight_007, 125m, 0]"/>
                    <signal_cue_instantly cue="LightProximitySensor" param="[$EarthTorusLight_008_pos, $EarthTorusLight_008, 125m, 0]"/>
                    <signal_cue_instantly cue="LightProximitySensor" param="[$EarthTorusLight_009_pos, $EarthTorusLight_009, 125m, 0]"/>
                    <signal_cue_instantly cue="LightProximitySensor" param="[$EarthTorusLight_010_pos, $EarthTorusLight_010, 125m, 0]"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Lights">
              <cues>

                <cue name="LightProximitySensor" instantiate="true" namespace="this">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$LightPos" exact="event.param.{1}"/>
                    <set_value name="$Light" exact="event.param.{2}"/>
                    <set_value name="$LightRange" exact="event.param.{3}"/>
                    <set_value name="$LightNear" exact="false"/>
                    <do_if value="(player.entity) and (player.entity.distanceto.{$LightPos} le $LightRange)">
                      <trigger_animation object="$Light" trigger="activate"/>
                      <set_value name="$LightNear" exact="true"/>
                    </do_if>
                  </actions>
                  <cues>
                    <cue name="LightProximitySensor_Range" checkinterval="0.25s" instantiate="true">
                      <conditions>
                        <check_value value="(player.entity) and (player.entity.sector == $LightPos.sector)"/>
                      </conditions>
                      <actions>
                        <do_if value="$LightNear and player.entity.distanceto.{$LightPos} gt $LightRange">
                          <trigger_animation object="$Light" trigger="deactivate"/>
                          <set_value name="$LightNear" exact="false"/>
                        </do_if>
                        <do_elseif value="not $LightNear and player.entity.distanceto.{$LightPos} le $LightRange">
                          <trigger_animation object="$Light" trigger="activate"/>
                          <set_value name="$LightNear" exact="true"/>
                        </do_elseif>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="LightRandomFlicker" instantiate="true" namespace="this">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--set_value name="$LightPos" exact="event.param.{1}"/-->
                    <set_value name="this.$Light" exact="event.param.{2}"/>
                    <set_value name="this.$LightOn" exact="false"/>
                    <trigger_animation object="this.$Light" trigger="deactivate"/>
                  </actions>
                  <cues>
                    <cue name="LightRandomFlicker_Periodic">
                      <delay exact="[0.5s, 1.5s, 3s].random"/>
                      <actions>
                        <do_if value="parent.$LightOn">
                          <trigger_animation object="parent.$Light" trigger="deactivate"/>
                          <set_value name="parent.$LightOn" exact="false"/>
                        </do_if>
                        <do_else>
                          <trigger_animation object="parent.$Light" trigger="activate"/>
                          <set_value name="parent.$LightOn" exact="true"/>
                        </do_else>
                        <reset_cue cue="LightRandomFlicker_Periodic"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_1_Approach">
              <cues>

                <cue name="Ch6_1_ApproachTorus_Done">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_1_Hint_ApproachTorus_BettyComment" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224601], [30224605], [30224606]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch6_Mapping_Entries"/>
                      <!--
                      <t id="	30224601	">	Destination reached.	</t>
                      not used <t id="	30224602	">	Analysing.	</t>
                      <t id="	30224605	">	Analysing Torus Wreckage.	</t>
                      <t id="	30224606	">	Mapping possible entries.	</t>
                          -->
                    </cue>

                    <cue name="Ch6_Mapping_Entries">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$Mapping_Countdown" exact="$EarthTorusMarkers1_temp.count"/>

                        <do_for_each in="$EarthTorusMarkers1_temp" name="$e">
                          <signal_cue_instantly cue="Ch6_Map_Entry" param="$e"/>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="Ch6_Map_Entry" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay min="10s" max="25s"/>
                      <actions>
                        <add_to_group groupname="$EarthTorusMarkers1" object="event.param"/>

                        <set_objective cue="$MissionCue" offset="position.[0,0,0]" step="$ObjectiveStep" action="objective.explore" text="{30224,6011}" group="$EarthTorusMarkers1" comment="detailed locations when in earth-sector" updatebriefing="true"/>

                        <set_value name="$Mapping_Countdown" exact="1" operation="subtract"/>
                        <do_if value="$Mapping_Countdown == 0">
                          <signal_cue cue="Ch6_Hint_Betty_Entries_Completed"/>
                        </do_if>
                      </actions>

                    </cue>

                    <cue name="Ch6_Hint_Betty_Entries_Completed">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Hint_Betty_Entries_Completed_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224607]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--<t id="	30224607	">	{10002,30224620}(Mapping) completed.	</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>


                <!-- We know we are at the torus at the start of the chapter, but players can fly away, and guidance set to a group (when sectors away) is not very performant on the map. -->
                <cue name="Ch6_1_Approach_Sector" instantiate="true" comment="">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_changed_sector object="player.entity" sector="$Earth"/>
                      <event_object_changed_sector object="player.entity" previous="$Earth"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.param == $Earth">
                      <do_if value="Ch6_1_ApproachTorus_Done.state == cuestate.complete" comment="already gave the Approach-Torus dialog, immediate objective-update when entering earth">
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.explore" text="{30224,6011}" group="$EarthTorusMarkers1" comment="detailed locations when in earth-sector" updatebriefing="true"/>
                      </do_if>
                    </do_if>
                    <do_else>
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.explore" text="{30224,6011}" object="$EarthTorus" comment="point to torus when not in earth-sector" updatebriefing="true"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch6_1_Approach_Cutscene" checkinterval="5s">
                  <conditions>
                    <check_value value="(player.entity.sector == $EarthTorus.sector) and (player.entity.distanceto.{$EarthTorus} lt 75km)"/>
                  </conditions>
                  <actions>
                    <append_to_list name="md.$MissionDND" exact="Ch6_1_Approach_Cutscene"/>
                    <play_cutscene result="this.$CutsceneID" key="'Story_Terraforming_Torus_1'">
                      <param name="torus" object="$EarthTorus"/>
                      <param name="target1" object="$EarthTorusMarker_16"/>
                      <param name="target2" object="$EarthTorusMarker_15"/>
                      <param name="target3" object="$EarthTorusMarker_01"/>
                      <param name="target4" object="$EarthTorusMarker_17"/>
                    </play_cutscene>
                  </actions>
                  <cues>

                    <cue name="Ch6_1_Approach_Cutscene_Started">
                      <conditions>
                        <event_cutscene_started cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <actions>
                        <set_playership_throttle value="0" comment="stop (to avoid crashing while cutscene plays)"/>
                        <force_player_speed speed="0"/>
                        <stop_player_autopilot/>
                      </actions>
                      <delay exact="2s"/>
                      <actions>
                        <speak actor="$YakiScientistActor" priority="100" >
                          <text line="30224601"/>
                          <text line="30224602" delay="3s"/>
                          <text line="30224603" delay="7s"/>
                        </speak>
                        <!--
                          <t id="	30224	601	">	Behold this miniscule shard of Terran hybris.	</t>
                          <t id="	30224	602	">	We will excavate your secrets and leave more adept on the technology of the Terraformers.(addressing station)	</t>
                          <t id="	30224	603	">	I do wonder if they are still capable of their ancestral deeds.	</t>                          
                        -->
                      </actions>
                    </cue>

                    <cue name="Ch6_1_Approach_Cutscene_EndCutscene">
                      <conditions>
                        <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <actions>
                        <remove_from_list name="md.$MissionDND" exact="Ch6_1_Approach_Cutscene"/>
                        <signal_cue cue="Ch6_1_ApproachTorus_Done"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_1_Approach_Entrances">
                  <cues>
                    <!-- Distance-checks and handlers for approaching each of the entrances -->
                    <cue name="Ch6_1_Entrance1" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$EarthTorusMarker_01"/>
                      <param name="ApproachDistance"  value="750m"/>
                      <param name="SuccessSignalCue"  value="Ch6_1_Entry_Approach_Correct"/>
                    </cue>
                    <cue name="Ch6_1_Entrance2" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$EarthTorusMarker_15"/>
                      <param name="ApproachDistance"  value="750m"/>
                      <param name="SuccessSignalCue"  value="Ch6_1_Entry15_Approach"/>
                    </cue>
                    <cue name="Ch6_1_Entrance3" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$EarthTorusMarker_16"/>
                      <param name="ApproachDistance"  value="750m"/>
                      <param name="SuccessSignalCue"  value="Ch6_1_Entry16_Approach"/>
                    </cue>
                    <cue name="Ch6_1_Entrance4" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$EarthTorusMarker_17"/>
                      <param name="ApproachDistance"  value="750m"/>
                      <param name="SuccessSignalCue"  value="Ch6_1_Entry17_Approach"/>
                    </cue>

                    <cue name="Ch6_1_Entry_Approach_Wrong" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="this.$ApproachTarget" exact="event.param"/>
                        <do_if value="this.$ApproachTarget == $EarthTorusMarker_15">
                          <set_value name="this.$Speaks" exact="[[30224610], [30224611]]"/>
                        </do_if>
                        <do_elseif value="this.$ApproachTarget == $EarthTorusMarker_16">
                          <set_value name="this.$Speaks" exact="[[30224610], [30224611]]"/>
                        </do_elseif>
                        <do_elseif value="this.$ApproachTarget == $EarthTorusMarker_17">
                          <set_value name="this.$Speaks" exact="[[30224610], [30224611]]"/>
                        </do_elseif>
                        <!--
                        <t id="	30224	610	">	Possible entry eliminated.	</t>
                        <t id="	30224	611	">	Updating.	</t>
                        -->
                      </actions>
                      <cues>
                        <cue name="Ch6_1_Entry_Approach_Wrong_Betty" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="parent.$Speaks"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_1_Entry_Approach_Wrong_UpdateObjective"/>
                        </cue>
                        <cue name="Ch6_1_Entry_Approach_Wrong_UpdateObjective">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch6_1_Approach_Wrong_Yaki_Lines"/>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <remove_from_group group="$EarthTorusMarkers1" object="parent.$ApproachTarget"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.explore" text="{30224,6011}" group="$EarthTorusMarkers1" comment="detailed locations when in earth-sector"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_1_Approach_Wrong_Yaki_Lines">
                          <conditions>
                            <event_cue_signalled/>
                            <check_value value="parent.$ApproachTarget == $EarthTorusMarker_16"/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_1_Approach_Wrong_Yaki_Lines_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$YakiScientistActor"/>
                              <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                              <param name="Lines"             value="[[30224641],[30224642]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                            </cue>
                            <!-- <t id="30224641">This door is sealed shut. There must have been some hasty repairs during segment-separation.</t>
                             <t id="30224642">Find another entry.</t>
                            -->
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_1_Entry15_Approach">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="this.$DoorsOpen" exact="false"/>
                        <set_value name="this.$ApproachTarget" exact="event.param"/>
                        <find_object_component name="$EarthTorusDoorControls_30" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_30" required="true"/>
                        <find_object_component name="$EarthTorusTurrets15" object="$EarthTorus" groupname="$EarthTorusTurrets15Group" grouptag="tag.group02" multiple="true" required="true" comment="all turrets in entry 15 hallway"/>
                      </actions>
                      <cues>

                        <cue name="Ch6_1_Entry15_Hostile" checkinterval="1s" instantiate="true">
                          <conditions>
                            <check_value value="(player.sector == $EarthTorus.sector) and $EarthTorusTurrets15.count"/>
                            <!--check_any>
                              <check_value value="(player.sector == $EarthTorus.sector) and (player.entity.distanceto.{$EarthTorusTurrets15.{$i}} lt 1000m)"/>
                            </check_any-->
                          </conditions>
                          <actions>
                            <set_value name="this.$nearnone" exact="true"/>
                            <do_for_each name="$Turret" in="$EarthTorusTurrets15">
                              <do_if value="not $Turret.exists">
                                <continue/>
                              </do_if>
                              <do_if value="(player.entity.distanceto.{$Turret} lt 1000m)">
                                <set_relation_boost object="$EarthTorus" faction="faction.player" value="-1.0" decay="0" comment="torus needs to be hostile, otherwise it will prevent turrets from firing at a friendly"/>
                                <set_relation_boost object="$EarthTorus" otherobject="$BettyShip" value="-1.0" decay="0"/>
                                <set_relation_boost object="$Turret" faction="faction.player" value="-1.0" decay="0"/>
                                <set_relation_boost object="$Turret" otherobject="$BettyShip" value="-1.0" decay="0"/>
                                <set_turret_targets object="$EarthTorus" target="[$BettyShip, player.entity.ship]" weaponmode="weaponmode.any" />
                                <set_value name="this.$nearnone" exact="false"/>
                                <signal_cue cue="Ch6_1_Torus_Intruder" check="false"/>
                              </do_if>
                            </do_for_each>
                            <do_if value="this.$nearnone">
                              <do_if value="Ch6_6_TurretRoom.state == cuestate.waiting">
                                <set_relation_boost object="$EarthTorus" faction="faction.player" value="0.0" decay="0" comment="torus back to neutral"/>
                                <set_relation_boost object="$EarthTorus" otherobject="$BettyShip" value="0.0" decay="0" comment="back to neutral"/>
                              </do_if>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Ch6_1_Torus_Intruder">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_1_Torus_Intruder_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$TorusActor"/>
                              <param name="Cutscene"          value="true"/>
                              <param name="CutsceneKey"       value="$TorusActorCutsceneKey"/>
                              <param name="Lines"             value="[[30224004]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="Ch6_1_Hint_Betty_Proximity_Alert"/>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch6_1_Hint_Betty_Proximity_Alert">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_1_Hint_Betty_Proximity_Alert_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$BettyActor"/>
                              <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                              <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                              <param name="Lines"             value="[[30224520], [30224640]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <!--<t id="	30224520	">	Proximity Alert	</t>
                          <t id="	30224640	">	{10002,505}(Hostiles detected.)	</t>-->
                              <param name="EndSignalCue"      value="Ch6_1_Entry15_Switch"/>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch6_1_Entry15_AutoDoor_Open" checkinterval="1s" instantiate="true">
                          <conditions>
                            <check_value value="(player.sector == $EarthTorus.sector) and (player.entity.distanceto.{$EarthTorusMarker_15} lt 180m)"/>
                            <check_value value="not parent.$DoorsOpen"/>
                          </conditions>
                          <actions>
                            <set_value name="parent.$DoorsOpen" exact="true"/>
                            <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_20" trigger="open_doors" /-->
                            <trigger_animation object="$EarthTorus" trigger="open_doors" />
                          </actions>
                        </cue>
                        <cue name="Ch6_1_Entry15_AutoDoor_Close" checkinterval="1s" instantiate="true">
                          <conditions>
                            <check_value value="(player.sector == $EarthTorus.sector) and (player.entity.distanceto.{$EarthTorusMarker_15} ge 180m)"/>
                            <check_value value="parent.$DoorsOpen"/>
                          </conditions>
                          <actions>
                            <set_value name="parent.$DoorsOpen" exact="false"/>
                            <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_20" trigger="close_doors"/-->
                            <trigger_animation object="$EarthTorus" trigger="close_doors"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_1_Entry15_Switch">
                          <conditions>
                            <event_cue_signalled/>
                            <!--<event_object_hull_below_function_threshold object="$EarthTorusDoorControls_30" check="false"/>-->
                          </conditions>
                          <delay exact="4s"/>
                          <actions>
                            <signal_cue_instantly cue="Ch6_1_Entry_Approach_Wrong" param="parent.$ApproachTarget"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>


                    <cue name="Ch6_1_Entry16_Approach">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="this.$ApproachTarget" exact="event.param"/>
                        <signal_cue_instantly cue="Ch6_1_Entry_Approach_Wrong" param="this.$ApproachTarget"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_1_Entry17_Approach">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="this.$DoorsOpen" exact="false"/>
                        <set_value name="this.$ApproachTarget" exact="event.param"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_1_Entry17_AutoDoor_Open" checkinterval="1s" instantiate="true">
                          <conditions>
                            <check_value value="(player.sector == $EarthTorus.sector) and (player.entity.distanceto.{$EarthTorusMarker_17} lt 30m)"/>
                            <check_value value="not parent.$DoorsOpen"/>
                          </conditions>
                          <actions>
                            <set_value name="parent.$DoorsOpen" exact="true"/>
                            <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_19"  trigger="open_doors2" /-->
                            <trigger_animation object="$EarthTorus" trigger="open_doors2" />
                          </actions>
                          <delay exact="3s"/>
                          <actions>
                            <do_if value="not parent.$WrongEntry17Eliminated?">
                              <set_value name="parent.$WrongEntry17Eliminated"/>
                              <signal_cue_instantly cue="Ch6_1_Entry_Approach_Wrong" param="parent.$ApproachTarget"/>
                            </do_if>
                          </actions>
                        </cue>
                        <cue name="Ch6_1_Entry17_AutoDoor_Close" checkinterval="1s" instantiate="true">
                          <conditions>
                            <check_value value="(player.sector == $EarthTorus.sector) and (player.entity.distanceto.{$EarthTorusMarker_17} ge 30m)"/>
                            <check_value value="parent.$DoorsOpen"/>
                          </conditions>
                          <actions>
                            <set_value name="parent.$DoorsOpen" exact="false"/>
                            <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_19"  trigger="close_doors2"/-->
                            <trigger_animation object="$EarthTorus" trigger="close_doors2"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_1_Entry_Approach_Correct">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- only keep correct entry in the $EarthTorusMarkers1-group (could clear it and add the correct one) -->
                        <remove_from_group group="$EarthTorusMarkers1"  object="$EarthTorusMarker_15"/>
                        <remove_from_group group="$EarthTorusMarkers1"  object="$EarthTorusMarker_16"/>
                        <remove_from_group group="$EarthTorusMarkers1"  object="$EarthTorusMarker_17"/>
                        <cancel_cue cue="Ch6_1_Approach_Sector"/>
                        <cancel_cue cue="Ch6_1_Entry_Approach_Wrong"/>
                      </actions>
                      <cues>

                        <!--cue name="Ch6_1_Entry_Approach_Correct_Yaki" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224602]]"/>
                          <param name="EndSignalCue"      value="Ch6_3_AirLock_Hint_Done"/>
                        </cue-->

                        <cue name="Ch6_1_Entry_Approach_Correct_Betty" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224613], [30224616, 0.5s]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_Hint_Yaki_Assistance"/>
                          <!--
                            <t id="30224613">\033MPossible entry confirmed.</t>                            
                            <t id="30224616">\033MAwaiting breach.</t>
                            -->
                        </cue>

                        <cue name="Ch6_Hint_Yaki_Assistance">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_Hint_Yaki_Assistance_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$YakiScientistActor"/>
                              <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                              <param name="Lines"             value="[[30224604], [30224605, 1s]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="Ch6_1_Complete" />
                              <!--
                              <t id="	30224604	">	Your colleague is requesting your assistance.	</t>
                              <t id="	30224605	">	Enter the structure in your space suit and try opening that door to let the both of you in.	</t>
                          -->
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch6_1_Complete">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_2_Entry"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_2_Entry" version="2" >
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_object_component name="$EarthTorusDoorControls_01" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_1" required="true"/>
                <set_object_min_hull object="$EarthTorusDoorControls_01" exact="$SwitchHullMin" comment="indestructible at 100 from gamestart, now allow players to switch it (but not destroy it)"/>
                <find_object_component name="$EarthTorusDoorControls_19" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_19" required="true" comment="Auto-opening maintenance door"/>

                <!-- find all door controls-->
                <find_object_component name="$EarthTorusDoorControlsList" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" multiple="true" required="true"/>
                <add_to_group groupname="$EarthTorusDoorControlsGroup" list="$EarthTorusDoorControlsList"/>

                <!-- objective -->
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30224,6012}" object="$EarthTorusMarker_01" radius="500m" updatebriefing="true" comment="pointing to the half-closed door"/>

              </actions>
              <patch sinceversion="2">
                <find_object_component name="$EarthTorusDoorControls_19" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_19" required="true" comment="Auto-opening maintenance door"/>
              </patch>
              <cues>

                <cue name="Ch6_2_EntryInRange_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="player.entity"/>
                  <param name="ApproachTarget"    value="$EarthTorusMarker_01"/>
                  <param name="ApproachDistance"  value="200m"/>
                  <param name="SuccessSignalCue"  value="Ch6_2_SpaceSuitObjective"/>
                </cue>

                <cue name="Ch6_2_SpaceSuitObjective">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="not $Scheduled_Ch6_2_Entry_Hint_Speak?"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_2_Entry_Objective"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_2_EntryOutOfRange_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="player.entity"/>
                      <param name="ApproachTarget"    value="$EarthTorusMarker_01"/>
                      <param name="ApproachDistance"  value="500m"/>
                      <param name="SuccessSignalCue"  value="Ch6_2_SpaceSuitObjective_Reset"/>
                      <param name="Invert"            value="true"/>
                    </cue>

                    <cue name="Ch6_2_SpaceSuitObjective_Reset">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Scheduled_Ch6_2_Entry_Hint_Speak?"/>
                      </conditions>
                      <actions>
                        <reset_cue cue="parent"/>
                        <reset_cue cue="Ch6_2_EntryInRange_Ref"/>
                        <signal_cue cue="Ch6_2_Entry_Objective"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_2_Entry_Objective" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <check_all>
                        <event_player_teleport_successful/>
                        <check_value value="@player.controlled.isclass.spacesuit"/>
                      </check_all>
                    </check_any>
                    <check_value value="not $Scheduled_Ch6_2_Entry_Hint_Speak?"/>
                  </conditions>
                  <actions>
                    <do_if value="player.entity.distanceto.{$EarthTorusMarker_01} gt 500m">
                      <!-- Get into the area -->
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30224,6012}" object="$EarthTorusMarker_01" radius="500m" updatebriefing="true" comment="pointing to the half-closed door"/>
                    </do_if>
                    <do_else>
                      <do_if value="@player.controlled.isclass.spacesuit">
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30224,6012}" object="$EarthTorusMarker_01" radius="500m" updatebriefing="true" comment="pointing to the half-closed door"/>
                      </do_if>
                      <do_else>
                        <find_player_transporter_slot name="$TransporterSlot" object="$BettyShip.controlroom"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.usespacesuit" slot="$TransporterSlot" updatebriefing="true" comment="Use spacesuit"/>
                      </do_else>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch6_2_Entry_Hint">
                  <actions>
                    <!-- using variable to avoid having to cancel cues with running dialogs -->
                    <set_value name="this.$ShowHintEntry" exact="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_2_Entry_Hint_Cancel" comment="no need for entry-hint anymore">
                      <conditions>
                        <event_object_hull_below_function_threshold object="$EarthTorusDoorControls_01" check="false"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$ShowHintEntry" exact="false"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_2_Entry_Hint_Speak_Trigger_Init">
                      <actions>
                        <do_if value="@player.controlled.isclass.spacesuit">
                          <cancel_cue cue="Ch6_2_Entry_Hint_Speak_Trigger"/>
                          <set_value name="$Scheduled_Ch6_2_Entry_Hint_Speak"/>
                        </do_if>
                        <do_else>
                          <cancel_cue cue="this"/>
                        </do_else>
                      </actions>
                      <delay exact="20s"/>
                      <actions>
                        <signal_cue cue="Ch6_2_Entry_Hint_Speak"/>
                      </actions>
                    </cue>
                    <cue name="Ch6_2_Entry_Hint_Speak_Trigger">
                      <conditions>
                        <event_player_teleport_successful/>
                        <check_value value="player.entity.object != $BettyShip"/>
                      </conditions>
                      <actions>
                        <set_value name="$Scheduled_Ch6_2_Entry_Hint_Speak"/>
                        <cancel_cue cue="Ch6_2_Entry_Hint_Speak_Trigger_Init"/>
                      </actions>
                      <delay exact="20s"/>
                      <actions>
                        <signal_cue cue="Ch6_2_Entry_Hint_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_2_Entry_Hint_Speak">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="parent.$ShowHintEntry"/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_2_Entry_Hint_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224607], [30224608, 1s], [30224609, 1s]]" comment=""/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_1_Entry_Hint_Done"/>
                          <!--
                          not used: <t id="	30224	606	">	There have to be switches to control the main airlock doors.	</t>
                          <t id="	30224607	">	There should be a switch for maintenance which you might be able to access from the space suit.	</t>
                          <t id="	30224608	">	Switches in this structure are reacting to laser polarisation of the Hand Laser(same as {20113,1061}) and the Repair Laser(same as {20113,1001}) to toggle between states.	</t>
                          <t id="	30224609	">	Other means of damaging might also suffice, the switches should be sturdy enough to handle most kinds of abuse.	</t>
                          -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch6_1_Entry_Hint_Done">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="parent.$ShowHintEntry" comment="could have changed in the meanwhile"/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30224,6013}" comment="Maintenance Switch" object="$EarthTorusDoorControls_01" updatebriefing="true"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_2_Entry_DoorControl_NonFunctional" instantiate="true">
                  <conditions>
                    <event_object_hull_below_function_threshold object="$EarthTorusDoorControls_01" check="false"/>
                  </conditions>
                  <actions>
                    <!--<cancel_cue cue="Ch6_2_Entry_Hint" comment="no need for hint anymore"/> Don't cancel Speak_Actor -->
                    <signal_cue cue="Ch6_2_Entry_DoorControl_NonFunctional_Comment" check="false"/>
                  </actions>
                </cue>

                <cue name="Ch6_2_GainEntry_DoorControl_Functional" instantiate="true">
                  <conditions>
                    <event_object_hull_above_function_threshold object="$EarthTorusDoorControls_01" check="false"/>
                  </conditions>
                  <actions>
                    <do_if value="$BettyShip.exists and ($BettyShip.distanceto.{$EarthTorusMarker_20} lt 50m) and ($BettyShip.sector == $EarthTorusMarker_20.sector)">
                      <signal_cue cue="Ch6_2_Entry_DoorControl_NonFunctional_Comment" check="false"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch6_2_Entry_DoorControl_NonFunctional_Comment">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_2_Pilot_Check">
                      <actions>
                        <do_if value="player.ship != $BettyShip">
                          <signal_cue cue="Ch6_2_Entry_DoorControl_NonFunctional_BettyComment_v2"/>
                        </do_if>
                      </actions>
                      <delay exact="3s"/>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6050}" text="$BettyShip.knownname" comment="Enter with Expedition Ship" object="$EarthTorusMarker_20" updatebriefing="true"/>
                        <do_if value="(player.ship != $BettyShip) and (@player.controlled.isclass.spacesuit)">
                          <request_docking container="$BettyShip" ship="player.ship" grantedresult="$grantedresult" queuedresult="$queuedresult"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch6_2_Entry_DoorControl_NonFunctional_BettyComment_v2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_2_Entry_DoorControl_NonFunctional_BettyComment_v2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224618]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_Entry_Boso_Comment"/>
                          <!-- <t id="	30224	618	">	Awaiting pilot.	</t> -->
                        </cue>
                      </cues>
                    </cue>


                    <cue name="Ch6_Entry_Boso_Comment">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Entry_Boso_Comment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30224601]]" comment="x"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_Entry_Dal_Comment"/>
                          <!--
                          <t id="	30224	601	">	Your colleague seems impressively capable in some ways, but she does not seem to trust in her piloting skills.(female colleague)	</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Entry_Dal_Comment">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$DalBusta?"/>
                        <check_value value="false" comment="Lines not in DB"/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Entry_Dal_Comment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30224601], [30224602]]" comment="x"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                          <t id="	30224	601	">	That's good for us, otherwise they wouldn't have much use for you and we wouldn't be allowed a peek into this restricted piece of history.	</t>
                          <t id="	30224	602	">	Let's keep going and see if we can salvage something for ourselves.	</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_2_Entry_DoorControl_Open_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_1" trigger="deactivate"/-->
                    <!--set_object_hull object="$EarthTorusDoorControls_01" exact="8" comment="opens (only as long as switch is not destroyed)"/-->
                  </actions>
                </cue>

                <cue name="Ch6_2_Entry_DoorControl_Close_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <trigger_animation object="$EarthTorus" group="tag.interactionspot_1" trigger="activate"/>
                    <!--set_object_hull object="$EarthTorusDoorControls_01" exact="100" comment="closes (only as long as switch is not destroyed)"/-->
                  </actions>
                </cue>

                <cue name="Ch6_2_Entry_DoorControlLid_Open_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <trigger_animation object="$EarthTorusDoorControls_01" trigger="open_doors"/>
                  </actions>
                </cue>

                <cue name="Ch6_2_Entry_DoorControlLid_Close_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <trigger_animation object="$EarthTorusDoorControls_01" trigger="close_doors"/>
                  </actions>
                </cue>

                <cue name="Ch6_2_Entry_MaintenanceDoor_Open_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_19" trigger="deactivate"/-->
                    <set_object_hull object="$EarthTorusDoorControls_19" exact="$SwitchHullMin" comment="opens"/>
                  </actions>
                </cue>

                <cue name="Ch6_2_Entry_MaintenanceDoor_Close_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_19" trigger="activate"/-->
                    <set_object_hull object="$EarthTorusDoorControls_19" exact="$SwitchHullMax" comment="closes"/>
                  </actions>
                </cue>

                <cue name="Ch6_2_Entry_BettyInside" checkinterval="0.1s">
                  <conditions>
                    <check_value value="$BettyShip.exists and ($BettyShip.distanceto.{$EarthTorusMarker_20} lt 200m) and ($BettyShip.sector == $EarthTorusMarker_20.sector)"/>
                  </conditions>
                  <actions>
                    <set_playership_throttle value="0" comment="stop (to avoid crashing while cutscene plays)"/>
                    <force_player_speed speed="0"/>
                    <stop_player_autopilot/>
                  </actions>
                  <delay exact="0.7s"/>
                  <actions>
                    <trigger_animation object="$EarthTorusDoorControls_01" trigger="close_doors"/>
                  </actions>
                  <delay exact="1.3s"/>
                  <actions>
                    <!--set_object_hull object="$EarthTorusDoorControls_01" exact="100" comment="change switch hull, which then closes the door to the outside"/-->
                    <trigger_animation object="$EarthTorus" group="tag.interactionspot_1" trigger="activate"/>
                    <!--<destroy_object object="$EarthTorusDoorControls_01" explosion="true"/>-->
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_19" trigger="deactivate" comment="opens door"/-->
                    <set_object_hull object="$EarthTorusDoorControls_19" exact="$SwitchHullMin" comment="opens"/>
                    <set_object_min_hull object="$EarthTorusDoorControls_01" exact="$SwitchHullMax"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_2_Entry_Trapped_Cutscene" comment="this triggers instantly when the parent-cue becomes active!">
                      <actions>
                        <append_to_list name="md.$MissionDND" exact="Ch6_2_Entry_Trapped_Cutscene"/>
                        <play_cutscene result="this.$CutsceneID" key="'Story_Terraforming_Torus_2'">
                          <param name="torus" object="$EarthTorus"/>
                        </play_cutscene>
                      </actions>
                      <cues>
                        <cue name="Ch6_2_Entry_Trapped_EndCutscene">
                          <conditions>
                            <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                          </conditions>
                          <delay exact="2s"/>
                          <actions>
                            <remove_from_list name="md.$MissionDND" exact="Ch6_2_Entry_Trapped_Cutscene"/>
                            <signal_cue cue="Ch6_2_Entry_BettyInside_Comment_v2"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_2_Entry_BettyInside_Comment_v2" >
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_2_Entry_BettyInside_Speaks_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$YakiScientistActor,$BettyActor]"/>
                          <param name="Cutscene"          value="[true, $ShowBettyShipCutscene]"/>
                          <param name="CutsceneKey"       value="[$YakiScientistActorCutsceneKey,$BettyActorCutsceneKey]"/>
                          <param name="Lines"             value="[[[30224610], [30224611]], [[30224616]]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[null, Ch6_2_Complete]"/>
                          <!--    
                          <t id="30224610">\033MDo not worry about that door.</t>
                          <t id="30224611">\033MYou will find another way out after you rob this place.('You' plural, place referring to Torus Wreckage)</t>
                          Betty: Awaiting breach.
                          -->
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_2_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$AcquiredTerranScan" comment="Re-Activate so the player is unbothored inside the Torus"/>
                    <signal_cue cue="Ch6_3_AirLock"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_3_AirLock">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_object_component name="$EarthTorusDoorControls_02" groupname="$EarthTorusAirlockSwitchGroup" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_2" required="true" comment="First airlock control"/>
                <find_object_component name="$EarthTorusDoorControls_03" groupname="$EarthTorusAirlockSwitchGroup" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_3" required="true" comment="Second airlock control"/>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6028}" comment="Airlock" object="$EarthTorusMarker_02" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch6_3_Player_SpacesuitHazard" checkinterval="0.25s">
                  <conditions>
                    <check_value value="@player.controlled.isclass.spacesuit"/>
                    <check_value value="player.controlled.isinhazardousregion"/>
                    <check_value value="player.sector == $Earth"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_3_Player_SpacesuitHazard_Warning"/>
                  </actions>
                </cue>

                <cue name="Ch6_3_Player_SpacesuitHazard_Warning">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_3_Player_SpacesuitHazard_Warning_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="Cutscene"          value="true"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224617]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch6_3_Player_SpacesuitHazard_Reset"/>
                      <param name="DelayInitial"      value="0s"/>
                      <param name="DelayStartCutscene" value="0s"/>
                      <!--
                      <t id="	30224	617	">	You're in a hazardous area, get out!	</t>
                      -->
                    </cue>

                    <cue name="Patch_Hazard_Warning_Reset" onfail="cancel">
                      <!-- Can't use a patch node as those run before new cues are recognised -->
                      <conditions>
                        <check_value value="Ch6_3_Player_SpacesuitHazard_Warning_Ref.state == cuestate.cancelled"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_3_Player_SpacesuitHazard_Reset"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_3_Player_SpacesuitHazard_Reset">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="5s"/>
                      <actions>
                        <reset_cue cue="parent"/>
                        <reset_cue cue="Ch6_3_Player_SpacesuitHazard"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_3_AirLock_Hints">
                  <actions>
                    <!-- using variables to avoid having to cancel cues with running dialogs -->
                    <set_value name="this.$ShowHintTunnel" exact="true"/>
                    <set_value name="this.$ShowHintSwitch" exact="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_3_AirLock_Hints_Cancel" comment="no need for either hint anymore">
                      <conditions>
                        <event_object_hull_below_function_threshold object="$EarthTorusDoorControls_02" check="false"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$ShowHintTunnel" exact="false"/>
                        <set_value name="parent.$ShowHintSwitch" exact="false"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_3_AirLock_MaintenanceTunnel_Hint">
                      <delay exact="10s"/>
                      <actions>
                        <signal_cue cue="Ch6_3_AirLock_MaintenanceTunnel_Hint_Speak"/>
                      </actions>
                      <cues>

                        <cue name="Ch6_3_AirLock_MaintenanceTunnel_Cancel" checkinterval="1s">
                          <conditions>
                            <check_value value="(player.entity.distanceto.{$EarthTorusDoorControls_02} lt 30m) and (player.entity.sector == $EarthTorusDoorControls_02.sector)"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch6_3_AirLock_Switch_Hint" comment="start time for next hint (switch)" check="false"/>
                            <set_value name="parent.parent.$ShowHintTunnel" exact="false" comment="near switch, no need for tunnel-hint anymore"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_3_AirLock_MaintenanceTunnel_Hint_Speak">
                          <conditions>
                            <event_cue_signalled/>
                            <check_value value="parent.parent.$ShowHintTunnel"/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_3_AirLock_MaintenanceTunnel_Hint_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$YakiScientistActor"/>
                              <param name="Cutscene"          value="true"/>
                              <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                              <param name="Lines"             value="[[30224612],[30224613,1s],[30224614,1s]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <!--
                              <t id="30224612">\033MThere seems to be an air lock in place.</t>
                              <t id="30224613">\033MThat means more maintenance duty for you.</t>
                              <t id="30224614">\033MThere should be service tunnels to get you to the other side of that door.</t>
                            Previously 605 There should be a maintenance tunnel to get to the other side of the airlock                            
                            <t id="30224615">Look out for switches.</t>
                            -->
                              <param name="EndSignalCue"      value="Ch6_3_AirLock_MaintenanceTunnel_Hint_Speak_Completed" comment="enable the next hint"/>
                            </cue>
                            <cue name="Ch6_3_AirLock_MaintenanceTunnel_Hint_Speak_Completed">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch6_3_AirLock_Switch_Hint" check="false"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_3_AirLock_Switch_Hint">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="180s"/>
                      <actions>
                        <signal_cue cue="Ch6_3_AirLock_Switch_Hint_Speak"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_3_AirLock_Switch_Hint_Speak">
                          <conditions>
                            <event_cue_signalled/>
                            <check_value value="parent.parent.$ShowHintSwitch"/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_3_AirLock_Switch_Hint_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$YakiScientistActor"/>
                              <param name="Cutscene"          value="true"/>
                              <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                              <param name="Lines"             value="[[30224606]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <!--     <t id="30224606">\033MThere have to be switches to control the main airlock doors.</t>
                              -->
                              <param name="EndSignalCue"      value="Ch6_3_AirLock_Switch_Hint_Done"/>
                            </cue>
                          </cues>
                        </cue>
                        <cue name="Ch6_3_AirLock_Switch_Hint_Done" comment="point the player to what he has to do">
                          <conditions>
                            <event_cue_signalled/>
                            <check_value value="parent.parent.$ShowHintSwitch" comment="could have changed in the meanwhile"/>
                          </conditions>
                          <actions>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.activate" text="{30224,6017}" group="$EarthTorusAirlockSwitchGroup" updatebriefing="true"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_3_AirLock1">
                  <!-- Using the switch inside the airlock (controls mini-entrance to get before and behind the airlock)
                    Initial state = green (maintenance entry from inside-airlock to outside-space is open)
                    Attacking = red, below-function-threshold (maintenance entry from inside to inside-station is open (while maintenance-entry to get to outside-space closes)
                  -->
                  <cues>
                    <cue name="Ch6_3_AirLockControl1_NonFunctional" instantiate="true">
                      <conditions>
                        <event_object_hull_below_function_threshold object="$EarthTorusDoorControls_02" check="false"/>
                      </conditions>
                      <actions>
                        <do_if value="not (Ch6_3_AirLockControl1_Comment1.state == cuestate.complete)">
                          <signal_cue cue="Ch6_3_AirLockControl1_Comment1" check="false"/>
                          <remove_from_group group="$EarthTorusAirlockSwitchGroup" object="$EarthTorusDoorControls_02"/>
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.activate" text="{30224,6017}" group="$EarthTorusAirlockSwitchGroup" updatebriefing="true"/>
                        </do_if>
                        <!--  The signalled cue does not exist
                        <do_if value="Ch6_3_AirLockControl1_Comment2.state == cuestate.complete">
                          <signal_cue cue="Ch6_3_AirLockControl1_Comment3" check="false"/>
                        </do_if>-->
                      </actions>
                    </cue>

                    <cue name="Ch6_3_AirlockControl_ResetAfterTeleportation" instantiate="true">
                      <!-- If the player is not actually cut off from the puzzle, this will not be detected and the airlock will reset regardless -->
                      <!-- If the player is close enough to dock but teleports instead, the airlock will also reset -->
                      <conditions>
                        <event_object_changed_object object="player.entity"/>
                        <check_any>
                          <check_all>
                            <!-- Reset the Switch if: Player teleports into anything except Spacesuit/BettyShip -->
                            <check_value value="not event.param.isclass.spacesuit"/>
                            <check_value value="event.param != $BettyShip"/>
                          </check_all>
                          <!-- Reset the Switch if: Player teleports into BettyShip from anything except Spacesuit,
                                 we don't need the reverse case as you cannot teleport out of the cover ship -->
                          <check_all>
                            <check_value value="event.param == $BettyShip"/>
                            <check_value value="not event.param2.isclass.spacesuit"/>
                          </check_all>
                          <check_all>
                            <!-- Reset the Switch if: Player teleports from Spacesuit into BettyShip but is not in docking range-->
                            <check_value value="event.param == $BettyShip"/>
                            <check_value value="event.param2.isclass.spacesuit"/>
                            <check_value value="not $SpaceSuitInDockingRange?"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Teleport detected, resetting Airlock Switch'" chance="$DebugChance"/>
                        <set_object_hull object="$EarthTorusDoorControls_02" exact="$SwitchHullMax"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_3_AirlockReset_InDockingRange_Undocked" instantiate="true">
                      <conditions>
                        <!-- From BettyShip into Spaceuit -> Expect SpaceSuitInDockingRange to not reset on quick undock/redocking (not important) -->
                        <event_object_changed_object object="player.entity"/>
                        <check_value value="event.param2 == $BettyShip"/>
                        <check_value value="event.param.isclass.spacesuit"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Setting $SpaceSuitInDockingRange (Undocked)'" chance="$DebugChance"/>
                        <set_value name="$SpaceSuitInDockingRange"/>
                      </actions>
                    </cue>
                    <cue name="Ch6_3_AirlockReset_InDockingRange" checkinterval="0.1s" instantiate="true">
                      <!-- Set Flag $SpaceSuitInDockingRange: If the player suit is close to $BettyShip -->
                      <conditions>
                        <check_value value="not $SpaceSuitInDockingRange?"/>
                        <check_value value="player.sector == $BettyShip.sector"/>
                        <check_value value="player.ship.isclass.spacesuit"/>
                        <check_value value="$BettyShip.distanceto.{player.ship} le ((player.ship.boost.maxspeed / 10) + 10m)"/>
                        <!-- boost.maxspeed / 10 as we check every 0.1s; 10m as the docking for the Moreya happened at about 7m -->
                      </conditions>
                      <actions>
                        <debug_text text="'Setting $SpaceSuitInDockingRange (Proximity-Checkinterval)'" chance="$DebugChance"/>
                        <set_value name="$SpaceSuitInDockingRange"/>
                      </actions>
                    </cue>
                    <cue name="Ch6_3_AirlockReset_OutOfDockingRange" checkinterval="0.1s" instantiate="true">
                      <!-- Remove Flag $SpaceSuitInDockingRange: If the player is not in a suit or the suit is not close to $BettyShip -->
                      <conditions>
                        <check_value value="$SpaceSuitInDockingRange?"/>
                        <check_any>
                          <check_value value="not player.ship.isclass.spacesuit"/>
                          <check_value value="player.sector != $BettyShip.sector"/>
                          <check_all>
                            <check_value value="player.ship.isclass.spacesuit"/>
                            <check_value value="$BettyShip.distanceto.{player.ship} gt ((player.ship.boost.maxspeed / 10) + 10m)"/>
                            <!-- boost.maxspeed / 10 as we check every 0.1s; 10m as the docking for the Moreya happened at about 7m -->
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Removing $SpaceSuitInDockingRange (Proximity-Checkinterval)'" chance="$DebugChance"/>
                        <remove_value name="$SpaceSuitInDockingRange"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_3_AirLockControl1_Functional" instantiate="true">
                      <conditions>
                        <event_object_hull_above_function_threshold object="$EarthTorusDoorControls_02" check="false"/>
                      </conditions>
                      <actions>
                        <!--
                        this actions content was added early in r407111, removed likely before release in r407434
                        => Ch6_3_AirLockControl1_Comment2 is never triggered.
                        A later check for Ch6_3_AirLockControl1_Comment2 to be completed always fails.
                        -->
                        <!--<do_if value="($BettyShip.exists) and ($BettyShip.distanceto.{$EarthTorusMarker_14} lt 75m) and (Ch6_3_AirLock_BettyInside_Comment.state == cuestate.complete)">
                          <signal_cue cue="Ch6_3_AirLockControl1_Comment2" check="false"/>
                        </do_if>-->
                      </actions>
                    </cue>

                    <cue name="Ch6_3_AirLockControl1_Comment1" comment="opened door to 2nd maintenance hallway">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_3_AirLockControl1_Comment1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224616]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                              <t id="30224616">\033MManually overriding those doors is a tedious endeavour, but you are getting there.</t>
                         -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_3_AirLockControl1_Comment2" comment="Now open the inner airlock door!">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="false" comment="This cue is never called. Was originally called by Ch6_3_AirLockControl1_Functional"/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_3_AirLockControl1_Comment2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224619]]" comment="Now you need to open the inner airlock door."/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                          <t id="30224619">Now you need to open the inner airlock door.</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_3_AirLock2">
                  <!-- Using the switch on the "station-inside" side (which opens the outside door)
                    Initial state = green (outside airlock-door is closed)
                    Attacking changes to red (and the outside airlock-door opens (so you can get your ship inside the airlock)
                  -->
                  <cues>

                    <cue name="Ch6_3_AirLockControl2_NonFunctional" instantiate="true">
                      <conditions>
                        <event_object_hull_below_function_threshold object="$EarthTorusDoorControls_03" check="false" comment="green->red (closed inner airlock, open outer airlock)"/>
                      </conditions>
                      <actions>
                        <do_if value="not (Ch6_3_AirLockControl2_Comment1.state == cuestate.complete)">
                          <signal_cue cue="Ch6_3_AirLockControl2_Comment1" check="false" comment="Go park your ship in the airlock!"/>
                          <!-- this leads to Ch6_3_AirLock_BettyInside_Comment complete up to 1s after -->
                        </do_if>
                        <!-- Ch6_3_AirLockControl1_Comment2 is never signalled.. -->
                        <!--<do_if value="Ch6_3_AirLockControl1_Comment2.state == cuestate.complete">
                          <signal_cue cue="Ch6_3_AirLockControl2_Comment3" check="false" comment="Let's proceed"/>
                        </do_if>-->
                      </actions>
                    </cue>

                    <cue name="Ch6_3_AirLockControl2_Functional" instantiate="true">
                      <conditions>
                        <event_object_hull_above_function_threshold object="$EarthTorusDoorControls_03" check="false" comment="red->green (open inner airlock, closes outer airlock)"/>
                      </conditions>
                      <actions>
                        <do_if value="(Ch6_3_AirLock_BettyInside_Comment.state == cuestate.complete)" comment="If Yaki asked to Park Betty inside the airlock">
                          <do_if value="($BettyShip.exists) and ($BettyShip.distanceto.{$EarthTorusMarker_14} lt 151m) and ($BettyShip.sector == $EarthTorusMarker_14.sector)" comment="... and Betty is actually inside the airlock">
                            <signal_cue cue="Ch6_3_AirLockControl2_Comment3" check="false" comment="Proceed"/>
                          </do_if>
                          <do_else>
                            <signal_cue cue="Ch6_3_AirLockControl2_Comment2" check="false" comment="Reminder: Your ship is mission critical, put it in the airlock!"/>
                          </do_else>
                        </do_if>
                        <do_else>
                          <debug_text text="'(ignoring)Need to do other things first'" chance="$DebugChance"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch6_3_AirLockControl2_Comment1">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_3_AirLockControl2_Comment1_Ref_v2" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BettyActor, $YakiScientistActor]"/>
                          <param name="Cutscene"          value="[$ShowBettyShipCutscene, true]"/>
                          <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $YakiScientistActorCutsceneKey]"/>
                          <param name="Lines"             value="[[[30224618]], [[30224691]]]" comment="Awaiting pilot"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[Ch6_3_Objective_Traverse_Airlock, Ch6_3_AirLock_Torus_Wakeup]"/>
                          <!-- Awaiting pilot.                          
                          <t id="30224691">Do not leave your colleague(female colleague) behind. You are both mission-critical!</t>
                          -->
                        </cue>
                        <cue name="Ch6_3_Objective_Traverse_Airlock">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="(not $EarthTorusDoorControls_02.isfunctional) and (player.ship != $BettyShip)">
                              <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.repair" object="$EarthTorusDoorControls_02" updatebriefing="true"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Ch6_3_Airlock2_Objective_PlayerInside"/>
                            </do_else>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_3_Airlock2_Objective_PlayerInside">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_object_hull_above_function_threshold object="$EarthTorusDoorControls_02" check="false"/>
                          <check_all>
                            <event_object_changed_object object="player.entity"/>
                            <check_value value="player.ship == $BettyShip"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6053}" text="$BettyShip.knownname" comment="Traverse the airlock with" updatebriefing="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_3_AirLockControl2_Comment2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_3_AirLockControl2_Comment2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224691]]" comment="Do not leave your colleague(female colleague) behind. You are both mission-critical!"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!-- <t id="30224691">Do not leave your colleague(female colleague) behind. You are both mission-critical!</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_3_AirLockControl2_Comment3">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Ready to proceed'" comment="$DebugChance"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_3_AirLockControl2_Comment3_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224618]]" comment="Awaiting pilot"/>
                          <!-- Awaiting pilot.
                          Previously: Let's proceed -->
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_3_Complete"/>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_3_AirLock_BettyInside" checkinterval="1s">
                  <conditions>
                    <check_value value="Ch6_3_AirLockControl2_Comment1.state == cuestate.complete" comment="was instructed to park betty inside?"/>
                    <check_value value="$BettyShip.exists and ($BettyShip.distanceto.{$EarthTorusMarker_14} lt 151m) and ($BettyShip.sector == $EarthTorusMarker_14.sector)" comment="use marker inside the airlock (near the wall, center would be better)"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_3_AirLock_BettyInside_Comment"/>
                  </actions>
                </cue>

                <cue name="Ch6_3_AirLock_BettyInside_Comment" >
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_3_Entry_BettyInside_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224616]]" comment="Awaiting breach"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!-- Awaiting breach.
                          Previously: Now close the outer airlock door -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_3_AirLock_Torus_Wakeup">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="5s"/>
                  <actions>
                    <set_value name="$TorusComputerActivated"/>
                    <signal_cue_instantly cue="Ch6_3_AirLock_Torus_Identify" param="[[30224601], [30224602]]" comment="Identify. This is a restricted area"/>
                    <!--
                    <t id="	30224	601	">	Welcome to Torus Aeternal Segment #34 Subsegment Storage.(speak # as "number", speak numerals seperately, speak Torus Aeternal as in provided sound sample)	</t>
                    <t id="	30224	602	">	{10098,30224604}(Requesting Identification) and Ware Transfer Permit.	</t>-->
                  </actions>
                  <delay exact="40s"/>
                  <actions>
                    <!--<write_incoming_message source="$TorusActor.knownname" highpriority="false"
                                            title="{30224,14001}"
                                             text="{30224,14002}"
                                            comment="Torus Aeternal Segment #34 - Identification Request">
                      <cutscene key="'OrbitIndefinitely'" param="$EarthTorus" />
                    </write_incoming_message>-->
                  </actions>
                  <delay exact="40s"/>
                  <actions>
                    <signal_cue_instantly cue="Ch6_3_AirLock_Torus_Identify"  param="[[30224603], [30224604]]" comment="Identify"/>
                    <!--
                    <t id="	30224	603	">	This is a restricted area under the Terran Protection Act.	</t>
                    <t id="	30224	604	">	Requesting Identification	</t>      
                    <t id="	30224	606	">	Identify.(Surprising shift in tone, more angry than computers should be)	</t>
                    -->
                  </actions>
                  <delay exact="50s"/>
                  <actions>
                    <signal_cue_instantly cue="Ch6_3_AirLock_Torus_Identify"  param="[[30224604]]"/>
                  </actions>
                  <delay exact="100s"/>
                  <actions>
                    <signal_cue_instantly cue="Ch6_3_AirLock_Torus_Identify"  param="[[30224606]]"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_3_AirLock_Torus_Identify" instantiate="true" comment="event.param = $Lines to be spoken">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $TorusRebooting?"/>
                      </conditions>
                      <actions>
                        <set_value name="this.$Lines" exact="event.param"/>
                        <set_value name="this.$EndSignalCue" exact="if (Ch6_3_AirLock_Yaki_IgnoreIt.state == cuestate.waiting) then Ch6_3_AirLock_Yaki_IgnoreIt else null"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_3_AirLock_Torus_Identity_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$TorusActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$TorusActorCutsceneKey"/>
                          <param name="Lines"             value="parent.$Lines"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="this.$EndSignalCue" comment="non-instantiating cue, so only triggered first time"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_3_AirLock_Yaki_IgnoreIt">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_3_AirLock_Yaki_Ignore_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224620], [30224621, 1s]]" comment="It looks like a security system was activated. Just ignore it."/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                        <t id="	30224	620	">	It looks like an old security system reactivated.	</t>
                        <t id="	30224	621	">	Just ignore it.	</t>
                        -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_3_Torus_Intruder">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_3_AirLock_Torus_Intruder_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$TorusActor"/>
                      <param name="Cutscene"          value="true"/>
                      <param name="CutsceneKey"       value="$TorusActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224005]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch6_3_AirLock_Torus_Intruder_Done" comment="Intruder Alert in Section 3C"/>
                      <!--
                       Intruder Alert in section 3C.  
                       -->
                    </cue>
                    <cue name="Ch6_3_AirLock_Torus_Intruder_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_relation_boost object="$EarthTorus" faction="faction.player" value="-1.0" decay="0" comment="torus needs to be hostile, otherwise it will prevent turrets in 6.6 from firing at a friendly"/>
                        <set_relation_boost object="$EarthTorus" otherobject="$BettyShip" value="-1.0" decay="0"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_3_Complete_Check" checkinterval="1s">
                  <conditions>
                    <check_value value="(player.sector == $EarthTorusMarker_04.sector) and (player.entity.distanceto.{$EarthTorusMarker_04} le 400m)"/>
                    <!--
                      > Player got to a Ch6_4 location without Ch6_3_Complete completed and got stuck.
                      > Ch6_3_AirLockControl2_Comment3 was somehow bypassed, should have been called by Ch6_3_AirLockControl2_Functional  
                    -->
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_3_Complete" check="false"/>
                  </actions>
                </cue>

                <cue name="Ch6_3_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_3_Torus_Intruder"/>
                    <signal_cue cue="Ch6_4_Sphere"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_4_Sphere" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_object_component name="$EarthTorusDoorControls_04" object="$EarthTorus" groupname="$EarthTorusSphereSwitchGroup" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_4" required="true" comment="Sphere control (visible when you enter)"/>
                <find_object_component name="$EarthTorusDoorControls_05" object="$EarthTorus" groupname="$EarthTorusSphereSwitchGroup" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_5" required="true" comment="Sphere control (90 ccw from entry)"/>
                <find_object_component name="$EarthTorusDoorControls_06" object="$EarthTorus" groupname="$EarthTorusSphereSwitchGroup" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_6" required="true" comment="Sphere control (180 ccw from entry (opposite from where you enter)"/>
                <find_object_component name="$EarthTorusDoorControls_07" object="$EarthTorus" groupname="$EarthTorusSphereSwitchGroup" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_7" required="true" comment="Sphere control (270 ccw from entry"/>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6051}" text="$BettyShip.knownname" comment="Enter HUB with Expedition Ship" object="$EarthTorusMarker_04" updatebriefing="true"/>
                <do_for_each name="this.$Switch" in="$EarthTorusSphereSwitchGroup">
                  <trigger_animation object="this.$Switch" trigger="close_doors"/>
                </do_for_each>

                <set_object_min_hull object="$EarthTorusDoorControls_04" exact="$SwitchHullMax"/>
                <set_object_min_hull object="$EarthTorusDoorControls_06" exact="$SwitchHullMax"/>

                <set_object_hull object="$EarthTorusDoorControls_05" exact="$SwitchHullMin"/>
                <set_object_hull object="$EarthTorusDoorControls_07" exact="$SwitchHullMin"/>
                <set_object_hull_unrepairable object="$EarthTorusDoorControls_05" unrepairable="true"/>
                <set_object_hull_unrepairable object="$EarthTorusDoorControls_07" unrepairable="true"/>

                <add_to_group groupname="$EarthTorusHubSwitchesFX" group="$EarthTorusSphereSwitchGroup"/>
              </actions>
              <patch sinceversion="2">
                <do_for_each name="this.$Switch" in="$EarthTorusSphereSwitchGroup">
                  <set_object_min_hull object="this.$Switch" exact="$SwitchHullMax"/>
                </do_for_each>
                <add_to_group groupname="$EarthTorusHubSwitchesFX" group="$EarthTorusSphereSwitchGroup"/>
              </patch>
              <cues>

                <!--cue name="Ch6_4_Hacked" checkinterval="250ms" instantiate="true">
                  <conditions>
                    <check_value value="($EarthTorusHubSwitchesFX.count)"/>
                  </conditions>
                  <delay exact="[0.3s, 0.4s, 0.5s].random"/>
                  <actions>
                    <do_if value="$EarthTorusHubSwitchesFX.count" comment="group might be emptied during the delay!">
                      <add_effect object="$EarthTorusHubSwitchesFX.random" effect="'signal_leak_discharge_effect_red'"/>
                    </do_if>
                  </actions>
                </cue-->

                <cue name="Ch6_4_Near_Cutscene" checkinterval="2s">
                  <conditions>
                    <check_value value="(player.entity.distanceto.{$EarthTorusMarker_04} le 400m) and (player.entity.sector == $EarthTorusMarker_04.sector)"/>
                  </conditions>
                  <actions>
                    <set_playership_throttle value="0" comment="stop (to avoid crashing while cutscene plays)"/>
                    <force_player_speed speed="0"/>
                    <stop_player_autopilot/>
                    <append_to_list name="md.$MissionDND" exact="Ch6_4_Near_Cutscene"/>
                    <play_cutscene result="this.$CutsceneID" key="'Story_Terraforming_Torus_3'">
                      <param name="SphereRoom" object="$EarthTorusMarker_04"/>
                    </play_cutscene>
                  </actions>
                  <cues>

                    <cue name="Ch6_4_Near_Cutscene_Started">
                      <conditions>
                        <event_cutscene_started cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <do_if value="$BettyShip.exists and ($BettyShip.distanceto.{$EarthTorusMarker_04} gt 400m) and ($BettyShip.sector == $EarthTorusMarker_04.sector)" comment="400 is roughly radius">
                          <speak actor="$YakiScientistActor" priority="100" >
                            <text line="30224630"/>
                            <text line="30224631"/>
                            <text line="30224691" delay="0.5s"/>
                          </speak>
                          <!-- HUB
                          <t id="	30224	630	">	You reached a hub for transferring ships to various parts of the Torus.	</t>
                          <t id="	30224	631	">	There should be controls to open the correct door.	</t>
                          <t id="	30224691	">	Don't leave your colleague behind, you are both mission critical.	</t>
                          -->
                          <debug_text text="'Debugging Voiceline Condition mission critical'"/>
                        </do_if>
                        <do_else>
                          <speak actor="$YakiScientistActor" priority="100" >
                            <text line="30224630"/>
                            <text line="30224631"/>
                          </speak>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch6_4_Near_Cutscene_EndCutscene">
                      <conditions>
                        <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <!--object="$EarthTorusMarker_04"-->
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6056}" comment="Gain Access" updatebriefing="true"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <remove_from_list name="md.$MissionDND" exact="Ch6_4_Near_Cutscene"/>
                        <set_value name="$TorusRebooting"/>
                        <signal_cue cue="Ch6_4_Sphere_Torus_Betty_Struggle"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_4_Sphere_Torus_Betty_Struggle">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_4_Sphere_Torus_Betty_Struggle_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$TorusActor, $BettyActor,
                                                              $TorusActor, $BettyActor,
                                                              $TorusActor, $BettyActor,
                                                              $TorusActor, $BettyActor,
                                                              $TorusActor, $BettyActor,
                                                              $TorusActor]"/>
                      <param name="Cutscene"          value="[true, $ShowBettyShipCutscene,
                                                              true, $ShowBettyShipCutscene,
                                                              true, $ShowBettyShipCutscene,
                                                              true, $ShowBettyShipCutscene,
                                                              true, $ShowBettyShipCutscene,
                                                              true,]"/>
                      <param name="CutsceneKey"       value="[$TorusActorCutsceneKey, $BettyActorCutsceneKey,
                                                              $TorusActorCutsceneKey, $BettyActorCutsceneKey,
                                                              $TorusActorCutsceneKey, $BettyActorCutsceneKey,
                                                              $TorusActorCutsceneKey, $BettyActorCutsceneKey,
                                                              $TorusActorCutsceneKey, $BettyActorCutsceneKey,
                                                              $TorusActorCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                              [[30224607, 0s], [30224611], [30224612], [30224613], [30224614]],
                                                              [[30224630, 0s]],
                                                              [[30224615, 0s]],
                                                              [[30224633, 0s]],
                                                              [[30224616, 0s]],
                                                              [[30224634, 0s]],
                                                              [[30224616, 0s]],
                                                              [[30224635, 0s]],
                                                              [[30224617, 0s]],
                                                              [[30224636, 0s]],
                                                              [[30224618, 0s], [30224619], [30224620]]
                                                             ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="DelayInitial"            value="[0s,0s,0s,0s,0s,0s,0s,0s,0s,0s,0s]"/>
                      <param name="DelayStartCutscene"      value="[0s,0s,0s,0s,0s,0s,0s,0s,0s,0s,0s]"/>
                      <param name="DelayEndCutscene"        value="[0s,0s,0s,0s,0s,0s,0s,0s,0s,0s,0s]"/>
                      <param name="EndSignalCue"      value="[Ch6_Mail_Torus_Arrest, null,
                                                              null, null,
                                                              null, null,
                                                              null, null,
                                                              null, null,
                                                              Ch6_4_Sphere_Torus_Betty_Struggle_Done]"/>
                      <!--
                      Torus	<t id="	30224	607	">	Attention: Suspending all Ship Traffic at Main Hub C5 Segment #34.(speak # as "number", speak numerals seperately)	</t>
                      Torus	<t id="	30224	611	">	Restricting Maintenance Capabilities.	</t>
                      Torus	<t id="	30224	612	">	You are placed under arrest for trespassing under the Terran Protection Act.	</t>
                      Torus	<t id="	30224	613	">	Security has been notified.	</t>
                      Torus	<t id="	30224	614	">	Detention imminent.	</t>
                      Betty	<t id="	30224	630	">	Security indisposed.	</t>
                      Torus	<t id="	30224	615	">	Affirmative.	</t>
                      Betty	<t id="	30224	633	">	Requesting Waiting Time Estimate.	</t>
                      Torus	<t id="	30224	616	">	Indefinitely.	</t>
                      Betty	<t id="	30224	634	">	Requesting Hub Obstruction Time Estimate.	</t>
                      Torus	<t id="	30224	616	">	Indefinitely.	</t>
                      Betty	<t id="	30224	635	">	Requesting Segment #34 Main Function.	</t>
                      Torus	<t id="	30224	617	">	Storage and Distribution.	</t>
                      Betty	<t id="	30224	636	">	Requesting Distribution Efficiency Estimate.	</t>
                      Torus	<t id="	30224	618	">	Task cannot be completed.	</t>
                      Torus	<t id="	30224	619	">	Main Function void.	</t>
                      Torus	<t id="	30224	620	">	Rebooting.	</t>                      
                      -->
                    </cue>

                    <cue name="Ch6_Mail_Torus_Arrest">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!--<write_incoming_message source="$TorusActor.knownname" highpriority="false"
                                                title="{30224,14101}"
                                                 text="{30224,14102}"
                                                comment="Torus Aeternal Segment #34 - Notice of Arrest">
                          <cutscene key="'OrbitIndefinitely'" param="$EarthTorus" />
                        </write_incoming_message>-->
                      </actions>
                    </cue>

                    <cue name="Ch6_4_Sphere_Torus_Betty_Struggle_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <clear_group group="$EarthTorusHubSwitchesFX"/>
                        <do_for_each name="this.$Switch" in="$EarthTorusSphereSwitchGroup">
                          <set_object_min_hull object="this.$Switch" exact="$SwitchHullMin"/>
                          <set_object_hull_unrepairable object="this.$Switch" unrepairable="false"/>
                          <trigger_animation object="this.$Switch" trigger="open_doors"/>
                        </do_for_each>
                      </actions>
                      <delay exact="30s"/>
                      <actions>
                        <do_if value="cuestate.complete != Ch6_4_Sphere_SwitchGroup_Success.state">
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6056}" group="$EarthTorusSphereSwitchGroup" comment="Gain Access" />
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch6_4_Sphere_Yaki_Comment">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_4_Sphere_Yaki_Comment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224638], [30224639, 1s], [30224615, 1s]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_4_Sphere_SwitchGroup_Success_Done"/>
                          <!-- 
                           <t id="30224638">That is an odd power fluctuation for a reboot.</t>
                           <t id="30224639">The energy supply must be damaged.</t> 
                           <t id="30224615">Look out for switches.</t>-->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_4_Sphere_SwitchGroup_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'$EarthTorusDoorControls #4=%s #5=%  #6=%s #7=%s)'.[$EarthTorusDoorControls_04.isfunctional, $EarthTorusDoorControls_05.isfunctional, $EarthTorusDoorControls_06.isfunctional, $EarthTorusDoorControls_07.isfunctional]"/>
                  </actions>
                </cue>

                <cue name="Ch6_4_Sphere_SwitchGroup_Toggled" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_object_hull_above_function_threshold group="$EarthTorusSphereSwitchGroup"/>
                      <event_object_hull_below_function_threshold group="$EarthTorusSphereSwitchGroup"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'switched=%s grouptag=%s (4=%s 5=%s 6=%s 7=%s)'.[event.param.name, event.param.grouptag, $EarthTorusDoorControls_04.isfunctional, $EarthTorusDoorControls_05.isfunctional, $EarthTorusDoorControls_06.isfunctional, $EarthTorusDoorControls_07.isfunctional]" chance="$DebugChance"/>
                    <do_if value="(not $EarthTorusDoorControls_04.isfunctional) and (not $EarthTorusDoorControls_05.isfunctional) and (not $EarthTorusDoorControls_06.isfunctional) and (not $EarthTorusDoorControls_07.isfunctional)">
                      <!-- success -->
                      <signal_cue_instantly cue="Ch6_4_Sphere_SwitchGroup_Success" param="[[30224644]]" comment="Splendid! Proceed! This path should get us to the data center."/>
                      <!-- <t id="30224 644">\033MSplendid! Proceed! This path should get us to the data center.</t> -->
                    </do_if>
                    <do_elseif value="($EarthTorusDoorControls_04.isfunctional) and ($EarthTorusDoorControls_05.isfunctional) and ($EarthTorusDoorControls_06.isfunctional) and ($EarthTorusDoorControls_07.isfunctional)">
                      <signal_cue_instantly cue="Ch6_4_Sphere_SwitchGroup_Comment" param="[[30224645]]" comment="This leads back to where we came from"/>
                      <!-- <t id="30224	645	">	This would be the way back, but we did not acquire any information on the Terraformers yet.	</t> -->
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Ch6_4_Sphere_SwitchGroup_Comments">
                  <cues>

                    <cue name="Ch6_4_Sphere_SwitchGroup_Success">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_4_Complete" comment="need to trigger immediately, otherwise door closes too slow"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_4_Sphere_SwitchGroup_Success_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224644]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_4_Sphere_SwitchGroup_Success_Done"/>
                          <!-- <t id="	30224	644	">	Splendid! Proceed! This path should get us to the data center.	</t> -->
                        </cue>

                        <cue name="Ch6_4_Sphere_SwitchGroup_Success_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_4_Sphere_SwitchGroup_Comment" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_any>
                          <set_value name="this.$Lines" exact="event.param"/>
                        </do_any>
                      </actions>
                      <cues>
                        <cue name="Ch6_4_Sphere_SwitchGroup_Comment_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="parent.$Lines"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_4_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_5_Airlock2"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_5_Airlock2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!--<find_object_component name="$EarthTorusCoverPlate" object="$EarthTorus" macro="macro.torus_coverplate_macro" state="componentstate.operational" required="true" recursive="true"/>
                <set_object_relation_behaviour object="$EarthTorusCoverPlate" disable="true" comment="avoid 'station under attack' repercussion warning" />-->
                <find_object_component name="$EarthTorusDoorControls_08" groupname="$EarthTorusAirlock2SwitchGroup" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_8" required="true" comment="Opens maintenance entry for 2nd airlock"/>
                <find_object_component name="$EarthTorusDoorControls_09" groupname="$EarthTorusAirlock2SwitchGroup" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_9" required="true" comment="Opens door for 2nd airlock"/>

                <signal_cue cue="Ch6_5_Lights_Setup" comment="at this point these lights start working (until the end of the entire chapter)"/>

                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6055}" text="$BettyShip.knownname" comment="Traverse the Torus with" object="$EarthTorusMarker_05" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch6_5_Setup">
                  <actions>
                    <!-- Door should be initially open, and close on approach -->
                  </actions>
                </cue>

                <cue name="Ch6_5_InitiateLockDown_Near" checkinterval="0.5s">
                  <conditions>
                    <check_value value="(player.entity.distanceto.{$EarthTorusMarker_05} lt 800) and (player.entity.sector == $EarthTorusMarker_05.sector)"/>
                  </conditions>
                  <cues>

                    <cue name="Ch6_5_InitiateLockdown_Start">
                      <delay exact="4s" comment="better sync with 'reboot complete' voiceline (intentionally not via EndSignalCue oof LIB_Dialog.Speak_Actor so it will always close after the delay, irrelevant of how long the speak takes)"/>
                      <actions>
                        <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_9" trigger="activate" comment="opens door"/-->
                        <trigger_animation object="$EarthTorus" group="tag.interactionspot_9" trigger="deactivate" comment="closes door"/>
                        <set_object_hull object="$EarthTorusDoorControls_09" exact="$SwitchHullMin"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_5_InitiateLockdown_Speak2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$TorusActor"/>
                      <param name="Cutscene"          value="true"/>
                      <param name="CutsceneKey"       value="$TorusActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224630]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch6_5_InitiateLockdown_Speak2_Done"/>
                      <!--
                      Torus	<t id="	30224	630	">	Reboot complete.	</t>
                      -->
                    </cue>

                    <cue name="Ch6_5_InitiateLockdown_Speak2_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="1.5s"/>
                      <actions>
                        <signal_cue cue="Ch6_5_Lockdown_Initiated_Speak_Done"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_5_InitiateLockdown_Activate_DEBUG" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_9" trigger="activate" comment="closes door (broken)"/-->
                        <set_object_hull object="$EarthTorusDoorControls_09" exact="$SwitchHullMin"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_5_InitiateLockdown_Deactivate_DEBUG" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!--trigger_animation object="$EarthTorus" group="tag.interactionspot_9" trigger="deactivate" comment="opens door"/-->
                        <set_object_hull object="$EarthTorusDoorControls_09" exact="$SwitchHullMax"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_5_Lockdown_Initiated2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_5_Lockdown_Initiated_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$TorusActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$TorusActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224631], [30224612]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_5_Lockdown_Initiated_Speak_Done"/>
                          <!--                          
                           Torus	<t id="	30224631	">	Attention Intruders:	</t>
                            <t id="30224612">You are under arrest for trespass, as defined by the Terran Protection Act.</t>
                           not used: Torus	<t id="	30224	603	">	This is a restricted area under the Terran Protection Act.	</t>
                           Betty	<t id="	30224616	">	{10002,30224614} {10002,30224615}(Awaiting breach.)	</t>
                           -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_5_Lockdown_Initiated_Speak_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!--<write_incoming_message source="$TorusActor.knownname" highpriority="false"
                                                title="{30224,14201}"
                                                 text="{30224,14202}"
                                                comment="Torus Aeternal Segment #34 - Notice of Hostility">
                          <cutscene key="'OrbitIndefinitely'" param="$EarthTorus" />
                        </write_incoming_message>-->
                      </actions>
                      <cues>
                        <cue name="Ch6_5_LockDown_Bypass_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224616]]"      comment="Awaiting Breach"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_5_InitiateLockdown_Bypass_Done"/>
                        </cue>

                        <cue name="Ch6_5_InitiateLockdown_Bypass_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="0.5s"/>
                          <actions>
                            <set_value name="$ObjectiveStep" operation="add"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6052}" comment="Bypass lockdown" object="$EarthTorusMarker_05" updatebriefing="true"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <!--<cue name="Ch6_5_CoverPlateDestroyed">
                  <conditions>
                    <event_object_destroyed object="$EarthTorusCoverPlate"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Coverplate was destroyed'" chance="$DebugChance"/>
                  </actions>
                </cue>-->

                <cue name="Ch6_5_CoverSwitch_Toggled" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_object_hull_above_function_threshold object="$EarthTorusDoorControls_08"/>
                      <event_object_hull_below_function_threshold object="$EarthTorusDoorControls_08"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Covered-Switch %s'.[$EarthTorusDoorControls_04.isfunctional]" chance="$DebugChance"/>
                    <do_if value="$EarthTorusDoorControls_04.isfunctional">
                      <!-- option to trigger speech -->
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch6_5_LockedDoorSwitch_Toggled_Speak">
                  <conditions>
                    <event_object_hull_below_function_threshold object="$EarthTorusDoorControls_09"/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_5_LockedDoorSwitch_Toggled_Speak_v2_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$TorusActor, $YakiScientistActor]"/>
                      <param name="Cutscene"          value="[true, true]"/>
                      <param name="CutsceneKey"       value="[$TorusActorCutsceneKey, $YakiScientistActorCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                              [[30224631], [30224612], [30224636], [30224637], [30224638]],
                                                              [[30224651], [30224652]]
                                                             ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[null, Ch6_5_LockedDoorSwitch_Toggled_Speak_Done]"/>
                    </cue>
                    <!--
                    Betty	<t id="	30224618	">	{10002,30224614} {10002,30224617}(Awaiting pilot.)	</t>
                    
                    Torus	<t id="	30224635	">	Bypass detected.	</t>
                    Torus	<t id="	30224611	">	Restricting Maintenance Capabilities.	</t>
                    
                           Torus	<t id="	30224631	">	Attention Intruders:	</t>
                            <t id="30224612">You are under arrest for trespass, as defined by the Terran Protection Act.</t>
                           not used: Torus	<t id="	30224	603	">	This is a restricted area under the Terran Protection Act.	</t>
                    
                    Torus	<t id="	30224636	">	You are advised to remain at the current location.	</t>
                    Torus	<t id="	30224637	">	Do not proceed.	</t>
                    Torus	<t id="	30224638	">	You have been warned.	</t>
                    Yaki	<t id="	30224651	">	That sounds ominous.	</t>
                    Yaki	<t id="	30224652	">	Proceed with caution.	</t>
                    -->

                    <cue name="Ch6_5_LockedDoorSwitch_Toggled_Speak_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                    </cue>
                    <cue name="Ch6_5_LockedDoor_Opened_After_Bypass">
                      <conditions>
                        <event_object_hull_above_function_threshold object="$EarthTorusDoorControls_09"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_5_LockedDoorSwitch_Toggled_BettySpeak"/>
                        <signal_cue cue="Ch6_5_BettySteepHallway_Objective"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_5_LockedDoorSwitch_Toggled_BettySpeak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_5_LockedDoorSwitch_Toggled_BettySpeak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224618]]" comment="Awaiting pilot"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch6_5_Objective_Enter_BettyShip"/>
                      <!-- Awaiting pilot.-->
                    </cue>
                    <cue name="Ch6_5_Objective_Enter_BettyShip">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="(player.ship != $BettyShip) and (@player.controlled.isclass.spacesuit)">
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.dockat" object="$BettyShip" updatebriefing="true"/>
                          <request_docking container="$BettyShip" ship="player.ship" grantedresult="$grantedresult" queuedresult="$queuedresult"/>
                        </do_if>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_5_BettySteepHallway_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_5_BettySteepHallway_Objective_Set">
                      <conditions>
                        <event_player_teleport_successful/>
                        <check_value value="player.ship == $BettyShip"/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6055}" text="$BettyShip.knownname" comment="Traverse the Torus with" updatebriefing="true"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>


                <cue name="Ch6_5_BettySteepHallway_Approach" checkinterval="1s">
                  <conditions>
                    <check_value value="($BettyShip.distanceto.{$EarthTorusMarker_07} lt 400m) and ($BettyShip.sector == $EarthTorusMarker_07.sector)"/>
                  </conditions>
                  <actions>
                    <trigger_autosave comment="dying in the turret room is annoying"/>
                    <debug_text text="'Betty nearing downward hallway into the turret room'" chance="$DebugChance"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_5_Hint_Betty_Proximity_Alert_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224520], [30224640]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--<t id="	30224520	">	Proximity Alert	</t>
                          <t id="	30224640	">	{10002,505}(Hostiles detected.)	</t>-->
                    </cue>
                  </cues>
                </cue>


                <cue name="Ch6_5_BettyTurretRoom_Approach_Cutscene" checkinterval="1s">
                  <conditions>
                    <check_value value="($BettyShip.distanceto.{$EarthTorusMarker_08} lt 400m) and ($BettyShip.sector == $EarthTorusMarker_08.sector)"/>
                  </conditions>
                  <actions>
                    <append_to_list name="md.$MissionDND" exact="Ch6_5_BettyTurretRoom_Approach_Cutscene"/>
                    <play_cutscene result="this.$CutsceneID" key="'Story_Terraforming_Torus_4'">
                      <param name="torus" object="$EarthTorus"/>
                    </play_cutscene>
                    <set_playership_throttle value="0" comment="stop (to avoid crashing while cutscene plays)"/>
                    <force_player_speed speed="0"/>
                    <stop_player_autopilot/>
                  </actions>
                  <cues>

                    <cue name="Ch6_5_BettyTurretRoom_Approach_Cutscene_Started">
                      <conditions>
                        <event_cutscene_started cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <delay exact="2s"/>
                      <actions>
                        <!--speak actor="$YakiScientistActor" priority="100" >
                          <text page="10" line="1"/>
                          <text page="11" line="1"/>
                        </speak-->
                      </actions>
                    </cue>

                    <cue name="Ch6_5_BettyTurretRoom_Approach_Cutscene_Ended">
                      <conditions>
                        <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <actions>
                        <remove_from_list name="md.$MissionDND" exact="Ch6_5_BettyTurretRoom_Approach_Cutscene"/>
                        <signal_cue cue="Ch6_5_Complete"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <!--cue name="Ch6_5_BettyTurretRoom_Approach_Dialog" checkinterval="1s">
                  <conditions>
                    <check_value value="($BettyShip.distanceto.{$EarthTorusMarker_08} lt 400) and ($BettyShip.sector == $EarthTorusMarker_08.sector)"/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_5_BettyTurretRoom_Approach_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="Cutscene"          value="true"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224658]]"/>
                      <param name="EndSignalCue"      value="Ch6_5_BettyTurretRoom_Approach_Speak_Done"/>
                    </cue>
                    <cue name="Ch6_5_BettyTurretRoom_Approach_Speak_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="0.5s"/>
                      <actions>
                        <signal_cue cue="Ch6_5_Complete"/>
                      </actions>
                    </cue>
                  </cues>
                </cue-->

                <cue name="Ch6_5_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_6_TurretRoom"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_6_TurretRoom">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_object_component name="$EarthTorusInternalTurrets" object="$EarthTorus" groupname="$EarthTorusInternalTurretsGroup" grouptag="tag.group01" multiple="true" required="true" comment="all turrets in the internal battle-room"/>

                <!-- Right Side Switch -->
                <find_object_component name="$EarthTorusDoorControls_10" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_10" required="true" comment="Opens door to exit the battle-room"/>
                <set_object_min_hull object="$EarthTorusDoorControls_10" exact="$SwitchHullMax" comment="indestructible, until all turrets destroyed"/>
                <trigger_animation object="$EarthTorusDoorControls_10" trigger="close_doors"/>

                <!-- Left Side Switch -->
                <find_object_component name="$EarthTorusDoorControls_11" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_11" required="true" comment="Opens door to exit the battle-room"/>
                <set_object_min_hull object="$EarthTorusDoorControls_11" exact="$SwitchHullMax" comment="indestructible, until all turrets destroyed"/>
                <trigger_animation object="$EarthTorusDoorControls_11" trigger="close_doors"/>

                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.defeat" text="{30224,6054}" comment="Hostile turrets" group="$EarthTorusInternalTurretsGroup" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch6_6_SecurityProtocols_Delay">
                  <delay exact="2s"/>
                  <actions>
                    <signal_cue cue="Ch6_6_SecurityProtocols"/>
                  </actions>
                  <delay exact="2s"/>
                  <actions>
                    <signal_cue cue="Ch6_6_SecurityProtocols_Speak_Done"/>
                  </actions>
                </cue>

                <cue name="Ch6_6_SecurityProtocols">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_6_SecurityProtocols_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$TorusActor"/>
                      <param name="Cutscene"          value="true"/>
                      <param name="CutsceneKey"       value="$TorusActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224006]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--<param name="EndSignalCue"      value="Ch6_6_SecurityProtocols_Speak_Done"/>-->
                      <!-- 006		Enacting security protocols.
                      -->
                    </cue>

                    <cue name="Ch6_6_SecurityProtocols_Speak_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_relation_boost object="$EarthTorus" faction="faction.player" value="-1.0" decay="0" comment="in case the boost was lost in the meanwhile"/>
                        <set_relation_boost object="$EarthTorus" otherobject="$BettyShip" value="-1.0" decay="0" comment="in case the boost was lost in the meanwhile"/>
                        <do_for_each name="$Turret" in="$EarthTorusInternalTurretsGroup">
                          <set_relation_boost object="$Turret" faction="faction.player" value="-1.0" decay="0"/>
                          <set_relation_boost object="$Turret" otherobject="$BettyShip" value="-1.0" decay="0"/>
                          <!--set_weapon_mode weapon="$Turret" weaponmode="weaponmode.any"/-->
                          <set_turret_targets object="$EarthTorus" target="[$BettyShip, player.ship]" weaponmode="weaponmode.any" />
                        </do_for_each>
                      </actions>
                      <delay exact="2s"/>
                      <actions>
                        <signal_cue cue="Ch6_6_Battle_Hotwired"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_6_Reset_Turrets" checkinterval="2s" instantiate="true" onfail="cancel">
                          <conditions>
                            <check_value value="$EarthTorusInternalTurretsGroup.count"/>
                          </conditions>
                          <actions>
                            <do_if value="(player.exists) and (player.sector == $EarthTorus.sector)">
                              <set_relation_boost object="$EarthTorus" faction="faction.player" value="-1.0" decay="0" comment="in case the boost was lost in the meanwhile"/>
                              <set_relation_boost object="$EarthTorus" otherobject="$BettyShip" value="-1.0" decay="0" comment="in case the boost was lost in the meanwhile"/>
                              <do_for_each name="$Turret" in="$EarthTorusInternalTurretsGroup">
                                <set_relation_boost object="$Turret" faction="faction.player" value="-1.0" decay="0"/>
                                <set_relation_boost object="$Turret" otherobject="$BettyShip" value="-1.0" decay="0"/>
                                <!--set_weapon_mode weapon="$Turret" weaponmode="weaponmode.any"/-->
                                <set_turret_targets object="$EarthTorus" target="[$BettyShip, player.ship]" weaponmode="weaponmode.any" />
                              </do_for_each>
                            </do_if>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_6_Battle_Hotwired">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_6_Battle_Hotwired_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224662], [30224663]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                          <t id="	30224	662	">	The turrets are consuming all remaining energy at this storage unit.	</t>
                          <t id="	30224	663	">	You will not be able to open the next door until all turrets are taken down.	</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>


                <cue name="Ch6_6_Battle_Turrets_DestroyAll_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_for_each name="$t" in="$EarthTorusInternalTurretsGroup">
                      <destroy_object object="$t" explosion="true"/>
                    </do_for_each>
                  </actions>
                </cue>

                <cue name="Ch6_6_Missing_Turrets_Workaround">
                  <conditions>
                    <event_cue_signalled cue="Ch6_6_Battle_Hotwired"/>
                  </conditions>
                  <delay exact="10s"/>
                  <actions>
                    <do_if value="not $EarthTorusInternalTurretsGroup.count">
                      <signal_cue cue="Ch6_6_Battle_Turrets_Destroyed"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch6_6_Battle_Turrets_Destroyed">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_destroyed group="$EarthTorusInternalTurretsGroup"/>
                    </check_any>
                    <check_value value="$EarthTorusInternalTurretsGroup.count le 1" />
                  </conditions>
                  <actions>
                    <set_object_min_hull object="$EarthTorusDoorControls_10" exact="$SwitchHullMin"/>
                    <set_object_min_hull object="$EarthTorusDoorControls_11" exact="$SwitchHullMin"/>

                    <trigger_animation object="$EarthTorusDoorControls_10" trigger="open_doors"/>
                    <trigger_animation object="$EarthTorusDoorControls_11" trigger="open_doors"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_6_Battle_Turrets_Destroyed_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="DelayInitial"      value="1s"/>
                      <param name="Lines"             value="[[30224616]]" comment="Awaiting breach."/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch6_6_Battle_Turrets_Destroyed_Speak_Done"/>
                    </cue>
                    <cue name="Ch6_6_Battle_Turrets_Destroyed_Speak_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <add_to_group groupname="$Ch6_6_Complete_Switches" list="[$EarthTorusDoorControls_10,$EarthTorusDoorControls_11]"/>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6020}" comment="Continue exploration" group="$Ch6_6_Complete_Switches" updatebriefing="true"/>
                      </actions>
                      <delay exact="0.5s"/>
                      <actions>
                        <signal_cue cue="Ch6_6_Complete"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_6_BattleSwitch_Toggled" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_object_hull_above_function_threshold object="$EarthTorusDoorControls_10"/>
                      <event_object_hull_below_function_threshold object="$EarthTorusDoorControls_10"/>
                      <event_object_hull_above_function_threshold object="$EarthTorusDoorControls_11"/>
                      <event_object_hull_below_function_threshold object="$EarthTorusDoorControls_11"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="$EarthTorusInternalTurretsGroup.count" comment="all turrets destroyed">
                      <debug_text text="'BattleDoor-Switch %s'.[$EarthTorusDoorControls_10.isfunctional]" chance="$DebugChance"/>
                      <debug_text text="'BattleDoor-Switch %s'.[$EarthTorusDoorControls_11.isfunctional]" chance="$DebugChance"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch6_6_Objective" check="false"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch6_6_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30224,6020}" comment="Continue exploration" object="$EarthTorusMarker_11" updatebriefing="true"/>
                  </actions>
                </cue>


                <cue name="Ch6_6_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_7_DataDownload"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_7_DataDownload" version="5">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>

                <find_object_component name="$EarthTorusDoorControls_12" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_12" required="true" comment="Opens door to exit the data-room"/>
                <set_object_min_hull object="$EarthTorusDoorControls_12" exact="$SwitchHullMax" comment="indestructible, until all data-download complete"/>
                <trigger_animation object="$EarthTorusDoorControls_12" trigger="close_doors"/>
                <create_group groupname="$EarthTorusDataSwitches"/>
                <create_group groupname="$EarthTorusDataSwitchesFX"/>
                <create_group groupname="$EarthTorusHackedSwitchesFX"/>
                <!-- find all switches -->
                <find_object_component name="$EarthTorusDataSwitch1" groupname="$EarthTorusDataSwitches2" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.riddleswitch_1" required="true"/>
                <find_object_component name="$EarthTorusDataSwitch2" groupname="$EarthTorusDataSwitches2" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.riddleswitch_2" required="true"/>
                <find_object_component name="$EarthTorusDataSwitch3" groupname="$EarthTorusDataSwitches1" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.riddleswitch_3" required="true"/>
                <find_object_component name="$EarthTorusDataSwitch4" groupname="$EarthTorusDataSwitches1" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.riddleswitch_4" required="true"/>
                <find_object_component name="$EarthTorusDataSwitch5" groupname="$EarthTorusDataSwitches1" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.riddleswitch_5" required="true"/>
                <find_object_component name="$EarthTorusDataSwitch6" groupname="$EarthTorusDataSwitches1" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.riddleswitch_6" required="true"/>
                <find_object_component name="$EarthTorusDataSwitch7" groupname="$EarthTorusDataSwitches2" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.riddleswitch_7" required="true"/>
                <find_object_component name="$EarthTorusDataSwitch8" groupname="$EarthTorusDataSwitches2" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.riddleswitch_8" required="true"/>

                <set_value name="$EarthTorusDataSwitchNumbers" exact="table[
                                 {$EarthTorusDataSwitch1} = '1', 
                                 {$EarthTorusDataSwitch2} = '2', 
                                 {$EarthTorusDataSwitch3} = '3', 
                                 {$EarthTorusDataSwitch4} = '4', 
                                 {$EarthTorusDataSwitch5} = '5', 
                                 {$EarthTorusDataSwitch6} = '6', 
                                 {$EarthTorusDataSwitch7} = '7', 
                                 {$EarthTorusDataSwitch8} = '8', 
                ]"/>
                <set_value name="$EarthTorusDataSwitchVoiceLines" exact="table[
                                 {$EarthTorusDataSwitch1} = 30224691, 
                                 {$EarthTorusDataSwitch2} = 30224692, 
                                 {$EarthTorusDataSwitch3} = 30224693, 
                                 {$EarthTorusDataSwitch4} = 30224694, 
                                 {$EarthTorusDataSwitch5} = 30224695, 
                                 {$EarthTorusDataSwitch6} = 30224696, 
                                 {$EarthTorusDataSwitch7} = 30224697, 
                                 {$EarthTorusDataSwitch8} = 30224698, 
                ]"/>
                <!-- setup other groups -->
                <add_to_group groupname="$EarthTorusDataSwitches" group="$EarthTorusDataSwitches1"/>
                <add_to_group groupname="$EarthTorusDataSwitches" group="$EarthTorusDataSwitches2"/>
                <!-- initial setup-->
                <do_for_each name="this.$switch" in="$EarthTorusDataSwitches1">
                  <set_object_hull object="this.$switch" exact="$SwitchHullMin"/>
                  <set_object_min_hull object="this.$switch" exact="$SwitchHullMin" comment="don't allow destruction"/>
                </do_for_each>
                <do_for_each name="this.$switch" in="$EarthTorusDataSwitches2">
                  <set_object_min_hull object="this.$switch" exact="$SwitchHullMax" comment="keep on max (meh)"/>
                  <trigger_animation object="this.$switch" trigger="close_doors"/>
                </do_for_each>
                <do_for_each name="this.$switch" in="$EarthTorusDataSwitches" comment="dataroom switches are hackable">
                  <set_object_hackable object="this.$switch" hackable="true"/>
                </do_for_each>

                <!--add_to_group groupname="$EarthTorusDataSwitchesFX" group="$EarthTorusDataSwitches2" comment="initially 1/2 of the switches is malfunctioning (forced on max)"/-->

                <set_value name="$IgnoreSwitch" exact="false"/>
                <set_value name="$DownloadProgressLimit" exact="0"/>
                <set_value name="$PlayerActions" exact="0"/>
              </actions>
              <patch sinceversion="3">
                <set_value name="$DownloadProgressLimit" exact="0"/>
                <set_value name="$PlayerActions" exact="0"/>
                <create_group groupname="$EarthTorusHackedSwitchesFX"/>
              </patch>
              <patch sinceversion="4">
                <set_value name="$EarthTorusDataSwitchNumbers" exact="table[
                                 {$EarthTorusDataSwitch1} = '1', 
                                 {$EarthTorusDataSwitch2} = '2', 
                                 {$EarthTorusDataSwitch3} = '3', 
                                 {$EarthTorusDataSwitch4} = '4', 
                                 {$EarthTorusDataSwitch5} = '5', 
                                 {$EarthTorusDataSwitch6} = '6', 
                                 {$EarthTorusDataSwitch7} = '7', 
                                 {$EarthTorusDataSwitch8} = '8', 
                ]"/>
              </patch>
              <patch sinceversion="5">
                <set_value name="$EarthTorusDataSwitchVoiceLines" exact="table[
                                 {$EarthTorusDataSwitch1} = 30224691, 
                                 {$EarthTorusDataSwitch2} = 30224692, 
                                 {$EarthTorusDataSwitch3} = 30224693, 
                                 {$EarthTorusDataSwitch4} = 30224694, 
                                 {$EarthTorusDataSwitch5} = 30224695, 
                                 {$EarthTorusDataSwitch6} = 30224696, 
                                 {$EarthTorusDataSwitch7} = 30224697, 
                                 {$EarthTorusDataSwitch8} = 30224698, 
                ]"/>
              </patch>
              <cues>

                <cue name="Ch6_7_DataRoom_Approach" checkinterval="1s">
                  <conditions>
                    <check_value value="($BettyShip.distanceto.{$EarthTorusMarker_10} lt 300) and ($BettyShip.sector == $EarthTorusMarker_10.sector)"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Betty nearing download-room'" chance="$DebugChance"/>
                    <set_object_min_hull object="$EarthTorusDoorControls_10" exact="$SwitchHullMax"/>
                    <set_object_min_hull object="$EarthTorusDoorControls_11" exact="$SwitchHullMax"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_7_DataRoom_Approach_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="Cutscene"          value="true"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224668], [30224682,2s], [30224684, 2s]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch6_7_DataRoom_Approach_Speak_Done"/>
                      <!--
                      <t id="	30224	668	">	We are approaching the location where your colleague can interface with the Torus' archives.(female colleague)	</t>
                      <t id="30224681">Now you will have to interact with the panels to release the file transfer.</t>
                      <t id="30224682">Now you will have to interact with the switches to release the file transfer.</t>
                      <t id="30224683">Activate all panels to grant your colleague(female colleague) access.</t>
                      <t id="30224684">Activate all switches to grant your colleague(female colleague) access.</t>
                      -->
                    </cue>
                    <cue name="Ch6_7_DataRoom_Approach_Speak_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <signal_cue cue="Ch6_7_Download"/>
                        <signal_cue cue="Ch6_7_Riddle1_Objective" comment="Investigate: Data Switches"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_7_Riddle_Dump_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Switches:'"/>
                    <do_for_each name="this.$switch" in="$EarthTorusDataSwitches">
                      <debug_text text="'grouptag=' + this.$switch.grouptag + ' hull=' + this.$switch.hull + ' isfunctional=' + this.$switch.isfunctional + ' hacked=' + this.$switch.ishacked"/>
                      <do_if value="$EarthTorusLockedFunctionalSwitches?">
                        <debug_text text="'grouptag=' + this.$switch.grouptag + ' GR_LOCKFunc=' + $EarthTorusLockedFunctionalSwitches.indexof.{this.$switch} + ' GR_Hacked=' + $EarthTorusHackedSwitchesFX.indexof.{this.$switch}"/>
                      </do_if>
                    </do_for_each>
                  </actions>
                </cue>

                <cue name="Ch6_7_Switch_Glitch" checkinterval="250ms" instantiate="true">
                  <conditions>
                    <check_value value="$EarthTorusDataSwitchesFX.count"/>
                  </conditions>
                  <delay exact="[0.1s, 0.2s, 0.3s].random"/>
                  <actions>
                    <do_if value="$EarthTorusDataSwitchesFX.count" comment="group might be emptied during the delay!">
                      <add_effect object="$EarthTorusDataSwitchesFX.random" effect="'signal_leak_discharge_effect'"/>
                    </do_if>
                    <do_if value="$EarthTorusDataSwitchesFX.count gt 4" comment="in case of many active, display a few more effects">
                      <add_effect object="$EarthTorusDataSwitchesFX.random" effect="'signal_leak_discharge_effect'"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch6_7_Switch_Hacked" checkinterval="1s" instantiate="true">
                  <conditions>
                    <check_value value="$EarthTorusHackedSwitchesFX.count"/>
                  </conditions>
                  <actions>
                    <do_for_each name="this.$switch" in="$EarthTorusHackedSwitchesFX">
                      <set_object_hacked object="this.$switch" duration="2s"/>
                    </do_for_each>
                  </actions>
                </cue>

                <!--<cue name="Ch6_7_Switch_HackedFX" checkinterval="500ms" instantiate="true">
                  <conditions>
                    <check_value value="$EarthTorusHackedSwitchesFX.count"/>
                  </conditions>
                  <delay exact="[0.1s, 0.3s, 0.5s].random"/>
                  <actions>
                    <do_if value="$EarthTorusHackedSwitchesFX.count">
                      <add_effect object="$EarthTorusHackedSwitchesFX.random" effect="'signal_leak_discharge_effect_red'" comment="should be done via hacked-effect definition on the macro"/>
                    </do_if>
                  </actions>
                </cue>-->

                <cue name="Ch6_7_Dialogs">
                  <cues>

                    <cue name="Ch6_7_YakiScientist_Switch_Affecting_Hint">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_7_YakiScientist_Switch_Affecting_Hint_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224688]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_7_Briefing_Update_1"/>
                          <!--
                          <t id="30224687">Pay attention to the outcome of your interactions; the panels are affecting each other.</t>
                          <t id="30224688">Pay attention to the outcome of your interactions; the switches are affecting each other.</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_Briefing_Update_1">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_7_YakiScientist_Switch_Unresponsive_Hint"/>
                      </actions>
                      <delay exact="10s"/>
                      <actions>
                        <set_value name="$RiddleExplanation" exact="{30224,6203} + '\n\n' + {30224,6209}"/>
                        <update_mission cue="$MissionCue" description="{30224,6002} + '\n\n' + $RiddleExplanation"/>
                        <!-- Notification {1015,300} Mission update: $REASON$
                         <t id="6001">(Mission Title)Torus Aeternal</t> -->
                        <substitute_text text="$message" source="{1015,300}" comment="Mission Update:">
                          <replace string="'$REASON$'" with="'' + readtext.{30224}.{6001}" comment="(Mission Title)Torus Aeternal"/>
                        </substitute_text>
                        <show_notification text="$message"/>
                      </actions>
                    </cue>
                    <cue name="Ch6_7_Briefing_Update_2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$RiddleExplanation" exact="{30224,6203} + '\n\n' + {30224,6209} + '\n\n' + {30224,6207}"/>
                        <update_mission cue="$MissionCue" description="{30224,6002} + '\n\n' + $RiddleExplanation"/>
                        <!-- Notification {1015,300} Mission update: $REASON$
                         <t id="6001">(Mission Title)Torus Aeternal</t> -->
                        <substitute_text text="$message" source="{1015,300}" comment="Mission Update:">
                          <replace string="'$REASON$'" with="'' + readtext.{30224}.{6001}" comment="(Mission Title)Torus Aeternal"/>
                        </substitute_text>
                        <show_notification text="$message"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_YakiScientist_Switch_Unresponsive_Hint">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_7_YakiScientist_Switch_Unresponsive_Hint_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224686]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                           <t id="30224685">Not all the panels are accessible right away. Ignore the unresponsive ones.</t>
                           <t id="30224686">Not all the switches are accessible right away. Ignore the unresponsive ones.</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_YakiScientist_Switch_Undo_Hint">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_7_YakiScientist_Switch_Undo_Hint_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$YakiScientistActor"/>
                          <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224689]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!-- 
                          <t id="30224689">This might sound unintuitive, but it may be necessary to undo an activation in order to solve the pattern.</t>

                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_YakiScientist_Switch_Shutdown_Hint">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_7_YakiScientist_Switch_Shutdown_Hint_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$TorusActor, $YakiScientistActor]"/>
                          <param name="CutsceneKey"       value="[$TorusActorCutsceneKey, $YakiScientistActorCutsceneKey]"/>
                          <param name="Lines"             value="[[[30224651],[30224654]], [[30224690], [30224692]]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[Ch6_7_Riddle2_Start, null]"/>
                          <!-- 
                          <t id="	30224651	">	You are not authorised.	</t>
                          <t id="	30224654	">	Booting Firewall.	</t>
                          
                          <t id="30224690">The security system is trying to shut us out.</t>
                          <t id="30224692">Continue unlocking to override it.</t>

                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_Betty_TransferStarted">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_7_Betty_TransferStarted_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224702], [30224710]]" comment="Storage reserved, Transfer started."/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_7_YakiScientist_Switch_Affecting_Hint"/>
                          <!--
                          <t id="	30224	702	">	Storage reserved.	</t>
                          <t id="	30224	710	">	Transferring Data.	</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_Betty_TransferPaused1">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_7_Betty_TransferPaused1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224703]]" comment="Data transfer paused"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_7_Betty_TransferPaused1_Done"/>
                        </cue>

                        <cue name="Ch6_7_Betty_TransferPaused1_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30224,6024}" comment="Transfer paused..." updatebriefing="true" silent="true">
                              <progress  progress="$DownloadProgress" max="100"/>
                            </set_objective>
                            <signal_cue_instantly cue="Ch6_7_Riddle1_Objective"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_Betty_TransferPaused2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_7_Betty_TransferPaused2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224703]]" comment="Data transfer paused"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_7_Betty_TransferPaused2_Done"/>
                        </cue>

                        <cue name="Ch6_7_Betty_TransferPaused2_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30224,6024}" comment="Transfer paused..." updatebriefing="true" silent="true">
                              <progress  progress="$DownloadProgress" max="100"/>
                            </set_objective>
                            <signal_cue_instantly cue="Ch6_7_Riddle2_Objective"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch6_7_Betty_TransferResumed1">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                      </actions>
                      <cues>
                        <cue name="Ch6_7_Betty_TransferResumed1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224704]]" comment="Data transfer resumed"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_7_YakiScientist_Switch_Shutdown_Hint"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_Betty_TransferResumed2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_7_Betty_TransferResumed2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BettyActor"/>
                          <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                          <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224668], [30224704]]" comment="All switches active. Data transfer resumed"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_7_Betty_TransferResumed2_Docking"/>
                        </cue>
                        <cue name="Ch6_7_Betty_TransferResumed2_Docking">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="(player.ship != $BettyShip) and (@player.controlled.isclass.spacesuit)">
                              <request_docking container="$BettyShip" ship="player.ship" grantedresult="$grantedresult" queuedresult="$queuedresult"/>
                            </do_if>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_Torus_Counteraction_Short" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <!-- Deprecated. For Debug showing how many of those queued up. -->
                      <cues>
                        <cue name="Ch6_7_Torus_Counteraction_Short_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$TorusActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$TorusActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224635], [30224639]]" comment="bypass detected, rerouting nodes"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch6_7_Torus_Counteraction_Long" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <!-- Deprecated. For Debug showing how many of those queued up. -->
                      <cues>
                        <cue name="Ch6_7_Torus_Counteraction_Long_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"               value="[$TorusActor, $BettyActor, $TorusActor]"/>
                          <param name="Cutscene"            value="[true, $ShowBettyShipCutscene,true]"/>
                          <param name="CutsceneKey"         value="[$TorusActorCutsceneKey, $BettyActorCutsceneKey, $TorusActorCutsceneKey]"/>
                          <param name="Lines"               value="parent.$lines"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="DelayInitial"        value="[0s,0s,0s]"/>
                          <param name="DelayStartCutscene"  value="[0s,0s,0s]"/>
                          <param name="DelayEndCutscene"    value="[0s,0s,0s]"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_Torus_Counteraction_Short_v2" instantiate="false">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_7_Torus_Counteraction_Short_v2_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$TorusActor"/>
                          <param name="Cutscene"          value="true"/>
                          <param name="CutsceneKey"       value="$TorusActorCutsceneKey"/>
                          <param name="Lines"             value="[[30224635], [30224639]]" comment="bypass detected, rerouting nodes"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_7_Torus_Counteraction_Speak_Short_Done"/>
                        </cue>
                        <cue name="Ch6_7_Torus_Counteraction_Speak_Short_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <reset_cue cue="parent"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_Torus_Counteraction_Long_v2" instantiate="false">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_any>
                          <set_value name="this.$lines" exact="[[[30224660, 0s]], [[30224654, 1s]], [[30224661, 1s]] ]"/>
                          <set_value name="this.$lines" exact="[[[30224660, 0s]], [[30224655, 1s]], [[30224663, 1s]] ]"/>
                          <set_value name="this.$lines" exact="[[[30224660, 0s]], [[30224656, 1s]], [[30224665, 1s]] ]"/>
                          <!--
                          Torus	<t id="	30224	660	">	Access denied. Identify.	</t>
                          Betty	<t id="	30224	654	">	Colonel Bjerke Rodrigo - ID 7-5-8.(speak: Seven Five Eight, do not speak dash)	</t>
                          Torus	<t id="	30224	661	">	Welcome Colonel Rodrigo.	</t>
                 not used Torus	<t id="	30224	662	">	Rodrigo retired.	</t>
                          Betty	<t id="	30224	655	">	Admiral Mia Hardman - ID 6-6-1.(speak: Six Six One, do not speak dash)	</t>
                          Torus	<t id="	30224	663	">	Welcome Admiral Hardman.	</t>
                 not used Torus	<t id="	30224	664	">	Admiral Hardman retired.	</t>
                          Betty	<t id="	30224	656	">	Officer Frank Tunnel - ID 3-7-0.(speak: Three Seven Zero, do not speak dash)	</t>
                          Torus	<t id="	30224	665	">	Welcome Officer Tunnel.	</t>
                 not used Torus	<t id="	30224	666	">	Officer Tunnel retired.	</t>
                          -->
                        </do_any>
                      </actions>
                      <cues>

                        <cue name="Ch6_7_Torus_Counteraction_Long_v2_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"               value="[$TorusActor, $BettyActor, $TorusActor]"/>
                          <param name="Cutscene"            value="[true, $ShowBettyShipCutscene,true]"/>
                          <param name="CutsceneKey"         value="[$TorusActorCutsceneKey, $BettyActorCutsceneKey, $TorusActorCutsceneKey]"/>
                          <param name="Lines"               value="parent.$lines"/>
                          <param name="DelayInitial"        value="[0s,0s,0s]"/>
                          <param name="DelayStartCutscene"  value="[0s,0s,0s]"/>
                          <param name="DelayEndCutscene"    value="[0s,0s,0s]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"        value="[null, null, Ch6_7_Torus_Counteraction_Speak_Long_Done]"/>
                        </cue>
                        <cue name="Ch6_7_Torus_Counteraction_Speak_Long_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <reset_cue cue="parent"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_7_Riddle1">
                  <cues>

                    <cue name="Ch6_7_Riddle1_Objective" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$DownloadProgress?"/>
                        <check_value value="$DownloadProgress == $DownloadProgressLimit"/>
                      </conditions>
                      <actions>
                        <set_value name="$NumActiveSwitches" exact="0"/>
                        <do_for_each in="$EarthTorusDataSwitches1" name="$switch">
                          <do_if value="$switch.isfunctional">
                            <set_value name="$NumActiveSwitches" exact="1" operation="add"/>
                          </do_if>
                        </do_for_each>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.activate" text="{30224,6023}" comment="Data Switches" updatebriefing="true" silent="true">
                          <progress text="{30224,6023}" progress="$NumActiveSwitches" max="$EarthTorusDataSwitches1.count"/>
                        </set_objective>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle1_Download">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$DownloadProgressLimit" exact="30"/>
                        <signal_cue cue="Ch6_7_Betty_TransferStarted" check="false"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle1_IgnoreTimed" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="false" comment="Not being called anymore; $IgnoreSwitch handling changed"/>
                      </conditions>
                      <actions>
                        <set_value name="$IgnoreSwitch" exact="true"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <signal_cue cue="Patch_Ch6_7_Riddle1_IgnoreTimed_Off" check="false"/>
                      </actions>
                    </cue>

                    <cue name="Patch_Ch6_7_Riddle1_IgnoreTimed_Off" instantiate="false" comment="Run once only for patching reasons">
                      <!-- We handle $IgnoreSwitch now more safely right after the switch adjustments have been made.
                           This patch should prevent it getting stuck for players who saved during the delay -->
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$IgnoreSwitch" exact="false"/>
                        <signal_cue cue="Ch6_7_Riddle1_Solved" check="false" comment="check if solved"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle1_Switch3" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch3"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch3"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle1_IgnoreTimed"/>-->
                        <signal_cue cue="Ch6_7_Riddle1_Download" check="false"/>
                        <signal_cue cue="Ch6_7_Riddle1_Objective"/>
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch3,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch4]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle1_Switch4" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch4"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch4"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle1_IgnoreTimed"/>-->
                        <signal_cue cue="Ch6_7_Riddle1_Download" check="false"/>
                        <signal_cue cue="Ch6_7_Riddle1_Objective"/>
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch4,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch5]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_YakiScientist_Switch_Undo_Hint" check="false" comment="We know this one is false and give a hint once"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle1_Switch5" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch5"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch5"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle1_IgnoreTimed"/>-->
                        <signal_cue cue="Ch6_7_Riddle1_Download" check="false"/>
                        <signal_cue cue="Ch6_7_Riddle1_Objective"/>
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch5,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch4]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_YakiScientist_Switch_Undo_Hint" check="false" comment="We know this one is false and give a hint once"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle1_Switch6" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch6"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch6"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle1_IgnoreTimed"/>-->
                        <signal_cue cue="Ch6_7_Riddle1_Download" check="false"/>
                        <signal_cue cue="Ch6_7_Riddle1_Objective"/>
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch6,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch5]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle1_Solved" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_all exact="$EarthTorusDataSwitches1.count" counter="$i">
                          <check_value value="$EarthTorusDataSwitches1.{$i}.isfunctional"/>
                        </check_all>
                      </conditions>
                      <actions>
                        <debug_text text="'All Switches Functional!'" chance="$DebugChance"/>

                        <!--add_to_group groupname="$EarthTorusDataSwitchesFX" group="$EarthTorusDataSwitches1" comment="first 4 switches also with effect (so all 8 now)"/-->
                        <do_for_each name="this.$switch" in="$EarthTorusDataSwitches1">
                          <set_object_min_hull object="this.$switch" exact="$SwitchHullMax" comment="first 4 also invulnerable (so all 8 now)"/>
                          <trigger_animation object="this.$switch" trigger="close_doors"/>
                        </do_for_each>

                        <signal_cue cue="Ch6_7_Riddle2"/>
                        <cancel_cue cue="Ch6_7_Riddle1"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_7_Riddle2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="this.$LastSwitch" exact="null"/>
                    <set_value name="$DownloadProgressLimit" exact="60"/>
                    <signal_cue cue="Ch6_7_Betty_TransferResumed1"/>

                    <create_group groupname="$EarthTorusHackedSwitchesGroup1"/>
                    <add_to_group groupname="$EarthTorusHackedSwitchesGroup1" list="[$EarthTorusDataSwitch1, $EarthTorusDataSwitch2, $EarthTorusDataSwitch3]"/>
                    <create_group groupname="$EarthTorusHackedSwitchesGroup2"/>
                    <add_to_group groupname="$EarthTorusHackedSwitchesGroup2" list="[$EarthTorusDataSwitch6, $EarthTorusDataSwitch7, $EarthTorusDataSwitch8]"/>

                    <create_group groupname="$EarthTorusLockedFunctionalSwitches"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_7_Riddle2_Objective" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$DownloadProgress == $DownloadProgressLimit"/>
                      </conditions>
                      <actions>
                        <set_value name="$NumActiveSwitches" exact="0"/>
                        <do_for_each in="$EarthTorusDataSwitches" name="$switch">
                          <do_if value="$switch.isfunctional">
                            <set_value name="$NumActiveSwitches" exact="1" operation="add"/>
                          </do_if>
                        </do_for_each>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30224,6024}" comment="Transfer paused..." updatebriefing="true" silent="true">
                          <progress text="{30224,6023}" progress="$NumActiveSwitches" max="$EarthTorusDataSwitches.count"/>
                        </set_objective>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Start">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="this.$message" exact="{30224,90022}"/>

                        <signal_cue cue="Ch6_7_Briefing_Update_2"/>

                        <clear_group group="$EarthTorusDataSwitchesFX" comment="removes electric effect"/>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle2_IgnoreTimed" comment="avoid cascades while setting up the switches"/>-->

                        <set_value name="$IgnoreSwitch" exact="true"/>
                        <set_value name="$Switches"/>
                        <do_for_each name="$switch" in="$EarthTorusDataSwitches">

                          <!--<do_if value="$switch.isfunctional">
                            <substitute_text text="this.$message_append" source="{30224,90006}" comment="Switch $ID$ is now inoperational(status report)">
                              <replace string="'$ID$'" with="$EarthTorusDataSwitchNumbers.{$switch}" />
                            </substitute_text>
                          </do_if>
                          <set_value name="this.$message" exact="this.$message + '\n' + this.$message_append"/>
                          
                          Notifications max out at 4 lines. Not enough space for the "all inactive" message + individual lines -->
                          <set_object_min_hull object="$switch" exact="$SwitchHullMin" comment="vulnerable again (but don't allow destruction)"/>
                          <set_object_hull object="$switch" exact="$SwitchHullMin" comment="vulnerable again"/>
                          <trigger_animation object="$switch" trigger="open_doors"/>
                        </do_for_each>
                        <set_value name="$IgnoreSwitch" exact="false"/>

                        <show_notification text="this.$message" sound="notification_generic" comment="switch (deactivated)/operational" timeout="10s" priority="9"/>

                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_RepairAll_DEBUG">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_for_each name="this.$switch" in="$EarthTorusDataSwitches">
                          <set_object_hull object="this.$switch" exact="$SwitchHullMax" comment="vulnerable again"/>
                        </do_for_each>
                        <signal_cue cue="Ch6_7_Riddle2_Solved"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_IgnoreTimed" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="false" comment="Not being called anymore; $IgnoreSwitch Handling changed"/>
                      </conditions>
                      <actions>
                        <set_value name="$IgnoreSwitch" exact="true"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <set_value name="$IgnoreSwitch" exact="false"/>
                        <!--signal_cue cue="Ch6_7_Riddle2_Solved" check="false" comment="check if solved"/-->
                        <signal_cue cue="Patch_Ch6_7_Riddle2_IgnoreTimed_Off" check="false"/>
                      </actions>
                    </cue>
                    <cue name="Patch_Ch6_7_Riddle2_IgnoreTimed_Off" instantiate="false" comment="Run once only for patching reasons">
                      <!-- We handle $IgnoreSwitch now more safely right after the switch adjustments have been made.
                           This patch should prevent it getting stuck for players who saved during the delay -->
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$IgnoreSwitch" exact="false"/>
                        <!--<signal_cue cue="Ch6_7_Riddle2_Solved" check="false" comment="check if solved"/>-->
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Torus_React" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$PlayerActions" operation="add"/>
                        <signal_cue cue="Ch6_7_Riddle2_Objective"/>

                        <!-- Open and Clear $EarthTorusHackedSwitchesFX -->
                        <set_value name="$IgnoreSwitch" exact="true"/>
                        <do_for_each in="$EarthTorusHackedSwitchesFX" name="$switch">
                          <trigger_animation object="$switch" trigger="open_doors"/>
                          <set_object_hull_unrepairable object="$switch" unrepairable="false"/>
                        </do_for_each>
                        <clear_group group="$EarthTorusHackedSwitchesFX"/>
                        <!-- Open $EarthTorusLockedFunctionalSwitches -->
                        <do_for_each in="$EarthTorusLockedFunctionalSwitches" name="$switch">
                          <trigger_animation object="$switch" trigger="open_doors"/>
                          <set_object_hull_unrepairable object="$switch" unrepairable="false"/>
                        </do_for_each>
                        <set_value name="$IgnoreSwitch" exact="false"/>

                      </actions>
                      <delay exact="3s" comment="takes 2 seconds for the above change to be applied by Ch6_7_Switch_Hacked, then check win-conditions"/>
                      <actions>

                        <!-- Unlock $EarthTorusLockedFunctionalSwitches -->
                        <set_value name="$IgnoreSwitch" exact="true"/>
                        <do_for_each in="$EarthTorusLockedFunctionalSwitches" name="$switch">
                          <set_object_min_hull object="$switch" exact="$SwitchHullMin"/>
                        </do_for_each>
                        <clear_group group="$EarthTorusLockedFunctionalSwitches"/>

                        <signal_cue_instantly cue="Ch6_7_Riddle2_Solved" check="false" comment="check if solved"/>
                        <!-- Riddle solve? If not, Torus has a counteraction  -->
                        <do_if value="$DownloadProgressLimit lt 100">
                          <do_if value="($PlayerActions % 5) == 0">
                            <signal_cue cue="Ch6_7_Torus_Counteraction_Long_v2" check="false"/>
                          </do_if>
                          <do_else>
                            <signal_cue cue="Ch6_7_Torus_Counteraction_Short_v2" check="false"/>
                          </do_else>

                          <do_if value="($PlayerActions % 2) == 0">
                            <set_value name="$CurrentGroup" exact="$EarthTorusHackedSwitchesGroup1"/>
                          </do_if>
                          <do_else>
                            <set_value name="$CurrentGroup" exact="$EarthTorusHackedSwitchesGroup2"/>
                          </do_else>

                          <!-- Lock Switches as hacked or functional-->
                          <do_for_each in="$CurrentGroup" name="$switch">
                            <trigger_animation object="$switch" trigger="close_doors"/>
                            <do_if value="$switch.isfunctional">
                              <add_to_group groupname="$EarthTorusLockedFunctionalSwitches" object="$switch"/>
                              <set_object_min_hull object="$switch" exact="$SwitchHullMax"/>
                            </do_if>
                            <do_else>
                              <add_to_group groupname="$EarthTorusHackedSwitchesFX" object="$switch"/>
                              <set_object_hull_unrepairable object="$switch" unrepairable="true"/>
                            </do_else>
                          </do_for_each>
                        </do_if>

                        <set_value name="$IgnoreSwitch" exact="false"/>

                        <signal_cue_instantly cue="Ch6_7_LegalityCheck"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_LegalityCheck_Init">
                      <actions>
                        <!-- build all possible cases -->
                        <!-- there are 256 legal puzzle states, as each switch can only be "activated by player" or "not activated by player", regardless of the switch being on or off. (binary counting to 11111111) -->
                        <create_list name="$PlayerStates" comment="all possible switch states as activated by player"/>
                        <do_all exact="2" counter="$s1">
                          <set_value name="$state_1" exact="($s1 - 1)" comment="either 0 or 1"/>
                          <do_all exact="2" counter="$s2">
                            <set_value name="$state_2" exact="($s2 - 1)" comment="either 0 or 1"/>
                            <do_all exact="2" counter="$s3">
                              <set_value name="$state_3" exact="($s3 - 1)" comment="either 0 or 1"/>
                              <do_all exact="2" counter="$s4">
                                <set_value name="$state_4" exact="($s4 - 1)" comment="either 0 or 1"/>
                                <do_all exact="2" counter="$s5">
                                  <set_value name="$state_5" exact="($s5 - 1)" comment="either 0 or 1"/>
                                  <do_all exact="2" counter="$s6">
                                    <set_value name="$state_6" exact="($s6 - 1)" comment="either 0 or 1"/>
                                    <do_all exact="2" counter="$s7">
                                      <set_value name="$state_7" exact="($s7 - 1)" comment="either 0 or 1"/>
                                      <do_all exact="2" counter="$s8">
                                        <set_value name="$state_8" exact="($s8 - 1)" comment="either 0 or 1"/>
                                        <set_value name="$PlayerState" exact="[$state_1, $state_2, $state_3, $state_4, $state_5, $state_6, $state_7, $state_8]"/>
                                        <append_to_list name="$PlayerStates" exact="$PlayerState"/>
                                      </do_all>
                                    </do_all>
                                  </do_all>
                                </do_all>
                              </do_all>
                            </do_all>
                          </do_all>
                        </do_all>

                        <!-- Now for every $PlayerState we want to build the Riddle state, meaning we deduct which switches are on or off -->
                        <!-- It's possible that multiple riddle states are the same, as multiple player states might lead to the same puzzle state -->
                        <create_list name="$RiddleStates" comment="all possible riddle states"/>
                        <do_for_each in="$PlayerStates" name="$state">
                          <set_value name="$RiddleState" exact="[0,0,0,0,0,0,0,0]"/>
                          <do_if value="$state.{1} == 1">
                            <set_value name="$RiddleState.{1}" exact="if $RiddleState.{1} then 0 else 1"/>
                            <set_value name="$RiddleState.{2}" exact="if $RiddleState.{2} then 0 else 1"/>
                          </do_if>
                          <do_if value="$state.{2} == 1">
                            <set_value name="$RiddleState.{1}" exact="if $RiddleState.{1} then 0 else 1"/>
                            <set_value name="$RiddleState.{2}" exact="if $RiddleState.{2} then 0 else 1"/>
                            <set_value name="$RiddleState.{3}" exact="if $RiddleState.{3} then 0 else 1"/>
                          </do_if>
                          <do_if value="$state.{3} == 1">
                            <set_value name="$RiddleState.{3}" exact="if $RiddleState.{3} then 0 else 1"/>
                            <set_value name="$RiddleState.{4}" exact="if $RiddleState.{4} then 0 else 1"/>
                          </do_if>
                          <do_if value="$state.{4} == 1">
                            <set_value name="$RiddleState.{5}" exact="if $RiddleState.{5} then 0 else 1"/>
                            <set_value name="$RiddleState.{4}" exact="if $RiddleState.{4} then 0 else 1"/>
                          </do_if>
                          <do_if value="$state.{5} == 1">
                            <set_value name="$RiddleState.{5}" exact="if $RiddleState.{5} then 0 else 1"/>
                            <set_value name="$RiddleState.{4}" exact="if $RiddleState.{4} then 0 else 1"/>
                          </do_if>
                          <do_if value="$state.{6} == 1">
                            <set_value name="$RiddleState.{5}" exact="if $RiddleState.{5} then 0 else 1"/>
                            <set_value name="$RiddleState.{6}" exact="if $RiddleState.{6} then 0 else 1"/>
                          </do_if>
                          <do_if value="$state.{7} == 1">
                            <set_value name="$RiddleState.{7}" exact="if $RiddleState.{7} then 0 else 1"/>
                            <set_value name="$RiddleState.{8}" exact="if $RiddleState.{8} then 0 else 1"/>
                          </do_if>
                          <do_if value="$state.{8} == 1">
                            <set_value name="$RiddleState.{6}" exact="if $RiddleState.{6} then 0 else 1"/>
                            <set_value name="$RiddleState.{7}" exact="if $RiddleState.{7} then 0 else 1"/>
                            <set_value name="$RiddleState.{8}" exact="if $RiddleState.{8} then 0 else 1"/>
                          </do_if>
                          <append_to_list name="$RiddleStates" exact="$RiddleState"/>
                        </do_for_each>

                        <!-- List for illegal riddle states we try to reset, debugging -->
                        <create_list name="$DEBUG_IllegalRiddleStateDetected"/>
                        <set_value name="$DEBUG_IllegalRiddleResetCounter" exact="0"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_7_LegalityCheck_Signal">
                          <actions>
                            <signal_cue cue="Ch6_7_LegalityCheck"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_7_LegalityCheck" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- check if current riddle state is in the list of legal (solvable) riddle states -->
                            <set_value name="$currentState" exact="[$EarthTorusDataSwitch1.isfunctional, $EarthTorusDataSwitch2.isfunctional, $EarthTorusDataSwitch3.isfunctional, $EarthTorusDataSwitch4.isfunctional, $EarthTorusDataSwitch5.isfunctional, $EarthTorusDataSwitch6.isfunctional, $EarthTorusDataSwitch7.isfunctional, $EarthTorusDataSwitch8.isfunctional]"/>
                            <do_if value="$RiddleStates.indexof.{$currentState}">
                              <!-- legal state, we do nothing -->
                            </do_if>
                            <do_else>
                              <debug_text text="'Illegal Torus Riddle State (unsolvable)! Resetting Riddle. ' + $currentState" chance="$DebugChance"/>
                              <do_if value="not $DEBUG_IllegalRiddleStateDetected.indexof.{$currentState}">
                                <append_to_list name="$DEBUG_IllegalRiddleStateDetected" exact="$currentState"/>
                              </do_if>
                              <set_value name="$DEBUG_IllegalRiddleResetCounter" operation="add"/>
                              <!-- RESET THE RIDDLE -->
                              <signal_cue_instantly cue="Ch6_7_Riddle_Switches_Reset"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="DEBUG_PrintStates">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <debug_text text="'PlayerStates'"/>
                            <do_for_each in="$PlayerStates" name="$s">
                              <debug_text text="$s"/>
                            </do_for_each>
                            <debug_text text="'RiddleStates'"/>
                            <do_for_each in="$RiddleStates" name="$s">
                              <debug_text text="$s"/>
                            </do_for_each>
                          </actions>
                        </cue>

                        <cue name="DEBUG_Switch_CreateIllegalState">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$IgnoreSwitch" exact="true"/>
                            <set_object_hull object="$EarthTorusDataSwitch1" exact="if $EarthTorusDataSwitch1.isfunctional then $SwitchHullMin else $SwitchHullMax"/>
                            <set_object_hull object="$EarthTorusDataSwitch3" exact="if $EarthTorusDataSwitch3.isfunctional then $SwitchHullMin else $SwitchHullMax"/>
                            <set_object_hull object="$EarthTorusDataSwitch5" exact="if $EarthTorusDataSwitch5.isfunctional then $SwitchHullMin else $SwitchHullMax"/>
                            <set_object_hull object="$EarthTorusDataSwitch7" exact="if $EarthTorusDataSwitch7.isfunctional then $SwitchHullMin else $SwitchHullMax"/>
                            <set_value name="$IgnoreSwitch" exact="false"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Switch1" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch1"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch1"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$LastSwitch" exact="$EarthTorusDataSwitch1"/>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle2_IgnoreTimed"/>-->
                        <!--<set_object_hull object="$EarthTorusDataSwitch2" exact="if $EarthTorusDataSwitch2.isfunctional then 10 else 92"/>-->
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch1,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch2]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_Riddle2_Torus_React"/>
                        <signal_cue cue="Ch6_7_YakiScientist_Switch_Undo_Hint" check="false" comment="We know this one is false and give a hint once"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Switch2" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch2"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch2"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$LastSwitch" exact="$EarthTorusDataSwitch2"/>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle2_IgnoreTimed"/>-->
                        <!--<set_object_hull object="$EarthTorusDataSwitch1" exact="if $EarthTorusDataSwitch1.isfunctional then 10 else 92"/>
                        <set_object_hull object="$EarthTorusDataSwitch3" exact="if $EarthTorusDataSwitch3.isfunctional then 10 else 92"/>-->
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch2,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch1, $EarthTorusDataSwitch3]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_Riddle2_Torus_React"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Switch3" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch3"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch3"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$LastSwitch" exact="$EarthTorusDataSwitch3"/>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle2_IgnoreTimed"/>-->
                        <!--<set_object_hull object="$EarthTorusDataSwitch4" exact="if $EarthTorusDataSwitch4.isfunctional then 10 else 92"/>-->
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch3,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch4]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_Riddle2_Torus_React"/>
                        <signal_cue cue="Ch6_7_YakiScientist_Switch_Undo_Hint" check="false" comment="We know this one is false and give a hint once"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Switch4" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch4"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch4"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$LastSwitch" exact="$EarthTorusDataSwitch4"/>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle2_IgnoreTimed"/>-->
                        <!--<set_object_hull object="$EarthTorusDataSwitch5" exact="if $EarthTorusDataSwitch5.isfunctional then 10 else 92"/>-->
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch4,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch5]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_Riddle2_Torus_React"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Switch5" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch5"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch5"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$LastSwitch" exact="$EarthTorusDataSwitch5"/>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle2_IgnoreTimed"/>-->
                        <!--<set_object_hull object="$EarthTorusDataSwitch4" exact="if $EarthTorusDataSwitch4.isfunctional then 10 else 92"/>-->
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch5,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch4]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_Riddle2_Torus_React"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Switch6" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch6"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch6"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$LastSwitch" exact="$EarthTorusDataSwitch6"/>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle2_IgnoreTimed"/>-->
                        <!--<set_object_hull object="$EarthTorusDataSwitch5" exact="if $EarthTorusDataSwitch5.isfunctional then 10 else 92"/>-->
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch6,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch5]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_Riddle2_Torus_React"/>
                        <signal_cue cue="Ch6_7_YakiScientist_Switch_Undo_Hint" check="false" comment="We know this one is false and give a hint once"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Switch7" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch7"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch7"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$LastSwitch" exact="$EarthTorusDataSwitch7"/>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle2_IgnoreTimed"/>-->
                        <!--<set_object_hull object="$EarthTorusDataSwitch8" exact="if $EarthTorusDataSwitch8.isfunctional then 10 else 92"/>-->
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch7,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch8]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_Riddle2_Torus_React"/>
                        <signal_cue cue="Ch6_7_YakiScientist_Switch_Undo_Hint" check="false" comment="We know this one is false and give a hint once"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Switch8" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_hull_above_function_threshold object="$EarthTorusDataSwitch8"/>
                          <event_object_hull_below_function_threshold object="$EarthTorusDataSwitch8"/>
                        </check_any>
                        <check_value value="not $IgnoreSwitch"/>
                      </conditions>
                      <actions>
                        <set_value name="parent.$LastSwitch" exact="$EarthTorusDataSwitch8"/>
                        <!--<signal_cue_instantly cue="Ch6_7_Riddle2_IgnoreTimed"/>-->
                        <!--<set_object_hull object="$EarthTorusDataSwitch6" exact="if $EarthTorusDataSwitch7.isfunctional then 10 else 92"/>
                        <set_object_hull object="$EarthTorusDataSwitch7" exact="if $EarthTorusDataSwitch7.isfunctional then 10 else 92"/>-->
                        <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Notifications" param="[$EarthTorusDataSwitch8,
                                              if event.name == 'event_object_hull_above_function_threshold' then true else false,
                                              [$EarthTorusDataSwitch6,$EarthTorusDataSwitch7]]"
                                              comment="[Switch triggered by player, switch now active?, [list of affected switches]]"/>
                        <signal_cue cue="Ch6_7_Riddle2_Torus_React"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Riddle2_Solved" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                        <check_all exact="$EarthTorusDataSwitches.count" counter="$i">
                          <check_value value="$EarthTorusDataSwitches.{$i}.isfunctional"/>
                          <!--debug_text text="'i=' + $i + ' functional=' + $EarthTorusDataSwitches.{$i}.isfunctional"/-->
                        </check_all>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_7_Betty_TransferResumed2"/>
                        <set_value name="$DownloadProgressLimit" exact="100" comment="when reachign 100 story continues"/>

                        <clear_group group="$EarthTorusHackedSwitchesFX" comment="solved the riddle, no more hacked switches"/>

                        <add_to_group groupname="$EarthTorusDataSwitchesFX" group="$EarthTorusDataSwitches" comment="all 8 now electric fx"/>
                        <do_for_each name="this.$switch" in="$EarthTorusDataSwitches">
                          <set_object_min_hull object="this.$switch" exact="$SwitchHullMax" comment="riddle solved, lock state while downloadprogress runs to 100"/>
                        </do_for_each>
                        <cancel_cue cue="Ch6_7_Riddle2"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_Hacked_DEBUG" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_for_each name="this.$switch" in="$EarthTorusDataSwitches">
                          <set_object_hacked object="this.$switch" duration="30s"/>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="Ch6_7_HackedReset_DEBUG" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_for_each name="this.$switch" in="$EarthTorusDataSwitches">
                          <set_object_hacked object="this.$switch" duration="1s" />
                        </do_for_each>
                      </actions>
                    </cue>


                  </cues>
                </cue>

                <cue name="Ch6_7_Riddle_Switches_Reset" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_object_changed_sector object="player.entity" previous="$Earth"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_value name="$IgnoreSwitch" exact="true"/>
                    <clear_group group="$EarthTorusHackedSwitchesFX"/>
                    <do_for_each name="this.$switch" in="$EarthTorusDataSwitches">
                      <set_object_min_hull object="this.$switch" exact="$SwitchHullMin"/>
                      <set_object_hull object="this.$switch" exact="$SwitchHullMin"/>
                      <trigger_animation object="this.$switch" trigger="open_doors"/>
                      <set_object_hull_unrepairable object="this.$switch" unrepairable="false"/>
                    </do_for_each>
                    <set_value name="$IgnoreSwitch" exact="false"/>
                    <signal_cue cue="Ch6_7_Riddle2_Objective"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_7_Betty_AllSwitchesDeactivated_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224666]]" comment="(switch)All switches have been deactivated."/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--
                        <t id="30224666">(switch)All switches have been deactivated.</t>
                          -->
                    </cue>
                  </cues>
                </cue>
                <cue name="Patch_Riddle_Switches_Reset" onfail="cancel">
                  <conditions>
                    <check_value value="player.sector != $Earth"/>
                  </conditions>
                  <actions>
                    <set_value name="$IgnoreSwitch" exact="true"/>
                    <do_for_each name="this.$switch" in="$EarthTorusDataSwitches">
                      <set_object_hull object="this.$switch" exact="$SwitchHullMin"/>
                    </do_for_each>
                    <set_value name="$IgnoreSwitch" exact="false"/>
                  </actions>
                </cue>

                <cue name="Ch6_7_Riddle_Switch_Notifications" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="this.$SwitchTriggered" exact="event.param.{1}" comment="switch triggered by player"/>
                    <set_value name="this.$SwitchActivated" exact="event.param.{2}" comment="true if above function treshold"/>
                    <set_value name="this.$Switches"        exact="event.param.{3}" comment="list of affected switches"/>

                    <!-- First Switch Activated/Deactivated by the Player -->
                    <do_if value="this.$SwitchActivated">
                      <substitute_text text="this.$message" source="{30224,90001}" comment="Switch $ID$ activated(activated by player)">
                        <replace string="'$ID$'" with="$EarthTorusDataSwitchNumbers.{this.$SwitchTriggered}" />
                      </substitute_text>
                    </do_if>
                    <do_else>
                      <substitute_text text="this.$message" source="{30224,90002}" comment="Switch $ID$ deactivated(deactivated by player)">
                        <replace string="'$ID$'" with="$EarthTorusDataSwitchNumbers.{this.$SwitchTriggered}" />
                      </substitute_text>
                    </do_else>
                    <!-- Betty voice lines: -->
                    <!--                    
                     <t id="30224662">(switch)Activated switch:(number)</t>
                     <t id="30224663">(switch)Deactivated switch:(number)</t>
                     <t id="30224664">(switch)Affected switch:(number)</t>
                     <t id="30224665">(switch)Affected switches:(multiple numbers)</t>
                    -->
                    <set_value name="$BettySwitchTriggered" exact="if this.$SwitchActivated then [30224662] else [30224663]"/>

                    <set_value name="$BettySwitchNumberLines" exact="[$BettySwitchTriggered, [$EarthTorusDataSwitchVoiceLines.{this.$SwitchTriggered}]]"/>
                    <do_if value="this.$Switches.count ge 1">
                      <set_value name="$BettyAffectedSwitches" exact="if (this.$Switches.count == 1) then [30224664] else [30224665]"/>
                      <append_to_list name="$BettySwitchNumberLines" exact="$BettyAffectedSwitches"/>
                    </do_if>

                    <!-- Switches Activated/Deactivated by other Switches -->
                    <set_value name="$IgnoreSwitch" exact="true"/>
                    <do_for_each in="this.$Switches" name="$switch">
                      <do_if value="$switch.isfunctional">
                        <set_object_hull object="$switch" exact="$SwitchHullMin"/>
                        <substitute_text text="this.$message_append" source="{30224,90006}" comment="Switch $ID$ is now inoperational(status report)">
                          <replace string="'$ID$'" with="$EarthTorusDataSwitchNumbers.{$switch}" />
                        </substitute_text>
                      </do_if>
                      <do_else>
                        <set_object_hull object="$switch" exact="$SwitchHullMax"/>
                        <substitute_text text="this.$message_append" source="{30224,90005}" comment="Switch $ID$ is now operational(status report)">
                          <replace string="'$ID$'" with="$EarthTorusDataSwitchNumbers.{$switch}" />
                        </substitute_text>
                      </do_else>
                      <set_value name="this.$message" exact="this.$message + '\n' + this.$message_append"/>
                      <append_to_list name="$BettySwitchNumberLines" exact="[$EarthTorusDataSwitchVoiceLines.{$switch}]"/>
                    </do_for_each>

                    <!-- Unlock $IgnoreSwitch right after the switch effects on other switches are done -->
                    <set_value name="$IgnoreSwitch" exact="false"/>
                    <signal_cue cue="Ch6_7_Riddle1_Solved" check="false" comment="check if solved"/>

                    <signal_cue_instantly cue="Ch6_7_Riddle_Switch_Voiceline" param="$BettySwitchNumberLines"/>
                    <show_notification text="this.$message" sound="notification_generic" comment="switch (deactivated)/operational" timeout="10s" priority="2"/>

                  </actions>
                </cue>

                <cue name="Ch6_7_Riddle_Switch_Voiceline" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="not $VoiceBettyRiddleActive?"/>
                  </conditions>
                  <actions>
                    <set_value name="$VoiceBettyRiddleActive"/>
                    <set_value name="this.$Lines" exact="event.param"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_7_Riddle_Switch_Voiceline_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="parent.$Lines" comment="Numerals of Switches"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch6_7_Unlock_Riddle_Switch_Voicelines"/>
                    </cue>
                    <cue name="Ch6_7_Unlock_Riddle_Switch_Voicelines">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_value name="$VoiceBettyRiddleActive"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_7_BypassRiddles_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$DownloadProgress" exact="95"/>
                    <set_value name="$DownloadProgressLimit" exact="100"/>
                    <add_to_group groupname="$EarthTorusDataSwitchesFX" group="$EarthTorusDataSwitches" comment="all 8 now electric fx"/>
                    <do_for_each name="this.$switch" in="$EarthTorusDataSwitches">
                      <set_object_min_hull object="this.$switch" exact="$SwitchHullMax" comment="riddle solved, lock state while downloadprogress runs to 100"/>
                    </do_for_each>
                    <cancel_cue cue="Ch6_7_Riddle1"/>
                    <cancel_cue cue="Ch6_7_Riddle2"/>
                  </actions>
                </cue>

                <cue name="Ch6_7_Download" comment="auto-increment up to limit, signal Ch6_7_Download_Complete when reaching 100">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$DownloadProgress" exact="0"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_7_Downloading_Progress" checkinterval="1s" instantiate="true">
                      <conditions>
                        <check_value value="$DownloadProgress lt $DownloadProgressLimit"/>
                      </conditions>
                      <actions>
                        <set_value name="$DownloadProgress" operation="add"/>

                        <do_if value="$DownloadProgress == 30">
                          <signal_cue cue="Ch6_7_Betty_TransferPaused1" comment="updates objective to objective.find"/>
                        </do_if>
                        <do_elseif value="$DownloadProgress == 60" comment="updates objective to objective.find">
                          <signal_cue cue="Ch6_7_Betty_TransferPaused2"/>
                        </do_elseif>
                        <do_elseif value="$DownloadProgress ge 100">
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.wait" text="{30224,6026}" comment="Download Complete..." updatebriefing="true" silent="true">
                            <progress  progress="$DownloadProgress" max="100"/>
                          </set_objective>
                          <signal_cue cue="Ch6_7_Betty_TransferComplete"/>
                        </do_elseif>
                        <do_else>
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.wait" text="{30224,6025}" comment="Downloading Data..." updatebriefing="true" silent="true">
                            <progress  progress="$DownloadProgress" max="100"/>
                          </set_objective>
                        </do_else>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_7_Betty_TransferComplete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <!--<cue name="Ch6_7_Betty_TransferComplete_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224705]]" comment="Data transfer complete"/>
                      <param name="EndSignalCue"      value="Ch6_7_Download_Complete"/>
                    </cue>-->

                    <cue name="Ch6_7_Betty_TransferComplete_Torus_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$BettyActor, $TorusActor]"/>
                      <param name="Cutscene"          value="[$ShowBettyShipCutscene, true]"/>
                      <param name="CutsceneKey"       value="[$BettyActorCutsceneKey, $TorusActorCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                              [[30224705]],
                                                              [[30224667], [30224668]]
                                                             ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[Unlock_Achievement_Torus_Data, Ch6_7_Download_Complete]"/>
                      <!--
                      <t id="	30224	705	">	Data transfer completed.	</t>
                      -->
                      <!--                         
                         <t id="30224667">Archives breached.</t>
                         <t id="30224668">Initiating data corruption.</t>
                         -->
                    </cue>

                    <cue name="Unlock_Achievement_Torus_Data">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <unlock_achievement name="COH_PLOT_TF_1" comment="Gather Essential Data"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_7_Download_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--<write_incoming_message source="$BettyActor.knownname" highpriority="true"
                                            title="{30224,13201}"
                                             text="{30224,13202}"
                                            comment="Subject: Mission Update Report">
                      <cutscene key="'OrbitIndefinitely'" param="$BettyShip" />
                    </write_incoming_message>-->
                  </actions>
                  <cues>
                    <cue name="Ch6_7_Download_Complete_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$YakiScientistActor"/>
                      <param name="Cutscene"          value="true"/>
                      <param name="CutsceneKey"       value="$YakiScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224677], [30224678]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch6_7_Download_Complete_Speak_Done"/>
                      <!--
                      <t id="	30224	677	">	We have what we came for!	</t>
                      <t id="	30224	678	">	Let's get out of here!	</t>
                      -->
                    </cue>

                    <cue name="Ch6_7_Download_Complete_Speak_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="0.5s"/>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.retreat" text="{30224,6027}" comment="Escape the Torus" object="$EarthTorusMarker_18" updatebriefing="true"/>
                        <signal_cue cue="Ch6_7_Complete"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>


                <cue name="Ch6_7_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_object_min_hull object="$EarthTorusDoorControls_12" exact="$SwitchHullMin" comment="can toggle it now to leave the dataroom"/>
                    <set_object_hull object="$EarthTorusDoorControls_12" exact="$SwitchHullMin" comment="auto-open"/>
                    <trigger_animation object="$EarthTorusDoorControls_12" trigger="open_doors"/>
                    <signal_cue cue="Ch6_8_EscapeTunnel"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_8_EscapeTunnel">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <append_to_list name="md.$MissionDND" exact="Ch6_8_EscapeTunnel"/>
                <find_object_component name="$EarthTorusDoorControls_18" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_18" required="true" comment="Opens door to exit the torus"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="Ch6_8_Explosion_Dataroom_Control"/>
              </actions>
              <delay exact="15s" comment="definitely starts after 15 seconds, might be signalled earlier (distance)"/>
              <actions>
                <signal_cue cue="Ch6_8_Explosions_Hallway_Control" check="false"/>
              </actions>
              <cues>

                <cue name="Ch6_8_Evacuate" checkinterval="1s">
                  <conditions>
                    <check_value value="(player.sector == $EarthTorusMarker_13.sector) and (player.entity.distanceto.{$EarthTorusMarker_13} lt 100m)"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_8_Explosions_Hallway_Control" check="false" comment="might be signalled earlier (timed)"/>
                  </actions>
                </cue>

                <cue name="Ch6_8_LightStrobe">
                  <actions>
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight011_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight012_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight013_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight014_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight015_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight016_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight017_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight018_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight019_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight020_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight021_macro" recursive="true" required="true" />
                    <find_object_component groupname="$EarthTorus_EscapeLights" object="$EarthTorus" macro="macro.torus_switchlight022_macro" recursive="true" required="true" />
                    <set_value name="this.$LightIndex"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_8_Strobe">
                      <actions>
                        <trigger_animation object="$EarthTorus_EscapeLights.{parent.$LightIndex}" trigger="activate"/>
                      </actions>
                      <delay exact="0.2s"/>
                      <actions>
                        <trigger_animation object="$EarthTorus_EscapeLights.{parent.$LightIndex}" trigger="deactivate"/>
                        <set_value name="parent.$LightIndex" operation="add"/>
                        <do_if value="parent.$LightIndex gt $EarthTorus_EscapeLights.count">
                          <set_value name="parent.$LightIndex" exact="1"/>
                        </do_if>
                        <reset_cue cue="Ch6_8_Strobe"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_8_Explosions_Dataroom" namespace="this">
                  <actions>
                    <find_object_component groupname="$Explosions" object="Start.$EarthTorus" macro="macro.explosion_pos_dummy_macro" grouptag="tag.explosion_1" recursive="true" multiple="true"/>
                    <set_value name="$delay" exact="5s"/>
                    <set_value name="$countmin" exact="1"/>
                    <set_value name="$countmax" exact="1"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_8_Explosion_Dataroom_Periodic">
                      <delay exact="$delay + [0.1s, 0.2s, 0.3s, 0.4s].random"/>
                      <actions>
                        <set_value name="this.$i" exact="0"/>
                        <set_value name="$countrnd" min="$countmin" max="$countmax"/>
                        <!--debug_text text="'go rnd=' + $countrnd + '    min=' + $countmin + ' max=' + $countmax"/-->
                        <do_while value="this.$i lt $countrnd">
                          <set_value name="this.$exp" exact="$Explosions.random"/>
                          <add_effect object="this.$exp" effect="'tm_explosion'">
                            <position x="[-100,-75,-50,-25,0,25,50,75,100].random" y="[-15,-10,-5,0,5,10,15].random" z="[-100,-75,-50,-25,0,25,50,75,100].random" object="this.$exp"/>
                          </add_effect>
                          <set_value name="this.$i" operation="add"/>
                        </do_while>
                        <reset_cue cue="Ch6_8_Explosion_Dataroom_Periodic"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_8_Explosion_Dataroom_Control">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Phase 0'" chance="Start.$DebugChance"/>
                        <reset_cue cue="Ch6_8_Explosion_Dataroom_Periodic"/>
                        <set_value name="$countmin" exact="0"/>
                        <set_value name="$countmax" exact="2"/>
                        <set_value name="$delay" exact="1s"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <debug_text text="'Phase 1'" chance="Start.$DebugChance"/>
                        <set_value name="$countmin" exact="1"/>
                        <set_value name="$countmax" exact="3"/>
                        <set_value name="$delay" exact="0.5s"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <debug_text text="'Phase 2'" chance="Start.$DebugChance"/>
                        <set_value name="$countmin" exact="2"/>
                        <set_value name="$countmax" exact="4"/>
                        <set_value name="$delay" exact="0.35s"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <debug_text text="'Phase 3'" chance="Start.$DebugChance"/>
                        <set_value name="$countmin" exact="($Explosions.count * 0.50)i"/>
                        <set_value name="$countmax" exact="($Explosions.count * 1.50)i "/>
                        <set_value name="$delay" exact="0.5s"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <debug_text text="'Phase 4'" chance="Start.$DebugChance"/>
                        <set_value name="$countmin" exact="($Explosions.count * 2.00)i"/>
                        <set_value name="$countmax" exact="($Explosions.count * 3.00)i "/>
                        <set_value name="$delay" exact="0.25s"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_8_Explosions_Hallway" namespace="this">
                  <actions>
                    <set_value name="$params1" exact="[1s, 0, 2]"/>
                    <set_value name="$params2" exact="[1s, 0, 2]"/>
                    <set_value name="$params3" exact="[1s, 0, 2]"/>
                    <set_value name="$params4" exact="[1s, 0, 2]"/>
                    <set_value name="$params5" exact="[1s, 0, 2]"/>
                    <find_object_component name="$ReferencePosition" object="Start.$EarthTorus" macro="macro.torus_switchlight011_macro" recursive="true" required="true" />
                    <find_object_component name="$ExplosionsList" groupname="$Explosions" object="Start.$EarthTorus" macro="macro.explosion_pos_dummy_macro" grouptag="tag.explosion_2" sortbydistanceto="$ReferencePosition" recursive="true" multiple="true"/>

                    <create_group groupname="$ExplosionGroup1"/>
                    <create_group groupname="$ExplosionGroup2"/>
                    <create_group groupname="$ExplosionGroup3"/>
                    <create_group groupname="$ExplosionGroup4"/>
                    <create_group groupname="$ExplosionGroup5"/>
                    <clear_group group="$ExplosionGroup1"/>
                    <clear_group group="$ExplosionGroup2"/>
                    <clear_group group="$ExplosionGroup3"/>
                    <clear_group group="$ExplosionGroup4"/>
                    <clear_group group="$ExplosionGroup5"/>
                    <set_value name="$i" exact="0"/>
                    <set_value name="$group" exact="1"/>

                    <do_for_each name="this.$expl" in="$Explosions">
                      <set_value name="$i" operation="add"/>
                      <do_if value="$i gt ($Explosions.count / 5)">
                        <set_value name="$i" exact="0"/>
                        <set_value name="$group" operation="add"/>
                      </do_if>
                      <do_if value="$group==1">
                        <add_to_group groupname="$ExplosionGroup1" object="this.$expl"/>
                      </do_if>
                      <do_elseif value="$group==2">
                        <add_to_group groupname="$ExplosionGroup2" object="this.$expl"/>
                      </do_elseif>
                      <do_elseif value="$group==3">
                        <add_to_group groupname="$ExplosionGroup3" object="this.$expl"/>
                      </do_elseif>
                      <do_elseif value="$group==4">
                        <add_to_group groupname="$ExplosionGroup4" object="this.$expl"/>
                      </do_elseif>
                      <do_elseif value="$group==5">
                        <add_to_group groupname="$ExplosionGroup5" object="this.$expl"/>
                      </do_elseif>
                    </do_for_each>
                  </actions>
                  <cues>

                    <cue name="Ch6_8_Explosions_Hallway_Trigger" instantiate="true" namespace="this">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="event.param.{1}.count" comment="ignore empty groups"/>
                      </conditions>
                      <actions>
                        <set_value name="$Explosions" exact="event.param.{1}"/>
                        <set_value name="$countmin" exact="event.param.{2}"/>
                        <set_value name="$countmax" exact="event.param.{3}"/>
                        <set_value name="$fx" exact="event.param.{4}"/>

                        <set_value name="$i" exact="0"/>
                        <set_value name="$countrnd" min="$countmin" max="$countmax"/>
                        <do_while value="$i lt $countrnd">
                          <set_value name="$exp" exact="$Explosions.random"/>
                          <add_effect object="this.$exp" effect="$fx">
                            <position x="[-50,-25,0,25,50].random" y="[-15,-10,-5,0,5,10,15].random" z="[-50,-25,0,25,50].random" object="this.$exp"/>
                          </add_effect>

                          <set_value name="$i" operation="add"/>
                        </do_while>
                      </actions>
                    </cue>

                    <cue name="Ch6_8_Explosions_Hallway_Periodic1_Wait">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_8_Explosion_Dataroom_Periodic1">
                          <delay exact="$params1.{1} + [0.1s, 0.2s, 0.3s].random"/>
                          <actions>
                            <signal_cue_instantly cue="Ch6_8_Explosions_Hallway_Trigger" param="[$ExplosionGroup1, $params1.{2}, $params1.{3}, $params1.{4}]"/>
                            <reset_cue cue="Ch6_8_Explosion_Dataroom_Periodic1"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_8_Explosions_Hallway_Periodic2_Wait">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_8_Explosion_Dataroom_Periodic2">
                          <delay exact="$params2.{1} + [0.1s, 0.2s, 0.3s].random"/>
                          <actions>
                            <signal_cue_instantly cue="Ch6_8_Explosions_Hallway_Trigger" param="[$ExplosionGroup2, $params2.{2}, $params2.{3}, $params2.{4}]"/>
                            <reset_cue cue="Ch6_8_Explosion_Dataroom_Periodic2"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_8_Explosions_Hallway_Periodic3_Wait">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_8_Explosion_Dataroom_Periodic3">
                          <delay exact="$params3.{1} + [0.1s, 0.2s, 0.3s].random"/>
                          <actions>
                            <signal_cue_instantly cue="Ch6_8_Explosions_Hallway_Trigger" param="[$ExplosionGroup3, $params3.{2}, $params3.{3}, $params3.{4}]"/>
                            <reset_cue cue="Ch6_8_Explosion_Dataroom_Periodic3"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_8_Explosions_Hallway_Periodic4_Wait">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_8_Explosion_Dataroom_Periodic4">
                          <delay exact="$params4.{1} + [0.1s, 0.2s, 0.3s].random"/>
                          <actions>
                            <signal_cue_instantly cue="Ch6_8_Explosions_Hallway_Trigger" param="[$ExplosionGroup4, $params4.{2}, $params4.{3}, $params4.{4}]"/>
                            <reset_cue cue="Ch6_8_Explosion_Dataroom_Periodic4"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_8_Explosions_Hallway_Periodic5_Wait">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_8_Explosion_Dataroom_Periodic5">
                          <delay exact="$params5.{1} + [0.1s, 0.2s, 0.3s].random"/>
                          <actions>
                            <signal_cue_instantly cue="Ch6_8_Explosions_Hallway_Trigger" param="[$ExplosionGroup5, $params5.{2}, $params5.{3}, $params5.{4}]"/>
                            <reset_cue cue="Ch6_8_Explosion_Dataroom_Periodic5"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_8_Explosions_Hallway_Control">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$params1" exact="[0.5s, 1, 1, 'tm_explosion']"/>
                        <set_value name="$params2" exact="[0.5s, 1, 1, 'tm_explosion_mini']"/>
                        <set_value name="$params3" exact="[0.5s, 1, 1, 'tm_explosion_mini']"/>
                        <set_value name="$params4" exact="[0.5s, 1, 1, 'tm_explosion_mini']"/>
                        <set_value name="$params5" exact="[0.5s, 1, 1, 'tm_explosion_mini']"/>
                        <signal_cue cue="Ch6_8_Explosions_Hallway_Periodic1_Wait" check="false"/>
                        <signal_cue cue="Ch6_8_Explosions_Hallway_Periodic2_Wait" check="false"/>
                        <signal_cue cue="Ch6_8_Explosions_Hallway_Periodic3_Wait" check="false"/>
                        <signal_cue cue="Ch6_8_Explosions_Hallway_Periodic4_Wait" check="false"/>
                        <signal_cue cue="Ch6_8_Explosions_Hallway_Periodic5_Wait" check="false"/>
                      </actions>
                      <delay exact="10s"/>
                      <actions>
                        <set_value name="$params1" exact="[0.5s, 2, 3, 'tm_explosion']"/>
                        <set_value name="$params2" exact="[0.5s, 2, 3, 'tm_explosion']"/>
                        <set_value name="$params3" exact="[0.5s, 1, 3, 'tm_explosion_mini']"/>
                        <set_value name="$params4" exact="[0.5s, 1, 3, 'tm_explosion_mini']"/>
                        <set_value name="$params5" exact="[0.5s, 1, 3, 'tm_explosion_mini']"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <set_value name="$params1" exact="[0.5s, 2, 4, 'tm_explosion']"/>
                        <set_value name="$params2" exact="[0.5s, 2, 4, 'tm_explosion']"/>
                        <set_value name="$params3" exact="[0.5s, 2, 3, 'tm_explosion']"/>
                        <set_value name="$params4" exact="[0.5s, 2, 3, 'tm_explosion_mini']"/>
                        <set_value name="$params5" exact="[0.5s, 2, 3, 'tm_explosion_mini']"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <set_value name="$params1" exact="[0.5s, 4, 8, 'tm_explosion']"/>
                        <set_value name="$params2" exact="[0.5s, 4, 8, 'tm_explosion']"/>
                        <set_value name="$params3" exact="[0.5s, 2, 4, 'tm_explosion']"/>
                        <set_value name="$params4" exact="[0.5s, 2, 4, 'tm_explosion']"/>
                        <set_value name="$params5" exact="[0.5s, 2, 4, 'tm_explosion_mini']"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <set_value name="$params1" exact="[0.5s, 8, 16, 'tm_explosion']"/>
                        <set_value name="$params2" exact="[0.5s, 8, 16, 'tm_explosion']"/>
                        <set_value name="$params3" exact="[0.5s, 8, 16, 'tm_explosion']"/>
                        <set_value name="$params4" exact="[0.5s, 8, 16, 'tm_explosion']"/>
                        <set_value name="$params5" exact="[0.5s, 8, 16, 'tm_explosion']"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_8_Escape1_Approach" checkinterval="0.25s" comment="player still speed-limited">
                  <conditions>
                    <check_value value="($BettyShip.distanceto.{$EarthTorusMarker_19} lt 500) and ($BettyShip.sector == $EarthTorusMarker_19.sector)"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Betty halfway through escape tunnel'" chance="$DebugChance"/>
                    <find_object_component name="$EarthTorusDoorControls_18" object="$EarthTorus" macro="macro.interactive_ter_doorcontrol_01_macro" grouptag="tag.interactionspot_18" required="true" comment="Opens door to exit the torus"/>
                    <set_object_hull object="$EarthTorusDoorControls_18" exact="$SwitchHullMin" comment="auto-open"/>
                  </actions>
                </cue>

                <cue name="Ch6_8_Escape2_Approach" checkinterval="0.25s" comment="no speed-limit anymore, and we don't want to miss the player boosting through">
                  <conditions>
                    <check_value value="($BettyShip.distanceto.{$EarthTorusMarker_21} lt 150) and ($BettyShip.sector == $EarthTorusMarker_21.sector)"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Betty near torus-exit'" chance="$DebugChance"/>
                    <set_object_min_hull object="$EarthTorusDoorControls_18" exact="$SwitchHullMax" comment="lock torus exit (lock backdoor)"/>
                    <trigger_animation object="$EarthTorus" group="tag.interactionspot_19" trigger="activate" comment="lock torus entrance (lock frontdoor)"/>
                  </actions>
                  <delay exact="4s"/>
                  <actions>
                    <signal_cue cue="Ch6_8_Complete"/>
                  </actions>
                </cue>

                <cue name="Ch6_8_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <remove_from_list name="md.$MissionDND" exact="Ch6_8_EscapeTunnel"/>

                    <!-- lock entrances into the torus -->
                    <!-- and to the next chapter -->
                    <signal_cue cue="Ch6_Complete"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Complete" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30224,6021}" text="{30224,6022}" comment="logbook entry title-6004/content-6005"/>
                <cancel_cue cue="parent"/>
                <signal_cue cue="Ch7_Escape"/>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_terraforming_torus"/>
              </actions>
              <patch sinceversion="2" state="complete">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_terraforming_torus"/>
              </patch>
              <patch sinceversion="2" state="cancelled">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_terraforming_torus"/>
              </patch>
            </cue>
          </cues>
        </cue>


        <cue name="Ch7_Force">
          <conditions>
            <event_cue_cancelled cue="this" comment="could contain force content and should not be signallable"/>
          </conditions>
          <actions>
            <set_value name="$AcquiredTerranScan"/>
          </actions>
          <force name="Ch7_Terraforming_Intro">
            <cancel_cue cue="Ch1_Intro"/>
          </force>
          <cues>
            <cue name="Ch7_Check_HQ">
              <actions>
                <do_if value="not $HQ?">
                  <signal_cue cue="Debug_Setup_HQ"/>
                </do_if>
                <signal_cue cue="Ch7_Force_Delay"/>
                <signal_cue cue="Ch4_Setup_MissionShip" check="false"/>
              </actions>
            </cue>
            <cue name="Ch7_Force_Delay">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="10s"/>
              <actions>
                <signal_cue cue="Ch1_Setup_ResearchShip" check="false"/>

                <signal_cue cue="Ch5_Setup_BettyShip_Behaviour"/>
                <set_object_radar_visible object="$BettyShip" visible="true"/>
                <warp object="$BettyShip" sector="$Earth">
                  <safepos value="position.[0,0,0]"/>
                </warp>
                <set_known object="$Earth" known="true"/>
                <teleport_player object="$BettyShip" instant="true" force="true" control="false"/>

              </actions>
              <delay exact="2s"/>
              <actions>
                <set_object_radar_visible object="$ResearchShip" visible="true"/>
                <warp object="$ResearchShip" sector="$Earth">
                  <safepos value="position.[100km,0km,0km]"/>
                </warp>
                <force_cue cue="Ch7_Escape"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- Chapter 7:
              - Player escapes Terran Space
        -->

        <cue name="Ch7_Escape">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>


            <create_mission comment="Mission: Data Transfer" group="missiongroup.story_terraforming"
                            name="{30224,7001}" description="{30224,7002}" rewardtext="{30224,7020}"
                            icon="'briefing_dr_rick_feynman_01'" iconcaption="$HeadScientistActor.name"
                            faction="faction.pioneers" difficulty="level.medium"
                            cue="$MissionCue" abortable="false" type="missiontype.plot">
              <briefing>
                <objective step="$ObjectiveStep" action="objective.wait"/>
              </briefing>
            </create_mission>

            <cancel_cue cue="Ch0_Reporting_To_ChiefScientist"/>
          </actions>
          <cues>

            <cue name="Ch7_Hint_Init">
              <actions>
                <run_actions ref="md.LIB_Generic.SuppressChatter_AddCue">
                  <param name="Cue" value="Ch7_Hint_Init"/>
                </run_actions>
              </actions>
              <cues>
                <cue name="Ch7_Hint_Init_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$YakiScientistActor, $BettyActor, $HeadScientistActor, $YakiScientistActor]"/>
                  <param name="Cutscene"          value="[true, $ShowBettyShipCutscene, true, true]"/>
                  <param name="CutsceneKey"       value="[$YakiScientistActorCutsceneKey, $BettyActorCutsceneKey, $HeadScientistActorCutsceneKey, $YakiScientistActorCutsceneKey]"/>
                  <param name="Lines"             value="[
                                                              [[30224701], [30224702]],
                                                              [[30224701]],
                                                              [[30224701]],
                                                              [[30224703], [30224704], [30224705], [30224706], [30224707]]
                                                             ]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="[null, null, Ch7_Rendezvous, null]"/>
                  <!--
                    Yaki	<t id="	30224	701	">	You got out of there! I was already wondering about possible malfunctions..	</t>
                    Yaki	<t id="	30224	702	">	Did the data transfer go through?	</t>
                    Betty	<t id="	30224	701	">	Requested data has been allocated.	</t>
                    HS	<t id="	30224	701	">	We are at the rendezvous point and ready for transfer.	</t>
                    Yaki	<t id="	30224	703	">	Splendid! Deliver to this location before any pests get to you.	</t>
                    Yaki	<t id="	30224	704	">	And that will conclude my partaking in our cooperation.	</t>
                    Yaki	<t id="	30224	705	">	Both of you have been quite adequate assistants.	</t>
                    Yaki	<t id="	30224	706	">	And I expect that both of you will work together to properly conclude our project.	</t>
                    Yaki	<t id="	30224	707	">	The best of luck and farewell!	</t>
                    xxxBetty <t id="30224708">Farewell, creator.</t>
                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_Rendezvous" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>

                <cancel_cue cue="Ch4_Setup_Align_ResearchShip"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.dockat" group="$ResearchShipGroup" updatebriefing="true"/>
                <do_if value="player.ship != $BettyShip">
                  <do_if value="$BettyShip.dock">
                    <set_objective cue="$MissionCue" action="objective.embark" object="$BettyShip"/>
                  </do_if>
                  <do_else>
                    <set_objective cue="$MissionCue" action="objective.dockat" object="$BettyShip"/>
                  </do_else>
                </do_if>
              </actions>
              <patch sinceversion="2">
                <do_if value="not $ResearchShip.exists">
                  <reset_cue cue="Ch7_PlayerReachedLocation_Success"/>
                </do_if>
              </patch>
              <cues>

                <cue name="Ch7_DND_Timeout">
                  <delay exact="14s"/>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressChatter_RemoveCue">
                      <param name="Cue" value="Ch7_Hint_Init"/>
                    </run_actions>
                  </actions>
                </cue>

                <cue name="Ch7_Patch_Reset_Objective" onfail="cancel">
                  <!-- The Patch node runs too quick, resetting the objective before the new ship is created -->
                  <conditions>
                    <check_value value="Ch7_HS_Conv.state == cuestate.waiting"/>
                    <check_value value="player.ship == $BettyShip"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.dockat" group="$ResearchShipGroup" updatebriefing="true"/>
                  </actions>
                </cue>

                <cue name="Ch7_PlayerReachedLocation_Success" version="2">
                  <conditions>
                    <event_object_docked object="$BettyShip"/>
                    <check_value value="$ResearchShipGroup.indexof.{event.param}"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch7_Rendezvous"/>

                    <!-- Move Research Ship -->
                    <create_position name="$TargetPos" object="$GaianProphecy" space="$GaianProphecy"/>
                    <cancel_all_orders object="$ResearchShip"/>
                    <create_order id="'MoveWait'" object="$ResearchShip" immediate="true">
                      <param name="destination" value="[$GaianProphecy, $TargetPos]"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>

                    <signal_cue cue="BettyShip_Stop_Messages"/>
                    <set_emergency_eject_active active="true"/>
                    <dismiss_control_entity actor="$BettyPilotActor" object="$BettyShip"/>
                    <remove_actor_from_room actor="$BettyPilotActor"/>

                    <signal_cue cue="Ch7_Talk_To_Scientist"/>
                    <!-- Lose Cover -->
                    <remove_value name="$AcquiredTerranScan"/>
                    <signal_objects object="$BettyShip" param="'LoseCover'"/>

                  </actions>
                  <patch sinceversion="2" state="complete">
                    <set_emergency_eject_active active="true"/>
                  </patch>
                  <patch sinceversion="2" state="cancelled">
                    <set_emergency_eject_active active="true"/>
                  </patch>
                </cue>
              </cues>
            </cue>


            <cue name="Ch7_Talk_To_Scientist">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch7_Speech_We_Got_You_v2_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"         value="[$HeadScientistActor, $BettyActor]"/>
                  <param name="Cutscene"      value="[true, $ShowBettyShipCutscene]"/>
                  <param name="CutsceneKey"   value="[$HeadScientistActorCutsceneKey, $BettyActorCutsceneKey]"/>
                  <param name="Lines"         value="[[[30224702]], [[30224710]]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <!-- HS	<t id="	30224	702	">	We got you!	</t>
                            Transfering Data-->
                  <param name="EndSignalCue"  value="[Ch7_HS_Conv, null]"/>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_HS_Conv">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$HeadScientistActor" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch7_Hint_Data_Transfer_Completed" checkinterval="1s">
                  <conditions>
                    <check_value value="$HeadScientistActor.room == player.room"/>
                  </conditions>
                  <actions>
                    <add_faction_relation faction="faction.player" otherfaction="faction.pioneers" value="0.0224" reason="relationchangereason.missioncompleted"/>
                  </actions>
                  <cues>
                    <cue name="Ch7_Hint_Data_Transfer_Completed_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"         value="$BettyActor"/>
                      <param name="Cutscene"      value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"   value="$BettyActorCutsceneKey"/>
                      <param name="Lines"         value="[[30224705]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!-- HS	<t id="	30224705	">	Data transfer completed.	</t>
                            Transfering Data-->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch7_Conv_ChiefScientist_Intro" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$HeadScientistActor"/>
                    <cue_is_waiting cue="Ch7_Conv_ChiefScientist_Main"/>
                    <check_value value="not $Ch7_Conv_ChiefScientist_End_Call?"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <run_actions ref="md.LIB_Generic.SuppressChatter_AddCue">
                      <param name="Cue" value="Ch7_HS_Conv"/>
                    </run_actions>

                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <!--<text line="30224703" comment="Brilliant! Of course the Terrans would never let a ship full of their confidential data escape."/>
                      <text line="30224704" comment="But that won't matter after we vacated the data"/>-->
                      <text line="30224705" comment="At last, we will be able to terraform"/>
                      <text line="30224706" comment="Now it will take a while to decrypt, examine and integrate our treasure into our existing research on terraforming"/>
                      <text line="30224707" comment="It could take years, maybe even decades"/>
                    </add_npc_line>

                    <!-- Was in a seperate cue previously -->
                    <add_npc_line speaker="$BosoTa" hidechoices="true" recipient="$HeadScientistActor">
                      <text line="30224701" comment="Years? Decades?"/>
                      <text line="30224702" comment="Greetings Chief Scientist."/>
                      <text line="30224703" comment="I am immensly sorry to intrude and interrupt, but please bear with me, I have a couple of algorithmsfor your problem."/>
                    </add_npc_line>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true" recipient="$BosoTa">
                      <text line="30224708" comment="You have what?"/>
                    </add_npc_line>
                    <add_npc_line speaker="$BosoTa" hidechoices="true" recipient="$HeadScientistActor">
                      <!--<text line="30224704" comment="Done."/>-->
                      <text line="30224706" comment="The integration of the obtained data into your existing research on terraforming is complete."/>
                    </add_npc_line>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true" recipient="$BosoTa">
                      <text line="30224709" comment="You have done what?(Dumbfounded)"/>
                      <text line="30224710" comment="I can not believe it."/>
                      <text line="30224711" comment="It is all there, we have the results for our research."/>
                      <text line="30224712" comment="With this we can immediately go into execution for Project Genesis.(Project Genesis same as {30224,1})"/>
                      <text line="30224713" comment="Gaian Prophecy will be terraformed!(Gaian Prophecy same as {20005,9019})"/>
                      <text line="30224720" comment="Thank you, Boron."/>
                    </add_npc_line>
                  </actions>
                  <cues>
                    <cue name="Ch7_Conv_Boso_Interrupt" comment="Seperate Cue to make the Scientist turn around to face the player">
                      <!-- Deprecated -->
                    </cue>

                    <cue name="Ch7_Conv_ChiefScientist_End_Call">
                      <conditions>
                        <event_conversation_finished actor="$HeadScientistActor"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch7_Conv_ChiefScientist_Intro"/>
                        <set_value name="$Ch7_Conv_ChiefScientist_End_Call"/>
                        <start_conversation actor="$HeadScientistActor" conversation="ch7_main" missioncue="$MissionCue"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch7_Conv_ChiefScientist_Main">
                  <conditions>
                    <event_conversation_started actor="$HeadScientistActor" conversation="ch7_main"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="Ch7_Conversation_ChiefScientist_Choices"/>
                  </actions>
                  <cues>
                    <cue name="Ch7_Conv_CS_Main_Start" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$HeadScientistActor"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                          <text line="30224001" comment="Greetings"/>
                        </add_npc_line>
                        <signal_cue_instantly cue="Ch7_Conversation_ChiefScientist_Choices"/>
                      </actions>
                    </cue>

                    <cue name="Ch7_Conv_CS_Main_End" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$HeadScientistActor" section="g_cancel"/>
                      </conditions>
                      <actions>
                        <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                          <text line="30224805" comment="Again, great thanks to you for playing your part in this."/>
                          <text line="30224806" comment="Farewell, friend."/>
                        </add_npc_line>
                        <signal_cue cue="Ch7_Grant_Terraforming" check="false"/>
                        <run_actions ref="md.LIB_Generic.SuppressChatter_RemoveCue">
                          <param name="Cue" value="Ch7_HS_Conv"/>
                        </run_actions>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch7_Conversation_ChiefScientist_Choices" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30224,30224702}" comment="What will you do now?"                    section="cs_what_now" highlighted="if $HeadScientistSaid.indexof.{30224730} then false else true"/>
                    <add_player_choice text="{30224,30224701}" comment="What did the freelancer get?"             section="cs_freelancer"/>
                    <add_player_choice text="{30224,30224703}" comment="What about the station?"                  section="cs_station"/>
                    <do_if value="$HeadScientistSaid.indexof.{30224730}">
                      <add_player_choice text="{30224,30224704}" comment="What kind of terraforming?"               section="cs_terraforming" highlighted="if $HeadScientistSaid.indexof.{30224750} then false else true"/>
                    </do_if>
                    <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"     section="g_cancel"/>
                  </actions>
                </cue>

                <cue name="Ch7_Conv_CS_Freelancer" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="cs_freelancer"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224716" comment="The same data, they are getting a copy."/>
                      <text line="30224717" comment="They are interested in Xenon behaviour and believe that understanding the original Terraforming technology will help them understand the Xenon better.('They' Referring to Paranid Gender)"/>
                    </add_npc_line>
                    <signal_cue_instantly cue="Ch7_Conversation_ChiefScientist_Choices"/>
                  </actions>
                </cue>

                <cue name="Ch7_Conv_CS_Now" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="cs_what_now"/>
                  </conditions>
                  <actions>
                    <append_to_list name="$HeadScientistSaid" exact="30224730"/>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224730" comment="With the new technology, we can properly attempt to terraform some of the planets to give our people a home world."/>
                      <text line="30224731" comment="You played a big role in this, and for that we are grateful."/>
                    </add_npc_line>
                    <signal_cue_instantly cue="Ch7_Conversation_ChiefScientist_Choices"/>
                  </actions>
                </cue>

                <cue name="Ch7_Conv_CS_Station" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="cs_station"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224740" comment="We leave it with the Boron."/>
                      <text line="30224741" comment="That is the least we can do after he fast-tracked all of our terraforming research into completion."/>
                      <text line="30224742" comment="I do not know what our Secret service was doing, but it seems to me now that the classification as criminal might have been an overstatement."/>
                      <text line="30224743" comment="At the very least he did seem eager to get this situation resolved without any hostility."/>
                    </add_npc_line>
                    <signal_cue_instantly cue="Ch7_Conversation_ChiefScientist_Choices"/>
                  </actions>
                </cue>

                <cue name="Ch7_Conv_CS_Terraforming" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="cs_terraforming"/>
                  </conditions>
                  <actions>
                    <append_to_list name="$HeadScientistSaid" exact="30224750"/>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224750" comment="We have now access to rather advanced terraforming projects."/>
                      <text line="30224751" comment="That will be required to undo some of the terraforming damage inflicted by the Xenon on Segaris."/>
                      <text line="30224752" comment="I still cannot believe that we are about to achieve what we set out to do."/>
                      <text line="30224753" comment="At last, our people will have a home world."/>
                    </add_npc_line>
                    <signal_cue_instantly cue="Ch7_Conversation_ChiefScientist_Choices"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch7_Grant_Terraforming">
              <conditions>
                <event_cue_signalled/>
                <check_value value="$HeadScientistSaid.indexof.{30224750}"/>
              </conditions>
              <actions>
                <set_objective cue="$MissionCue" action="objective.wait"/>
                <run_actions ref="md.LIB_Generic.SuppressChatter_AddCue">
                  <param name="Cue" value="Ch7_Grant_Terraforming"/>
                </run_actions>
              </actions>
              <cues>

                <cue name="Ch7_Boso_New_TF_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$BosoTa"/>
                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                  <param name="Lines"             value="[[30224710],[30224711]]" comment="x"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="Ch7_Grant_Terraforming_Research"/>
                  <!--<t id="	30224710	">	Assistant! I still have the terraforming data we worked so hard to obtain and assemble.	</t>
                          <t id="	30224711	">	We, too, now have the knowledge to implement new, exciting terraforming projects.	</t>
                    -->
                </cue>

                <cue name="Ch7_Grant_Terraforming_Research">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_userdata storystate="'story_terraforming'" value="1"/>
                    <add_research ware="ware.research_tf_tech"/>
                    <unlock_achievement name="COH_PLOT_TF_3" comment="Advanced Terraforming"/>
                    <show_notification text="{1015,90} + '\n' + ware.research_tf_tech.name" sound="notification_generic" comment="Document received"/>

                    <do_if value="$DalBusta?">
                      <signal_cue cue="Ch7_Dal_New_TF"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch_Hint_TF_Done"/>
                    </do_else>

                    <signal_cue cue="Ch7_Betty_Farewell"/>
                  </actions>
                </cue>

                <cue name="Ch7_Dal_New_TF">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch7_Dal_New_TF_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30224750], [30224751], [30224752]]" comment="x"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch_Hint_TF_Done"/>
                      <!--
                      <t id="	30224750	">	Terraforming, eh?	</t>
                      <t id="	30224751	">	I did hope that we'd dig out something more useful to us space-faring folks out here	</t>
                      <t id="	30224752	">	Nonetheless, it will surely proove useful in our shaping of the gate network.	</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch_Hint_TF_Done">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <run_actions ref="md.LIB_Generic.SuppressChatter_RemoveCue">
                      <param name="Cue" value="Ch7_Grant_Terraforming"/>
                    </run_actions>
                    <set_value name="$Hint_New_TF"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch7_Betty_Farewell">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" operation="add" exact="1"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.embark"  object="$BettyShip" updatebriefing="true"/>
              </actions>
              <cues>

                <cue name="Ch7_Betty_Farewell_Start">
                  <conditions>
                    <event_player_started_control/>
                    <check_value value="player.controlled == $BettyShip"/>
                    <check_value value="$Hint_New_TF?"/>
                  </conditions>
                  <cues>
                    <cue name="Ch7_Hint_Betty_Farewell_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BettyActor"/>
                      <param name="Cutscene"          value="$ShowBettyShipCutscene"/>
                      <param name="CutsceneKey"       value="$BettyActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224711], [30224707], [30224709, 1s, Ch7_Betty_Uploading_Effect], [30224714]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch7_Hint_Betty_Farewell_Completed"/>
                      <!--
                    <t id="30224711">Mission achieved.</t>
                    <t id="30224707">Establishing long-distance uplink to Kuromanckami(Kuromanckami same as {30224,104}).</t>
                    <t id="30224709">Uploading Expedition AI Core Mk7(Expedition AI Core Mk7 same as {30224,101}).</t>                    xxxx<t id="30224706">Initiating data upload.</t>
                    <t id="30224714">Farewell, Pilot #3.(# spoken as 'number')</t>
                   -->
                    </cue>

                    <cue name="Ch7_Betty_Uploading_Effect">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch7_BettyShip_Effect_Red">
                          <delay min="1s" max="2s"/>
                          <actions>
                            <add_effect object="$BettyShip" effect="'signal_leak_discharge_effect'"/>
                            <reset_cue cue="this"/>
                          </actions>
                        </cue>
                        <cue name="Ch7_BettyShip_Effect_Blue">
                          <delay min="1s" max="2s"/>
                          <actions>
                            <add_effect object="$BettyShip" effect="'signal_leak_discharge_effect_red'"/>
                            <reset_cue cue="this"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch7_Hint_Betty_Farewell_Completed" version="3">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <find_object_component name="$Weapons" multiple="true" object="$BettyShip" class="class.weapon"/>
                        <do_for_each name="$Weapon" in="$Weapons">
                          <set_object_hacked object="$Weapon" duration="12s"/>
                        </do_for_each>
                        <find_object_component name="$Engines" multiple="true" object="$BettyShip" class="class.engine"/>
                        <do_for_each name="$Engine" in="$Engines">
                          <set_object_hacked object="$Engine" duration="12s"/>
                        </do_for_each>
                        <set_object_npc_assignment_restricted object="$BettyShip" restricted="false"/>
                        <set_ship_safepos_allowed ship="$BettyShip" allow="true"/>
                        <set_object_sellable object="$BettyShip" sellable="true"/>
                      </actions>
                      <delay exact="12s"/>
                      <actions>
                        <!--<write_incoming_message source="$BettyActor.knownname" highpriority="true"
                                                title="{30224,13301}"
                                                 text="{30224,13302}"
                                                comment="Subject: Mission Termination Report">
                          <cutscene key="'OrbitIndefinitely'" param="$BettyShip" />
                        </write_incoming_message>-->
                        <signal_cue cue="Ch7_Complete"/>
                      </actions>
                      <patch sinceversion="2" state="complete">
                        <do_if value="$BettyShip.exists">
                          <set_ship_safepos_allowed ship="$BettyShip" allow="true"/>
                        </do_if>
                      </patch>
                      <patch sinceversion="2" state="cancelled">
                        <do_if value="$BettyShip.exists">
                          <set_ship_safepos_allowed ship="$BettyShip" allow="true"/>
                        </do_if>
                      </patch>
                      <patch sinceversion="3" state="complete">
                        <do_if value="$BettyShip.exists">
                          <set_object_sellable object="$BettyShip" sellable="true"/>
                        </do_if>
                      </patch>
                      <patch sinceversion="3" state="cancelled">
                        <do_if value="$BettyShip.exists">
                          <set_object_sellable object="$BettyShip" sellable="true"/>
                        </do_if>
                      </patch>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch7_BettyShipDestroyed_Event">
                  <conditions>
                    <event_object_destroyed object="$BettyShip"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch7_Complete"/>
                  </actions>
                </cue>
                <cue name="Ch7_BettyShipDestroyed_Patch" onfail="cancel">
                  <conditions>
                    <check_value value="not $BettyShip.exists"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch7_Complete"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch7_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Cleanup_ResearchShip"/>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30224,7021}" text="{30224,7022}"/>
                <cancel_cue cue="parent"/>
                <signal_cue cue="Ch8_Terraforming"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Ch8_Force">
          <force name="Ch8_Terraforming_Intro">
            <!-- Special setup actions when you "fast-forward" into a chapter (skipping earlier ones) -->

            <force_cue cue="Ch8_Terraforming"/>
            <add_research ware="ware.research_tf_tech"/>
            <show_notification text="{1015,90} + '\n' + ware.research_tf_tech.name" sound="notification_generic" comment="Document received"/>
          </force>
        </cue>

        <!-- Chapter 8:
              - Player gets updates on Terraforming progress
        -->

        <cue name="Ch8_Terraforming" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Probably no Mission Here, Just updates on terraforming -->
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>
          </actions>
          <patch sinceversion="2" state="cancelled">
            <signal_cue cue="Ch8_Terraform_Segaris"/>
            <signal_cue cue="Ch8_Terraform_Gaian_Prophecy"/>
          </patch>
          <cues>

            <cue name="Ch8_Conv_ChiefScientist">
              <cues>
                <cue name="Ch8_Conv_CS_Main_Start" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$HeadScientistActor"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224001" comment="Greetings"/>
                    </add_npc_line>
                    <signal_cue_instantly cue="Ch8_Conversation_ChiefScientist_Choices"/>
                  </actions>
                </cue>

                <cue name="Ch8_Conv_CS_Main_End" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$HeadScientistActor" section="g_cancel"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true" chance="33">
                      <text line="30224805" comment="Again, great thanks to you for playing your part in this."/>
                    </add_npc_line>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224806" comment="Farewell, friend."/>
                    </add_npc_line>
                  </actions>
                </cue>

                <cue name="Ch8_Conversation_ChiefScientist_Choices" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30224,30224701}" comment="What did the freelancer get?"             section="cs_freelancer"/>
                    <add_player_choice text="{30224,30224703}" comment="What about the station?"                  section="cs_station"/>

                    <add_player_choice text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"     section="g_cancel"/>
                  </actions>
                </cue>

                <cue name="Ch8_Conv_CS_Freelancer" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="cs_freelancer"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224716" comment="The same data, they are getting a copy."/>
                      <text line="30224717" comment="They are interested in Xenon behaviour and believe that understanding the original Terraforming technology will help them understand the Xenon better.('They' Referring to Paranid Gender)"/>
                    </add_npc_line>
                    <signal_cue_instantly cue="Ch8_Conversation_ChiefScientist_Choices"/>
                  </actions>
                </cue>
                <cue name="Ch8_Conv_CS_Station" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="cs_station"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$HeadScientistActor" hidechoices="true">
                      <text line="30224740" comment="We leave it with the Boron."/>
                      <text line="30224741" comment="That is the least we can do after he fast-tracked all of our terraforming research into completion."/>
                      <text line="30224742" comment="I do not know what our Secret service was doing, but it seems to me now that the classification as criminal might have been an overstatement."/>
                      <text line="30224743" comment="At the very least he did seem eager to get this situation resolved without any hostility."/>
                    </add_npc_line>
                    <signal_cue_instantly cue="Ch8_Conversation_ChiefScientist_Choices"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch8_Conversation_HeadScientist_Updates">
              <cues>

                <cue name="Ch8_TF_Update_Segaris_Timeout">
                  <delay min="60min" max="80min"/>
                  <actions>
                    <signal_cue cue="Ch8_TF_Update_Segaris_LeftSector"/>
                  </actions>
                </cue>

                <cue name="Ch8_TF_Update_Segaris_LeftSector">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch8_TF_Update_Segaris_LeftSector_Ref" ref="md.LIB_Generic.LeftSector">
                      <param name="TargetSector"        value="$Segaris"/>
                      <param name="SuccessSignalCue"    value="Ch8_TF_Update_Segaris"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch8_TF_Update_Segaris" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="not $HeadScientistActor.ship">
                      <set_value name="$HeadScientistActorCutsceneKey"   exact="table[ $key = 'ShowCharacter']"/>
                    </do_if>

                    <signal_cue cue="Ch8_Terraform_Segaris"/>
                    <write_incoming_message source="$HeadScientistActor.knownname" highpriority="false"
                                            object="$Segaris" interaction="showonmap"
                                            title="{30224,10101}"
                                             text="{30224,10102}"
                                            comment="Project Genesis: Terraforming of Terranova in the Segaris System"/>
                  </actions>
                  <patch sinceversion="2">
                    <signal_cue cue="Ch8_Terraform_Segaris"/>
                  </patch>
                  <cues>
                    <cue name="Ch8_TF_Update_Segaris_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$HeadScientistActor"/>
                      <param name="CutsceneKey"       value="$HeadScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224801],[30224802],[30224803],[30224805],[30224806]]" comment="x"/>
                      <param name="MissionCue"        value="null"/>
                      <param name="IsInMission"       value="false"/>
                      <param name="EndSignalCue"      value="Ch8_TF_Update_Gaian_Prophecy_Timeout"/>
                      <!-- 
                    Signal TF Planet Updates + Lines telling the player that those are habitable now 
                    <t id="	30224801	">	Greetings, friend.	</t>
                    <t id="	30224802	">	I am proud to announce that we are making great progress in our terraforming endeavours.	</t>
                    <t id="	30224803	">	You will find that our planet Terranova in the Segaris system is now a much more livable place again.	</t>
                    <t id="	30224805	">	Again, great thanks to you for playing your part in this.	</t>
                    <t id="	30224806	">	Farewell, friend.	</t>
                -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch8_TF_Update_Gaian_Prophecy_Timeout">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay min="60min" max="80min"/>
                  <actions>
                    <signal_cue cue="Ch8_TF_Update_Gaian_Prophecy_LeftSector"/>
                  </actions>
                </cue>

                <cue name="Ch8_TF_Update_Gaian_Prophecy_LeftSector">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch8_TF_Update_Gaian_Prophecy_LeftSector_Ref" ref="md.LIB_Generic.LeftSector">
                      <param name="TargetSector"        value="$GaianProphecy"/>
                      <param name="SuccessSignalCue"    value="Ch8_TF_Update_Gaian_Prophecy"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch8_TF_Update_Gaian_Prophecy" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="not $HeadScientistActor.ship">
                      <set_value name="$HeadScientistActorCutsceneKey"   exact="table[ $key = 'ShowCharacter']"/>
                    </do_if>
                    <signal_cue cue="Ch8_Terraform_Gaian_Prophecy"/>
                    <write_incoming_message source="$HeadScientistActor.knownname" highpriority="false"
                                            object="$GaianProphecy" interaction="showonmap"
                                            title="{30224,10201}"
                                             text="{30224,10202}"
                                            comment="Project Genesis: Terraforming of Sutton in the Gaian Prophecy System"/>
                  </actions>
                  <patch sinceversion="2">
                    <signal_cue cue="Ch8_Terraform_Gaian_Prophecy"/>
                  </patch>
                  <cues>
                    <cue name="Ch8_TF_Update_Gaian_Prophecy_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$HeadScientistActor"/>
                      <param name="CutsceneKey"       value="$HeadScientistActorCutsceneKey"/>
                      <param name="Lines"             value="[[30224801],[30224802],[30224804],[30224805],[30224806]]" comment="x"/>
                      <param name="MissionCue"        value="null"/>
                      <param name="IsInMission"       value="false"/>
                      <param name="EndSignalCue"      value="Ch8_Complete"/>
                      <!-- 
                    Signal TF Planet Updates + Lines telling the player that those are habitable now 
                    <t id="	30224801	">	Greetings, friend.	</t>
                    <t id="	30224802	">	I am proud to announce that we are making great progress in our terraforming endeavours.	</t>
                    <t id="	30224804	">	You will find that our planet Sutton in the Gaian Prophecy system now harbours a much more hospitable planet.	</t>
                    <t id="	30224805	">	Again, great thanks to you for playing your part in this.	</t>
                    <t id="	30224806	">	Farewell, friend.	</t>
                -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch8_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <cancel_cue cue="parent"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Ch8_Terraforming_Effects">
          <actions>
            <find_cluster name="$Cluster_Segaris" macro="macro.cluster_113_macro"/>
            <initialise_terraforming cluster="$Cluster_Segaris" partname="'part_earthlike'"/>
            <set_terraforming_stat cluster="$Cluster_Segaris" id="'population'" value="0" />

            <set_value name="$PopulationGrowth" exact="[
                       1 * 1000,
                       50 * 1000,
                       200 * 1000,
                       400 * 1000,
                       1 * 1000 * 1000,
                       10 * 1000 * 1000,
                       25 * 1000 * 1000,
                       50 * 1000 * 1000,
                       75 * 1000 * 1000                       
                       ]"/>
            <set_value name="$PopulationGrowthDelay" exact="60min"/>
            <set_value name="$Population_Segaris_Current" exact="0"/>
            <set_value name="$Population_GaianProphecy_Current" exact="0"/>

            <find_cluster name="$Cluster_GaianProphecy" macro="macro.cluster_114_macro"/>
            <initialise_terraforming cluster="$Cluster_GaianProphecy" partname="'planet'"/>
            <set_terraforming_stat cluster="$Cluster_GaianProphecy" id="'population'" value="0" />
          </actions>
          <cues>
            <cue name="Ch8_Terraforming_Skip" onfail="cancel">
              <conditions>
                <check_value value="$ForceCompleted"/>
              </conditions>
              <actions>
                <add_research ware="ware.research_tf_tech"/>

                <!--Segaris-->
                <set_world_population cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="10021" amount="$PopulationGrowth.last"/>
                <set_world_atmosphere cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="11071" comment="Nitrogen/Oxygen"/>
                <set_world_settlements cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="16041" comment="Multiple Cities"/>

                <!--Gaian Prophecy-->
                <set_world_population cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="10021" amount="$PopulationGrowth.last * 1.2"/>
                <set_world_atmosphere cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="11071" comment="Nitrogen/Oxygen"/>
                <set_world_settlements cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="16041" comment="Multiple Cities"/>
              </actions>
            </cue>

            <cue name="Ch8_Terraform_Segaris" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$Population_Segaris_Current" exact="1" operation="add"/>
                <set_world_population cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="10021" amount="$PopulationGrowth.{$Population_Segaris_Current}"/>
                <set_world_atmosphere cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="11071" comment="Nitrogen/Oxygen"/>
                <set_world_settlements cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="16031" comment="Research Outpost"/>
              </actions>
              <patch sinceversion="2">
                <set_world_population cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="10021" amount="if $PopulationGrowth.{$Population_Segaris_Current}? then $PopulationGrowth.{$Population_Segaris_Current} else $PopulationGrowth.last"/>
                <set_world_atmosphere cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="11071" comment="Nitrogen/Oxygen"/>
                <do_if value="$Population_Segaris_Current ge 3">
                  <set_world_settlements cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="16041" comment="Multiple Cities"/>
                </do_if>
                <do_else>
                  <set_world_settlements cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="16031" comment="Research Outpost"/>
                </do_else>
              </patch>
              <cues>
                <cue name="Ch8_Terraform_Segaris_PopulationGrowth">
                  <delay exact="$PopulationGrowthDelay"/>
                  <actions>
                    <set_value name="$Population_Segaris_Current" exact="1" operation="add"/>
                    <do_if value="$PopulationGrowth.{$Population_Segaris_Current}?">
                      <set_world_population cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="10021" amount="$PopulationGrowth.{$Population_Segaris_Current}"/>
                      <do_if value="$Population_Segaris_Current ge 3">
                        <set_world_settlements cluster="$Cluster_Segaris" partname="'part_earthlike'" page="1042" line="16041" comment="Multiple Cities"/>
                      </do_if>
                      <reset_cue cue="this"/>
                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>
            <cue name="Ch8_Terraform_Gaian_Prophecy" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$Population_GaianProphecy_Current" exact="1" operation="add"/>
                <set_world_population cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="10021" amount="$PopulationGrowth.{$Population_GaianProphecy_Current}"/>
                <set_world_atmosphere cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="11071" comment="Nitrogen/Oxygen"/>
                <set_world_settlements cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="16031" comment="Research Outpost"/>
              </actions>
              <patch sinceversion="2">
                <set_world_population cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="10021" amount="(if $PopulationGrowth.{$Population_GaianProphecy_Current}? then $PopulationGrowth.{$Population_GaianProphecy_Current} else $PopulationGrowth.last) * 1.2"/>
                <set_world_atmosphere cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="11071" comment="Nitrogen/Oxygen"/>
                <do_if value="$Population_GaianProphecy_Current ge 3">
                  <set_world_settlements cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="16041" comment="Multiple Cities"/>
                </do_if>
                <do_else>
                  <set_world_settlements cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="16031" comment="Research Outpost"/>
                </do_else>
              </patch>
              <cues>
                <cue name="Ch8_Terraform_Sutton_PopulationGrowth">
                  <delay exact="$PopulationGrowthDelay"/>
                  <actions>
                    <set_value name="$Population_GaianProphecy_Current" exact="1" operation="add"/>
                    <do_if value="$PopulationGrowth.{$Population_GaianProphecy_Current}?">
                      <set_world_population cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="10021" amount="$PopulationGrowth.{$Population_GaianProphecy_Current} * 1.2"/>
                      <do_if value="$Population_GaianProphecy_Current ge 3">
                        <set_world_settlements cluster="$Cluster_GaianProphecy" partname="'planet'" page="1042" line="16041" comment="Multiple Cities"/>
                      </do_if>
                      <reset_cue cue="this"/>
                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

      </cues>
    </cue>

    <cue name="Patch_Userdata" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
      </conditions>
      <actions>
        <do_if value="ware.research_tf_tech.research.unlocked">
          <set_userdata storystate="'story_terraforming'" value="1"/>
        </do_if>
      </actions>
    </cue>
  </cues>
</mdscript>
