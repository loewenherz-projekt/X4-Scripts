<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Story_Split" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="Start" namespace="this" mapeditor="false" version="13">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
        <check_value value="player.galaxy.macro.ismacro.{macro.xu_ep2_universe_macro}" comment="only in main-galaxy"/>
      </conditions>
      <actions>
        <!--Custom gamestart flags (only reliable after 6.20 gamestarts)-->
        <set_value name="$story_split_faction_decision" exact="gamestart.storystate.story_split_faction_decision"/>
        <set_value name="$story_split_curbs_declaration" exact="gamestart.storystate.story_split_curbs_declaration"/>
        <set_value name="$story_split_curbs_no_colonial_police" exact="gamestart.storystate.story_split_curbs_no_colonial_police"/>
        <set_value name="$story_split_cabal_coup" exact="gamestart.storystate.story_split_cabal_coup"/>
        <set_value name="$story_split_cabal_complete" exact="gamestart.storystate.story_split_cabal_complete"/>
        <set_value name="$story_split_court_complete" exact="gamestart.storystate.story_split_court_complete"/>
        <set_value name="$HasCustomGamestartSkip" exact="
                   $story_split_faction_decision or
                   $story_split_curbs_declaration or
                   $story_split_curbs_no_colonial_police or
                   $story_split_cabal_coup or
                   $story_split_cabal_complete or
                   $story_split_court_complete"/>

        <!-- Story Mission Page: 30221-->
        <find_sector name="$SplitSectors" multiple="true" extension="'ego_dlc_split'"/>
        <find_sector name="$BaseSectors"  multiple="true" extension="''"/>
        <!-- Find all Split Sectors bordering Base Sectors -->
        <find_gate name="$Gates" multiple="true" space="player.galaxy"/>
        <create_list name="$GatesToSplitSpace"/>
        <do_for_each in="$Gates" name="$g">
          <do_if value="$g.exit">
            <do_if value="$BaseSectors.indexof.{$g.sector} and $SplitSectors.indexof.{$g.exit.sector}">
              <append_to_list name="$GatesToSplitSpace" exact="$g"/>
            </do_if>
          </do_if>
        </do_for_each>

        <find_sector name="$BoneYardSector" macro="macro.cluster_425_sector001_macro" required="true" comment="The boneyard"/>
        <find_sector name="$HeartOfAcrimonySector" macro="macro.Cluster_411_Sector001_macro" required="true" comment="not the Boneyard"/>
        <find_sector name="$TharkasRavine2" macro="macro.cluster_410_sector001_macro" comment="Tharka's Ravine XVI, in Front of HoA"/>

        <find_gate   name="$FuneralGate"      accelerator="true" space="$HeartOfAcrimonySector"/>
        <!--<set_object_name object="$FuneralGate" page="20103" line="1301" comment="Funeral Accelerator"/>-->
        <set_object_description object="$FuneralGate" page="20103" line="1302"/>

        <set_value name="$DebugStationSpawned"        exact="100" comment="100 to one-time spawn HQ"/>
        <set_value name="$DebugChance"                exact="0"/>
        <set_value name="$DeepDebugChance"            exact="0"     comment="for AI scripts and similar external code"/>
        <set_value name="$MissionCue"                 exact="this"/>
        <set_value name="$AttentionActivePhysics"     exact="attention.nearby"/>

        <set_value name="$Achievement_Informed_On_Slavery" exact="0"/>
        <set_value name="$Achievement_Working_With_Police" exact="0"/>

        <create_list name="$BosoSaid"     comment="List of Lines $BosoTa has said which should not be repeated"/>
        <create_list name="$DalSaid"      comment="List of Lines $DalBusta has said which should not be repeated"/>
        <create_list name="$LoyalistSaid" comment="List of Lines $LoyalistActor has said which should not be repeated"/>
        <create_list name="$CurbSaid" comment="List of Lines $CurbActor has said which should not be repeated"/>
        <create_list name="$OutcastSaid" comment="List of Lines $OutcastActor has said which should not be repeated"/>
        <create_list name="$EscapedSaid" comment="List of Lines $EscapedActor has said which should not be repeated"/>

        <set_value name="$CurbRelationBonus"    exact="2" comment="+1 per decision the Curbs like, min 1, max 3"/>
        <set_value name="$CurbRelationBonusMax" exact="3" comment="For calculations, e.g. 0/2 = no bonus, 1/2 = half bonus, 2/2 = full bonus"/>
        <!-- +1 for Ch3_Trials_Worthy Worth Agreed (paying max) + 0.01 relation -->
        <!-- -1 for not defending the ship at the end of Ch4 + 0.02 relation / +13/14? (.032=15)-->
        <set_value name="$ZyarthRelationBonus"    exact="2" comment="+1 per decision the Patriarchy likes"/>
        <set_value name="$ZyarthRelationBonusMax" exact="4" comment="For calculations, e.g. 0/2 = no bonus, 1/2 = half bonus, 2/2 = full bonus"/>
        <!-- -1 for angrying the policeman -->
        <!-- +1 for warning them at the first opportunity -->
        <!-- +1 for leaving the battle scene, latest when asked -->
        <set_value name="$MaxRelationBonus" exact="0.032" comment="best case you start at +15 with the supported faction"/>

        <set_value name="$DalCutsceneKey"       exact="table[ $key = 'ShowCharacterDal']"/>
        <set_value name="$Dal2CutsceneKey"      exact="table[ $key = 'ShowNPCFace']"/>
        <set_value name="$BosoCutsceneKey"      exact="table[ $key = 'ShowCharacterBoron']"/>
        <set_value name="$LoyalistCutsceneKey"  exact="table[ $key = 'ShowNPCFace']"/>
        <set_value name="$EscapedCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
        <set_value name="$OutcastCutsceneKey"   exact="table[ $key = 'ShowNPCFace']"/>
        <set_value name="$CurbCutsceneKey"      exact="table[ $key = 'ShowNPCFace']"/>
        <set_value name="$ShowPilotCutsceneKey" exact="table[ $key = 'ShowNPCFace']"/>

        <set_value name="$RelationBoostDocking" exact="faction.player.relation.dock.min + 0.001" comment="otherwise docking is barely not allowed"/>
        <set_value name="$RelationBoostHostile" exact="faction.player.relation.kill.max - 0.001"/>

        <set_value name="$SlaveTrader" exact="null"/>
        <!--<set_value name="$MissionGroup"   exact="missiongroup.story_split"/>-->
        <set_value name="$DalBusta"  exact="null"/>
        <set_value name="$BosoTa" exact="null"/>

        <set_value name="$SplitPaintMods" exact="table[ $splitStripes = ware.paintmod_0090,
                                                        $splitBasic = ware.paintmod_0091,
                                                        $splitCover = ware.paintmod_0092,
                                                        $familiesStripes = ware.paintmod_0089,
                                                        $familiesBasic = ware.paintmod_0093,
                                                        $familiesCover = ware.paintmod_0094,
                                                        $curbsStripes = ware.paintmod_0088,
                                                        $curbsBasic = ware.paintmod_0095,
                                                        $curbsCover = ware.paintmod_0096]"/>


        <set_value name="$PaintMod_CourtUncovered"        exact="$SplitPaintMods.$curbsStripes"/>
        <set_value name="$PaintMod_CabalUncovered"        exact="$SplitPaintMods.$curbsBasic"/>
        <set_value name="$PaintMod_SlaveTrader"           exact="$SplitPaintMods.$familiesBasic"/>
        <set_value name="$PaintMod_GetawayShip"           exact="$SplitPaintMods.$familiesCover"/>
        <set_value name="$PaintMod_PatriarchyPolice"      exact="$SplitPaintMods.$splitBasic"/>
        <set_value name="$PaintMod_FuneralServiceShip"    exact="ware.paintmod_0006" comment="Black"/>
        <set_value name="$PaintMod_FuneralCoffinShip"     exact="ware.paintmod_0006" comment="Black"/>

        <create_group groupname="$SabotageTraderGroup"/>

        <create_cue_actor name="$LoyalistActor" cue="namespace" macro="character_split_loyalist_macro">
          <page exact="10405"/>
          <owner exact="faction.civilian"/>
          <skills>
            <skill type="management"  exact="10"/>
            <skill type="morale"      exact="12"/>
            <skill type="piloting"    exact="8"/>
            <skill type="engineering" exact="3"/>
            <skill type="boarding"    exact="9"/>
          </skills>
        </create_cue_actor>
        <set_entity_traits entity="$LoyalistActor" missionactor="true" customhandler="true" subtitlename="true"/>
        <set_entity_overrides entity="$LoyalistActor" icon="'shadyguy'" title="'{30221,151}'"/>
        <set_value name="$LoyalistActorFakeNames" exact="[120, 121, 122, 123, 124]"/>
        <set_value name="$LoyalistActorCurrentName" exact="$LoyalistActorFakeNames.random"/>
        <remove_from_list name="$LoyalistActorFakeNames" exact="$LoyalistActorCurrentName"/>
        <set_object_name object="$LoyalistActor" page="30221" line="$LoyalistActorCurrentName"/>
        <set_value name="$LoyalistActor.$MissionCue" exact="$MissionCue"/>

        <create_cue_actor name="$OutcastActor" cue="namespace" macro="character_split_outcast_macro">
          <page exact="10406"/>
          <owner exact="faction.civilian"/>
          <skills>
            <skill type="management"  exact="6"/>
            <skill type="morale"      exact="12"/>
            <skill type="piloting"    exact="11"/>
            <skill type="engineering" exact="4"/>
            <skill type="boarding"    exact="8"/>
          </skills>
        </create_cue_actor>
        <set_entity_traits entity="$OutcastActor" missionactor="true" customhandler="true" subtitlename="true"/>
        <set_entity_overrides entity="$OutcastActor" icon="'defenceofficer'" title="'{30221,152}'"/>
        <set_value name="$OutcastActor.$MissionCue" exact="$MissionCue"/>

        <create_cue_actor name="$CurbActor" cue="namespace" macro="character_split_curb_macro">
          <page exact="10451"/>
          <owner exact="faction.civilian"/>
          <skills>
            <skill type="management"  exact="15"/>
            <skill type="morale"      exact="15"/>
            <skill type="piloting"    exact="5"/>
            <skill type="engineering" exact="1"/>
            <skill type="boarding"    exact="6"/>
          </skills>
        </create_cue_actor>
        <set_entity_traits entity="$CurbActor" missionactor="true" customhandler="true" subtitlename="true"/>
        <set_entity_overrides entity="$CurbActor" icon="'factionrepresentative'" title="'{30221,153}'"/>
        <set_value name="$CurbActor.$MissionCue" exact="$MissionCue"/>

        <create_cue_actor name="$EscapedActor" cue="namespace" macro="character_split_escaped_macro">
          <page exact="10102"/>
          <owner exact="faction.civilian"/>
          <skills>
            <skill type="management"  exact="8"/>
            <skill type="morale"      exact="9"/>
            <skill type="piloting"    exact="7"/>
            <skill type="engineering" exact="2"/>
            <skill type="boarding"    exact="11"/>
          </skills>
        </create_cue_actor>
        <set_entity_traits entity="$EscapedActor" missionactor="true" customhandler="true" subtitlename="true"/>
        <set_entity_overrides entity="$EscapedActor" icon="'shadyguy'" title="'{30221,154}'"/>
        <set_value name="$EscapedActor.$MissionCue" exact="$MissionCue"/>

        <set_value name="$AddStoryMentors"/>
        <!-- Player Affiliation -->
        <set_value name="$SplitGamestart"               exact="false"/>
        <set_value name="$AffiliationFF"                exact="false" comment="FF Gamestart"/>
        <set_value name="$AffiliationPatriarchy"        exact="false" comment="Patriarchy Gamestart"/>

        <do_if value="player.module == 'x4ep1_gamestart_split1'">
          <set_value name="$SplitGamestart" exact="true"/>
          <set_value name="$AffiliationFF" exact="true"/>
        </do_if>
        <do_elseif value="player.module == 'x4ep1_gamestart_split2'">
          <set_value name="$SplitGamestart" exact="true"/>
          <set_value name="$AffiliationPatriarchy" exact="true"/>
        </do_elseif>
      </actions>
      <patches>
        <patch sinceversion="3">
          <!-- Can only happen in internal savegames, temporary measure to avoid having to create many new savegames-->
          <set_value name="$DalCutsceneKey"       exact="table[ $key = 'ShowCharacterDal']"/>
          <set_value name="$Dal2CutsceneKey"      exact="table[ $key = 'ShowCharacterBoron']"/>
          <set_value name="$BosoCutsceneKey"      exact="table[ $key = 'ShowCharacterBoron']"/>
          <set_value name="$LoyalistCutsceneKey"  exact="table[ $key = 'ShowPilot']"/>
          <set_value name="$EscapedCutsceneKey"   exact="table[ $key = 'ShowPilot']"/>
          <set_value name="$OutcastCutsceneKey"   exact="table[ $key = 'ShowCharacter']"/>
          <set_value name="$CurbCutsceneKey"      exact="table[ $key = 'ShowCharacter']"/>
          <set_value name="$ShowPilotCutsceneKey" exact="table[ $key = 'ShowPilot']"/>
        </patch>
        <patch sinceversion="4">
          <set_value name="$Achievement_Informed_On_Slavery" exact="0"/>
          <set_value name="$Achievement_Working_With_Police" exact="0"/>
        </patch>
        <patch sinceversion="5">
          <!--If the prisoners have the service role, then they should have been removed as cue actors-->
          <do_if value="@$Prisoner1Actor.isclass.npc and $Prisoner1Actor.role == entityrole.service">
            <debug_text text="'Removing Split prisoner ' + $Prisoner1Actor + ' ' + $Prisoner1Actor.knownname + ' as a cue actor'" filter="savegame"/>
            <remove_cue_actor cue="namespace" actor="$Prisoner1Actor"/>
          </do_if>
          <do_if value="@$Prisoner2Actor.isclass.npc and $Prisoner2Actor.role == entityrole.service">
            <debug_text text="'Removing Split prisoner ' + $Prisoner2Actor + ' ' + $Prisoner2Actor.knownname + ' as a cue actor'" filter="savegame"/>
            <remove_cue_actor cue="namespace" actor="$Prisoner2Actor"/>
          </do_if>
        </patch>
        <patch sinceversion="6">
          <set_value name="$Patch_OutdatedObjects" exact="[]"/>
          <do_for_each name="$Patch_Object" valuename="$Patch_ObjectParameters" in="md.LIB_Generic.ObjectInvincibilityManager.$ObjectTable">
            <do_if value="$Patch_ObjectParameters.$requestercues.indexof.{this}">
              <do_if value="$Patch_Object != @$HOJStation and $Patch_Object != @$Sink_Container and $Patch_Object != @$PickupContainer">
                <append_to_list name="$Patch_OutdatedObjects" exact="$Patch_Object"/>
              </do_if>
            </do_if>
          </do_for_each>
          <do_for_each name="$Patch_Object" in="$Patch_OutdatedObjects">
            <debug_text text="'Removing outdated invincibility request for ' + $Patch_Object + ' ' + $Patch_Object.knownname" filter="savegame"/>
            <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
              <param name="Object" value="$Patch_Object"/>
              <param name="RequesterCue" value="this"/>
              <param name="DebugChance" value="$DebugChance"/>
            </run_actions>
          </do_for_each>
          <remove_value name="$Patch_OutdatedObjects"/>
        </patch>
        <patch sinceversion="7">
          <set_value name="$HasCustomGamestartSkip" exact="false"/>
        </patch>
        <patch sinceversion="8">
          <set_value name="$AddStoryMentors"/>
        </patch>
        <patch sinceversion="9">
          <do_if value="@$HOJStation.exists">
            <set_object_encyclopedia_visibility object="$HOJStation" visible="true"/>
          </do_if>
        </patch>
        <patch sinceversion="10">
          <set_value name="$story_split_faction_decision" exact="false"/>
          <set_value name="$story_split_curbs_declaration" exact="false"/>
          <set_value name="$story_split_curbs_no_colonial_police" exact="false"/>
          <set_value name="$story_split_cabal_coup" exact="false"/>
          <set_value name="$story_split_cabal_complete" exact="false"/>
          <set_value name="$story_split_court_complete" exact="false"/>
        </patch>
        <patch sinceversion="11">
          <create_group groupname="$SabotageTraderGroup"/>
        </patch>
        <patch sinceversion="12">
          <do_if value="$MissionCue.hasmission">
            <do_if value="not $PlayerChose?">
              <update_mission cue="$MissionCue" group="missiongroup.story_split"/>
              <set_value name="$PatchedMissionGroup" exact="missiongroup.story_split"/>
            </do_if>
            <do_elseif value="$PlayerChose == 'Patriarchy'">
              <update_mission cue="$MissionCue" group="missiongroup.story_split_zyarth"/>
              <set_value name="$PatchedMissionGroup" exact="missiongroup.story_split_zyarth"/>
            </do_elseif>
            <do_else>
              <update_mission cue="$MissionCue" group="missiongroup.story_split_court"/>
              <set_value name="$PatchedMissionGroup" exact="missiongroup.story_split_court"/>
            </do_else>
          </do_if>
        </patch>
        <patch sinceversion="13">
          <set_value name="$LoyalistActor.$MissionCue"  exact="$MissionCue"/>
          <set_value name="$OutcastActor.$MissionCue"   exact="$MissionCue"/>
          <set_value name="$CurbActor.$MissionCue"      exact="$MissionCue"/>
          <set_value name="$EscapedActor.$MissionCue"   exact="$MissionCue"/>
        </patch>
      </patches>
      <cues>
        <cue name="PATCH_AddStoryMentors" onfail="cancel">
          <conditions>
            <check_value value="$AddStoryMentors?"/>
          </conditions>
          <delay exact="1s"/>
          <actions>
            <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$LoyalistActor]"/>
            <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$OutcastActor]"/>
            <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$CurbActor]"/>
            <signal_cue_instantly cue="md.Setup.AddStoryMentor" param="table[$story=namespace, $actor=$EscapedActor]"/>
          </actions>
        </cue>

        <cue name="Accelerator_BoneYard_Patch" onfail="cancel" version="2">
          <!-- Multiple players report that they used autopilot to fly to the Funeral Gate and it got them through the inactive (!) gate.
               This leads to their property being trapped in the disconnected sector and can be a blocker if they don't have global research unlocked.
               We don't have a repro for this bug, so the workaround is to warp player property back into the other HoA sector until the gate is permanently opened.
          -->
          <conditions>
            <check_value value="not $HasCustomGamestartSkip"/>
            <check_any>
              <check_value value="not ($Ch3_Trials_Policehunt? and $Ch3_Trials_Policehunt)" comment="gate permanently unlocked"/>
              <check_value value="Ch3_Funeral_BreakIn_Done.state != cuestate.complete" comment="player about to traverse as intended by plot"/>
            </check_any>
          </conditions>
          <patch sinceversion="2">
            <do_if value="@$HasCustomGamestartSkip">
              <debug_text text="'Cancelling cue due to a custom gamestart skip being active'" filter="savegame"/>
              <cancel_cue cue="this"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Warp_Back" instantiate="true">
              <conditions>
                <event_object_changed_sector object="player.entity" sector="$BoneYardSector"/>
                <check_value value="not ($Ch3_Trials_Policehunt? and $Ch3_Trials_Policehunt)" comment="gate permanently unlocked"/>
                <check_value value="Ch3_Funeral_BreakIn_Done.state != cuestate.complete" comment="player is about to traverse as intended by plot"/>
              </conditions>
              <actions>
                <warp object="player.ship" sector="$HeartOfAcrimonySector" zone="$BoneYardAccelerator_InTo.zone"/>
              </actions>
            </cue>

            <!-- Rescue everything which is already trapped there -->
            <cue name="Warp_Back_Ships_Patch">
              <actions>
                <find_ship_by_true_owner faction="faction.player" space="$BoneYardSector" multiple="true" name="$PlayerShipsInBoneYard"/>

                <!-- Warp players back on their ship -->
                <do_if value="(player.sector == $BoneYardSector) and (player.ship.owner != faction.player)">
                  <do_if value="$PlayerShipsInBoneYard.count">
                    <teleport_player object="$PlayerShipsInBoneYard.{1}" instant="true" force="true" control="false"/>
                  </do_if>
                  <do_else>
                    <find_dockingbay name="$docks" object="$HQ" checkoperational="true" multiple="true"/>
                    <do_if value="$docks.count">
                      <teleport_player object="$HQ" instant="true" force="true" control="false"/>
                    </do_if>
                    <do_else>
                      <!--
                        Player got into the sector through the rare bug, docked at the Ravenous Wight, undocked their ship and lost it to a Xenon encounter.
                        Very unlikely.
                      -->
                      <find_station name="$PossiblePickupContainers" space="player.galaxy" multiple="true" sortbygatedistanceto="player.entity">
                        <match_dock walkable="true"/>
                        <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                      </find_station>
                      <teleport_player object="$PossiblePickupContainers" instant="true" force="true" control="false"/>
                    </do_else>
                  </do_else>
                </do_if>

                <do_for_each in="$PlayerShipsInBoneYard" name="$ship">
                  <warp object="$ship" sector="$HeartOfAcrimonySector" zone="$BoneYardAccelerator_InTo.zone"/>
                </do_for_each>
              </actions>
            </cue>

          </cues>
        </cue>
        <cue name="Accelerators_Setup">
          <actions>
            <!-- Find Accelerator into the boneyard / accelerator out of the boneyard -->
            <find_gate name="$BoneYardAccelerator_OutOf" space="$BoneYardSector" accelerator="true" required="true"/>
            <find_gate name="$BoneYardAccelerator_InTo" space="$BoneYardAccelerator_OutOf.exit.sector" accelerator="true" required="true"/>
            <assert value="$BoneYardAccelerator_OutOf.sector == $BoneYardAccelerator_InTo.exit.sector" comment="should never trigger (universe is predefined)"/>
            <signal_cue cue="BoneYardCarrier_Setup"/>
          </actions>
        </cue>
        <cue name="Police_Rattlesnake">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$PoliceSector" exact="event.param.{1}"/>
            <create_loadout result="$loadout_Missile_Rattlesnake">
              <macros>
                <engine macro="engine_spl_l_travel_01_mk1_macro" path="../con_engine_03"/>
                <engine macro="engine_spl_l_travel_01_mk1_macro" path="../con_engine_02"/>
                <engine macro="engine_spl_l_travel_01_mk1_macro" path="../con_engine_01"/>
                <weapon macro="weapon_spl_l_destroyer_01_mk1_macro" path="../con_weapon_04"/>
                <weapon macro="weapon_spl_l_destroyer_01_mk1_macro" path="../con_weapon_03"/>
                <weapon macro="weapon_spl_l_destroyer_01_mk1_macro" path="../con_weapon_02"/>
                <weapon macro="weapon_spl_l_destroyer_01_mk1_macro" path="../con_weapon_01"/>
                <shield macro="shield_spl_l_standard_01_mk2_macro" path="../con_shieldgenerator_l_01"/>
              </macros>
              <groups>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_back_up_mid"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_front_up_mid"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_front_down_mid"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_up_mid" exact="4"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_down_back_mid"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_back_up_mid_02"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_up_back_mid_2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_down_mid" exact="4"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_down_back_mid_2"/>
                <turrets macro="turret_spl_m_guided_02_mk1_macro" path=".." group="group_front_up_mid" exact="4"/>
                <turrets macro="turret_spl_m_guided_02_mk1_macro" path=".." group="group_front_down_mid" exact="4"/>
                <turrets macro="turret_spl_l_plasma_01_mk1_macro" path=".." group="group_mid_up_mid" exact="2"/>
                <turrets macro="turret_spl_l_plasma_01_mk1_macro" path=".." group="group_down_back_mid"/>
                <turrets macro="turret_spl_m_guided_02_mk1_macro" path=".." group="group_up_back_mid" exact="2"/>
                <turrets macro="turret_spl_l_plasma_01_mk1_macro" path=".." group="group_up_back_mid_2"/>
                <turrets macro="turret_spl_l_plasma_01_mk1_macro" path=".." group="group_mid_down_mid" exact="2"/>
                <turrets macro="turret_spl_m_guided_02_mk1_macro" path=".." group="group_down_back_mid_2" exact="2"/>
              </groups>
              <ammunition>
                <ammunition macro="missile_interceptor_light_mk1_macro" exact="100"/>
                <ammunition macro="missile_starburst_heavy_mk1_macro" exact="100"/>
                <ammunition macro="missile_disruptor_light_mk1_macro" exact="80"/>
                <ammunition macro="ship_gen_s_lasertower_01_a_macro" exact="250"/>
                <ammunition macro="countermeasure_flares_01_macro" exact="20"/>
                <unit macro="ship_gen_xs_repairdrone_01_a_macro" exact="10"/>
              </ammunition>
              <software>
                <software ware="software_dockmk2"/>
                <software ware="software_flightassistmk1"/>
                <software ware="software_scannerlongrangemk2"/>
                <software ware="software_scannerobjectmk2"/>
                <software ware="software_targetmk1"/>
                <software ware="software_trademk1"/>
              </software>
              <virtualmacros>
                <thruster macro="thruster_gen_l_allround_01_mk3_macro"/>
              </virtualmacros>
            </create_loadout>

            <do_if value="$PoliceSector == $BoneYardSector">
              <create_position name="$PoliceShipPos" object="$BoneYardAccelerator_OutOf" space="$BoneYardSector" x="0km" y="0km" z="2km"/>
              <create_rotation name="$PoliceshipRot"
               pitch="$BoneYardAccelerator_OutOf.rotation.pitch"
               roll="$BoneYardAccelerator_OutOf.rotation.roll"
               yaw="$BoneYardAccelerator_OutOf.rotation.yaw"/>
            </do_if>
            <do_else>
              <create_position name="$PoliceShipPos" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="5km" z="20km"/>
              <create_rotation name="$PoliceshipRot"
               pitch="$BoneYardAccelerator_OutOf.rotation.pitch"
               roll="$BoneYardAccelerator_OutOf.rotation.roll"
               yaw="$BoneYardAccelerator_OutOf.rotation.yaw"/>
            </do_else>


            <create_ship name="$PoliceRattleSnake" capturable="false" missioncue="namespace" macro="ship_spl_l_destroyer_01_a_macro" sector="$PoliceSector" commandeerable="false">
              <owner exact="faction.split"/>
              <!--<paint ware="$SplitPaintMods.$familiesStripes"/>-->
              <paint ware="$SplitPaintMods.$familiesBasic"/>
              <loadout loadout="$loadout_Missile_Rattlesnake"/>
              <pilot>
                <select faction="faction.split" tags="tag.fighterpilot"/>
              </pilot>
              <people ref="split_elite_military_crew">
                <fillpercent exact="100"/>
              </people>
              <position x="$PoliceShipPos.x" y="$PoliceShipPos.y" z="$PoliceShipPos.z"/>
              <rotation value="$PoliceshipRot"/>
            </create_ship>

            <signal_objects object="player.galaxy" param="'Cover'" param2="[$PoliceRattleSnake, faction.freesplit]"/>

            <do_if value="$PoliceSector == $BoneYardSector">
              <set_value name="$MainAttack"/>
              <set_object_relation_behaviour object="$PoliceRattleSnake" disable="false"/>
              <set_object_min_hull object="$PoliceRattleSnake" exact="0"/>
              <set_object_docking_enabled object="$PoliceRattleSnake" enabled="true"/>
            </do_if>
            <do_else>
              <set_object_relation_behaviour object="$PoliceRattleSnake" disable="true"/>
              <set_object_min_hull object="$PoliceRattleSnake" exact="50"/>
              <set_object_docking_enabled object="$PoliceRattleSnake" enabled="false"/>
            </do_else>

          </actions>
          <cues>
            <cue name="Police_Rattlesnake_Destroyed">
              <conditions>
                <event_object_destroyed object="$PoliceRattleSnake"/>
              </conditions>
              <actions>
                <cancel_cue cue="Police_Rattlesnake_Uncovered"/>
              </actions>
            </cue>
            <cue name="Police_Rattlesnake_Uncovered">
              <conditions>
                <event_object_changed_owner object="$PoliceRattleSnake"/>
                <check_value value="event.param == $PoliceRattleSnake.trueowner"/>
                <check_value value="not $MainAttack?"/>
              </conditions>
              <actions>
                <signal_objects object="player.galaxy" param="'Cover'" param2="[$PoliceRattleSnake, faction.freesplit]"/>
                <!--<find_ship job="'zyarth_dronecarrier_patrol_m_sector_colonial'" multiple="true"
                           name="this.$ColonialPoliceLocal" space="$PoliceRattleSnake.sector"/>
                <do_for_each in="this.$ColonialPoliceLocal" name="$p">
                  <create_order id="'Flee'" object="$p" immediate="true">
                    <param name="method" value="'boost'"/>
                    <param name="attacker" value="$PoliceRattleSnake"/>
                    <param name="donotdrop" value="true"/>
                    <param name="deploydistraction" value="false"/>
                    <param name="log" value="false"/>
                  </create_order>
                </do_for_each>-->
                <reset_cue cue="this"/>
              </actions>
            </cue>
          </cues>
        </cue>
        <cue name="BoneYardCarrier_Setup">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Creating Boneyard Carrier'" chance="$DebugChance"/>
            <!-- Create 'Raptor' Unique Carrier (contains the 'court of curbs'-throneroom) -->

            <set_value name="$DistanceToGate" exact="macro.ship_spl_l_destroyer_01_a_macro.maxradarrange" comment="Needs to be far from the gate for proper attack behaviour once the Rattlesnake attacks"/>

            <create_position name="$BoneyardCarrierPosition" object="$BoneYardAccelerator_OutOf" space="$BoneYardSector" x="0km" y="0km" z="$DistanceToGate"/>
            <create_rotation name="$FaceBoneYardAccelerator_OutOf"
             pitch="$BoneYardAccelerator_OutOf.rotation.pitch"
             roll="$BoneYardAccelerator_OutOf.rotation.roll"
             yaw="$BoneYardAccelerator_OutOf.rotation.yaw + 180deg"/>


            <create_loadout result="$Court_Raptor">
              <macros>
                <engine macro="engine_spl_xl_allround_01_mk1_macro" path="../con_engine_01"/>
                <shield macro="shield_spl_xl_standard_01_mk1_macro" path="../con_shieldgen_xl_01"/>
              </macros>
              <groups>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_back_mid_mid"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_front_mid_front" exact="4"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_front_mid_top_01" exact="4"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_front_mid_bottom_02" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_mid_bottom_01" exact="4"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_mid_top_03" exact="4"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_left_bottom_01" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_right_bottom_01" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_back_mid_bottom" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_mid_top_01" exact="4"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_back_mid_mid_2" exact="4"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_mid_top_02" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_left_top_l" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_left_bottom_l" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_right_bottom_l" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_right_top_l" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_left_mid"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_right_mid"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_back_mid_mid_3" exact="2"/>
                <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_interior_hangar_01" exact="2"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_front_mid_front" exact="10"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_front_mid_top_01" exact="9"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_front_mid_bottom_02" exact="5"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_mid_mid_bottom_01" exact="10"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_mid_mid_top_03" exact="10"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_mid_left_bottom_01" exact="5"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_mid_right_bottom_01" exact="5"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_back_mid_bottom" exact="5"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_mid_mid_top_01" exact="10"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_back_mid_mid_2" exact="10"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_mid_mid_top_02" exact="4"/>
                <turrets macro="turret_spl_l_beam_01_mk1_macro" path=".." group="group_mid_left_top_l" exact="2"/>
                <turrets macro="turret_spl_l_beam_01_mk1_macro" path=".." group="group_mid_left_bottom_l" exact="2"/>
                <turrets macro="turret_spl_l_beam_01_mk1_macro" path=".." group="group_mid_right_bottom_l" exact="2"/>
                <turrets macro="turret_spl_l_beam_01_mk1_macro" path=".." group="group_mid_right_top_l" exact="2"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_mid_left_mid" exact="2"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_mid_right_mid" exact="2"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_back_mid_mid_3" exact="2"/>
                <turrets macro="turret_spl_m_flak_02_mk1_macro" path=".." group="group_interior_hangar_01" exact="4"/>
              </groups>
              <ammunition>
                <ammunition macro="countermeasure_flares_01_macro" exact="40"/>
                <unit macro="ship_gen_xs_repairdrone_01_a_macro" exact="18"/>
                <unit macro="ship_gen_xs_cargodrone_empty_01_a_macro" exact="2"/>
              </ammunition>
              <software>
                <software ware="software_dockmk2"/>
                <software ware="software_flightassistmk1"/>
                <software ware="software_scannerlongrangemk2"/>
                <software ware="software_scannerobjectmk2"/>
                <software ware="software_targetmk1"/>
              </software>
              <virtualmacros>
                <thruster macro="thruster_gen_xl_allround_01_mk3_macro"/>
              </virtualmacros>
            </create_loadout>


            <!--<find_zone name="$BoneYardZone" macro="macro.zone005_cluster_425_sector001_macro" required="true"/>
            zone="$BoneYardZone"-->
            <create_ship name="$BoneyardCarrier" sector="$BoneYardSector" missioncue="namespace" macro="ship_spl_xl_carrier_01_a_macro" commandeerable="false" capturable="false">
              <owner exact="faction.freesplit" overridenpc="true"/>
              <!--loadout ref="story_split_boneyardcarrier"/-->
              <people>
                <fillpercent exact="100"/>
                <person role="service" weight="25">
                  <select race="race.split" tags="tag.service" />
                </person>
                <person role="marine" weight="75">
                  <select race="race.split" tags="tag.marine"/>
                </person>
              </people>
              <paint ware="$SplitPaintMods.$curbsBasic"/>
              <loadout loadout="$Court_Raptor"/>
              <pilot>
                <select faction="faction.freesplit" tags="tag.fighterpilot"/>
              </pilot>
              <position x="$BoneyardCarrierPosition.x" y="$BoneyardCarrierPosition.y" z="$BoneyardCarrierPosition.z"/>
              <rotation value="$FaceBoneYardAccelerator_OutOf"/>
            </create_ship>
            <set_object_name object="$BoneyardCarrier" page="30221" line="217"/>
            <remove_value name="$Court_Raptor"/>
            <set_object_relation_behaviour object="$BoneyardCarrier" disable="true"/>
            <set_object_min_hull object="$BoneyardCarrier" exact="50"/>
            <cancel_all_orders object="$BoneyardCarrier"/>
            <set_ship_safepos_allowed ship="$BoneyardCarrier" allow="false"/>
            <create_order id="'Wait'" object="$BoneyardCarrier" default="true" comment="stay put">
              <param name="noattackresponse" value="true"/>
            </create_order>
            <create_order id="'Wait'" object="$BoneyardCarrier" immediate="true" comment="stay put">
              <param name="noattackresponse" value="true"/>
            </create_order>

            <!-- create Split Throne room (persistent) -->
            <set_value name="$ThroneRoom_Macro" exact="macro.room_spl_throneroom_01_macro"/>
            <get_room_definition doors="$ThroneRoom_InteriorDoors" macro="$ThroneRoom_CorridorMacro" race="race.split" tags="tag.corridor" />
            <set_value name="$ThroneRoom_Door" exact="if $ThroneRoom_InteriorDoors.count ge 3 then $ThroneRoom_InteriorDoors.{3} else $ThroneRoom_InteriorDoors.{1}"/>
            <create_dynamic_interior interiorname="$ThroneRoom_Interior" corridorname="$ThroneRoom_Corridor" roomname="$ThroneRoom_Room" object="$BoneyardCarrier" room="$ThroneRoom_Macro" corridor="$ThroneRoom_CorridorMacro" door="$ThroneRoom_Door" name="'{20007,3001}'" persistent="true"/>
            <set_dynamic_interior_private object="$BoneyardCarrier" interior="$ThroneRoom_Interior" private="true"/>
            <!-- npc slots in the throneroom -->
            <!--find_npc_slot name="$ThroneRoom_NpcSlots" object="$ThroneRoom_Room" tags="[tag.npc]" multiple="true" />
            <find_npc_slot name="$ThroneRoom_SeatSlots" object="$ThroneRoom_Room" tags="[tag.npc, tag.sit]" multiple="true" /-->
          </actions>
          <cues>
            <cue name="BoneyardCarrier_Subordinates">
              <actions>
                <create_loadout result="$Curbs_S_Light_Asp_Raider" comment="ship_spl_s_fighter_02_b_macro">
                  <macros>
                    <engine macro="engine_spl_s_combat_01_mk3_macro" path="../con_engine_03"/>
                    <engine macro="engine_spl_s_combat_01_mk3_macro" path="../con_engine_02"/>
                    <weapon macro="weapon_spl_s_gatling_01_mk2_macro" path="../con_weapon_04"/>
                    <weapon macro="weapon_spl_s_gatling_01_mk2_macro" path="../con_weapon_03"/>
                    <weapon macro="weapon_spl_s_gatling_01_mk2_macro" path="../con_weapon_02"/>
                    <shield macro="shield_spl_s_standard_01_mk2_macro" path="../con_shield_01"/>
                  </macros>
                  <ammunition>
                    <ammunition macro="ship_gen_xs_lasertower_01_a_macro" exact="50"/>
                    <ammunition macro="countermeasure_flares_01_macro" exact="4"/>
                  </ammunition>
                  <software>
                    <software ware="software_dockmk1"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk2"/>
                    <software ware="software_scannerobjectmk2"/>
                    <software ware="software_targetmk1"/>
                    <software ware="software_trademk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_s_allround_01_mk3_macro"/>
                  </virtualmacros>
                </create_loadout>

                <create_loadout result="$Curbs_S_Heavy_Balaur" comment="ship_spl_s_heavyfighter_02_a_macro">
                  <macros>
                    <engine macro="engine_spl_s_combat_01_mk3_macro" path="../con_engine_003"/>
                    <engine macro="engine_spl_s_combat_01_mk3_macro" path="../con_engine_02"/>
                    <engine macro="engine_spl_s_combat_01_mk3_macro" path="../con_engine_01"/>
                    <weapon macro="weapon_spl_s_gatling_01_mk2_macro" path="../con_weapon_02"/>
                    <weapon macro="weapon_spl_s_gatling_01_mk2_macro" path="../con_weapon_04"/>
                    <weapon macro="weapon_spl_s_gatling_01_mk2_macro" path="../con_weapon_03"/>
                    <weapon macro="weapon_spl_s_gatling_01_mk2_macro" path="../con_weapon_01"/>
                    <shield macro="shield_spl_s_standard_01_mk2_macro" path="../con_shield_01"/>
                  </macros>
                  <ammunition>
                    <ammunition macro="ship_gen_xs_lasertower_01_a_macro" exact="50"/>
                    <ammunition macro="countermeasure_flares_01_macro" exact="4"/>
                  </ammunition>
                  <software>
                    <software ware="software_dockmk1"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk2"/>
                    <software ware="software_scannerobjectmk2"/>
                    <software ware="software_targetmk1"/>
                    <software ware="software_trademk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_s_combat_01_mk3_macro"/>
                  </virtualmacros>
                </create_loadout>

                <create_loadout result="$Curbs_M_Corvette_Dragon_Raider" comment="ship_spl_m_corvette_01_b_macro">
                  <macros>
                    <engine macro="engine_spl_m_combat_01_mk3_macro" path="../con_engine_01"/>
                    <weapon macro="weapon_spl_m_gatling_01_mk2_macro" path="../con_weapon_01"/>
                    <weapon macro="weapon_spl_m_gatling_01_mk2_macro" path="../con_weapon_02"/>
                    <weapon macro="weapon_spl_m_gatling_01_mk2_macro" path="../con_weapon_03"/>
                    <weapon macro="weapon_spl_m_gatling_01_mk2_macro" path="../con_weapon_04"/>
                    <weapon macro="weapon_spl_m_gatling_01_mk2_macro" path="../con_weapon_05"/>
                    <weapon macro="weapon_spl_m_gatling_01_mk2_macro" path="../con_weapon_06"/>
                    <shield macro="shield_spl_m_standard_01_mk1_macro" path="../con_shield_01"/>
                    <turret macro="turret_spl_m_flak_01_mk1_macro" path="../con_turret_l"/>
                    <turret macro="turret_spl_m_flak_01_mk1_macro" path="../con_turret_r"/>
                  </macros>
                  <ammunition>
                    <ammunition macro="missile_torpedo_heavy_mk1_macro" exact="8"/>
                    <ammunition macro="ship_gen_xs_lasertower_01_a_macro" exact="100"/>
                    <ammunition macro="countermeasure_flares_01_macro" exact="8"/>
                  </ammunition>
                  <software>
                    <software ware="software_dockmk1"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk2"/>
                    <software ware="software_scannerobjectmk2"/>
                    <software ware="software_targetmk1"/>
                    <software ware="software_trademk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_m_combat_01_mk3_macro"/>
                  </virtualmacros>
                </create_loadout>

                <set_value name="$Raptor_M_Capacity" exact="30" comment="hardcoded, currently correct TODO Softcode"/>
                <set_value name="$Raptor_S_Capacity" exact="100" comment="hardcoded, currently correct TODO Softcode"/>

                <!-- Create Defensive Fleet -->

                <set_value name="$Asps_Per_Balaur" exact="2"/>
                <set_value name="$Balaur_Subordination_Table" exact="table[]"/>
                <!-- BALAUR Heavy Fighters -->
                <do_all exact="10">
                  <set_value name="$Current_Paint" exact="[$SplitPaintMods.$curbsStripes, $SplitPaintMods.$curbsBasic].random"/>

                  <create_ship name="$Balaur_Defender" groupname="$Balaur_Defenders" sector="$BoneyardCarrier.sector"
                               macro="ship_spl_s_heavyfighter_02_a_macro" commandeerable="false" missioncue="namespace">
                    <owner exact="faction.freesplit"/>
                    <paint ware="$Current_Paint"/>
                    <pilot>
                      <select faction="faction.freesplit" tags="tag.fighterpilot"/>
                    </pilot>
                    <loadout loadout="$Curbs_S_Heavy_Balaur"/>
                  </create_ship>

                  <!-- ASP Light Fighters -->
                  <do_all exact="$Asps_Per_Balaur">
                    <create_ship name="$Asp_Defender" groupname="$Balaur_Subordination_Table.{$Balaur_Defender}" sector="$BoneyardCarrier.sector"
                                 macro="ship_spl_s_fighter_02_b_macro" commandeerable="false" missioncue="namespace">
                      <owner exact="faction.freesplit"/>
                      <paint ware="$Current_Paint"/>
                      <pilot>
                        <select faction="faction.freesplit" tags="tag.fighterpilot"/>
                      </pilot>
                      <loadout loadout="$Curbs_S_Light_Asp_Raider"/>
                    </create_ship>
                  </do_all>

                </do_all>

                <!-- Dragon Defenders -->
                <do_all exact="3" counter="$c">
                  <create_ship name="$Dragon_Defender" groupname="$Dragon_Defenders" sector="$BoneyardCarrier.sector"
                               macro="ship_spl_m_corvette_01_b_macro" commandeerable="false" missioncue="namespace">
                    <owner exact="faction.freesplit"/>
                    <paint ware="[$SplitPaintMods.$curbsStripes, $SplitPaintMods.$curbsBasic, $SplitPaintMods.$curbsCover].{$c}"/>
                    <pilot>
                      <select faction="faction.freesplit" tags="tag.fighterpilot"/>
                    </pilot>
                    <loadout loadout="$Curbs_M_Corvette_Dragon_Raider"/>
                  </create_ship>
                  <create_order id="'AssignCommander'" object="$Dragon_Defender">
                    <param name="commander" value="$BoneyardCarrier"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>
                </do_all>

              </actions>
              <delay exact="1s"/>
              <actions>
                <do_for_each in="$Balaur_Defenders" name="$B">
                  <create_order id="'AssignCommander'" object="$B">
                    <param name="commander" value="$BoneyardCarrier"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>

                  <do_for_each in="$Balaur_Subordination_Table.{$B}" name="$Asp">
                    <create_order id="'AssignCommander'" object="$Asp">
                      <param name="commander" value="$B"/>
                      <param name="assignment" value="assignment.attack"/>
                      <param name="cancelorders" value="true"/>
                    </create_order>
                  </do_for_each>
                </do_for_each>

              </actions>
            </cue>
          </cues>
        </cue>
        <cue name="HallsOfJudgement_Setup" version="2" onfail="cancel">
          <conditions>
            <!--Note: All custom gamestart skips for the Split story take place past the Chapter 4 Prison Escape. For simplicity, we do not create this station-->
            <check_value value="not $HasCustomGamestartSkip"/>
          </conditions>
          <actions>
            <!-- Create Hall of Judgement (unique station) -->
            <debug_text text="'Creating Hall of Judgement'" chance="$DebugChance"/>
            <find_sector name="$HOJSector" macro="macro.cluster_409_sector001_macro" comment="Hall of Judgement"/>
            <create_station name="$HOJStation" macro="macro.station_gen_factory_base_01_macro" owner="faction.split" sector="$HOJSector" state="componentstate.operational" constructionplan="'split_hall_of_judgement'" encyclopedia="true">
              <safepos x="34393.406" y="-3867" z="-2586"/>
            </create_station>
            <signal_objects object="player.galaxy" param="'init station'" param2="$HOJStation" param3="false"/>
            <add_default_production_wares object="$HOJStation" lowerlimit="10" upperlimit="10"/>
            <set_object_name object="$HOJStation" page="20103" line="2001" comment="Hall of Judgement"/>

            <!--Set to invincible-->
            <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
              <param name="Object" value="$HOJStation"/>
              <param name="RequesterCue" value="HallsOfJudgement_Setup"/>
              <param name="DebugChance" value="$DebugChance"/>
            </run_actions>

            <!-- create Hall of Judgement Prison room (persistent) -->
            <set_value name="$HOJ_PrisonMacro" exact="macro.room_gen_detentioncell_01_macro"/>
            <get_room_definition doors="$HOJ_PrisonInteriorDoors" macro="$HOJ_PrisonCorridorMacro" race="race.split" tags="tag.corridor" />
            <set_value name="$HOJ_PrisonDoor" exact="if $HOJ_PrisonInteriorDoors.count ge 3 then $HOJ_PrisonInteriorDoors.{3} else $HOJ_PrisonInteriorDoors.{1}"/>
            <create_dynamic_interior interiorname="$HOJ_Prison_Interior" corridorname="$HOJ_Prison_Corridor" roomname="$HOJ_Prison_Room" object="$HOJStation" room="$HOJ_PrisonMacro" corridor="$HOJ_PrisonCorridorMacro" door="$HOJ_PrisonDoor" name="'{20007,3021}'" persistent="true"/>
            <set_dynamic_interior_private object="$HOJStation" interior="$HOJ_Prison_Interior" private="true"/>

            <set_trigger_activation_wares room="$HOJ_Prison_Room" group="tag.door_01" ware="ware.inv_encrypted_accesskey" amount="1" consumeonuse="true" />
            <set_triggers_locked object="$HOJ_Prison_Room" group="tag.door_02" locked="true"/>
            <set_trigger_activation_wares room="$HOJ_Prison_Room" group="tag.door_03" ware="ware.inv_encrypted_accesskey" amount="1" consumeonuse="true"/>

            <!-- create Hall of Judgement Control room (persistent) -->
            <set_value name="$HOJ_ControlMacro" exact="macro.room_gen_managersoffice_01_macro"/>
            <get_room_definition doors="$HOJ_ControlInteriorDoors" macro="$HOJ_ControlCorridorMacro" race="race.split" tags="tag.corridor" />
            <set_value name="$HOJ_ControlDoor" exact="if $HOJ_ControlInteriorDoors.count ge 3 then $HOJ_ControlInteriorDoors.{3} else $HOJ_ControlInteriorDoors.{1}"/>
            <create_dynamic_interior interiorname="$HOJ_Control_Interior" corridorname="$HOJ_Control_Corridor" roomname="$HOJ_Control_Room" object="$HOJStation" room="$HOJ_ControlMacro" corridor="$HOJ_ControlCorridorMacro" door="$HOJ_ControlDoor" name="'{20007,1151}'" persistent="true"/>
            <set_dynamic_interior_private object="$HOJStation" interior="$HOJ_Control_Interior" private="true"/>
          </actions>
          <patch sinceversion="2" state="complete">
            <!-- restore any wrecked modules-->
            <find_object_component name="$ModuleWrecks" object="$HOJStation" class="class.module" multiple="true" state="componentstate.wreck"/>
            <do_for_each name="$ModuleWreck" in="$ModuleWrecks" counter="$i">
              <debug_text text="'restoring module ' + $ModuleWreck + ' ' + $ModuleWreck.knownname" filter="savegame"/>
              <restore_object object="$ModuleWreck" recursive="true"/>
              <set_object_hull object="$ModuleWreck" exact="100"/>
            </do_for_each>
            <do_if value="@$SlaveTraderShip.isoperational and Ch4_Collaborate_Station_Takeover.state == cuestate.complete and Ch4_Docked.state != cuestate.complete and Ch4_Docked.state != cuestate.cancelled">
              <!-- reissue order (is aborted if it fails once due to missing dock) -->
              <cancel_all_orders object="$SlaveTraderShip"/>
              <create_order id="'DockAndWait'" object="$SlaveTraderShip" >
                <param name="destination" value="$HOJStation" comment="stay docked at Halls of Judgement"/>
                <param name="debugchance" value="$DebugChance"/>
              </create_order>
            </do_if>

            <!--Set to invincible-->
            <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
              <param name="Object" value="$HOJStation"/>
              <param name="RequesterCue" value="HallsOfJudgement_Setup"/>
              <param name="DebugChance" value="$DebugChance"/>
            </run_actions>

            <!--Reinitialise as the engineer and AI unit was not set up-->
            <signal_objects object="player.galaxy" param="'init station'" param2="$HOJStation" param3="false"/>
          </patch>
          <cues>
            <cue name="HallsOfJudgement_Guardian">
              <conditions>
                <event_object_destroyed object="$HOJStation"/>
              </conditions>
              <actions>
                <debug_text text="'recreating HOJ'" chance="$DebugChance"/>
                <!-- todo: find another location, slowly rebuild, while ch4 waits for construction -->
                <reset_cue cue="HallsOfJudgement_Setup" comment="respawn"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Debug_Cues">
          <cues>

            <cue name="Debug_Skipper_Story_Split" onfail="cancel">
              <conditions>
                <check_value value="player.debug" comment="skipper only in debug builds"/>
              </conditions>
              <cues>
                <!-- In newer stories, all Debug_Skipper* cues are in here.-->
                <cue name="Debug_SkipperShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.Setup.Debug_Setup_SkipperShip_Create"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Debug_SkipperShip_Completed">
              <conditions>
                <event_cue_completed cue="md.Setup.Debug_Setup_SkipperShip_Create_Completed"/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="Debug_Skipper"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <!--<event_cue_signalled cue="md.Story_Split.Ch0"/>
                  <event_cue_signalled cue="md.Story_Split.Ch1_Arrival"/>
                  <event_cue_signalled cue="md.Story_Split.Ch2_Study"/>
                  <event_cue_signalled cue="md.Story_Split.Ch3_Conspiracy"/>
                  <event_cue_signalled cue="md.Story_Split.Ch4_Collaborate"/>
                  <event_cue_signalled cue="md.Story_Split.Ch5_Choose"/>
                  <event_cue_signalled cue="md.Story_Split.Ch6_Sink"/>
                  <event_cue_signalled cue="md.Story_Split.Ch7_Stage_2"/>
                  <event_cue_signalled cue="md.Story_Split.Ch8_Stage_3_v2"/>-->
                </check_any>
              </conditions>
              <actions>
                <create_cue_actor name="$SkipperActor" cue="$MissionCue" macro="character_split_curb_macro">
                  <owner exact="faction.civilian"/>
                  <name name="'Split Skipper'"/>
                </create_cue_actor>
                <set_entity_type entity="$SkipperActor" type="entitytype.crowd"/>
                <set_entity_traits entity="$SkipperActor" missionactor="true" customhandler="true"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="Debug_Skipper_Spawn"/>
              </actions>
              <cues>

                <cue name="Debug_Skipper_Spawn" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$SkipperPos" x="12.5" y="-2.9m" z="-2.8"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = md.Setup.Debug_Setup_SkipperShip.$SkipperShip.controlroom,
                                                                                                                                      $position = $SkipperPos,
                                                                                                                                      $rotation = rotation.[280deg, 0deg, 0deg],
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Disconnect" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$SkipperActor"/>
                  </conditions>
                  <actions>
                    <add_player_choice highlighted="true" section="skipper_main" text="'PLEASE SAVE YOUR GAME'"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$SkipperActor" section="skipper_main"/>
                      <event_conversation_returned_to_section actor="$SkipperActor" section="skipper_main"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_value name="this.$Selectable" exact="false"/>
                    <do_if value="md.Story_Split.Split_Story_Activation_Manager.state == cuestate.cancelled">
                      <set_value name="this.$Selectable" exact="true"/>
                    </do_if>
                    <add_player_choice_sub section="skipper_chapter_split" text="'Skip to Split chapter'" selectable="this.$Selectable" tooltip="'Requires HQ with Boso and Dal'"/>
                    <add_player_choice_sub section="skipper_sinks_split" text="'Skip to Split sinks'" selectable="this.$Selectable" tooltip="'Requires HQ with Boso and Dal'"/>

                    <add_player_choice_sub section="skipper_credits" text="'Cheat 500 mio credits'"/>
                    <add_player_choice_sub section="skipper_bombs" text="'Cheat Caviar and Bombs'"/>
                    <add_player_choice_sub section="skipper_hq" text="'Cheat HQ'"/>
                  </actions>
                </cue>

                <!-- *** SPLIT SKIPPER *** -->
                <cue name="Debug_Skipper_Conversation_Chapter_Split" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_chapter_split"/>
                  </conditions>
                  <actions>
                    <do_if value="md.Story_Split.Ch5_Choose.state == cuestate.waiting">
                      <set_value name="this.$Selectable" exact="true"/>
                    </do_if>
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_1'" text="'Split: Skip to Ch1'" />
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_2'" text="'Split: Skip to Ch2'"/>
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_3'" text="'Split: Skip to Ch3'"/>
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_4'" text="'Split: Skip to Ch4'"/>
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_5'" text="'Split: Skip to Choice'"/>
                    <add_player_choice_return text="'Back'"/>
                  </actions>
                </cue>
                <cue name="Debug_Skipper_Conversation_Sinks_Split" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_sinks_split"/>
                  </conditions>
                  <actions>
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_6_Patriarchy'" text="'Split: Skip to Ch6 Patriarchy'" />
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_7_Patriarchy'" text="'Split: Skip to Ch7 Patriarchy'"/>
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_6_Curbs'" text="'Split: Skip to Ch6 Curbs'"/>
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_7_Curbs'" text="'Split: Skip to Ch7 Curbs'"/>
                    <add_player_choice section="skipper_chapter_split_selected" choiceparam="'ch_8_Curbs'" text="'Split: Skip to Ch8 Curbs'"/>
                    <add_player_choice_return text="'Back'"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Chapter_Split_Selected" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_chapter_split_selected"/>
                  </conditions>
                  <actions>
                    <!-- Reset / cancel previous chapters to prevent interference. -->
                    <set_value name="$SplitChapterCues" exact="[md.Story_Split.Loop_Offer_Story_Start,
                                                            md.Story_Split.StoryOffer,
                                                            md.Story_Split.Ch0,
                                                            md.Story_Split.Ch1_Arrival,
                                                            md.Story_Split.Ch2_Study,
                                                            md.Story_Split.Ch3_Conspiracy,
                                                            md.Story_Split.Ch4_Collaborate,
                                                            md.Story_Split.Ch5_Choose,
                                                            md.Story_Split.Ch6_Sink,
                                                            md.Story_Split.Ch7_Stage_2,
                                                            md.Story_Split.Ch8_Stage_3_v2]"/>
                    <do_for_each in="$SplitChapterCues" name="$Chapter">
                      <do_if value="$Chapter.state == cuestate.complete">
                        <set_value name="$RunningSplitChapter" exact="$Chapter"/>
                      </do_if>
                      <do_elseif value="$Chapter.state == cuestate.waiting">
                        <do_if value="$RunningSplitChapter?">
                          <do_if value="$RunningSplitChapter == md.Story_Split.StoryOffer">
                            <cancel_cue cue="$RunningSplitChapter"/>
                          </do_if>
                          <do_else>
                            <reset_cue cue="$RunningSplitChapter"/>
                          </do_else>
                        </do_if>
                        <break/>
                      </do_elseif>
                    </do_for_each>

                    <do_if value="event.param2 == 'ch_1'">
                      <signal_cue cue="md.Story_Split.Ch1_Arrival"/>
                    </do_if>
                    <do_if value="event.param2 == 'ch_2'">
                      <signal_cue cue="md.Story_Split.Ch2_Study"/>
                    </do_if>
                    <do_if value="event.param2 == 'ch_3'">
                      <signal_cue cue="md.Story_Split.DEBUG_Setup_Ch3"/>
                    </do_if>
                    <do_if value="event.param2 == 'ch_4'">
                      <signal_cue cue="md.Story_Split.Ch4_Collaborate"/>
                    </do_if>
                    <do_if value="event.param2 == 'ch_5'">
                      <!-- Improve reputation to prevent unneccessary attacks. -->
                      <set_faction_relation faction="faction.freesplit" otherfaction="faction.player" value="1.0"/>
                      <set_faction_relation faction="faction.split" otherfaction="faction.player" value="0"/>

                      <signal_cue cue="md.Story_Split.Ch5_Choose_DEBUG "/>
                    </do_if>
                    <do_if value="event.param2 == 'ch_6_Patriarchy'">
                      <signal_cue cue="md.Story_Split.Debug_Ch6_Patriarchy"/>
                    </do_if>
                    <do_if value="event.param2 == 'ch_6_Curbs'">
                      <signal_cue cue="md.Story_Split.Debug_Ch6_Curbs"/>
                    </do_if>
                    <do_if value="event.param2 == 'ch_7_Patriarchy'">
                      <signal_cue cue="md.Story_Split.Debug_Ch7_Stage_2_Patriarchy"/>
                    </do_if>
                    <do_if value="event.param2 == 'ch_7_Curbs'">
                      <signal_cue cue="md.Story_Split.Debug_Ch7_Stage_2_Curb"/>
                    </do_if>
                    <do_if value="event.param2 == 'ch_8_Curbs'">
                      <signal_cue cue="md.Story_Split.Ch8_Stage_3_v2"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Caviar_Bombs" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_bombs"/>
                  </conditions>
                  <actions>
                    <add_inventory ware="ware.inv_spaceflycaviar" exact="5"/>
                    <add_inventory ware="ware.weapon_gen_spacesuit_demolition_01_mk1"     exact="1"/>
                    <add_inventory ware="ware.bomb_player_limpet_mine_01_mk1"             exact="20"/>
                    <add_inventory ware="ware.bomb_player_limpet_emp_01_mk1"              exact="20"/>
                    <add_player_choice_return text="'Back'"/>
                  </actions>
                </cue>

                <cue name="Debug_Skipper_Conversation_Credits" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_credits"/>
                  </conditions>
                  <actions>
                    <reward_player money="500000000Cr"/>
                    <add_player_choice_return text="'Back'"/>
                  </actions>
                </cue>
                <cue name="Debug_Skipper_Conversation_HQ" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$SkipperActor" section="skipper_hq"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Debug_Setup_HQ"/>
                    <add_player_choice_return text="'Back'"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Debug_Arm_Spacesuit">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_inventory ware="ware.weapon_gen_spacesuit_demolition_01_mk1"     exact="2"/>
                <add_inventory ware="ware.weapon_gen_spacesuit_laser_01_mk1"          exact="2"/>
                <add_inventory ware="ware.weapon_gen_spacesuit_repairlaser_01_mk1"    exact="2"/>
                <add_inventory ware="ware.bomb_player_limpet_mine_01_mk1"             exact="123"/>
                <add_inventory ware="ware.bomb_player_limpet_emp_01_mk1"              exact="123"/>
                <debug_text text="'Boom.'"/>
              </actions>
            </cue>

            <cue name="Debug_Setup_HQ">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <cancel_cue cue="md.X4Ep1_Mentor_Subscriptions.Phase_SignalLeak"/>
              </actions>
              <cues>
                <cue name="Debug_Spawn_HQ">
                  <delay exact="5ms"/>
                  <actions>
                    <do_if value="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors.state == cuestate.waiting and not md.X4Ep1_Mentor_Subscriptions.Start.$HQ?">
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors" param="true"/>
                    </do_if>
                    <do_elseif value="md.X4Ep1_Mentor_Subscriptions.Start.$HQ? and not md.X4Ep1_Mentor_Subscriptions.Start.$HQ.isplayerowned">
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors" param="true"/>
                    </do_elseif>
                    <signal_cue cue="Set_Persistent_Characters"/>
                  </actions>
                </cue>
                <cue name="Set_Persistent_Characters">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                    <set_value name="$DalBusta"   exact="md.$PersistentCharacters.$DalBusta"/>
                    <set_value name="$BosoTa"     exact="md.$PersistentCharacters.$BosoTa"/>
                    <set_value name="$BosoCutsceneKey"      exact="table[ $key = 'ShowCharacterBoron']"/>
                    <assert value="$DalBusta != null" text="'Dal is null'"/>
                    <assert value="$BosoTa != null" text="'Boso is null'"/>

                    <signal_cue_instantly cue="md.Story_Diplomacy_Intro.Pt11_End" param="table[$forced = true]" check="false"/>
                    <cancel_cue cue="Split_Story_Activation_Manager"/>
                    <signal_cue cue="Dal_Dialog_Option_Split_Story"/>
                    <signal_cue cue="Loop_Offer_Story_Start"/>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <!--
        ############### PLOT PHASES / Chapters ###############
        The phases are sections of the plot. Only one phase should be active at a time.
        They can contain the following:
        - Set-piece plot mission content
        - Calls trigger mission thread offers, defined below (those managed through md.MC_Management.Thread_Manager)
        - Calls to single GM definitions
        ###########################################
        Phase Prefixes:
          - Ch1_Arrival_
          - Study_
          - Conspiracy_ (Identify_Prove_)
          - Collaborate_
          - Choose_
          - Sink_
          - Curbs_
          - Patriarchy_
        ###########################################-->

        <!-- Dal Busta Story Interaction -->
        <cue name="Dal_Dialog_Option_Split_Story">
          <!-- Cancelled in Ch6_Sink -->
          <conditions>
            <check_any>
              <event_cue_signalled/>
            </check_any>
          </conditions>
          <cues>
            <cue name="Dal_Section_Story_Split" instantiate="true">
              <conditions>
                <event_conversation_started actor="$DalBusta"/>
                <check_value value="($HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ} and (player.entity.room == $DalBusta.room))
                             or ($FuneralServiceShip? and $DalBusta.hascontext.{$FuneralServiceShip} and player.entity.hascontext.{$FuneralServiceShip})"/>
                <check_value value="event.param != 'curiosity_got_the_better_of_you'" comment="conversation started mid-conversation"/>
              </conditions>
              <actions>
                <add_player_choice section="story_split" selectable="true"
                                   text="{30221,302}" comment="'The Split Connection'"/>
                <!-- choice param remains null for Ch0_Dal_Split_Dialog -->
                <add_player_choice section="main" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- *** STORY MANAGER INTERACTION *** -->
        <!-- Set $HQ/$Dal/$Boso - SIGNAL: Loop_Offer_Story_Start -->
        <cue name="Split_Story_Activation_Manager">
          <cues>

            <cue name="Activate_Immediately" onfail="cancel">
              <conditions>
                <check_value value="md.X4Ep1_Mentor_Subscriptions.UnlockResearch.state == cuestate.complete and md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete"/>
                <check_value value="not $HasCustomGamestartSkip"/>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <cue name="Check_For_Scientific_Mentor_Ending" version="3">
              <conditions>
                <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.UnlockResearch"/>
                <check_value value="md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete"/>
                <check_value value="not $HasCustomGamestartSkip"/>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
              <patch sinceversion="3" state="waiting">
                <do_if value="(md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete) and (md.X4Ep1_Mentor_Subscriptions.UnlockResearch.state == cuestate.complete)">
                  <signal_cue cue="Activate_Story"/>
                </do_if>
              </patch>
            </cue>

            <cue name="Check_For_Diplomatic_Mentor_Ending">
              <conditions>
                <event_cue_completed cue="md.Story_Diplomacy_Intro.Pt11_End"/>
                <check_value value="md.X4Ep1_Mentor_Subscriptions.UnlockResearch.state == cuestate.complete"/>
                <check_value value="not $HasCustomGamestartSkip"/>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <cue name="Activate_Story">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
                <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
                <assert value="$DalBusta != null" text="'DalBusta is null'"/>
                <assert value="$BosoTa != null" text="'BosoTa is null'"/>

                <signal_cue cue="Loop_Offer_Story_Start"/>
                <cancel_cue cue="Split_Story_Activation_Manager"/>
                <signal_cue cue="Dal_Dialog_Option_Split_Story"/>
              </actions>
            </cue>

            <cue name="Handle_Custom_Gamestart_Skip" onfail="cancel">
              <conditions>
                <check_value value="$HasCustomGamestartSkip"/>
              </conditions>
              <cues>
                <cue name="Handle_Custom_Gamestart_Skip_Activate" checkinterval="50ms" version="3">
                  <conditions>
                    <check_value value="@md.$PersistentCharacters.$DalBusta.exists"/>
                  </conditions>
                  <actions>
                    <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
                    <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
                    <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
                    <assert value="$DalBusta != null" text="'DalBusta is null'"/>
                    <assert value="$BosoTa != null" text="'BosoTa is null'"/>

                    <do_if value="$story_split_faction_decision">
                      <signal_cue cue="Ch5_Choose_DEBUG"/>
                    </do_if>
                    <do_elseif value="$story_split_curbs_declaration">
                      <set_object_active object="$FuneralGate" activate="true"/>
                      <signal_cue_instantly cue="Police_Rattlesnake" param="[$BoneYardSector]"/>
                      <signal_cue_instantly cue="Sink_Effect_Curbs_Stage1_NewFaction" param="true"/>
                      <signal_cue cue="Debug_Ch7_Stage_2_Curb"/>
                    </do_elseif>
                    <do_elseif value="$story_split_curbs_no_colonial_police">
                      <set_object_active object="$FuneralGate" activate="true"/>
                      <signal_cue_instantly cue="Sink_Effect_Curbs_Stage1_NewFaction" param="true"/>
                      <signal_cue_instantly cue="Sink_Effect_Curbs_Stage2_StopPolice" param="true"/>
                      <signal_cue cue="Ch8_Stage_3_v2"/>
                    </do_elseif>
                    <do_elseif value="$story_split_cabal_coup">
                      <set_object_active object="$FuneralGate" activate="true"/>
                      <set_faction_relation faction="faction.court" otherfaction="faction.player" value="-1.0"/>
                      <set_value name="$RelationUpToZero" exact="0"/>
                      <do_if value="faction.player.relationto.{faction.split} lt 0">
                        <set_value name="$RelationUpToZero" exact="-1 * (faction.player.relationto.{faction.split})"/>
                      </do_if>
                      <add_faction_relation faction="faction.player" otherfaction="faction.split" value="(($ZyarthRelationBonus/$ZyarthRelationBonusMax) * 0.032) + $RelationUpToZero" reason="relationchangereason.missioncompleted" />
                      <signal_cue_instantly cue="Police_Rattlesnake" param="[$HeartOfAcrimonySector]"/>
                      <signal_cue_instantly cue="Sink_Effect_Zyarth_Stage1_NewFaction" param="true"/>
                      <signal_cue cue="Debug_Ch7_Stage_2_Patriarchy"/>
                    </do_elseif>

                    <!--Story completed states-->
                    <do_elseif value="$story_split_cabal_complete">
                      <set_object_active object="$FuneralGate" activate="true"/>
                      <signal_cue_instantly cue="Sink_Effect_Zyarth_Stage1_NewFaction" param="true"/>
                      <signal_cue_instantly cue="Sink_Effect_Zyarth_Stage2_TakeOverSectors" param="true"/>
                    </do_elseif>
                    <do_elseif value="$story_split_court_complete">
                      <set_object_active object="$FuneralGate" activate="true"/>
                      <signal_cue_instantly cue="Sink_Effect_Curbs_Stage1_NewFaction" param="true"/>
                      <signal_cue_instantly cue="Sink_Effect_Curbs_Stage2_StopPolice" param="true"/>
                      <signal_cue_instantly cue="Sink_Effect_Curbs_Stage3_NewPatriarchy" param="true"/>
                    </do_elseif>

                    <do_if value="$HasCustomGamestartSkip">
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_coffin"/>
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_thrones"/>
                    </do_if>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <do_if value="@$PoliceRattleSnake.isoperational">
                      <!--We don't need the rattlesnake operational at either of the above points where it may have been created.-->
                      <destroy_object object="$PoliceRattleSnake"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="3">
                    <do_if value="$HasCustomGamestartSkip">
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_coffin"/>
                      <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_thrones"/>
                    </do_if>
                  </patch>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>
        <!-- While not $SplitStoryOfferedSuccessfully?, - SIGNAL: Dal_Offer_Call -->
        <cue name="Loop_Offer_Story_Start">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>
            <cue name="Loop_Offer_Story">
              <delay exact="180s"/>
              <actions>
                <do_if value="not $SplitStoryOfferedSuccessfully?">
                  <do_if value="Dal_Offer_Call.state == cuestate.waiting">
                    <signal_cue cue="Dal_Offer_Call"/>
                  </do_if>
                  <reset_cue cue="this"/>
                </do_if>
              </actions>
            </cue>
          </cues>
        </cue>


        <cue name="StoryOffer">
          <!--<conditions>
            <event_cue_signalled cue="md.NPC_Diplomatic_Mentor.StoryManager"/>
          </conditions>-->
          <cues>
            <!--
            <cue name="StoryAdd" checkinterval="3s">
              <conditions>
                <check_value value="md.NPC_Diplomatic_Mentor.StoryManager.state == cuestate.complete"/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Diplomatic_Mentor.AddStory" param="Start"/>
              </actions>
            </cue>-->
            <cue name="StoryRemove">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!--<signal_cue_instantly cue="md.NPC_Diplomatic_Mentor.RemoveStory" param="Start"/>-->
                <set_value name="$SplitStoryOfferedSuccessfully"/>
              </actions>
            </cue>

            <cue name="StoryReminder" instantiate="true">
              <!-- Prevents the story from being offered multiple times -->
              <conditions>
                <event_cue_signalled cue="Start"/>
                <check_value value="event.param == 'trigger_reminder'"/>
                <check_value value="Dal_Offer_Call.state == cuestate.waiting"/>
              </conditions>
              <actions>
                <signal_cue cue="Dal_Offer_Call"/>
              </actions>
            </cue>

            <!-- Interaction Cutscene
                 Failed to accept the call, RESET: Dal_Offer_Call
                 Accepted Call,
                  - g_Cancel,   RESET: Dal_Offer_Call
                  - accept,     SIGNAL: StoryRemove, Ch0
                  - decline,    SIGNAL: StoryRemove, Story_Offer_At_HQ
                                SET: $PlayerDeclined
            -->
            <cue name="Dal_Offer_Call" comment="resets on Fail_To_Interact/ESC, otherwise signals StoryRemove">
              <conditions>
                <event_cue_signalled/>
                <check_value value="not (player.entity.room == $DalBusta.room)"/>
              </conditions>
              <cues>
                <cue name="Dal_Wait_For_Fullscreen" checkinterval="5s">
                  <conditions>
                    <check_value value="not player.isinfullscreenmenu"/>
                    <check_value value="not player.isinconversation"/>
                    <check_value value="not player.isscreenshotmode"/>
                    <check_value value="not md.$MissionDND.count"/>
                    <check_value value="player.age ge (md.$LastMentorSpeak + 30min)"/>
                  </conditions>
                  <actions>
                    <!-- Offer Call and at HQ -->
                    <!-- no mission cue as there currently is no mission -->
                    <play_cutscene key="$DalCutsceneKey.$key" result="parent.$CutsceneID" targetmonitor="true" timeout="20s">
                      <interaction text="{30220,1004}" param="$DalBusta" param2="'accept_interaction_story_split'"/>
                      <param name="npcref" object="$DalBusta" />
                      <param name="room"   object="$DalBusta.room" />
                    </play_cutscene>
                    <!--<cancel_cue cue="md.Story_Diplomacy_Intro.Pt11_End"/>
                    <cancel_cue cue="md.Story_Diplomacy_Intro.Pt11_Dal_Conversation"/>-->
                  </actions>
                  <cues>

                    <cue name="Dal_Call_Speak_v2">
                      <conditions>
                        <event_cutscene_started cutscene="parent.parent.$CutsceneID"/>
                        <check_value value="event.param2" comment="So that we're not listening for null before the cutscene starts"/>
                      </conditions>
                      <actions>
                        <speak actor="$DalBusta" priority="90">
                          <text line="if player.entity.isfemale then 30200002 else 30200001" delay="0.6s" comment="Hey there partner."/>
                        </speak>
                      </actions>
                    </cue>

                    <!-- Accept the call -->
                    <cue name="Dal_Call_Interact_v3">
                      <conditions>
                        <event_player_interaction param="$DalBusta" param2="'accept_interaction_story_split'"/>
                      </conditions>
                      <actions>
                        <stop_cutscene cutscene="parent.parent.$CutsceneID"/>
                        <!-- no mission cue as there currently is no mission -->
                        <start_conversation actor="$DalBusta" conversation="story_offer" priority="100"/>
                      </actions>
                    </cue>

                    <cue name="Dal_Call_Cutscene_Stopped">
                      <conditions>
                        <event_cutscene_stopped cutscene="parent.parent.$CutsceneID"/>
                      </conditions>
                      <actions>
                        <do_if value="Dal_Call_Interact_v3.state == cuestate.waiting">
                          <reset_cue cue="parent.parent" comment="Remind Later"/>
                        </do_if>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Story_Activated">
              <conditions>
                <event_cue_signalled cue="Activate_Story"/>
              </conditions>
              <cues>
                <cue name="Dal_Offer_Story_Conversation_Start_v4" instantiate="true">
                  <conditions>
                    <check_any>
                      <!--<event_conversation_started actor="$DalBusta"/>-->
                      <event_conversation_started actor="$DalBusta" conversation="story_offer"/>
                      <event_conversation_next_section actor="$DalBusta" section="story_split"/>
                      <event_conversation_next_section actor="$DalBusta" section="story_split_accept"/>
                      <event_conversation_next_section actor="$DalBusta" section="g_cancel"/>
                      <event_conversation_next_section actor="$DalBusta" section="story_split_decline"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="(event.name == 'event_conversation_started') or event.param == 'story_split'">
                      <allow_conversation_escape enabled="true"/>
                      <!-- Story Specific Line is said -->
                      <add_npc_line speaker="$DalBusta" line="30221137" comment="I have looked into and analysed the sociopolitical forces at play in the Split territories." hidechoices="true"/>
                      <!-- Player Choice: Interested; Not; Escaped -->
                      <add_player_choice text="{30221,1052}" comment="(Player Choice)What did you learn about the factions?(addressing male character Dal)" section="story_split_accept" position="bottom_left"/>
                      <add_player_choice text="{30220,202}" comment="I'm not interested." section="story_split_decline" position="bottom_right"/>
                    </do_if>
                    <do_elseif value="event.name == 'event_conversation_next_section'">
                      <!-- CANCEL - Remind Later -->
                      <do_if value="event.param == 'g_cancel'">
                        <reset_cue cue="Dal_Offer_Call" comment="Remind Later"/>
                      </do_if>
                      <!-- ACCEPT - Start directly, Abort Reminders-->
                      <do_elseif value="event.param == 'story_split_accept'">
                        <signal_cue cue="StoryRemove" comment="No more Reminders, Story starts directly"/>
                        <cancel_cue cue="Story_Activated"/>
                        <!--<signal_cue cue="Dal_Dialog_Option_Split_Story" comment="Add Split Story to Dal Player Choices"/>-->
                        <signal_cue cue="Ch0"/>
                      </do_elseif>
                      <!-- DECLINE - Abort Reminders, Offer At HQ-->
                      <do_elseif value="event.param == 'story_split_decline'">
                        <!--<signal_cue cue="Dal_Dialog_Option_Split_Story" comment="Add Split Story to Dal Player Choices"/>-->
                        <signal_cue cue="StoryRemove" comment="No more Reminders, Story offered in HQ"/>
                        <signal_cue cue="Story_Offer_At_HQ"/>
                        <cancel_cue cue="Story_Activated"/>
                        <add_npc_line speaker="$DalBusta" line="30200005" comment="That's too bad." hidechoices="true"/>
                        <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30200007 else 30200006" comment="You can always come and find me if you change your mind." hidechoices="true"/>
                        <set_value name="$PlayerDeclined"/>
                      </do_elseif>
                    </do_elseif>
                  </actions>
                </cue>
              </cues>
            </cue>

            <!-- 
                 Gate Event done, SIGNAL Ch1_Arrival
                 else, accept, SIGNAL Ch0
            -->
            <cue name="Story_Offer_At_HQ" comment="Player Declined the Story Offer; Offer at HQ Ch0 or Ch1">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <!-- Accept, SIGNAL: Ch0 -->
                <cue name="Ch0_Dal_Split_Dialog" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="story_split"/>
                  </conditions>
                  <actions>
                    <do_if value="event.param2 == null">
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="if player.entity.isfemale then 30200009 else 30200008" comment="Did curiosity get the better of you?"/>
                        <text line="30220984" comment="Excellent!"/>
                      </add_npc_line>
                      <cancel_cue cue="Story_Offer_At_HQ"/>

                      <!-- We need to know here which chapter to signal, otherwise the player gets kicked out of the conv if it's Ch1 -->

                      <!-- Copy of Ch0_Check_Prerequisites Code -->

                      <!-- No Prereq mission on Split Gamestarts -->
                      <set_value name="$SplitGamestart" exact="false"/>
                      <do_if value="player.module == 'x4ep1_gamestart_split1'">
                        <set_value name="$SplitGamestart" exact="true"/>
                      </do_if>
                      <do_elseif value="player.module == 'x4ep1_gamestart_split2'">
                        <set_value name="$SplitGamestart" exact="true"/>
                      </do_elseif>

                      <!-- Check if the Player knows the Gates to DLC space -->
                      <set_value name="$GateEventDone" exact="$SplitGamestart" comment="Don't bug Split about finding a way back"/>
                      <do_if value="not $SplitGamestart">
                        <do_if value="(md.Setup_DLC_Split.Gate_Intro.state == cuestate.complete) or
                                (md.Setup_DLC_Split.Gate_Intro.state == cuestate.cancelled)">
                          <set_value name="$GateEventDone" exact="true"/>
                        </do_if>
                      </do_if>

                      <do_if value="$GateEventDone and player.entity.room == $DalBusta.room">
                        <signal_cue_instantly cue="Ch1_Arrival"/>
                        <!-- no mission cue as there currently is no mission -->
                        <start_conversation actor="$DalBusta" conversation="curiosity_got_the_better_of_you"/>
                      </do_if>
                      <do_else>
                        <signal_cue cue="Ch0"/>
                      </do_else>

                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Ch0">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <cancel_cue cue="StoryOffer"/>
          </actions>
          <cues>

            <!--$GateEventDone, SIGNAL: Ch0_Meet_Dal_Start_Ch1 OR Ch1_Arrival
                else            SIGNAL: Ch0_Offer_Rumors -->
            <cue name="Ch0_Check_Prerequisites">
              <actions>
                <!-- No Prereq mission on Split Gamestarts -->
                <set_value name="$SplitGamestart" exact="false"/>
                <do_if value="player.module == 'x4ep1_gamestart_split1'">
                  <set_value name="$SplitGamestart" exact="true"/>
                </do_if>
                <do_elseif value="player.module == 'x4ep1_gamestart_split2'">
                  <set_value name="$SplitGamestart" exact="true"/>
                </do_elseif>

                <!-- Check if the Player knows the Gates to DLC space -->
                <set_value name="$GateEventDone" exact="$SplitGamestart" comment="Don't bug Split about finding a way back"/>
                <do_if value="not $SplitGamestart">
                  <do_if value="(md.Setup_DLC_Split.Gate_Intro.state == cuestate.complete) or
                                (md.Setup_DLC_Split.Gate_Intro.state == cuestate.cancelled)">
                    <set_value name="$GateEventDone" exact="true"/>
                  </do_if>
                </do_if>

                <do_if value="$GateEventDone">
                  <do_if value="player.entity.room == $DalBusta.room">
                    <signal_cue cue="Ch1_Arrival"/>
                  </do_if>
                  <do_else>
                    <signal_cue cue="Ch0_Meet_Dal_Start_Ch1"/>
                  </do_else>
                </do_if>
                <do_else>
                  <signal_cue_instantly cue="Ch0_Offer_Rumors"/>
                </do_else>
              </actions>
            </cue>

            <!-- SIGNAL Set Objective, on completion SIGNAL Ch1_Arrival -->
            <cue name="Ch0_Offer_Rumors">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_npc_line speaker="$DalBusta" hidechoices="true">
                  <text line="30221010" comment="There are rumors of gates activating, leading into Split space."/>
                  <text line="30221011" comment="A number of their ships have been sighted in several sectors."/>
                  <text line="30221012" comment="I'll try and find out all I can about Split politics."/>
                  <text line="if player.entity.isfemale then 30221014 else 30221013" comment="You meanwhile investigate the rumors and try to find those gates."/>
                </add_npc_line>
              </actions>
              <cues>
                <cue name="Ch0_Offer_Rumors_Done">
                  <conditions>
                    <event_conversation_finished actor="$DalBusta"/>
                  </conditions>
                  <actions>
                    <!-- Mission: Reactivating Jump Gates -->
                    <set_value name="$Description" exact="if player.entity.isfemale then {30221,803} else {30221,802}"
                               comment="(Mission Text)Your trusted friend Dal Busta heard rumors of Jump Gate reactivations and Split ship sightings. While he inquires the Alliance of the Word about the Split, your task is to investigate those rumors and try to find the reactivated gates."/>
                    <!-- Set Objective "Find Gates to Split Space"; Listen for Completion, -->
                    <create_mission cue="$MissionCue" name="{30221,801}" faction="faction.player" type="missiontype.plot" abortable="false" group="missiongroup.story_split"
                                    difficulty="level.easy" description="$Description" rewardtext="{30221,999}"
                                    icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
                      <briefing>
                        <objective step="1" action="objective.find" text="{30221,811}" comment="(objective.find)Reconnected Jump Gate"/>
                      </briefing>
                    </create_mission>
                    <set_objective_from_briefing step="1" cue="$MissionCue"/>
                  </actions>
                  <cues>
                    <cue name="Ch0_Prereq_Mission_Completed_Failsafe">
                      <delay exact="2s"/>
                      <actions>
                        <do_if value="(Ch0_Prereq_Mission_Completed.state == cuestate.waiting)
                           and (     (md.Setup_DLC_Split.Gate_Intro.state == cuestate.complete)
                                  or (md.Setup_DLC_Split.Gate_Intro.state == cuestate.cancelled) )">
                          <signal_cue cue="Ch0_Prereq_Mission_Completed"/>
                        </do_if>
                        <do_elseif value="not ((Ch0_Prereq_Mission_Completed.state == cuestate.waiting) or 
                                           (Ch0_Prereq_Mission_Completed.state == cuestate.complete) )">
                          <reset_cue cue="this"/>
                        </do_elseif>
                      </actions>
                    </cue>

                    <cue name="Ch0_Prereq_Mission_Completed">
                      <!--Listen for Completion, Signal .. Offer_At_HQ ? -->
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_cue_completed cue="md.Setup_DLC_Split.Gate_Intro"/>
                          <event_cue_cancelled cue="md.Setup_DLC_Split.Gate_Intro"/>
                        </check_any>
                      </conditions>
                      <cues>
                        <cue name="Ch0_Prereq_Mission_Completed_Delay">
                          <delay exact="12s"/>
                          <actions>
                            <!-- TODO @Heinrich Place Dal somewhere close to the Split gate -->
                            <signal_cue cue="Ch0_Prereq_Mission_Completed_Delay_Signalled"/>
                          </actions>
                        </cue>
                        <cue name="Ch0_Prereq_Mission_Completed_Delay_Signalled">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch0_Speak_Dal_015_Complete_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30221016 else 30221015],
                                                                  [30220984],
                                                                  [30221137],
                                                                  [30200012],
                                                                  [if player.entity.isfemale then 30220013 else 30220012]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="Ch0_Logbook"/>
                              <!-- 
                           <t id="30221015">You found it! A gate connecting our space to Split space!</t>
                           <t id="30221016">(spoken to female 'you' variation){,30221015}</t>                          
                           <t id="30220984">Excellent!</t>                           
                           <t id="30221137">I have looked into and analysed the sociopolitical forces at play in the Split territories.</t>  
                           30200012 However, that is not a conversation to hold over comms.
                 not used: <t id="30221505">You'd better meet me to discuss this.</t>
                 not used: <t id="30221506">(spoken to female 'you'){,30221505}</t>
                           <t id="30220012">Meet me to discuss this.</t>
                           <t id="30220013">(spoken to female 'you' variation){10111,30220012}</t>
                          -->
                            </cue>

                            <cue name="Ch0_Logbook">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <remove_mission cue="$MissionCue" type="completed"/>
                                <write_to_logbook category="missions" faction="faction.player" title="{30221,805}" text="if player.entity.isfemale then {30221,807} else {30221,806}"/>
                                <signal_cue cue="Ch1_Arrival"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch0_Meet_Dal_Start_Ch1">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_npc_line speaker="$DalBusta" line="30200012" comment="However, that is not a conversation to hold over comms." hidechoices="true" chance="if $PlayerDeclined? then 0 else 100"/>
                <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30200014 else 30200013" comment="Let's meet in person." hidechoices="true" chance="if $PlayerDeclined? then 0 else 100"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="Ch1_Arrival"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Ch1_Arrival" comment="Text IDs 100">
          <!-- 1. Player Talks to Dal in HQ about Split -->
          <!-- 2. Player talks to, then transports Loyalist to FF Space; On Fail: Transport again until the Police Incident plays out -->
          <!-- 3. Police Control Incident; Police stops the Player, may shoot for a bit before the Passenger stops them-->
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <cancel_cue cue="Ch0"/>
          </actions>
          <cues>
            <cue name="Ch1_Dal_Split_HQ">
              <actions>
                <!-- Mission: Infiltrating Split Politics -->
                <create_mission cue="$MissionCue" name="{30221,1001}" faction="faction.player" type="missiontype.plot" abortable="false" group="missiongroup.story_split"
                                difficulty="level.easy" description="{30221,1002}" rewardtext="{30221,1199}"
                                    icon="'briefing_fau_t_nnt_01'" iconcaption="$LoyalistActor.name">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$DalBusta"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing step="1" cue="$MissionCue"/>
                <signal_cue_instantly cue="Ch1_Dal_Split_Intro"/>

              </actions>
            </cue>

            <cue name="Ch1_Dal_Split_Intro">
              <!-- Player asks Dal about the Split in HQ -->
              <!-- SET BRIEFING / CONVERSATION -->
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Add "Story_Split" section to Dal Busta's Dialogs -->
              </actions>
              <cues>
                <cue name="Ch1_Dal_Split_Intro_Dialog" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$DalBusta" conversation="curiosity_got_the_better_of_you"/>
                      <event_conversation_next_section actor="$DalBusta" section="story_split"/>
                    </check_any>
                    <check_value value="Ch2_Study.state != cuestate.complete"/>
                  </conditions>
                  <!-- 3 ways to get here:                  
	                <<ch0_accept>> Gate Event done & player is in the room after "Did curiosity get the better of you?"
                  section story_split choice ch0_accept
	                <<null>> After "What did you discover?" (accepting offer) > "Let's meet in person."
                  section story_split choice null
	                <<null>> After (completing C0) "You found it! Meet me to discuss this"
                  section story_split choice null
                  -->
                  <actions>
                    <!-- Voice Lines -->
                    <do_if value="((event.name == 'event_conversation_next_section') and (event.param2 == null))
                                  or ((event.name == 'event_conversation_started'))">
                      <set_value name="$ShowPlayerChoices" exact="'main'"/>
                      <!-- Gate Event done & player is in the room after "Did curiosity get the better of you?" -->
                      <cancel_cue cue="Story_Offer_At_HQ" comment="cancel 'Did curiosity get the better of you?' .."/>
                      <!-- after "Meet me to discuss this or "Did curiosity get the better of you? > Yes."-->

                      <do_if value="not $DalSaid.indexof.{115}">
                        <append_to_list name="$DalSaid" exact="115"/>
                        <add_npc_line speaker="$DalBusta" hidechoices="true">
                          <text line="30221115" comment="So, here is what I have learned from the Alliance of the Word about the reconnected systems:"/>
                          <text line="30221116" comment="The outcasts and criminals seek safe haven with the Free Families, while the proud families organise under the high Patriarch Zyarth."/>
                          <text line="30221117" comment="The patriarchal court(translate as royal court, not judicial) is quite aloof and too isolated to interfere."/>
                          <text line="30221118" comment="A lot of well connected parties try to influence politics there and as political outsiders we won't stand a chance."/>
                          <text line="30221119" comment="The Free Families, however, are a messy bunch." delay="0.8s"/>
                          <text line="30221120" comment="Political structures here are quite obscure, but they also are not as established."/>
                          <text line="30221121" comment="Nevertheless, they are a formidable force, and could turn the tide for the Split." delay="0.2s"/>
                          <text line="30221122" comment="This is why we need to establish better connections there, to learn how to use the political situation for our benefit." delay="0.4s"/>
                        </add_npc_line>
                        <do_if value="player.entity.race != race.split">
                          <add_npc_line speaker="$DalBusta" hidechoices="true">
                            <text line="30221174" comment="It won't be easy." delay="0.8s"/>
                            <text line="30221175" comment="From what I gathered, most Split are not particularly keen on working with outsiders."/>
                          </add_npc_line>
                        </do_if>
                      </do_if>
                    </do_if>
                    <do_elseif value="(event.name == 'event_conversation_next_section') and (event.param2 == 'ch1_main')">
                      <set_value name="$ShowPlayerChoices" exact="'main'"/>
                    </do_elseif>
                    <do_elseif value="(event.name == 'event_conversation_next_section') and (event.param2 == 'ch1_1_factions')">
                      <set_value name="$ShowPlayerChoices" exact="'main'"/>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="if $AffiliationPatriarchy then 30221170 else 30221169" comment="The most important event in recent Split history was the battle at the Fires of ..."/>
                        <text line="30221171" comment="With this decisive battle, the Zyarth Patriarchy subdued a coalition of Free Families." delay="0.5s"/>
                        <text line="30221177" comment="The Patriarchy has already established a court and their own police force within Free Families space." delay="0.5s"/>
                      </add_npc_line>
                      <do_if value="$AffiliationPatriarchy or $AffiliationFF">
                        <add_npc_line speaker="$DalBusta" hidechoices="true">
                          <text line="if player.entity.isfemale then 30221173 else 30221172" comment="As I understand it, you witnessed this historical event first hand?"/>
                        </add_npc_line>
                        <set_value name="$ShowPlayerChoices" exact="'split'"/>
                      </do_if>
                    </do_elseif>
                    <do_elseif value="(event.name == 'event_conversation_next_section')
                               and ((event.param2 == 'ch1_1a_affiliationFF') or (event.param2 == 'ch1_1b_affiliationZY'))">
                      <set_value name="$ShowPlayerChoices" exact="'main'"/>
                      <do_if value="$AffiliationFF" comment="(Player Choice)I valiantly fought Zyarth Tyranny!">
                        <add_npc_line speaker="$DalBusta" hidechoices="true">
                          <text line="if player.entity.isfemale then 30221106 else 30221105" comment="... who are invading to enrich themselves on your economy and purge your identity, right."/>
                          <text line="if player.entity.isfemale then 30221108 else 30221107" comment="Still, bearing in mind the Fires of Defeat fiasco, and with the political situation in Free Families space in limbo, your standing is not too high."/>
                        </add_npc_line>
                      </do_if>
                      <do_elseif value="$AffiliationPatriarchy" comment="(Player Choice)The Patriarchy brings civilisation...">
                        <add_npc_line speaker="$DalBusta" hidechoices="true">
                          <text line="30221109" comment="... granting all Split, outcasts, exiles and cursed ones, a way out of the slums and back into society."/>
                          <text line="30221110" comment="I heard their broadcast."/>
                          <text line="if player.entity.isfemale then 30221112 else 30221111" comment="Still, coming from the Patriarchy you are not very popular in Fallen Families territory."/>
                        </add_npc_line>
                      </do_elseif>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="if player.entity.isfemale then 30221114 else 30221113" comment="Vanishingly few Split there would want to work with you, which is what we need to change."/>
                      </add_npc_line>
                    </do_elseif>
                    <do_elseif value="(event.name == 'event_conversation_next_section') and (event.param2 == 'ch1_2_plan')" comment="What's your Plan?">
                      <set_value name="$ShowPlayerChoices" exact="'main'"/>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30221123" comment="I'll take a ship to their Trade Station to learn more about the intricacies of their economy." delay="0.5s"/>
                        <text line="30221124" comment="Boso will help me work through their data." delay="0.5s"/>
                      </add_npc_line>
                      <add_npc_line speaker="$BosoTa" hidechoices="true">
                        <text line="30221102" comment="I must say, I am quite curious on what can be deducted from reading company registrations and financial movements."/>
                      </add_npc_line>
                    </do_elseif>
                    <do_elseif value="(event.name == 'event_conversation_next_section') and (event.param2 == 'ch1_3_task')" comment="What can I do?">
                      <set_value name="$ShowPlayerChoices" exact="'task'"/>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30221125" comment="With the reconnection of the gates, there are still some Split who are concluding their businesses here in order to return to their families and culture."/>
                        <text line="if player.entity.isfemale then 30221127 else 30221126" comment="In order to learn more about them, you should offer your ship as a means of transport."/>
                      </add_npc_line>
                    </do_elseif>
                    <do_elseif value="(event.name == 'event_conversation_next_section') and ((event.param2 == 'ch1_4a_ferry') or (event.param2 == 'ch1_4b_good'))">
                      <set_value name="$ShowPlayerChoices" exact="'main'"/>
                      <set_value name="$TaskDone"/>
                      <do_if value="event.param2 == 'ch1_4a_ferry'">
                        <add_npc_line speaker="$DalBusta" hidechoices="true">
                          <text line="30221128" comment="Of course not!"/>
                        </add_npc_line>
                      </do_if>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30221129" comment="I have found one Split in particular who, I suspect, is well connected with either the Free Families or the Patriarchy Occupation there."/>
                        <text line="30221130" comment="He aroused some suspicion."/>
                        <text line="30221131" comment="Apparently he makes the trip regularly under different names, so he could be some sort of smuggler who potentially has ties to the other side."/>
                        <text line="if player.entity.isfemale then 30221133 else 30221132" comment="You should help him out to learn more about him; maybe befriend him in order to make him share his connections."/>
                      </add_npc_line>
                      <add_npc_line speaker="$BosoTa" hidechoices="true">
                        <text line="if player.entity.isfemale then 30221104 else 30221103" comment="Be careful to not accidentally join his unlawful smuggling operation while transporting him."/>
                      </add_npc_line>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30221134" comment="That's all I have for you at the moment."/>
                      </add_npc_line>
                      <append_to_list name="$BosoSaid" exact="30221103"/>
                    </do_elseif>
                    <do_elseif value="(event.name == 'event_conversation_next_section') and (event.param2 == 'ch1_5_ready')">
                      <set_value name="$ShowPlayerChoices" exact="'ready'"/>
                      <add_npc_line speaker="$DalBusta" hidechoices="true">
                        <text line="30221176" comment="He requests to be transported in an S-sized ship."/>
                        <text line="if player.entity.isfemale then 30221136 else 30221135" comment="I will update you on his position as soon as I know more."/>
                      </add_npc_line>
                    </do_elseif>

                    <!-- (Back) out of Player Choices -->
                    <do_if value="($ShowPlayerChoices == 'task') or ($ShowPlayerChoices == 'split')" comment="Back to Split tier 1">
                      <add_player_choice section="story_split" choiceparam="'ch1_main'" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                    </do_if>
                    <do_elseif value="$ShowPlayerChoices == 'ready'">
                      <!-- Do nothing, seeing only back is weird -->
                    </do_elseif>
                    <do_else comment="Back out of Split Story completely">
                      <add_player_choice section="stories" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                    </do_else>
                    <!-- Player Choices -->
                    <do_if value="$ShowPlayerChoices == 'main'">
                      <add_player_choice section="story_split" choiceparam="'ch1_1_factions'"        highlighted="false" text="{30221,1052}" comment="What did you learn about the factions?"/>
                      <add_player_choice section="story_split" choiceparam="'ch1_2_plan'"            highlighted="false" text="{30221,1055}" comment="What's your plan?"/>
                      <add_player_choice section="story_split" choiceparam="'ch1_3_task'"            highlighted="not ($TaskDone? and (not $TaskOffered?))" text="{30221,1056}" comment="What can I do?"/>
                      <do_if value="$TaskDone? and (not $TaskOffered?)">
                        <add_player_choice section="story_split" choiceparam="'ch1_5_ready'"           highlighted="true" text="{30221,1059}" comment="I'm ready."/>
                      </do_if>
                    </do_if>
                    <do_elseif value="$ShowPlayerChoices == 'split'">
                      <add_player_choice section="story_split" choiceparam="'ch1_1a_affiliationFF'"  highlighted="false" text="{30221,1053}" comment="I valiantly fought Zyarth Tyranny!"/>
                      <add_player_choice section="story_split" choiceparam="'ch1_1b_affiliationZY'"  highlighted="false" text="{30221,1054}" comment="The Patriarchy brings civilisation, ..."/>
                    </do_elseif>
                    <do_elseif value="$ShowPlayerChoices == 'task'">
                      <add_player_choice section="story_split" choiceparam="'ch1_4a_ferry'"          highlighted="false" text="{30221,1057}" comment="Ferry random Split to make friends?"/>
                      <add_player_choice section="story_split" choiceparam="'ch1_4b_good'"           highlighted="false" text="{30221,1058}" comment="Sounds good to me."/>
                    </do_elseif>
                    <do_elseif value="($ShowPlayerChoices == 'ready') and (not $TaskOffered?)">
                      <set_value name="$TaskOffered"/>
                      <signal_cue cue="Ch1_Suspicious_Split"/>
                      <!-- Mission: Suspicious Split -->
                      <update_mission cue="$MissionCue" abortable="false" description="if player.entity.isfemale then ({30221,1103} + '\n\n' + {30221,1105}) else ({30221,1102} + '\n\n' + {30221,1104})"
                                      type="missiontype.plot" name="{30221,1101}" faction="faction.player" difficulty="level.easy"
                                      rewardtext="{30221,1199}">
                        <briefing>
                          <!-- maybe add "objective.find" followed by .attack -->
                          <objective step="1"       action="objective.embark"             text="{30221,1121}" comment="S-Sized Ship"/>
                          <objective step="2"       action="objective.talkto"             text="{30221,151}"  comment="Suspicious Split"/>
                          <objective step="3"       action="objective.transport"          text="{30221,151}"  comment="Suspicious Split"/>
                        </briefing>
                      </update_mission>
                      <set_objective_from_briefing step="1" cue="$MissionCue"/>
                    </do_elseif>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Suspicious_Split">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <cancel_cue cue="Ch1_Dal_Split_Intro_Dialog"/>
                <set_value name="$NPCPassenger"         exact="$LoyalistActor"/>
                <set_value name="$PassengerShip"        exact="null"/>
                <set_value name="$NPCPassengerTemplate" exact="$LoyalistActor.npctemplate"/>

                <!-- Loyalist Conversation Variables -->
                <set_value name="$LoyalistAngryness" exact="0"/>
                <set_value name="$LoyalistVerdict" exact="0"/>
                <set_value name="$LoyalistChoicesCount" exact="0"/>
                <set_value name="$LoyalistAskingAgainWeight" exact="0"/>
              </actions>
              <cues>

                <cue name="Ch1_Story_Reminder_Talk" checkinterval="1s" onfail="cancel">
                  <conditions>
                    <check_value value="Ch1_Loyalist_Dialog_Topics.state == cuestate.waiting"/>
                  </conditions>
                  <cues>
                    <cue name="Ch1_Story_Reminder_Talk_v2_Ref" ref="md.Story_Paranid.Story_Reminder">
                      <param name="Actor"       value="$DalBusta"/>
                      <param name="CutsceneKey" value="$DalCutsceneKey"/>
                      <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30200106 else 30200105]]"/>
                      <param name="CancelCue"   value="Ch1_Loyalist_Dialog_Topics"/>
                      <param name="Delay"       value="20min"/>
                      <!--  <t id="30200001">Hey there partner.</t>
                                <t id="30200002">(spoken to female player){10111,30200001}</t>
                                <t id="30200105">Don't keep our contact waiting for too long.</t>
                                <t id="30200106">(spoken to female player){,30200105}</t>
                                <t id="30200107">Where have you wandered off to?</t>
                                <t id="30200108">(spoken to female player 'you'){,30200107}</t>    -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Suspicious_Split_Intel">
                  <cues>
                    <cue name="Ch1_Suspicious_Split_Intel_Left_Station" checkinterval="15s">
                      <conditions>
                        <check_any>
                          <check_value value="player.station != $DalBusta.station"/>
                          <check_value value="player.ship != $DalBusta.ship"/>
                        </check_any>
                      </conditions>
                      <cues>

                        <cue name="Ch1_Suspicious_Init">
                          <actions>
                            <set_value name="$PickupContainer"      exact="null"/>
                            <set_value name="$TargetContainer"      exact="null"/>
                            <signal_cue cue="Ch1_Suspicious_Set_Stations"/>
                            <set_value name="$RetrySettingStationsDelay" exact="61s"/>
                          </actions>
                        </cue>

                        <cue name="Ch1_Suspicious_Set_Stations_Failed" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="$RetrySettingStationsDelay"/>
                          <actions>
                            <!-- failure might indicate an odd universe state, so check less often as it's expensive -->
                            <set_value name="$RetrySettingStationsDelay" exact="61s" operation="add"/>
                            <set_value name="$RetrySettingStationsDelay" exact="[$RetrySettingStationsDelay, 613s].min"/>
                            <set_value name="$PickupContainer"      exact="null"/>
                            <set_value name="$TargetContainer"      exact="null"/>
                            <signal_cue cue="Ch1_Suspicious_Set_Stations"/>
                          </actions>
                        </cue>

                        <cue name="Ch1_Suspicious_Set_Stations">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_all exact="1" comment="handling break cases">

                              <create_list name="$GatesToFriendlySplitSpace"/>
                              <do_for_each in="$GatesToSplitSpace" name="$g">
                                <do_if value="$g.exit.sector.owner.relationto.{faction.player} ge (faction.player.relation.dock.min + 0.001)">
                                  <append_to_list name="$GatesToFriendlySplitSpace" exact="$g"/>
                                </do_if>
                              </do_for_each>

                              <!-- Find the closest gate to DLC Split Space -->
                              <set_value name="$DistanceFrom"     exact="player.entity"/>
                              <set_value name="$DistanceToList"   exact="if $GatesToFriendlySplitSpace.count
                                                                     then $GatesToFriendlySplitSpace else $GatesToSplitSpace"/>
                              <set_value name="$UselocalHighways" exact="true"/>
                              <run_actions ref="md.LIB_Generic.FindNearestObjectFromList" result="$NearestObjectsList">
                                <param name="DistanceFrom"                 value="$DistanceFrom"/>
                                <param name="DistanceToList"               value="$DistanceToList"/>
                                <param name="UselocalHighways"             value="$UselocalHighways"/>
                              </run_actions>
                              <do_if value="(not $NearestObjectsList.{1}.count) or (not $NearestObjectsList.{2})" comment="empty/null if there is no path from player to target (disconnected sector)">
                                <signal_cue cue="Ch1_Suspicious_Set_Stations_Failed"/>
                                <reset_cue cue="this"/>
                                <break/>
                              </do_if>

                              <set_value name="$TargetGate"       exact="$NearestObjectsList.{2}"/>

                              <!-- Find all sectors on the way there -->
                              <get_global_path multiple="true" component="$pathComponents" uselocalhighways="true">
                                <start object="$DistanceFrom"/>
                                <end object="$TargetGate"/>
                              </get_global_path>
                              <do_if value="not $pathComponents.count" comment="empty if there is no path from player to target (disconnected sector)">
                                <signal_cue cue="Ch1_Suspicious_Set_Stations_Failed"/>
                                <reset_cue cue="this"/>
                                <break/>
                              </do_if>
                              <create_list name="$SectorsAlongTheWay"/>
                              <do_for_each in="$pathComponents" name="$component">
                                <do_if value="not $component.isclass.{class.highway}">
                                  <do_if value="not $SectorsAlongTheWay.indexof.{$component.sector}">
                                    <do_if value="$BaseSectors.indexof.{$component.sector}" comment="Pickup Split in a BaseSector">
                                      <append_to_list name="$SectorsAlongTheWay" exact="$component.sector"/>
                                    </do_if>
                                  </do_if>
                                </do_if>
                              </do_for_each>

                              <assert value="$SectorsAlongTheWay.count" text="'@Heinrich - List should have at least the $TargetGate sector in it. [Ch1]'"/>
                              <set_value name="$CenterSectorID" exact="[($SectorsAlongTheWay.count / 2)i, 1].max"/>
                              <set_value name="$PreferredSector" exact="$SectorsAlongTheWay.{$CenterSectorID}"/>
                              <find_station name="$PossiblePickupContainers" space="$PreferredSector" multiple="true" tradestation="false">
                                <match_dock walkable="true"/>
                                <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                              </find_station>

                              <!-- Failed to find a station in the preferred sector-->
                              <do_if value="not $PossiblePickupContainers.count">
                                <!-- try all others en route, preferably close to the center one -->
                                <set_value name="$SectorsAlongTheWaySorted" exact="[]"/>
                                <do_all exact="$CenterSectorID + 1" counter="$i" comment="+1 due to possible int casting round down">
                                  <do_if value="($CenterSectorID + $i) le $SectorsAlongTheWay.count">
                                    <append_to_list name="$SectorsAlongTheWaySorted" exact="$SectorsAlongTheWay.{$CenterSectorID + $i}"/>
                                    <!-- Sectors from CenterSector to TargetSector -->
                                  </do_if>
                                  <do_if value="($CenterSectorID - $i) ge 1">
                                    <append_to_list name="$SectorsAlongTheWaySorted" exact="$SectorsAlongTheWay.{$CenterSectorID - $i}"/>
                                    <!-- Sectors from CenterSector to StartSector -->
                                  </do_if>
                                </do_all>

                                <do_for_each in="$SectorsAlongTheWaySorted" name="$s">
                                  <find_station name="$PossiblePickupContainers" space="$s" multiple="true" tradestation="false">
                                    <match_dock walkable="true"/>
                                    <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                                  </find_station>
                                  <do_if value="$PossiblePickupContainers.count">
                                    <break/>
                                  </do_if>
                                </do_for_each>

                                <do_if value="not $PossiblePickupContainers.count">
                                  <!-- None of the preferred sectors had a suitable station, we now expensively search the galaxy -->
                                  <find_station name="$PossiblePickupContainers" space="player.galaxy" multiple="true" sortbygatedistanceto="player.entity">
                                    <match_dock walkable="true"/>
                                    <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                                  </find_station>
                                </do_if>
                                <!-- Failsafe if we failed to find a station in the preferred sector -->
                              </do_if>

                              <!-- Find the $PossiblePickupContainer with the shortest route from Start to Target -->
                              <set_value name="$DistanceFrom"     exact="player.entity"/>
                              <set_value name="$DistanceToList"   exact="$PossiblePickupContainers"/>
                              <set_value name="$UselocalHighways" exact="true"/>
                              <run_actions ref="md.LIB_Generic.FindNearestObjectFromList" result="$NearestObjectsList">
                                <param name="DistanceFrom"                 value="$DistanceFrom"/>
                                <param name="DistanceToList"               value="$DistanceToList"/>
                                <param name="UselocalHighways"             value="$UselocalHighways"/>
                              </run_actions>
                              <do_if value="(not $NearestObjectsList.{1}.count) or (not $NearestObjectsList.{2})" comment="empty/null if there is no path from player to target (disconnected sector)">
                                <signal_cue cue="Ch1_Suspicious_Set_Stations_Failed"/>
                                <reset_cue cue="this"/>
                                <break/>
                              </do_if>
                              <set_value name="$ObjectsByDistanceToPlayer"  exact="$NearestObjectsList.{3}"/>
                              <set_value name="$DistanceFrom"     exact="$TargetGate"/>
                              <set_value name="$DistanceToList"   exact="$PossiblePickupContainers"/>
                              <set_value name="$UselocalHighways" exact="true"/>
                              <run_actions ref="md.LIB_Generic.FindNearestObjectFromList" result="$NearestObjectsList">
                                <param name="DistanceFrom"                 value="$DistanceFrom"/>
                                <param name="DistanceToList"               value="$DistanceToList"/>
                                <param name="UselocalHighways"             value="$UselocalHighways"/>
                              </run_actions>
                              <do_if value="(not $NearestObjectsList.{1}.count) or (not $NearestObjectsList.{2})" comment="empty if there is no path from player to target (disconnected sector)">
                                <signal_cue cue="Ch1_Suspicious_Set_Stations_Failed"/>
                                <reset_cue cue="this"/>
                                <break/>
                              </do_if>
                              <set_value name="$ObjectsByDistanceToTargetGate"  exact="$NearestObjectsList.{3}"/>

                              <set_value name="$ObjectsByDistanceTotal" exact="table[]"/>
                              <do_for_each in="$ObjectsByDistanceToPlayer" name="$key">
                                <set_value name="$ObjectsByDistanceTotal.{$key}" exact="$ObjectsByDistanceToPlayer.{$key} + $ObjectsByDistanceToTargetGate.{$key}"/>
                              </do_for_each>
                              <set_value name="$ObjectsByDistanceTotalSorted" exact="$ObjectsByDistanceTotal.keys.sorted"/>
                              <remove_value name="$ObjectsByDistanceToPlayer"/>
                              <remove_value name="$ObjectsByDistanceToTargetGate"/>
                              <remove_value name="$ObjectsByDistanceTotal"/>

                              <set_value name="$PickupContainer"      exact="$ObjectsByDistanceTotalSorted.{1}"/>

                              <do_if value="$PickupContainer.exists">
                                <!-- Ideally find any station behind the Target Gate -->
                                <set_value name="$PreferredSector" exact="$TargetGate.exit.sector"/>
                                <!--<assert value="$SplitSectors.indexof.{$PreferredSector}" text="'@Heinrich - Target Sector is not a Split DLC Sector'"/>-->
                                <!-- TODO @Heinrich why did this fire? PickupContainer in Unholy Retribution -->
                                <find_station space="$PreferredSector" name="$TargetContainer" tradestation="false">
                                  <match_dock walkable="true"/>
                                  <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                                  <match trueowner="[faction.argon,faction.antigone]" negate="true"/>
                                </find_station>

                                <!-- We failed to find a station -->
                                <do_if value="not $TargetContainer.exists">
                                  <find_station space="player.galaxy" name="$PossibleTargetContainers" multiple="true" sortbygatedistanceto="player.entity">
                                    <match_dock walkable="true"/>
                                    <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                                  </find_station>
                                  <do_for_each in="$PossibleTargetContainers" name="$c">
                                    <do_if value="$SplitSectors.indexof.{$c.sector}">
                                      <set_value name="$TargetContainer" exact="$c"/>
                                      <break/>
                                    </do_if>
                                  </do_for_each>
                                </do_if>
                              </do_if>

                              <!-- DONE setting stations -->
                              <do_if value="$PickupContainer.exists and $TargetContainer.exists">
                                <set_value name="$TargetContainerSector" exact="$TargetContainer.sector"/>
                                <set_value name="$TargetContainerName" exact="$TargetContainer.knownname" comment="saving as a fake objective target in case the station gets destroyed"/>
                                <do_if value="not (Ch1_Suspicious_Stations_Set.state == cuestate.complete)">
                                  <!-- First Time Speech-->
                                  <signal_cue cue="Ch1_Suspicious_Stations_Set"/>
                                </do_if>
                                <do_else>
                                  <!-- Contingency Success Speech "~we found him again" -->
                                  <signal_cue cue="Ch1_Suspicious_Stations_Set_Contingency"/>
                                </do_else>
                              </do_if>
                              <do_else>
                                <debug_text text="'Failed Picking Stations - PC: ' + $PickupContainer + ' TC: ' + $TargetContainer" chance="$DebugChance"/>
                                <!-- Try again later -->
                                <signal_cue cue="Ch1_Suspicious_Set_Stations_Failed"/>
                              </do_else>
                              <reset_cue cue="this"/>
                            </do_all>
                          </actions>
                        </cue>

                        <cue name="Ch1_Passenger_Transport_Contingency">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch1_Passenger_Transport_Check_Object" onfail ="cancel">
                              <conditions>
                                <!--Check cuestate as this cue was added in a patch and this cue branch may still be active-->
                                <check_value value="Ch1_Police_Control_Event.state == cuestate.disabled or Ch1_Police_Control_Event.state == cuestate.waiting"/>
                              </conditions>
                              <actions>
                                <do_if value="$PickupContainer.isoperational">
                                  <!--Set the $PickupContainer to invincible-->
                                  <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                                    <param name="Object" value="$PickupContainer"/>
                                    <param name="RequesterCue" value="namespace"/>
                                    <param name="ReachedThresholdSignalCue" value="Ch1_Passenger_Transport_Rescue_Actor"/>
                                    <param name="DebugChance" value="$DebugChance"/>
                                  </run_actions>
                                </do_if>
                                <do_else>
                                  <debug_text text="'Station lost'" chance="$DebugChance"/>
                                  <signal_cue cue="Ch1_Passenger_Transport_Failed_Restart"/>
                                </do_else>
                              </actions>
                            </cue>
                            <cue name="Ch1_Passenger_Transport_Rescue_Actor">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <!--Disconnect the actor from the object and make the object vulnerable again-->
                                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $LoyalistActor,
                                                      table[
                                                      $requestercue = namespace,
                                                      $location = 'disconnect',
                                                      $priority = 100,
                                                      $debugchance = $DeepDebugChance,
                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                      ]"/>
                                <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                                  <param name="Object" value="$PickupContainer"/>
                                  <param name="RequesterCue" value="namespace"/>
                                  <param name="DebugChance" value="$DebugChance"/>
                                </run_actions>

                                <signal_cue cue="Ch1_Passenger_Transport_Station_Destroyed"/>
                              </actions>
                            </cue>

                            <cue name="Debug_Destroy_PickupContainer">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <debug_text text="this"/>
                                <destroy_object object="$PickupContainer"/>
                              </actions>
                            </cue>

                            <cue name="Ch1_Passenger_Transport_Station_Destroyed_Init" version="2">
                              <!-- Apparently the station can be 0x0 at this point already and won't be caught by event_object_destroyed x -->
                              <actions>
                                <do_if value="not $PickupContainer.exists">
                                  <signal_cue cue="Ch1_Passenger_Transport_Station_Destroyed"/>
                                </do_if>
                              </actions>
                              <patch sinceversion="2">
                                <reset_cue cue="this"/>
                              </patch>
                            </cue>

                            <cue name="Ch1_Passenger_Transport_Station_Destroyed">
                              <conditions>
                                <check_any>
                                  <check_all>
                                    <event_object_destroyed object="$PickupContainer"/>
                                    <check_value value="not $LoyalistActor.ship" comment="on a station or disconnected"/>
                                  </check_all>
                                  <event_cue_signalled/>
                                </check_any>
                              </conditions>
                              <actions>
                                <signal_cue_instantly cue="Ch1_Passenger_Transport_Loyalist_Ref" param="'passenger_is_lost'"/>
                              </actions>
                              <delay exact="1s"/>
                              <actions>
                                <reset_cue cue="Ch1_Passenger_Transport_Loyalist"/>
                              </actions>
                              <cues>
                                <cue name="Ch1_Speak_Dal_150_Station_Destroyed_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$DalBusta"/>
                                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                  <param name="Lines"             value="[[30221150], [30221151], [30221152]]"/>
                                  <!-- <t id="30221150">The station is gone, so it looks like we lost our Split smuggler.</t>
                          <t id="30221151">I'll try and find more intel on the Split.</t>
                          <t id="30221152">We need to start making connections there.</t>-->
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="Ch1_Passenger_Transport_Failed_Restart"/>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch1_Passenger_Died">
                              <conditions>
                                <check_any>
                                  <event_object_destroyed object="$LoyalistActor"/>
                                  <event_cue_signalled/>
                                </check_any>
                                <check_value value="Ch2_Study.state == cuestate.waiting"/>
                              </conditions>
                              <actions>
                                <reset_cue cue="Ch1_Passenger_Transport_Loyalist"/>
                              </actions>
                              <cues>
                                <cue name="Ch1_Speak_Dal_Unexpected_Loyalist_Destroyed_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$DalBusta"/>
                                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                  <param name="Lines"             value="[[30220605], [[30202130],[30220606],[30220607]].random , [30221151], [30221152]]"/>
                                  <!--                        
                          <t id="30220605">Oh no.</t>
                          Random One Of Those: <t id="30202130">That could have gone better.</t>
                          Random One Of Those: <t id="30220606">I wasn't expecting that.</t>
                          Random One Of Those: <t id="30220607">Well, that was unexpected.</t>                         
                          <t id="30221151">I'll try and find more intel on the Split.</t>
                          <t id="30221152">We need to start making connections there.</t>-->
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="Ch1_Passenger_Transport_Failed_Restart"/>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch1_Passenger_Transport_Failed_Restart">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <reset_cue cue="Ch1_Passenger_Transport_Loyalist"/>
                                <signal_cue cue="Ch1_Suspicious_Set_Stations"/>
                                <!-- Revive Loyalist Actor? -->
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch1_Suspicious_Stations_Set">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch1_Speak_Dal_141_Transmitting_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30221141],
                                                                      [30221142]]"/>
                              <param name="EndSignalCue"      value="Ch1_Passenger_Transport_Loyalist"/>
                              <!-- 
                                  <t id="30221141">I've got a lock on his current location.</t>
                                  <t id="30221142">Transmitting data now.</t>-->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch1_Suspicious_Stations_Set_Contingency">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch1_Speak_Dal_Back_Routine_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"                 value="$DalBusta"/>
                              <param name="CutsceneKey"           value="$DalCutsceneKey"/>
                              <param name="Lines"                 value="[[30221153], [if ([1,1,2].random == 1) then 30221154 else 30221156]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"          value="Ch1_Suspicious_Stations_Set_Contingency_Reset"/>
                              <!-- Contingency Lines 
                                           <t id="30221153">I've got an update on the suspicious Split.</t>
                                           <t id="30221154">Apparently he escaped the blast and is again requesting transport into Split space.</t>
                                  not used <t id="30221155">He's assumed yet another different identity too.</t>
                                           <t id="30221156">Apparently he survived and is back to his routine.</t>
                               -->
                            </cue>
                            <cue name="Ch1_Suspicious_Stations_Set_Contingency_Reset">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <reset_cue cue="parent"/>
                                <signal_cue cue="Ch1_Passenger_Transport_Loyalist"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Passenger_Transport_Loyalist">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Ch1_Passenger_Transport_Contingency"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $LoyalistActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $PickupContainer,
                                                                                                      $slottags = [tag.npc_generic],
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <set_objective_from_briefing cue="$MissionCue" step="1" comment="required to properly recover from a null actor guidance (stopped at the transporter)"/>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue cue="Ch1_Passenger_Transport_Contingency"/>
                  </actions>
                  <cues>
                    <cue name="Ch1_Suspicious_ReachedSector_Ref" ref="md.LIB_Generic.ReachedSector">
                      <param name="TargetSector" value="$PickupContainer.sector"/>
                      <param name="SuccessSignalCue" value="Ch1_Suspicious_Warning"/>
                    </cue>
                    <cue name="Ch1_Suspicious_Warning">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="player.entity.race == race.paranid">
                          <set_value name="$Line" exact="if player.entity.isfemale then 30221146 else 30221145"/>
                        </do_if>
                        <do_else>
                          <set_value name="$Line" exact="if player.entity.isfemale then 30221144 else 30221143"/>
                        </do_else>

                        <do_if value="not $BosoSaid.indexof.{30221103}">
                          <set_value name="$BosoLine" exact="if player.entity.isfemale then 30221104 else 30221103"/>
                        </do_if>
                        <do_else>
                          <set_value name="$BosoLine" exact="30221321"/>
                        </do_else>

                      </actions>
                      <cues>
                        <cue name="Ch1_Speak_Dal_143_Warning_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$DalBusta, $BosoTa, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey]"/>
                          <param name="Lines"             value="[[[$Line]],
                                                                      [[$BosoLine]],
                                                                      [[if player.entity.isfemale then 30221149 else 30221148]]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                        </cue>
                      </cues>
                      <!--
                         DAL:  <t id="30221143">Remember, he is kind of fishy, so be on your toes.</t>
                               <t id="30221144">(spoken to female "your"){,30221143}</t>
                               <t id="30221145">Remember, he is kind of fishy, so use all of your brains.</t>
                               <t id="30221146">(spoken to female 'you'){,30221145}</t>
                         BOSO:  <t id="30221321">*** Squeaking Noise of Worry and Discontent ***</t>                       
                        <text line="if player.entity.isfemale then 30221104 else 30221103" comment="Be careful to not accidentally join his unlawful smuggling operation while transporting him."/>
                         DAL:  <t id="30221148">Also we are trying to befriend him, so try not to make him feel uncomfortable.</t>
                               <t id="30221149">(spoken to female 'you'){,30221148}</t>
                           -->
                    </cue>
                    <cue name="Ch1_Passenger_Transport_Loyalist_Ref" ref="md.RML_Transport_Passengers_V2.TransportPassengers_V2">
                      <param name="EndSignalCue"    value="Ch1_Passenger_Transport_Loyalist_End"/>
                      <param name="MissionCue"      value="$MissionCue"/>
                      <param name="DebugChance"     value="$DeepDebugChance"/>

                      <param name="StartObject"     value="$PickupContainer"  comment="Object to place the NPC on"/>
                      <param name="DropOff"         value="false"/>
                      <param name="Destination"     value="$TargetContainer"  comment="Destination object to drop off the passenger"/>
                      <param name="Passenger"       value="$NPCPassenger"/>
                      <param name="PlaceNPC"        value="false" comment="RML_Transport_Passengers_V2 cannot handle NPCPlacement without rooms (e.g. on ships), so we place the NPC"/>

                      <param name="StartStep"       value="1"  comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"  value="true"        comment="Update the briefing objective step when the objective is updated"/>
                    </cue>

                    <cue name="Ch1_Loyalist_Dialog_Topics" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_started actor="$LoyalistActor"/>
                          <event_conversation_next_section actor="$LoyalistActor" section="ch1_loyalist"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="event.name == 'event_conversation_started'">
                          <set_value name="$ShowPlayerChoices" exact="0"/>
                          <set_value name="$NPCPassenger.$PassengerConvHandlerExists" exact="true" comment="Validation blackboard variable so the RML can know something is looking after the conversation."/>
                          <add_npc_line line="2002" comment="(Greeting - neutral) @Heinrich Update on Voice Updates" />
                          <set_value name="$MissionDescription" exact="if player.entity.isfemale then {30221,1103} else {30221,1102}"/>
                          <update_mission cue="$MissionCue" description="$MissionDescription" rewardtext="{30221,1199}">
                            <briefing>
                              <objective step="1"       action="objective.talkto"    text="$NPCPassenger.knownname"/>
                              <objective step="2"       action="objective.transport" text="$NPCPassenger.knownname + ' ' + {30221,1170}"/>
                            </briefing>
                          </update_mission>

                          <do_if value="not $LoyalistActor.ship" comment="either on station or disconnected">
                            <add_player_choice text="{30221,1151}" position="bottom_left" section="ch1_loyalist" choiceparam="'ch1_0_greeting'" comment="(Player Choice)Greetings! I will be your transport.(addressing male Split)"/>
                          </do_if>
                          <add_player_choice text="{1002,2}" position="bottom_right" section="g_finish" comment="Goodbye"/>
                        </do_if>
                        <do_else>
                          <!-- next_section -->
                          <do_if value="event.param2 == 'ch1_0_greeting'">
                            <set_value name="$ShowPlayerChoices" exact="'ch1_0_greeting'"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221101" comment="Wonderful."/>
                              <text line="30221102" comment="Split going to meet kin!"/>
                            </add_npc_line>
                          </do_if>
                          <do_elseif value="event.param2 == 'ch1_0_topics_init'">
                            <set_value name="$ShowPlayerChoices" exact="'ch1_0_topics'"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221103" comment="Right."/>
                              <text line="if player.entity.isfemale then 30221105 else 30221104" comment="Split can humour you with some stories."/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_0_topics'">
                            <set_value name="$ShowPlayerChoices" exact="'ch1_0_topics'"/>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_1_zyarth'">
                            <set_value name="$ShowPlayerChoices" exact="'ch1_1_zyarth'"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221108" comment="Patriarchal Split are traditional."/>
                              <text line="30221109" comment="Politics follow Thuruk's way."/>
                              <text line="30221110" comment="Zyarth, Patriarch of all Split, unites all lesser patriarchs under his rule."/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_1_1_patriarch'">
                            <append_to_list name="$LoyalistSaid" exact="'ch1_sec1_1'"/>
                            <set_value name="$ShowPlayerChoices" exact="'ch1_1_zyarth'"/>
                            <set_value name="$LoyalistVerdict" exact="1" operation="add"/>
                            <set_value name="$LoyalistChoicesCount" exact="1" operation="add"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221111" comment="The Patriarch is a survivalist, always on the move."/>
                              <text line="30221112" comment="He made a name for himself fighting Xenon invaders."/>
                              <text line="30221113" comment="The Zyarth family was thriving in the outer reaches."/>
                              <text line="30221114" comment="Then Patriarch Rhonkar failed to keep the empire together."/>
                              <text line="30221115" comment="Zyarth stepped in to prevent the great families from drifting apart."/>
                              <text line="30221116" comment="After the gate realignments, he had outlived all of his former competitors."/>
                              <text line="30221117" comment="And now there is barely a Split alive who would remember another Patriarch on the throne."/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_1_2_stability'">
                            <append_to_list name="$LoyalistSaid" exact="'ch1_sec1_2'"/>
                            <set_value name="$ShowPlayerChoices" exact="'ch1_1_zyarth'"/>
                            <set_value name="$LoyalistVerdict" exact="1" operation="subtract"/>
                            <set_value name="$LoyalistAngryness" exact="1" operation="subtract"/>
                            <set_value name="$LoyalistChoicesCount" exact="1" operation="add"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221118" comment="Given how long he has reign, do not expect him to be gone anytime soon."/>
                            </add_npc_line>
                            <add_npc_line speaker="$DalBusta" hidechoices="true">
                              <text line="if player.entity.isfemale then 30221158 else 30221157" comment="By Boso, don't question the future of what could be his government!"/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_2_families'">
                            <set_value name="$ShowPlayerChoices" exact="'ch1_2_families'"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221119" comment="Outcasts, exiles and cursed ones such as Family Tkr."/>
                              <text line="30221120" comment="It is more a slum than an economy, really."/>
                              <text line="30221121" comment="But some pride themselves on being free from imperial rule."/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_2_1_tkr'">
                            <append_to_list name="$LoyalistSaid" exact="'ch1_sec2_1'"/>
                            <set_value name="$ShowPlayerChoices" exact="'ch1_2_families'"/>
                            <set_value name="$LoyalistVerdict" exact="1" operation="add"/>
                            <set_value name="$LoyalistChoicesCount" exact="1" operation="add"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221122" comment="The disgraced family, responsible for a reactor incident on a shipyard."/>
                              <text line="30221123" comment="We still remember our dead every anniversary."/>
                              <text line="30221124" comment="(angry)May they haunt that cursed family for all eternity!"/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_2_2_opposed'">
                            <append_to_list name="$LoyalistSaid" exact="'ch1_sec2_2'"/>
                            <set_value name="$ShowPlayerChoices" exact="'ch1_2_families'"/>
                            <set_value name="$LoyalistVerdict" exact="1" operation="subtract"/>
                            <set_value name="$LoyalistAngryness" exact="1" operation="subtract"/>
                            <set_value name="$LoyalistChoicesCount" exact="1" operation="add"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221125" comment="Some of the families do not want patriarchal laws in their realm."/>
                              <text line="30221126" comment="And local pirates are similarly reluctant to accept proper government."/>
                            </add_npc_line>
                            <add_npc_line speaker="$DalBusta" hidechoices="true" chance="if $AffiliationPatriarchy then 0 else 100">
                              <text line="30221159" comment="So this guy bought into the patriarchal propaganda.."/>
                            </add_npc_line>
                            <add_npc_line speaker="$DalBusta" hidechoices="true">
                              <text line="if player.entity.isfemale then 30221161 else 30221160" comment="Be careful."/>
                              <text line="30221162" comment="We don't want to alienate him."/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_3_occupation'">
                            <append_to_list name="$LoyalistSaid" exact="'ch1_sec3'"/>
                            <set_value name="$ShowPlayerChoices" exact="'ch1_0_topics'"/>
                            <set_value name="$LoyalistChoicesCount" exact="1" operation="add"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221127" comment="The Patriarchy grants all Split, outcasts, exiles and cursed ones, a way out of the slums and back to civilisation."/>
                              <text line="30221128" comment="But to reintegrate the Free Families back to Split society, criminals must be weeded out."/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_4_slavery'">
                            <set_value name="$ShowPlayerChoices" exact="'ch1_4_slavery'"/>
                            <set_value name="$LoyalistChoicesCount" exact="1" operation="add"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221129" comment="Oh yes, Split civilisation has long slave tradition."/>
                              <text line="30221130" comment="Split not look kindly upon weaklings, be it foreign creatures or own kin."/>
                              <text line="if player.entity.isfemale then 30221132 else 30221131" comment="You seem concerned about slaves' fate."/>
                              <text line="if player.entity.isfemale then 30221134 else 30221133" comment="Maybe you interested in some news."/>
                              <text line="30221135" comment="Argon slaves heard that their home world was reconnected."/>
                              <text line="30221136" comment="They grew insurgent, so Patriarchy started pushing slave rights to calm them."/>
                              <text line="30221137" comment="Of course that goes against Free Families."/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_4_1_abolishment'">
                            <set_value name="$Achievement_Informed_On_Slavery" exact="1" operation="add"/>
                            <append_to_list name="$LoyalistSaid" exact="'ch1_sec4_1'"/>
                            <append_to_list name="$LoyalistSaid" exact="'ch1_sec4'"/>
                            <set_value name="$ShowPlayerChoices" exact="'ch1_0_topics'"/>
                            <set_value name="$LoyalistVerdict" exact="1" operation="subtract"/>
                            <set_value name="$LoyalistAngryness" exact="1" operation="subtract"/>
                            <set_value name="$LoyalistChoicesCount" exact="1" operation="add"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="30221138" comment="Argon Federation is demanding end to enslavement of Argon."/>
                              <text line="30221139" comment="But cannot go into every Split household and take their slaves."/>
                            </add_npc_line>
                            <add_npc_line speaker="$DalBusta" hidechoices="true">
                              <text line="if player.entity.isfemale then 30221164 else 30221163" comment="I will let that one slide but, just to remind you, your mission was to befriend him."/>
                            </add_npc_line>
                          </do_elseif>
                          <do_elseif value="event.param2 == 'ch1_end'"></do_elseif>

                          <!-- Check parent sections to be done -->
                          <do_if value="$LoyalistSaid.indexof.{'ch1_sec1_1'} and $LoyalistSaid.indexof.{'ch1_sec1_2'}">
                            <append_to_list name="$LoyalistSaid" exact="'ch1_sec1'"/>
                          </do_if>
                          <do_if value="$LoyalistSaid.indexof.{'ch1_sec2_1'} and $LoyalistSaid.indexof.{'ch1_sec2_2'}">
                            <append_to_list name="$LoyalistSaid" exact="'ch1_sec2'"/>
                          </do_if>

                          <!-- Allow leaving after asking enough -->
                          <do_if value="$LoyalistChoicesCount ge 4" comment="0 to 7">
                            <set_value name="$ConversationDone"/>
                          </do_if>
                          <do_if value="($LoyalistVerdict le -2) or ($LoyalistAngryness le -3)" comment="Verdict -3 to 2">
                            <!-- NPC aborts conversation and goes on board / restarting conversation should not allow to talk again -->
                            <set_value name="$ConversationDone"/>
                            <set_value name="$ConversationDoneAngry"/>
                          </do_if>

                          <!-- set the basic player choices based on "$ShowPlayerChoices" -->

                          <do_if value="$ConversationDoneAngry?">
                            <set_value name="$ZyarthRelationBonus" exact="1" operation="subtract"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="false">
                              <text line="30221141" comment="That's enough."/>
                              <text line="30221142" comment="Time to go now."/>
                            </add_npc_line>
                            <add_player_choice section="passenger_onboard" position="bottom_right"    selectable="$ConversationDone?" text="readtext.{1002}.{3015}" comment="Come on board"/>
                          </do_if>
                          <do_elseif value="$ShowPlayerChoices == 'ch1_0_greeting'">
                            <do_if value="$ConversationDone?">
                              <add_player_choice section="passenger_onboard" position="bottom_right"    selectable="$ConversationDone?" text="readtext.{1002}.{3015}" comment="Come on board"/>
                            </do_if>
                            <do_else>
                              <add_player_choice text="{30221,1152}" comment="I'd like to hear more about them." section="ch1_loyalist" choiceparam="'ch1_0_topics_init'"/>
                            </do_else>
                          </do_elseif>
                          <do_elseif value="$ShowPlayerChoices == 'ch1_0_topics'">
                            <!-- ConversationDoneAngry removed from here -->
                            <!--<do_else>-->
                            <do_any>
                              <add_npc_line speaker="$LoyalistActor" hidechoices="false" weight="1">
                                <text line="if player.entity.isfemale then 30221107 else 30221106" comment="Ask!"/>
                              </add_npc_line>
                              <add_npc_line speaker="$LoyalistActor" hidechoices="false" weight="$LoyalistAskingAgainWeight">
                                <text line="if player.entity.isfemale then 30221172 else 30221140" comment="Any more questions?"/>
                              </add_npc_line>
                            </do_any>
                            <set_value name="$LoyalistAskingAgainWeight" exact="1"/>
                            <add_player_choice section="passenger_onboard" position="bottom_right"    selectable="$ConversationDone?" text="readtext.{1002}.{3015}" tooltip="{30221,1162}" comment="'Come on Board / Acquire enough information.'"/>
                            <add_player_choice section="ch1_loyalist" choiceparam="'ch1_1_zyarth'"      selectable="not $LoyalistSaid.indexof.{'ch1_sec1'}" text="{30221,1153}" comment="'On the Zyarth Patriarchy...'"/>
                            <add_player_choice section="ch1_loyalist" choiceparam="'ch1_2_families'"    selectable="not $LoyalistSaid.indexof.{'ch1_sec2'}" text="{30221,1156}" comment="'On the Free Families...'"/>
                            <add_player_choice section="ch1_loyalist" choiceparam="'ch1_3_occupation'"  selectable="not $LoyalistSaid.indexof.{'ch1_sec3'}" text="{30221,1159}" comment="'On the patriarchal presence...'"/>
                            <add_player_choice section="ch1_loyalist" choiceparam="'ch1_4_slavery'"     selectable="not $LoyalistSaid.indexof.{'ch1_sec4'}" text="{30221,1160}" comment="'On slavery...'"/>
                            <!--</do_else>-->
                          </do_elseif>
                          <do_else>
                            <add_player_choice section="ch1_loyalist" choiceparam="'ch1_0_topics'"     selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                            <do_if value="$ShowPlayerChoices == 'ch1_1_zyarth'">
                              <add_player_choice section="ch1_loyalist" choiceparam="'ch1_1_1_patriarch'" selectable="not $LoyalistSaid.indexof.{'ch1_sec1_1'}"  text="{30221,1154}" comment="'What kind of Patriarch is Zyarth?'"/>
                              <add_player_choice section="ch1_loyalist" choiceparam="'ch1_1_2_stability'" selectable="not $LoyalistSaid.indexof.{'ch1_sec1_2'}"  text="{30221,1155}" comment="'How stable is the Patriarchy?'"/>
                            </do_if>
                            <do_elseif value="$ShowPlayerChoices == 'ch1_2_families'">
                              <add_player_choice section="ch1_loyalist" choiceparam="'ch1_2_1_tkr'"     selectable="not $LoyalistSaid.indexof.{'ch1_sec2_1'}"  text="{30221,1157}" comment="'Family Tkr?'"/>
                              <add_player_choice section="ch1_loyalist" choiceparam="'ch1_2_2_opposed'" selectable="not $LoyalistSaid.indexof.{'ch1_sec2_2'}"  text="{30221,1158}" comment="'Are Free Families opposed to Patriarchy rule (Zyarth?)?'"/>
                            </do_elseif>
                            <do_elseif value="$ShowPlayerChoices == 'ch1_4_slavery'">
                              <add_player_choice section="ch1_loyalist" choiceparam="'ch1_4_1_abolishment'" selectable="not $LoyalistSaid.indexof.{'ch1_sec4_1'}"  text="{30221,1161}" comment="'Will slavery ever be abolished?'"/>
                            </do_elseif>
                          </do_else>

                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch1_Passenger_Transport_Loyalist_NextSection_SelectShip" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$NPCPassenger" />
                        <check_value value="event.param == 'passenger_onboard'" />
                      </conditions>
                      <actions>
                        <find_object_component name="this.$PlayerShips" object="$NPCPassenger.container" owner="faction.player" class="[class.ship_s]" recursive="true" multiple="true" />
                        <set_value name="$ShipTooBig" exact="readtext.{30232}.{102}"/>
                        <open_conversation_menu menu="PlatformUndockMenu" param="[0, 0, $NPCPassenger.container, 'movepassenger', [ this.$PlayerShips, $ShipTooBig]]" />
                      </actions>
                    </cue>

                    <cue name="Ch1_Passenger_Transport_Loyalist_Check_Ship" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$NPCPassenger" />
                        <check_value value="event.param == 'c_movepassenger_destinationselected'" />
                      </conditions>
                      <actions>
                        <!--people.free does not count control entity slots, which is fine for this case
                            Inbound people should be flagged as 'intransit' and included in the current total of people-->
                        <debug_text text="'$PassengerShip ' + event.param2 + ' has ' + event.param2.people.free + ' free people slots'" chance="$DebugChance"/>
                        <do_if value="event.param2.people.free">
                          <!--Ship has enough space for the passenger. Add them to the ship's people list and attempt to have them walk to it.-->
                          <set_value name="$PassengerShip" exact="event.param2" />
                          <!-- Make NPC walk to selected ship. As their destination slot is a NPC transport slot, they will become 'hidden' on arrival. They will continue to exist. -->
                          <find_npc_waypoint name="this.$DespawnWaypoints" object="$PassengerShip" tags="tag.npctransport" multiple="true"/>
                          <assert value="this.$DespawnWaypoints.count" text="'No waypoints on ' + $PassengerShip + ' ' + $PassengerShip.knownname + ' tagged ' + tag.npctransport + '. No place to despawn passengers.'"/>
                          <debug_text text="'Attempting to add ' + $NPCPassenger + ' to ' + $PassengerShip + ' ' +$PassengerShip.knownname + ' as a passenger'" chance="$DebugChance"/>
                          <create_npc_template name="this.$Template" object="$PassengerShip" entity="$NPCPassenger" role="entityrole.passenger"/>
                          <assert value="$NPCPassengerTemplate == this.$Template" text="'Template of passenger added to the ship ' + this.$Template + ' does not match that stored earlier ' + $NPCPassengerTemplate + ' [Owen]'"/>
                          <assert value="this.$Template" text="'Attempted to add passenger to the selected ship but it failed. [Owen]'"/>
                          <do_if value="this.$Template">
                            <do_if value="this.$DespawnWaypoints.count">
                              <!--
                              <set_value name="$MovementTable" exact="table[$slot = this.$DespawnWaypoints.random]" />
                              <signal_objects object="$NPCPassenger" param="'npc_move_to'" param2="$MovementTable.clone"/>-->
                              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $NPCPassenger,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = this.$DespawnWaypoints.random,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance]
                                                                                                      ]"/>
                            </do_if>
                            <do_else>
                              <assert value="this.$DespawnWaypoints.count" text="'No place for the NPC was found on the selected ship ' + $PassengerShip + ' ' + $PassengerShip.macro.id + ' - This will fail the RML. [Owen]'"/>
                              <remove_actor_from_room actor="$NPCPassenger"/>
                            </do_else>
                          </do_if>
                          <signal_objects object="$NPCPassenger" param="'passenger_transport_ship_selected'" param2="$PassengerShip"/>
                        </do_if>
                        <do_else>
                          <add_npc_line speaker="$NPCPassenger" line="11803" comment="(No room on selected ship)" />
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Debug_Destroy_TargetContainer">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="this"/>
                        <destroy_object object="$TargetContainer"/>
                      </actions>
                    </cue>
                    <cue name="Debug_Destroy_TargetDocks">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="this"/>
                        <find_dockingbay name="$docks" object="$TargetContainer" checkoperational="true" multiple="true">
                        </find_dockingbay>
                        <do_for_each in="$docks" name="$dock">
                          <destroy_object object="$dock"/>
                        </do_for_each>
                      </actions>
                    </cue>

                    <cue name="Ch1_Passenger_Transport_Loyalist_End" version="3">
                      <conditions>
                        <event_cue_signalled/>
                        <!-- Signalled when the Passenger enters the Players Ship (DropOff == false) -->
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <!-- Check $EndFeedbackValue for Success -->
                        <do_if value="this.$EndFeedbackValue le 0">
                          <!-- Expecting the TargetContainer to have failed -->

                          <find_station space="player.galaxy" name="$PossibleTargetContainers" multiple="true" sortbygatedistanceto="player.entity">
                            <match_content checkoperational="true">
                              <match_dock size="tag.dock_s"/>
                            </match_content>
                            <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                          </find_station>
                          <do_for_each in="$PossibleTargetContainers" name="$c">
                            <do_if value="$SplitSectors.indexof.{$c.sector}">
                              <set_value name="$TargetContainer" exact="$c"/>
                              <break/>
                            </do_if>
                          </do_for_each>
                          <set_value name="$TargetContainerSector" exact="$TargetContainer.sector"/>
                          <set_value name="$TargetContainerName" exact="$TargetContainer.knownname" comment="saving as a fake objective target in case the station gets destroyed"/>

                          <remove_value name="this.$EndFeedbackValue"/>
                          <reset_cue cue="this"/>
                          <reset_cue cue="Ch1_Passenger_Transport_Loyalist_Ref"/>

                        </do_if>
                        <do_else>
                          <!-- Temporary "disable" zyarth colonial police hostility towards the Loyalist Ship-->
                          <speak actor="$LoyalistActor" line="11801" comment="(NPC moves onto player's ship)I'm aboard your ship and ready to go." priority="90"/>

                          <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                            <param name="Object" value="$PickupContainer"/>
                            <param name="RequesterCue" value="namespace"/>
                            <param name="DebugChance" value="$DebugChance"/>
                          </run_actions>

                          <do_if value="$TargetContainer.exists">
                            <set_value name="$TargetContainerSector" exact="$TargetContainer.sector"/>
                            <set_value name="$TargetContainerName" exact="$TargetContainer.knownname" comment="saving as a fake objective target in case the station gets destroyed"/>
                          </do_if>
                          <do_else>
                            <find_station space="player.galaxy" name="$PossibleTargetContainers" multiple="true" sortbygatedistanceto="player.entity">
                              <match_dock walkable="true"/>
                              <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                            </find_station>
                            <do_for_each in="$PossibleTargetContainers" name="$c">
                              <do_if value="$SplitSectors.indexof.{$c.sector}">
                                <set_value name="$TargetContainer" exact="$c"/>
                                <break/>
                              </do_if>
                            </do_for_each>
                            <do_if value="$TargetContainer.exists">
                              <set_value name="$TargetContainerSector" exact="$TargetContainer.sector"/>
                              <set_value name="$TargetContainerName" exact="$TargetContainer.knownname" comment="saving as a fake objective target in case the station gets destroyed"/>
                            </do_if>
                            <do_else>
                              <debug_text text="'Failed to find a $TargetContainer'"/>
                            </do_else>
                          </do_else>

                          <set_objective step="3" cue="$MissionCue" action="objective.flyto" object="$TargetContainerSector" text="$TargetContainerName" updatebriefing="true"/>
                          <signal_cue cue="Ch1_Police_Control" check="false"/>
                        </do_else>
                      </actions>
                      <patch sinceversion="2">
                        <do_if value="this.$EndFeedbackValue le 0">
                          <!-- Expecting the TargetContainer to have failed -->

                          <find_station space="player.galaxy" name="$PossibleTargetContainers" multiple="true" sortbygatedistanceto="player.entity">
                            <match_dock walkable="true"/>
                            <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                          </find_station>
                          <do_for_each in="$PossibleTargetContainers" name="$c">
                            <do_if value="$SplitSectors.indexof.{$c.sector}">
                              <set_value name="$TargetContainer" exact="$c"/>
                              <break/>
                            </do_if>
                          </do_for_each>
                          <set_value name="$TargetContainerSector" exact="$TargetContainer.sector"/>
                          <set_value name="$TargetContainerName" exact="$TargetContainer.knownname" comment="saving as a fake objective target in case the station gets destroyed"/>

                          <remove_value name="this.$EndFeedbackValue"/>
                          <reset_cue cue="this"/>
                          <reset_cue cue="Ch1_Passenger_Transport_Loyalist_Ref"/>
                        </do_if>
                      </patch>
                      <patch sinceversion="3" state="complete">
                        <do_if value="$PickupContainer? and $PickupContainer.exists and ($LoyalistActor.station != $PickupContainer)">
                          <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                            <param name="Object" value="$PickupContainer"/>
                            <param name="RequesterCue" value="namespace"/>
                            <param name="CheckObjectPresence" value="false"/>
                            <param name="DebugChance" value="$DebugChance"/>
                          </run_actions>
                        </do_if>
                      </patch>
                      <patch sinceversion="3" state="cancelled">
                        <do_if value="$PickupContainer? and $PickupContainer.exists and ($LoyalistActor.station != $PickupContainer)">
                          <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                            <param name="Object" value="$PickupContainer"/>
                            <param name="RequesterCue" value="namespace"/>
                            <param name="CheckObjectPresence" value="false"/>
                            <param name="DebugChance" value="$DebugChance"/>
                          </run_actions>
                        </do_if>
                      </patch>
                      <cues>
                        <cue name="Ch1_Story_Reminder_Transport" checkinterval="1s" onfail="cancel">
                          <conditions>
                            <check_value value="Ch1_Police_Control_Event.state == cuestate.waiting"/>
                          </conditions>
                          <cues>
                            <cue name="Ch1_Story_Reminder_Transport_v2_Ref" ref="md.Story_Paranid.Story_Reminder">
                              <param name="Actor"       value="$DalBusta"/>
                              <param name="CutsceneKey" value="$DalCutsceneKey"/>
                              <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30200108 else 30200107]]"/>
                              <param name="CancelCue"   value="Ch1_Police_Control_Event"/>
                              <param name="Delay"       value="20min"/>
                              <!--  <t id="30200001">Hey there partner.</t>
                                <t id="30200002">(spoken to female player){10111,30200001}</t>
                                <t id="30200105">Don't keep our contact waiting for too long.</t>
                                <t id="30200106">(spoken to female player){,30200105}</t>
                                <t id="30200107">Where have you wandered off to?</t>
                                <t id="30200108">(spoken to female player 'you'){,30200107}</t>    -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                  <!-- cue: Ch1_Passenger_Transport_Loyalist -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch1_Police_Control">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- ZYA Police stops the Player, may be a short fight, Loyalist talks them out of it. -->
              <actions>
                <create_cue_actor name="$Split_Police_Pilot" cue="namespace" macro="character_split_male_generic_02_macro">
                  <page exact="10405"/>
                  <owner exact="faction.split"/>
                  <skills>
                    <skill type="management"  exact="3"/>
                    <skill type="morale"      exact="6"/>
                    <skill type="piloting"    exact="9"/>
                    <skill type="engineering" exact="3"/>
                    <skill type="boarding"    exact="8"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$Split_Police_Pilot" missionactor="true" customhandler="true" subtitlename="$Split_Police_Pilot.knownname"/>
              </actions>
              <cues>
                <cue name="Ch1_Police_Control_Init" version="3">
                  <delay exact="if $PassengerShipSetDelay? then $PassengerShipSetDelay else 0s"/>
                  <actions>
                    <do_if value="$PassengerShip? and $PassengerShip.exists">
                      <create_list name="$ApproachHandlers"/>
                      <do_for_each in="$SplitSectors" name="$s">
                        <signal_cue_instantly cue="Ch1_Police_Control_Check_Sector_v2" param="$s"/>
                      </do_for_each>
                      <signal_cue cue="Ch1_PassengerShip_Lost_Failsafe"/>
                    </do_if>
                    <do_else>
                      <set_value name="$PassengerShipSetDelay" exact="3s"/>
                      <reset_cue cue="this" comment="try again"/>
                    </do_else>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="$ApproachHandlers?" comment="If the list got removed we're past this part of the story already">
                      <!-- Abort Wrong Approach Handlers-->
                      <do_all exact="$ApproachHandlers.count" counter="$ah">
                        <do_if value="$ApproachHandlers.{$ah}.exists">
                          <cancel_cue cue="$ApproachHandlers.{$ah}"/>
                        </do_if>
                      </do_all>

                      <!-- Create New Approach Handlers -->
                      <do_if value="not $PassengerShip?">
                        <set_value name="$PassengerShip" exact="$LoyalistActor.ship"/>
                      </do_if>
                      <do_if value="$PassengerShip.exists">
                        <do_for_each in="$SplitSectors" name="$s">
                          <signal_cue_instantly cue="Ch1_Police_Control_Check_Sector" param="$s" comment="Ch1_...Sector_v2 may not exist during this patch"/>
                        </do_for_each>
                      </do_if>
                      <do_else>
                        <!-- $LoyalistActor is null or not on a ship -->
                        <debug_text text="'$LoyalistActor is null or not on a ship'"/>
                        <reset_cue cue="parent"/>
                        <do_if value="not $LoyalistActor">
                          <signal_cue cue="Ch1_Passenger_Died"/>
                        </do_if>
                      </do_else>

                    </do_if>
                  </patch>
                  <patch sinceversion="3">
                    <set_value name="$Patch_PassengerShip_Lost_Failsafe" comment="cannot signal directly as the new cue does not exist yet"/>
                  </patch>
                </cue>

                <cue name="Ch1_Police_Control_Check_Sector" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Sector" exact="event.param"/>
                    <append_to_list name="$ApproachHandlers" exact="this"/>
                  </actions>
                  <cues>
                    <cue name="Ch1_Police_Control_ReachedTargetSector_Ref" ref="md.LIB_Generic.ReachedSector">
                      <param name="TargetObject"      value="$PassengerShip"/>
                      <param name="TargetSector"      value="$Sector"/>
                      <param name="SuccessSignalCue"  value="Ch1_Police_Control_Event"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Police_Control_Check_Sector_v2" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Sector" exact="event.param"/>
                    <append_to_list name="$ApproachHandlers" exact="this"/>
                  </actions>
                  <cues>
                    <cue name="Ch1_Police_Control_ReachedTargetSector_Ref_v2" ref="md.LIB_Generic.ReachedSector">
                      <param name="TargetObject"      value="$PassengerShip"/>
                      <param name="TargetSector"      value="$Sector"/>
                      <param name="SuccessSignalCue"  value="Ch1_Police_Control_Event"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Passenger_Ship_Lost_Failsafe_Patch" checkinterval="3s" onfail="cancel">
                  <conditions>
                    <check_value value="$Patch_PassengerShip_Lost_Failsafe?"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch1_PassengerShip_Lost_Failsafe"/>
                  </actions>
                </cue>

                <cue name="Ch1_PassengerShip_Lost_Failsafe">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch1_PassengerShip_Lost" checkinterval="5s">
                      <!-- Abort Broken Approach Handlers when the PassengerShip was lost -->
                      <conditions>
                        <check_value value="not $PassengerShip.exists"/>
                      </conditions>
                      <actions>
                        <reset_cue cue="Ch1_Passenger_Transport_Loyalist"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <do_all exact="$ApproachHandlers.count" counter="$ah">
                          <do_if value="$ApproachHandlers.{$ah}.exists">
                            <cancel_cue cue="$ApproachHandlers.{$ah}"/>
                          </do_if>
                        </do_all>
                        <reset_cue cue="parent"/>
                        <reset_cue cue="Ch1_Police_Control_Init"/>
                        <signal_cue cue="Ch1_Passenger_Transport_Loyalist"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>


                <cue name="Ch1_Police_Control_Event">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Abort Approach Handlers-->
                    <do_all exact="$ApproachHandlers.count" counter="$ah">
                      <do_if value="$ApproachHandlers.{$ah}.exists">
                        <cancel_cue cue="$ApproachHandlers.{$ah}"/>
                      </do_if>
                    </do_all>
                    <remove_value name="$ApproachHandlers"/>

                    <set_value name="$ContainerShip" exact="$LoyalistActor.ship"/>
                    <do_while value="$ContainerShip.ship.exists">
                      <set_value name="$ContainerShip" exact="$ContainerShip.ship"/>
                    </do_while>

                    <do_if value="$ContainerShip.station.exists">
                      <!-- Player probably arrived with the HQ $ContainerShip.station.isheadquarters, catch that by changing the $TargetObject objective -->
                      <signal_cue cue="Ch1_Police_Control_Retarget"/>
                    </do_if>
                    <do_else comment="We did not warp in on the station, but entered normally">
                      <!-- Set Gate -->
                      <find_gate name="$Gates" active="true" multiple="true" space="$ContainerShip.sector"/>
                      <do_for_each in="$Gates" name="$g">
                        <do_if value="$BaseSectors.indexof.{$g.exit.sector}">
                          <set_value name="$CurrentGate" exact="$g"/>
                          <break/>
                        </do_if>
                      </do_for_each>

                      <!-- Stop the Ship -->
                      <do_if value="player.ship == $ContainerShip">
                        <set_playership_throttle value="0" comment="stop (to avoid crashing while cutscene plays)"/>
                        <force_player_speed speed="0"/>
                        <stop_player_autopilot/>
                      </do_if>
                      <do_else>
                        <create_order id="'Wait'" object="$ContainerShip" immediate="true">
                          <param name="noattackresponse" value="true"/>
                        </create_order>
                      </do_else>

                      <create_position name="$PoliceShipPos" object="$CurrentGate" space="$CurrentGate.sector" x="0km" y="0km" z="2.3km"/>
                      <create_position name="$ContainerShipPos" object="$CurrentGate" space="$CurrentGate.sector" x="0km" y="0.1km" z="1km - [$ContainerShip.length, 120m].max"/>

                      <warp object="$ContainerShip" sector="$ContainerShip.sector">
                        <position x="$ContainerShipPos.x" y="$ContainerShipPos.y" z="$ContainerShipPos.z"/>
                        <rotation pitch="$CurrentGate.rotation.pitch" roll="$CurrentGate.rotation.roll" yaw="$CurrentGate.rotation.yaw"/>
                      </warp>

                      <create_rotation  name="$FacePlayer"
                                        pitch="$ContainerShip.rotation.pitch + 10deg"
                                        roll="$ContainerShip.rotation.roll"
                                        yaw="$ContainerShip.rotation.yaw + 220deg"/>


                      <create_loadout result="$loadout_Missile_Rattlesnake">
                        <macros>
                          <engine macro="engine_spl_l_travel_01_mk1_macro" path="../con_engine_03"/>
                          <engine macro="engine_spl_l_travel_01_mk1_macro" path="../con_engine_02"/>
                          <engine macro="engine_spl_l_travel_01_mk1_macro" path="../con_engine_01"/>
                          <weapon macro="weapon_spl_l_destroyer_01_mk1_macro" path="../con_weapon_04"/>
                          <weapon macro="weapon_spl_l_destroyer_01_mk1_macro" path="../con_weapon_03"/>
                          <weapon macro="weapon_spl_l_destroyer_01_mk1_macro" path="../con_weapon_02"/>
                          <weapon macro="weapon_spl_l_destroyer_01_mk1_macro" path="../con_weapon_01"/>
                          <shield macro="shield_spl_l_standard_01_mk2_macro" path="../con_shieldgenerator_l_01"/>
                        </macros>
                        <groups>
                          <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_back_up_mid"/>
                          <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_front_up_mid"/>
                          <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_front_down_mid"/>
                          <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_up_mid" exact="4"/>
                          <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_down_back_mid"/>
                          <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_back_up_mid_02"/>
                          <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_up_back_mid_2"/>
                          <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_mid_down_mid" exact="4"/>
                          <shields macro="shield_spl_m_standard_02_mk2_macro" path=".." group="group_down_back_mid_2"/>
                          <turrets macro="turret_spl_m_guided_02_mk1_macro" path=".." group="group_front_up_mid" exact="4"/>
                          <turrets macro="turret_spl_m_guided_02_mk1_macro" path=".." group="group_front_down_mid" exact="4"/>
                          <turrets macro="turret_spl_l_plasma_01_mk1_macro" path=".." group="group_mid_up_mid" exact="2"/>
                          <turrets macro="turret_spl_l_plasma_01_mk1_macro" path=".." group="group_down_back_mid"/>
                          <turrets macro="turret_spl_m_guided_02_mk1_macro" path=".." group="group_up_back_mid" exact="2"/>
                          <turrets macro="turret_spl_l_plasma_01_mk1_macro" path=".." group="group_up_back_mid_2"/>
                          <turrets macro="turret_spl_l_plasma_01_mk1_macro" path=".." group="group_mid_down_mid" exact="2"/>
                          <turrets macro="turret_spl_m_guided_02_mk1_macro" path=".." group="group_down_back_mid_2" exact="2"/>
                        </groups>
                        <ammunition>
                          <ammunition macro="missile_interceptor_light_mk1_macro" exact="100"/>
                          <ammunition macro="missile_starburst_heavy_mk1_macro" exact="100"/>
                          <ammunition macro="missile_disruptor_light_mk1_macro" exact="80"/>
                          <ammunition macro="ship_gen_s_lasertower_01_a_macro" exact="250"/>
                          <ammunition macro="countermeasure_flares_01_macro" exact="20"/>
                          <unit macro="ship_gen_xs_repairdrone_01_a_macro" exact="10"/>
                        </ammunition>
                        <software>
                          <software ware="software_dockmk2"/>
                          <software ware="software_flightassistmk1"/>
                          <software ware="software_scannerlongrangemk2"/>
                          <software ware="software_scannerobjectmk2"/>
                          <software ware="software_targetmk1"/>
                          <software ware="software_trademk1"/>
                        </software>
                        <virtualmacros>
                          <thruster macro="thruster_gen_l_allround_01_mk3_macro"/>
                        </virtualmacros>
                      </create_loadout>


                      <create_ship name="$PoliceShip" sector="$ContainerShip.sector" capturable="false" missioncue="namespace" macro="ship_spl_l_destroyer_01_a_macro">
                        <loadout loadout="$loadout_Missile_Rattlesnake"/>
                        <owner exact="faction.split" overridenpc="true"/>
                        <paint ware="$PaintMod_PatriarchyPolice"/>
                        <pilot actor="$Split_Police_Pilot"/>
                        <position x="$PoliceShipPos.x" y="$PoliceShipPos.y" z="$PoliceShipPos.z"/>
                        <rotation value="$FacePlayer"/>
                      </create_ship>
                      <set_object_relation_behaviour object="$PoliceShip" disable="true"/>
                      <set_object_min_hull object="$PoliceShip" exact="50"/>
                      <set_relation_boost value="$RelationBoostDocking" decay="0" object="$Split_Police_Pilot" otherobject="$LoyalistActor.ship"/>

                      <create_order id="'Wait'" object="$PoliceShip" immediate="true">
                        <param name="noattackresponse" value="true"/>
                      </create_order>

                      <signal_cue cue="Ch1_Police_Overshoot"/>
                      <signal_cue_instantly cue="Ch1_Police_Cutscene"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch1_Police_Control_Retarget">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Create a new Target Ship -->
                    <set_value name="$Distance" min="$ContainerShip.maxradarrange + 5km" max="$ContainerShip.maxradarrange + 15km"/>
                    <create_position name="$SpawnPosition" object="$ContainerShip" x="$Distance" y="$Distance" z="$Distance" space="$ContainerShip.sector"/>
                    <create_ship name="$PoliceShip" sector="$LoyalistActor.sector">
                      <select faction="faction.split" tags="[tag.fighter, tag.heavy]"/>
                      <loadout>
                        <level exact="0.7"/>
                      </loadout>
                      <owner exact="faction.split" overridenpc="true"/>
                      <pilot actor="$Split_Police_Pilot"/>
                      <safepos value="$SpawnPosition"/>
                    </create_ship>
                    <set_object_relation_behaviour object="$PoliceShip" disable="true"/>
                    <set_object_min_hull object="$PoliceShip" exact="50"/>
                    <signal_cue cue="Ch1_Police_Overshoot"/>
                    <set_relation_boost value="$RelationBoostDocking" decay="0" object="$Split_Police_Pilot" otherobject="$LoyalistActor.ship"/>
                    <create_order id="'Wait'" object="$PoliceShip" immediate="true">
                      <param name="noattackresponse" value="true"/>
                    </create_order>
                  </actions>
                  <cues>
                    <cue name="Ch1_Police_Control_Retarget_Speak">
                      <delay exact="5s"/>
                      <actions>
                        <speak actor="$LoyalistActor">
                          <text line="30221143" comment="Change of plans."/>
                          <text line="if player.entity.isfemale then 30221173 else 30221143" comment="Sending you new destination data."/>
                        </speak>
                      </actions>
                      <cues>
                        <cue name="Ch1_Police_Control_Retarget_Objective">
                          <conditions>
                            <event_speak_finished actor="$LoyalistActor" line="30221143" comment="First Line of Speak: Change of plans."/>
                          </conditions>
                          <delay exact="0.5s"/>
                          <actions>
                            <set_objective step="3" cue="$MissionCue" action="objective.flyto" object="$PoliceShip" text="$PoliceShip.knownname" updatebriefing="true"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch1_Police_Control_Retarget_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="$LoyalistActor.ship"/>
                      <param name="ApproachTarget"    value="$LoyalistActor.ship"/>
                      <param name="ApproachDistance"  value="param.docking.maxdistance.{$ContainerShip.class} * 0.9"/>
                      <!-- @HEinrich todo: Container ship could be too large for docking -->
                      <param name="SuccessSignalCue"  value="Ch1_Police_Control_Retarget_Reached"/>
                    </cue>
                    <cue name="Ch1_Police_Control_Retarget_Reached">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Stop the ship -->
                        <set_value name="$ContainerShip" exact="$LoyalistActor.ship"/>
                        <do_while value="$ContainerShip.ship.exists">
                          <set_value name="$ContainerShip" exact="$ContainerShip.ship"/>
                        </do_while>
                        <create_order id="'Wait'" object="$ContainerShip" immediate="true">
                          <param name="noattackresponse" value="true"/>
                        </create_order>

                        <signal_cue cue="Ch1_Police_Cutscene"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Police_Overshoot">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch1_Police_Overshoot_Loop">
                      <conditions>
                        <event_object_attacked object="$PoliceShip"/>
                        <check_value value="event.param.isplayerowned"/>
                      </conditions>
                      <delay max="0.1s" min="0.05s"/>
                      <actions>
                        <set_object_min_hull object="$PoliceShip" exact="33"/>
                        <set_relation_boost object="$PoliceShip" faction="faction.player" value="$RelationBoostDocking" comment="Boost to allow landing" decay="0"/>
                        <reset_cue cue="this"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Police_Cutscene">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Invincibility for Cutscene Ships during cutscene -->
                    <set_object_min_hull object="$PoliceShip" exact="$PoliceShip.hullpercentage"/>
                    <set_object_min_shield object="$PoliceShip" exact="$PoliceShip.shieldpercentage"/>

                    <set_value name="$PoliceCutscenePlayerShip" exact="player.ship"/>
                    <set_object_min_hull object="$PoliceCutscenePlayerShip" exact="player.ship.hullpercentage"/>
                    <set_object_min_shield object="$PoliceCutscenePlayerShip" exact="player.ship.shieldpercentage"/>

                    <set_value name="$PoliceCutsceneLoyalistActorShip" exact="$LoyalistActor.ship"/>
                    <set_object_min_hull object="$PoliceCutsceneLoyalistActorShip" exact="$LoyalistActor.ship.hullpercentage"/>
                    <set_object_min_shield object="$PoliceCutsceneLoyalistActorShip" exact="$LoyalistActor.ship.shieldpercentage"/>

                  </actions>
                  <cues>
                    <cue name="Ch1_Police_Cutscene_Start">
                      <actions>
                        <play_cutscene result="this.$CutsceneID" key="'Story_Split_Encounter'" abortable="false">
                          <param name="target_ship" object="$PoliceShip"/>
                        </play_cutscene>
                        <set_value name="$Ch2_ScavengerHuntSector" exact="$LoyalistActor.sector"/>
                        <find_gate name="$Gates" multiple="true" sortbydistanceto="$PoliceShip" space="$LoyalistActor.sector" active="true"/>
                        <set_value name="$Ch2_ScavengerHuntEntryGate" exact="$Gates.{1}"/>

                        <find_object_component groupname="$TargetComponents" object="$PoliceShip" class="class.turret" multiple="true"/>

                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <!-- Start Docking Behaviour -->
                        <do_if value="$ContainerShip.distanceto.{$PoliceShip} le param.docking.maxdistance.{$ContainerShip.class}">
                          <do_if value="player.ship == $ContainerShip">
                            <dock_player_ship_at destination="$PoliceShip"/>
                          </do_if>
                          <do_else>
                            <create_order id="'DockAndWait'" object="$ContainerShip" immediate="true">
                              <param name="destination" value="$PoliceShip" comment="stay docked at $PoliceShip"/>
                            </create_order>
                          </do_else>
                        </do_if>
                      </actions>
                      <cues>
                        <cue name="Ch1_Police_Cutscene_PlayerShip_Docked">
                          <conditions>
                            <event_object_docked_at container="$PoliceShip"/>
                            <!--<check_value value="event.param == $LoyalistActor.ship"/> // should be in, but maybe safer if not -->
                          </conditions>
                          <actions>
                            <!-- Remove Character -->
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                                  param="['add_definition', $LoyalistActor, table[
                                                                                                  $requestercue = namespace,
                                                                                                  $priority = 100,
                                                                                                  $location = $PoliceShip,
                                                                                                  $slottags = [tag.npc_generic],
                                                                                                  $debugchance = $DebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>
                          </actions>
                        </cue>

                        <cue name="Ch1_Police_Cutscene_Turrets">
                          <delay exact="5s"/>
                          <actions>
                            <do_for_each in="$TargetComponents" name="$t">
                              <aim_turret turret="$t" target="$ContainerShip"/>
                            </do_for_each>
                            <do_if value="Ch1_Police_Cutscene_End.state != cuestate.complete">
                              <reset_cue cue="this"/>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Ch1_Police_Cutscene_End">
                          <conditions>
                            <check_any>
                              <event_speak_finished actor="$LoyalistActor" line="30221149" comment="First line of the speak: He passes"/>
                              <event_speak_finished actor="$LoyalistActor" line="30221150" comment="First line of the speak: She passes"/>
                              <event_speak_finished actor="$LoyalistActor" line="30221151" comment="First line of the speak: It passes"/>
                              <event_speak_finished actor="$LoyalistActor" line="30221155" comment="First line of the speak: Dangerous Opinions"/>
                              <event_speak_finished actor="$LoyalistActor" line="30221156" comment="First line of the speak: Dangerous Opinions"/>
                              <event_cue_signalled comment="currently not used, but might be required as failsafe"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <stop_cutscene cutscene="parent.$CutsceneID"/>
                            <!-- Remove Invincibility after Cutscene ends -->
                            <set_object_min_hull object="$PoliceCutscenePlayerShip" exact="0"/>
                            <set_object_min_shield object="$PoliceCutscenePlayerShip" exact="0"/>
                            <set_object_min_hull object="$PoliceCutsceneLoyalistActorShip" exact="0"/>
                            <set_object_min_shield object="$PoliceCutsceneLoyalistActorShip" exact="0"/>

                            <remove_npc_template object="$PassengerShip" template="$NPCPassengerTemplate"/>

                            <cancel_cue cue="Ch1_Loyalist_Dialog_Topics"/>

                            <signal_cue cue="Ch1_Police_Control_Done"/>
                          </actions>
                          <delay exact="3s"/>
                          <actions>
                            <!--<signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                                  param="['add_definition', $LoyalistActor, table[
                                                                                                  $requestercue = namespace,
                                                                                                  $priority = 100,
                                                                                                  $location = 'disconnect',
                                                                                                  $slottags = [tag.stand],
                                                                                                  $debugchance = $DebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>-->
                          </actions>
                          <cues>
                            <cue name="Ch1_Police_Leave_Scene">
                              <conditions>
                                <event_cue_signalled cue="Ch1_Police_Control_Done"/>
                              </conditions>
                              <actions>
                                <set_object_min_shield object="$PoliceShip" exact="50"/>
                                <create_order id="'Flee'" object="$PoliceShip" immediate="true">
                                  <param name="method" value="'boost'"/>
                                  <param name="attacker" value="$ContainerShip"/>
                                  <param name="donotdrop" value="true"/>
                                  <param name="deploydistraction" value="false"/>
                                  <param name="log" value="false"/>
                                </create_order>
                              </actions>
                              <cues>
                                <cue name="Ch1_Police_Despawn" checkinterval="23s">
                                  <conditions>
                                    <check_any>
                                      <check_value value="$PoliceShip.distanceto.{player.ship} ge 10km"/>
                                      <check_value value="$PoliceShip.sector != player.entity.sector"/>
                                    </check_any>
                                  </conditions>
                                  <actions>
                                    <cancel_all_orders object="$PoliceShip"/>
                                    <create_order object="$PoliceShip" id="'MoveDie'" immediate="true">
                                      <param name="byidle" value="false"/>
                                      <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                                    </create_order>
                                    <cancel_cue cue="Ch1_Police_Overshoot"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch1_Police_Cutscene_Speech">
                          <!-- Check if it is possible to have a targetmonitor during a fullscreen cutscene (probably not but would be cool) -->
                          <actions>
                            <!-- Add Scan Behaviour? -->
                            <!-- TODO: Make the player ship dock at the police ship OR the other way around, depending on Ship Sizes (spawn appropriate Ship Size), Disembark Passenger during Cutscene -->
                          </actions>
                          <cues>
                            <cue name="Ch1_Police_Cutscene_Speech_1">
                              <actions>
                                <speak actor="$Split_Police_Pilot" priority="100" comment="Plot relevant">
                                  <text line="11201" delay="0.5s" comment="This is sector security"/>
                                  <text line="11301" delay="0.5s" comment="(variant)(ship scan warning) / Plunderers Scan warning"/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Ch1_Police_Cutscene_Speech_2">
                              <conditions>
                                <event_speak_finished actor="$Split_Police_Pilot" line="11201" comment="First line of the speak"/>
                              </conditions>
                              <actions>
                                <speak actor="$BosoTa" priority="100" comment="Plot relevant">
                                  <text line="if player.entity.isfemale then 30221203 else 30221202" delay="0.5s" comment="Have I not warned my assistant to not become an accomplice in an unlawful conveyance of goods?"/>
                                  <!--
                                  <text line="30221167" delay="0.5s" comment="I want to see how he handles it."/>-->
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Ch1_Police_Cutscene_Speech_2b">
                              <conditions>
                                <check_any>
                                  <event_speak_finished actor="$BosoTa" line="30221202" comment="First line of the speak"/>
                                  <event_speak_finished actor="$BosoTa" line="30221203" comment="First line of the speak"/>
                                </check_any>
                              </conditions>
                              <actions>

                                <do_if value="$Split_Police_Pilot.sector.owner.primaryrace == race.split">
                                  <speak actor="$DalBusta" priority="100" comment="Plot relevant">
                                    <text line="if player.entity.isfemale then 30220345 else 30220344" delay="0.5s" comment="I think you'd better comply."/>
                                    <text line="if player.entity.isfemale then 30221166 else 30221165" delay="0.5s" comment="Wait! Let your passenger deal with this."/>
                                    <!--
                                  <text line="30221167" delay="0.5s" comment="I want to see how he handles it."/>-->
                                  </speak>
                                </do_if>
                                <do_else>
                                  <speak actor="$DalBusta" priority="100" comment="Plot relevant">
                                    <text line="30221901" delay="0.5s" comment="It is rather odd to come across Patriarchy Police in this sector."/>
                                    <text line="if player.entity.isfemale then 30221166 else 30221165" delay="0.5s" comment="Wait! Let your passenger deal with this."/>
                                    <!--
                                  <text line="30221167" delay="0.5s" comment="I want to see how he handles it."/>-->
                                  </speak>
                                </do_else>
                              </actions>
                            </cue>
                            <cue name="Ch1_Police_Cutscene_Speech_3">
                              <conditions>
                                <check_any>
                                  <event_speak_finished actor="$DalBusta" line="30220345" comment="First line of the speak"/>
                                  <event_speak_finished actor="$DalBusta" line="30220344" comment="First line of the speak"/>
                                  <event_speak_finished actor="$DalBusta" line="30221901" comment="First line of the speak"/>
                                </check_any>
                              </conditions>
                              <actions>
                                <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                  <text line="30221145" delay="3.5s" comment="This is Fau t'Nnt reporting on behalf of scanned vessel."/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Ch1_Police_Cutscene_Speech_4">
                              <conditions>
                                <event_speak_finished actor="$LoyalistActor" line="30221145" comment="First line of the speak"/>
                              </conditions>
                              <actions>
                                <speak actor="$Split_Police_Pilot" priority="100" comment="Plot relevant">
                                  <text line="3003" delay="0.5s" comment="Captain."/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Ch1_Police_Cutscene_Speech_5">
                              <conditions>
                                <event_speak_finished actor="$Split_Police_Pilot" line="3003" comment="First line of the speak"/>
                              </conditions>
                              <actions>
                                <do_if value="(player.entity.race == race.split) and not player.entity.isfemale">
                                  <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                    <text line="30221146" delay="0.5s" comment="He has been questioned."/>
                                  </speak>
                                  <do_if value="$LoyalistAngryness ge 0" comment="no dangerous opinions">
                                    <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                      <text line="30221149" delay="0.5s" comment="He passes."/>
                                      <text line="30221152" delay="0.5s" comment="Put his ID on whitelist."/>
                                    </speak>
                                  </do_if>
                                  <do_else comment="dangerous opinions">
                                    <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                      <text line="30221155" delay="0.5s" comment="This one has some dangerous opinions."/>
                                      <text line="30221157" delay="0.5s" comment="No imminent danger though."/>
                                    </speak>
                                  </do_else>
                                </do_if>
                                <do_elseif value="(player.entity.race == race.split) and player.entity.isfemale">
                                  <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                    <text line="30221147" delay="0.5s" comment="She has been questioned."/>
                                  </speak>
                                  <do_if value="$LoyalistAngryness ge 0" comment="no dangerous opinions">
                                    <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                      <text line="30221150" delay="0.5s" comment="She passes."/>
                                      <text line="30221153" delay="0.5s" comment="Put her ID on whitelist."/>
                                    </speak>
                                  </do_if>
                                  <do_else comment="dangerous opinions">
                                    <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                      <text line="30221155" delay="0.5s" comment="This one has some dangerous opinions.(female this one)"/>
                                      <text line="30221157" delay="0.5s" comment="No imminent danger though."/>
                                    </speak>
                                  </do_else>
                                </do_elseif>
                                <do_else>
                                  <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                    <text line="30221148" delay="0.5s" comment="The creature has been questioned."/>
                                  </speak>
                                  <do_if value="$LoyalistAngryness ge 0" comment="no dangerous opinions">
                                    <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                      <text line="30221151" delay="0.5s" comment="It passes."/>
                                      <text line="30221154" delay="0.5s" comment="Put its ID on whitelist."/>
                                    </speak>
                                  </do_if>
                                  <do_else comment="dangerous opinions">
                                    <speak actor="$LoyalistActor" priority="100" comment="Plot relevant">
                                      <text line="30221155" delay="0.5s" comment="This one has some dangerous opinions."/>
                                      <text line="30221157" delay="0.5s" comment="No imminent danger though."/>
                                    </speak>
                                  </do_else>
                                </do_else>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch1_Police_Control_Done">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Zyarth Police Captain -->
                    <set_entity_overrides entity="$LoyalistActor" icon="'shadyguy'" title="'{30221,158}'"/>
                    <set_objective cue="$MissionCue" action="objective.wait" comment="Stop guidance to the station the $LoyalistActor does not want to go to."/>

                    <do_if value="$LoyalistAngryness lt 0" comment="Dangerous Opinions">
                      <set_value name="$LoyalistLines" exact="[[if player.entity.isfemale then 30221161 else 30221160],
                                                           [if player.entity.isfemale then 30221163 else 30221162, 2s],
                                                           [30221206],
                                                           [if player.entity.isfemale then 30221167 else 30221166]]"/>
                    </do_if>
                    <do_else comment="No Dangerous Opinions">
                      <set_value name="$LoyalistLines" exact="[[if player.entity.isfemale then 30221161 else 30221160],
                                                           [if player.entity.isfemale then 30221165 else 30221164, 2s],
                                                           [30221206],
                                                           [if player.entity.isfemale then 30221167 else 30221166]]"/>
                    </do_else>
                  </actions>
                  <cues>
                    <cue name="Ch1_Loyalist_Hint_160_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"           value="[$LoyalistActor, $DalBusta]"/>
                      <param name="CutsceneKey"     value="[$LoyalistCutsceneKey, $DalCutsceneKey]"/>
                      <param name="DelayInitial"    value="[5s, 1s]"/>
                      <param name="Lines"           value="[$LoyalistLines, [[30220607], [30221902],
                                                                             [30221903, 1s], [30221904], 
                                                                             [30221905, 1.5s]
                                                                              ]
                                                           ]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"    value="[null, Ch1_Logbook]"/>
                      <!--
        Loyalist: <t id="30221160">Since you showed interest in Split culture...</t>
                  <t id="30221161">(spoken to female 'you'){,30221160}</t>
                  <t id="30221162">have friend who might talk some sense into you.</t>
                  <t id="30221163">(spoken to female 'you'){,30221162}</t>
                  <t id="30221164">have friend you can discuss Split matters with.</t>
                  <t id="30221165">(spoken to female 'you'){,30221164}</t>
                  <add_npc_line hidechoices="true" line="30221206" comment="That reckless Split always find trouble."/>
                  <t id="30221166">Sending you her contact details.</t>
                  <t id="30221167">(spoken to female 'you'){,30221166}</t>
        DAL:          
                  <t id="30220607">Well, that was unexpected.</t>
        not used: <t id="30221168">Looks like the only thing he was smuggling was himself!</t>
                  
                  <t id="30221902">Looks like our suspect was scouting newcomers for the Zyarth authorities.
                  <t id="30221903">Connections to the Zyarth Patriarchy won't get us anywhere.
                  <t id="30221904">The contact he provided, however, definitely belongs to the Free Families.
                  <t id="30221905">I have a possible location for her, but she won't be that easy to actually get hold of.
                  
       not used   <t id="30202183">Very well then.</t>
        not used: <t id="30202130">That could have gone better.</t>
       not used:  <t id="30220663">This is it, my friend.</t>
       not used:  <t id="30220664">(spoken to female player){10111,30220663}</t>
                  <t id="30220353">I have the ID of the ship we're supposed to find.</t>
                  
     use later     <t id="30221180">We're looking for Yu t'Knk of Family Zyarth.</t>
     use later     <t id="30221181">Don't let the family name fool you. She belonged to Family Gau before it was defeated by, and integrated into, Family Zyarth.</t>
     use later     <t id="30221182">(spoken to female 'you'){,30221181}</t>
     not used     <t id="30221202">Doing her a favour could earn us the friend we need.</t>
     not used     <t id="30221203">Let's start by getting you to the sector she's in.</t>
     not used     <t id="30221204">(spoken to female 'you'){,30221203}</t>
     not used     <t id="30221205">So, um...(guilty) the downside is that we have a little problem with this contact.</t>
                  -->
                    </cue>

                    <cue name="Ch1_Logbook">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$Ch1_RemoveMissionLater" comment="running mission required for npc call mission"/>
                        <!--<remove_mission cue="$MissionCue" type="completed"/>-->
                        <set_value name="$Description" exact="if player.entity.isfemale then {30221,1107} else {30221,1106}"/>
                        <set_value name="$Description" exact="$Description + '\n\n'"/>
                        <set_value name="$LoyalistAngryness" exact="if $LoyalistAngryness? then $LoyalistAngryness else 0" comment="Debugging"/>
                        <do_if value="$LoyalistAngryness ge 0" comment="no dangerous opinions">
                          <set_value name="$Description" exact="$Description + (if player.entity.isfemale then {30221,1109} else {30221,1108})"/>
                        </do_if>
                        <do_else>
                          <set_value name="$Description" exact="$Description + (if player.entity.isfemale then {30221,1111} else {30221,1110})"/>
                        </do_else>
                        <!--<write_to_logbook category="missions" faction="faction.player" title="{30221,1101}" text="if player.entity.isfemale then ({30221,807}) else ({30221,806})"/>-->

                        <signal_cue cue="Ch2_Study"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
              <!--
              FIND: Hall of Judgement + Police in Sector (Divert from other if none, maybe spawn one?)
              MOVE: Police to gate
              FORCE: ... Eventy thing, ask Owen about his encounter thing.
                  > Dialogue something, checking which start the player had
              Put this in the Reconnection_Transport one
              -->

            </cue>
          </cues>
        </cue>

        <cue name="Ch2_Study" comment="Text IDs 200" version="2">
          <!-- 1. Track the escaped Slave Ship, Boso/Dal line variations for falsely checking out: Wreckage, Abandoned Ship (get in), Asteroid -->
          <!-- 2. Found Slave Ship: Comm, shoot turrets or ship, dock for passenger -->
          <!-- 3. "Slave Trader" jumps in, Land on Slave Trader, Talk to Curb -->
          <!-- 4. Deliver Caviar (Curb in Cockpit in front of the Accelerator for Funeral Reasons), Funeral (Cut)-Scene, Talk to Guests -->
          <!-- 5. Pick up Dal at Trading Station, Satellite Scan, Defence Drone Escape -->
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <cancel_cue cue="Ch1_Arrival"/>

            <do_if value="$PoliceShip? and $PoliceShip.exists">
              <cancel_all_orders object="$PoliceShip"/>
              <create_order object="$PoliceShip" id="'MoveDie'" immediate="true">
                <param name="byidle" value="false"/>
                <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
              </create_order>
            </do_if>

            <find_sector name="$Closest" sortbydistanceto="player.entity" multiple="false"/>
            <set_value name="$Ch2_ScavengerHuntSector" exact="if $Ch2_ScavengerHuntSector? then $Ch2_ScavengerHuntSector else $Closest"/>
          </actions>
          <patch sinceversion="2" state="complete">
            <do_if value="$PoliceShip? and $PoliceShip.exists">
              <cancel_all_orders object="$PoliceShip"/>
              <create_order object="$PoliceShip" id="'MoveDie'" immediate="true">
                <param name="byidle" value="false"/>
                <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
              </create_order>
            </do_if>
          </patch>
          <patch sinceversion="2" state="cancelled">
            <do_if value="$PoliceShip? and $PoliceShip.exists">
              <cancel_all_orders object="$PoliceShip"/>
              <create_order object="$PoliceShip" id="'MoveDie'" immediate="true">
                <param name="byidle" value="false"/>
                <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
              </create_order>
            </do_if>
          </patch>
          <cues>

            <cue name="Ch2_Study_Retrieve_Person">
              <!-- Variant on RetrieveItem and TransportPassenger
                 Shoot a Ship until it gives up, then land and automatically wait for Passenger -->

              <actions>
                <!-- Variables in case this mission is resetted -->
                <do_if value="not $Surrendered?">
                  <set_value name="$Surrendered" exact="false"/>
                </do_if>

                <do_if value="not $Study_Retrieve_Person_Setup?">
                  <set_value name="$Study_Retrieve_Person_Setup" exact="true"/>

                  <!-- One-Time setup Variables -->
                  <set_value name="$StartStep"            exact="1"/>
                </do_if>
              </actions>
              <cues>
                <cue name="Ch2_Spawn_GetawayShip_Init">
                  <actions>
                    <signal_cue cue="Ch2_Spawn_GetawayShip"/>
                  </actions>
                </cue>
                <cue name="Ch2_Spawn_GetawayShip">
                  <!-- Resets self until a freesplit and argon station can be found -->
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="0.5s"/>
                  <actions>
                    <create_loadout result="$loadout">
                      <macros>
                        <!--<engine macro="engine_spl_m_combat_01_mk1_macro"    path="../con_engine_01" />-->
                        <engine macro="engine_spl_m_combat_01_mk1_macro"    path="../con_engine_02" />
                        <!--<engine macro="engine_spl_m_combat_01_mk1_macro"    path="../con_engine_03" />-->
                        <weapon macro="weapon_gen_m_laser_01_mk1_macro"     path="../con_weapon_01"/>
                        <weapon macro="weapon_gen_m_laser_01_mk1_macro"     path="../con_weapon_02"/>
                        <weapon macro="weapon_gen_m_laser_01_mk1_macro"     path="../con_weapon_03"/>
                        <shield macro="shield_spl_m_standard_01_mk1_macro"  path="../con_shield_01"/>
                        <shield macro="shield_spl_m_standard_01_mk1_macro"  path="../con_shield_02"/>
                        <!-- skipping attempt to apply group loadout for invalid macro path '../con_turret_01'
                      -->
                        <turret macro="turret_spl_m_flak_01_mk1_macro"      path="../con_turret_01_r" optional="0"/>
                        <turret macro="turret_spl_m_flak_01_mk1_macro"      path="../con_turret_01_l" optional="0"/>
                        <turret macro="turret_spl_m_flak_01_mk1_macro"      path="../con_turret_02_r" optional="0"/>
                        <turret macro="turret_spl_m_flak_01_mk1_macro"      path="../con_turret_02_l" optional="0"/>
                      </macros>
                      <virtualmacros>
                        <thruster macro="thruster_gen_m_combat_01_mk3_macro" />
                      </virtualmacros>
                    </create_loadout>

                    <set_value name="$Ch2_Spawn_Setup_Successful" exact="false"/>
                    <do_all exact="1" comment="Handling Break-Cases (instead of nisting do_if)">

                      <!-- Find the closest Free Families (Split) Sector to start this mission on -->
                      <set_value name="$Faction" exact="faction.freesplit"/>
                      <set_value name="$TargetLocation" exact="player.entity"/>
                      <run_actions ref="md.LIB_Generic.FindNearestStationForFaction" result="$SuitableStation">
                        <param name="Faction" value="$Faction"/>
                        <param name="TargetLocation" value="$TargetLocation"/>
                        <param name="UselocalHighways" value="true"/>
                      </run_actions>
                      <do_if value="not $SuitableStation.exists">
                        <!--<signal_cue_instantly cue="WaitForFactionToHaveStations" param="[faction.freesplit, this]" comment="faction, signalcue"/>-->
                        <signal_cue_instantly cue="WaitForFactionToHaveStations_Handler" param="table[$Faction = faction.freesplit,
                                                                                                      $SignalCue = this]"/>
                        <reset_cue cue="this"/>
                        <break/>
                      </do_if>
                      <set_value name="$EscapeFromSector" exact="$SuitableStation.sector"/>

                      <!-- Find the closest Argon station towards the escape-sector [TODO: Allow Antigone, Teladi, null or something] -->
                      <set_value name="$Faction" exact="faction.argon"/>
                      <set_value name="$TargetLocation" exact="$EscapeFromSector"/>
                      <run_actions ref="md.LIB_Generic.FindNearestStationForFaction" result="$SuitableStation">
                        <param name="Faction" value="$Faction"/>
                        <param name="TargetLocation" value="$TargetLocation"/>
                        <param name="UselocalHighways" value="true"/>
                      </run_actions>
                      <set_value name="$EscapeToStation" exact="$SuitableStation" comment="Where the Argons try to escape to, might be null"/>
                      <do_if value="not $EscapeToStation.exists">
                        <!--<signal_cue_instantly cue="WaitForFactionToHaveStations" param="[faction.argon, this]" comment="faction, signalcue"/>-->
                        <signal_cue_instantly cue="WaitForFactionToHaveStations_Handler" param="table[$Faction = faction.argon,
                                                                                                      $SignalCue = this]"/>
                        <reset_cue cue="this"/>
                        <break/>
                      </do_if>

                      <!-- Find the furthest away Free Families (Split) station in the escape-sector -->
                      <set_value name="$TargetLocation" exact="if $EscapeToStation? then $EscapeToStation else null"/>
                      <set_value name="$EscapeFromStation" exact="null"/>
                      <set_value name="$EscapeFromStation_DifferentSector" exact="null"/>
                      <set_value name="$EscapeFromStation_Close" exact="null"/>
                      <set_value name="$Faction" exact="faction.freesplit"/>
                      <run_actions ref="md.LIB_Generic.FindStationsForFactionByDistance" result="$Out_StationsByDistance">
                        <param name="Faction" value="$Faction"/>
                        <param name="TargetLocation" value="if $TargetLocation then $TargetLocation else player.entity"/>
                        <param name="UselocalHighways" value="true"/>
                      </run_actions>
                      <do_if value="not $Out_StationsByDistance.count">
                        <!--<signal_cue_instantly cue="WaitForFactionToHaveStations" param="[faction.freesplit, this]" comment="faction, signalcue"/>-->
                        <signal_cue_instantly cue="WaitForFactionToHaveStations_Handler" param="table[$Faction = faction.freesplit,
                                                                                                      $SignalCue = this]"/>
                        <reset_cue cue="this"/>
                        <break/>
                      </do_if>

                      <do_all exact="$Out_StationsByDistance.count" counter="$s" reverse="true" comment="find the furthest away one">
                        <set_value name="$station" exact="$Out_StationsByDistance.{$s}"/>
                        <do_if value="($station.distanceto.{player.entity} gt 42km)
                              and ($station.sector == $EscapeFromSector)" comment="spawn in the player sector but not in player sight">
                          <set_value name="$EscapeFromStation" exact="$station"/>
                          <remove_value name="$Out_StationsByDistance"/>
                          <break/>
                        </do_if>
                        <do_elseif value="($station.sector != $EscapeFromSector)">
                          <set_value name="$EscapeFromStation_DifferentSector" exact="$station"/>
                        </do_elseif>
                        <do_else>
                          <set_value name="$EscapeFromStation_Close" exact="$station"/>
                        </do_else>
                      </do_all>
                      <remove_value name="$Out_StationsByDistance"/>
                      <!-- If no furthest FRF station in the sector could be found, try another sector or a station closeby-->
                      <do_if value="not $EscapeFromStation" comment="Use any of the alternative stations found">
                        <do_if value="$EscapeFromStation_DifferentSector">
                          <set_value name="$EscapeFromStation" exact="$EscapeFromStation_DifferentSector"/>
                          <debug_text text="'Chose $EscapeFromStation_DifferentSector'" chance="$DebugChance"/>
                        </do_if>
                        <do_elseif value="$EscapeFromStation_Close">
                          <set_value name="$EscapeFromStation" exact="$EscapeFromStation_Close"/>
                          <debug_text text="'Chose $EscapeFromStation_Close'" chance="$DebugChance"/>
                        </do_elseif>
                        <do_else>
                          <assert value="false" text="'no EscapeFromStation (freesplit) found even though there should be one [Heinrich]'"/>
                        </do_else>
                      </do_if>

                      <find_dockingbay name="$dock" object="$EscapeFromStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_m"/>
                      </find_dockingbay>
                      <debug_text text="'Dockingbay found: ' + $dock" chance="$DebugChance"/>

                      <set_value name="$EscapeFromDockingbay" exact="$dock"/>
                      <!--="if $dock then $dock else $EscapeFromStation"/-->

                      <set_value name="$Ch2_Spawn_Setup_Successful" exact="true"/>
                    </do_all>

                  </actions>
                  <cues>
                    <cue name="Ch2_Getaway_Cutscene_Delay" checkinterval="5s" version="2">
                      <conditions>
                        <check_all>
                          <check_value value="$Ch2_Spawn_Setup_Successful? and $Ch2_Spawn_Setup_Successful"/>
                          <check_value value="not player.isinfullscreenmenu"/>
                          <check_value value="$EscapeFromDockingbay.assignedship == null" comment="might never be true if the ship is stationary, .. "/>
                          <check_value value="player.sector" comment="null on player.zone.issuperhighway"/>
                        </check_all>
                      </conditions>
                      <actions>
                        <!-- We have to create the ship with the Cutscene,
                        otherwise the faction.civilian starts undocking it preemptively
                        and the cutscene loses the ship when the docking process finishes-->
                        <create_ship name="$GetawayShip_Cutscene" capturable="false" sector="player.sector" missioncue="namespace" macro="ship_spl_m_frigate_01_a_macro" dock="$EscapeFromDockingbay">
                          <owner exact="$EscapeFromStation.owner"/>
                          <loadout loadout="$loadout"/>
                          <pilot>
                            <select race="race.drone"/>
                          </pilot>
                          <people>
                            <fillpercent exact="8"/>
                            <person role="prisoner" weight="100">
                              <select race="race.split"/>
                              <!--testing, probably rather passengers-->
                            </person>
                            <!-- Add a "Prisoner" person Split .. -->
                          </people>
                          <paint ware="$PaintMod_GetawayShip"/>
                        </create_ship>
                        <set_object_relation_behaviour object="$GetawayShip_Cutscene" disable="true"/>
                        <set_object_min_hull object="$GetawayShip_Cutscene" exact="50"/>
                        <set_object_docking_enabled object="$GetawayShip_Cutscene" enabled="false"/>

                        <!-- Create a 2nd Ship to be moved closeby -->
                        <create_ship name="$Ch2_SlaveTraderShip" capturable="false" sector="$TharkasRavine2" missioncue="namespace" macro="ship_spl_l_trans_container_01_a_macro" commandeerable="false" >
                          <!-- zone="$EscapeFromStation.zone" -->
                          <owner exact="faction.freesplit" overridenpc="true"/>
                          <loadout ref="story_split_slavetrader"/>
                          <people>
                            <fillpercent exact="0"/>
                          </people>
                          <paint ware="$PaintMod_SlaveTrader"/>
                          <loadout ref="story_split_slavetrader"/>
                          <pilot>
                            <select faction="faction.freesplit" tags="tag.fighterpilot"/>
                          </pilot>
                        </create_ship>
                        <set_relation_boost value="$RelationBoostDocking" decay="0" object="$Ch2_SlaveTraderShip" otherobject="player.entity"/>
                        <set_object_relation_behaviour object="$Ch2_SlaveTraderShip" disable="true"/>
                        <set_object_name object="$Ch2_SlaveTraderShip" page="30221" line="206" comment="Slave Trader 3"/>
                        <set_object_min_hull object="$Ch2_SlaveTraderShip" exact="50"/>
                        <create_order id="'Wait'" object="$Ch2_SlaveTraderShip" default="true">
                          <param name="noattackresponse" value="true"/>
                        </create_order>

                        <!-- Argon Crew, Split Hostage should not be piloting-->
                        <!-- Start the Mission Ship from the closest FF Dock, target somewhere in space behind asteroids or something ? -->

                        <!-- After the mission the ship turns Argon and tries to reach $EscapeToStation. On success the player gets reputation with the Argon -->

                        <precache_hint target="$GetawayShip_Cutscene"/>
                        <precache_hint target="$EscapeFromStation"/>

                        <create_order id="'Flee'" object="$GetawayShip_Cutscene" immediate="true">
                          <param name="method" value="'boost'"/>
                          <param name="attacker" value="$EscapeFromStation"/>
                          <param name="donotdrop" value="true"/>
                          <param name="deploydistraction" value="true"/>
                          <param name="log" value="false"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>
                      </actions>
                      <patch sinceversion="2">
                        <set_relation_boost value="$RelationBoostDocking" decay="0" object="$Ch2_SlaveTraderShip" otherobject="player.entity"/>
                      </patch>
                      <cues>
                        <cue name="Ch2_Getaway_Cutscene_Play">
                          <actions>
                            <play_cutscene key="'Cutscene_undock_m'" targetmonitor="true" result="$CutsceneID" >
                              <param name="ship" object="$GetawayShip_Cutscene"/>
                            </play_cutscene>
                            <set_value name="$Dal_Lines_On_Getaway" exact="[
                                     [30221209],
                                     [30221210],
                                     [30221211],
                                     [30221202]
                                         ]"/>
                            <do_if value="player.ship.exists and (not player.ship.isclass.{class.ship_s})">
                              <append_to_list name="$Dal_Lines_On_Getaway" exact="[if player.entity.isfemale then 30221216 else 30221215]"/>
                              <append_to_list name="$Dal_Lines_On_Getaway" exact="[30221217]"/>
                            </do_if>
                            <!--<append_to_list name="$Dal_Lines_On_Getaway" exact="[if player.entity.isfemale then 30221287 else 30221212]"/>-->
                            <append_to_list name="$Dal_Lines_On_Getaway" exact="[if player.entity.isfemale then 30221288 else 30221213]"/>
                            <!--       <append_to_list name="$Dal_Lines_On_Getaway" exact="[30221214]"/>
         not used      Dal	  <t id="30221212	">	Boso will help you track them down so that we can negotiate the hostage's release.
                       Dal	  	287		(spoken to female 'you'){,30221212}
                       Dal	  <t id="30221213	">	Be aware that the Patriarchy police are also looking for this ship.
                       Dal	  	288		(spoken to female 'you'){,30221213}
                   not used	  <t id="30221214	">	Should the opportunity arise, we could also try and give the slaves a helping hand.-->
                          </actions>
                          <cues>
                            <cue name="Ch2_Getaway_Cutscene_Subtitles">
                              <conditions>
                                <event_cutscene_started key="'Cutscene_undock_m'"/>
                              </conditions>
                              <actions>
                                <speak actor="$DalBusta" priority="90" voiceover="true">
                                  <text line="if player.entity.isfemale then 30221207 else 30221206" comment="Have a look at this."/>
                                  <text line="30221208" comment="Recently there have been a number of slaves who have escaped their former masters."/>
                                </speak>
                              </actions>
                              <cues>
                                <cue name="Ch2_Getaway_Cutscene_Subtitles_Done">
                                  <conditions>
                                    <check_any>
                                      <!-- What if the speak got aborted? -->
                                      <event_speak_finished actor="$DalBusta" line="30221207"/>
                                      <event_speak_finished actor="$DalBusta" line="30221206"/>
                                    </check_any>
                                  </conditions>
                                  <delay exact="10s"/>
                                  <actions>
                                    <destroy_object explosion="false" object="$GetawayShip_Cutscene"/>
                                  </actions>
                                  <cues>
                                    <cue name="Ch2_Getaway_Cutscene_Dal_206" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor"             value="$DalBusta"/>
                                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                      <param name="Lines"             value="$Dal_Lines_On_Getaway"/>
                                      <!--                              
                              <t id="30221206">Have a look at this.</t>
                              <t id="30221207">(spoken to female 'you'){,30221206}</t>
                              <t id="30221208">Recently there have been a number of slaves who have escaped their former masters.</t>
                              <t id="30221209">This isn't the first instance of slave resistance since the gates opened.</t>
                              <t id="30221210">News of a strong Argon Federation elsewhere has inspired them with some hope.</t>
                              <t id="30221211">This lot, however, decided to take our Split friend hostage.</t>
                              <t id="30221202">Doing her a favour could earn us the friend we need.</t>
                              
                              IF Player is not on an S sized ship
                         TODO: @Heinrich if not said, retrigger those lines if the player switches into a bigger ship
                              <t id="30221215">To land on the fugitive ship, you need to be on board an S-sized ship.</t>
                              <t id="30221216">(spoken to female 'you'){,30221215}</t>
                              <t id="30221217">A bigger ship might be perceived as threatening, and could complicate the release of the hostage.</t>
                              -->
                                      <param name="MissionCue"        value="if $Ch1_RemoveMissionLater? then $MissionCue else null"/>
                                      <param name="IsInMission"       value="$Ch1_RemoveMissionLater?"/>
                                      <param name="EndSignalCue"      value="Ch2_Retrieve_Person_Create_Offer"/>
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="DEBUG_Takeover_Stations_To_FRF">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_sector name="this.$sector1" macro="macro.cluster_409_sector001_macro" comment="Tharka's Ravine 1"/>
                    <find_sector name="this.$sector2" macro="macro.cluster_410_sector001_macro" comment="Tharka's Ravine 2"/>
                    <find_sector name="this.$sector3" macro="macro.cluster_412_sector001_macro" comment="Tharka's Ravine 3"/>
                    <find_sector name="this.$sector4" macro="macro.cluster_413_sector001_macro" comment="Tharka's Ravine 4"/>
                    <find_sector name="this.$sector5" macro="macro.cluster_411_sector001_macro" comment="Heart of Acrimony"/>
                    <find_station name="this.$defencestations" space="this.$sector1" multiple="true"/>
                    <find_station name="this.$defencestations" space="this.$sector2" multiple="true" append="true"/>
                    <find_station name="this.$defencestations" space="this.$sector3" multiple="true" append="true"/>
                    <find_station name="this.$defencestations" space="this.$sector4" multiple="true" append="true"/>
                    <find_station name="this.$defencestations" space="this.$sector5" multiple="true" append="true"/>
                  </actions>
                  <cues>
                    <cue name="DEBUG_Takeover_Stations_To_FRF_2" ref="md.LIB_Generic.TakeoverStations">
                      <param name="Stations" value="parent.$defencestations"/>
                      <param name="TargetFaction" value="faction.freesplit"/>
                      <param name="SuccessSignalCue" value="null"/>
                      <param name="Delay" value="[2s,3s]"/>
                      <param name="Chance" value="100"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_Retrieve_Person_Create_Offer">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Cleanup Ch1 mission -->
                    <do_if value="$Ch1_RemoveMissionLater?">
                      <remove_mission cue="$MissionCue" type="completed"/>
                      <write_to_logbook category="missions" faction="faction.player" title="{30221,1101}" text="if player.entity.isfemale then ({30221,807}) else ({30221,806})"/>
                    </do_if>

                    <!-- Mission: Rebellious Thralls -->
                    <set_value name="$MissionDescription" exact="if player.entity.isfemale then {30221,2003} else {30221,2002}"/>
                    <create_mission cue="$MissionCue" abortable="false" name="{30221,2001}" faction="faction.player" group="missiongroup.story_split"
                                    difficulty="level.medium" rewardtext="{30221,2099}" type="missiontype.plot"
                                    description="$MissionDescription" comment="Mission: Rebellious Thralls"
                                    icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
                      <briefing>
                        <!-- maybe add "objective.find" followed by .attack -->
                        <objective step="1"       action="objective.find"             text="$OutcastActor.knownname"/>
                        <objective step="2"       action="objective.transport"        text="$OutcastActor.knownname"/>
                      </briefing>
                    </create_mission>
                    <set_objective_from_briefing cue="$MissionCue" step="1"/>

                    <signal_cue cue="Ch2_Find_GetawayShip"/>
                    <!--<do_if value="$Surrendered">
                      <signal_cue cue="Ch2_Surrendered_GetawayShip"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch2_Engage_GetawayShip"/>
                    </do_else>-->
                  </actions>
                </cue>

                <cue name="Ch2_Find_GetawayShip_Failed" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="60s"/>
                  <actions>
                    <signal_cue cue="Ch2_Find_GetawayShip"/>
                  </actions>
                </cue>

                <cue name="Ch2_Find_GetawayShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Find 4 Locations leading the player towards the Funeral,
                    * Not Argon Owned, possible to add a Split Patrol to the mix -->
                    <get_global_path multiple="true" component="$pathComponents" uselocalhighways="true">
                      <start object="$Ch2_ScavengerHuntSector"/>
                      <end object="$TharkasRavine2"/>
                    </get_global_path>
                    <do_if value="not $pathComponents.count" comment="empty path, possibly player in a disconnected sector">
                      <signal_cue cue="Ch2_Find_GetawayShip_Failed"/>
                      <reset_cue cue="this"/>
                    </do_if>
                    <do_else>
                      <create_list name="$SectorsAlongTheWay"/>
                      <create_list name="$SectorsAlongTheWayWithoutArgonSectors" comment="used if there are enough of them"/>
                      <!-- TODO: Maybe also cut out hostile sectors so that the objectives aren't heavily guarded in Split Space -->
                      <set_value name="$EntryGatesAlongTheWay" exact="table[]"/>
                      <set_value name="$ExitGatesAlongTheWay" exact="table[]"/>


                      <!-- Set last Exit Gate -->
                      <find_gate name="$Gates" multiple="true" space="$TharkasRavine2"/>
                      <do_for_each in="$Gates" name="$g">
                        <do_if value="$g.isactive and $g.exit.sector == $HeartOfAcrimonySector">
                          <set_value name="$ExitGatesAlongTheWay.{$TharkasRavine2}" exact="$g"/>
                          <break/>
                        </do_if>
                      </do_for_each>

                      <do_for_each in="$pathComponents" name="$component">
                        <set_value name="$componentSector" exact="if $component.isclass.{class.sector} then $component else $component.sector"/>

                        <do_if value="not $component.isclass.{class.highway}">
                          <do_if value="not $SectorsAlongTheWay.indexof.{$componentSector}">
                            <append_to_list name="$SectorsAlongTheWay" exact="$componentSector"/>
                            <do_if value="$component.isclass.{class.gate} or $component.isclass.{class.highwayexitgate}">
                              <!-- Add to Entry Gates -->
                              <set_value name="$EntryGatesAlongTheWay.{$componentSector}" exact="$component"/>
                            </do_if>
                            <do_if value="$componentSector.owner != faction.argon">
                              <append_to_list name="$SectorsAlongTheWayWithoutArgonSectors" exact="$componentSector"/>
                            </do_if>
                          </do_if>
                          <do_else>
                            <do_if value="$component.isclass.{class.gate} or $component.isclass.{class.highwayentrygate}">
                              <!-- Add to Exit Gates -->
                              <set_value name="$ExitGatesAlongTheWay.{$componentSector}" exact="$component"/>
                            </do_if>
                          </do_else>
                        </do_if>
                      </do_for_each>
                      <!-- Set first Entry Gate -->
                      <do_if value="$Ch2_ScavengerHuntEntryGate? and $Ch2_ScavengerHuntEntryGate != null">
                        <set_value name="$EntryGatesAlongTheWay.{$Ch2_ScavengerHuntSector}" exact="$Ch2_ScavengerHuntEntryGate"/>
                      </do_if>
                      <do_else>
                        <find_gate name="$Gates" multiple="true" space="$Ch2_ScavengerHuntSector" active="true"
                                   sortbydistanceto="$ExitGatesAlongTheWay.{$Ch2_ScavengerHuntSector}"/>
                        <assert value="$Gates.count ge 1" text="'@Heinrich Found only 1 or less gates!'"/>
                        <do_for_each in="$Gates" name="$g">
                          <do_if value="$g != $ExitGatesAlongTheWay.{$Ch2_ScavengerHuntSector}">
                            <set_value name="$EntryGatesAlongTheWay.{$Ch2_ScavengerHuntSector}" exact="$g"/>
                            <break/>
                          </do_if>
                        </do_for_each>
                      </do_else>

                      <assert value="$SectorsAlongTheWay.count" text="'@Heinrich - List should have at least the $TargetGate sector in it. [Ch2]'"/>

                      <set_value name="$SectorsAlongTheWay" exact="if $SectorsAlongTheWayWithoutArgonSectors.count
                                                               then $SectorsAlongTheWayWithoutArgonSectors
                                                               else $SectorsAlongTheWay"/>

                      <set_value name="$Ch2_SectorWreckage" exact="$SectorsAlongTheWay.{[($SectorsAlongTheWay.count - 2), 1].max}"/>
                      <set_value name="$Ch2_SectorRock"     exact="$SectorsAlongTheWay.{[($SectorsAlongTheWay.count - 1), 1].max}"/>
                      <!--  RESCUE $TwoGrand // $Ch2_ScavengerHuntSector -->
                      <!--  Found Wreckage  -->
                      <!--  Found Rock -->
                      <!--  Correct one $Ravine -->
                    </do_else>
                  </actions>
                  <cues>
                    <cue name="Ch2_GetAway_Positions">
                      <actions>
                        <create_group groupname="$InvestigationLocations"/>
                        <!-- TODO @Heinrich Allow to skip targets -->
                      </actions>
                      <cues>
                        <cue name="Ch2_Investigate" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <!-- Called when the group gets new elements or loses any -->
                          <actions>
                            <!-- Find closest, set guidance to closest -->
                            <set_value name="$lowestdistance" exact="null"/>
                            <set_value name="$DistanceFrom" exact="player.entity"/>
                            <set_value name="$UselocalHighways" exact="false"/>
                            <set_value name="$closest" exact="null"/>
                            <do_for_each in="$InvestigationLocations" name="$i">
                              <!--<estimate_travel_time result="$time" start="player.entity"  target="$i"
                                                    ship="player.ship"/>-->
                              <!--
                                extensions\ego_dlc_split\md\Story_Split.xml(2896): Must provide either ship or all engine parameters
                                                      speed="1" travelattack="1" travelcharge="1" travelfactor="1"-->
                              <!--<estimate_travel_time result="$time" start="player.entity"  target="$i" uselocalhighways="true"
                                                    speed="1" travelattack="1" travelcharge="1" travelfactor="1"/>-->
                              <set_value name="$DistanceTo" exact="$i"/>
                              <get_global_path resultdistance="$DistanceTotal" component="$Path_Components" uselocalhighways="$UselocalHighways">
                                <start object="$DistanceFrom"/>
                                <end object="$DistanceTo"/>
                              </get_global_path>
                              <do_if value="$DistanceTotal ge 0">
                                <do_if value="($lowestdistance == null)">
                                  <set_value name="$closest" exact="$i"/>
                                  <set_value name="$lowestdistance" exact="$DistanceTotal"/>
                                </do_if>
                                <do_elseif value="$DistanceTotal lt $lowestdistance">
                                  <set_value name="$closest" exact="$i"/>
                                  <set_value name="$lowestdistance" exact="$DistanceTotal"/>
                                </do_elseif>
                              </do_if>
                            </do_for_each>
                            <remove_value name="$Path_Components"/>

                            <do_if value="not $closest" comment="remains null if DistanceAcrossClusters fails to path (disconnected sector case)">
                              <set_value name="$closest" exact="$InvestigationLocations.{1}"/>
                            </do_if>

                            <create_position name="$DistractionLocation" object="$closest" space="$closest.sector"/>
                            <!-- offset="$DistractionLocation" -->

                            <set_value name="$silentUpdate" exact="false"/>
                            <do_if value="not $CurrentInvestigationTarget?" comment="Var to decide if the target was changed to update silently">
                              <set_value name="$CurrentInvestigationTarget" exact="$closest"/>
                            </do_if>
                            <do_elseif value="$CurrentInvestigationTarget == $closest">
                              <set_value name="$silentUpdate" exact="true"/>
                            </do_elseif>
                            <do_else>
                              <set_value name="$CurrentInvestigationTarget" exact="$closest"/>
                            </do_else>

                            <set_value name="$AtClaimShip" exact="false"/>
                            <set_objective cue="$MissionCue" action="objective.investigate" offset="$DistractionLocation" object="$closest.sector" radius="5km" text="readtext.{20204}.{6701}" comment="Hijacked Ship" silent="$silentUpdate"/>
                          </actions>
                        </cue>
                        <cue name="Ch2_Investigate_Loop">
                          <!--<delay exact="if $InvestigateLoopDelay? then $InvestigateLoopDelay else 113s"/>-->
                          <delay exact="31s"/>
                          <actions>
                            <!--<do_if value="$CurrentInvestigationTarget? and $GetawayShip?">
                              <set_value name="$InvestigateLoopDelay" exact="if ($CurrentInvestigationTarget == $GetawayShip) then 7s else 113s"/>
                            </do_if>-->
                            <do_if value="not $AtClaimShip">
                              <signal_cue cue="Ch2_Investigate"/>
                            </do_if>
                            <reset_cue cue="this"/>
                          </actions>
                        </cue>

                        <cue name="Ch2_ScavengerHunt_1" version="2">
                          <!-- $Ch2_ScavengerHuntSector -->
                          <!-- RESCUE SHIP-->
                          <actions>
                            <set_value name="$FromObject" exact="$EntryGatesAlongTheWay.{$Ch2_ScavengerHuntSector}"/>
                            <set_value name="$ToObject"   exact="$ExitGatesAlongTheWay.{$Ch2_ScavengerHuntSector}"/>
                            <assert value="$FromObject != $ToObject" text="'@Heinrich EntryGate and ExitGate should never be the same.'"/>

                            <!-- Find a position halfway towards -->
                            <set_value name="$Distance01" exact="0.2"  comment="range [0,1] where 0 is location of FromObject and 1 is location of ToObject"/>
                            <!-- TODO: @Heinrich, make sure distance01 + random offset don't end up right next to the gate or behind it,
                                       also add failsafes if everything happens in the same sector (by using 0.2, 0.4, 0.6, 0.8 e.g.)-->
                            <set_value name="$DistanceFromTo" exact="$FromObject.distanceto.{$ToObject} * $Distance01"/>

                            <create_position name="$TargetOrigin" object="$ToObject" space="$FromObject.zone"/>
                            <create_orientation name="$Rotation" orientation="look_at" refposition="$TargetOrigin">
                              <position  object="$FromObject" space="$FromObject.zone"/>
                            </create_orientation>
                            <create_position name="$Location" x="$FromObject.position.x + sin($Rotation.yaw) * $DistanceFromTo" y="0" z="$FromObject.position.z + cos($Rotation.yaw) * $DistanceFromTo"/>

                            <create_position name="$Offset" x="$Location.x" y="$Location.y" z="$Location.z" space="$FromObject.sector" min="20km" max="50km"/>

                            <create_loadout result="$loadout">
                              <macros>
                                <!--<engine macro="engine_spl_m_combat_01_mk1_macro"    path="../con_engine_01" />-->
                                <engine macro="engine_spl_m_combat_01_mk1_macro"    path="../con_engine_02" />
                                <!--<engine macro="engine_spl_m_combat_01_mk1_macro"    path="../con_engine_03" />-->
                                <weapon macro="weapon_gen_m_laser_01_mk1_macro"     path="../con_weapon_01"/>
                                <weapon macro="weapon_gen_m_laser_01_mk1_macro"     path="../con_weapon_02"/>
                                <weapon macro="weapon_gen_m_laser_01_mk1_macro"     path="../con_weapon_03"/>
                                <shield macro="shield_spl_m_standard_01_mk1_macro"  path="../con_shield_01"/>
                                <shield macro="shield_spl_m_standard_01_mk1_macro"  path="../con_shield_02"/>
                                <!-- skipping attempt to apply group loadout for invalid macro path '../con_turret_01'
                                -->
                                <turret macro="turret_spl_m_flak_01_mk1_macro"      path="../con_turret_01_r" optional="0"/>
                                <turret macro="turret_spl_m_flak_01_mk1_macro"      path="../con_turret_01_l" optional="0"/>
                                <turret macro="turret_spl_m_flak_01_mk1_macro"      path="../con_turret_02_r" optional="0"/>
                                <turret macro="turret_spl_m_flak_01_mk1_macro"      path="../con_turret_02_l" optional="0"/>
                              </macros>
                              <virtualmacros>
                                <thruster macro="thruster_gen_m_combat_01_mk3_macro" />
                              </virtualmacros>
                            </create_loadout>
                            <create_ship name="$SalvageShip" capturable="true" sector="$Ch2_ScavengerHuntSector"
                                         macro="ship_spl_m_frigate_01_a_macro" missioncue="namespace">
                              <people>
                                <fillpercent exact="0"/>
                              </people>
                              <loadout loadout="$loadout"/>
                              <owner exact="faction.ownerless"/>
                              <paint ware="$PaintMod_GetawayShip"/>
                              <pilot actor="null" />
                              <safepos value="$Offset" />
                            </create_ship>
                            <add_to_group groupname="global.$IgnoredAbandonedShips" object="$SalvageShip" comment="prevent i.e. Yaki from claiming the ship"/>
                            <set_object_min_hull object="$SalvageShip" exact="5"/>
                            <set_object_hull object="$SalvageShip" exact="14"/>
                            <set_object_docking_enabled object="$SalvageShip" enabled="false"/>
                            <set_object_radar_visible object="$SalvageShip" visible="true"/>
                            <add_to_group groupname="$InvestigationLocations" object="$SalvageShip"/>
                            <signal_cue cue="Ch2_Investigate"/>
                          </actions>
                          <patch sinceversion="2">
                            <do_if value="$SalvageShip.exists">
                              <set_object_capturable object="$SalvageShip" capturable="true"/>
                              <add_to_group groupname="global.$IgnoredAbandonedShips" object="$SalvageShip" comment="prevent i.e. Yaki from claiming the ship"/>
                            </do_if>
                          </patch>
                          <patch sinceversion="2" state="cancelled">
                            <do_if value="$SalvageShip.exists">
                              <set_object_capturable object="$SalvageShip" capturable="true"/>
                              <add_to_group groupname="global.$IgnoredAbandonedShips" object="$SalvageShip" comment="prevent i.e. Yaki from claiming the ship"/>
                            </do_if>
                          </patch>
                          <cues>
                            <cue name="Ch2_PlayerReachedLocation1_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachObject"    value="player.entity"/>
                              <param name="ApproachTarget"    value="$SalvageShip"/>
                              <param name="ApproachDistance"  value="4km"/>
                              <param name="SuccessSignalCue"  value="Ch2_Getaway_Salvage_Boso_226"/>
                            </cue>
                            <cue name="Ch2_Getaway_Salvage_Boso_226">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch2_Getaway_Salvage_Boso_226_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$BosoTa"/>
                                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                                  <param name="Lines"             value="[[30221226], [30221227], [30221228],
                                                              [if player.entity.isfemale then 30221230 else 30221229]]"/>
                                  <!--
                                   Boso	<t id="30221226	">	This vessel fits the type, but I am not sure if it is indeed the correct one.
                                   Boso	<t id="30221227	">	This one appears to have been abandoned.
                                   Boso	<t id="30221228	">	How strange.
                                   Boso	<t id="30221229	">	You should try to gain entry to it, so that we can extract more details from the ship's internal logs.
                                   Boso	<t id="30221230	">	(spoken to female 'you'){,30221229}-->
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="Ch2_Getaway_Salvage_Gain_Entry_Objective"/>
                                </cue>
                              </cues>
                            </cue>
                            <cue name="Ch2_Getaway_Salvage_Gain_Entry_Objective">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <do_if value="not $SalvageShipSecured?">
                                  <set_value name="$AtClaimShip" exact="true"/>
                                  <set_objective cue="$MissionCue" action="objective.secure" object="$SalvageShip"/>
                                </do_if>
                              </actions>
                              <cues>
                                <cue name="Ch2_Getaway_Salvage_Help">
                                  <delay exact="5min"/>
                                  <cues>
                                    <cue name="Ch2_Getaway_Salvage_Help_LeakGuidance_Patch" onfail="cancel">
                                      <conditions>
                                        <check_value value="parent.state == cuestate.complete"/>
                                      </conditions>
                                      <actions>
                                        <signal_cue cue="Ch2_Getaway_Salvage_Help_LeakGuidance"/>
                                      </actions>
                                    </cue>

                                    <cue name="Ch2_Getaway_Salvage_Help_LeakGuidance">
                                      <conditions>
                                        <check_any>
                                          <event_cue_completed cue="parent"/>
                                          <event_cue_signalled comment="patch case"/>
                                        </check_any>
                                      </conditions>
                                      <actions>
                                        <set_objective cue="$MissionCue" action="objective.secure" object="$SalvageShip"/>
                                      </actions>
                                      <cues>

                                        <cue name="Ch2_Getaway_Salvage_Help_Reset_InRange" ref="md.LIB_Generic.ApproachObject_Handler">
                                          <param name="ApproachObject"    value="player.entity"/>
                                          <param name="ApproachTarget"    value="$SalvageShip"/>
                                          <param name="ApproachDistance"  value="2km"/>
                                          <param name="SuccessSignalCue"  value="Ch2_Getaway_Salvage_Help_Reset_FindLeak"/>
                                        </cue>

                                        <cue name="Ch2_Getaway_Salvage_Help_Reset_FindLeak">
                                          <conditions>
                                            <event_cue_signalled/>
                                          </conditions>
                                          <actions>
                                            <find_object_component name="$SalvageShip_SignalLeak" object="$SalvageShip" class="class.signalleak" multiple="false"/>
                                            <do_if value="$SalvageShip_SignalLeak.exists and ($SalvageShip_SignalLeak.type == signalleaktype.claim)">
                                              <set_objective cue="$MissionCue" action="objective.scan" object="$SalvageShip_SignalLeak"/>
                                            </do_if>
                                            <do_else>
                                              <set_objective cue="$MissionCue" action="objective.secure" object="$SalvageShip"/>
                                            </do_else>
                                          </actions>
                                          <cues>

                                            <cue name="Ch2_Getaway_Salvage_Help_ClaimGuidance_Reset_NoLeak" onfail="cancel">
                                              <conditions>
                                                <check_value value="not $SalvageShip_SignalLeak"/>
                                              </conditions>
                                              <actions>
                                                <signal_cue cue="Ch2_Getaway_Salvage_Help_ClaimGuidance_Reset"/>
                                              </actions>
                                            </cue>

                                            <cue name="Ch2_Getaway_Salvage_Help_ClaimGuidance_Reset">
                                              <conditions>
                                                <check_any>
                                                  <event_cue_signalled/>
                                                  <event_object_destroyed object="$SalvageShip_SignalLeak"/>
                                                </check_any>
                                              </conditions>
                                              <actions>
                                                <set_objective cue="$MissionCue" action="objective.secure" object="$SalvageShip"/>
                                              </actions>
                                              <delay exact="5s" comment="prevent infinite loops"/>
                                              <actions>
                                                <reset_cue cue="Ch2_Getaway_Salvage_Help_Reset_InRange"/>
                                                <reset_cue cue="parent"/>
                                              </actions>
                                            </cue>
                                          </cues>
                                        </cue>

                                      </cues>
                                    </cue>

                                  </cues>
                                </cue>
                              </cues>
                            </cue>
                            <!--this cue is only to prevent the story from getting stuck at this spot; we might be able to remove it later if we can confirm that it no longer triggers-->
                            <cue name="Ch2_Getaway_Salvage_OwnerChanged_SafetyCheck" checkinterval="2s">
                              <conditions>
                                <check_value value="$SalvageShip.owner == faction.player"/>
                              </conditions>
                              <actions>
                                <debug_text filter="error" text="'Owner change of salvage ship was missed - recovering by signalling cue directly'"/>
                                <signal_cue cue="Ch2_Getaway_Savage_Scanned"/>
                              </actions>
                            </cue>
                            <cue name="Ch2_Getaway_Savage_Scanned">
                              <conditions>
                                <check_any>
                                  <event_object_changed_owner object="$SalvageShip" owner="faction.player"/>
                                  <event_cue_signalled/>
                                </check_any>
                              </conditions>
                              <actions>
                                <set_value name="$SalvageShipSecured"/>
                                <set_object_min_hull object="$SalvageShip" exact="0"/>
                                <cancel_cue cue="Ch2_Getaway_Salvage_Help"/>
                                <cancel_cue cue="Ch2_Getaway_Salvage_OwnerChanged_SafetyCheck"/>
                              </actions>
                              <cues>
                                <cue name="Ch2_Getaway_Salvage_Boso_231_Ref_v1" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor"             value="[$BosoTa, $DalBusta, $BosoTa]"/>
                                  <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey, $BosoCutsceneKey]"/>
                                  <param name="Lines"             value="[
                                                                            [[30221231], [30221232], [30221233], [30221216]],
                                                                            [[30221906], [30221907], [30221908], [if player.entity.isfemale then 30221287 else 30221212]],
                                                                            [[30221221], [30221204], [30221223], [if player.entity.isfemale then 30221225 else 30221224]]
                                                                         ]"/>
                                  <!-- 
                              Boso	<t id="30221231	">	Oh dear me, no.
                              Boso	<t id="30221232	">	Apparently this vessel was stopped, and its crew taken, during the invasion by the Patriarchy.
                              Boso	<t id="30221233	">	This must all have happened before the gates were reconnected.
                              Boso	<t id="30221234	">	It is clearly the wrong ship, so let us turn our attention to the others.
                              Boso	<t id="30221216 ">  It is clearly the wrong ship, so let us turn our attention to other possible locations for her whereabouts.
                              
                              Dal	<t id="30221	906	">	The others, right...(referring to "the other locations")
                              Dal	<t id="30221	907	">	I have a lot of bulk data, but can't pinpoint a possible location for our fugitives.
                              Dal	<t id="30221	908	">	Sending it over. This sort of riddle should make your senses tingle.
                              Dal	<t id="30221	212	">	Boso will help you track them down so that we can negotiate the hostage's release.         
                              <t id="30221	287	">	(spoken to female 'you'){,30221212}
                                
                              Boso	<t id="30221221	">How exciting!
               not used:      Boso	<t id="30221222	">Dal has provided a considerable number of sensor data logs from ships that have traversed this sector.
                              Boso	<t id="30221204	">	Dal has provided a considerable number of sensor data logs from ships that have traversed Free Families sectors on their trade routes.  
                              Boso	<t id="30221223	">Analysing the logs and cross-referencing them with cargo records, I was able to identify several vessels worthy of further investigation.
                              Boso	<t id="30221224	">I will mark their positions on your map for you.
                              Boso	<t id="30221225	">(spoken to female 'you'){,30221224}
                                    -->
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="[null, null, Ch2_SalvageShip_Killable_v2]"/>
                                </cue>
                                <cue name="Ch2_SalvageShip_Killable_v2">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <set_object_min_hull object="$SalvageShip" exact="0"/>
                                    <remove_from_group group="$InvestigationLocations" object="$SalvageShip"/>
                                    <signal_cue cue="Ch2_Investigate"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch2_ScavengerHunt_2">
                          <!-- $Ch2_SectorWreckage -->
                          <!-- WRONG WRECKAGE TYPE -->
                          <actions>
                            <!-- TODO @Heinrich put this into a lib -->
                            <set_value name="$FromObject" exact="$EntryGatesAlongTheWay.{$Ch2_SectorWreckage}"/>
                            <set_value name="$ToObject"   exact="$ExitGatesAlongTheWay.{$Ch2_SectorWreckage}"/>
                            <assert value="$FromObject != $ToObject" text="'@Heinrich EntryGate and ExitGate should never be the same.'"/>

                            <!-- Find a position halfway towards -->
                            <set_value name="$Distance01" exact="0.3"  comment="range [0,1] where 0 is location of FromObject and 1 is location of ToObject"/>
                            <!-- TODO: @Heinrich, make sure distance01 + random offset don't end up right next to the gate or behind it,
                                       also add failsafes if everything happens in the same sector (by using 0.2, 0.4, 0.6, 0.8 e.g.)-->
                            <set_value name="$DistanceFromTo" exact="$FromObject.distanceto.{$ToObject} * $Distance01"/>

                            <create_position name="$TargetOrigin" object="$ToObject" space="$FromObject.zone"/>
                            <create_orientation name="$Rotation" orientation="look_at" refposition="$TargetOrigin">
                              <position  object="$FromObject" space="$FromObject.zone"/>
                            </create_orientation>
                            <create_position name="$Location" x="$FromObject.position.x + sin($Rotation.yaw) * $DistanceFromTo" y="0" z="$FromObject.position.z + cos($Rotation.yaw) * $DistanceFromTo"/>

                            <create_position name="$Offset" x="$Location.x" y="$Location.y" z="$Location.z" space="$FromObject.sector" min="20km" max="50km"/>
                            <create_object macro="macro.env_debris_split_s_02_macro" name="$Wreckage" sector="$Ch2_SectorWreckage">
                              <safepos value="$Offset"/>
                            </create_object>
                            <set_wreck_persistence object="$Wreckage" persistent="true"/>
                            <set_object_min_hull object="$Wreckage" exact="1"/>
                            <add_to_group groupname="$InvestigationLocations" object="$Wreckage"/>
                            <signal_cue cue="Ch2_Investigate"/>
                          </actions>
                          <cues>
                            <cue name="Ch2_PlayerReachedLocation2_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachObject"    value="player.entity"/>
                              <param name="ApproachTarget"    value="$Wreckage"/>
                              <param name="ApproachDistance"  value="4km"/>
                              <param name="SuccessSignalCue"  value="Ch2_Getaway_Salvage_Boso_237"/>
                            </cue>
                            <cue name="Ch2_Getaway_Salvage_Boso_237">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch2_Getaway_Salvage_Boso_237_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$BosoTa"/>
                                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                                  <param name="Lines"             value="[[30221237], [30221238, 2s]]"/>
                                  <!--
                           WRONG WRECKAGE TYPE:
                             Boso	<t id="30221237"> This wreckage appears similar to the vessel we are looking for, but it is of a different type.
                             Boso	<t id="30221238">	There is no use in further investigation.
                                  -->
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="Ch2_Wreckage_Killable"/>
                                </cue>
                                <cue name="Ch2_Wreckage_Killable">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <set_object_min_hull object="$Wreckage" exact="0"/>
                                    <remove_from_group group="$InvestigationLocations" object="$Wreckage"/>
                                    <signal_cue cue="Ch2_Investigate"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_ScavengerHunt_3">
                          <!-- $Ch2_SectorRock -->
                          <!-- Rock -->
                          <actions>
                            <!-- TODO @Heinrich put this into a lib -->
                            <set_value name="$FromObject" exact="$EntryGatesAlongTheWay.{$Ch2_SectorRock}"/>
                            <set_value name="$ToObject"   exact="$ExitGatesAlongTheWay.{$Ch2_SectorRock}"/>
                            <assert value="$FromObject != $ToObject" text="'@Heinrich EntryGate and ExitGate should never be the same.'"/>

                            <!-- Find a position halfway towards -->
                            <set_value name="$Distance01" exact="0.4"  comment="range [0,1] where 0 is location of FromObject and 1 is location of ToObject"/>
                            <!-- TODO: @Heinrich, make sure distance01 + random offset don't end up right next to the gate or behind it,
                                       also add failsafes if everything happens in the same sector (by using 0.2, 0.4, 0.6, 0.8 e.g.)-->
                            <set_value name="$DistanceFromTo" exact="$FromObject.distanceto.{$ToObject} * $Distance01"/>

                            <create_position name="$TargetOrigin" object="$ToObject" space="$FromObject.zone"/>
                            <create_orientation name="$Rotation" orientation="look_at" refposition="$TargetOrigin">
                              <position  object="$FromObject" space="$FromObject.zone"/>
                            </create_orientation>
                            <create_position name="$Location" x="$FromObject.position.x + sin($Rotation.yaw) * $DistanceFromTo" y="0" z="$FromObject.position.z + cos($Rotation.yaw) * $DistanceFromTo"/>

                            <create_position name="$Offset" x="$Location.x" y="$Location.y" z="$Location.z" space="$FromObject.sector" min="20km" max="50km"/>
                            <create_object macro="macro.env_ast_ore_m_03_macro" name="$Rock" sector="$Ch2_SectorRock">
                              <safepos value="$Offset"/>
                            </create_object>
                            <add_to_group groupname="$InvestigationLocations" object="$Rock"/>
                            <signal_cue cue="Ch2_Investigate"/>
                            <set_object_min_hull object="$Rock" exact="1" comment="Todo @Heinrich remove afterwards"/>
                          </actions>
                          <cues>
                            <cue name="Ch2_PlayerReachedLocation3_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachObject"    value="player.entity"/>
                              <param name="ApproachTarget"    value="$Rock"/>
                              <param name="ApproachDistance"  value="4km"/>
                              <param name="SuccessSignalCue"  value="Ch2_Getaway_Salvage_Boso_235"/>
                            </cue>
                            <cue name="Ch2_Getaway_Salvage_Boso_235">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch2_Getaway_Salvage_Boso_235_Ref" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor"             value="[$BosoTa, $DalBusta, $BosoTa]"/>
                                  <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey, $BosoCutsceneKey]"/>
                                  <param name="Lines"             value="[[[30221235]], [[30221218]], [[30221236]]]"/>
                                  <!--
                                  Boso	<t id="30221235">	This... vessel... appears to be... a rock!
                                  Dal	  <t id="30221218">	(incredulous)That's what you got from of my sensor data?
                                  Boso	<t id="30221236">	(defensive)Obscure readings can result in low levels of certainty.
                                  -->
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="[null, null, Ch2_Rock_Killable]"/>
                                </cue>
                                <cue name="Ch2_Rock_Killable">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <set_object_min_hull object="$Rock" exact="0"/>
                                    <remove_from_group group="$InvestigationLocations" object="$Rock"/>
                                    <signal_cue cue="Ch2_Investigate"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_ScavengerHunt_4">
                          <!-- $TharkasRavine2 -->
                          <!-- Correct Ship -->
                          <actions>
                            <!-- TODO @Heinrich put this into a lib -->
                            <set_value name="$FromObject" exact="$EntryGatesAlongTheWay.{$TharkasRavine2}"/>
                            <set_value name="$ToObject"   exact="$ExitGatesAlongTheWay.{$TharkasRavine2}"/>
                            <assert value="$FromObject != $ToObject" text="'@Heinrich EntryGate and ExitGate should never be the same.'"/>

                            <!-- Find a position halfway towards -->
                            <set_value name="$Distance01" exact="0.5"  comment="range [0,1] where 0 is location of FromObject and 1 is location of ToObject"/>
                            <!-- TODO: @Heinrich, make sure distance01 + random offset don't end up right next to the gate or behind it,
                                       also add failsafes if everything happens in the same sector (by using 0.2, 0.4, 0.6, 0.8 e.g.)-->
                            <set_value name="$DistanceFromTo" exact="$FromObject.distanceto.{$ToObject} * $Distance01"/>

                            <create_position name="$TargetOrigin" object="$ToObject" space="$FromObject.zone"/>
                            <create_orientation name="$Rotation" orientation="look_at" refposition="$TargetOrigin">
                              <position  object="$FromObject" space="$FromObject.zone"/>
                            </create_orientation>
                            <create_position name="$Location" x="$FromObject.position.x + sin($Rotation.yaw) * $DistanceFromTo" y="0" z="$FromObject.position.z + cos($Rotation.yaw) * $DistanceFromTo"/>

                            <create_position name="$GetawayShipPosition" x="$Location.x" y="$Location.y" z="$Location.z" space="$FromObject.sector" min="20km" max="50km"/>

                            <create_ship name="$GetawayShip" capturable="false" sector="$TharkasRavine2" missioncue="namespace" macro="ship_spl_m_frigate_01_a_macro">
                              <owner exact="faction.argon"/>
                              <loadout loadout="$loadout"/>
                              <pilot macro="character_split_escaped_macro">
                                <page exact="10102" comment="Jey Cortner Page"/>
                              </pilot>
                              <people>
                                <fillpercent exact="8"/>
                                <person role="prisoner" weight="100">
                                  <select race="race.split"/>
                                  <!--testing, probably rather passengers-->
                                </person>
                                <!-- Add a "Prisoner" person Split .. -->
                              </people>
                              <paint ware="$PaintMod_GetawayShip"/>
                              <safepos value="$GetawayShipPosition"/>
                            </create_ship>
                            <signal_objects object="player.galaxy" param="'Cover'" param2="[$GetawayShip, faction.freesplit]"/>
                            <set_object_relation_behaviour object="$GetawayShip" disable="true"/>
                            <set_object_name object="$GetawayShip" page="30221" line="207" comment="Hijacked Ship"/>
                            <set_object_min_hull object="$GetawayShip" exact="50"/>
                            <set_object_docking_enabled object="$GetawayShip" enabled="false"/>
                            <!--<create_order id="'Wait'" object="$GetawayShip" immediate="true">
                              <param name="noattackresponse" value="false"/>
                            </create_order>-->

                            <find_dockingbay object="$GetawayShip" multiple="false" name="$GetawayShipDock"/>
                            <!-- TODO: Failed to place OutcastActor on the dock 'room' @Heinrich -->
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $GetawayShipDock,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                            <add_to_group groupname="$InvestigationLocations" object="$GetawayShip"/>
                            <signal_cue cue="Ch2_Investigate"/>
                          </actions>
                          <cues>
                            <cue name="Ch2_PlayerReachedLocation4_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachObject"    value="player.entity"/>
                              <param name="ApproachTarget"    value="$GetawayShip"/>
                              <param name="ApproachDistance"  value="5km"/>
                              <param name="SuccessSignalCue"  value="Ch2_Getaway_Salvage_Boso_239"/>
                            </cue>
                            <cue name="Ch2_Getaway_Salvage_Boso_239">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch2_Getaway_Salvage_Boso_239_Ref" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor"             value="[$BosoTa, $DalBusta]"/>
                                  <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey]"/>
                                  <param name="Lines"             value="[[[30221239], [30221240]],
                                                                          [[30221219], [if player.entity.isfemale then 30221221 else 30221220]]]"/>
                                  <!--
                              Boso	<t id="30221239	">	This vessel seems to fit the description provided by Dal rather well.
                              Boso	<t id="30221240	">	Maybe you could try asking the pilot whether they recently escaped slavery aboard a Split station.
                              Dal	  <t id="30221219	">	(sarcastic)Oh that'll go down well.
                              Dal	  <t id="30221220	">	Seriously though, just ask them where they're headed or something.
                              Dal	  <t id="30221221	">	(spoken to female 'you'){,30221220}
                                  -->
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="[null, Ch2_Engage_GetawayShip]"/>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <!-- LINES
                Dal	  <t id="30221215	">	To land on the fugitive ship, you need to be on board an S-sized ship.
                Dal	  <t id="30221216	">	(spoken to female 'you'){,30221215}
                Dal	  <t id="30221217	">	A bigger ship might be perceived as threatening, and could complicate the release of the hostage.
                  -->

                <!--
            <cue name="Scan_GetawayShip" comment="currently not used, might be a step between flee->attack->surrender to add more player tasks">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Scan_Ref" ref="md.RML_Scan.Scan">
                  <!-§- always pass these -§->
                  <param name="EndSignalCue"        value="Surrendered_GetawayShip"/>
                  <param name="MissionCue"          value="$MissionCue"/>
                  <param name="StartStep"           value="$StartStep" comment="Briefing step to start the mission on"/>
                  <param name="UpdateBriefing"      value="true" comment="Update the briefing objective step when the objective is updated"/>
                  <param name="DebugChance"         value="$DeepDebugChance"/>
                  <param name="ObjectiveText"     value="$TextTable.$objective"/>
                  <param name="ScanObjective"     value="$ScanObjective"/>
                </cue>
              </cues>
            </cue>-->

                <cue name="Ch2_Engage_GetawayShip">
                  <!-- RML scan ? -->
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch2_GetAway_Positions"/>
                    <update_mission cue="$MissionCue">
                      <briefing>
                        <objective step="1" action="objective.follow" object="$GetawayShip" text="$GetawayShip.knownname" />
                        <objective step="2" action="objective.dockat" object="$GetawayShip" text="$GetawayShip.knownname" />
                        <!--<objective step="3" action="objective.transport" object="$OutcastActor" text="$OutcastActor.knownname" />-->
                      </briefing>
                    </update_mission>
                    <set_objective_from_briefing cue="$MissionCue" step="1"/>

                    <create_position name="$EscapePosition" object="$EscapeFromStation" space="$EscapeFromStation.sector"
                                                            z="50km"
                                                            x="[8km, 13km, 21km, -8km, -13km, -21km].random"
                                                            y="[8km, 13km, 21km, -8km, -13km, -21km].random"/>

                    <create_order id="'MoveWait'" object="$GetawayShip" immediate="true">
                      <param name="destination" value="[$EscapeFromStation.sector, $EscapePosition]"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                  </actions>
                  <cues>

                    <cue name="Player_Approach_Gate_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"        value="$GetawayShip"/>
                      <param name="ApproachDistance"      value="3km"/>
                      <param name="SuccessSignalCue"      value="Ch2_GetawayShip_Approach_Completed"/>
                    </cue>

                    <cue name="Ch2_GetawayShip_Approach_Completed">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="$Surrendered">
                          <signal_cue cue="Ch2_Surrendered_GetawayShip"/>
                        </do_if>
                        <do_else comment="not $Surrendered">
                          <signal_cue cue="Ch2_Engage_GetawayShip_Warning"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch2_Engage_GetawayShip_Warning">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch2_Engage_EscapedActor_Warning_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$EscapedActor, $BosoTa, $DalBusta, $BosoTa, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$EscapedCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey]"/>
                          <param name="Lines"             value="[
                                 
                     [[if player.entity.isfemale then 30221220 else 30221219],
                      [if player.entity.isfemale then 30221222 else 30221221]],
                     [[30221241]],
                     [[30221222],[30221223]
                     ],
                     [[30221242]],
                     [[if player.entity.isfemale then 30221286 else 30221226],[if player.entity.isfemale then 30221228 else 30221227]] 
                     ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"     value="[Ch2_Engage_GetawayShip_Flee, null, Ch2_Engage_GetawayShip_Objective_Attack, null, null]"/>
                          <!--     
                            ESCAPED:
                            <t id="30221219">This is your first and only warning.</t>
                            <t id="30221220">(spoken to female 'you'){,30221219}</t>
                   not used <t id="30221223">We do not negotiate with the Patriarchy's lackeys.</t>
                            <t id="30221221">Do not approach any closer or we will open fire.</t>
                            <t id="30221222">(spoken to female 'you'){,30221221}</t>
                            BOSO:                            
                            <t id="30221241">They don't seem very welcoming.</t>
                            DAL:               
                            <t id="30221222">He's carrying quite a weight on his shoulders with those other fugitives on board.</t>
                            <t id="30221223">We'll have to... persuade him if we want to get our hostage.</t>
                   not used <t id="30221224">Engage, but don't destroy that ship.</t>
                   not used <t id="30221225">(spoken to female 'you'){,30221224}</t>
                            BOSO:
                            <t id="30221242">Is that really necessary?</t> 
                            DAL:
                            <t id="30221226">They only need to think that you're willing to kill.</t>
                            <t id="30221286">(spoken to female 'you'){,30221226}</t>
                            <t id="30221227">Oh, and try not to damage the crew quarters.</t>
                            <t id="30221228">(spoken to female 'you'){,30221227}</t>
           not used, misleading   <t id="30221229">Maybe try aiming at the engines and turrets or whatever.</t>
           not used, misleading   <t id="30221230">(spoken to female 'you'){,30221229}</t>                            
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_Engage_GetawayShip_Flee">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>

                        <!--<commandeer_object object="$GetawayShip"/>-->
                        <create_order id="'Flee'" object="$GetawayShip" immediate="true">
                          <param name="method" value="'boost'"/>
                          <param name="attacker" value="player.ship"/>
                          <param name="donotdrop" value="true"/>
                          <param name="deploydistraction" value="true"/>
                          <param name="log" value="false"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>

                        <create_position name="$GetawayShipPos" object="$GetawayShip" space="$GetawayShip.sector"/>

                        <!-- ask if there is Follow instead @Heinrich TODO -->
                        <create_order id="'MoveWait'" object="$Ch2_SlaveTraderShip" immediate="true">
                          <param name="destination" value="[$GetawayShip.sector, $GetawayShipPos]"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>

                      </actions>
                    </cue>

                    <cue name="Ch2_Engage_GetawayShip_Objective_Attack">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- EnforceSurrender_Ref already set's an "attack" objective -->
                        <!--
                        <update_mission cue="$MissionCue">
                          <briefing>
                            <objective step="1" action="objective.follow" object="$GetawayShip" text="$GetawayShip.knownname" />
                            <objective step="2" action="objective.attack" object="$GetawayShip" text="$GetawayShip.knownname" />
                            <objective step="3" action="objective.dockat" object="$GetawayShip" text="$GetawayShip.knownname" />
                            <!-$-<objective step="3" action="objective.transport" object="$OutcastActor" text="$OutcastActor.knownname" />-$->
                          </briefing>
                        </update_mission>
                        <set_objective_from_briefing cue="$MissionCue" step="2"/>-->
                      </actions>
                      <cues>
                        <cue name="Ch2_GetawayShip_Hostile">
                          <conditions>
                            <event_object_attacked object="$GetawayShip"/>
                            <check_value value="event.param.isplayerowned"/>
                          </conditions>
                          <actions>
                            <set_relation_boost object="$GetawayShip" faction="faction.player" value="$RelationBoostHostile" silent="true"/>
                            <create_order id="'Attack'" name="$attackOrder" object="$GetawayShip" immediate="true">
                              <param name="primarytarget" value="event.param"/>
                              <!--<param name="secondarytargets" value="[player.ship]"/>-->
                              <param name="pursuetargets" value="false"/>
                              <param name="checkrelation" value="false"/>
                              <param name="allowothertargets" value="false" comment="prevent ship from attacking everything in range due to checkrelation false"/>
                            </create_order>
                          </actions>
                        </cue>

                        <cue name="Ch2_EnforceSurrender_Ref" ref="md.RML_Enforce_Surrender.EnforceSurrender">
                          <!-- always pass these -->
                          <param name="EndSignalCue"        value="Ch2_Surrendered_GetawayShip"/>
                          <param name="MissionCue"          value="$MissionCue"/>
                          <param name="StartStep"           value="1" comment="Briefing step to start the mission on"/>
                          <param name="UpdateBriefing"      value="true" comment="Update the briefing objective step when the objective is updated"/>
                          <param name="DebugChance"         value="$DeepDebugChance"/>
                          <!-- mission-related parameters -->
                          <param name="TargetShip"          value="$GetawayShip"/>
                          <param name="TargetShieldPercent" value="80"/>
                          <param name="TargetHullPercent"   value="60"/>
                        </cue>

                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_Surrendered_GetawayShip">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Surrendered" exact="true"/>
                    <cancel_cue cue="Ch2_GetawayShip_Hostile"/>
                    <signal_cue cue="Ch2_Retrieve_Hostage"/>

                    <create_position name="$GetawayShipPos" object="$GetawayShip" space="$GetawayShip.sector"/>
                    <cancel_all_orders object="$Ch2_SlaveTraderShip"/>
                    <create_order id="'MoveWait'" object="$Ch2_SlaveTraderShip" default="true">
                      <param name="destination" value="[$GetawayShip.sector, $GetawayShipPos]"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>

                    <cancel_all_orders object="$GetawayShip"/>
                    <create_position name="$GetawayShipPos2" object="$GetawayShip" space="$GetawayShip.sector" z="1km"/>
                    <create_order id="'MoveWait'" object="$GetawayShip" default="true">
                      <param name="destination" value="[$GetawayShip.sector, $GetawayShipPos2]"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>

                  </actions>
                  <cues>
                    <cue name="Ch2_Surrendered_Escaped_224_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$EscapedActor"/>
                      <param name="CutsceneKey"       value="$EscapedCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30221225 else 30221224],
                                                              [30221229],
                                                              [if player.entity.isfemale then 30221231 else 30221230]]"/>
                      <param name="EndSignalCue"      value="Ch2_Surrendered_Attacked_Afterwards_Enable_Speak"/>

                      <!--
                       <t id="30221224">Cease fire! We're ready to negotiate!(rushed)</t>
                       <t id="30221225">(spoken to female 'you'){,30221224}</t>
                       
                       <t id="30221229">We're willing to give up the hostage!</t>
                       <t id="30221230">Dock on our ship to pick her up.</t>
                       <t id="30221231">(spoken to female 'you'){,30221230}</t>
                      -->
                    </cue>

                    <!-- Reset immediately, but talk again only if it was triggered while the first surrender speak was done -->

                    <cue name="Ch2_Surrendered_Attacked_Afterwards_Enable_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$Surrendered_Speak_Allowed"/>
                        <set_objective_from_briefing cue="$MissionCue" step="2"/>
                        <set_object_docking_enabled object="$GetawayShip" enabled="true"/>
                        <signal_objects object="player.galaxy" param="'Cover'" param2="[$GetawayShip, faction.freesplit]"/>
                      </actions>
                    </cue>

                    <cue name="Ch2_Reset_Relation_On_Overshooting_Speak">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$Surrendered_Speak_Allowed?"/>
                      </conditions>
                      <actions>

                        <set_value name="$EscapedActorLines" exact="[
                                   [
                                    [if player.entity.isfemale then 30221228 else 30221227],[30221226]
                                   ].random
                                   ]"/>
                        <do_if value="$OutcastActor.ship == $GetawayShip">
                          <append_to_list name="$EscapedActorLines" exact="[30221229]"/>
                        </do_if>
                      </actions>
                      <cues>
                        <cue name="Ch2_Surrendered_Escaped_226_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$EscapedActor"/>
                          <param name="CutsceneKey"       value="$EscapedCutsceneKey"/>
                          <param name="Lines"             value="$EscapedActorLines"/>
                          <param name="EndSignalCue"      value="Ch2_Reset_Relation_Speak_Reset"/>
                          <!--
                               <t id="30221226">Stop! Please!</t>
                               <t id="30221227">I said cease fire!</t>
                               <t id="30221228">(spoken to female 'you'){,30221227}</t>
                               <t id="30221229">We're willing to give up the hostage!</t>
                              -->
                        </cue>
                        <cue name="Ch2_Reset_Relation_Speak_Reset">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay min="7s" max="13s"/>
                          <actions>
                            <reset_cue cue="parent"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_Reset_Relation_GetawayAttacking" instantiate="true">
                      <conditions>
                        <event_player_owned_attacked/>
                        <check_value value="event.param == $GetawayShip"/>
                        <check_value value="$Surrendered"/>
                      </conditions>
                      <actions>
                        <set_relation_boost object="$GetawayShip" faction="faction.player" value="$RelationBoostDocking" comment="Boost Reset" decay="0"/>
                        <do_all exact="$GetawayShip.subordinates.count" counter="$sub">
                          <set_relation_boost object="$GetawayShip.subordinates.{$sub}" faction="lookup.faction.{$f}" value="$RelationBoostDocking"   comment="Boost to allow landing"  decay="0"/>
                        </do_all>
                        <signal_objects object="player.galaxy" param="'Cover'" param2="[$GetawayShip, faction.freesplit]"/>
                      </actions>
                    </cue>

                    <cue name="Ch2_Reset_Relation" instantiate="true">
                      <conditions>
                        <check_all>
                          <!-- Attacked by player-owned ship and shield/hull values are low enough -->
                          <event_object_attacked object="$GetawayShip" />
                          <debug_text text="'%s attacker=%s shield=%s hull=%s'.[event.object, event.param, $GetawayShip.shieldpercentage, $GetawayShip.hullpercentage]" debugchance="$DebugChance - 100" />
                          <check_value value="event.param.isplayerowned" />
                          <check_value value="$Surrendered"/>
                        </check_all>
                      </conditions>
                      <actions>
                        <set_relation_boost object="$GetawayShip" faction="faction.player" value="$RelationBoostDocking" comment="Boost Reset" decay="0"/>
                        <do_all exact="$GetawayShip.subordinates.count" counter="$sub">
                          <set_relation_boost object="$GetawayShip.subordinates.{$sub}" faction="lookup.faction.{$f}" value="$RelationBoostDocking"   comment="Boost to allow landing"  decay="0"/>
                        </do_all>
                        <signal_objects object="player.galaxy" param="'Cover'" param2="[$GetawayShip, faction.freesplit]"/>
                        <set_objective_from_briefing cue="$MissionCue" step="2"/>
                      </actions>
                      <cues>
                        <cue name="Ch2_Reset_Relation_On_Overshooting">
                          <delay min="0.05s" max="0.1s"/>
                          <actions>
                            <set_relation_boost object="$GetawayShip" faction="faction.player" value="$RelationBoostDocking" comment="Boost to allow landing"  decay="0"/>
                            <!-- Change Subordinates and Lasertowers to the same faction -->

                            <do_all exact="lookup.faction.count" counter="$f">
                              <do_if value="$GetawayShip.trueowner != lookup.faction.{$f}">
                                <set_relation_boost object="$GetawayShip" faction="lookup.faction.{$f}" value="$RelationBoostDocking" comment="Boost to allow landing"  decay="0"/>
                                <do_all exact="$GetawayShip.subordinates.count" counter="$sub">
                                  <set_relation_boost object="$GetawayShip.subordinates.{$sub}" faction="lookup.faction.{$f}" value="$RelationBoostDocking"   comment="Boost to allow landing"  decay="0"/>
                                </do_all>
                              </do_if>
                            </do_all>
                            <!-- ^Supposed to make everyone else stop attacking $GetawayShip, does not work that well. Probably because they don't update the relation (quick enough) and keep the target -->

                            <do_if value="Ch2_Reset_Relation_On_Overshooting_Speak.state == cuestate.waiting">
                              <signal_cue cue="Ch2_Reset_Relation_On_Overshooting_Speak"/>
                            </do_if>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_Retrieve_Hostage">
                  <!-- Needs to be called from not-Place-Hostage on the Reset_Chapter case TODO -->
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>

                    <do_all exact="lookup.faction.count" counter="$f">
                      <do_if value="$GetawayShip.trueowner != lookup.faction.{$f}">
                        <set_relation_boost object="$GetawayShip" faction="lookup.faction.{$f}" value="$RelationBoostDocking" comment="Boost Reset"  decay="0"/>
                      </do_if>
                    </do_all>

                    <!-- Change Subordinates and Lasertowers to the same faction -->
                    <do_all exact="$GetawayShip.subordinates.count" counter="$sub">
                      <set_owner object="$GetawayShip.subordinates.{$sub}.pilot" faction="faction.civilian"/>
                      <set_relation_boost object="$GetawayShip.subordinates.{$sub}" faction="faction.player" value="$RelationBoostDocking"   comment="Boost to allow landing"  decay="0"/>
                    </do_all>

                    <create_order id="'Wait'" object="$GetawayShip" immediate="true">
                      <param name="noattackresponse" value="true"/>
                    </create_order>

                    <set_value name="$TargetLocation" exact="player.entity"/>
                    <set_value name="$Faction" exact="faction.freesplit"/>
                    <run_actions ref="md.LIB_Generic.FindNearestStationForFaction" result="$SuitableStation">
                      <param name="Faction" value="$Faction"/>
                      <param name="TargetLocation" value="$TargetLocation"/>
                    </run_actions>
                    <set_value name="$HostageDestination" exact="$SuitableStation" comment="temp, we probably want to drop the hostage of somewhere else"/>
                    <!-- add Slavetrader 'jumping in' -->

                  </actions>
                  <cues>
                    <!-- TIMING: Outcast on board + Slave Trader in Range @Heinrich TODO -->
                    <cue name="Ch2_SlaveTrader_Engage">
                      <actions>
                        <create_position name="$GetawayShipPos" object="$GetawayShip" space="$GetawayShip.sector"/>
                        <create_order id="'MoveWait'" object="$Ch2_SlaveTraderShip" immediate="true">
                          <param name="destination" value="[$GetawayShip.sector, $GetawayShipPos]"/>
                          <param name="debugchance" value="$DeepDebugChance"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch2_Transport_Hostage_Ref" ref="md.RML_Transport_Passengers_V2.TransportPassengers_V2">
                      <param name="EndSignalCue"    value="Ch2_Retrieve_Hostage_Done"/>
                      <param name="MissionCue"      value="$MissionCue"/>
                      <param name="StartStep"       value="2"  comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"  value="true"        comment="Update the briefing objective step when the objective is updated"/>

                      <param name="Passenger"       value="$OutcastActor"/>
                      <param name="DropOff"         value="false"/>
                      <param name="Destination"     value="null"  comment="Destination object to drop off the passenger"/>
                      <param name="PlaceNPC"        value="false" comment="RML_Transport_Passengers_V2 cannot handle NPCPlacement without rooms (e.g. on ships), so we do it ourselves"/>
                      <param name="SkipConversation" value="true" comment="We want the passenger to come on board automatically"/>

                      <!-- ************************************************************************************************************************************************************************ -->
                      <!-- If the mission is to manage placing the delivery NPC, all of these parameters must be passed in together -->
                      <!-- Room, corridor and door definitions could be provided by the caller through get_room_definition -->
                      <param name="StartObject"           value="$GetawayShip"  comment="Object to place the NPC on"/>
                      <!-- ************************************************************************************************************************************************************************ -->

                      <param name="DebugChance"           value="$DeepDebugChance"/>
                    </cue>

                    <cue name="Ch2_Hostage_Transport_Check_Ship" instantiate="true">
                      <conditions>
                        <event_object_docked_at container="$GetawayShip"/>
                        <check_any>
                          <check_value value="player.ship == $GetawayShip"/>
                          <check_value value="player.ship.dock.container == $GetawayShip"/>
                        </check_any>
                      </conditions>
                      <delay min="2s" max="2.5s" comment="Remove when we get an event when the floor recalculates walkable navmeshes"/>
                      <!-- TODO @Heinrich ^ work around delay -->
                      <actions>
                        <!-- TODO @Heinrich this might be killing the outcast actor / incompatible to the new NPC placement-->
                        <set_value name="$NPCPassenger"           exact="$OutcastActor"/>
                        <set_value name="$NPCPassengerTemplate"   exact="$OutcastActor.npctemplate"/>
                        <!--people.free does not count control entity slots, which is fine for this case
                            Inbound people should be flagged as 'intransit' and included in the current total of people-->
                        <debug_text text="'$PassengerShip ' + event.param + ' has ' + event.param.people.free + ' free people slots'" chance="$DeepDebugChance"/>
                        <do_if value="event.param.people.free">
                          <!--Ship has enough space for the passenger. Add them to the ship's people list and attempt to have them walk to it.-->
                          <set_value name="$PassengerShip" exact="event.param" />
                          <!-- Make NPC walk to selected ship. As their destination slot is a NPC transport slot, they will become 'hidden' on arrival. They will continue to exist. -->
                          <find_npc_waypoint name="this.$DespawnWaypoints" object="$PassengerShip" tags="tag.npctransport" multiple="true"/>
                          <assert value="this.$DespawnWaypoints.count" text="'No waypoints on ' + $PassengerShip + ' ' + $PassengerShip.knownname + ' tagged ' + tag.npctransport + '. No place to despawn passengers.'"/>
                          <debug_text text="'Attempting to add ' + $NPCPassenger + ' to ' + $PassengerShip + ' ' +$PassengerShip.knownname + ' as a passenger'" chance="$DebugChance"/>
                          <create_npc_template name="this.$Template" object="$PassengerShip" entity="$NPCPassenger" role="entityrole.passenger"/>
                          <assert value="$NPCPassengerTemplate == this.$Template" text="'Template of passenger added to the ship ' + this.$Template + ' does not match that stored earlier ' + $NPCPassengerTemplate + ' [Owen]'"/>
                          <assert value="this.$Template" text="'Attempted to add passenger to the selected ship but it failed. [Owen]'"/>
                          <do_if value="this.$Template">
                            <!--State machine debug-&->
                        <set_value name="$NPCPassenger.$StateMachine.$DeepDebugChance" exact="100"/>-->
                            <do_if value="this.$DespawnWaypoints.count">
                              <!--
                              <set_value name="$MovementTable" exact="table[$slot = this.$DespawnWaypoints.random]" />
                              <signal_objects object="$NPCPassenger" param="'npc_move_to'" param2="$MovementTable.clone"/>-->
                              <!-- Try another move order instead -->
                              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = this.$DespawnWaypoints.random,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance]
                                                                                                      ]"/>
                            </do_if>
                            <do_else>
                              <assert value="this.$DespawnWaypoints.count" text="'No place for the NPC was found on the selected ship ' + $PassengerShip + ' ' + $PassengerShip.macro.id + ' - This will fail the RML. [Owen]'"/>
                              <remove_actor_from_room actor="$NPCPassenger"/>
                            </do_else>
                          </do_if>
                          <signal_objects object="$NPCPassenger" param="'passenger_transport_ship_selected'" param2="$PassengerShip"/>
                          <signal_cue cue="Ch2_Passenger_Walking_Towards_Ship"/>
                        </do_if>
                        <do_else>
                          <speak actor="$OutcastActor" priority="100" comment="TODO: Speak Priorities">
                            <!-- TODO: Test Behaviour/Contingency in the no room case -->
                            <text line="11803" comment="(No room on player's ship)You don't have enough room on your ship right now."/>
                          </speak>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch2_Passenger_Walking_Towards_Ship">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_known object="$Ch2_SlaveTraderShip" known="true"/>
                        <!-- add $CurbActor to $Ch2_SlaveTraderShip -->
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $CurbActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Ch2_SlaveTraderShip,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                      </actions>
                      <cues>
                        <!-- currently no cue, Dal lines:
                        
                                 [
                                  [if player.entity.isfemale then 30221232 else 30221231],
                                  [if player.entity.isfemale then 30221234 else 30221233]
                                 ],
                          
                            -->

                        <cue name="Ch2_Passenger_Walking_Towards_Ship_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <!-- Speak Actors Outcast / Curb -->
                          <param name="Actor"             value="[$OutcastActor, $CurbActor, $OutcastActor, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$OutcastCutsceneKey, $CurbCutsceneKey, $OutcastCutsceneKey, $DalCutsceneKey]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[null, Ch2_Dock_At_SlaveTrader, null, null]"/>
                          <param name="Lines"             value="[
                                 [
                                  [if player.entity.isfemale then 30221227 else 30221226]
                                 ],
                                 [
                                  [if (player.ship.extension == 'ego_dlc_split') then 30221221 else 30221223],
                                  [if (player.ship.extension == 'ego_dlc_split') then 30221222 else 30221224]
                                 ],
                                 [
                                  [30221230],
                                  [if player.entity.isfemale then 30221232 else 30221231]
                                 ],
                                 [
                                  [30221235]
                                 ]
                                 ]"/>
                          <!--
                           Dal:
                           <t id="30221231">You'd better not leave your ship while docked, just in case.</t>
                           <t id="30221232">(spoken to female 'you'){,30221231}</t>
                           <t id="30221233">Wait there for the hostage to come aboard.</t>
                           <t id="30221234">(spoken to female 'you'){,30221233}</t>
                           Outcast:
                           <t id="30221226">Split thank you for liberation from Argon rebels.</t>
                           <t id="30221227">(spoken to female 'you'){,30221226}</t>
                 not used: <t id="30221228">Please, take me to Split station.</t>
                 not used: <t id="30221229">(spoken to female 'you'){,30221228}</t>
                           Curb:
                           <t id="30221221">Slave Trader 3 calling humble vessel.</t>
                           <t id="30221222">Humble vessel will release Split hostage immediately.</t>
                           <t id="30221223">Slave Trader 3 calling foreign vessel.</t>
                           <t id="30221224">Foreign vessel will release Split hostage immediately.</t>
                           Outcast:
                           <t id="30221230">Split go home.</t>
                           <t id="30221231">Please comply.</t>
                           <t id="30221232">(spoken to female 'you'){,30221231}</t>
                           Dal:
                           <t id="30221235">The timing of that was rather suspicious.</t>               
                          -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch2_Dock_At_SlaveTrader">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Ch2_Slave_Trader_3_Called"/>
                    <cancel_cue cue="Ch2_Reset_Relation"/>
                    <cancel_cue cue="Ch2_Hostage_Transport_Check_Ship"/>
                    <!--<cancel_cue cue="Ch2_Hostage_Ship_Destroyed"/>-->
                    <set_objective cue="$MissionCue" action="objective.dockat" object="$Ch2_SlaveTraderShip" text="$Ch2_SlaveTraderShip.knownname"/>
                  </actions>
                </cue>

                <cue name="Ch2_Retrieve_Hostage_Done" comment="Signalled when $OutcastActor enters the player ship" version="3">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$feedbackvalue" exact="if this.$EndFeedbackValue? then this.$EndFeedbackValue else 0"/>
                    <debug_text text="$feedbackvalue" chance="$DebugChance"/>

                    <!-- Needs an immediate objective after the hostage got transported to the ship-->
                    <do_if value="not $Ch2_Slave_Trader_3_Called?">
                      <set_objective cue="$MissionCue" action="objective.undock" object="$OutcastActor.ship" text="$GetawayShip.knownname"/>
                    </do_if>
                    <do_else>
                      <set_objective cue="$MissionCue" action="objective.dockat" object="$Ch2_SlaveTraderShip" text="$Ch2_SlaveTraderShip.knownname" step="2" updatebriefing="true"/>
                    </do_else>

                    <do_if value="$feedbackvalue lt 0">
                      <signal_cue_instantly cue="Ch2_Meet_Curb" param="null"/>
                      <cancel_all_orders object="$GetawayShip"/>
                      <create_order object="$GetawayShip" id="'MoveDie'" immediate="true">
                        <param name="byidle" value="false"/>
                        <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                      </create_order>
                      <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                            param="['add_definition', $OutcastActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = $Ch2_SlaveTraderShip,
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>
                      <do_if value="$PassengerShip.exists">
                        <remove_npc_template  object="$PassengerShip" template="$NPCPassengerTemplate"/>
                      </do_if>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$feedbackvalue" exact="if this.$EndFeedbackValue? then this.$EndFeedbackValue else 0"/>
                    <debug_text text="$feedbackvalue" chance="$DebugChance"/>
                    <do_if value="$feedbackvalue lt 0">
                      <signal_cue_instantly cue="Ch2_Meet_Curb" param="null"/>
                      <cancel_all_orders object="$GetawayShip"/>
                      <create_order object="$GetawayShip" id="'MoveDie'" immediate="true">
                        <param name="byidle" value="false"/>
                        <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                      </create_order>
                      <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                            param="['add_definition', $OutcastActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = $Ch2_SlaveTraderShip,
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>
                      <do_if value="$PassengerShip.exists">
                        <remove_npc_template  object="$PassengerShip" template="$NPCPassengerTemplate"/>
                      </do_if>
                    </do_if>
                  </patch>
                  <patch sinceversion="3">
                    <do_if value="(cuestate.waiting == Ch2_Meet_Curb.state) and ($Ch2_Slave_Trader_3_Called?)">
                      <set_objective cue="$MissionCue" action="objective.dockat" object="$Ch2_SlaveTraderShip" text="$Ch2_SlaveTraderShip.knownname" step="2" updatebriefing="true"/>
                    </do_if>
                  </patch>
                  <cues>
                    <cue name="Ch2_Player_Undocked_From_GetawayShip">
                      <conditions>
                        <event_object_undocked_from container="$GetawayShip"/>
                        <check_value value="event.param == $OutcastActor.ship"/>
                        <!-- Players could dock, collect the passenger and get the PassengerShip destroyed while docked-->
                        <check_value value="$feedbackvalue ge 0"/>
                      </conditions>
                      <actions>
                        <cancel_all_orders object="$GetawayShip"/>
                        <create_order object="$GetawayShip" id="'MoveDie'" immediate="true">
                          <param name="byidle" value="false"/>
                          <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch2_Hostage_Landed">
                      <conditions>
                        <event_object_docked_at container="$Ch2_SlaveTraderShip"/>
                        <check_value value="event.param == $OutcastActor.ship"/>
                        <check_value value="$feedbackvalue ge 0"/>
                      </conditions>
                      <delay exact="2s"/>
                      <actions>
                        <!-- Despawn $OutcastActor on $Ch2_SlaveTraderShip -->
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                              param="['add_definition', $OutcastActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = $Ch2_SlaveTraderShip,
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>
                        <remove_npc_template  object="$PassengerShip" template="$NPCPassengerTemplate"/>
                        <signal_cue_instantly cue="Ch2_Meet_Curb" param="'friend'"/>
                      </actions>
                    </cue>
                    <!-- TODO @Heinrich Contingency if the $OutcastActor.ship gets destroyed without the player on board .. -->
                    <cue name="Ch2_Hostage_Ship_Destroyed" version="2">
                      <conditions>
                        <event_object_destroyed object="$OutcastActor.ship"/>
                        <check_value value="$feedbackvalue ge 0"/>
                      </conditions>
                      <actions>
                        <signal_cue_instantly cue="Ch2_Meet_Curb" param="null"/>
                      </actions>
                      <patch sinceversion="2" state="cancelled">
                        <do_if value="cuestate.waiting == Ch2_Meet_Curb.state">
                          <do_if value="$OutcastActor.ship">
                            <reset_cue cue="this"/>
                          </do_if>
                          <do_else>
                            <signal_cue_instantly cue="Ch2_Meet_Curb" param="null"/>
                          </do_else>
                        </do_if>
                      </patch>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_Meet_Curb">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Lines" exact="[[if player.entity.isfemale then 30221237 else 30221236, 1s, Ch2_Meet_Curb_Objective]]"/>
                    <do_if value="event.param == 'friend'">
                      <append_to_list name="$Lines" exact="[if player.entity.isfemale then 30221239 else 30221238]"/>
                    </do_if>

                    <create_order object="$GetawayShip" id="'MoveDie'" immediate="true">
                      <param name="byidle" value="false"/>
                      <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                    </create_order>
                  </actions>
                  <cues>
                    <cue name="Ch2_Meet_Curb_Objective_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="$Lines"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <!--
                      <t id="30221236">Before you leave, you'd better have a little chat with that pilot.</t>
                      <t id="30221237">(spoken to female 'you'){,30221236}</t>
                      <t id="30221238">You may have made a friend after all!</t>
                      <t id="30221239">(spoken to female 'you'){,30221238}</t>     -->
                    </cue>
                    <cue name="Ch2_Meet_Curb_Objective">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- TODO @Heinrich probably better to use step variables -->
                        <set_objective cue="$MissionCue" step="3" action="objective.talkto" object="$CurbActor" updatebriefing="true"/>
                      </actions>
                      <cues>
                        <cue name="Ch2_Meet_Curb_Conversation" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_conversation_started actor="$CurbActor"/>
                              <event_conversation_next_section actor="$CurbActor" section="ch2_curb"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <do_if value="not $Ch2_Meet_Curb_Conversation_Initial?">
                              <set_value name="$Ch2_Meet_Curb_Conversation_Initial"/>
                              <!-- Start moving the ship closer to the target space -->
                              <create_order id="'MoveWait'" object="$Ch2_SlaveTraderShip" immediate="true">
                                <param name="destination" value="[$FuneralGate.sector, $FuneralGate.position]"/>
                                <param name="debugchance" value="$DeepDebugChance"/>
                              </create_order>

                              <!-- Greeting -->
                              <do_if value="player.entity.race == race.split">
                                <do_if value="player.entity.isfemale">
                                  <add_npc_line line="30221233" comment="(Greeting)Pilot is welcomed aboard Slave Trader 3."/>
                                </do_if>
                                <do_else comment="is male">
                                  <add_npc_line line="30221232" comment="(Greeting)Pilot is welcomed aboard Slave Trader 3."/>
                                </do_else>
                              </do_if>
                              <do_else comment="not race.split">
                                <do_if value="player.entity.isfemale">
                                  <add_npc_line line="30221231" comment="(Greeting)Creature is welcomed aboard Slave Trader 3."/>
                                </do_if>
                                <do_else comment="is male">
                                  <add_npc_line line="30221230" comment="(Greeting)Creature is welcomed aboard Slave Trader 3."/>
                                </do_else>
                              </do_else>
                              <!-- Split not fond of your meddling in our matters -->
                              <do_if value="$AffiliationPatriarchy">
                                <add_npc_line line="30221235" comment="Split not fond of Patriarchy meddling with matters of Free Families."/>
                              </do_if>
                              <do_elseif value="$AffiliationFF">
                                <add_npc_line line="30221236" comment="Split not fond of non-entities meddling with matters of Free Families."/>
                              </do_elseif>
                              <do_else>
                                <add_npc_line line="30221234" comment="Split not fond of outsiders meddling with Split matters."/>
                              </do_else>
                              <!-- FFAffiliation Thanked for service in Fires of Defeat -->
                              <do_if value="$AffiliationFF">
                                <do_if value="player.entity.isfemale">
                                  <add_npc_line line="30221238" comment="However, pilot(female) is thanked for her service in Fires of Defeat."/>
                                </do_if>
                                <do_else>
                                  <add_npc_line line="30221237" comment="However, pilot(male) is thanked for his service in Fires of Defeat."/>
                                </do_else>
                              </do_if>
                              <add_npc_line line="30221239" comment="Fugitives have been under surveillance."/>
                              <add_npc_line line="30221240" comment="Contact has been made to negotiate hostage's freedom."/>
                              <add_npc_line line="30221241" comment="Hostage situation was under control."/>
                              <!-- reckless, tried to rescue one of ours-->
                              <do_if value="player.entity.race == race.split">
                                <do_if value="player.entity.isfemale">
                                  <add_npc_line line="30221245" comment="This pilot's reckless behaviour endangered a Split life."/>
                                  <add_npc_line line="30221249" comment="Nonetheless, this pilot did try to rescue one of ours."/>
                                </do_if>
                                <do_else comment="is male">
                                  <add_npc_line line="30221244" comment="This pilot's reckless behaviour endangered a Split life."/>
                                  <add_npc_line line="30221248" comment="Nonetheless, this pilot did try to rescue one of ours."/>
                                </do_else>
                              </do_if>
                              <do_else comment="not split">
                                <do_if value="player.entity.isfemale">
                                  <add_npc_line line="30221243" comment="This creature's reckless behaviour endangered a Split life."/>
                                  <add_npc_line line="30221247" comment="Nonetheless, this creature did try to rescue one of ours."/>
                                </do_if>
                                <do_else comment="is male">
                                  <add_npc_line line="30221242" comment="This creature's reckless behaviour endangered a Split life."/>
                                  <add_npc_line line="30221246" comment="Nonetheless, this creature did try to rescue one of ours."/>
                                </do_else>
                              </do_else>
                            </do_if>

                            <!-- Always -->
                            <!-- Pilot can make amends, meet our ship, also bring customary gift of caviar -->
                            <do_if value="player.entity.isfemale">
                              <add_npc_line line="30221251" comment="So, pilot can make amends by attending funeral of Split war hero."/>
                              <add_npc_line line="30221253" comment="Pilot meet our ship at accelerator in Heart of Acrimony."/>
                              <add_npc_line line="30221255" comment="Pilot also bring customary gift of caviar!"/>
                            </do_if>
                            <do_else>
                              <add_npc_line line="30221250" comment="So, pilot can make amends by attending funeral of Split war hero."/>
                              <add_npc_line line="30221252" comment="Pilot meet our ship at accelerator in Heart of Acrimony."/>
                              <add_npc_line line="30221254" comment="Pilot also bring customary gift of caviar!"/>
                            </do_else>
                          </actions>
                          <delay exact="2s"/>
                          <actions>
                            <!-- Remove Outcast Character -->
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                                  param="['add_definition', $OutcastActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = 'disconnect',
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>
                          </actions>
                        </cue>

                        <cue name="Ch2_Meet_Curb_Conversation_Ended">
                          <conditions>
                            <event_conversation_finished actor="$CurbActor"/>
                            <!-- Make sure the player is not in a conversation (e.g. asking her again and again?) @Heinrich TODO TOTESTFORERRORS-->
                          </conditions>
                          <actions>
                            <remove_mission cue="$MissionCue" type="completed"/>
                            <add_faction_relation faction="faction.player" otherfaction="faction.freesplit" value="0.0032" reason="relationchangereason.missioncompleted"/>
                            <write_to_logbook category="missions" faction="faction.player" title="{30221,2004}" text="if player.entity.isfemale then {30221,2006} else {30221,2005}"/>

                            <cancel_cue cue="Ch2_Retrieve_Hostage_Done"/>

                            <!-- Remove Character -->
                            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                                  param="['add_definition', $CurbActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = 'disconnect',
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <!-- Set Objective "Get Caviar" -->
                            <set_value name="$Ch2_Step_Fly_To_Funeral" exact="2"/>

                            <set_value name="$Description" exact="if player.entity.isfemale then {30221,2103} else {30221,2102}"/>
                            <do_if value="$AffiliationFF">
                              <set_value name="$Description" exact="$Description + '/n/n' + (if player.entity.isfemale then {30221,2106} else {30221,2105})"/>
                            </do_if>
                            <!-- Mission : Tomb of Patriarchs -->
                            <create_mission cue="$MissionCue" description="$Description" name="{30221,2101}" group="missiongroup.story_split"
                                            faction="faction.player" type="missiontype.plot" abortable="false" difficulty="level.easy" rewardtext="{30221,2199}"
                                            icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
                              <briefing>
                                <objective step="1"                              action="objective.acquire_ware"    text="readtext.{20201}.{11501}"/>
                                <objective step="$Ch2_Step_Fly_To_Funeral"       action="objective.flyto"           text="$FuneralGate.knownname" object="$FuneralGate"/>
                              </briefing>
                            </create_mission>
                            <set_objective_from_briefing cue="$MissionCue" step="1"/>
                          </actions>
                          <delay exact="6s"/>
                          <actions>
                            <signal_cue cue="Ch2_On_Curb_Caviar_Dal_240"/>
                          </actions>
                        </cue>

                        <cue name="Ch2_On_Curb_Caviar_Dal_240">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$Dal_Lines_Intel_On_Curb" exact="[[30221240], [30221241], [30221243], [30221244, 1.3s], [30221245, 1.4s], [30221246, 1.4s]]"/>
                            <!--    <t id="30221240">OK, I've found some more data about her in the Trade Station's records.</t>
                                    <t id="30221241">This was apparently a "Curb", a female advisor to male Split decision makers.</t>
                                    <t id="30221243">These Curbs were originally set up by Patriarch Ghus t'Gllt to temper the worst excesses of male Split's enthusiasm.</ t>
                                    <t id="30221244">She belongs to Tkr t'Znk, a minor patriarch who trades in Argon Slaves with the Zyarth Patriarchy.</t>
                                    <t id="30221245">She was probably out here to clean up on the fugitive property mess, which caused a significant loss of face for her male counterpart.</ t>
                                    <t id="30221246">Not that Family Tkr has much reputation to lose these days.</t>                    
                             -->


                            <do_if value="player.entity.inventory.{ware.inv_spaceflycaviar}.count">
                              <!-- Player has Caviar -->
                              <append_to_list name="$Dal_Lines_Intel_On_Curb" exact="[if player.entity.isfemale then 30221248 else 30221247, 2s]"/>
                              <append_to_list name="$Dal_Lines_Intel_On_Curb" exact="[if player.entity.isfemale then 30221250 else 30221249]"/>
                              <append_to_list name="$Dal_Lines_Intel_On_Curb" exact="[if player.entity.isfemale then 30221252 else 30221251]"/>
                              <!--  <t id="30221247">So, caviar! Do you happen to have some on you?</t>
                                    <t id="30221248">(spoken to female 'you'){,30221247}</t>              
                                    <t id="30221249">Indeed you do! That's handy.</t>
                                    <t id="30221250">(spoken to female 'you'){,30221249}</t>
                                    <t id="30221251">Off to the funeral then.</t>
                                    <t id="30221252">(spoken to female 'you'){,30221251}</t>             
                                    -->
                              <set_value name="$EndSignalCue" exact="Ch2_Player_Funeral_Guidance"/>
                            </do_if>
                            <do_elseif value="player.entity.inventory.{ware.inv_spaceflyeggs}.count ge ware.inv_spaceflycaviar.resources.{ware.inv_spaceflyeggs}.count" comment="enough eggs to craft caviar">
                              <set_value name="$EndSignalCue" exact="null"/>
                              <signal_cue cue="Ch2_Aquire_Caviar"/>
                            </do_elseif>
                            <do_else comment="no caviar and not enough eggs to craft">
                              <set_value name="$EndSignalCue" exact="null"/>
                              <signal_cue cue="Ch2_Aquire_Caviar"/>
                            </do_else>
                          </actions>
                          <cues>
                            <cue name="Ch2_On_Curb_Caviar_Dal_240_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="$Dal_Lines_Intel_On_Curb"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="$EndSignalCue"/>
                            </cue>
                          </cues>
                        </cue>

                        <!-- Signalled if the player has no Caviar -->
                        <cue name="Ch2_Aquire_Caviar">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- ware.inv_spaceflycaviar.resources.{ware.inv_spaceflyeggs}.count -->
                            <set_value name="$InventoryTable" exact="table[{ware.inv_spaceflycaviar} = 1]"/>
                            <set_value name="$CollectInventoryStartStep" exact="1"/>
                          </actions>
                          <cues>
                            <cue name="Ch2_Aquire_Caviar_Ref" ref="md.RML_Collect_Inventory.CollectInventory">
                              <param name="EndSignalCue" value="Ch2_Player_Funeral_Guidance"/>
                              <param name="MissionCue" value="Start"/>
                              <param name="StartStep" value="$CollectInventoryStartStep"/>
                              <param name="Objective" value="objective.acquire_ware"/>
                              <param name="WaresParam" value="$InventoryTable"/>
                              <param name="DebugChance" value="$DebugChance"/>
                            </cue>
                            <cue name="Ch2_Acquire_Caviar_Eggs_Hint">
                              <cues>
                                <cue name="Ch2_Acquire_Caviar_Eggs_Init">
                                  <actions>
                                    <!-- Player has enough eggs to warrant the hint -->
                                    <do_if value="player.entity.inventory.{ware.inv_spaceflyeggs}.count ge ware.inv_spaceflycaviar.resources.{ware.inv_spaceflyeggs}.count">
                                      <signal_cue cue="Ch2_Acquire_Caviar_Enough_Eggs_Listener"/>
                                    </do_if>
                                  </actions>
                                </cue>
                                <cue name="Ch2_Acquire_Caviar_Enough_Eggs_Listener">
                                  <conditions>
                                    <check_any>
                                      <check_all>
                                        <event_cue_signalled/>
                                        <check_value value="not player.entity.inventory.{ware.inv_spaceflycaviar}.count"/>
                                      </check_all>
                                      <check_all>
                                        <event_inventory_added object="player.entity"/>
                                        <check_value value="event.param.{ware.inv_spaceflyeggs}?"/>
                                        <check_value value="player.entity.inventory.{ware.inv_spaceflyeggs}.count ge ware.inv_spaceflycaviar.resources.{ware.inv_spaceflyeggs}.count"/>
                                        <check_value value="not player.entity.inventory.{ware.inv_spaceflycaviar}.count"/>
                                      </check_all>
                                    </check_any>
                                  </conditions>
                                  <actions>
                                    <!-- Add Boso Voiceline Hint on Crafting -->
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                            <cue name="Ch2_Acquire_Caviar_Done">
                              <cues>
                                <cue name="Ch2_Acquire_Caviar_Done_Init">
                                  <actions>
                                    <!-- Player has enough eggs to warrant the hint -->
                                    <do_if value="player.entity.inventory.{ware.inv_spaceflycaviar}.count">
                                      <signal_cue cue="Ch2_Acquire_Caviar_Done_Listener"/>
                                    </do_if>
                                  </actions>
                                </cue>
                                <cue name="Ch2_Acquire_Caviar_Done_Listener">
                                  <conditions>
                                    <check_any>
                                      <event_cue_signalled/>
                                      <check_all>
                                        <event_inventory_added object="player.entity"/>
                                        <check_value value="event.param.{ware.inv_spaceflycaviar}?"/>
                                      </check_all>
                                    </check_any>
                                  </conditions>
                                  <delay exact="5s"/>
                                  <actions>
                                    <do_if value="Ch2_Player_Funeral_Guidance.state == cuestate.waiting">
                                      <debug_text text="'RML Failed to signnal Funeral Guidance'"/>
                                      <signal_cue cue="Ch2_Player_Funeral_Guidance"/>
                                    </do_if>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                            <cue name="Ch2_Player_Add_Caviar_DEBUG">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <add_inventory ware="ware.inv_spaceflycaviar" exact="1"/>
                              </actions>
                            </cue>
                            <cue name="Ch2_Player_Add_Eggs_DEBUG">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <add_inventory ware="ware.inv_spaceflyeggs" exact="ware.inv_spaceflycaviar.resources.{ware.inv_spaceflyeggs}.count"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_Caviar_Guidance">
                          <cues>
                            <!--<cue name="Ch2_Player_Missing_Resources">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <find_gate   name="$JumpGate"      accelerator="false" space="$HeartOfAcrimonySector"/>
                                <create_position name="$Offset" object="$JumpGate" space="$HeartOfAcrimonySector" min="50km" max="75km"/>
                                <create_object macro="macro.env_debris_split_s_01_macro" name="$CaviarTrader" sector="$HeartOfAcrimonySector">
                                  <safepos value="$Offset"/>
                                </create_object>
                                <set_object_min_hull object="$CaviarTrader" exact="1"/>

                                <set_value name="$EggsRequired" exact="ware.inv_spaceflycaviar.resources.{ware.inv_spaceflyeggs}.count"/>

                                <create_group groupname="$Eggs"/>
                                <do_all exact="($EggsRequired / 3) + 1" comment="The drop definition guarantees 3 eggs">
                                  <spawn_drop object="$CaviarTrader" drop="'drops_splitstory_spaceflyeggs'"/>
                                </do_all>
                                <find_object name="$Drops" class="class.collectable" space="$CaviarTrader.zone" multiple="true"/>
                                <do_for_each in="$Drops" name="$d">
                                  <set_object_min_hull object="$d" exact="1"/>
                                  <add_to_group groupname="$Eggs" object="$d"/>
                                </do_for_each>
                                <set_objective cue="$MissionCue" action="objective.collect" group="$Eggs"/>
                              </actions>
                            </cue>-->
                          </cues>
                        </cue>

                        <cue name="Ch2_Player_Funeral_Guidance">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!--<cancel_cue cue="Ch2_Player_Has_Eggs"/>-->

                            <!-- Curb of Family Tkr-->
                            <set_entity_overrides entity="$CurbActor" icon="'factionrepresentative'" title="'{30221,155}'"/>

                            <set_objective_from_briefing cue="$MissionCue" step="$Ch2_Step_Fly_To_Funeral"/>
                          </actions>
                          <cues>
                            <cue name="Ch2_Player_Left_Curb_Ship">
                              <delay exact="13s"/>
                              <actions>
                                <set_value name="$FoundPlayer" exact="false" comment="Player is still on the Mission Ship"/>

                                <set_value name="$ContainerShip" exact="player.ship"/>
                                <do_if value="$ContainerShip == $Ch2_SlaveTraderShip">
                                  <set_value name="$FoundPlayer" exact="true"/>
                                </do_if>
                                <do_else>
                                  <!-- Player is not directly on the ship, but might be on a ship docked on the ship -->
                                  <do_if value="$ContainerShip">
                                    <do_while value="$ContainerShip.ship.exists">
                                      <set_value name="$ContainerShip" exact="$ContainerShip.ship"/>
                                      <do_if value="$ContainerShip == $Ch2_SlaveTraderShip">
                                        <set_value name="$FoundPlayer" exact="true"/>
                                        <break/>
                                      </do_if>
                                    </do_while>
                                  </do_if>
                                </do_else>

                                <do_if value="$FoundPlayer">
                                  <reset_cue cue="this"/>
                                </do_if>
                                <do_else>
                                  <signal_cue cue="Ch2_SlaveTrader_Despawn"/>
                                  <signal_cue cue="Ch2_Study_Funeral_Setup"/>
                                </do_else>
                              </actions>
                            </cue>

                            <cue name="Ch2_SlaveTrader_Despawn">
                              <!-- TODO: Check again with Nick & Owen if that's necessary;
                                         Checking the MoveDie Target for player owned ships should go in the ai order -->
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch2_Meet_Curb_Remove_Ship">
                                  <!-- Removing the ship:
                                  - make sure the player.entity is not on it
                                  - find components playerowned;
                                  - if neither player nor playerowned stuff is on it, forbid docking and moveDie,
                                  - check if forbidding docking also forbids spacesuit docking @Heinrich TODO
                                  -->
                                  <delay exact="197s"/>
                                  <actions>
                                    <set_value name="$FoundPlayerOwnedOnShip" exact="false"/>

                                    <set_value name="$ContainerShip" exact="player.ship"/>
                                    <do_if value="$ContainerShip == $Ch2_SlaveTraderShip">
                                      <set_value name="$FoundPlayerOwnedOnShip" exact="true"/>
                                    </do_if>
                                    <do_else>
                                      <!-- Player is not directly on the ship, but might be on a ship docked on the ship -->
                                      <do_while value="$ContainerShip.ship.exists">
                                        <set_value name="$ContainerShip" exact="$ContainerShip.ship"/>
                                        <do_if value="$ContainerShip == $Ch2_SlaveTraderShip">
                                          <set_value name="$FoundPlayerOwnedOnShip" exact="true"/>
                                          <break/>
                                        </do_if>
                                      </do_while>
                                    </do_else>

                                    <do_if value="not $FoundPlayerOwnedOnShip">
                                      <!-- If the player is not on the ship, check if they left other ships on the ship -->
                                      <find_object_component name="$DockedShips" object="$Ch2_SlaveTraderShip" class="class.ship" owner="faction.player" multiple="true"/>
                                      <do_if value="$DockedShips.count">
                                        <set_value name="$FoundPlayerOwnedOnShip" exact="true"/>
                                      </do_if>
                                    </do_if>

                                    <do_if value="$FoundPlayerOwnedOnShip">
                                      <reset_cue cue="this"/>
                                      <!-- if the player is on the ship or has ships on the ship, check again in ~3 minutes (maybe increase the time so we don't check so often in case the player has decided to leave a ship there) -->
                                      <!-- Look into ejecting player ships -->
                                    </do_if>
                                    <do_else>
                                      <!-- disallow docking -->
                                      <!-- movedie this ship -->
                                      <set_object_docking_enabled object="$Ch2_SlaveTraderShip" enabled="false"/>
                                      <create_order object="$Ch2_SlaveTraderShip" id="'MoveDie'" immediate="true">
                                        <param name="byidle" value="false"/>
                                        <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                                      </create_order>
                                    </do_else>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch2_Force_Funeral">
              <force name="Plot_Split_Ch2_Funeral">
                <force_cue cue="Ch2_Study_Funeral_Setup"/>
              </force>
            </cue>

            <cue name="Ch2_Study_Funeral_Setup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <cancel_cue cue="Ch2_Study_Retrieve_Person"/>
                <set_value name="$LoyalistActorCurrentName" exact="$LoyalistActorFakeNames.random"/>
                <remove_from_list name="$LoyalistActorFakeNames" exact="$LoyalistActorCurrentName"/>
                <set_object_name object="$LoyalistActor" page="30221" line="$LoyalistActorCurrentName"/>
              </actions>
              <cues>
                <!-- Create Positions / Rotations -->
                <cue name="Ch2_Study_Place_FuneralServiceShip">
                  <actions>
                    <create_position name="$FuneralLaunchPos" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="1km"/>
                    <create_position name="$FuneralTargetPos" object="$FuneralGate.exit" space="$FuneralGate.exit.sector" x="0km" y="0km" z="5km"/>

                    <create_rotation name="$FaceFuneralGate"
                                     pitch="$FuneralGate.rotation.pitch"
                                     roll="$FuneralGate.rotation.roll"
                                     yaw="$FuneralGate.rotation.yaw + 180deg"/>
                    <create_rotation name="$FaceFuneralGateExit"
                                 pitch="$FuneralGate.exit.rotation.pitch"
                                 roll="$FuneralGate.exit.rotation.roll"
                                 yaw="$FuneralGate.exit.rotation.yaw + 180deg"/>
                    <!-- FUNERAL SERVICE SHIP -->
                    <create_ship name="$FuneralServiceShip" capturable="false" sector="$FuneralGate.sector" missioncue="namespace" macro="ship_spl_l_trans_container_01_a_macro">
                      <people>
                        <fillpercent exact="0"/>
                      </people>
                      <paint ware="$PaintMod_FuneralServiceShip"/>
                      <!--<loadout loadout=""/>-->
                      <owner exact="faction.civilian"/>
                      <pilot>
                        <select race="race.drone"/>
                        <!-- tags="tag.aipilot" -->
                      </pilot>
                      <position x="$FuneralLaunchPos.x" y="$FuneralLaunchPos.y" z="$FuneralLaunchPos.z"/>
                      <rotation value="$FaceFuneralGate"/>
                    </create_ship>
                    <set_object_relation_behaviour object="$FuneralServiceShip" disable="true"/>
                    <set_object_min_hull object="$FuneralServiceShip" exact="33"/>
                    <set_ship_safepos_allowed ship="$FuneralServiceShip" allow="false"/>

                    <set_object_name object="$FuneralServiceShip" page="30221" line="209" comment="Funeral Service Ship"/>
                    <create_order id="'Wait'" object="$FuneralServiceShip" immediate="true">
                      <param name="noattackresponse" value="true"/>
                    </create_order>

                    <find_dockingbay name="$FuneralServiceDock" object="$FuneralServiceShip" checkoperational="true" multiple="false">
                      <match_dock size="tag.dock_s" storage="true"/>
                    </find_dockingbay>

                    <cancel_cue cue="Ch2_Meet_Curb_Conversation"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $CurbActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $FuneralServiceShip,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $LoyalistActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $FuneralServiceShip,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $FuneralServiceShip,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                  </actions>
                  <cues>
                    <!-- @Heinrich TODO Deliver Inventory has a "standard thanks" which will not work since Curb is not a generic character -->
                    <cue name="Ch2_Deliver_Caviar_Ref" ref="md.RML_Deliver_Inventory.Deliver_Inventory">
                      <param name="EndSignalCue"    value="Ch2_Deliver_Caviar_Continue_Conversation"/>
                      <param name="MissionCue"      value="$MissionCue"/>
                      <param name="StartStep"       value="3"           comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"  value="true"        comment="Update the briefing objective step when the objective is updated"/>

                      <!--Delivery params-->
                      <param name="WaresTableParam"         value="table[{ware.inv_spaceflycaviar} = 1]"/>
                      <param name="DeliveryNPC"             value="$CurbActor"      comment="The NPC to which the items should be delivered." />
                      <param name="DeliveryObject"          value="$FuneralServiceShip"  comment="The object on which to point to before the NPC is placed. Also used to create the interior with the below parameters" />
                      <param name="ProgressBarText"         value="{30004,1054}" comment="Text to be displayed next to the ware delivery progress bar e.g. ('Delivered')"/>
                      <param name="ConversationOptionText"  value="{30221,2151}" comment="(Player Choice)I brought the caviar."/>
                      <param name="ConversationTipText"     value="{30221,2152}" comment="(Tooltip for an unselectable Player Choice)Insufficient Inventory"/>
                      <!--<param name="DeliveryNPCLine"         value="30221256"/>-->
                      <param name="PlaceNPC"                value="false" comment="we place them ourselves now"/>
                      <param name="DebugChance"             value="$DeepDebugChance"/>
                    </cue>
                    <!-- Catch failed delivery before progress? -->
                    <cue name="Ch2_Deliver_Caviar_Continue_Conversation">
                      <conditions>
                        <!--<event_speak_finished actor="$CurbActor" line="30221256" comment="Split accept offering."/>-->
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <add_npc_line line="30221256" comment="Split accept offering."/>
                        <add_npc_line line="if player.entity.isfemale then 30221261 else 30221260" comment="Guest may interact with others."/>
                        <add_npc_line line="30221262" comment="Ceremony starts soon."/>
                      </actions>
                      <cues>
                        <cue name="Ch2_Deliver_Caviar_Conversation_Done">
                          <conditions>
                            <event_conversation_finished actor="$CurbActor"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch2_Funeral_Conversations"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_Outcast_Conversation" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_started actor="$OutcastActor"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <add_npc_line line="if player.entity.isfemale then 30221241 else 30221240" comment="Split grateful for your honourable actions."/>
                        <do_if value="$AffiliationFF">
                          <add_npc_line line="if player.entity.isfemale then 30221243 else 30221242" comment="Do not give up resistance yet."/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch2_Loyalist_Conversation_Greeting" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_started actor="$LoyalistActor"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <add_npc_line line="if player.entity.isfemale then 30221202 else 30221201" comment="Hrm. You again."/>
                        <do_if value="not $Ch2_Meet_Loyalist_Conversation_Initial?">
                          <set_value name="$Ch2_Meet_Loyalist_Conversation_Initial"/>
                          <add_npc_line hidechoices="true" line="30221203" comment="Both searching ravaged space."/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch2_Funeral_Conversations">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch2_Loyalist_Conversation_Greeting"/>
                        <create_group groupname="$Guests"/>
                        <add_to_group groupname="$Guests" list="[$LoyalistActor, $OutcastActor]"/>
                        <set_objective cue="$MissionCue" action="objective.talkto" group="$Guests"/>
                        <!-- @Heinrich TOOD Mission Steps -->
                      </actions>
                      <cues>
                        <cue name="Ch2_Loyalist_Conversation" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_conversation_started actor="$LoyalistActor"/>
                              <event_conversation_next_section actor="$LoyalistActor" section="ch2_loyalist"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <do_if value="event.name == 'event_conversation_started'">
                              <do_if value="$Ch2_Accepted_Investigation?">
                                <add_npc_line hidechoices="true" line="30221203" comment="Both searching ravaged space."/>
                              </do_if>
                              <do_else>
                                <add_npc_line hidechoices="true" line="if player.entity.isfemale then 30221205 else 30221204"
                                              comment="Split heard your tracked down rebels and released hostage."/>

                                <do_if value="not $Ch2_Meet_Loyalist_Conversation_Initial?">
                                  <add_npc_line hidechoices="true" line="30221206" comment="That reckless Split always find trouble."/>
                                  <do_if value="$AffiliationPatriarchy">
                                    <add_npc_line hidechoices="true" line="if player.entity.isfemale then 30221208 else 30221207"
                                                  comment="Given your training, success was to be expected."/>
                                  </do_if>
                                </do_if>

                                <add_npc_line hidechoices="true" line="if player.entity.isfemale then 30221210 else 30221209"
                                              comment="You track them down quick. Split have request for you."/>

                                <do_if value="$LoyalistAngryness lt 0" comment="dangerous opinions">
                                  <add_npc_line hidechoices="true" line="if player.entity.isfemale then 30221212 else 30221211"
                                                comment="Might improve your reputation here."/>
                                </do_if>
                                <add_player_choice text="{30221,2153}" section="ch2_loyalist" choiceparam="'ch2_interested'" comment="(Player Choice)OK, I'm listening.(Addressing male, Request)"/>
                              </do_else>
                            </do_if>
                            <do_elseif value="event.name == 'event_conversation_next_section'">
                              <do_if value="event.param2 == 'ch2_interested'">
                                <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                                  <text line="30221213" comment="Local Patriarch Noa t'Hlp faces justice at Hall of Judgement."/>
                                  <text line="30221214" comment="Accusation is witholding reparations to Zyarth Patriarchy."/>
                                  <text line="30221215" comment="He says he is not wealthy enough for such demands."/>
                                  <text line="30221216" comment="Says his financial records were stolen."/>
                                  <text line="30221217" comment="Former business partners gave evidence, showing many slaves bought from him." delay="0.5s"/>
                                  <text line="30221218" comment="Punishment sould not be applied without proper investigation, but other Split not willing to take a stand." delay="0.5s"/>
                                </add_npc_line>

                                <do_if value="player.entity.race == race.split">
                                  <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                                    <text line="if player.entity.isfemale then 30221220 else 30221219" comment="As honourable Split, maybe you help with investigation."/>
                                  </add_npc_line>
                                </do_if>
                                <do_else>
                                  <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                                    <text line="if player.entity.isfemale then 30221222 else 30221221" comment="As outsider, maybe you help with investigation."/>
                                  </add_npc_line>
                                </do_else>
                                <add_npc_line speaker="$DalBusta" hidechoices="true">
                                  <text line="30221257" comment="This sounds like a way in for us."/>
                                  <text line="if player.entity.isfemale then 30221259 else 30221258" comment="Let's do it!"/>
                                </add_npc_line>
                                <add_player_choice text="{30221,2154}" section="ch2_loyalist" choiceparam="'ch2_agreed'" comment="Agreed."/>
                              </do_if>
                              <do_elseif value="event.param2 == 'ch2_agreed'">
                                <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                                  <text line="30221223" comment="Very well."/>
                                  <text line="30221224" comment="Split wait for information to support release of Patriarch."/>
                                </add_npc_line>
                                <set_value name="$Ch2_Accepted_Investigation"/>
                              </do_elseif>
                            </do_elseif>
                          </actions>
                        </cue>

                        <cue name="Ch2_Loyalist_MissionAccepted">
                          <conditions>
                            <event_conversation_finished actor="$LoyalistActor"/>
                            <check_value value="$Ch2_Accepted_Investigation?"/>
                          </conditions>
                          <actions>
                            <set_objective cue="$MissionCue" action="objective.wait" text="{30221,2160}"/>
                            <signal_cue cue="Ch2_Funeral_Ceremony"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <!-- Player_Docked 
                <event_object_docked_at container="$FuneralServiceShip"/>
                    <check_value value="event.object == $FuneralServiceShip"/>
                    <check_any>
                      <check_value value="player.ship == $FuneralServiceShip"/>
                      <check_value value="(player.ship.dock.exists) and (player.ship.dock.container == $FuneralServiceShip)"/>
                    </check_any>                  
                -->

                <cue name="Ch2_Funeral_Ceremony">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <!-- Conversations can be held, Ceremony Cutscene -->
                  <!-- This activates the Accelerator and should make sure that the player cannot smuggle anything through it! -->
                  <!-- Possible Issue: Activated Accelerator sends well placed ships through immediately -->
                  <!-- Basic idea: Run around and talk to everyone, after completing the last dialogue we take away player control and play the funeral scene -->
                  <!-- 2nd Time the player has more control and can hide in the retrieved ship -->
                  <cues>
                    <cue name="Ch2_Undock_Coffin">
                      <actions>
                        <!-- PLACE Coffin Ship -->
                        <create_loadout result="$loadout" comment="Courier Tuatara Loadout">
                          <macros>
                            <engine macro="engine_spl_s_combat_01_mk3_macro"    path="../con_engine_01" />
                            <engine macro="engine_spl_s_combat_01_mk3_macro"    path="../con_engine_02" />
                            <engine macro="engine_spl_s_combat_01_mk3_macro"    path="../con_engine_03" />
                            <weapon macro="weapon_gen_s_laser_01_mk1_macro"     path="../con_weapon_01"/>
                          </macros>
                          <virtualmacros>
                            <thruster macro="thruster_gen_s_combat_01_mk3_macro" />
                          </virtualmacros>
                        </create_loadout>
                        <!-- Courier Tuatara Spawn -->
                        <create_cue_actor name="$DeadPatriarch" cue="$MissionCue">
                          <select race="race.drone"/>
                          <owner exact="faction.ownerless"/>
                        </create_cue_actor>

                        <create_ship name="$FuneralCoffinShip" capturable="false" commandeerable="false"
                                     missioncue="namespace"
                                     macro="ship_spl_s_trans_container_01_plot_01_macro"
                                     dock="$FuneralServiceDock">
                          <owner exact="faction.ownerless"/>
                          <loadout loadout="$loadout"/>
                          <pilot actor="$DeadPatriarch"/>
                          <!--<select race="race.drone" tags="tag.aipilot"/>                            
                          </pilot>-->
                          <people>
                            <fillpercent exact="0"/>
                          </people>
                          <paint ware="$PaintMod_FuneralCoffinShip"/>
                          <!--
                          <position x="$FuneralLaunchPos.x" y="$FuneralLaunchPos.y" z="$FuneralLaunchPos.z"/>
                          <rotation value="$FaceFuneralGate"/> -->
                        </create_ship>
                        <set_object_relation_behaviour object="$FuneralCoffinShip" disable="true"/>
                        <set_object_name object="$FuneralCoffinShip" page="30221" line="208" comment="Coffin ship"/>
                        <set_object_min_hull object="$FuneralCoffinShip" exact="50"/>
                        <set_ship_safepos_allowed ship="$FuneralCoffinShip" allow="false"/>
                      </actions>
                      <delay exact="0.5s"/>
                      <actions>
                        <!-- x right, z frontal -->
                        <!--                        
                        <create_position name="$FuneralOffset" object="$FuneralServiceShip.dock.launchpos" space="$FuneralServiceShip.sector" z="150m" y="150m"/>
                        <create_object name="$DerelictBeacon" macro="macro.env_deco_nav_beacon_t5_mission_macro" owner="faction.buccaneers" sector="$FuneralServiceShip.sector">
                          <position x="$FuneralOffset.x" y="$FuneralOffset.y" z="$FuneralOffset.z"/>
                        </create_object>                      
                        -->

                        <find_dockingbay name="$sdock" object="$FuneralCoffinShip.container">
                          <match_dock size="tag.dock_s"/>
                        </find_dockingbay>
                        <create_position name="$FuneralCoffinShipLaunchPos" x="$sdock.launchpos.x" y="$sdock.launchpos.y + 40m" z="$sdock.launchpos.z + 100m"/>
                        <create_order object="$FuneralCoffinShip" id="'MoveWait'">
                          <param name="destination" value="[$sdock, $FuneralCoffinShipLaunchPos]"/>
                          <param name="precise" value="true"/>
                        </create_order>

                        <!--<create_order id="'Undock'" object="$FuneralCoffinShip" immediate="true"/>-->

                        <play_cutscene result="this.$CutsceneID" key="'Story_Split_Funeral_Accelerator'" abortable="false">
                          <param name="target_gate" object="$FuneralGate"/>
                          <param name="target_ship" object="$FuneralServiceShip"/>
                        </play_cutscene>
                      </actions>
                      <cues>

                        <!-- $Ch2_FuneralSteps_Undocked -->
                        <cue name="Ch2_Funeral_Steps_Coffin_Undocked">
                          <conditions>
                            <event_object_undocked_from container="$FuneralServiceShip"/>
                            <check_value value="event.param == $FuneralCoffinShip"/>
                          </conditions>
                          <actions>
                            <set_value name="$Ch2_FuneralSteps_Undocked"/>
                            <!--<dismiss_control_entity object="$FuneralCoffinShip" actor="$DeadPatriarch"/>-->
                          </actions>
                          <delay exact="60s"/>
                          <actions>
                            <!--<signal_cue_instantly cue="Ch2_Funeral_Steps_Coffin_Fireworks"/>-->
                            <!--<signal_cue_instantly cue="Ch2_Funeral_Steps_Move_Coffin"/>-->
                          </actions>
                        </cue>

                        <!-- Start Fireworks - Only if Signalled and $Ch2_FuneralSteps_Undocked? -->
                        <cue name="Ch2_Funeral_Steps_Coffin_Fireworks">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch2_Funeral_Fireworks_Init" checkinterval="1s">
                              <conditions>
                                <check_value value="$Ch2_FuneralSteps_Undocked?"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch2_Launch_Coffin_Countermeasures_Loop"/>
                              </actions>
                            </cue>
                            <cue name="Ch2_Launch_Coffin_Countermeasures_Loop">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="0.7s"/>
                              <actions>
                                <add_ammo object="$FuneralCoffinShip" macro="macro.countermeasure_flares_01_macro" amount="1"/>
                                <launch_countermeasures object="$FuneralCoffinShip"/>
                                <signal_cue cue="Ch2_Launch_Countermeasures_Refire"/>
                                <reset_cue cue="this"/>
                              </actions>
                            </cue>
                            <cue name="Ch2_Launch_Countermeasures_Refire">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="0.7s"/>
                              <actions>
                                <do_if value="$BoneYardSector != $FuneralCoffinShip.sector">
                                  <signal_cue cue="Ch2_Launch_Coffin_Countermeasures_Loop"/>
                                  <reset_cue cue="this"/>
                                </do_if>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <!-- Move Coffin Set $Ch2_FuneralSteps_GateClosed-->
                        <cue name="Ch2_Funeral_Steps_Move_Coffin">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!--<assign_control_entity object="$FuneralCoffinShip" post="controlpost.aipilot" actor="$DeadPatriarch" transfer="true"/>-->
                            <set_object_active object="$FuneralGate" activate="true"/>
                            <create_order object="$FuneralCoffinShip" id="'MoveDie'" immediate="true">
                              <param name="atstation" value="$BoneyardCarrier"/>
                              <param name="byidle" value="false"/>
                              <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                            </create_order>
                          </actions>
                          <cues>

                            <cue name="Ch2_Coffin_Reached_Sector_Ref" ref="md.LIB_Generic.ReachedSector">
                              <param name="TargetObject" value="$FuneralCoffinShip"/>
                              <param name="TargetSector" value="$BoneYardSector"/>
                              <param name="SuccessSignalCue" value="Ch2_Coffin_In_Sector"/>
                            </cue>

                            <cue name="Ch2_Coffin_In_Sector">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_object_active object="$FuneralGate" activate="false"/>
                              </actions>
                              <cues>
                                <cue name="Ch2_Gate_Close_Failsafe">
                                  <delay exact="0.1s"/>
                                  <actions>
                                    <do_if value="$FuneralGate.isactive" comment="Gate failed to close once in testing">
                                      <set_object_active object="$FuneralGate" activate="false"/>
                                      <reset_cue cue="this"/>
                                    </do_if>
                                    <do_else>
                                      <set_value name="$Ch2_FuneralSteps_GateClosed"/>
                                    </do_else>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <!-- Stop Cutscene -->
                        <cue name="Ch2_Stop_Cutscene">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <stop_cutscene cutscene="parent.$CutsceneID"/>

                            <set_value name="$Ch2b_RemoveMissionLater"/>
                            <!--<remove_mission cue="$MissionCue" type="completed"/>
                            <set_value name="$Description" exact="if player.entity.isfemale then {30221,2112} else {30221,2111}"/>
                            <do_if value="$AffiliationFF">
                              -->
                            <!-- Replace the former Description -->
                            <!--
                              <set_value name="$Description" exact="if player.entity.isfemale then {30221,2114} else {30221,2113}"/>
                            </do_if>
                            -->
                            <!-- Tomb of Patriarchs -->
                            <!--
                            <write_to_logbook category="missions" faction="faction.player" title="{30221,2101}" text="$Description"/>-->

                          </actions>
                        </cue>

                        <cue name="Ch2_Funeral_Speech">
                          <conditions>
                            <event_cutscene_started cutscene="parent.$CutsceneID"/>
                          </conditions>
                          <cues>
                            <cue name="Ch2_Funeral_Speech_Curb_1">
                              <actions>
                                <play_music music="'music_story_split_funeral'"/>
                                <speak actor="$CurbActor" priority="90" voiceover="true">
                                  <text line="30221270" delay="2s" comment="Guests will now honour fallen Patriarch Gau t'Pg."/>
                                  <text line="30221271" comment="Gau t'Pg took up arms to face Zyarth Tyranny."/>
                                  <text line="30221272" comment="A witness will now speak of his bravery!"/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Ch2_Funeral_Speech_Outcast_1">
                              <conditions>
                                <event_speak_finished actor="$CurbActor" line="30221270"/>
                              </conditions>
                              <actions>
                                <speak actor="$OutcastActor" priority="90" voiceover="true">
                                  <text line="30221245" comment="This Split flew under Gau t'Pg in the Fires." delay="0.6s"/>
                                  <text line="30221246" comment="Honourable fighters and transports took on Zyarth armada." delay="0.6s"/>
                                  <text line="30221247" comment="Big Argnu Gau t'Pg not know how to retreat." delay="0.6s"/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Ch2_Funeral_Speech_Laughter">
                              <conditions>
                                <event_speak_finished actor="$OutcastActor" line="30221245"/>
                              </conditions>
                              <actions>
                                <!--<speak actor="$OutcastActor" priority="90" line="1008" caninterrupt="false" voiceover="true" comment="laughter" recipient="$OutcastActor" delay="0.3s"/>-->
                                <speak actor="$LoyalistActor" priority="90" line="1008" caninterrupt="false" voiceover="true" comment="laughter" recipient="$LoyalistActor"/>
                              </actions>
                            </cue>
                            <cue name="Ch2_Funeral_Speech_Outcast_2">
                              <conditions>
                                <check_any>
                                  <event_speak_finished actor="$OutcastActor" line="1008"/>
                                  <event_speak_finished actor="$LoyalistActor" line="1008"/>
                                </check_any>
                              </conditions>
                              <actions>
                                <speak actor="$OutcastActor" priority="90" voiceover="true">
                                  <text line="30221249" comment="Attacking Rattlesnake belonging to Zyarth, Patriarch attacked turret head-on." delay="0.6s"/>
                                  <text line="30221250" comment="Split witnessed this." delay="1s"/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Ch2_Funeral_Speech_Curb_2">
                              <conditions>
                                <event_speak_finished actor="$OutcastActor" line="30221249"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch2_Funeral_Steps_Coffin_Fireworks"/>
                                <speak actor="$CurbActor" priority="90" voiceover="true">
                                  <text line="30221274" comment="War hero of Free Families." delay="2s"/>
                                  <text line="30221275" comment="Patriarch gave life for Split freedom."/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Ch2_Funeral_Speech_Curb_2_b" comment="triggers during Curb_2">
                              <conditions>
                                <event_speak_finished actor="$CurbActor" line="30221274"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch2_Funeral_Steps_Move_Coffin"/>
                                <speak actor="$CurbActor" priority="90" voiceover="true">
                                  <text line="30221276" comment="All guests shall remember his name."/>
                                  <text line="30221277" comment="All guests shall glorify his victories."/>
                                  <text line="30221278" comment="Until greater deeds are done."/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Ch2_Funeral_Speech_Done">
                              <conditions>
                                <event_speak_finished actor="$CurbActor" line="30221276"/>
                              </conditions>
                              <actions>
                                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                                      param="['add_definition', $CurbActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = 'disconnect',
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>
                                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                                      param="['add_definition', $LoyalistActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = 'disconnect',
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>
                                <cancel_cue cue="Ch2_Outcast_Conversation"/>
                                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                                      param="['add_definition', $OutcastActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = 'disconnect',
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>
                                <add_faction_relation faction="faction.player" otherfaction="faction.freesplit" value="0.0016" reason="relationchangereason.missioncompleted"/>
                                <signal_cue cue="Ch2_Stop_Cutscene"/>
                              </actions>
                              <delay exact="10s"/>
                              <actions>
                                <signal_cue cue="Ch2_Brief_Funds_Mission"/>
                              </actions>
                            </cue>

                            <cue name="Ch2_Brief_Funds_Mission">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch2_On_Curb_Caviar_Dal_296_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$DalBusta"/>
                                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                  <param name="Lines"             value="[
                                                                      [30221926],
                                                                      [30221927],
                                                                      [30221928],
                                                                      [30221929]
                                                                      ]"/>
                                  <!-- <t id="30221926">Let's see if we can help this Patriarch and make him owe us a favour.</t>
                                   <t id="30221927">He declared his own financial records as stolen, and I don't see any way for us to locate those.</t>
                                   <t id="30221928">But we can review the claims of his business partners.</t>
                                   <t id="30221929">The Trading Station ought to have records of those transactions, but I'll need Boso's help to access those.(translate Trading Station as in {20102,1051})</t>
                              -->
                                  <param name="MissionCue"        value="if $Ch2b_RemoveMissionLater? then $MissionCue else null"/>
                                  <param name="IsInMission"       value="$Ch2b_RemoveMissionLater?"/>
                                  <param name="EndSignalCue"      value="Ch2_MissionAccepted_Done_v2"/>
                                </cue>
                                <cue name="Ch2_MissionAccepted_Done_v2">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <signal_cue cue="Ch2_Identify_Funds"/>
                                  </actions>
                                  <cues>
                                    <cue name="Ch2_Story_Reminder" checkinterval="1s" onfail="cancel">
                                      <conditions>
                                        <check_value value="Ch2_Objective_Scan.state == cuestate.waiting"/>
                                      </conditions>
                                      <cues>
                                        <cue name="Ch2_Story_Reminder_v2_Ref" ref="md.Story_Paranid.Story_Reminder">
                                          <param name="Actor"       value="$DalBusta"/>
                                          <param name="CutsceneKey" value="$DalCutsceneKey"/>
                                          <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30200108 else 30200107]]"/>
                                          <param name="CancelCue"   value="Ch2_Objective_Scan"/>
                                          <param name="Delay"       value="20min"/>
                                          <param name="MissionCue"        value="if $Ch2b_RemoveMissionLater? then $MissionCue else null"/>
                                          <param name="IsInMission"       value="$Ch2b_RemoveMissionLater?"/>
                                          <!--  <t id="30200001">Hey there partner.</t>
                                          <t id="30200002">(spoken to female player){10111,30200001}</t>
                                          <t id="30200105">Don't keep our contact waiting for too long.</t>
                                          <t id="30200106">(spoken to female player){,30200105}</t>
                                          <t id="30200107">Where have you wandered off to?</t>
                                          <t id="30200108">(spoken to female player 'you'){,30200107}</t>    -->
                                        </cue>
                                      </cues>
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch2_Identify_Funds" comment="Resetable (using $BosoSaid to not play lines twice where it would be odd)">
              <conditions>
                <event_cue_signalled/>
                <!-- TODO precache-hint the station ... -->
              </conditions>
              <!--
              Input: Probably Trading Station;
              [OUTDATED: A station which offers GMs against specific families (maybe Tkr 'has been trying to make amends with the patriarchy')]
              The player puts a satellite next to a signal leak (100m, update every 1s not every 5s)
              Solve Signal Leak, Reroute (likely Boron) for a specific story point
              //OPTIONAL later: Player causes the Leak? Player repairs the decaying Satellite during transaction?
          -->
              <actions>
                <set_value name="$ResetableCue"               exact="this"/>
                <set_value name="$SignalLeakStationLast"      exact="if $SignalLeakStation? then $SignalLeakStation else null"/>
                <set_value name="$SignalLeakStation"          exact="null"/>
                <set_value name="$SignalLeakLocationLast"     exact="if $SignalLeakLocation? then $SignalLeakLocation else null"/>
                <set_value name="$SignalLeakLocation"         exact="null"/>
                <set_value name="$SignalLeak"                 exact="null"/>
                <set_value name="$MaxDistanceLeakToSatellite" exact="5000m"/>
                <create_group groupname="$SignalLeakSatellites"/>
                <create_group groupname="$SignalLeakSatellitesWorking"/>

                <substitute_text text="$ObjectiveTextSatellite" source="readtext.{30136}.{130}" chance="if $ObjectiveTextSatellite? then 0 else 100">
                  <replace string="'$NUMBER$'"     with="''" comment="Satellite at target position"/>
                </substitute_text>

                <!--
            <append_to_list name="md.Signal_Leaks.Manager.$SuppressSignalLeakFactions" exact="faction.fallenfamilies"/>-->
                <!-- todo: another reset by going out of sector just in case the signal leak is bad -->
              </actions>
              <cues>

                <cue name="Ch2_Debug_Blowup_LeakStation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <destroy_object object="$SignalLeakStation" explosion="true"/>
                  </actions>
                </cue>

                <cue name="Ch2_Debug_Blowup_Satellite">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <destroy_group group="$SignalLeakSatellites"/>
                  </actions>
                </cue>

                <!-- SETUP $SignalLeakStation OBJECTIVE TravelTo Station -->
                <cue name="Ch2_Choose_LeakStation">
                  <!-- Setup $SignalLeakStation -->
                  <actions>

                    <find_station_by_true_owner tradestation="true" faction="faction.freesplit" name="$TradingStation" space="player.galaxy" checkoperational="true"/>

                    <do_if value="$TradingStation">
                      <set_value name="$LeakObject" exact="$TradingStation"/>
                      <include_actions ref="md.Signal_Leaks.GetLeakSlots"/>
                      <do_if value="$LeakLocations.count gt 1" comment="need more than 1 to not repeat locations on failure">
                        <set_value name="$SignalLeakStation" exact="$LeakObject"/>
                      </do_if>
                    </do_if>

                    <do_if value="not $SignalLeakStation">
                      <set_value name="$Faction" exact="faction.freesplit"/>
                      <run_actions ref="md.LIB_Generic.FindStationsForFactionByDistance" result="$Out_StationsByDistance">
                        <param name="Faction" value="$Faction"/>
                        <param name="UselocalHighways" value="true"/>
                      </run_actions>
                      <do_all exact="$Out_StationsByDistance.count" counter="$station">
                        <set_value name="$LeakObject" exact="$Out_StationsByDistance.{$station}"/>
                        <include_actions ref="md.Signal_Leaks.GetLeakSlots"/>
                        <do_if value="$LeakLocations.count gt 1" comment="need more than 1 to not repeat locations on failure">
                          <set_value name="$SignalLeakStation" exact="$LeakObject"/>
                          <break/>
                        </do_if>
                      </do_all>
                    </do_if>

                    <do_if value="not $SignalLeakStation">
                      <!-- No Station Available .. wait for another station -->
                      <!--<signal_cue_instantly cue="WaitForFactionToHaveStations" param="[faction.freesplit, parent]" comment="faction, signalcue"/>-->
                      <signal_cue_instantly cue="WaitForFactionToHaveStations_Handler" param="table[$Faction = faction.freesplit,
                                                                                                      $SignalCue = parent]"/>
                      <reset_cue cue="parent"/>
                    </do_if>
                    <do_else>
                      <!-- Send the player to the station -->
                      <do_if value="($SignalLeakStation != $SignalLeakStationLast) and (not $BosoSaid.indexof.{30221265})" comment="Prevent Speech Repetition on Chapter Reset">
                        <signal_cue cue="Ch2_Speak_Boso_265"/>
                      </do_if>
                      <do_else>
                        <signal_cue cue="Ch2_Objective_LeakSatellite"/>
                      </do_else>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch2_Speak_Boso_265" comment="Optional, does not repeat">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <append_to_list name="$BosoSaid" exact="30221265"/>
                  </actions>
                  <cues>
                    <cue name="Ch2_Speak_Boso_265_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30221265,1s]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch2_Identify_Funds_CreateMission"/>
                      <!-- 
                          <t id="30221265">I have located a potential Signal Leak to double-check the former business partners' claims.</t>
                          -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_Identify_Funds_CreateMission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Cleanup Old Mission -->
                    <do_if value="$Ch2b_RemoveMissionLater?">
                      <remove_mission cue="$MissionCue" type="completed"/>
                      <set_value name="$Description" exact="if player.entity.isfemale then {30221,2112} else {30221,2111}"/>
                      <do_if value="$AffiliationFF">
                        <!-- Replace the former Description -->
                        <set_value name="$Description" exact="if player.entity.isfemale then {30221,2114} else {30221,2113}"/>
                      </do_if>
                      <!-- Tomb of Patriarchs -->
                      <write_to_logbook category="missions" faction="faction.player" title="{30221,2101}" text="$Description"/>
                    </do_if>

                    <!-- Mission: Court Case -->
                    <set_value name="$Ch2Description" exact="(if player.entity.isfemale then {30221,2203} else {30221,2202}) + '\n\n' + ({30221,2204}) + '\n\n' + (if player.entity.isfemale then {30221,2206} else {30221,2205})"/>

                    <create_mission cue="$MissionCue" type="missiontype.plot" name="{30221,2201}"  abortable="false" group="missiongroup.story_split"
                         faction="faction.player" difficulty="level.easy" rewardtext="{30221,2999}" description="$Ch2Description"
                                    icon="'briefing_fau_t_nnt_01'" iconcaption="$LoyalistActor.name">
                      <briefing>
                        <objective step="1"       action="objective.flyto"    text="$SignalLeakStation.knownname" object="$SignalLeakStation" />
                        <objective step="2"       action="objective.deploy"    text="$ObjectiveTextSatellite"/>
                        <objective step="3"       action="objective.scan"       text="{30221,2250}"/>
                      </briefing>
                    </create_mission>
                    <set_objective_from_briefing step="1" cue="$MissionCue"/>
                    <signal_cue cue="Ch2_Objective_LeakSatellite"/>
                  </actions>
                </cue>

                <!-- Player in sector: Create SignalLeak OBJECTIVE Place Satellite (scan signal = failure)  -->
                <cue name="Ch2_Objective_LeakSatellite">
                  <!-- expects $SignalLeakStation -->
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="1" action="objective.flyto"     text="$SignalLeakStation.knownname" object="$SignalLeakStation" updatebriefing="true"/>
                  </actions>
                  <cues>
                    <cue name="Ch2_Abort_LeakStation_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$SignalLeakStation"/>
                      </conditions>
                      <cues>
                        <cue name="Ch2_Speak_Boso_266_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30221266],[30221267]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Mission_Reset"/>
                          <!-- 
                           <t id="30221266">Oh, no! It would appear that we have lost the signal.</t>
                           <t id="30221267">I can't even find the station now. I think we will have to look for another one.</t>
                           
                           <t id="30221268">Do remember to set up a working satellite nearby before you try and scan the station.</t>
                           <t id="30221269">(spoken to female 'you'){,30221268}</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_SignalLeak_Init">
                      <actions>
                        <do_if value="$SignalLeakStation.attention ge $AttentionActivePhysics" comment="careful, using external view also changes attention @Heinrich TODO, maybe hint the station ">
                          <signal_cue cue="Ch2_Create_Leak"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch2_LeakStation_Attention_Changed"/>
                        </do_else>
                      </actions>
                    </cue>

                    <!-- @Heinrich Test flying OOS and back, reset and signal immediately might not work, same for Create_Leak_Reset -->

                    <cue name="Ch2_LeakStation_Attention_Changed">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <reset_cue cue="Ch2_Create_Leak"/>
                      </actions>
                      <cues>
                        <cue name="Ch2_LeakStation_Attention_Changed_Event">
                          <conditions>
                            <event_object_changed_attention object="$SignalLeakStation"/>
                          </conditions>
                          <actions>


                            <reset_cue cue="Ch2_LeakStation_Attention_Changed"/>
                            <reset_cue cue="Ch2_SignalLeak_Init"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_Create_Leak">
                      <!-- Creates the SignalLeak and sets the Objective (Deploy Satellite at Leak) -->
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>

                      <cues>
                        <cue name="Ch2_Create_Leak_Resetter">
                          <delay exact="1s"/>
                          <actions>

                            <do_if value="$SignalLeakStation.exists" comment="Catch Destroyed Station">
                              <do_if value="not $SignalLeakStation.isphysicsready">
                                <reset_cue cue="this"/>
                              </do_if>
                              <do_else>
                                <!-- Find another LeakSlot, since the one we found (possibly out of sector) might not be free anymore -->
                                <set_value name="$LeakObject" exact="$SignalLeakStation"/>
                                <include_actions ref="md.Signal_Leaks.GetLeakSlots"/>
                                <do_if value="$LeakLocations.count gt 1" comment="need more than 1 to not repeat locations on failure">
                                  <shuffle_list list="$LeakLocations"/>
                                  <do_all exact="$LeakLocations.count" counter="$l">
                                    <do_if value="$LeakLocations.{$l} != $SignalLeakLocationLast">
                                      <set_value name="$SignalLeakLocation" exact="$LeakLocations.{$l}"/>
                                      <break/>
                                    </do_if>
                                  </do_all>
                                </do_if>

                                <do_if value="$SignalLeakLocation == null">
                                  <signal_cue cue="Mission_Reset"/>
                                </do_if>
                                <do_else>
                                  <set_value name="$MissionLeakMacro" exact="macro.signalleak_s_standard_01_macro" />

                                  <find_object_surface posname="$SurfacePos" rotname="$SurfaceRot" object="$SignalLeakLocation.component" height="$MissionLeakMacro.boundingbox.max.y - $MissionLeakMacro.boundingbox.center.y">
                                    <position value="$SignalLeakLocation.offset" />
                                    <!-- the rotation created by the normal would look away from the surface, we want a rotation that's looking parallel to the surface -->
                                    <offsetrotation pitch="-90deg" />
                                  </find_object_surface>

                                  <do_if value="@$SurfacePos">
                                    <create_signal_leak name="$SignalLeak" groupname="$Leaks" macro="$MissionLeakMacro" type="signalleaktype.mission" object="$SignalLeakLocation.component">
                                      <position value="$SurfacePos" />
                                      <rotation value="$SurfaceRot" />
                                      <!--<voice page="$SignalLeakActor.page" lines="[1000003, 1000004, 1000005]"/>-->
                                    </create_signal_leak>
                                    <create_position name="$SignalLeakPos" object="$SignalLeak" space="$SignalLeak.sector"/>
                                    <signal_cue cue="Ch2_Objective_LeakSatellite_Create"/>
                                  </do_if>
                                  <do_else>
                                    <reset_cue cue="this"/>
                                  </do_else>
                                </do_else>

                              </do_else>
                            </do_if>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_Objective_LeakSatellite_Create">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>


                        <create_position name="$TargetOffset" object="$SignalLeak" space="$SignalLeakStation.sector"/>
                        <set_value name="$TargetOffset"       exact="$TargetOffset"/>
                        <set_value name="$TargetRadius"       exact="$MaxDistanceLeakToSatellite"/>
                        <!--<set_value name="$DeployableCategory" exact="deployablecategory.satellite"/>-->

                        <set_objective cue="$MissionCue" step="2" action="objective.deploy" text="$ObjectiveTextSatellite" object="$SignalLeakStation.sector" offset="$TargetOffset" radius="$TargetRadius * 0.8" updatebriefing="true" comment="now the object is known"/>

                        <reset_cue cue="Ch2_Objective_Scan"/>
                        <signal_cue cue="Ch2_Objective_Scan"/>

                        <create_list name="$Speak_Boso_270"/>
                        <do_if value="$SignalLeakStationLast" comment="Do not play this line on the first Signal Leak">
                          <append_to_list name="$Speak_Boso_270" exact="[30221270, 0s]"/>
                        </do_if>
                        <append_to_list name="$Speak_Boso_270" exact="[(if player.entity.isfemale then 30221272 else 30221271), 1s]"/>

                      </actions>
                      <cues>
                        <cue name="Ch2_Speak_Boso_270_Ref" ref="md.LIB_Dialog.Speak_Actor" comment="consider one-time only">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="$Speak_Boso_270"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch2_Objective_LeakSatellite_Create_Resetter"/>
                          <!--
                          <t id="30221270">I have now located a proper Signal Leak through which we should be able to get the information.</t>
                          <t id="30221271">Place a satellite next to it so that I can remotely work on its decryption.</t>
                          <t id="30221272">(spoken to female 'you'){,30221271}</t>
                          -->
                        </cue>

                        <cue name="Ch2_Objective_LeakSatellite_Create_Resetter">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <remove_value name="$Speak_Boso_270"/>
                            <reset_cue cue="parent"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch2_Abort_Signal_Repaired" comment="Signal Leak Scanned before the Satellite was in place">
                      <conditions>
                        <event_player_repaired_signal_leak signal="$SignalLeak"/>
                      </conditions>
                      <actions>

                        <destroy_object object="$SignalLeak" explosion="false"/>
                        <set_objective action="objective.wait" cue="$MissionCue"/>
                        <signal_cue cue="Ch2_Speak_Boso_284_Else"/>
                      </actions>
                    </cue>

                    <cue name="Ch2_Abort_Signal_Scanned" comment="Signal Leak Scanned before the Satellite was in place">
                      <conditions>
                        <event_player_signal_unlock_finished signal="$SignalLeak"/>
                      </conditions>
                      <actions>

                        <destroy_object object="$SignalLeak" explosion="false"/>
                        <set_objective action="objective.wait" cue="$MissionCue"/>
                      </actions>
                      <cues>
                        <cue name="Ch2_Speak_Boso_275_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30221275],
                                                                  [if player.entity.isfemale then 30221277 else 30221276, 0.3s]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Mission_Reset"/>
                          <!--
                          <t id="30221275">No, no, no! We need a satellite first to decrypt the data stream properly.</t>
                          <t id="30221276">Let us find another signal.</t>
                          <t id="30221277">(spoken to female 'you'){,30221276}</t>
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch2_Objective_Scan">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch2_Place_LeakSatellite" instantiate="true" comment="abort if it gets scanned or the station destroyed">
                      <conditions>
                        <event_satellite_launched space="$SignalLeakStation.sector"/>
                        <!-- TODO @Heinrich Satellites Pushed into place should also work while in place -->
                      </conditions>
                      <actions>


                        <set_value name="$LaunchedSatellite" exact="event.param2"/>

                        <find_object groupname="$SatellitesInArea" deployablecategory="deployablecategory.satellite" multiple="true" space="$SignalLeakStation.sector" owner="faction.player">
                          <match_distance space="$SignalLeakStation.sector" value="$TargetOffset" max="$TargetRadius"/>
                        </find_object>

                        <do_if value="$SatellitesInArea.count">
                          <do_if value="$SignalLeakSatellites.count == 0" comment="first Satellite in the correct position">
                            <signal_cue cue="Ch2_Speak_Boso_278"/>
                            <cancel_cue cue="Ch2_Abort_Signal_Scanned"/>
                            <signal_cue cue="Ch2_LeakSatellite_In_Place"/>
                          </do_if>
                          <add_to_group groupname="$SignalLeakSatellites" group="$SatellitesInArea"/>
                        </do_if>
                      </actions>
                    </cue>
                    <cue name="Ch2_Speak_Boso_278">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch2_Speak_Boso_278_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30221278,1s, Ch2_Scan_Objective],
                                                                      [if player.entity.isfemale then 30221280 else 30221279, 1s]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!-- 
                              <t id="30221278">Very good. Now let me set up the satellite to decrypt your signal scan.</t>
                              <t id="30221279">Please proceed with the scan.</t>
                              <t id="30221280">(spoken to female 'you'){,30221279}</t>
                              -->
                        </cue>
                        <cue name="Ch2_Scan_Objective">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="$SignalLeak">
                              <set_objective cue="$MissionCue" step="3" action="objective.scan" object="$SignalLeak" updatebriefing="true" comment="now the object is known"/>
                            </do_if>
                            <do_else>
                              <set_objective cue="$MissionCue" action="objective.wait"/>
                            </do_else>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch2_LeakSatellite_In_Place">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch2_LeakSatellite_Destroyed_Redeploy">
                          <conditions>
                            <event_object_destroyed group="$SignalLeakSatellites"/>
                          </conditions>
                          <actions>


                            <do_if value="$SignalLeakSatellites.count == 0">
                              <!-- Satellites got destroyed -->
                              <signal_cue cue="Ch2_Objective_LeakSatellite_Create"/>
                            </do_if>
                            <do_else>
                              <reset_cue cue="this"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch2_Scan_Leak">
                          <conditions>
                            <event_player_signal_unlock_finished signal="$SignalLeak"/>
                          </conditions>
                          <actions>


                            <destroy_object object="$SignalLeak" explosion="false"/>

                            <set_value name="$OutOfRange" exact="false"/>
                            <do_all exact="$SignalLeakSatellites.count" counter="$s" reverse="true">
                              <set_value name="$CurrentSatellite" exact="$SignalLeakSatellites.{$s}"/>
                              <do_if value="($SignalLeak.distanceto.{$CurrentSatellite} le $MaxDistanceLeakToSatellite)">
                                <do_if value="($CurrentSatellite.isactive)">
                                  <add_to_group groupname="$SignalLeakSatellitesWorking" object="$CurrentSatellite"/>
                                </do_if>
                              </do_if>
                              <do_else>
                                <set_value name="$OutOfRange" exact="true"/>
                              </do_else>
                            </do_all>

                            <cancel_cue cue="Ch2_Abort_LeakStation_Destroyed"/>
                            <cancel_cue cue="Ch2_LeakSatellite_Destroyed_Redeploy"/>

                            <do_if value="$SignalLeakSatellitesWorking.count">
                              <do_all exact="$SignalLeakSatellitesWorking.count" counter="$ws">
                                <set_owner object="$SignalLeakSatellitesWorking.{$ws}" faction="faction.civilian"/>
                              </do_all>

                              <signal_cue cue="Ch2_Repair_Satellites_Mission"/>
                              <signal_cue cue="Ch2_SparklingSatellite"/>
                            </do_if>
                            <do_else>
                              <do_if value="$OutOfRange">
                                <signal_cue cue="Ch2_Speak_Boso_284_Out_Of_Range"/>
                              </do_if>
                              <do_elseif value="not $SignalLeakSatellites.count">
                                <signal_cue cue="Ch2_Speak_Boso_284_Destroyed"/>
                              </do_elseif>
                              <do_else>
                                <signal_cue cue="Ch2_Speak_Boso_284_Else"/>
                              </do_else>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch2_Speak_Boso_284_Destroyed">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch2_Speak_Boso_284_Destroyed_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$BosoTa"/>
                              <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                              <param name="Lines"             value="[[30221284],
                                                                      [30221285],
                                                                      [if player.entity.isfemale then 30221287 else 30221286]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="Mission_Reset"/>
                              <!-- 
                              <t id="30221284">Something went wrong, I could not connect to a satellite. We need to try again somewhere else.</t>
                              <t id="30221285">We have lost the network completely.</t>
                              <t id="30221286">Let us try again on another Signal Leak, but be prepared to repair a satellite quickly if needed.</t>
                              <t id="30221287">(spoken to female 'you'){,30221286}</t>
                              -->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_Speak_Boso_284_Out_Of_Range">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch2_Speak_Boso_284_Out_Of_Range_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$BosoTa"/>
                              <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                              <param name="Lines"             value="[[30221284],
                                                                      [if player.entity.isfemale then 30221277 else 30221276],
                                                                      [if player.entity.isfemale then 30221274 else 30221273]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="Mission_Reset"/>
                              <!-- 
                              <t id="30221284">Something went wrong, I could not connect to a satellite. We need to try again somewhere else.</t>
                              <t id="30221276">Let us find another signal.</t>
                              <t id="30221277">(spoken to female 'you'){,30221276}</t>
                              <t id="30221273">Try not to bump the satellite out of range.</t>
                              <t id="30221274">(spoken to female 'you'){,30221273}</t>
                              -->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_Speak_Boso_284_Else">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch2_Speak_Boso_284_Else_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$BosoTa"/>
                              <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                              <param name="Lines"             value="[[30221284],
                                                                      [30221285],
                                                                      [if player.entity.isfemale then 30221277 else 30221276]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="Mission_Reset"/>
                              <!-- 
                              <t id="30221284">Something went wrong, I could not connect to a satellite. We need to try again somewhere else.</t>
                              <t id="30221285">We have lost the network completely.</t>
                              <t id="30221276">Let us find another signal.</t>
                              <t id="30221277">(spoken to female 'you'){,30221276}</t>
                              -->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_SparklingSatellite">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>

                          </actions>
                          <cues>
                            <cue name="Ch2_SparklingSatellite_Damage">
                              <delay min="1s" max="2s"/>
                              <actions>
                                <do_all exact="$SignalLeakSatellitesWorking.count" counter="$s">
                                  <set_value name="$CurrentSatellite" exact="$SignalLeakSatellitesWorking.{$s}"/>
                                  <add_effect object="$CurrentSatellite" effect="'signal_leak_discharge_effect'"/>
                                  <set_object_hull object="$CurrentSatellite" max="$CurrentSatellite.hullpercentage - 1" min="$CurrentSatellite.hullpercentage - 2"/>
                                  <!-- worst case: every second -2 % => 50 seconds, best case every 2 seconds -1% => 200 seconds, average case: ~125 seconds-->
                                  <do_if value="$CurrentSatellite.hullpercentage le 0">
                                    <destroy_object object="$CurrentSatellite" comment="also removes from group" explosion="true"/>
                                  </do_if>
                                </do_all>
                                <do_if value="$SignalLeakSatellitesWorking.count">
                                  <reset_cue cue="this" comment="reset until they are destroyed"/>
                                </do_if>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_Speak_Boso_281" comment="Optional, does not repeat">
                          <conditions>
                            <event_cue_signalled/>
                            <set_value name="$line" exact="30221281"/>
                            <!--<check_value value="not $BosoSaid.indexof.{$line}"/>-->
                          </conditions>
                          <!--<actions>
                            <append_to_list name="$BosoSaid" exact="$line"/>
                          </actions>-->
                          <cues>
                            <cue name="Ch2_Speak_Boso_281_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$BosoTa"/>
                              <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                              <param name="Lines"             value="[[$line,1s],
                                                                          [if player.entity.isfemale then 30221283 else 30221282, 0.3s]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="Ch2_Player_In_Suit"/>
                              <!--
                                  Boso:
                                  <t id="30221281">Oh dear me. The satellite network is going completely haywire!</t>
                                  <t id="30221282">You need to repair it or it might explode!</t>
                                  <t id="30221283">(spoken to female 'you'){,30221282}</t>                       
                                  -->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_Player_In_Suit" >
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>

                            <cue name="Ch2_Player_In_Suit_Already">
                              <actions>
                                <do_if value="@player.controlled.isclass.spacesuit">
                                  <signal_cue cue="Ch2_Player_In_Suit_Teleport"/>
                                </do_if>
                              </actions>
                            </cue>

                            <cue name="Ch2_Player_In_Suit_Teleport">
                              <conditions>
                                <check_any>
                                  <event_cue_signalled/>
                                  <check_all>
                                    <event_player_teleport_successful/>
                                    <check_value value="@player.controlled.isclass.spacesuit"/>
                                  </check_all>
                                </check_any>
                              </conditions>
                              <delay exact="2s"/>
                              <!--<actions>
                                <signal_cue cue="Ch2_Speak_Loyalist_230"/>
                              </actions>-->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_Speak_Loyalist_230">
                          <!-- Deactiavte for now -->
                          <conditions>
                            <event_cue_signalled/>
                            <set_value name="$line" exact="30221230"/>
                            <check_value value="not $LoyalistSaid.indexof.{$line}"/>
                          </conditions>
                          <actions>
                            <append_to_list name="$LoyalistSaid" exact="$line"/>
                          </actions>
                          <cues>
                            <cue name="Ch2_Speak_Loyalist_230_Ref" ref="md.LIB_Dialog.Speak_Actors">
                              <param name="Actor" value="[$LoyalistActor, $BosoTa, $DalBusta]"/>
                              <param name="CutsceneKey" value="[$LoyalistCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey]"/>
                              <param name="Lines" value="[
                                 [[if player.entity.isfemale then 30221231 else 30221230],
                                  [if player.entity.isfemale then 30221233 else 30221232],
                                  [30221234],
                                  [30221235],
                                  [30221236, 0.4s]],
                                  
                                 [[30221214]],
                                 
                                 [[30221930, 1s], [30221931],
                                 [if player.entity.isfemale then 30221272 else 30221271, 0.3s],
                                 [30221932, 0.6s, Ch2_Speak_Loyalist_230_Done]]
                                 ]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <!--                       
                                  Loyalist:
                                  <t id="30221230">You too late.</t>
                                  <t id="30221231">(spoken to female 'you'){,30221230}</t>
                                  <t id="30221232">You fail..</t>
                                  <t id="30221233">(spoken to female 'you'){,30221232}</t>
                                  <t id="30221234">Patriarch Noa t'Hlp executed.</t>
                                  <t id="30221235">No justice for him.</t>
                                  <t id="30221236">Split should have hired better investigator.</t>
                                  
                                  Boso	<t id="30221214	">Goodness gracious me!
                                  Dal   <t id="30221930	">There is nothing we could have done for him.
                                  Dal   <t id="30221931	">The Zyarth Patriarchy is on edge and rather overzealous in their attempts to bring order to the Free Families.
                                  Dal:
                                  <t id="30221271">Since we're here, let's finish the job.</t>
                                  <t id="30221272">(spoken to female 'you'){,30221271}</t>     
                                  Dal	<t id="30221	932	">	Knowing whether he's been set up, and if so by whom, will be valuable information.
                              -->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch2_Speak_Loyalist_230_Done">
                          <!-- never called -->
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$Loyalist_230_Done" exact="true"/>
                          </actions>
                        </cue>

                        <cue name="Ch2_Repair_Satellites_Mission">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <update_mission cue="$MissionCue">
                              <briefing>
                                <objective step="1"       action="objective.flyto"    text="$SignalLeakStation.knownname"/>
                                <objective step="2"       action="objective.deploy"   text="$ObjectiveTextSatellite"/>
                                <objective step="3"       action="objective.scan"     text="{30220,3008}" comment="(objective.scan)Signal Leak"/>
                                <objective step="4"       action="objective.repair"   text="{20201,20301}" comment="Satellite"/>
                              </briefing>
                            </update_mission>
                            <set_objective cue="$MissionCue" step="4" action="objective.repair" text="readtext.{20201}.{20301}" group="$SignalLeakSatellitesWorking" updatebriefing="true" comment="object is now known"/>

                            <signal_cue cue="Ch2_Speak_Boso_281"/>
                          </actions>
                          <cues>
                            <cue name="Ch2_Repaired_Satellite_In_Time">
                              <!-- Success, if one of the Satellites is back to 100% hull -->
                              <conditions>
                                <event_object_hull_repaired group="$SignalLeakSatellitesWorking"/>
                                <check_value value="event.param.hullpercentage ge 95"/>
                              </conditions>
                              <actions>

                                <set_objective cue="$MissionCue" action="objective.wait" comment="Wait for Story to continue"/>
                                <do_all exact="$SignalLeakSatellitesWorking.count" counter="$ws" reverse="true">
                                  <set_owner object="$SignalLeakSatellitesWorking.{$ws}" faction="faction.player"/>
                                  <remove_from_group group="$SignalLeakSatellitesWorking" object="$SignalLeakSatellitesWorking.{$ws}"/>
                                </do_all>
                                <!--<signal_cue cue="Leaks_Delayed_Reactivation"/>-->
                                <signal_cue cue="Ch2_Speak_Boso_288"/>
                              </actions>
                            </cue>

                            <cue name="Ch2_Repaired_Satellite_In_Time_Wait_Speech">
                              <!-- never called -->
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch2_Speak_Boso_288"/>
                              </actions>
                              <!--<cues>
                                <cue name="Ch2_Repaired_Satellite_Speech_Done" checkinterval="3s">
                                  <conditions>
                                    <check_value value="$Loyalist_230_Done? and $Loyalist_230_Done"/>
                                    <!-%- Loyalist said his lines -%->
                                  </conditions>
                                  <actions>
                                    <signal_cue cue="Ch2_Speak_Boso_288"/>
                                  </actions>
                                </cue>
                              </cues>-->
                            </cue>

                            <cue name="Ch2_Speak_Boso_288" comment="optional cue, does not repeat">
                              <conditions>
                                <event_cue_signalled/>
                                <set_value name="$line" exact="30221288"/>
                                <check_value value="not $BosoSaid.indexof.{$line}"/>
                              </conditions>
                              <actions>
                                <append_to_list name="$BosoSaid" exact="$line"/>
                              </actions>
                              <cues>
                                <cue name="Ch2_Speak_Boso_288_Ref" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor"             value="[$BosoTa, $DalBusta, $BosoTa, $DalBusta]"/>
                                  <param name="CutsceneKey"       value="[$BosoCutsceneKey, $Dal2CutsceneKey, $BosoCutsceneKey, $Dal2CutsceneKey]"/>
                                  <param name="Lines"             value="[  [[$line,0.1s], [30221290]],
                                                                            [[30221274], [30221275, 3s], [30221276,2s]],
                                                                            [[30221291]],
                                                                            [[30221277], [30221278], [(if player.entity.isfemale then 30221281 else 30221280)]]
                                                                        ]"/>
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="[null, null, null, Ch3_Conspiracy]"/>
                                  <!--Boso:
                                      <t id="30221288">Perfect. I'm tracing where the funds went now.</t>
                                      <t id="30221290">Dal will look into the data to find out ..</t>
                                      Dal:
                                       <t id="30221274">OK, I'm looking through the company registrations.</t>
                                       <t id="30221275">Found it!</t>
                                       <t id="30221273">I've found where the funds went!</t> (UNUSED, too repetitive with Boso's lines?)
                                       <t id="30221276">Boso, it is absolutely imperative that you delete the data from the station, immediately.</t>
                                      Boso:
                                      <t id="30221291">But....(worried) won't they need that information for their financial records?</t>
                                      Dal: 
                                      <t id="30221277">Not this particular transaction.</t>
                                      <t id="30221278">I'll explain later.</t>
                                      <t id="30221280">Let's get back to that funeral ship.</t>
                                      <t id="30221281">(spoken to female 'you'){,30221280}</t>
                                      
             currently not used       <t id="30221320">The executed Patriarch's body is already on the way.</t>
             currently not used       <t id="30221321">This is a funeral we need to attend.</t>
                                      -->
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch2_SparklingSatelliteLost" instantiate="true">
                              <!-- Failed, if all Satellites are destroyed => New Signal Leak -->
                              <conditions>
                                <event_object_destroyed group="$SignalLeakSatellitesWorking"/>
                              </conditions>
                              <actions>
                                <remove_from_group group="$SignalLeakSatellitesWorking" object="event.object" comment="remove now because we need the correct .count immediately"/>
                                <debug_text text="' WorkingSatellites: ' + $SignalLeakSatellitesWorking.count" chance="$DebugChance"/>
                                <do_if value="$SignalLeakSatellitesWorking.count == 0">
                                  <signal_cue cue="Ch2_Speak_Boso_285"/>
                                </do_if>
                              </actions>
                              <cues>
                                <cue name="Ch2_SparklingSatelliteLost_Update" onfail="cancel">
                                  <conditions>
                                    <check_value value="$SignalLeakSatellitesWorking.count == 0"/>
                                  </conditions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch2_Speak_Boso_285">
                              <!-- Can this overlap with other instances of 30221286, e.g. when a scan just happened as the satellite got destroyed?-->
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch2_Speak_Boso_285_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$BosoTa"/>
                                  <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                                  <param name="Lines"             value="[[30221285],
                                                                      [if player.entity.isfemale then 30221287 else 30221286]]"/>
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue"      value="Mission_Reset"/>
                                  <!--
                               <t id="30221285">We have lost the network completely.</t>
                               <t id="30221286">Let us try again on another Signal Leak, but be prepared to repair a satellite quickly if needed.</t>
                               <t id="30221287">(spoken to female 'you'){,30221286}</t>   
                              -->
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <!--<cue name="Leaks_Delayed_Reactivation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="300s"/>
                  <actions>
                    <remove_from_list name="md.Signal_Leaks.Manager.$SuppressSignalLeakFactions" exact="faction.freesplit"/>
                  </actions>
                </cue>-->

                  </cues>
                </cue>

                <cue name="Ch2_Identify_Funds_Police">
                  <!-- Deactivated / NEver Called -->
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- TODO @Heinrich Ask Nick on how to launch a police masstraffic ship from the stations masstraffic dock
                         ship_spl_xs_police_01_a_macro -->
                    <add_units object="$SignalLeakStation" exact="1" category="unitcategory.defence" mk="1"/>
                    <!--<launch_masstraffic_drone object="$SignalLeakStation" category="unitcategory.police" name="$SignalLeakPolice"/>-->
                    <!--<launch_drone name="$SignalLeakPolice" object="$SignalLeakStation" category="unitcategory.police" exact="1"/>-->
                    <launch_drone name="$LaunchedDrone" object="$SignalLeakStation" category="unitcategory.defence" exact="1"/>

                    <do_if value="$LaunchedDrone != null">
                      <cancel_all_orders object="$LaunchedDrone"/>
                      <create_order id="'MoveWait'" object="$LaunchedDrone" immediate="true">
                        <param name="destination" value="[$SignalLeakStation.sector, $SignalLeakPos]"/>
                        <param name="debugchance" value="$DeepDebugChance"/>
                      </create_order>
                    </do_if>

                    <!--
                      <create_order object="$LaunchedDrone" id="'MoveToObject'" immediate="true">
                        <param name="destination" value="$SignalLeakPos"/>
                      </create_order>-->
                  </actions>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="DEBUG_Setup_Ch3">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_position name="$FuneralLaunchPos" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="1km"/>
            <create_position name="$FuneralTargetPos" object="$FuneralGate.exit" space="$FuneralGate.exit.sector" x="0km" y="0km" z="5km"/>

            <create_rotation name="$FaceFuneralGate"
                             pitch="$FuneralGate.rotation.pitch"
                             roll="$FuneralGate.rotation.roll"
                             yaw="$FuneralGate.rotation.yaw + 180deg"/>
            <create_rotation name="$FaceFuneralGateExit"
                         pitch="$FuneralGate.exit.rotation.pitch"
                         roll="$FuneralGate.exit.rotation.roll"
                         yaw="$FuneralGate.exit.rotation.yaw + 180deg"/>
            <!-- FUNERAL SERVICE SHIP -->
            <create_ship name="$FuneralServiceShip" capturable="false" sector="$FuneralGate.sector" missioncue="namespace" macro="ship_spl_l_trans_container_01_a_macro">
              <people>
                <fillpercent exact="0"/>
              </people>
              <paint ware="$PaintMod_FuneralServiceShip"/>
              <!--<loadout loadout=""/>-->
              <owner exact="faction.civilian"/>
              <pilot>
                <select race="race.drone"/>
                <!-- tags="tag.aipilot" -->
              </pilot>
              <position x="$FuneralLaunchPos.x" y="$FuneralLaunchPos.y" z="$FuneralLaunchPos.z"/>
              <rotation value="$FaceFuneralGate"/>
            </create_ship>
            <set_object_relation_behaviour object="$FuneralServiceShip" disable="true"/>
            <set_object_min_hull object="$FuneralServiceShip" exact="33"/>
            <set_ship_safepos_allowed ship="$FuneralServiceShip" allow="false"/>

            <set_object_name object="$FuneralServiceShip" page="30221" line="209" comment="Funeral Service Ship"/>
            <create_order id="'Wait'" object="$FuneralServiceShip" immediate="true">
              <param name="noattackresponse" value="true"/>
            </create_order>

            <find_dockingbay name="$FuneralServiceDock" object="$FuneralServiceShip" checkoperational="true" multiple="false">
              <match_dock size="tag.dock_s" storage="true"/>
            </find_dockingbay>


            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $CurbActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $FuneralServiceShip,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $LoyalistActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $FuneralServiceShip,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $FuneralServiceShip,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>


            <set_value name="$Ch2Description" exact="(if player.entity.isfemale then {30221,2203} else {30221,2202}) + '\n\n' + ({30221,2204}) + '\n\n' + (if player.entity.isfemale then {30221,2206} else {30221,2205})"/>
            <create_mission cue="$MissionCue" type="missiontype.plot" name="{30221,2201}"  abortable="false" group="missiongroup.story_split"
                 faction="faction.player" difficulty="level.easy" rewardtext="{30221,2999}" description="$Ch2Description"
                            icon="'briefing_fau_t_nnt_01'" iconcaption="$LoyalistActor.name">
              <briefing>
                <objective step="1"       action="objective.flyto"  />
              </briefing>
            </create_mission>

            <signal_cue cue="Ch3_Conspiracy"/>
          </actions>
        </cue>

        <cue name="Ch3_Conspiracy" comment="Text IDs 300">
          <!-- 1. Land at the Funeral Ship (Dal out), Space-Suit & EMP Bomb into the Coffin Ship,
                  go through Accelerator-"Cutscene" + Player teleport -->
          <!-- 2. Player in Prison (on a Ship)-Dialogue (Curb + Outcast there), Player in Throneroom Dialogue, "prove worth" part -->
          <!-- (Optional: Tell the Loyalist about it) -->
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <cancel_cue cue="Ch2_Study"/>
            <set_objective cue="$MissionCue" action="objective.flyto" object="$FuneralGate" comment="$HeartOfAcrimonySector might make the gate unpassable"/>
          </actions>
          <cues>
            <cue name="Ch3_Story_Reminder" checkinterval="1s" onfail="cancel">
              <conditions>
                <check_value value="Ch3_Player_Reached_FuneralSector.state == cuestate.waiting"/>
              </conditions>
              <cues>
                <cue name="Ch3_Story_Reminder_v2_Ref" ref="md.Story_Paranid.Story_Reminder">
                  <param name="Actor"       value="$DalBusta"/>
                  <param name="CutsceneKey" value="$Dal2CutsceneKey"/>
                  <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30200108 else 30200107]]"/>
                  <param name="CancelCue"   value="Ch3_Player_Reached_FuneralSector"/>
                  <param name="Delay"       value="20min"/>
                  <!--  <t id="30200001">Hey there partner.</t>
                                <t id="30200002">(spoken to female player){10111,30200001}</t>
                                <t id="30200105">Don't keep our contact waiting for too long.</t>
                                <t id="30200106">(spoken to female player){,30200105}</t>
                                <t id="30200107">Where have you wandered off to?</t>
                                <t id="30200108">(spoken to female player 'you'){,30200107}</t>    -->
                </cue>
              </cues>
            </cue>
            <cue name="Ch3_Player_ReachedSector_Ref" ref="md.LIB_Generic.ReachedSector">
              <param name="TargetSector" value="$HeartOfAcrimonySector"/>
              <param name="SuccessSignalCue" value="Ch3_Player_Reached_FuneralSector"/>
            </cue>
            <cue name="Ch3_Player_Reached_FuneralSector">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch3_Dal_301_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="DelayInitial"      value="9s"/>
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                  <param name="Lines"             value="[
                                                            [30221301],
                                                            [30221302],
                                                            [30221303],
                                                            [30221373],
                                                            [30221308]
                         
                                                         ]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="Ch3_Approach_Funeral"/>

                  <!--  Dal Explaining Conspiracy
                  <t id="30221301">So, the slave traders claim to have bought slaves from the executed Patriarch, which is sort of true.</t>
                  <t id="30221302">But the Patriarch didn't see any of the money they paid.</t>
                  <t id="30221303">Instead, all of the money went to the funeral service.</t>                  
                  <t id="30221373">With the financial records from the court case, we hold some pretty damning evidence about the conspiracy.</t>
        not used     <t id="30221304">This is it!</t>
        used in conv later:     <t id="30221307">We need(emphasis) to get on the inside, literally!</t>
                  <t id="30221308">We need to get back to that accelerator and find out what they're hiding on the other side of it.</t>    
        not used: <t id="30221305">This has to be it!</t>
        not used: <t id="30221306">This is the potential turning point for the Split.</t>
                  -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch3_Approach_Funeral">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30221,2201}" text="if player.entity.isfemale then {30221,2212} else {30221,2211}"/>
                <cancel_cue cue="Ch2_Loyalist_Conversation_Greeting"/>
              </actions>
              <delay exact="3s"/>
              <actions>
                <!-- (Mission Title)Tax Evasion 101 - How to hide money from Zyarth -->
                <create_mission cue="$MissionCue" name="{30221,3001}" group="missiongroup.story_split"
                                description="(if player.entity.isfemale then {30221,3003} else {30221,3002}) + '\n\n' + (if player.entity.isfemale then {30221,3005} else {30221,3004})"
                  type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="false"
                                    icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
                  <briefing>
                    <objective step="1" action="objective.dockat" object="$FuneralServiceShip" text="$FuneralServiceShip.knownname"/>
                    <objective step="2" action="objective.talkto" object="$DalBusta"/>
                  </briefing>
                </create_mission>
                <set_objective_from_briefing step="1" cue="$MissionCue"/>
              </actions>
              <cues>
                <cue name="Ch3_Approach_Funeral_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachTarget"    value="$FuneralServiceShip"/>
                  <param name="ApproachDistance"  value="25km"/>
                  <param name="SuccessSignalCue"  value="Ch3_Reached_Funeral"/>
                </cue>
              </cues>
            </cue>
            <cue name="Ch3_Reached_Funeral">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch3_Dal_309_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="DelayInitial"      value="1s"/>
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                  <param name="Lines"             value="[
                                                              [if player.entity.isfemale then 30221310 else 30221309]                         
                                                             ]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="Ch3_Funeral_Dal_Waiting"/>
                  <!--  
                      <t id="30221309">I made it to the funeral on my own. I'll wait for you to get here.</t>
                      <t id="30221310">(spoken to female 'you'){,30221309}</t>
                      -->
                </cue>

                <cue name="Ch3_Funeral_Dal_Waiting">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective_from_briefing step="2" cue="$MissionCue"/>
                    <!-- spawn Dal's Taxi and make it fly away to show 'how he got here' -->
                    <create_loadout result="$loadout">
                      <macros>
                        <engine macro="engine_arg_s_travel_01_mk1_macro" path="../con_engine_02"/>
                        <engine macro="engine_arg_s_travel_01_mk1_macro" path="../con_engine_01"/>
                        <weapon macro="weapon_gen_s_laser_01_mk1_macro" path="../con_weapon_006"/>
                        <weapon macro="weapon_gen_s_laser_01_mk1_macro" path="../con_weapon_005"/>
                        <shield macro="shield_arg_s_standard_01_mk1_macro" path="../con_shield_01"/>
                      </macros>
                      <ammunition>
                        <ammunition macro="countermeasure_flares_01_macro" exact="4"/>
                      </ammunition>
                      <software>
                        <software ware="software_flightassistmk1"/>
                        <software ware="software_scannerobjectmk1"/>
                        <software ware="software_trademk1"/>
                      </software>
                      <virtualmacros>
                        <thruster macro="thruster_gen_s_allround_01_mk1_macro"/>
                      </virtualmacros>
                    </create_loadout>
                    <create_cue_actor name="$DalsTaxiDriver" cue="$MissionCue">
                      <select race="race.argon"/>
                      <owner exact="faction.civilian"/>
                    </create_cue_actor>
                    <create_ship name="$DalsTaxi"
                                 macro="ship_arg_s_trans_container_02_a_macro"
                                 dock="$FuneralServiceDock">
                      <owner exact="faction.civilian"/>
                      <loadout loadout="$loadout"/>
                      <pilot actor="$DalsTaxiDriver"/>
                      <people>
                        <fillpercent exact="0"/>
                      </people>
                    </create_ship>
                    <create_order object="$DalsTaxi" id="'MoveDie'" immediate="true">
                      <param name="atstation" value="$HQ"/>
                      <param name="byidle" value="false"/>
                      <param name="mintime" value="120s" comment="stay alive for specified time, after it docks"/>
                    </create_order>


                    <find_object_component name="$Dock" object="$FuneralServiceShip" checkoperational="true" macro="macro.dockingbay_arg_s_01_macro"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $CurbActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $FuneralServiceShip,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <set_value name="$LoyalistActorCurrentName" exact="$LoyalistActorFakeNames.random"/>
                    <remove_from_list name="$LoyalistActorFakeNames" exact="$LoyalistActorCurrentName"/>
                    <set_object_name object="$LoyalistActor" page="30221" line="$LoyalistActorCurrentName"/>

                    <create_position name="$LoyPos" x="-3.814" z="21.504"/>
                    <create_rotation name="$LoyRot" yaw="177.0deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $LoyalistActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $LoyRot,
                                                                                                      $position = $LoyPos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <create_position name="$DalPos" x="-10.79" z="21.542"/>
                    <create_rotation name="$DalRot" yaw="142.0deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $DalBusta,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $rotation = $DalRot,
                                                                                                      $position = $DalPos,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                  </actions>
                  <cues>
                    <cue name="Ch3_Loyalist_Angry_Start">
                      <actions>
                        <set_objective cue="$MissionCue" object="$LoyalistActor" action="objective.talkto"/>
                      </actions>
                      <cues>
                        <cue name="Ch3_Loyalist_Angry_v2">
                          <conditions>
                            <event_conversation_started actor="$LoyalistActor"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="if player.entity.isfemale then 30221231 else 30221230" comment="You too late."/>
                              <text line="if player.entity.isfemale then 30221233 else 30221232" comment="You fail.."/>
                              <text line="30221234" comment="Patriarch Noa t'Hlp executed."/>
                              <text line="30221235" comment="No justice for him."/>
                              <text line="30221236" comment="Split should have hired better investigator."/>
                            </add_npc_line>
                            <!--
                        Loyalist:
                                  <t id="30221230">You too late.</t>
                                  <t id="30221231">(spoken to female 'you'){,30221230}</t>
                                  <t id="30221232">You fail..</t>
                                  <t id="30221233">(spoken to female 'you'){,30221232}</t>
                                  <t id="30221234">Patriarch Noa t'Hlp executed.</t>
                                  <t id="30221235">No justice for him.</t>
                                  <t id="30221236">Split should have hired better investigator.</t>
                                  
                                  Boso	<t id="30221214	">Goodness gracious me!
                                  Dal   <t id="30221930	">There is nothing we could have done for him.
                                  Dal   <t id="30221931	">The Zyarth Patriarchy is on edge and rather overzealous in their attempts to bring order to the Free Families.
                        -->
                          </actions>
                          <cues>
                            <cue name="Ch3_Loyalist_Angry_Done_v2">
                              <conditions>
                                <event_conversation_finished actor="$LoyalistActor"/>
                              </conditions>
                              <actions>
                                <set_value name="$Ch3_Loyalist_Angry_Done"/>
                                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                                      param="['add_definition', $LoyalistActor, table[
                                                                                         $requestercue = $MissionCue,
                                                                                         $priority = 100,
                                                                                         $location = 'disconnect',
                                                                                         $slottags = [tag.stand],
                                                                                         $debugchance = $DebugChance,
                                                                                         $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                              </actions>
                              <cues>
                                <cue name="Ch3_Speak_Boso_214_Ref_v2" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor" value="[$BosoTa]"/>
                                  <param name="CutsceneKey" value="[$BosoCutsceneKey]"/>
                                  <param name="Lines" value="[  [[30221214]]
                                                            ]"/>
                                  <param name="MissionCue"        value="$MissionCue"/>
                                  <param name="EndSignalCue" value="[Ch3_TalkToDal_v2]"/>
                                </cue>
                                <cue name="Ch3_TalkToDal_v2">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <set_objective_from_briefing cue="$MissionCue" step="2" comment="Talk to Dal"/>
                                  </actions>
                                  <cues>
                                    <cue name="Ch3_Loyalist_Angry_Reaction_v2" instantiate="true">
                                      <conditions>
                                        <event_conversation_started actor="$LoyalistActor"/>
                                      </conditions>
                                      <actions>
                                        <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                                          <text line="if player.entity.isfemale then 30221304 else 30221303" comment="(Disappointed)You remain failure."/>
                                        </add_npc_line>
                                      </actions>
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>


                    <cue name="Ch3_Dal_Funeral_Conversation" instantiate="true">
                      <conditions>
                        <check_any>
                          <!--<event_conversation_started actor="$DalBusta"/>-->
                          <event_conversation_next_section actor="$DalBusta" section="story_split"/>
                        </check_any>
                        <check_value value="$Ch3_Loyalist_Angry_Done?"/>
                      </conditions>
                      <actions>
                        <do_if value="event.param2 == null">
                          <cancel_cue cue="Ch1_Dal_Split_Intro"/>
                          <add_npc_line speaker="$DalBusta" hidechoices="true">
                            <text line="30221930" comment="There is nothing we could have done for him."/>
                            <text line="30221931" comment="The Zyarth Patriarchy is on edge and rather overzealous in their attempts to bring order to the Free Families."/>
                          </add_npc_line>
                          <add_player_choice section="story_split" choiceparam="'ch3_break_in_mission'" selectable="true" text="{30221,1056}" comment="(Player Choice)What can I do?"/>
                        </do_if>
                        <do_elseif value="event.param2 == 'ch3_break_in_mission'">
                          <add_npc_line speaker="$DalBusta" hidechoices="true">
                            <text line="30221307" comment="We need(emphasis) to get on the inside, literally!"/>
                            <text line="30221322" comment="I'll concentrate on distracting the funeral attendees."/>
                            <text line="if player.entity.isfemale then 30221324 else 30221323" comment="Boso will help you to break into that coffin ship."/>
                            <text line="if player.entity.isfemale then 30221326 else 30221325" comment="And off you go through the accelerator!"/>
                            <text line="if player.entity.isfemale then 30221379 else 30221327" comment="Don't worry!" delay="0.4s"/>
                            <text line="if player.entity.isfemale then 30221328 else 30221328" comment="I've stocked up on various technical widgets you might need!" delay="0.3s"/>
                            <!--ERROR: MISSING FEMALE VARIATION: Dal	<t id="30221328">I've stocked up on various technical widgets you might need!</t>
                               // added to TextDB changes as 30221366 -->
                          </add_npc_line>

                          <add_npc_line speaker="$BosoTa" hidechoices="true">
                            <text line="30221302" comment="Well, an EMP bomb would probably be the most useful thing to help us gain initial access."/>
                          </add_npc_line>
                          <add_npc_line speaker="$DalBusta" hidechoices="true">
                            <text line="30221329" comment="Right, I've got one here."/>
                          </add_npc_line>
                          <add_player_choice text="{30221,3051}" section="story_split" choiceparam="'ch3_break_in'" comment="Perfect.(Acknowledge getting inventory from male for specific task)"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_break_in'">
                          <do_if value="player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.count le 0">
                            <add_inventory entity="player.entity" ware="ware.weapon_gen_spacesuit_demolition_01_mk1" exact="1"/>
                          </do_if>
                          <add_inventory entity="player.entity" ware="ware.bomb_player_limpet_emp_01_mk1" exact="5"/>
                          <add_npc_line speaker="$DalBusta" hidechoices="true">
                            <text line="if player.entity.isfemale then 30221336 else 30221335" comment="They won't accept your ship being too close by during the procession."/>
                            <text line="30221337" comment="A space suit, however, might escape their notice."/>
                            <!--
                not used:  <t id="30221341">You can either jump into a spacesuit on the dock, or have another pilot fly your ship out of the way once you've jumped out.</t>
                not used:  <t id="30221342">(spoken to female 'you'){,30221341}</t>                
                not used:  <t id="30221340">Right, will do.</t>
        Boso    not used:  <t id="30221303">If you want to scramble their sensors then I recommend Dal's distraction as a particularly good suggestion.</ t>
        Boso    not used:  <t id="30221304">(spoken to female 'you'){,30221303}</t>-->
                            <text line="if player.entity.isfemale then 30221339 else 30221338" comment="Boso will help you scramble their sensors, just to make sure."/>
                            <text line="if player.entity.isfemale then 30221381 else 30221343" comment="The service is about to begin. Get in a spacesuit!"/>
                          </add_npc_line>
                          <set_value name="$Ch3_Breakin_Briefing_Completed"/>
                        </do_elseif>
                      </actions>
                    </cue>
                    <cue name="Ch3_Dal_Funeral_Conversation_Done">
                      <conditions>
                        <event_conversation_finished actor="$DalBusta"/>
                        <check_value value="$Ch3_Breakin_Briefing_Completed?"/>
                        <check_value value="event.param != 'g_cancel'"/>
                        <!-- TODO: Property lookup failed: g_cancel @Heinrich -->
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch3_Loyalist_Angry_Reaction_v2"/>
                        <signal_cue cue="Ch3_Undock_Coffin"/>
                        <signal_cue cue="Ch3_Coffin_Breakin"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
            <cue name="Ch3_Breakin_Briefing_Done">
              <!-- TOOD Remove this parent cue later, for now don't corrupt save games  -->
              <cues>
                <cue name="Ch3_Undock_Coffin" comment="For the most part, a Copy of Ch2_Undock_Coffin without the cutscene">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch3_Dal_Funeral_Conversation"/>
                    <!-- PLACE Coffin Ship -->
                    <create_loadout result="$loadout" comment="Courier Tuatara Loadout">
                      <macros>
                        <engine macro="engine_spl_s_combat_01_mk3_macro"    path="../con_engine_01" />
                        <engine macro="engine_spl_s_combat_01_mk3_macro"    path="../con_engine_02" />
                        <engine macro="engine_spl_s_combat_01_mk3_macro"    path="../con_engine_03" />
                        <weapon macro="weapon_gen_s_laser_01_mk1_macro"     path="../con_weapon_01"/>
                      </macros>
                      <virtualmacros>
                        <thruster macro="thruster_gen_s_combat_01_mk3_macro" />
                      </virtualmacros>
                    </create_loadout>
                    <!-- Courier Tuatara Spawn -->
                    <create_cue_actor name="$DeadPatriarch" cue="$MissionCue">
                      <select race="race.drone"/>
                      <owner exact="faction.civilian"/>
                    </create_cue_actor>

                    <create_ship name="$FuneralCoffinShip" capturable="false" commandeerable="false"
                                 missioncue="namespace"
                                 macro="ship_spl_s_trans_container_01_plot_01_macro"
                                 dock="$FuneralServiceDock">
                      <owner exact="faction.civilian"/>
                      <loadout loadout="$loadout"/>
                      <pilot actor="$DeadPatriarch"/>
                      <!--<select race="race.drone" tags="tag.aipilot"/>                            
                          </pilot>-->
                      <people>
                        <fillpercent exact="0"/>
                      </people>
                      <!-- paintmod 6 is the player starting paintmod so maybe a bad choice @Heinrich TODO PAintMods -->
                      <paint ware="$PaintMod_FuneralCoffinShip"/>
                      <!--
                          <position x="$FuneralLaunchPos.x" y="$FuneralLaunchPos.y" z="$FuneralLaunchPos.z"/>
                          <rotation value="$FaceFuneralGate"/> -->
                    </create_ship>
                    <set_object_relation_behaviour object="$FuneralCoffinShip" disable="true"/>
                    <set_object_name object="$FuneralCoffinShip" page="30221" line="208" comment="Coffin ship"/>
                    <set_object_min_hull object="$FuneralCoffinShip" exact="50"/>
                    <set_ship_safepos_allowed ship="$FuneralCoffinShip" allow="false"/>
                    <set_object_docking_enabled object="$FuneralCoffinShip" enabled="false"/>
                  </actions>
                  <delay exact="0.5s"/>
                  <actions>
                    <!--<create_order id="'Undock'" object="$FuneralCoffinShip" immediate="true"/>-->

                    <find_dockingbay name="$sdock" object="$FuneralCoffinShip.container">
                      <match_dock size="tag.dock_s"/>
                    </find_dockingbay>
                    <create_position name="$FuneralCoffinShipLaunchPos" x="$sdock.launchpos.x" y="$sdock.launchpos.y + 40m" z="$sdock.launchpos.z + 100m"/>
                    <create_order object="$FuneralCoffinShip" id="'MoveWait'">
                      <param name="destination" value="[$sdock, $FuneralCoffinShipLaunchPos]"/>
                      <param name="precise" value="true"/>
                    </create_order>
                  </actions>
                  <cues>
                    <!-- $Ch3_FuneralSteps_Undocked -->
                    <cue name="Ch3_Funeral_Steps_Coffin_Undocked">
                      <conditions>
                        <event_object_undocked_from container="$FuneralServiceShip"/>
                        <check_value value="event.param == $FuneralCoffinShip"/>
                      </conditions>
                      <actions>
                        <set_value name="$Ch3_FuneralSteps_Undocked"/>
                        <!--<dismiss_control_entity object="$FuneralCoffinShip" actor="$DeadPatriarch"/>-->
                        <!--<signal_cue_instantly cue="Ch2_Funeral_Steps_Coffin_Fireworks"/>
                            <signal_cue_instantly cue="Ch2_Funeral_Steps_Move_Coffin"/>-->
                        <!-- -->
                      </actions>
                    </cue>

                    <cue name="Ch3_Funeral_Undock_Safety" version="2">
                      <delay exact="10s"/>
                      <actions>
                        <do_if value="(Ch3_Funeral_BreakIn_Done.state == cuestate.waiting) and ($FuneralCoffinShip.dock)">
                          <create_order object="$FuneralCoffinShip" id="'MoveWait'">
                            <param name="destination" value="[$sdock, $FuneralCoffinShipLaunchPos]"/>
                            <param name="precise" value="true"/>
                          </create_order>
                          <reset_cue cue="this"/>
                        </do_if>
                      </actions>
                      <patch sinceversion="2">
                        <reset_cue cue="this"/>
                      </patch>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch3_Funeral_Distraction">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
              </actions>
              <cues>

                <cue name="Ch3_Funeral_DalToBridge">
                  <actions>
                    <create_position name="this.$DalPos" x="2.83" y="0.1" z="-0.45"/>
                    <create_rotation name="this.$DalRot" yaw="-86.9deg"/>
                    <set_value name="$TempRoom" exact="$CurbActor.room"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $DalBusta,
                                                                                                table[
                                                                                                $requestercue = namespace,
                                                                                                $location = $TempRoom,
                                                                                                $rotation = this.$DalRot,
                                                                                                $position = this.$DalPos,
                                                                                                $priority = 100,
                                                                                                $debugchance = $DeepDebugChance]
                                                                                                ]"/>
                  </actions>
                </cue>

                <cue name="Ch3_Dal_344_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="DelayInitial"      value="3s"/>
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                  <param name="Lines"             value="[ [if player.entity.isfemale then 30221345 else 30221344] ]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="Ch3_Funeral_Speech_Curb_1"/>
                  <!-- 
                  <t id="30221344">Time to shine. Don't let me down.</t>
                  <t id="30221345">(spoken to female 'you'){,30221344}</t>
                  -->
                </cue>
                <cue name="Ch3_Funeral_Speech_Curb_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <speak actor="$CurbActor" priority="90" recipient="$DeadPatriarch">
                      <text line="30221301" delay="2s" comment="Guests will now honour fallen Patriarch Noa t'Hlp."/>
                      <text line="30221302" comment="Noa t'Hlp was slaughtered by Zyarth occupiers, after unjust trial by false authority!"/>
                      <text line="30221303" comment="A witness will now speak of his bravery!"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch3_Funeral_Speech_Dal_1">
                  <conditions>
                    <event_speak_finished actor="$CurbActor" line="30221301"/>
                  </conditions>
                  <actions>
                    <speak actor="$DalBusta" priority="90" recipient="$DeadPatriarch">
                      <text line="30221346" comment="I have stories of his bravery!"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch3_Funeral_Speech_Curb_2">
                  <conditions>
                    <event_speak_finished actor="$DalBusta" line="30221346"/>
                  </conditions>
                  <actions>
                    <speak actor="$CurbActor" priority="90" recipient="$DeadPatriarch">
                      <text line="30221304" comment="Argon visitor will remain quiet!"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch3_Funeral_Speech_Dal_2">
                  <conditions>
                    <event_speak_finished actor="$CurbActor" line="30221304"/>
                  </conditions>
                  <actions>
                    <speak actor="$DalBusta" priority="90" recipient="$DeadPatriarch">
                      <text line="30221347" comment="Please, ..."/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch3_Funeral_Speech_Curb_3">
                  <conditions>
                    <event_speak_finished actor="$DalBusta" line="30221347"/>
                  </conditions>
                  <actions>
                    <speak actor="$CurbActor" priority="90" recipient="$DeadPatriarch">
                      <text line="30221305" comment="Quiet!"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch3_Funeral_Speech_Dal_3">
                  <conditions>
                    <event_speak_finished actor="$CurbActor" line="30221305"/>
                  </conditions>
                  <actions>
                    <speak actor="$DalBusta" priority="90" recipient="$DeadPatriarch">
                      <text line="30221348" comment="With all due respect, ..."/>
                      <text line="30221349" comment="I came here to say goodbye to a Split whose songs of bravery impressed my kin!"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch3_Funeral_Speech_Curb_4">
                  <conditions>
                    <event_speak_finished actor="$DalBusta" line="30221348"/>
                  </conditions>
                  <actions>
                    <speak actor="$CurbActor" priority="90" recipient="$DeadPatriarch">
                      <text line="30221306" comment="*** muttering noises ***"/>
                      <text line="30221307" comment="Argon may continue to pay respects!" delay="2s"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch3_Funeral_Speech_Dal_4">
                  <conditions>
                    <event_speak_finished actor="$CurbActor" line="30221306"/>
                  </conditions>
                  <actions>
                    <speak actor="$DalBusta" priority="90" recipient="$DeadPatriarch">
                      <text line="30221350" comment="Thank you!"/>
                      <text line="30221351" comment="First, I want to thank you very much for giving me this opportunity."/>
                      <text line="30221352" comment="It is quite... (slight pause)progressive of you to give an outsider a voice in an event so significant."/>
                      <text line="30221353" comment="I was quite young when I first heard of his bravery!"/>
                      <text line="30221354" comment="The deceased...(cut off, can be mid-word)"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch3_Funeral_Speech_Boso_1">
                  <conditions>
                    <event_speak_finished actor="$DalBusta" line="30221350"/>
                  </conditions>
                  <cues>
                    <cue name="Ch3_Speak_Boso_315_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30221316 else 30221315]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch3_Funeral_Speech_Done"/>
                      <!-- 
                      <t id="30221315">I have terminated your connection to Dal for the moment, to avoid suspicious communication signals, and also to alleviate your inevitable boredom.</t>
                      <t id="30221316">(spoken to female 'you'){,30221315}</t>                          -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch3_Coffin_Breakin">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <update_mission cue="$MissionCue" name="{30221,3101}" description="if player.entity.isfemale then ({30221,3003} + '\n\n' + {30221,3005} + '\n\n' + {30221,3103}) else ({30221,3002} + '\n\n' + {30221,3004} + '\n\n' + {30221,3102})" rewardtext="{30221,3199}">
                  <briefing>
                    <objective step="1" action="objective.talkto"       object="$DalBusta"/>
                    <objective step="2" action="objective.usespacesuit" comment="Use spacesuit"/>
                  </briefing>
                </update_mission>
                <set_value name="$CurrentStep" exact="2"/>
                <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep" comment="Disembark: Spacesuit"/>

                <create_group groupname="$CoffinSignalLeaks"/>
                <create_group groupname="$PlayerBombs"/>

                <set_value name="$LeakPositionTable" exact="table[]"/>
                <set_value name="$LeakRotationTable" exact="table[]"/>
                <!-- Save this values for the leak on bomb placement, as I cannot get them through the destruction event -->
              </actions>
              <cues>

                <cue name="Ch3_Coffin_Breakin_UndockCoffin_Safety" comment="Fix for a player whose CoffinShip was docked at this stage" onfail="cancel">
                  <conditions>
                    <check_value value="cuestate.waiting == Ch3_Funeral_BreakIn_Done.state"/>
                    <check_value value="$FuneralCoffinShip.dock"/>
                  </conditions>
                  <actions>
                    <create_order object="$FuneralCoffinShip" id="'MoveWait'">
                      <param name="destination" value="[$sdock, $FuneralCoffinShipLaunchPos]"/>
                      <param name="precise" value="true"/>
                    </create_order>
                  </actions>
                </cue>

                <cue name="Ch3_Player_In_Suit_Already">
                  <actions>
                    <do_if value="@player.controlled.isclass.spacesuit">
                      <signal_cue cue="Ch3_Player_Approaching_Coffin_In_Spacesuit"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch3_Player_Approaching_Coffin_In_Spacesuit">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <check_all>
                        <event_player_teleport_successful/>
                        <check_value value="@player.controlled.isclass.spacesuit"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <delay exact="2s"/>
                  <actions>
                    <signal_cue cue="Ch3_Boso_Warning_305"/>
                    <signal_cue cue="Ch3_BreakIn_EMP_Obj"/>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <signal_cue cue="Ch3_Funeral_Distraction"/>
                    <signal_cue cue="Ch3_BreakIn_Docking"/>
                  </actions>
                </cue>

                <cue name="Ch3_Boso_Warning_305">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="not $Ch3_Breakin_Docking_Denied_Done?"/>
                  </conditions>
                  <cues>
                    <cue name="Ch3_Boso_Warning_305_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor" value="$BosoTa"/>
                      <param name="CutsceneKey" value="$BosoCutsceneKey"/>
                      <param name="Lines" value="[[if player.entity.isfemale then 30221306 else 30221305]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue" value="Ch3_Boso_Warning_Done"/>
                      <!-- 
                              <t id="30221305">You need to approach the funeral ship with great care.</t>
                              <t id="30221306">(spoken to female 'you'){,30221305}</t>                   
                    not used: <t id="30221307">I have managed to orchestrate a postponement of the funeral thanks to some "technical difficulties" with their coffin ship.</t>
                    not used: <t id="30221308">See if you can gain access to the ship by requesting docking permission first.</t>
                              <t id="30221309">(spoken to female 'you'){,30221308}</t>
                              -->
                    </cue>
                    <cue name="Ch3_Boso_Warning_Done">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$Ch3_Boso_Warning_Done"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_BreakIn_Docking">
                  <!-- TODO: @Heinrich delete parent cue in next iteration, don't now for savegame reasons -->
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch3_Breakin_Docking_Denied">
                      <conditions>
                        <check_any>
                          <event_object_docking_denied group="global.$PlayerContainerGroup"/>
                          <check_all>
                            <event_object_docking_impossible group="global.$PlayerContainerGroup"/>
                            <check_value value="event.param == $FuneralCoffinShip"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <set_value name="$Ch3_Breakin_Docking_Denied_Done"/>
                      </actions>
                      <cues>
                        <cue name="Ch3_Boso_310_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor" value="$BosoTa"/>
                          <param name="CutsceneKey" value="$BosoCutsceneKey"/>
                          <param name="Lines" value="[[if player.entity.isfemale then 30221311 else 30221310]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                          <t id="30221310">It's a pity that didn't work. I suppose you'll have to use that EMP bomb that Dal provided..</t>
                          <t id="30221311">(spoken to female 'you'){,30221310}</t>
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_BreakIn_EMP_Obj">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$CoffinSignalLeaks.count le 0">
                      <set_value name="$CurrentStep" exact="1" operation="add"/>
                      <set_objective cue="$MissionCue" action="objective.launch" object="$FuneralCoffinShip" text="{30220,3007}" step="$CurrentStep" comment="Launch EMP to create Signal Leak" updatebriefing="true"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch3_Player_Created_Leak" comment="Misnamed Cue, keep for Savegame reasons">
                  <cues>
                    <cue name="Ch3_Player_Attached_EMP" instantiate="true">
                      <conditions>
                        <event_player_bomb_attached/>
                        <check_value value="event.param.macro == macro.bomb_player_limpet_emp_01_mk1_macro"/>
                        <check_value value="event.param.parent == $FuneralCoffinShip"/>
                      </conditions>
                      <actions>
                        <add_to_group groupname="$PlayerBombs" object="event.param"/>
                        <set_value name="$MissionLeakMacro_Small" exact="macro.dataleak_xs_standard_01_macro" />
                        <find_object_surface object="$FuneralCoffinShip" posname="$targetpos" rotname="$targetrot" space="$FuneralCoffinShip" height="$MissionLeakMacro_Small.boundingbox.max.y - $MissionLeakMacro_Small.boundingbox.center.y">
                          <position object="event.param" />
                          <offsetrotation pitch="-90deg" comment="-90deg might be correct"/>
                        </find_object_surface>
                        <set_value name="$LeakPositionTable.{event.param}" exact="$targetpos"/>
                        <set_value name="$LeakRotationTable.{event.param}" exact="$targetrot"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_Player_Placed_BombOther" instantiate="true">
                      <conditions>
                        <event_player_bomb_attached/>
                        <check_value value="event.param.macro != macro.bomb_player_limpet_emp_01_mk1_macro"/>
                        <check_value value="event.param.parent == $FuneralCoffinShip"/>
                      </conditions>
                      <actions>
                        <!--show_help line="7202" duration="10s" position="13" force="true" comment="Switch the ammo of your launcher to 'Spacesuit EMPs'."/-->

                        <!-- We still save the bomb position -->
                        <set_value name="$MissionLeakMacro_Small" exact="macro.dataleak_xs_standard_01_macro" />
                        <find_object_surface object="$FuneralCoffinShip" posname="$targetpos" rotname="$targetrot" space="$FuneralCoffinShip" height="$MissionLeakMacro_Small.boundingbox.max.y - $MissionLeakMacro_Small.boundingbox.center.y">
                          <position object="event.param" />
                          <offsetrotation pitch="-90deg" comment="-90deg might be correct"/>
                        </find_object_surface>
                        <set_value name="$LeakPositionTable.{event.param}" exact="$targetpos"/>
                        <set_value name="$LeakRotationTable.{event.param}" exact="$targetrot"/>
                      </actions>
                      <cues>
                        <cue name="Ch3_Player_Placed_BombOther_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor" value="$BosoTa"/>
                          <param name="CutsceneKey" value="$BosoCutsceneKey"/>
                          <param name="Lines" value="[[if player.entity.isfemale then 30200005 else 30200004], [30200006, 1s]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch3_Player_Placed_BombOther_Wrong_Ammo_Delay"/>
                          <!--
                            <t id="30200004">The ordnance you are using does not appear to be particularly suitable for the job.</t>
                            <t id="30200005">(spoken to female player 'you'){,30200004}</t>
                            <t id="30200006">I recommend switching to EMPs.(pronounced Ee-Em-Pees)</t>
                          -->
                        </cue>

                        <cue name="Ch3_Player_Placed_BombOther_Wrong_Ammo_Delay">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="20s"/>
                          <actions>
                            <reset_cue cue="Ch3_Player_Placed_BombOther"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch3_Player_Triggered_EMP" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$PlayerBombs" method="killmethod.selfdestructed"/>
                      </conditions>
                      <actions>
                        <!-- manually place $Leak in $CoffinSignalLeaks on $FuneralCoffinShip-->
                        <debug_text text="'Bomb destroyed ' + event.object.knownname"/>
                        <set_value name="$bomb" exact="event.object"/>

                        <create_signal_leak name="$SignalLeak" groupname="$CoffinSignalLeaks" macro="macro.dataleak_xs_standard_01_macro" type="signalleaktype.mission" object="$FuneralCoffinShip" sector="$FuneralCoffinShip.sector">
                          <position value="$LeakPositionTable.{$bomb}" />
                          <rotation value="$LeakRotationTable.{$bomb}" />
                          <!--<voice page="$SignalLeakActor.page" lines="[1000003, 1000004, 1000005]"/>-->
                        </create_signal_leak>

                        <debug_text text="$SignalLeak.knownname + ' in ' + $SignalLeak"/>
                        <signal_cue cue="Ch3_Leak_Created_Manually"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_Player_Out_Of_Bombs" checkinterval="10s">
                      <conditions>
                        <check_value value="not player.entity.inventory.{ware.bomb_player_limpet_emp_01_mk1}.count"/>
                        <check_value value="not $PlayerBombs.count"/>
                        <check_value value="not $Ch3_Leak_Done?"/>
                      </conditions>
                      <delay exact="20s"/>
                      <actions>
                        <signal_cue cue="Ch3_Player_Out_Of_Bombs_Autocreate_Leak"/>
                        <!-- TODO: Give the player a source of bombs instead, e.g. stash on the dock -->
                      </actions>
                    </cue>

                    <cue name="Ch3_Player_Out_Of_Bombs_Autocreate_Leak">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="cuestate.waiting == Ch3_Funeral_BreakIn_Done.state"/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Player_Out_Of_Bombs_Boso_30221264" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30221264]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch3_Create_Leak"/>
                          <!-- <t id="30221264">I have located a potential Signal Leak for our purposes.</t> -->
                        </cue>
                        <cue name="Ch3_Create_Leak">
                          <conditions>
                            <event_cue_signalled/>
                            <check_value value="cuestate.waiting == Ch3_Funeral_BreakIn_Done.state"/>
                          </conditions>
                          <actions>
                            <do_if value="$LeakPositionTable.keys.count">
                              <set_value name="$targetpos" exact="$LeakPositionTable.{1}"/>
                              <set_value name="$targetrot" exact="$LeakRotationTable.{1}"/>
                            </do_if>
                            <do_else>
                              <!-- Player never placed a bomb, so we use the service ship as a reference object -->
                              <set_value name="$MissionLeakMacro_Small" exact="macro.dataleak_xs_standard_01_macro" />
                              <find_object_surface object="$FuneralCoffinShip" posname="$targetpos" rotname="$targetrot" space="$FuneralCoffinShip" height="$MissionLeakMacro_Small.boundingbox.max.y - $MissionLeakMacro_Small.boundingbox.center.y">
                                <position object="$FuneralServiceShip" />
                                <offsetrotation pitch="-90deg" comment="-90deg might be correct"/>
                              </find_object_surface>
                            </do_else>
                            <create_signal_leak name="$SignalLeak" groupname="$CoffinSignalLeaks" macro="macro.dataleak_xs_standard_01_macro" type="signalleaktype.mission" object="$FuneralCoffinShip" sector="$FuneralCoffinShip.sector">
                              <position value="$targetpos" />
                              <rotation value="$targetrot" />
                              <!--<voice page="$SignalLeakActor.page" lines="[1000003, 1000004, 1000005]"/>-->
                            </create_signal_leak>
                            <signal_cue cue="Ch3_Leak_Created_Manually"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_BreakIn_EMP">
                  <cues>
                    <cue name="Ch3_Leak_Created_Manually" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch3_Player_Placed_BombOther"/>
                        <do_if value="$CoffinSignalLeaks.count">
                          <set_objective cue="$MissionCue" action="objective.scan" group="$CoffinSignalLeaks" updatebriefing="true" comment="Now we know the target objects" step="4"/>
                          <do_if value="not $BosoSaid.indexof.{30221279}">
                            <signal_cue cue="Ch3_Boso_Speak_Scan"/>
                            <append_to_list name="$BosoSaid" exact="30221279"/>
                          </do_if>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch3_Leak_Created" instantiate="true">
                      <conditions>
                        <event_player_created_signal_leaks/>
                        <check_value value="event.param.{1}.parent == $FuneralCoffinShip"/>
                      </conditions>
                      <actions>
                        <do_for_each in="event.param" name="$leak">
                          <add_to_group groupname="$CoffinSignalLeaks" object="$leak"/>
                        </do_for_each>
                        <do_if value="$CoffinSignalLeaks.count gt 0">
                          <set_objective cue="$MissionCue" action="objective.scan" group="$CoffinSignalLeaks" updatebriefing="true" comment="Now we know the target objects" step="4"/>
                          <do_if value="not $BosoSaid.indexof.{30221279}">
                            <signal_cue cue="Ch3_Boso_Speak_Scan"/>
                            <append_to_list name="$BosoSaid" exact="30221279"/>
                          </do_if>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch3_Boso_Speak_Scan">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not $Ch3_Leak_Done?"/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Speak_Boso_279_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30221280 else 30221279, 1s]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!-- 
                              <t id="30221279">Please proceed with the scan.</t>
                              <t id="30221280">(spoken to female 'you'){,30221279}</t>
                              -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch3_Leaks_Destroyed">
                      <conditions>
                        <event_object_destroyed group="$CoffinSignalLeaks"/>
                        <check_value value="$CoffinSignalLeaks.count == 0"/>
                      </conditions>
                      <actions>
                        <do_if value="not $Ch3_Leak_Done?">
                          <set_objective cue="$MissionCue" action="objective.launch" object="$FuneralCoffinShip" text="{30220,3007}" comment="Launch: EMP to Create Signal Leak" step="3"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch3_Scan_Leak">
                      <conditions>
                        <check_any>
                          <event_player_repaired_signal_leak/>
                          <event_player_signal_unlock_impossible/>
                          <event_player_signal_unlock_finished/>
                        </check_any>
                        <check_value value="$CoffinSignalLeaks.indexof.{event.param}"/>
                      </conditions>
                      <actions>
                        <set_value name="$Ch3_Leak_Done"/>
                        <signal_cue cue="Ch3_Scan_Leak_Done"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_Scan_Leak_Done" version="2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_object_docking_enabled object="$FuneralCoffinShip" enabled="true"/>
                        <set_objective cue="$MissionCue" object="$FuneralCoffinShip" action="objective.dockat" step="5" updatebriefing="true"/>
                        <!--<assign_control_entity object="$FuneralCoffinShip" post="controlpost.aipilot" actor="$DeadPatriarch" transfer="true"/>-->

                        <cancel_all_orders object="$FuneralCoffinShip"/>
                        <set_ship_safepos_allowed ship="$FuneralCoffinShip" allow="false"/>
                        <create_order id="'Wait'" object="$FuneralCoffinShip" default="true" comment="stay put">
                          <param name="noattackresponse" value="true"/>
                        </create_order>
                        <create_order id="'Wait'" object="$FuneralCoffinShip" immediate="true" comment="stay put">
                          <param name="noattackresponse" value="true"/>
                        </create_order>
                        <cancel_cue cue="Ch3_Player_Triggered_EMP"/>
                        <cancel_cue cue="Ch3_Leak_Created_Manually"/>
                        <cancel_cue cue="Ch3_Leak_Created"/>
                      </actions>
                      <patch sinceversion="2">
                        <cancel_cue cue="Ch3_Player_Triggered_EMP"/>
                        <cancel_cue cue="Ch3_Leak_Created_Manually"/>
                        <cancel_cue cue="Ch3_Leak_Created"/>
                        <do_if value="Ch3_Funeral_BreakIn_Done.state == cuestate.waiting">
                          <set_objective cue="$MissionCue" object="$FuneralCoffinShip" action="objective.dockat" step="5" updatebriefing="true"/>
                        </do_if>
                      </patch>
                      <cues>
                        <cue name="Ch3_Boso_312_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30221312]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!-- 
                          <t id="30221312">Ah well. I suppose that turned out to be relatively easy in the end.</t> -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch3_Funeral_Speech_Done">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$FuneralSpeechDone"/>
                <do_if value="$FuneralBreakInDone?">
                  <signal_cue cue="Ch3_Funeral_Cutscene"/>
                </do_if>
              </actions>
            </cue>
            <cue name="Ch3_Funeral_BreakIn_Done">
              <conditions>
                <event_player_teleport_successful/>
                <check_value value="$FuneralCoffinShip?"/>
                <check_value value="player.entity.object == $FuneralCoffinShip"/>
              </conditions>
              <actions>
                <cancel_cue cue="Ch3_BreakIn_Docking"/>
                <set_objective cue="$MissionCue" action="objective.await" text="{30220,3014}" comment="(objective.await)Further Instructions"/>
                <set_value name="$FuneralBreakInDone"/>
                <do_if value="$FuneralSpeechDone?">
                  <signal_cue cue="Ch3_Funeral_Cutscene"/>
                </do_if>
                <set_value name="player.entity.$x4ep1_teleporter_malfunctioning" exact="true"/>
                <find_dockingbay name="$FuneralCoffinShipDocks" object="$FuneralCoffinShip" multiple="true"/>
                <do_for_each in="$FuneralCoffinShipDocks" name="$FuneralCoffinShipDock">
                  <set_room_locked room="$FuneralCoffinShipDock" locked="true"/>
                </do_for_each>
              </actions>
            </cue>

            <cue name="Ch3_Funeral_Cutscene">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <play_music music="'music_story_split_boneyard'"/>
                <!-- TODO: Cutscene which starts later -->
                <play_cutscene result="this.$CutsceneID" key="'Story_Split_Funeral_Accelerator_2'" abortable="false">
                  <param name="target_gate" object="$FuneralGate"/>
                  <param name="target_ship" object="$FuneralServiceShip"/>
                </play_cutscene>
                <!-- maybe wait for the cutscene to start -->
                <set_object_active object="$FuneralGate" activate="true"/>
                <cancel_all_orders object="$FuneralCoffinShip"/>
                <create_order id="'DockAndWait'" object="$FuneralCoffinShip">
                  <param name="destination" value="$BoneyardCarrier" comment="stay docked at Halls of Judgement"/>
                </create_order>
              </actions>
              <cues>
                <cue name="Ch3_Boso_Speak_313">
                  <delay exact="2s"/>
                  <actions>
                    <speak actor="$BosoTa" priority="90">
                      <text line="if player.entity.isfemale then 30221314 else 30221313" comment="Good luck on your journey to the other side!"/>
                    </speak>
                    <set_objective cue="$MissionCue" action="objective.wait"/>
                  </actions>
                </cue>
                <cue name="Ch3_Funeral_Stop_Cutscene">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                    <signal_cue cue="Ch3_Boneyard"/>
                  </actions>
                  <cues>
                    <cue name="Ch3_Coffin_Reached_Sector_Ref" ref="md.LIB_Generic.ReachedSector">
                      <param name="TargetObject" value="$FuneralCoffinShip"/>
                      <param name="TargetSector" value="$BoneYardSector"/>
                      <param name="SuccessSignalCue" value="Ch3_Coffin_In_Sector"/>
                    </cue>

                    <cue name="Ch3_Coffin_In_Sector">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_object_active object="$FuneralGate" activate="false"/>
                      </actions>
                      <cues>
                        <cue name="Ch3_Gate_Close_Failsafe">
                          <delay exact="0.1s"/>
                          <actions>
                            <do_if value="$FuneralGate.isactive" comment="Gate failed to close once in testing">
                              <set_object_active object="$FuneralGate" activate="false"/>
                              <reset_cue cue="this"/>
                            </do_if>
                            <do_else>
                              <set_value name="$Ch3_FuneralSteps_GateClosed"/>
                            </do_else>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
                <!-- Start Fireworks - Only if Signalled and $Ch2_FuneralSteps_Undocked? -->
                <cue name="Ch3_Funeral_Steps_Coffin_Fireworks">
                  <!--<conditions>
                    <event_cue_signalled/>
                  </conditions>-->
                  <cues>
                    <cue name="Ch3_Funeral_Fireworks_Init" checkinterval="1s">
                      <conditions>
                        <check_value value="$Ch3_FuneralSteps_Undocked?"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_Launch_Coffin_Countermeasures_Loop"/>
                      </actions>
                    </cue>
                    <cue name="Ch3_Launch_Coffin_Countermeasures_Loop">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="0.7s"/>
                      <actions>
                        <add_ammo object="$FuneralCoffinShip" macro="macro.countermeasure_flares_01_macro" amount="1"/>
                        <launch_countermeasures object="$FuneralCoffinShip"/>
                        <signal_cue cue="Ch3_Launch_Countermeasures_Refire"/>
                        <reset_cue cue="this"/>
                      </actions>
                    </cue>
                    <cue name="Ch3_Launch_Countermeasures_Refire">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="0.7s"/>
                      <actions>
                        <do_if value="$BoneYardSector != $FuneralCoffinShip.sector">
                          <signal_cue cue="Ch3_Launch_Coffin_Countermeasures_Loop"/>
                          <reset_cue cue="this"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch3_Funeral_Stop_Cutscene"/>
                        </do_else>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch3_Boneyard" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_coffin"/>

                <!-- Put Dal back on the dock for later meetings -->
                <create_position name="$DalPos" x="-10.79" z="21.542"/>
                <create_rotation name="$DalRot" yaw="142.0deg"/>
                <find_object_component name="$Dock" object="$FuneralServiceShip" checkoperational="true" macro="macro.dockingbay_arg_s_01_macro"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $DalBusta,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Dock,
                                                                                                      $rotation = $DalRot,
                                                                                                      $position = $DalPos,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                <!--<set_owner object="$FuneralCoffinShip" faction="faction.freesplit"/>-->

                <create_position name="$MeetingPos" object="$BoneyardCarrier" space="$BoneYardSector" x="0km" y="0km" z="1km"/>

                <!--<create_order id="'DockAndWait'" object="$FuneralCoffinShip">
                  <param name="destination" value="$BoneyardCarrier"/>
                </create_order>-->
                <cancel_all_orders object="$FuneralCoffinShip"/>
                <create_order id="'MoveWait'" object="$FuneralCoffinShip" immediate="true">
                  <param name="destination" value="[$BoneyardCarrier.sector, $MeetingPos]"/>
                  <param name="debugchance" value="$DeepDebugChance"/>
                </create_order>

                <set_value name="$Current_Paint" exact="[$SplitPaintMods.$curbsStripes, $SplitPaintMods.$curbsBasic].random"/>


                <create_ship name="$Balaur_Patrol" sector="$BoneyardCarrier.sector"
                             macro="ship_spl_s_heavyfighter_02_a_macro" commandeerable="false" missioncue="namespace">
                  <owner exact="faction.freesplit"/>
                  <paint ware="$Current_Paint"/>
                  <pilot>
                    <select faction="faction.freesplit" tags="tag.fighterpilot"/>
                  </pilot>
                  <loadout loadout="$Curbs_S_Heavy_Balaur"/>
                  <position x="$BoneyardCarrierPosition.x" y="$BoneyardCarrierPosition.y + 4km" z="$BoneyardCarrierPosition.z + 3km"/>
                  <rotation value="$FaceBoneYardAccelerator_OutOf"/>
                </create_ship>
              </actions>
              <delay exact="1s"/>
              <actions>
                <cancel_all_orders object="$Balaur_Patrol"/>
                <create_order id="'MoveWait'" object="$Balaur_Patrol" immediate="true">
                  <param name="destination" value="[$BoneyardCarrier.sector, $MeetingPos]"/>
                  <param name="debugchance" value="$DeepDebugChance"/>
                </create_order>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Balaur_Patrol,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                <do_if value="false">
                  <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                        param="['add_definition', $OutcastActor, table[
                                                                                         $requestercue = $MissionCue,
                                                                                         $priority = 100,
                                                                                         $location = 'disconnect',
                                                                                         $slottags = [tag.stand],
                                                                                         $debugchance = $DebugChance,
                                                                                         $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                  <!--<signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $OutcastActor, namespace]"/>-->
                </do_if>

              </actions>
              <patch sinceversion="2" state="cancelled">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_coffin"/>
              </patch>
              <patch sinceversion="2" state="complete">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_coffin"/>
              </patch>
              <cues>

                <cue name="Ch3_Balaur_Refresh_Position">
                  <delay exact="10s"/>
                  <actions>
                    <cancel_all_orders object="$Balaur_Patrol"/>
                    <create_order id="'MoveWait'" object="$Balaur_Patrol" immediate="true">
                      <param name="destination" value="[$FuneralCoffinShip.sector, $FuneralCoffinShip.position]"/>
                      <param name="debugchance" value="$DeepDebugChance"/>
                    </create_order>
                    <reset_cue cue="this"/>
                  </actions>
                </cue>

                <cue name="Ch3_Boneyard_Dialog_1_Boso">
                  <cues>
                    <cue name="Ch3_Speak_Boso_318_Ref_4" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="DelayInitial"      value="10s"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30221318 else 30221317], [30221319], [30221322, 1s]]"/>
                      <!--                      
                      I succeeded in using your transceiver to identify your location quite precisely before the accelerator closed.
                      As a result, I have re-established communications!
                       <t id="30221322">The closed accelerator seems to interfere with our teleportation technology.</t>

                        -->
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch3_Boneyard_Dialog_2_Dal"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_Boneyard_Dialog_2_Dal">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch3_Speak_Dal_355_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                      <param name="DelayInitial"      value="3s"/>
                      <param name="Lines"             value="[[30221355], [30221356], [30221357], [30221358]]"/>
                      <!--                      
                      <text line="30221355" delay="6s" comment="I got out of there, finally."/>
                      <text line="30221356" delay="0.8s" comment="How are things on the other side?"/>
                      <text line="30221357" delay="0.8s" comment="Any Split ghosts haunting the place?"/>
                      <text line="30221358" delay="0.8s" comment="Is it as dead as they tried to make us believe?"/>
                        -->
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch3_Boneyard_Dialog_3_Outcast"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_Boneyard_Dialog_3_Outcast">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$OutcastLines" exact="[]"/>
                    <do_if value="$AffiliationPatriarchy">
                      <append_to_list name="$OutcastLines" exact="[if player.entity.isfemale then 30221320 else 30221319]" comment="(hissing)You!"/>
                      <append_to_list name="$OutcastLines" exact="[if player.entity.isfemale then 30221322 else 30221321]" comment="(hissing)You will regret coming here!"/>
                    </do_if>
                    <do_elseif value="$AffiliationFF">
                      <append_to_list name="$OutcastLines" exact="[if player.entity.isfemale then 30221316 else 30221315]" comment="Pilot, welcome to Split resistance!"/>
                      <append_to_list name="$OutcastLines" exact="[if player.entity.isfemale then 30221318 else 30221317]" comment="Follow. We meet leaders!"/>
                    </do_elseif>
                    <do_elseif value="player.entity.race == race.split">
                      <append_to_list name="$OutcastLines" exact="[30221310]" comment="Look what we have here!"/>
                      <append_to_list name="$OutcastLines" exact="[if player.entity.isfemale then 30221312 else 30221311]" comment="Stowaway, you come with us!"/>
                    </do_elseif>
                    <do_else>
                      <append_to_list name="$OutcastLines" exact="[30221310]" comment="Look what we have here!"/>
                      <append_to_list name="$OutcastLines" exact="[if player.entity.isfemale then 30221314 else 30221313]" comment="Creature, you come with us!"/>
                    </do_else>


                    <set_value name="$Lines" exact="[[if player.entity.isfemale then 30221360 else 30221359], [30221361], [if player.entity.isfemale then 30221363 else 30221362]]"/>
                    <do_if value="$AffiliationPatriarchy">
                      <append_to_list name="$Lines" exact="[if player.entity.isfemale then 30221365 else 30221364]"/>
                      <!--
                    <t id="30221359">Sounds like they got you.</t>
                    <t id="30221360">(spoken to female 'you'){,30221359}</t>
                    <t id="30221361">Right.</t>
                    <t id="30221362">You'll need to try and make yourself seem valuable to them to avoid the worst!</t>
                    <t id="30221363">(spoken to female 'you'){,30221362}</t>
                    <t id="30221364">Don't you tell her that you're a member of family Nhuut yourself!</t>
                    <t id="30221365">(spoken to female 'you'){,30221364}</t>-->
                    </do_if>
                  </actions>
                  <cues>
                    <cue name="Ch3_Speak_Boso_321_Ref_v2" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$OutcastActor, $BosoTa, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$OutcastCutsceneKey, $BosoCutsceneKey, $Dal2CutsceneKey]"/>
                      <param name="DelayInitial"      value="[6s,0s,0s]"/>
                      <param name="Lines"             value="[$OutcastLines, [[30221321]], $Lines]"/>
                      <!-- <t id="30221321">*** Squeaking Noise of Worry and Discontent ***</t>-->
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[null, null, Ch3_Trials]"/>
                    </cue>
                  </cues>
                </cue>

              </cues>

            </cue>

            <cue name="Ch3_Trials">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <fade_screen fadeout="0.5s" fadein="0.5s" realtime="true"/>
                <cancel_cue cue="Ch3_Balaur_Refresh_Position"/>
              </actions>
              <delay exact="0.5s"/>
              <actions>
                <!-- (Mission Title)Seem Valuable -->
                <update_mission cue="$MissionCue" abortable="false" description="(if player.entity.isfemale then {30221,3003} else {30221,3002}) + '\n\n' + (if player.entity.isfemale then {30221,3203} else {30221,3202})"
                                type="missiontype.plot" name="{30221,3201}" faction="faction.player" difficulty="level.easy"
                                rewardtext="{30221,3299}">
                  <briefing>
                    <!-- maybe add "objective.find" followed by .attack -->
                    <objective step="6" action="objective.free" text="player.entity.knownname"/>
                  </briefing>
                </update_mission>
                <set_value name="$CurrentStep" exact="6"/>
                <set_objective_from_briefing step="$CurrentStep" cue="$MissionCue"/>

                <!-- Zyarth Secret Police -->
                <set_entity_overrides entity="$LoyalistActor" icon="'shadyguy'" title="'{30221,159}'"/>

                <!--<dismiss_control_entity object="$FuneralCoffinShip" actor="$OutcastActor"/>-->
                <!-- Create Carrier Prison Room (persistent) -->
                <set_value name="$CRB_PrisonMacro" exact="macro.room_gen_detentioncell_01_macro"/>
                <get_room_definition doors="$CRB_PrisonInteriorDoors" macro="$CRB_PrisonCorridorMacro" race="race.split" tags="tag.corridor" />

                <set_value name="$CRB_PrisonDoor" exact="if $CRB_PrisonInteriorDoors.count ge 3 then $CRB_PrisonInteriorDoors.{3} else $CRB_PrisonInteriorDoors.{1}"/>
                <create_dynamic_interior interiorname="$CRB_Prison_Interior" corridorname="$CRB_Prison_Corridor" roomname="$CRB_Prison_Room" object="$BoneyardCarrier" room="$CRB_PrisonMacro" corridor="$CRB_PrisonCorridorMacro" door="$CRB_PrisonDoor" name="'{20007,3021}'" persistent="true"/>
                <set_dynamic_interior_private object="$BoneyardCarrier" interior="$CRB_Prison_Interior" private="true"/>
                <set_triggers_locked object="$CRB_Prison_Room" group="tag.door_01" locked="true"/>
                <set_triggers_locked object="$CRB_Prison_Room" group="tag.door_02" locked="true"/>
                <set_triggers_locked object="$CRB_Prison_Room" group="tag.door_03" locked="true"/>

                <add_actor_to_room actor="player.entity" object="$CRB_Prison_Room">
                  <position x="2.75" y="player.entity.race.height" z="-7.73"/>
                  <rotation yaw="90deg" pitch="-45deg" comment="look down sadly"/>
                </add_actor_to_room>
                <destroy_object object="$FuneralCoffinShip" explosion="false"/>
                <destroy_object object="$Balaur_Patrol"     explosion="false"/>

                <!-- position in the throneroom -->
                <create_position name="$CurbPos" x="-0.09" z="-10.75"/>
                <create_rotation name="$CurbRot" yaw="0.0deg"/>
                <create_position name="$OutcastPos" x="1.5" z="-11.25"/>
                <create_rotation name="$OutcastRot" yaw="-30.0deg" />
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $CurbActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $ThroneRoom_Room,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $CurbRot,
                                                                                                      $position = $CurbPos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $ThroneRoom_Room,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $OutcastRot,
                                                                                                      $position = $OutcastPos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
              </actions>
              <cues>
                <cue name="Ch3_Trials_Move_Curb">
                  <delay exact="3s"/>
                  <actions>

                    <!-- Position in the prison cell -->
                    <create_position name="$OutcastPos" x="1.729" z="-3.456"/>
                    <create_rotation name="$OutcastRot" yaw="-160.0deg" />
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $CRB_Prison_Room,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $OutcastRot,
                                                                                                      $position = $OutcastPos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <create_position name="$CurbPos" x="3.005" z="-4.17"/>
                    <create_rotation name="$CurbRot" yaw="-180.0deg"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $CurbActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $CRB_Prison_Room,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $CurbRot,
                                                                                                      $position = $CurbPos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                  </actions>
                </cue>
                <cue name="Ch3_Trials_Start" checkinterval="1s">
                  <conditions>
                    <check_value value="$CurbActor.distanceto.{player.entity} le 3m"/>
                    <check_value value="$CurbActor.distanceto.{$CurbPos} le 0.2m"/>
                    <check_value value="$CurbActor.room == player.entity.room"/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$CurbActor" updatebriefing="true"/>
                    <signal_cue cue="Ch3_Trials_Prison_Dialog_Start"/>
                  </actions>
                </cue>
                <cue name="Ch3_Trials_Prison_Dialog_Start">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <start_conversation actor="$CurbActor" conversation="Ch3_Trials_Prison" priority="100" missioncue="$MissionCue"/>
                  </actions>
                </cue>
                <cue name="Ch3_Trials_Prison_Dialog" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$CurbActor" />
                      <event_conversation_next_section actor="$CurbActor" section="Ch3_Trials_Prison"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="not event.param2">
                      <cancel_cue cue="Ch3_Trials_Prison_Dialog_Start"/>
                      <do_if value="player.entity.race == race.split">
                        <add_npc_line speaker="$CurbActor" hidechoices="true">
                          <text line="if player.entity.isfemale then 30221311 else 30221310" comment="(angry)Captured Split will explain presence!"/>
                        </add_npc_line>
                      </do_if>
                      <do_else>
                        <add_npc_line speaker="$CurbActor" hidechoices="true">
                          <text line="if player.entity.isfemale then 30221313 else 30221312" comment="(angry)Captured creature will explain presence!"/>
                        </add_npc_line>
                      </do_else>
                      <add_player_choice section="Ch3_Trials_Prison" choiceparam="'ch3_trials_prison_1'" selectable="true" text="{30221,3251}" comment="(Player Choice)I was looking into a court case..."/>
                    </do_if>
                    <do_elseif value="event.param2 == 'ch3_trials_prison_1'">
                      <add_npc_line speaker="$CurbActor" hidechoices="true">
                        <text line="if player.entity.isfemale then 30221315 else 30221314" comment="(angry)Prisoner will explain affiliation to dead Patriarch!"/>
                      </add_npc_line>
                      <add_player_choice section="Ch3_Trials_Prison" choiceparam="'ch3_trials_prison_2a'" selectable="true" text="{30221,3252}" comment="(Player Choice)It was a request by Fau t'Nnt!"/>
                      <add_player_choice section="Ch3_Trials_Prison" choiceparam="'ch3_trials_prison_2b'" selectable="true" text="{30221,3253}" comment="(Player Choice)I wanted more lenience from their police!"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch3_trials_prison_2a'">
                      <add_npc_line speaker="$CurbActor" hidechoices="true">
                        <text line="if player.entity.isfemale then 30221317 else 30221316" comment="(angry)Prisoner will explain affiliation to Fau t'Nnt of Family Nhuut!"/>
                      </add_npc_line>
                      <add_player_choice section="Ch3_Trials_Prison" choiceparam="'ch3_trials_prison_3'" selectable="true" text="{30221,3254}" comment="No ties, just trying to get by!"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch3_trials_prison_2b'">
                      <add_npc_line speaker="$CurbActor" hidechoices="true">
                        <text line="if player.entity.isfemale then 30221319 else 30221318" comment="(angry)Prisoner will explain affiliation to Patriarchy police!"/>
                      </add_npc_line>
                      <add_player_choice section="Ch3_Trials_Prison" choiceparam="'ch3_trials_prison_3'" selectable="true" text="{30221,3254}" comment="No ties, just trying to get by!"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch3_trials_prison_3'">
                      <add_npc_line speaker="$CurbActor" hidechoices="true">
                        <text line="if player.entity.isfemale then 30221321 else 30221320" comment="Another victim of patriarchy oppression."/>
                        <text line="if player.entity.isfemale then 30221323 else 30221322" comment="Stowaway came to right place."/>
                        <text line="30221324" comment="We strive for Split freedom."/>
                        <text line="if player.entity.isfemale then 30221326 else 30221325" comment="How prisoner know to come here?"/>
                      </add_npc_line>
                      <add_player_choice section="Ch3_Trials_Prison" choiceparam="'ch3_trials_prison_4'" selectable="true" text="{30221,3255}" comment="I traced funds to the Funeral Service."/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch3_trials_prison_4'">
                      <add_npc_line speaker="$CurbActor" hidechoices="true">
                        <text line="30221327" comment="Where?" delay="0.5s"/>
                      </add_npc_line>
                      <add_player_choice section="Ch3_Trials_Prison" choiceparam="'ch3_trials_prison_5'" selectable="true" text="{30221,3256}" comment="At the Trading Station, but I deleted them!"/>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch3_trials_prison_5'">
                      <add_npc_line speaker="$CurbActor" hidechoices="true">
                        <text line="30280001" comment="Impressive work."/>
                        <text line="30221328" comment="Very well." delay="2s"/>
                        <text line="if player.entity.isfemale then 30221330 else 30221329" comment="Guest seems more curious than hostile."/>
                      </add_npc_line>
                    </do_elseif>
                  </actions>
                </cue>
                <cue name="Ch3_Trials_Prison_Dialog_End">
                  <conditions>
                    <event_conversation_finished actor="$CurbActor" outcomeparam="'ch3_trials_prison_5'"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch3_Trials_Prison_Dialog"/>
                    <set_triggers_locked object="$CRB_Prison_Room" group="tag.door_01" locked="false"/>
                    <!-- Open the cell and move the NPCs to the throneroom for further dialogs -->

                    <create_position name="$CurbPos" x="-0.09" z="-10.75"/>
                    <create_rotation name="$CurbRot" yaw="0.0deg"/>
                    <create_position name="$OutcastPos" x="1.5" z="-11.25"/>
                    <create_rotation name="$OutcastRot" yaw="-30.0deg" />
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $CurbActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $ThroneRoom_Room,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $CurbRot,
                                                                                                      $position = $CurbPos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $ThroneRoom_Room,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $OutcastRot,
                                                                                                      $position = $OutcastPos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <set_value name="$DalBustaLines" exact="[]"/>
                    <set_value name="$BosoTaLines" exact="[]"/>
                    <append_to_list name="$DalBustaLines" exact="[30221940]" comment="That went rather well."/>
                    <do_if value="player.entity.race == race.split">
                      <append_to_list name="$DalBustaLines" exact="[if player.entity.isfemale then 30221943 else 30221944]" comment="They aren't allowing you to leave yet, but being promoted from prisoner to guest is a good sign."/>
                      <append_to_list name="$BosoTaLines" exact="[if player.entity.isfemale then 30221326 else 30221325]" comment="Indeed, well done, assistant!"/>
                    </do_if>
                    <do_else>
                      <append_to_list name="$DalBustaLines" exact="[if player.entity.isfemale then 30221942 else 30221941]" comment="They aren't allowing you to leave yet, but being promoted from creature to guest is a good sign."/>
                      <append_to_list name="$BosoTaLines" exact="[if player.entity.isfemale then 30221324 else 30221323]" comment="Indeed, well done, creature! Er, I mean, assistant."/>
                    </do_else>
                    <debug_text text="'Dal Lines: ' + $DalBustaLines + ' Boso Lines: ' + $BosoTaLines"/>
                  </actions>
                  <cues>
                    <cue name="Ch3_Speak_Dal_and_Boso_Prison_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$DalBusta, $BosoTa, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$Dal2CutsceneKey, $BosoCutsceneKey, $Dal2CutsceneKey]"/>
                      <param name="Lines"             value="[$DalBustaLines, $BosoTaLines, [[if player.entity.isfemale then 30221953 else 30221952]]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[null, Ch3_Open_Prison_Door, null]"/>
                      <!--
                        <speak actor="$DalBusta" priority="100" comment="Plot relevant">
                          <text line="if player.entity.isfemale then 30221953 else 30221952" comment="We'll need to discuss which side we're on, but for now at least act like you want to join their cause in order to regain your freedom."/>
                        </speak>-->
                    </cue>

                    <cue name="Ch3_Open_Prison_Door">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <activate_platform_trigger room="$CRB_Prison_Room" group="tag.door_01" result="this.$platform_result"/>
                        <create_position name="$ThroneRoom_DoorPos" x="-0.3" y="1.6" z="11.3"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <do_if value="$platform_result? and (not parent.$platform_result)">
                          <activate_platform_trigger room="$CRB_Prison_Room" group="tag.door_01" result="parent.$platform_result"/>
                          <reset_cue cue="this"/>
                        </do_if>
                      </actions>
                    </cue>
                    <cue name="Ch3_Trials_Curb_Arrived_In_Throneroom" checkinterval="1s">
                      <conditions>
                        <check_value value="$CurbActor.distanceto.{$CurbPos} le 1m"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch3_Trials_Throneroom"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_Trials_ThroneroomCutscene" checkinterval="1ms">
                      <conditions>
                        <check_all>
                          <check_value value="player.entity.hascontext.{$ThroneRoom_Interior}"/>
                          <check_value value="player.entity.distanceto.[$ThroneRoom_Room, $ThroneRoom_DoorPos] le 1.65m"/>
                        </check_all>
                      </conditions>
                      <actions>
                        <play_music music="'music_story_split_throneroom'"/>
                        <set_value name="$CutsceneKey" exact="'story_split_curb_throneroom_reveal'"/>
                        <play_cutscene key="$CutsceneKey" result="this.$CutsceneID" abortable="true">
                          <param name="targetobject"      object="$CurbActor"/>
                          <param name="orbitdist"         number="0"/>
                          <param name="orbitelevation"    number="0"/>
                        </play_cutscene>
                      </actions>
                      <cues>
                        <cue name="Ch3_Trials_ThroneroomCutscene_Stop">
                          <conditions>
                            <event_cutscene_started cutscene="parent.$CutsceneID"/>
                          </conditions>
                          <delay exact="17s"/>
                          <actions>
                            <stop_cutscene cutscene="parent.$CutsceneID"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch3_Trials_Throneroom">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$CurbActor" updatebriefing="true"/>
                    <set_value name="$ShowPlayerChoices" exact="''"/>
                    <set_value name="$Ch3TrialsWorth" exact="0" comment="+1 on insult which increses the cost"/>

                    <set_value name="$Ch3_Trials_Policehunt" exact="false"/>
                    <set_value name="$Ch3_Trials_Worthy" exact="false"/>
                    <set_value name="$Ch3_Trials_Dedicated" exact="false"/>

                    <set_value name="$PlayerInformed" exact="false"/>
                  </actions>
                  <cues>
                    <cue name="Ch3_Remove_Outcast">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Separatist Officer -->
                        <set_entity_overrides entity="$OutcastActor" icon="'defenceofficer'" title="'{30221,157}'"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                         param="['add_definition', $OutcastActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = 'disconnect',
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>

                      </actions>
                    </cue>

                    <cue name="Ch3_Trials_Throneroom_Dialog" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_started actor="$CurbActor"/>
                          <event_conversation_next_section actor="$CurbActor" section="Ch3_Trials_Throneroom"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="event.name == 'event_conversation_started'">
                          <add_npc_line speaker="$CurbActor" hidechoices="true">
                            <text line="30221328" comment="Very well."/>
                          </add_npc_line>
                          <set_value name="$ShowPlayerChoices" exact="'ch3_0_topics'"/>
                        </do_if>
                        <do_elseif value="event.param2 == 'ch3_0_topics'">
                          <set_value name="$ShowPlayerChoices" exact="'ch3_0_topics'"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_3_prove'">
                          <set_value name="$ShowPlayerChoices" exact="'ch3_3_prove'"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_trials_court_1'">
                          <add_npc_line speaker="$CurbActor" hidechoices="true">
                            <text line="30221331" comment="We eliminate criminals."/>
                            <text line="30221332" comment="Loyalists who welcome Patriarchy have no place here."/>
                          </add_npc_line>
                          <set_value name="$PlayerInformed" exact="true"/>
                          <set_value name="$ShowPlayerChoices" exact="'ch3_0_topics'"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_trials_court_2'">
                          <add_npc_line speaker="$CurbActor" hidechoices="true">
                            <text line="30221333" comment="Separatist families are still uniting against Patriarchy Oppression."/>
                          </add_npc_line>
                          <set_value name="$PlayerInformed" exact="true"/>
                          <set_value name="$ShowPlayerChoices" exact="'ch3_0_topics'"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_trials_court_3'">
                          <add_npc_line speaker="$CurbActor" hidechoices="true">
                            <text line="if player.entity.isfemale then 30221335 else 30221334" comment="Guest shall prove worth and dedication."/>
                          </add_npc_line>
                          <do_if value="$AffiliationFF and not $OutcastSaid.indexof.{30221323}">
                            <add_npc_line speaker="$OutcastActor" hidechoices="true">
                              <text line="if player.entity.isfemale then 30221324 else 30221323" comment="Guest survived Fires. Good pilot."/>
                            </add_npc_line>
                            <append_to_list name="$OutcastSaid" exact="30221323"/>
                            <!-- No "lower burden" mechanic implemented
                            <add_npc_line speaker="$CurbActor" hidechoices="true">
                              <text line="30221336" comment="This shall lower burden."/>
                            </add_npc_line>-->
                          </do_if>
                          <set_value name="$ShowPlayerChoices" exact="'ch3_3_prove'"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_trials_court_3_1'">
                          <add_npc_line speaker="$CurbActor" hidechoices="true">
                            <text line="30221337" comment="Monetarily"/>
                          </add_npc_line>
                          <do_if value="$Ch3TrialsWorth lt 1">
                            <set_value name="$ShowPlayerChoices" exact="'ch3_3_worth_1'"/>
                          </do_if>
                          <do_elseif value="$Ch3TrialsWorth == 1">
                            <set_value name="$ShowPlayerChoices" exact="'ch3_3_worth_2'"/>
                          </do_elseif>
                          <do_elseif value="$Ch3TrialsWorth gt 1">
                            <set_value name="$ShowPlayerChoices" exact="'ch3_3_worth_3'"/>
                          </do_elseif>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_trials_court_3_1_insult'">
                          <add_npc_line speaker="$CurbActor" hidechoices="true">
                            <text line="30221341" comment="This insult!"/>
                            <text line="30221339" comment="This shall raise burden."/>
                          </add_npc_line>
                          <set_value name="$Ch3TrialsWorth" exact="1" operation="add"/>
                          <do_if value="$Ch3TrialsWorth lt 1">
                            <set_value name="$ShowPlayerChoices" exact="'ch3_3_worth_1'"/>
                          </do_if>
                          <do_elseif value="$Ch3TrialsWorth == 1">
                            <set_value name="$ShowPlayerChoices" exact="'ch3_3_worth_2'"/>
                          </do_elseif>
                          <do_elseif value="$Ch3TrialsWorth gt 1">
                            <set_value name="$ShowPlayerChoices" exact="'ch3_3_worth_3'"/>
                          </do_elseif>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_trials_court_3_1_symbolic'">
                          <add_npc_line speaker="$CurbActor" hidechoices="true">
                            <text line="30221342" comment="This symbolic."/>
                            <text line="30221338" comment="Worth now proven."/>
                          </add_npc_line>
                          <transfer_money from="faction.player" to="faction.freesplit" amount="$WorthSymbolic"/>
                          <set_value name="$Ch3_Trials_Worthy" exact="true"/>
                          <signal_cue cue="Ch3_Trials_Completed_Check"/>
                          <set_value name="$ShowPlayerChoices" exact="'ch3_3_worth'"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_trials_court_3_1_agreed'">
                          <add_npc_line speaker="$CurbActor" hidechoices="true">
                            <text line="30221340" comment="Agreed."/>
                            <text line="30221338" comment="Worth now proven."/>
                          </add_npc_line>
                          <transfer_money from="faction.player" to="faction.freesplit" amount="$WorthAgreed"/>
                          <set_value name="$Ch3_Trials_Worthy" exact="true"/>
                          <signal_cue cue="Ch3_Trials_Completed_Check"/>
                          <set_value name="$ShowPlayerChoices" exact="'ch3_3_worth'"/>
                          <set_value name="$CurbRelationBonus" exact="1" operation="add"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_trials_court_3_2'">
                          <add_npc_line speaker="$CurbActor" hidechoices="true">
                            <text line="30221343" comment="Rise against Patriarchy and fight oppression."/>
                            <text line="if player.entity.isfemale then 30221349 else 30221348" comment="Guest granted access here, to return with report."/>
                          </add_npc_line>
                          <do_if value="Ch3_Remove_Outcast.state == cuestate.waiting">
                            <signal_cue cue="Ch3_Remove_Outcast"/>
                          </do_if>
                          <do_if value="not $Ch3_Trials_Policehunt">
                            <set_object_active object="$FuneralGate" activate="true"/>
                            <set_value name="player.entity.$x4ep1_teleporter_malfunctioning" exact="false"/>
                            <set_value name="$Ch3_Trials_Policehunt" exact="true"/>
                            <signal_cue cue="Ch3_Police_Hunt"/>
                          </do_if>
                        </do_elseif>

                        <do_if value="$ShowPlayerChoices == 'ch3_0_topics'">
                          <add_player_choice section="g_cancel" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_1'" selectable="true" highlighted="false"
                                             text="{30221,3257}" comment="(Player Choice)Why did you frame the Patriarch?"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_2'" selectable="true" highlighted="false"
                                             text="{30221,3258}" comment="(Player Choice)The separatist Patriarchs are uniting?"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3'"
                                             text="{30221,3259}" comment="(Player Choice)I want to join your cause. / Acquire enough information."
                                             selectable="$PlayerInformed" highlighted="$PlayerInformed"
                                             tooltip="if $PlayerInformed then '' else {30221,1162}"/>
                        </do_if>
                        <do_elseif value="$ShowPlayerChoices == 'ch3_3_prove'">
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_0_topics'" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1'"
                                             selectable="not $Ch3_Trials_Worthy"
                                             tooltip="if $Ch3_Trials_Worthy then (if player.entity.isfemale then {30221,3291} else {30221,3290}) else ''"
                                             text="{30221,3260}" comment="(Player Choice)How do I prove my worth?"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_2'"
                                             selectable="not $Ch3_Trials_Dedicated"
                                             tooltip="if $Ch3_Trials_Dedicated then (if player.entity.isfemale then {30221,3293} else {30221,3292}) else ''"
                                             text="{30221,3261}" comment="(Player Choice)How do I prove my dedication?"/>
                        </do_elseif>
                        <do_elseif value="$ShowPlayerChoices == 'ch3_3_worth_1'">
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_3_prove'" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                          <!-- Choice 1-->
                          <set_value name="$Cr_Amount" exact="(250 * 1000)"/>
                          <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                            <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                          </substitute_text>
                          <set_value name="$PlayerHasMoney_250k" exact="player.money ge ($Cr_Amount)Cr"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1_insult'"
                                             text="$OfferCredits" comment="Offer Cr"
                                             selectable="$PlayerHasMoney_250k"
                                             tooltip="if $PlayerHasMoney_250k then '' else {30221,3271}"/>

                          <!-- Choice 2-->
                          <set_value name="$Cr_Amount" exact="(500 * 1000)"/>
                          <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                            <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                          </substitute_text>
                          <set_value name="$PlayerHasMoney_500k" exact="player.money ge ($Cr_Amount)Cr"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1_insult'"
                                             text="$OfferCredits" comment="Offer Cr"
                                             selectable="$PlayerHasMoney_500k"
                                             tooltip="if $PlayerHasMoney_500k then '' else {30221,3271}"/>

                          <!-- Choice 3-->
                          <set_value name="$Cr_Amount" exact="(1 * 1000 * 1000)"/>
                          <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                            <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                          </substitute_text>
                          <set_value name="$WorthSymbolic" exact="($Cr_Amount)Cr"/>
                          <set_value name="$PlayerHasMoney_WorthSymbolic" exact="player.money ge $WorthSymbolic"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1_symbolic'"
                                             text="$OfferCredits" comment="Offer Cr"
                                             selectable="$PlayerHasMoney_WorthSymbolic"
                                             tooltip="if $PlayerHasMoney_WorthSymbolic then '' else {30221,3271}"/>

                          <!-- Choice 4-->
                          <set_value name="$Cr_Amount" exact="(20 * 1000 * 1000)"/>
                          <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                            <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                          </substitute_text>
                          <set_value name="$WorthAgreed" exact="($Cr_Amount)Cr"/>
                          <set_value name="$PlayerHasMoney_WorthAgreed" exact="player.money ge $WorthAgreed"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1_agreed'"
                                             text="$OfferCredits" comment="Offer Cr"
                                             selectable="$PlayerHasMoney_WorthAgreed"
                                             tooltip="if $PlayerHasMoney_WorthAgreed then '' else {30221,3271}"/>
                        </do_elseif>
                        <do_elseif value="$ShowPlayerChoices == 'ch3_3_worth_2'">
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_3_prove'" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                          <!-- Choice 1-->
                          <set_value name="$Cr_Amount" exact="(750 * 1000)"/>
                          <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                            <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                          </substitute_text>
                          <set_value name="$PlayerHasMoney_750k" exact="player.money ge ($Cr_Amount)Cr"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1_insult'"
                                             text="$OfferCredits" comment="Offer Cr"
                                             selectable="$PlayerHasMoney_750k"
                                             tooltip="if $PlayerHasMoney_750k then '' else {30221,3271}"/>
                          <!-- Choice 2-->
                          <set_value name="$Cr_Amount" exact="(1.5 * 1000 * 1000)"/>
                          <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                            <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                          </substitute_text>
                          <set_value name="$WorthSymbolic" exact="($Cr_Amount)Cr"/>
                          <set_value name="$PlayerHasMoney_WorthSymbolic" exact="player.money ge $WorthSymbolic"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1_symbolic'"
                                             text="$OfferCredits" comment="Offer Cr"
                                             selectable="$PlayerHasMoney_WorthSymbolic"
                                             tooltip="if $PlayerHasMoney_WorthSymbolic then '' else {30221,3271}"/>
                          <!-- Choice 3-->
                          <set_value name="$Cr_Amount" exact="(20 * 1000 * 1000)"/>
                          <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                            <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                          </substitute_text>
                          <set_value name="$WorthAgreed" exact="($Cr_Amount)Cr"/>
                          <set_value name="$PlayerHasMoney_WorthAgreed" exact="player.money ge $WorthAgreed"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1_agreed'"
                                             text="$OfferCredits" comment="Offer Cr"
                                             selectable="$PlayerHasMoney_WorthAgreed"
                                             tooltip="if $PlayerHasMoney_WorthAgreed then '' else {30221,3271}"/>
                        </do_elseif>
                        <do_elseif value="$ShowPlayerChoices == 'ch3_3_worth_3'">
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_3_prove'" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                          <!-- Choice 1-->
                          <set_value name="$Cr_Amount" exact="(2 * 1000 * 1000)"/>
                          <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                            <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                          </substitute_text>
                          <set_value name="$WorthSymbolic" exact="($Cr_Amount)Cr"/>
                          <set_value name="$PlayerHasMoney_WorthSymbolic" exact="player.money ge $WorthSymbolic"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1_symbolic'"
                                             text="$OfferCredits" comment="Offer Cr"
                                             selectable="$PlayerHasMoney_WorthSymbolic"
                                             tooltip="if $PlayerHasMoney_WorthSymbolic then '' else {30221,3271}"/>
                          <!-- Choice 2-->
                          <set_value name="$Cr_Amount" exact="(20 * 1000 * 1000)"/>
                          <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                            <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                          </substitute_text>
                          <set_value name="$WorthAgreed" exact="($Cr_Amount)Cr"/>
                          <set_value name="$PlayerHasMoney_WorthAgreed" exact="player.money ge $WorthAgreed"/>
                          <add_player_choice section="Ch3_Trials_Throneroom" choiceparam="'ch3_trials_court_3_1_agreed'"
                                             text="$OfferCredits" comment="Offer Cr"
                                             selectable="$PlayerHasMoney_WorthAgreed"
                                             tooltip="if $PlayerHasMoney_WorthAgreed then '' else {30221,3271}"/>
                        </do_elseif>

                        <!--
                         Outcast Lines:
                         <t id="30221325">Guest fought Patriarchy Police.</t>
                         <t id="30221326">(spoken to female 'Guest'){,30221325}</t>
                         <t id="30221327">Patriarchy stations fell under guest's command.</t>
                         <t id="30221328">(spoken about female 'guest'){,30221327}</t>                           
                         -->
                      </actions>
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch3_Police_Hunt" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_dockingbay name="$BoneyardDock" object="$BoneyardCarrier" checkoperational="true" multiple="false">
                      <match_dock size="tag.dock_s" storage="true"/>
                    </find_dockingbay>

                    <create_loadout result="$loadout" comment="Courier Tuatara Loadout">
                      <macros>
                        <engine macro="engine_spl_s_combat_01_mk3_macro"    path="../con_engine_01" />
                        <engine macro="engine_spl_s_combat_01_mk3_macro"    path="../con_engine_02" />
                        <engine macro="engine_spl_s_combat_01_mk3_macro"    path="../con_engine_03" />
                        <weapon macro="weapon_gen_s_laser_01_mk1_macro"     path="../con_weapon_01"/>
                      </macros>
                      <virtualmacros>
                        <thruster macro="thruster_gen_s_combat_01_mk3_macro" />
                      </virtualmacros>
                    </create_loadout>

                    <create_ship name="$NewPlayerShip"
                                 macro="ship_spl_s_trans_container_01_a_macro"
                                 dock="$BoneyardDock">
                      <owner exact="$BoneyardDock.owner" comment="pitfall: needs to be dock owner to not fail if player is not at docking relations"/>
                      <loadout loadout="$loadout"/>
                      <people>
                        <fillpercent exact="0"/>
                      </people>
                      <!-- paintmod 6 is the player starting paintmod @Heinrich TODO PAintMods / Can I give the player another one or would he 'have' it? -->
                      <paint ware="$PaintMod_FuneralCoffinShip"/>
                    </create_ship>
                    <set_owner object="$NewPlayerShip" faction="faction.player" comment="pitfall: needs to be done after creation to avoid spawn failure cases due to relations"/>

                    <create_ship name="$ColonialPolice" sector="$HeartOfAcrimonySector" capturable="false" missioncue="namespace" macro="ship_spl_m_frigate_01_a_macro">
                      <owner exact="faction.split"/>
                      <loadout>
                        <level exact="0.7"/>
                      </loadout>
                      <owner exact="faction.split" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.split" tags="tag.fighterpilot"/>
                      </pilot>
                    </create_ship>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <signal_cue cue="Ch3_Police_Snitch"/>
                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.kill" object="$ColonialPolice" updatebriefing="true"/>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="null == $NewPlayerShip">
                      <set_value name="$PATCH_CreateShip_NewPlayerShip"/>
                      <create_ship name="$NewPlayerShip"
                        macro="ship_spl_s_trans_container_01_a_macro"
                        dock="$BoneyardDock">
                        <owner exact="$BoneyardDock.owner" comment="pitfall: needs to be dock owner to not fail if player is not at docking relations"/>
                        <loadout loadout="$loadout"/>
                        <people>
                          <fillpercent exact="0"/>
                        </people>
                        <!-- paintmod 6 is the player starting paintmod @Heinrich TODO PAintMods / Can I give the player another one or would he 'have' it? -->
                        <paint ware="$PaintMod_FuneralCoffinShip"/>
                      </create_ship>
                      <set_owner object="$NewPlayerShip" faction="faction.player" comment="pitfall: needs to be done after creation to avoid spawn failure cases due to relations"/>
                    </do_if>
                  </patch>
                  <cues>
                    <cue name="Ch3_Police_Hunt_Done" version="2">
                      <conditions>
                        <check_any>
                          <event_object_destroyed object="$ColonialPolice" comment="ship destroyed"/>
                          <event_object_abandoned object="$ColonialPolice" comment="or pilot ejected (which we also accept)"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <add_faction_relation faction="faction.player" otherfaction="faction.freesplit" value="0.0016" reason="relationchangereason.missioncompleted"/>
                        <set_value name="$Ch3_Trials_Dedicated" exact="true"/>
                        <do_if value="not $Ch3_Trials_Worthy">
                          <set_value name="$CurrentStep" exact="1" operation="add"/>
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30221,3220}" object="$CurbActor" updatebriefing="true" comment="Prove your Worth"/>
                        </do_if>
                        <signal_cue cue="Ch3_Trials_Completed_Check"/>
                      </actions>
                      <patch sinceversion="2">
                        <do_if value="$Ch3_Trials_Dedicated and not $Ch3_Trials_Worthy">
                          <set_value name="$Patch_Mantis113_WrongObjective"/>
                          <!--  update the objective, if we're here it should be the correct one regardless.
                                worst case we update it unnecessarily to the same as before-->
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30221,3220}" object="$CurbActor" updatebriefing="true" comment="Prove your Worth"/>
                        </do_if>
                      </patch>
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch3_Trials_Completed_Check" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="$Ch3_Trials_Worthy"/>
                    <check_value value="$Ch3_Trials_Dedicated"/>
                  </conditions>
                  <delay exact="10s"/>
                  <actions>
                    <set_value name="$Ch3b_RemoveMissionLater" comment="running mission required for npc call mission"/>
                    <!--<remove_mission cue="$MissionCue" type="completed"/>
                    <set_value name="$Description" exact="if player.entity.isfemale then {30221,3212} else {30221,3211}"/>
                    <do_if value="@$WarnedLoyalist">
                      <set_value name="$Description" exact="$Description + '\n\n' + (if player.entity.isfemale then {30221,3214} else {30221,3213})"/>
                    </do_if>
                    <write_to_logbook category="missions" faction="faction.player" title="{30221,3201}" text="$Description"/>-->

                    <do_if value="player.entity.room == $CurbActor.room">
                      <cancel_cue cue="Ch3_Trials_Throneroom_Dialog"/>
                      <start_conversation actor="$CurbActor" conversation="Ch3_Trials_Done" priority="100" missioncue="if $Ch3b_RemoveMissionLater? then $MissionCue else null"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch3_Trials_Completed_Call"/>
                    </do_else>
                  </actions>
                </cue>
                <cue name="Ch3_Trials_Completed_Conversation">
                  <conditions>
                    <event_conversation_started actor="$CurbActor" conversation="Ch3_Trials_Done"/>
                  </conditions>
                  <actions>
                    <add_npc_line speaker="$CurbActor" hidechoices="true">
                      <text line="if player.entity.isfemale then 30221347 else 30221346" comment="Guest is dedicated and worthy."/>
                      <text line="if player.entity.isfemale then 30221351 else 30221350" comment="Novice will meet Slave Trader."/>
                      <text line="30221352" comment="Much work to be done."/>
                    </add_npc_line>
                  </actions>
                  <cues>
                    <cue name="Ch3_Trials_Completed_Conversation_Done">
                      <conditions>
                        <event_conversation_finished actor="$CurbActor"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch4_Collaborate"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch3_Trials_Completed_Call">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch3_Trials_Throneroom_Dialog"/>
                  </actions>
                  <cues>
                    <cue name="Ch3_Trials_Completed_Call_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$CurbActor"/>
                      <param name="CutsceneKey"       value="$CurbCutsceneKey"/>
                      <param name="Lines"             value="[ [if player.entity.isfemale then 30221347 else 30221346], [if player.entity.isfemale then 30221351 else 30221350], [30221352] ]"/>
                      <param name="MissionCue"        value="if $Ch3b_RemoveMissionLater? then $MissionCue else null"/>
                      <param name="IsInMission"       value="$Ch3b_RemoveMissionLater?"/>
                      <param name="EndSignalCue"      value="Ch4_Collaborate"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>


            <cue name="Ch3_Police_Snitch">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- Do not remove this opportunity even after Ch3 is complete, as "Dal can set up a meeting with Zyarh police" is part of the Ch4 Mission Briefing ! (Maybe move between Ch3 and Ch4, rename cue for save game reasons) -->
              <actions>
              </actions>
              <cues>
                <cue name="Ch3_Dal_370_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                  <param name="Lines"             value="[
                                [30221945],
                                [30221946],
                                [30221370, 2s],
                                [if player.entity.isfemale then 30221372 else 30221371],
                                [30221373],
                                [if player.entity.isfemale then 30221948 else 30221947],
                                [if player.entity.isfemale then 30221375 else 30221374]
                      ]"/>
                  <!--                
                  <t id="30221	945	">	We found the hideout of a Free Families separatist movement!
                  <t id="30221	946	">	Knowing that Patriarch Tkr is involved, I will try to identify his allies in this undertaking.       
                  <t id="30221370">Well, I do have a contact working for the Patriarchy Police.</t>
                  <t id="30221371">If you're interested in warning them about the budding rebellion, I think I can arrange a meeting.</t>
                  <t id="30221372">(spoken to female 'you'){,30221371}</t>
                  <t id="30221373">With the financial records from the court case, we hold some pretty damning evidence about the conspiracy.</t>
                  <t id="30221	947	">	Meet me on the Funeral Service Ship if you want me to arrange a meeting with the Patriarchy Police.
                  <t id="30221	948	">	(spoken to female 'you'){,30221947}
                  <t id="30221374">If you're not interested, there is probably some benefit to be gained from working our way up within the rebellion to get a sense of its scope.</t>
                  <t id="30221375">(spoken to female 'you'){,30221374}</t>-->
                  <param name="MissionCue"        value="if $Ch3b_RemoveMissionLater? then $MissionCue else null"/>
                  <param name="IsInMission"       value="$Ch3b_RemoveMissionLater?"/>
                  <param name="EndSignalCue"    value="Ch3_Conv_Dal"/>
                </cue>

                <cue name="Ch3_Conv_Dal">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch3_Conversation_Dal_Warn" instantiate="true">
                      <conditions>
                        <event_conversation_next_section section="story_split"/>
                        <check_value value="event.object == $DalBusta"/>
                      </conditions>
                      <actions>
                        <do_if value="event.param2 == null">
                          <add_npc_line speaker="$DalBusta" hidechoices="true">
                            <text line="if player.entity.isfemale then 30221950 else 30221949" comment="Do you want to inform Patriarchy Forces about this separatist movement?"/>
                          </add_npc_line>
                          <add_player_choice section="story_split" choiceparam="''" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                          <add_player_choice section="story_split" choiceparam="'ch3_warn_police'" selectable="true" text="{30220,1105}" comment="What do I need to do?"/>
                        </do_if>
                        <do_elseif value="event.param2 == 'ch3_warn_police'">
                          <add_npc_line speaker="$DalBusta" hidechoices="true">
                            <text line="30221951" comment="I'll set up a meeting with my contact.(male contact)"/>
                            <text line="if player.entity.isfemale then 30221136 else 30221135" comment="I will update you on his position as soon as I know more."/>
                          </add_npc_line>
                          <signal_cue cue="Ch3_Snitch_Dal_Contact"/>
                          <cancel_cue cue="parent"/>
                        </do_elseif>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_Snitch_Dal_Contact" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="5s"/>
                  <actions>
                    <signal_cue cue="Ch3_Conv_Loyalist"/>
                    <signal_cue cue="Ch4_Move_Dal"/>
                  </actions>
                  <patch sinceversion="2">
                    <signal_cue cue="Ch4_Move_Dal"/>
                  </patch>
                </cue>

                <cue name="Ch3_Conv_Loyalist">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$LoyalistActorCurrentName" exact="$LoyalistActorFakeNames.random"/>
                    <remove_from_list name="$LoyalistActorFakeNames" exact="$LoyalistActorCurrentName"/>
                    <set_object_name object="$LoyalistActor" page="30221" line="$LoyalistActorCurrentName"/>
                  </actions>
                  <cues>
                    <cue name="Ch3_Warn_Station">
                      <actions>
                        <find_station name="$MeetStation" space="player.galaxy" sortbygatedistanceto="player.entity">
                          <match_dock walkable="true"/>
                          <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                        </find_station>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $LoyalistActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $MeetStation,
                                                                                                      $slottags = [tag.npc_generic],
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                        <do_if value="$Ch3_Trials_Dedicated">
                          <set_value name="$CurrentStep" exact="1" operation="add"/>
                        </do_if>
                        <do_if value="$ColonialPolice.exists and (Ch3_Police_Hunt_Done.state == cuestate.waiting)">
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$LoyalistActor" updatebriefing="true"/>
                          <signal_cue_instantly cue="md.GenericMissions.DisconnectedActorObjectiveLibrary" param="table[
                                              $actor = $LoyalistActor,
                                              $object = $MeetStation,
                                              $missioncue = $MissionCue,
                                              $cancelcue = Ch3_Cancel_Loyalist_Meetstation_Placement,
                                              $libfailedcue = null,
                                              $step = $CurrentStep,
                                              $objective = objective.talkto,
                                              $debugchance = $DebugChance]"/>
                        </do_if>
                      </actions>
                      <cues>
                        <cue name="Ch3_Warn_Station_Guard">
                          <conditions>
                            <event_object_destroyed object="$MeetStation"/>
                          </conditions>
                          <actions>
                            <reset_cue cue="parent"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch3_Conversation_Loyalist_Warn" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_started actor="$LoyalistActor"/>
                          <event_conversation_next_section actor="$LoyalistActor"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <do_if value="event.name == 'event_conversation_started'">
                          <do_if value="$Achievement_Working_With_Police le 0">
                            <set_value name="$ShowPlayerChoices" exact="'main'"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="if player.entity.isfemale then 30221301 else 30221302" comment="Split heard you have proof."/>
                            </add_npc_line>
                          </do_if>
                          <do_elseif value="$Achievement_Working_With_Police == 1">
                            <set_value name="$ShowPlayerChoices" exact="'trust'"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="if player.entity.isfemale then 30221313 else 30221312" comment="You have new findings?"/>
                            </add_npc_line>
                          </do_elseif>
                          <do_else>
                            <set_value name="$ShowPlayerChoices" exact="'done'"/>
                            <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                              <text line="if player.entity.isfemale then 30221313 else 30221312" comment="You have new findings?"/>
                            </add_npc_line>
                          </do_else>
                        </do_if>
                        <do_elseif value="event.param2 == 'back_out_1'">
                          <set_value name="$ShowPlayerChoices" exact="''"/>
                          <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                            <text line="if player.entity.isfemale then 30221304 else 30221303" comment="(Disappointed)You remain failure."/>
                          </add_npc_line>
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.kill" object="$ColonialPolice" updatebriefing="true"/>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'back_out_2'">
                          <set_value name="$ShowPlayerChoices" exact="''"/>
                          <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                            <text line="if player.entity.isfemale then 30221324 else 30221311" comment="Report all new findings."/>
                          </add_npc_line>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_warn_police'">
                          <set_value name="$Achievement_Working_With_Police" operation="add" exact="1"/>
                          <set_value name="$ShowPlayerChoices" exact="'trust'"/>
                          <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                            <text line="30221305" comment="Split understand."/>
                            <text line="30221306" comment="Patriarch never got paid."/>
                            <text line="30221307" comment="A setup!"/>
                            <text line="if player.entity.isfemale then 30221309 else 30221308" comment="Split not make this connection when sending you."/>
                            <text line="30221310" comment="Good work."/>
                            <text line="if player.entity.isfemale then 30221324 else 30221311" comment="Report all new findings."/>
                          </add_npc_line>
                        </do_elseif>
                        <do_elseif value="event.param2 == 'ch3_police_trust'">
                          <set_value name="$Achievement_Working_With_Police" operation="add" exact="1"/>
                          <set_value name="$ShowPlayerChoices" exact="'done'"/>
                          <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                            <text line="30221314" comment="Impressive."/>
                            <text line="30221315" comment="Police observe terrorist cells and prepare raid."/>
                            <text line="if player.entity.isfemale then 30221317 else 30221316" comment="Split want to hire you to continue investigations."/>
                            <text line="if player.entity.isfemale then 30221319 else 30221318" comment="You work undercover and report their plans."/>
                            <text line="if player.entity.isfemale then 30221321 else 30221320" comment="Patriarchy will reward you greatly."/>
                          </add_npc_line>
                          <signal_cue cue="Ch3_Police_Collaboration"/>
                        </do_elseif>
                        <do_if value="$ShowPlayerChoices == 'main'">
                          <add_player_choice section="story_split" choiceparam="'back_out_1'" selectable="true" text="readtext.{30221}.{5062}" comment="(Player Choice)Actually, it won't hold up in court." position="bottom_right"/>
                          <add_player_choice section="story_split" choiceparam="'ch3_warn_police'" text="{30221,5063}" comment="(Player Choice)I traced the slave transaction funds."/>
                        </do_if>
                        <do_elseif value="$ShowPlayerChoices == 'trust'">
                          <add_player_choice section="story_split" choiceparam="'back_out_2'" selectable="true" text="readtext.{30221}.{5064}" comment="(Player Choice)That's it for now." position="bottom_right"/>
                          <add_player_choice section="story_split" choiceparam="'ch3_police_trust'" text="{30221,5065}" comment="(Player Choice)The conspirers trust me."/>
                        </do_elseif>
                        <do_elseif value="$ShowPlayerChoices == 'done'">
                          <add_player_choice section="story_split" choiceparam="'back_out_2'" selectable="true" text="readtext.{30221}.{5064}" comment="(Player Choice)That's it for now." position="bottom_right"/>
                        </do_elseif>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_Dal_Surprised">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch3_Dal_376_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="DelayInitial"      value="9s"/>
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                      <param name="Lines"             value="[
                                                            [30221376],
                                                            [30221377],
                                                            [30221378]
                                                         ]"/>
                      <param name="MissionCue"        value="if $Ch3b_RemoveMissionLater? then $MissionCue else null"/>
                      <param name="IsInMission"       value="$Ch3b_RemoveMissionLater?"/>
                      <!-- DAL POLICE:                  
                        <t id="30221376">Sorry for that little surprise. I didn't know he was the contact.</t>
                        <t id="30221377">So now we've made friends with both sides.</t>
                        <t id="30221378">As soon as we know what exactly it is that they are aiming to achieve, and how likely it is to happen, we'll be able to chose a side.</t>       
                         -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch3_Cancel_Loyalist_Meetstation_Placement">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                                      param="['add_definition', $LoyalistActor, table[
                                                                                         $requestercue = $MissionCue,
                                                                                         $priority = 100,
                                                                                         $location = 'disconnect',
                                                                                         $slottags = [tag.stand],
                                                                                         $debugchance = $DebugChance,
                                                                                         $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                  </actions>
                </cue>

                <cue name="Ch3_Police_Collaboration">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="10s"/>
                  <actions>
                    <set_value name="$ZyarthRelationBonus" exact="1" operation="add"/>
                    <signal_cue cue="Ch3_Dal_Surprised"/>
                  </actions>
                  <cues>
                    <cue name="Ch3_Police_Collaboration_Start">
                      <conditions>
                        <event_conversation_finished actor="$LoyalistActor"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch3_Conv_Loyalist"/>
                        <signal_cue cue="Ch3_Cancel_Loyalist_Meetstation_Placement"/>
                        <set_value name="$WarnedLoyalist" exact="true"/>
                        <do_if value="not $Ch3_Trials_Dedicated">
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30221,3221}" text="$ColonialPolice.knownname" object="$ColonialPolice" updatebriefing="true" comment="Pretend Attacking: "/>
                        </do_if>
                      </actions>
                      <cues>
                        <cue name="Ch3_Police_Collaboration_Distance_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                          <param name="ApproachObject"    value="player.entity"/>
                          <param name="ApproachTarget"    value="$ColonialPolice"/>
                          <param name="ApproachDistance"  value="5km"/>
                          <param name="SuccessSignalCue"  value="Ch3_Police_Collaboration_Pretend"/>
                        </cue>

                        <cue name="Ch3_Police_Collaboration_Pretend">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch3_Police_Collaborate" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$ColonialPolice.assignedpilot"/>
                              <param name="CutsceneKey"       value="table[ $key = 'ShowPilot']"/>
                              <param name="Lines"             value="[
                                                                  [2011],
                                                                  [2010]]"/>
                              <param name="MissionCue"        value="if $Ch3b_RemoveMissionLater? then $MissionCue else null"/>
                              <param name="IsInMission"       value="$Ch3b_RemoveMissionLater?"/>
                              <param name="EndSignalCue"      value="Ch3_Police_Collaborate_Done"/>
                              <!-- 
                            <t id="2010">(Goodbye - over comms)Over and out.</t>
                            <t id="2011">(Goodbye - staff)Glad to have been of assistance.</t> -->
                            </cue>
                            <cue name="Ch3_Police_Collaborate_Done" version="3">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <dismiss_pilot object="$ColonialPolice"/>
                                <eject_npcs object="$ColonialPolice"/>
                                <eject_people object="$ColonialPolice"/>
                                <find_dockingbay name="$DockingBay" object="$ColonialPolice" checkoperational="true" multiple="false">
                                  <match_any>
                                    <match_dock size="tag.dock_xs"/>
                                  </match_any>
                                </find_dockingbay>
                                <create_ship name="$escapePod_a" sector="$ColonialPolice.sector" dock="$DockingBay" macro="ship_gen_xs_escapepod_01_a_macro">
                                  <owner exact="faction.civilian"/>
                                  <loadout>
                                    <level exact="0.7"/>
                                  </loadout>
                                  <owner exact="faction.split" overridenpc="true"/>
                                  <pilot>
                                    <select faction="faction.split" tags="tag.fighterpilot"/>
                                  </pilot>
                                </create_ship>
                                <cancel_all_orders object="$escapePod_a"/>
                                <create_order object="$escapePod_a" id="'MoveDie'"/>
                              </actions>
                              <delay exact="0.5s"/>
                              <actions>
                                <create_ship name="$escapePod" sector="$ColonialPolice.sector" dock="$DockingBay" macro="ship_gen_xs_escapepod_01_a_macro">
                                  <owner exact="faction.civilian"/>
                                  <loadout>
                                    <level exact="0.7"/>
                                  </loadout>
                                  <owner exact="faction.split" overridenpc="true"/>
                                  <pilot>
                                    <select faction="faction.split" tags="tag.fighterpilot"/>
                                  </pilot>
                                </create_ship>
                                <cancel_all_orders object="$escapePod"/>
                                <create_order object="$escapePod" id="'MoveDie'"/>
                              </actions>
                              <delay exact="1.4s"/>
                              <actions>
                                <destroy_object object="$ColonialPolice" explosion="true"/>
                              </actions>
                              <patch sinceversion="2">
                                <cancel_all_orders object="$escapePod"/>
                                <create_order object="$escapePod" id="'MoveDie'"/>
                              </patch>
                              <patch sinceversion="3" state="complete">
                                <set_value name="$Patch_For_EscapePod_Required"/>
                              </patch>
                              <patch sinceversion="3" state="cancelled">
                                <set_value name="$Patch_For_EscapePod_Required"/>
                              </patch>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="PATCH_EscapePod_Cleanup">
          <!-- Cleans up the 2nd mission created $escapePod
               Checks the sector regularly (61s) until it only finds 1 escape pod left and cleans it up
               Is done when there is no split owned EscapePod in this sector
               Might also clean up generic escape pods
          -->
          <delay exact="if $Delay_EscapePodCleanup? then $Delay_EscapePodCleanup else 0s"/>
          <actions>
            <do_if value="$Patch_For_EscapePod_Required?">
              <find_ship name="$EscapePods" space="$HeartOfAcrimonySector" macro="macro.ship_gen_xs_escapepod_01_a_macro" multiple="true" owner="faction.split"/>
              <do_if value="$EscapePods.count le 0">
                <debug_text text="'No Escape Pods found, aborting Cleanup'" chance="$DebugChance"/>
              </do_if>
              <do_elseif value="$EscapePods.count == 1">
                <debug_text text="'Cleaning up Ch3 Escape Pod'" chance="$DebugChance"/>

                <cancel_all_orders object="$EscapePods.{1}"/>
                <create_order object="$EscapePods.{1}" id="'MoveDie'"/>

                <set_value name="$Delay_EscapePodCleanup" exact="61s"/>
                <reset_cue cue="this"/>
              </do_elseif>
              <do_else>
                <do_if value="$escapePod">
                  <cancel_all_orders object="$escapePod"/>
                  <create_order object="$escapePod" id="'MoveDie'"/>
                </do_if>

                <set_value name="$Delay_EscapePodCleanup" exact="61s"/>
                <debug_text text="'Multiple Escape Pods found, trying again in ' + $Delay_EscapePodCleanup" chance="$DebugChance"/>
                <reset_cue cue="this"/>
              </do_else>
            </do_if>
          </actions>
        </cue>

        <cue name="Pt4_Force">
          <force name="Plot_Split_Pt4">
            <set_faction_relation faction="faction.freesplit" otherfaction="faction.player" value="0.5" comment="friendly"/>
            <signal_cue cue="Ch4_Collaborate"/>
          </force>
        </cue>

        <cue name="Ch4_Patch_Move_Dal_To_HQ">
          <cues>
            <cue name="Ch4_Patch_Init">
              <actions>
                <do_if value="Ch4_Collaborate.state != cuestate.waiting">
                  <signal_cue cue="Ch4_Move_Dal"/>
                </do_if>
              </actions>
            </cue>
            <cue name="Ch4_Move_Dal">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_cue_signalled cue="Ch4_Collaborate"/>
                </check_any>
              </conditions>
              <cues>
                <cue name="Ch4_Move_Dal_Back_to_HQ" checkinterval="5s">
                  <conditions>
                    <check_value value="player.entity.room != $DalBusta.room"/>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $DalBusta, namespace]"/>
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <!--The two prisoner actors still had placement requests active even when they were player owned and could be assigned to objects
        They also also added as people to the ship, while the actors did not change their role-->
        <cue name="Ch4_Patch_Release_Prisoner_Placement_Requests_V2" onfail="cancel">
          <conditions>
            <check_any>
              <cue_is_cancelled cue="Ch4_Collaborate"/>
              <cue_is_complete cue="Ch4_Collaborate"/>
            </check_any>
          </conditions>
          <actions>
            <set_value name="this.$NPCs" exact="[]"/>
            <do_if value="@$Prisoner1Actor.exists and (Ch4_Escape_GetAway_Prisoner1.state == cuestate.complete or Ch4_Escape_GetAway_Prisoner1.state == cuestate.cancelled)">
              <append_to_list name="this.$NPCs" exact="$Prisoner1Actor"/>
            </do_if>
            <do_if value="@$Prisoner2Actor.exists and (Ch4_Escape_GetAway_Prisoner2.state == cuestate.complete or Ch4_Escape_GetAway_Prisoner2.state == cuestate.cancelled)">
              <append_to_list name="this.$NPCs" exact="$Prisoner2Actor"/>
            </do_if>
            <do_for_each name="$Patch_NPC" in="this.$NPCs">
              <debug_text text="'Releasing Split plot position requests from actor ' + $Patch_NPC + ' ' + $Patch_NPC.knownname" filter="savegame"/>
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $Patch_NPC, namespace]"/>
              <do_if value="$Patch_NPC.assignedcontrolled">
                <do_if value="not $Patch_NPC.controlled and not $Patch_NPC.isintransit">
                  <do_if value="player.controlled == $Patch_NPC.assignedcontrolled">
                    <debug_text text="'Reinitialising actor ' + $Patch_NPC + ' ' + $Patch_NPC.knownname + ' as busy control entity of ' + $Patch_NPC.assignedcontrolled + ' ' + $Patch_NPC.assignedcontrolled.knownname + ' which is currently controlled by the player'" filter="savegame"/>
                    <find_npc_waypoint name="this.$DespawnSlot" object="$Patch_NPC.assignedcontrolled" tags="tag.npctransport"/>
                    <set_entity_traits entity="$Patch_NPC" busy="true" hidden="true"/>
                    <add_actor_to_room actor="$Patch_NPC" slot="this.$DespawnSlot"/>
                    <remove_value name="this.$DespawnSlot"/>
                  </do_if>
                  <do_else>
                    <set_entity_traits entity="$Patch_NPC" busy="false" hidden="false"/>
                    <add_actor_to_post_location actor="$Patch_NPC"/>
                    <initialise_control_entity actor="$Patch_NPC"/>
                    <debug_text text="'Reinitialising actor ' + $Patch_NPC + ' ' + $Patch_NPC.knownname + ' as control entity of ' + $Patch_NPC.controlled + ' ' + $Patch_NPC.controlled.knownname" filter="savegame"/>
                  </do_else>
                </do_if>
              </do_if>
              <do_else>
                <debug_text text="'Checking if Split prisoner ' + $Patch_NPC + ' ' + $Patch_NPC.knownname + ' is still a role entity for the player'" filter="savegame"/>
                <do_if value="$Patch_NPC.isplayerowned and not $Patch_NPC.role">
                  <set_entity_traits entity="$Patch_NPC" temporary="true"/>
                  <do_if value="Ch4_Escape_NewCrew_ChangeRole.state == cuestate.waiting">
                    <set_entity_role entity="$Patch_NPC" role="entityrole.passenger"/>
                    <!--$GetAwayShip still points to the correct ship-->
                    <set_entity_role_object entity="$Patch_NPC" object="$GetAwayShip"/>
                  </do_if>
                  <do_else>
                    <set_entity_role entity="$Patch_NPC" role="entityrole.service"/>
                    <set_entity_traits entity="$Patch_NPC" customhandler="false"/>
                    <do_if value="$Patch_NPC.object.people.{$Patch_NPC.npctemplate}.exists">
                      <set_entity_role_object entity="$Patch_NPC" object="$Patch_NPC.object"/>
                    </do_if>
                  </do_else>
                  <debug_text text="'Split prisoner ' + $Patch_NPC + ' ' + $Patch_NPC.knownname + ' is to be corrected to become role ' + $Patch_NPC.role" filter="savegame"/>
                </do_if>
              </do_else>
              <!--Remove reference to this actor and reinitialise state machine-->
              <remove_cue_actor cue="namespace" actor="$Patch_NPC"/>
              <signal_objects object="$Patch_NPC" param="'npc_state_reinit'"/>
            </do_for_each>
            <remove_value name="this.$NPCs"/>
          </actions>
        </cue>

        <cue name="Ch4_Collaborate" comment="Text IDs 400">
          <!-- 1. Report to Outcast on a Ship close to HoJ-Station -->
          <!-- 2. Place Bombs on the Cargo Drones; Get Launcher(if needed) + Bombs from Outcast Character, get more if you run out of bombs -->
          <!-- 3. Ship lands at HoJ, "Station Takeover":
               3.1 Deliver Bombs to ESlave on Station,
               3.2 get "access key" item from Crate,
               3.3 access to prison,
               3.4 free split prisoners,
               3.5 "Passenger Transport" them but they actually become your crsew -->
          <!-- 4. Escape the Station, (If warned: The Police will give the player the chance to leave + lines, but the boost decays quickly), fighting or leaving is both fine -->
          <!-- 5. Talk to Curb in the Funeral Sector -->
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <cancel_cue cue="Ch3_Conspiracy"/>

            <!-- spawn slavetrader -->
            <create_position name="$position" object="$HOJStation" space="$HOJSector"/>
            <set_value name="$mindist" exact="50km"/>
            <set_value name="$maxdist" exact="75km"/>
            <run_actions ref="md.LIB_Generic.CreatePositionEclipticNearFar" result="$position">
              <param name="position" value="$position"/>
              <param name="mindist" value="$mindist"/>
              <param name="maxdist" value="$maxdist"/>
            </run_actions>

            <create_ship name="$SlaveTraderShip" capturable="false" sector="$HOJSector" missioncue="namespace" macro="ship_spl_l_trans_container_01_a_macro" commandeerable="false">
              <owner exact="faction.freesplit" overridenpc="true"/>
              <loadout ref="story_split_slavetrader"/>
              <people>
                <fillpercent exact="0"/>
              </people>
              <paint ware="$PaintMod_SlaveTrader"/>
              <loadout ref="story_split_slavetrader"/>
              <pilot>
                <select faction="faction.freesplit" tags="tag.fighterpilot"/>
              </pilot>
              <safepos value="$position"/>
            </create_ship>
            <set_object_relation_behaviour object="$SlaveTraderShip" disable="true"/>
            <set_object_name object="$SlaveTraderShip" page="30221" line="205" comment="Slave Trader 2"/>
            <set_object_min_hull object="$SlaveTraderShip" exact="50" comment="invulnerable"/>
            <set_known object="$SlaveTraderShip" known="true"/>
            <!--start_script name="'order.wait'" object="$SlaveTraderShip.pilot">
                  <param name="debugchance" value="$DebugChance"/>
            </start_script-->
            <create_order id="'Wait'" object="$SlaveTraderShip" default="true" comment="stay put"/>

            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $SlaveTraderShip.controlroom,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

            <!-- briefing step -->
            <set_value name="$ObjectiveStep" exact="1"/>

          </actions>
          <cues>
            <cue name="Ch4_Collaborate_Outcast_Location_Failsafe" checkinterval="2s">
              <conditions>
                <check_value value="not player.entity.hascontext.{$BoneyardCarrier}"/>
                <check_value value="$OutcastActor.room != $SlaveTraderShip.controlroom"/>
              </conditions>
              <actions>
                <debug_text text="'OutcastActor ' + $OutcastActor.name + ' has been moved to ' + @$OutcastActor.object.knownname + ' - moving back to control room of ' + $SlaveTraderShip.knownname"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $SlaveTraderShip.controlroom,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                <reset_cue cue="this"/>
              </actions>
            </cue>

            <cue name="Ch4_Collaborate_Outcast_Location_Destroyed">
              <conditions>
                <event_object_destroyed object="$SlaveTraderShip"/>
              </conditions>
              <actions>
                <cancel_cue cue="Ch4_Collaborate_Outcast_Location_Failsafe" comment="stop enforcing character location"/>
              </actions>
            </cue>

            <!-- 1. Report to outcast -->

            <cue name="Ch4_CheckStationHOJ" checkinterval="10s">
              <conditions>
                <check_value value="$HOJStation.isoperational"/>
              </conditions>
              <actions>
                <run_actions ref="md.LIB_Generic.SetStationMinHull" comment="indestructible during most of ch4 (up to shortly before Ch4_Battle_v2)">
                  <param name="Station" value="$HOJStation"/>
                  <param name="MinHullPercent" value="15"/>
                </run_actions>
                <signal_cue cue="Ch4_Collaborate_Report"/>
              </actions>
            </cue>

            <cue name="Ch4_Collaborate_Report">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$OutcastIntro" exact="false"/>
                <set_value name="$OutcastRigged" exact="false"/>
                <set_value name="$OutcastEngage" exact="false"/>
              </actions>
              <cues>

                <cue name="Ch4_Collaborate_Outcast_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$OutcastActor"/>
                  <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                  <param name="Lines"             value="[[30221401]]"/>
                  <param name="EndSignalCue"      value="Ch4_Collaborate_Outcast_Mission"/>
                  <!--
                    <text line="30221401" comment="Report to Slave Trader 2 for first mission towards Split freedom."/>
                  -->
                </cue>


                <cue name="Ch4_Collaborate_Outcast_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Cleanup Old Mission -->
                    <do_if value="$Ch3b_RemoveMissionLater?">
                      <remove_mission cue="$MissionCue" type="completed"/>
                      <set_value name="$Description" exact="if player.entity.isfemale then {30221,3212} else {30221,3211}"/>
                      <do_if value="@$WarnedLoyalist">
                        <set_value name="$Description" exact="$Description + '\n\n' + (if player.entity.isfemale then {30221,3214} else {30221,3213})"/>
                      </do_if>
                      <write_to_logbook category="missions" faction="faction.player" title="{30221,3201}" text="$Description"/>
                    </do_if>

                    <!-- create mission / briefing -->
                    <set_value name="$ObjectiveStep" exact="1"/>

                    <set_value name="$Description" exact="if player.entity.isfemale then {30221,4003} else {30221,4002}"/>
                    <do_if value="@$WarnedLoyalist">
                      <set_value name="$Description" exact="if player.entity.isfemale then {30221,4005} else {30221,4004}"/>
                    </do_if>

                    <!-- Mission : Report to Slave Trader 2-->
                    <create_mission cue="$MissionCue" name="{30221,4001}" description="$Description" type="missiontype.plot" faction="faction.freesplit" difficulty="level.medium" abortable="false" rewardtext="{30221,4199}"
                                    icon="'briefing_yu_t_knk_01'" iconcaption="$OutcastActor.name" group="missiongroup.story_split">
                      <briefing>
                        <objective step="$ObjectiveStep" action="objective.custom" object="$OutcastActor" customaction="{30221,4010}"/>
                      </briefing>
                    </create_mission>
                    <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>
                  </actions>
                  <cues>
                    <cue name="Ch4_Story_Reminder" checkinterval="1s" onfail="cancel">
                      <conditions>
                        <check_value value="Ch4_Player_Reported_To_Ship.state == cuestate.waiting"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Story_Reminder_V2_Ref" ref="md.Story_Paranid.Story_Reminder">
                          <param name="Actor"       value="$DalBusta"/>
                          <param name="CutsceneKey" value="$Dal2CutsceneKey"/>
                          <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30200106 else 30200105]]"/>
                          <param name="CancelCue"   value="Ch4_Player_Reported_To_Ship"/>
                          <param name="Delay"       value="20min"/>
                          <!--  <t id="30200001">Hey there partner.</t>
                                <t id="30200002">(spoken to female player){10111,30200001}</t>
                                <t id="30200105">Don't keep our contact waiting for too long.</t>
                                <t id="30200106">(spoken to female player){,30200105}</t>
                                <t id="30200107">Where have you wandered off to?</t>
                                <t id="30200108">(spoken to female player 'you'){,30200107}</t>    -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Player_Reported_To_Ship">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                </cue>

                <cue name="Ch4_Collaborate_Outcast_Talk" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$OutcastActor"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="$OutcastIntro == false">
                      <do_if value="Ch4_Player_Reported_To_Ship.state == cuestate.waiting">
                        <signal_cue cue="Ch4_Player_Reported_To_Ship"/>
                      </do_if>
                      <add_npc_line line="if player.entity.isfemale then 30221403 else 30221402" hidechoices="true" comment="Split welcome rookie aboard!"/>
                      <add_npc_line line="if player.entity.isfemale then 30221405 else 30221404" hidechoices="true" comment="Split need you outside for minor maintenance."/>
                      <add_npc_line line="if player.entity.isfemale then 30221407 else 30221406" hidechoices="true" comment="Take bombs."/>
                      <add_npc_line line="if player.entity.isfemale then 30221409 else 30221408" hidechoices="true" comment="And bomb launcher too."/>
                      <add_npc_line line="if player.entity.isfemale then 30221413 else 30221412" hidechoices="true" comment="You go in space suit and fly to mass traffic dock in front of Slave Trader 2."/>
                    </do_if>
                    <do_elseif value="($OutcastRigged == false) and (not player.entity.inventory.{ware.bomb_player_limpet_mine_01_mk1}.count)" comment="out of bombs">
                      <add_npc_line line="if player.entity.isfemale then 30221429 else 30221428" hidechoices="true" comment="Rookie waste ammunition."/>
                      <add_npc_line line="if player.entity.isfemale then 30221466 else 30221427" hidechoices="true" comment="Try again."/>
                    </do_elseif>
                    <do_elseif value="$OutcastRigged == false">
                      <add_npc_line line="if player.entity.isfemale then 30221415 else 30221414" hidechoices="true" comment="Get in space suit, rookie!"/>
                    </do_elseif>
                    <do_elseif value="$OutcastRigged and (not $OutcastEngage)">
                      <add_player_choice text="{30221,4050}" section="c_ready" comment="I'm ready!"/>
                    </do_elseif>
                    <do_else>
                      <!-- some fallback -->
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch4_Collaborate_Outcast_Conv_Bombs" instantiate="true" comment="multiple refills">
                  <conditions>
                    <check_any>
                      <event_speak_finished actor="$OutcastActor" line="30221406" comment="initial supply"/>
                      <event_speak_finished actor="$OutcastActor" line="30221407" comment="initial supply"/>
                      <event_speak_finished actor="$OutcastActor" line="30221428" comment="out-of-bombs refill"/>
                      <event_speak_finished actor="$OutcastActor" line="30221429" comment="out-of-bombs refill"/>
                    </check_any>
                  </conditions>
                  <delay exact="250ms"/>
                  <actions>
                    <add_inventory entity="player.entity" ware="ware.bomb_player_limpet_mine_01_mk1" exact="5"/>
                  </actions>
                </cue>

                <cue name="Ch4_Collaborate_Outcast_Conv_Launcher" comment="one-time">
                  <conditions>
                    <check_any>
                      <event_speak_finished actor="$OutcastActor" line="30221408"/>
                      <event_speak_finished actor="$OutcastActor" line="30221409"/>
                    </check_any>
                  </conditions>
                  <delay exact="250ms"/>
                  <actions>
                    <add_inventory entity="player.entity" ware="ware.weapon_gen_spacesuit_demolition_01_mk1" exact="1"/>
                  </actions>
                </cue>

                <cue name="Ch4_Collaborate_Outcast_Conv_Ready" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$OutcastActor" section="c_ready" />
                  </conditions>
                  <actions>
                    <add_npc_line line="30221434" hidechoices="true" comment="Slave Trader 2 ready to engage!"/>
                    <set_value name="$OutcastEngage" exact="true"/>
                    <signal_cue cue="Ch4_Collaborate_Station_Takeover"/>
                  </actions>
                </cue>

                <cue name="Ch4_Collaborate_Outcast_Intro_ConvEnded" comment="intro only once!">
                  <conditions>
                    <check_any>
                      <event_speak_finished actor="$OutcastActor" line="30221412"/>
                      <event_speak_finished actor="$OutcastActor" line="30221413"/>
                    </check_any>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <set_value name="$OutcastIntro" exact="true" comment="intro dialog done"/>
                    <signal_cue cue="Ch4_Collaborate_Spacesuit_Use"/>
                  </actions>
                </cue>

                <cue name="Ch4_Collaborate_Spacesuit_Use">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" operation="add"/>
                    <find_player_transporter_slot name="$TransporterSlot" object="player.ship.controlroom"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.usespacesuit" slot="$TransporterSlot" updatebriefing="true" comment="Use spacesuit"/>
                  </actions>
                  <delay exact="20s"/>
                  <actions>
                    <signal_cue cue="Ch4_Collaborate_Spacesuit_Cutscene"/>
                  </actions>
                  <cues>
                    <cue name="Ch4_Collaborate_Spacesuit_Using">
                      <conditions>
                        <event_player_teleport_successful/>
                        <check_value value="@player.controlled.isclass.spacesuit"/>
                      </conditions>
                      <delay exact="5s"/>
                      <actions>
                        <signal_cue cue="Ch4_Collaborate_Instructions_Cutscene"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_Collaborate_Spacesuit_Cutscene" comment="hint">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="not @player.controlled.isclass.spacesuit"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Collaborate_Spacesuit_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$OutcastActor"/>
                          <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                          <param name="Lines"             value="[[30221414]]"/>
                          <!--
                              <text line="30221414" comment="Get in space suit, rookie!"/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_Collaborate_Instructions_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Collaborate_Instructions_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$OutcastActor"/>
                          <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                          <param name="DelayInitial"      value="5s"/>
                          <param name="Lines"             value="[[30221416], [if player.entity.isfemale then 30221418 else 30221417], [30221419]]"/>
                          <param name="EndSignalCue"      value="Ch4_Collaborate_Place_Bombs"/>
                          <!--
                            <text line="30221416" comment="Split send out cargo drones up front."/>
                            <text line="if player.entity.isfemale then 30221418 else 30221417" comment="You place bombs on cargo drones."/>
                            <text line="30221419" comment="Not destroy cargo drones, Split need them later."/>
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <!-- 2. Place Bombs, Resetable -->
            <cue name="Ch4_Collaborate_Place_Bombs">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.sabotage" text="{30221,4012}" updatebriefing="true"/>

                <create_group groupname="$BombTargets"/>
                <create_group groupname="$PrimedDrones"/>
                <set_value name="$LaunchAmount" exact="3" comment="decremented on launch, incremented on failure; Be wary of the max drone amount"/>
                <set_value name="$PrimeGoal" exact="$LaunchAmount"/>
                <set_value name="$SuccessfullyPrimed" exact="0"/>
              </actions>
              <cues>

                <cue name="Ch4_Launch_MassTraffic_Setup">
                  <cues>

                    <cue name="Ch4_Launch_MassTraffic_Init">
                      <actions>
                        <signal_cue cue="Ch4_Launch_MassTraffic_Delayed"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_Launch_Control" comment="Sanity Check and Recovery" instantiate="true" checkinterval="60s">
                      <conditions>
                        <set_value name="$ExpectedDroneAmount" exact="$SuccessfullyPrimed + $LaunchAmount + $BombTargets.count + $PrimedDrones.count"/>
                        <check_value value="$ExpectedDroneAmount lt $PrimeGoal"/>
                      </conditions>
                      <actions>
                        <set_value name="$Ch4_Sanity_DroneAmount" exact="'SP: ' + $SuccessfullyPrimed + ' LA: ' + $LaunchAmount + ' BTc: ' + $BombTargets.count + '  PDc: ' + $PrimedDrones.count + ' are less than PG: ' + $PrimeGoal"/>
                        <set_value name="$LaunchAmount" exact="$PrimeGoal - $ExpectedDroneAmount" operation="add"/>
                        <do_all exact="$PrimeGoal - $ExpectedDroneAmount">
                          <signal_cue cue="Ch4_Request_Masstraffic_Launch"/>
                        </do_all>
                      </actions>
                    </cue>

                    <cue name="Ch4_Request_Masstraffic_Launch" instantiate="true">
                      <!-- Will only launch if $LaunchAmount gt 0 -->
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Wait_For_Launch" checkinterval="5s">
                          <conditions>
                            <check_value value="Ch4_Launch_MassTraffic_Delayed.state == cuestate.waiting"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch4_Launch_MassTraffic_Delayed"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <!-- Launch-Delayed cues call each other every ~5 seconds and work through the desired LaunchAmount-->
                    <cue name="Ch4_Launch_MassTraffic_Delayed">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$LaunchAmount gt 0"/>
                      </conditions>
                      <delay exact="9s"/>
                      <actions>
                        <reset_cue cue="this" comment="reset self after actions"/>
                        <signal_cue cue="Ch4_Launch_MassTraffic"/>
                        <set_value name="$LaunchAmount" operation="subtract" exact="1"/>
                        <do_if value="$LaunchAmount gt 0">
                          <signal_cue cue="Ch4_Request_Masstraffic_Launch"/>
                        </do_if>
                      </actions>
                    </cue>
                    <cue name="Ch4_Launch_MassTraffic_Delayed_2">
                      <!-- Deprecated, left for save game compatibility-->
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$LaunchAmount gt 0"/>
                      </conditions>
                      <delay exact="9s"/>
                      <actions>
                        <reset_cue cue="this" comment="reset self after actions"/>
                        <signal_cue cue="Ch4_Launch_MassTraffic"/>
                        <set_value name="$LaunchAmount" operation="subtract" exact="1"/>
                        <do_if value="$LaunchAmount gt 0">
                          <signal_cue cue="Ch4_Launch_MassTraffic_Delayed"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch4_Launch_MassTraffic" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$DroneAmount" exact="$SlaveTraderShip.availableunits.{unitcategory.transport}.count"/>
                        <do_if value="$DroneAmount == 0">
                          <add_units object="$SlaveTraderShip" exact="1" category="unitcategory.transport" mk="1"/>
                        </do_if>

                        <set_value name="$Launched" exact="null"/>
                        <launch_masstraffic_drone object="$SlaveTraderShip" category="unitcategory.transport" name="$Launched"/>

                        <do_if value="$Launched.exists">
                          <debug_text text="'Drone Launched'" chance="$DebugChance"/>
                          <add_to_group groupname="$BombTargets" object="$Launched"/>
                          <!--<signal_cue_instantly cue="Ch4_MassTraffic_Destroyed" param="$BombTargets"/>-->
                          <start_script name="'masstraffic.move.waitforsignal'" object="$Launched.pilot">
                            <param name="homebase" value="$SlaveTraderShip"/>
                            <!--<param name="masstraffic" value="true"/>-->
                            <param name="debugchance" value="$DebugChance - 100"/>
                            <param name="signal" value="'RecallRiggedMassTraffic'"/>
                          </start_script>

                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.sabotage" group="$BombTargets" text="{30221,4012}" updatebriefing="true" comment="updating the group"/>
                        </do_if>
                        <do_else>
                          <set_value name="$LaunchAmount" exact="1" operation="add"/>
                          <signal_cue cue="Ch4_Request_Masstraffic_Launch"/>
                          <debug_text text="'Drone Launch failed!'" chance="$DebugChance"/>
                        </do_else>

                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_Player_Placed_BombOther" instantiate="true">
                  <conditions>
                    <event_player_bomb_attached/>
                    <check_value value="event.param.macro != macro.bomb_player_limpet_mine_01_mk1_macro"/>
                    <check_value value="$BombTargets.indexof.{event.param.parent}"/>
                  </conditions>
                  <actions>
                    <!--show_help line="7201" duration="10s" position="13" force="true" comment="Switch the ammo of your launcher to 'Spacesuit Bombs'."/-->
                  </actions>
                  <cues>
                    <cue name="Ch4_Player_Placed_BombOther_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor" value="$BosoTa"/>
                      <param name="CutsceneKey" value="$BosoCutsceneKey"/>
                      <param name="Lines" value="[[if player.entity.isfemale then 30200005 else 30200004], [30200007, 1s]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch4_Player_Placed_BombOther_Wrong_Ammo_Delay"/>
                      <!--
                          <t id="30200004">The ordnance you are using does not appear to be particularly suitable for the job.</t>
                          <t id="30200005">(spoken to female player 'you'){,30200004}</t>
                          <t id="30200007">I recommend switching to explosive charges.</t>
                      -->
                    </cue>
                    <cue name="Ch4_Player_Placed_BombOther_Wrong_Ammo_Delay">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="20s"/>
                      <actions>
                        <reset_cue cue="Ch4_Player_Placed_BombOther"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch4_Player_Placed_Bomb" instantiate="true">
                  <conditions>
                    <event_player_bomb_attached/>
                    <check_value value="event.param.macro == macro.bomb_player_limpet_mine_01_mk1_macro"/>
                  </conditions>
                  <actions>
                    <set_value name="$Bomb" exact="event.param"/>

                    <do_if value="$BombTargets.indexof.{$Bomb.object}" comment="Bomb attached to one of our Targets">
                      <set_value name="$FoundTarget" exact="$Bomb.object"/>
                      <set_owner object="$Bomb" faction="$FoundTarget.trueowner"/>
                      <do_all exact="$BombTargets.count" counter="$bt" reverse="true">
                        <do_if value="$BombTargets.{$bt} != $FoundTarget">
                          <disable_collisions_between object="$FoundTarget" target="$BombTargets.{$bt}" comment="avoid kicking each other out of the dock"/>
                        </do_if>
                      </do_all>
                      <signal_objects object="$FoundTarget" param="'RecallRiggedMassTraffic'"/>
                      <add_to_group groupname="$PrimedDrones" object="$FoundTarget"/>
                      <remove_from_group group="$BombTargets" object="$FoundTarget"/>
                      <do_if value="$PrimedDrones.count == 1">
                        <signal_cue cue="Ch4_MassTraffic_Rigged_PlacedBomb_Cutscene" comment="feedback to player that he's doing fine"/>
                      </do_if>
                    </do_if>

                    <do_if value="$BombTargets.count == 0" comment="all targets rigged?">
                      <!-- wait for the rigged ship to have docked (="destroyed")-->
                      <cancel_cue cue="Ch4_Player_Placed_BombOther"/>
                      <set_value name="$ObjectiveStep" operation="add"/>
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.wait" group="$PrimedDrones" text="$PrimedDrones.{1}.knownname" updatebriefing="true"/>
                    </do_if>
                    <do_elseif value="player.entity.inventory.{ware.bomb_player_limpet_mine_01_mk1}.count == 0" comment="out-of-ammo">
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$OutcastActor" updatebriefing="false"/>
                      <signal_cue cue="Ch4_Collaborate_OutOfAmmo_Cutscene"/>
                    </do_elseif>
                    <do_else>
                      <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.sabotage" group="$BombTargets" text="$BombTargets.{1}.knownname" updatebriefing="false"/>
                    </do_else>

                  </actions>
                </cue>

                <cue name="Ch4_Collaborate_OutOfAmmo_Cutscene" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Collaborate_OutOfAmmo_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$OutcastActor"/>
                      <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30221431 else 30221430]]"/>
                      <!--
                        <text line="if player.entity.isfemale then 30221431 else 30221430" comment="Report back to Split for more bombs."/>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_MassTraffic_Destroyed" instantiate="true">
                  <conditions>
                    <event_object_destroyed group="$PrimedDrones"/>
                    <check_value value="$SuccessfullyPrimed lt $PrimeGoal" comment="... and not already completed"/>
                  </conditions>
                  <actions>
                    <set_value name="$MassTraffic" exact="event.object"/>
                    <remove_from_group group="$BombTargets" object="$MassTraffic"/>
                    <do_if value="event.param2 == killmethod.collected" comment="masstraffic returned after being rigged">
                      <set_value name="$SuccessfullyPrimed" operation="add" exact="1"/>
                      <do_if value="$SuccessfullyPrimed ge $PrimeGoal">
                        <signal_cue cue="Ch4_MassTraffic_Rigged_Complete_Cutscene"/>
                      </do_if>
                      <do_elseif value="$SuccessfullyPrimed == 1">
                        <signal_cue cue="Ch4_MassTraffic_Rigged_First_Cutscene"/>
                      </do_elseif>
                      <do_elseif value="$SuccessfullyPrimed == ($PrimeGoal - 2)">
                        <signal_cue cue="Ch4_MassTraffic_Rigged_TwoMore_Cutscene"/>
                      </do_elseif>
                      <do_elseif value="$SuccessfullyPrimed == ($PrimeGoal - 1)">
                        <signal_cue cue="Ch4_MassTraffic_Rigged_LastOne_Cutscene"/>
                      </do_elseif>
                    </do_if>
                    <do_else comment="Prematurely destroyed">
                      <signal_cue cue="Ch4_MassTraffic_Rigged_Fail_Cutscene"/>
                      <set_value name="$LaunchAmount" exact="1" operation="add"/>
                      <signal_cue cue="Ch4_Request_Masstraffic_Launch"/>
                      <!-- Encounter-Free Period for Story Chunks? -->
                      <!-- Maybe delay if hostiles are closeby "Take care of the Hostiles before we try again. (?)"-->
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch4_MassTraffic_Rigged_Chatter">
                  <cues>

                    <cue name="Ch4_MassTraffic_Rigged_PlacedBomb_Cutscene" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_MassTraffic_Rigged_PlacedBomb_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$OutcastActor"/>
                          <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30221422 else 30221421]]"/>
                          <!--
                            <text line="if player.entity.isfemale then 30221422 else 30221421" comment="Good job, rookie."/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_MassTraffic_Rigged_First_Cutscene" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_MassTraffic_Rigged_First_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$OutcastActor"/>
                          <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                          <param name="Lines"             value="[[30221420]]"/>
                          <!--
                            <text line="30221420" comment="Drone primed and secured."/>
                            <text line="if player.entity.isfemale then 30221422 else 30221421" comment="Good job, rookie."/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_MassTraffic_Rigged_TwoMore_Cutscene" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_MassTraffic_Rigged_TwoMore_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$OutcastActor"/>
                          <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30221424 else 30221423]]"/>
                          <!--
                            <text line="if player.entity.isfemale then 30221424 else 30221423" comment="Two more and rookie can return to ship."/>
                          -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch4_MassTraffic_Rigged_LastOne_Cutscene" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_MassTraffic_Rigged_LastOne_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$OutcastActor"/>
                          <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                          <param name="Lines"             value="[[30221425]]"/>
                          <!--
                            <text line="30221425" comment="One drone left.."/>
                          -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch4_MassTraffic_Rigged_Fail_Cutscene" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_MassTraffic_Rigged_Fail_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$OutcastActor"/>
                          <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                          <param name="Lines"             value="[[30221426], [30221427]]"/>
                          <!--
                            <text line="30221426" comment="Something went wrong. Lost drone."/>
                            <text line="30221427" comment="Try again."/>
                          -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch4_MassTraffic_Rigged_Complete_Cutscene" instantiate="true">
                      <conditions>
                        <event_cue_signalled comment="Signalled on: $SuccessfullyPrimed ge $PrimeGoal"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_MassTraffic_Rigged_Complete_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$OutcastActor"/>
                          <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                          <param name="Lines"             value="[[30221432]]"/>
                          <param name="EndSignalCue"      value="Ch4_MassTraffic_Rigged_Complete_Continue"/>
                          <!--
                            <text line="30221432" comment="Report to Slave Trader 2 for mission start."/>
                          -->
                        </cue>
                        <cue name="Ch4_MassTraffic_Rigged_Complete_Continue">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$OutcastRigged" exact="true" comment="finished rigging"/>
                            <set_value name="$ObjectiveStep" operation="add"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$OutcastActor" updatebriefing="true"/>
                            <cancel_cue cue="Ch4_Collaborate_Place_Bombs"/>
                            <!-- talking to the outcast will signal Ch4_Collaborate_Station_Takeover -->
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <!--cue name="Ch4_MassTraffic_Rigged_ReturnToShip">
                  <conditions>
                    <event_player_teleport_successful/>
                    <check_value value="$SuccessfullyPrimed ge $PrimeGoal"/>
                    <check_value value="player.ship == $SlaveTraderShip"/>
                  </conditions>
                  <actions>
                  </actions>
                </cue-->

              </cues>
            </cue>

            <!-- 3. Send the Ship to dock at the Hall of Judgement Station-->
            <cue name="Ch4_Collaborate_Station_Takeover" version="2">
              <!-- The player is on the $SlaveTraderShip and completed bomb placement -->
              <!-- The ship docks at a (probably player-hostile) Split station -->
              <!-- The player gets off, talks to EscapedSlave in a hacking room, gets an access key from a crate, gets to a prison room, opens the prisoner doors (uses key), and they all run to an S ship on dock,
                    Player gets the ship and the prisoners as crew -->
              <!-- CUTSCENES: prison gates open, slave revolt sounds, evacuation,  -->
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- place escaped actor on HOJ-station -->
                <find_npc_slot name="$HOJ_Control_Slot" object="$HOJ_Control_Room" comment="any"/>
                <add_actor_to_room actor="$EscapedActor" slot="$HOJ_Control_Slot"/>

                <cancel_all_orders object="$SlaveTraderShip"/>
                <create_order id="'DockAndWait'" object="$SlaveTraderShip">
                  <param name="destination" value="$HOJStation" comment="stay docked at Halls of Judgement"/>
                </create_order>

                <!-- TODO: talkto: separatist contact instead of wait: ... -->
                <set_value name="$ObjectiveStep" operation="add"/>
                <!-- Note: Setting object="$HOJStation" results in guidance pointing to playership (which is not what we want in this case) -->
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.wait" text="{30221,4013}" updatebriefing="true"/>
              </actions>
              <patch sinceversion="2" state="complete">
                <do_if value="$SlaveTraderShip.order.id == 'DockAndWait'">
                  <do_if value="not $OutcastRigged">
                    <!-- order came from HallsOfJudgement_Setup and is too early (drones weren't rigged yet), abort order.
                      Player can talk to the captain after rigging and that will trigger the DockAndWait order. -->
                    <create_order id="'Wait'" object="$SlaveTraderShip" default="true" comment="stay put"/>
                  </do_if>
                  <do_elseif value="$SlaveTraderShip.hascontext.{$HOJStation}">
                    <!-- order came from HallsOfJudgement_Setup and is too early (drones weren't rigged yet), but ST2 already docked.
                      Too late for aborting and the cue which would listen for docking wasn't active yet, so signal manually -->
                    <signal_cue cue="Ch4_Docked"/>
                    <!-- reset part of the story which could already run -->
                    <reset_cue cue="Ch4_Collaborate_Escaped"/>
                    <reset_cue cue="Ch4_Collaborate_Escaped_NoticePlayer"/>
                  </do_elseif>
                </do_if>
                <do_elseif value="Ch4_Collaborate_Escaped.state == cuestate.complete ">
                  <!-- If player has a high rep with Zyarth, he can dock at the HOJ before the Slavetrader docks (which spawns the prisoners).
                    He can also already talk to Jey and progress partially through the plot, up to the point where the prisoners are needed. -->
                  <do_if value="Ch4_Docked.state != cuestate.complete">
                    <reset_cue cue="Ch4_Collaborate_Escaped"/>
                    <reset_cue cue="Ch4_Collaborate_Escaped_NoticePlayer"/>
                    <cancel_all_orders object="$SlaveTraderShip"/>
                    <create_order id="'DockAndWait'" object="$SlaveTraderShip">
                      <param name="destination" value="$HOJStation" comment="stay docked at Halls of Judgement"/>
                    </create_order>
                    <!-- objective will switch to Talk to Jey, on arrival of the slavetrader at the HOJ-->
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.wait" text="{30221,4013}" updatebriefing="true"/>
                  </do_if>
                </do_elseif>
              </patch>
              <cues>

                <!-- Ship approaches the station, should start close, shouldn't take too long -->
                <cue name="Ch4_Approach_Dock" checkinterval="3s">
                  <conditions>
                    <check_value value="$SlaveTraderShip.distanceto.{$HOJStation} lt 4km"/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Approach_OutcastEngage">
                      <delay exact="1s"/>
                      <cues>
                        <cue name="Ch4_Approach_OutcastEngage_Cutscene" onfail="cancel">
                          <conditions>
                            <check_value value="player.entity.distanceto.{$OutcastActor} gt 10" comment="player is 'far away' - cutscene"/>
                          </conditions>
                          <cues>
                            <cue name="Ch4_Approach_OutcastEngage_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$OutcastActor"/>
                              <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30221437 else 30221436], [if player.entity.isfemale then 30221439 else 30221438], [if player.entity.isfemale then 30221441 else 30221440]]"/>
                              <param name="EndSignalCue"      value="Ch4_Approach_DalEngage_Cutscene"/>
                              <!--
                                <text line="if player.entity.isfemale then 30221437 else 30221436" comment="When docked, you meet person inside for more instructions."/>
                                <text line="if player.entity.isfemale then 30221439 else 30221438" comment="Contact will expect you deliver bombs."/>
                                <text line="if player.entity.isfemale then 30221441 else 30221440" comment="When cargo drones allowed into station, they make distraction. Then you do job."/>
                              -->
                            </cue>
                          </cues>
                        </cue>
                        <cue name="Ch4_Approach_OutcastEngage_NearSpeak" onfail="cancel">
                          <conditions>
                            <check_value  value="player.entity.distanceto.{$OutcastActor} le 10" comment="player is nearby - speaks"/>
                          </conditions>
                          <actions>
                            <speak actor="$OutcastActor" priority="100">
                              <text line="if player.entity.isfemale then 30221437 else 30221436" comment="When docked, you meet person inside for more instructions."/>
                              <text line="if player.entity.isfemale then 30221439 else 30221438" comment="Contact will expect you deliver bombs."/>
                              <text line="if player.entity.isfemale then 30221441 else 30221440" comment="When cargo drones allowed into station, they make distraction. Then you do job."/>
                            </speak>
                          </actions>
                          <cues>
                            <cue name="Ch4_Approach_OutcastEngage_NearSpeak_Done">
                              <conditions>
                                <check_any>
                                  <event_speak_finished actor="$OutcastActor" line="30221436"/>
                                  <event_speak_finished actor="$OutcastActor" line="30221437"/>
                                </check_any>
                              </conditions>
                              <delay exact="0.5s"/>
                              <actions>
                                <signal_cue cue="Ch4_Approach_DalEngage_Cutscene"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch4_Approach_DalEngage_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Arrival_Dal_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                          <param name="DelayInitial"      value="5s"/>
                          <param name="Lines"             value="[[30221401], [30221402], [if player.entity.isfemale then 30221404 else 30221403]]" comment="You're probably trying to steal something.], [30221405]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                            <text line="30221401" comment="This is all rather conspiratorial. They still didn't tell us what this is about, though."/>
                            <text line="30221402" comment="We'll know soon enough, I suppose."/>
                            <text line="if player.entity.isfemale then 30221404 else 30221403" comment="You're probably trying to steal something."/>
                            <text line="30221405" comment="Try to not get caught."/>
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Docked_PATCH" onfail="cancel">
                  <conditions>
                    <check_value value="$SlaveTraderShip.hascontext.{$HOJStation}"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch4_Docked" check="false"/>
                  </actions>
                </cue>

                <cue name="Ch4_Docked">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_docked object="$SlaveTraderShip" dock="$HOJStation"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$EscapedActor" updatebriefing="true"/>
                  </actions>
                  <cues>

                    <cue name="Ch4_Prison_SetupTriggers" instantiate="true" comment="setup everytime, triggerstate not stored even if room is persistent">
                      <conditions>
                        <event_object_changed_room object="player.entity" room="$HOJ_Prison_Room" comment="set triggers each time the player enters the room"/>
                      </conditions>
                      <actions>
                        <do_if value="not $Door01Unlocked?" comment="if already unlocked, don't re-lock on entering room (default=unlocked)">
                          <set_trigger_activation_wares room="$HOJ_Prison_Room" group="tag.door_01" ware="ware.inv_encrypted_accesskey" amount="1" consumeonuse="true" />
                        </do_if>
                        <set_triggers_locked object="$HOJ_Prison_Room" group="tag.door_02" locked="true"/>
                        <do_if value="not $Door03Unlocked?" comment="if already unlocked, don't re-lock on entering room (default=unlocked)">
                          <set_trigger_activation_wares room="$HOJ_Prison_Room" group="tag.door_03" ware="ware.inv_encrypted_accesskey" amount="1" consumeonuse="true"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch4_GetAway_Setup">
                      <actions>
                        <find_dockingbay name="$DockingBays" object="$HOJStation" checkoperational="true" multiple="true" walkable="true" comment="walkable=true ignores launchtubes!" required="true">
                          <match_any>
                            <match_dock size="tag.dock_s"/>
                          </match_any>
                        </find_dockingbay>
                        <do_if value="$DockingBays.count">
                          <create_ship name="$GetAwayShip" sector="$HOJSector" dock="$DockingBays.random" missioncue="namespace" macro="ship_spl_s_heavyfighter_01_a_macro" capturable="false" commandeerable="false">
                            <owner exact="$HOJStation.owner" overridenpc="true"/>
                            <loadout ref="story_split_getaway"/>
                            <people>
                              <fillpercent exact="0"/>
                            </people>
                          </create_ship>
                          <set_object_min_hull object="$GetAwayShip" exact="50"/>
                        </do_if>
                        <do_else>
                          <!-- TODO: What if all docks destroyed? -->
                          <!-- TODO: What if ship is put into internal storage? (player can't recall, not the owner!)-->
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch4_PoliceSquad_Setup">
                      <actions>
                        <set_value name="$PoliceSquadMacro" exact="macro.ship_spl_s_heavyfighter_01_a_macro"/>
                        <find_dockingbay name="$HOJInternalDock" object="$HOJStation" multiple="true" required="true">
                          <match_dock storage="true" size="$PoliceSquadMacro.docksize"/>
                        </find_dockingbay>
                        <do_all exact="5" counter="$i">
                          <do_if value="$HOJInternalDock.count">
                            <create_ship name="$PoliceSquadShip" macro="$PoliceSquadMacro" dock="$HOJInternalDock.random" capturable="false">
                              <owner exact="faction.split" overridenpc="true" />
                              <pilot group="split.pilot"/>
                              <loadout ref="story_split_policesquad" />
                            </create_ship>
                            <add_to_group groupname="$PoliceSquad" object="$PoliceSquadShip"/>
                          </do_if>
                        </do_all>
                      </actions>
                    </cue>

                    <cue name="Ch4_Prison_Setup">
                      <actions>
                        <set_value name="$DoorsLocked" exact="0"/>
                        <create_cue_actor name="$Prisoner1Actor" cue="namespace" macro="character_split_prisoner1_macro">
                          <page exact="10401"/>
                          <owner exact="faction.civilian"/>
                          <skills>
                            <skill type="management"  exact="2"/>
                            <skill type="morale"      exact="0"/>
                            <skill type="piloting"    exact="3"/>
                            <skill type="engineering" exact="12"/>
                            <skill type="boarding"    exact="0"/>
                          </skills>
                        </create_cue_actor>
                        <set_entity_traits entity="$Prisoner1Actor" customhandler="true"/>
                        <set_entity_overrides entity="$Prisoner1Actor" icon="'shadyguy'" title="'{20208,20401}'"/>
                        <set_entity_role entity="$Prisoner1Actor" role="entityrole.prisoner"/>
                        <set_entity_role_object entity="$Prisoner1Actor" object="$HOJStation"/>
                        <create_cue_actor name="$Prisoner2Actor" cue="namespace" macro="character_split_prisoner2_macro">
                          <page exact="10402"/>
                          <owner exact="faction.civilian"/>
                          <skills>
                            <skill type="management"  exact="2"/>
                            <skill type="morale"      exact="0"/>
                            <skill type="piloting"    exact="12"/>
                            <skill type="engineering" exact="3"/>
                            <skill type="boarding"    exact="0"/>
                          </skills>
                        </create_cue_actor>
                        <set_entity_traits entity="$Prisoner2Actor" customhandler="true"/>
                        <set_entity_overrides entity="$Prisoner2Actor" icon="'shadyguy'" title="'{20208,20401}'"/>
                        <set_entity_role entity="$Prisoner2Actor" role="entityrole.prisoner"/>
                        <set_entity_role_object entity="$Prisoner2Actor" object="$HOJStation"/>
                        <!-- find prisoner npc-slots and place the two above cue-actors -->
                        <find_npc_slot name="$NPCSlot" object="$HOJ_Prison_Room" tags="tag.prisoner" multiple="true" />
                        <do_all exact="$NPCSlot.count" counter="$i">
                          <do_if value="$NPCSlot.{$i}.group == tag.door_01">
                            <add_actor_to_room result="$Prisoner1result" actor="$Prisoner1Actor" slot="$NPCSlot.{$i}"/>
                            <do_if value="$Prisoner1result">
                              <set_value name="$DoorsLocked" operation="add"/>
                            </do_if>
                          </do_if>
                          <do_elseif value="$NPCSlot.{$i}.group == tag.door_03">
                            <add_actor_to_room result="$Prisoner2result" actor="$Prisoner2Actor" slot="$NPCSlot.{$i}"/>
                            <do_if value="$Prisoner2result">
                              <set_value name="$DoorsLocked" operation="add"/>
                            </do_if>
                          </do_elseif>
                        </do_all>
                        <set_value name="$DoorsLockedMax" exact="$DoorsLocked" comment="remember #prisoners"/>
                      </actions>
                      <cues>
                        <cue name="Ch4_Prisoner_OneLiner_Help" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_conversation_started actor="$Prisoner1Actor"/>
                              <event_conversation_started actor="$Prisoner2Actor"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="event.object" line="10028"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>

                </cue>

                <cue name="Ch4_Collaborate_Escaped_NoticePlayer" checkinterval="1s">
                  <conditions>
                    <check_value value="player.entity.distanceto.{$EscapedActor} lt 8m"/>
                    <check_value value="Ch4_Docked.state == cuestate.complete"/>
                  </conditions>
                  <actions>
                    <speak actor="$EscapedActor" priority="100">
                      <text line="30221401" comment="(impatient, 'on phone')Stand by, I'm still waiting for the delivery."/>
                      <text line="30221402" comment="('on phone')Hang on. I think it's just arrived."/>
                    </speak>
                    <signal_cue cue="Ch4_Collaborate_Escaped"/>
                  </actions>
                </cue>

                <cue name="Ch4_Collaborate_Escaped">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$EscapedIntro" exact="false"/>
                    <set_value name="$EscapedPackage" exact="false"/>
                    <set_value name="$EscapedYouToo" exact="false"/>
                  </actions>
                  <cues>

                    <cue name="Ch4_Collaborate_Escaped_Talk" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$EscapedActor"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <do_if value="$EscapedIntro == false">
                          <add_npc_line line="if player.entity.isfemale then 30221404 else 30221403" hidechoices="true" comment="I'm surprised to see you back here."/>
                          <add_npc_line line="if player.entity.isfemale then 30221406 else 30221405" hidechoices="true" comment="You definitively didn't work for them when you gatecrashed our meeting, so they must have recruited you since then."/>
                          <add_player_choice text="{30221,4051}" section="c_separatists" comment="You work for the separatists?"/>
                          <add_player_choice text="{30221,4052}" section="c_bombs" comment="I have the bombs."/>
                        </do_if>
                        <do_elseif value="$EscapedPackage == false">
                          <add_npc_line line="if player.entity.isfemale then 30221408 else 30221407" hidechoices="true" comment="Do you have the package?"/>
                        </do_elseif>
                        <do_elseif value="$EscapedPackage == true">
                        </do_elseif>
                      </actions>
                    </cue>

                    <cue name="Ch4_Collaborate_Escaped_Conv_Separatists" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$EscapedActor" section="c_separatists" />
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <set_value name="$Achievement_Informed_On_Slavery" exact="1" operation="add"/>
                        <add_npc_line line="30221409" hidechoices="true" comment="I'm here to liberate Argon slaves."/>
                        <add_npc_line line="if player.entity.isfemale then 30221411 else 30221410" hidechoices="true" comment="I've no clue what your priorities are, but you seem to be in over your head here."/>
                        <add_player_choice text="{30221,4052}" section="c_bombs" comment="I have the bombs."/>
                        <set_value name="$EscapedYouToo" exact="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_Collaborate_Escaped_Conv_Package" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$EscapedActor" section="c_bombs" />
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line line="if player.entity.isfemale then 30221413 else 30221412" hidechoices="true" comment="Good job, soldier!"/>
                        <add_npc_line line="if player.entity.isfemale then 30221415 else 30221414" hidechoices="true" comment="You'll find the access codes stashed in a crate on the dock."/>
                        <add_npc_line line="if player.entity.isfemale then 30221417 else 30221416" hidechoices="true" comment="Now get out there. We all have a job to do."/>
                        <set_value name="$EscapedIntro" exact="true"/>
                      </actions>
                      <cues>

                        <cue name="Ch4_Collaborate_Escaped_Conv_Package2">
                          <conditions>
                            <event_conversation_finished actor="$EscapedActor"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch4_Collaborate_Escaped_Conv_Package_Delivery"/>
                          </actions>
                          <delay exact="3s" comment="focussing from player on 'someone remotely'"/>
                          <actions>
                            <!-- TODO: $OutcastActor, trigger 'on the radio'-animation -->
                            <speak actor="$EscapedActor">
                              <text line="30221418" comment="('on phone')Bravo to Tango, we're in business."/>
                              <text line="30221419" comment="('on phone')The package is on the way."/>
                            </speak>
                            <!-- TODO: $OutcastActor, walks out of the room -->
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_Collaborate_Escaped_Conv_Package_Delivery">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- spawn crate on crateslot -->
                        <find_dockingbay name="$DockingBays" object="$HOJStation" checkoperational="true" multiple="true" walkable="true" comment="walkable=true ignores launchtubes!">
                          <match_dock size="[tag.dock_s, tag.dock_m]"/>
                        </find_dockingbay>
                        <create_list name="$CrateSlots"/>
                        <set_value name="$SelectedDockingBay" exact="$DockingBays.random"/>
                        <find_crate_slot name="$CrateSlots" object="$SelectedDockingBay" tags="tag.crate_s" multiple="true" />
                        <debug_text text="'Found #crateslots:' + $CrateSlots.count"/>
                        <do_if value="$CrateSlots.count">
                          <create_crate name="$KeyCrate" macro="macro.crate_gen_s_01_macro" slot="$CrateSlots.random" />
                          <add_cargo object="$KeyCrate" ware="ware.inv_encrypted_accesskey" exact="2" comment="for 2 prison-doors"/>
                        </do_if>
                        <do_else>
                          <debug_text text="'No crateslots found!'"/>
                        </do_else>

                        <!-- set objective (huge station, so guidance to crate) -->
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.pickup" text="{30221,4015}" object="$KeyCrate" updatebriefing="true"/>

                        <do_if value="$EscapedYouToo">
                          <signal_cue cue="Ch4_Collaborate_BosoComments_CutsceneStart"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch4_Collaborate_DalComments_CutsceneStart"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch4_Collaborate_BosoComments_CutsceneStart" comment="optional voiceline">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Collaborate_BosoComments_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor" value="$BosoTa"/>
                          <param name="CutsceneKey" value="$BosoCutsceneKey"/>
                          <param name="DelayInitial"      value="3s"/>
                          <param name="Lines" value="[[30221401, 1s]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch4_Collaborate_DalComments_CutsceneStart"/>
                          <!--
                            <text line="30221401" comment="Ah, what a noble cause! Now I feel much more comfortable with our involvement in this plot."/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_Collaborate_DalComments_CutsceneStart" comment="mandatory">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Collaborate_DalComments_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                          <param name="DelayInitial"      value="1s"/>
                          <param name="Lines"             value="[[30221407]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--             
                            <text line="30221407" comment="I think I might have underestimated the scope of this undertaking."/>
                            -->
                        </cue>
                      </cues>
                    </cue>


                    <cue name="Ch4_Collaborate_KeyCrate_Pickup">
                      <conditions>
                        <event_player_opened_crate/>
                        <check_value value="event.param == @$KeyCrate"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <set_value name="$EscapedPackage" exact="true"/>
                        <destroy_object object="$KeyCrate" comment="un-reserve slot"/>
                        <signal_cue cue="Ch4_Collaborate_Crate_Comments"/>
                        <signal_cue cue="Ch4_Prison"/>
                      </actions>
                    </cue>

                    <cue name="Ch4_Collaborate_Crate_Comments">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch4_Collaborate_Crate_Comments_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$DalBusta, $BosoTa]"/>
                          <param name="CutsceneKey"       value="[$Dal2CutsceneKey, $BosoCutsceneKey]"/>
                          <param name="DelayInitial"      value="[2s, 0s]"/>
                          <param name="Lines"             value="[[[30221408]],
                                                                  [[if player.entity.isfemale then 30221403 else 30221402], [if player.entity.isfemale then 30221405 else 30221404] ]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[null, Ch4_Collaborate_Crate_Comments_Done]"/>
                          <!--           
                            <text line="30221408" comment="Now what?"/>
                            <text line="if player.entity.isfemale then 30221403 else 30221402" comment="Your possession of the contents of the crate would appear to grant you access to a restricted area on this station."/>
                            <text line="if player.entity.isfemale then 30221405 else 30221404" comment="I suggest you find an elevator, or something, to take you there."/>
                          -->
                        </cue>

                        <cue name="Ch4_Collaborate_Crate_Comments_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$ObjectiveStep" operation="add"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.find" text="{30221, 4021}" updatebriefing="true" comment="Restricted Area"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_Prison_Impatient">
                          <delay exact="45s"/>
                          <actions>
                            <signal_cue cue="Ch4_Prison_Impatient_Wait"/>
                          </actions>
                          <cues>
                            <cue name="Ch4_Prison_Impatient_Wait">
                              <conditions>
                                <event_cue_signalled/>
                                <check_value value="$DoorsLocked gt 0" comment="don't trigger if prisoners already rescued"/>
                              </conditions>
                              <cues>
                                <cue name="Ch4_Prison_Impatient_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$OutcastActor"/>
                                  <param name="CutsceneKey"       value="$ShowPilotCutsceneKey"/>
                                  <param name="Lines"             value="[ [if player.entity.isfemale then 30221443 else 30221442] ]"/>
                                  <!--
                                      <t id="30221442">You rescued Split yet?</t>
                                      <t id="30221443">(spoken to female 'you'){,30221442}</t>
                                  -->
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Ch4_Prison">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$PrisonerEscapeCount" exact="0"/>
                      </actions>
                      <cues>

                        <cue name="Ch4_Prison_Corridor" comment="1-time">
                          <conditions>
                            <event_object_changed_room object="player.entity" room="$HOJ_Prison_Corridor"/>
                          </conditions>
                          <cues>
                            <cue name="Ch4_Prison_BuffaloUndock">
                              <actions>
                                <!-- slave trader leaves station -->
                                <create_position name="$position" object="$HOJStation" space="$HOJSector"/>
                                <set_value name="$mindist" exact="25km"/>
                                <set_value name="$maxdist" exact="30km"/>
                                <run_actions ref="md.LIB_Generic.CreatePositionEclipticNearFar" result="$position">
                                  <param name="position" value="$position"/>
                                  <param name="mindist" value="$mindist"/>
                                  <param name="maxdist" value="$maxdist"/>
                                </run_actions>
                                <!-- ai-order -->
                                <cancel_all_orders object="$SlaveTraderShip"/>
                                <create_order object="$SlaveTraderShip" id="'MoveGeneric'">
                                  <param name="destination" value="$HOJStation.sector"/>
                                  <param name="position" value="$position"/>
                                  <param name="noboost" value="true"/>
                                </create_order>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_Prison_Entered" comment="1-time">
                          <conditions>
                            <event_object_changed_room object="player.entity" room="$HOJ_Prison_Room"/>
                          </conditions>
                          <cues>
                            <cue name="Ch4_Prison_Entered_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$OutcastActor"/>
                              <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                              <param name="Lines"             value="[ [if player.entity.isfemale then 30221445 else 30221444] ]"/>
                              <!-- 
                                <t id="30221444">Get captives and get out.</t>
                                <t id="30221445">(spoken to female 'you'){,30221444}</t>
                              -->
                            </cue>

                            <cue name="Ch4_Prison_Entered_Speak_Finished">
                              <conditions>
                                <check_any>
                                  <event_speak_finished actor="$OutcastActor" line="30221445"/>
                                  <event_speak_finished actor="$OutcastActor" line="30221444"/>
                                </check_any>
                              </conditions>
                              <actions>
                                <set_value name="$ObjectiveStep" operation="add"/>
                                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.free" text="{30221, 4022}" updatebriefing="true" comment="prisoners"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_Prison_Unlocked" instantiate="true">
                          <conditions>
                            <check_any>
                              <event_player_unlocked_platform_trigger component="$HOJ_Prison_Room" group="tag.door_01" />
                              <event_player_unlocked_platform_trigger component="$HOJ_Prison_Room" group="tag.door_03" />
                            </check_any>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <!-- note that once it was unlocked, player can open/close as often as he wants (without needing the unlock-ware) -->
                            <set_value name="$DoorsLocked" operation="subtract"/>
                            <signal_cue cue="Ch4_Prison_Escape"/>
                            <!-- prisoner escaping (ai-order) -->
                            <do_if value="event.param2 == tag.door_01">
                              <signal_cue_instantly cue="Ch4_Prisoner_Escape" param="$Prisoner1Actor"/>
                              <set_value name="$Door01Unlocked" exact="true"/>
                            </do_if>
                            <do_elseif value="event.param2 == tag.door_03">
                              <set_value name="$Door03Unlocked" exact="true"/>
                              <signal_cue_instantly cue="Ch4_Prisoner_Escape" param="$Prisoner2Actor"/>
                            </do_elseif>
                          </actions>
                          <cues>
                          </cues>
                        </cue>

                        <cue name="Ch4_Prison_Escape_Recall" checkinterval="15s" instantiate="true">
                          <conditions>
                            <check_value value="$HOJStation.exists and $GetAwayShip.exists and $GetAwayShip.hascontext.{$HOJStation}"/>
                          </conditions>
                          <actions>
                            <do_if value="$GetAwayShip.parent.isstorage" comment="GetAwayShip is stored internally?">
                              <request_retrieval queuedresult="$QueuedResult1" grantedresult="$GrantedResult1" ship="$GetAwayShip" />
                              <debug_text text="'Requesting retrieval from internal storage for GetAwayShip'" chance="$DebugChance"/>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Ch4_Prisoner_Escape" instantiate="true" comment="parameter: prisoner-npc (to move to ship)">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <find_npc_waypoint name="this.$DespawnWaypoints" object="$GetAwayShip" tags="tag.npctransport" multiple="true"/>
                            <debug_text text="'Escape: ' + event.param.name + ' path: ' + this.$DespawnWaypoints.count + ' speed: ' + event.param.runspeed"/>
                            <do_if value="this.$DespawnWaypoints.count">
                              <!--
                              <set_value name="$MovementTable" exact="table[$slot = this.$DespawnWaypoints.random, $movementspeed = event.param.runspeed]" comment="TODO: @Owen, should run" />
                              <signal_objects object="event.param" param="'npc_move_to'" param2="$MovementTable.clone"/>-->
                              <!-- TODO: Prisoners do not move -->
                              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', event.param,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = this.$DespawnWaypoints.random,
                                                                                                      $priority = 100,
                                                                                                      $debugchance = $DeepDebugChance]
                                                                                                      ]"/>
                            </do_if>
                            <do_else>
                              <!-- cheat and teleport the npc -->
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Ch4_Prison_Alarm" comment="1-time">
                          <conditions>
                            <event_object_changed_room object="player.entity" room="$HOJ_Prison_Corridor"/>
                            <check_value value="$DoorsLocked le 0" comment="both cell doors opened and leaving prison-room"/>
                          </conditions>
                          <delay exact="4s"/>
                          <actions>
                            <set_alert_level object="$HOJStation" level="red" comment="escape noticed"/>
                            <cancel_cue cue="Ch4_Prisoner_OneLiner_Help"/>
                          </actions>
                          <cues>
                            <cue name="Ch4_Prisoner_OneLiner_Thank" instantiate="true">
                              <conditions>
                                <check_any>
                                  <event_conversation_started actor="$Prisoner1Actor"/>
                                  <event_conversation_started actor="$Prisoner2Actor"/>
                                </check_any>
                              </conditions>
                              <actions>
                                <add_npc_line speaker="event.object" line="2111"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_Prison_Escape">
                          <conditions>
                            <event_cue_signalled/>
                            <check_value value="$DoorsLocked == 0"/>
                          </conditions>
                          <actions>
                            <set_value name="$ObjectiveStep" operation="add"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.embark" text="{30221,4018}" object="$GetAwayShip" updatebriefing="true"/>
                            <signal_cue cue="Ch4_PoliceSquad_Launch" comment="policesquad launches"/>
                          </actions>
                          <cues>
                            <cue name="Ch4_Prison_Escape1_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$OutcastActor"/>
                              <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                              <param name="Lines"             value="[[30221446],[30221448],[30221449],[if player.entity.isfemale then 30221451 else 30221450]]"/>
                              <param name="EndSignalCue"      value="Ch4_Prison_Escape_Cutscene"/>
                              <!--
                               <t id="30221446">Captives on way. Ready to execute.</t>
                               <t id="30221448">Activate cargo drone bombs.</t>
                               <t id="30221449">Take Split off station. Meet at funeral.</t>
                               <t id="30221450">Escape ship ready for you.</t>
                               <t id="30221451">(spoken to female 'you'){,30221450}</t>
                              -->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_Prison_Escape_Cutscene">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <play_cutscene result="$CutsceneID" key="'Story_Split_Escape'" abortable="true">
                              <param name="target_station" object="$HOJStation" />
                              <param name="target_ship" object="$SlaveTraderShip" />
                            </play_cutscene>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <!-- Camera needs to be close to station in the cutscene, since explosions are culled away at further distances -->
                            <signal_cue cue="Ch4_Prison_Escape_Cutscene_Explosions1" comment="signalling sub-cue requires delayed-action"/>
                          </actions>
                          <cues>

                            <cue name="Ch4_Prison_Escape_Cutscene_Explosions1">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <add_effect object="$HOJStation" effect="'ref_explosion_station_explosion01'"/>
                              </actions>
                              <delay exact="3s"/>
                              <actions>
                                <add_effect object="$HOJStation" effect="'ref_explosion_station_explosion01'"/>
                                <add_effect object="$HOJStation" effect="'ref_explosion_station_explosion01'"/>
                              </actions>
                              <delay exact="6s"/>
                              <actions>
                                <add_effect object="$HOJStation" effect="'ref_explosion_station_explosion01'"/>
                                <add_effect object="$HOJStation" effect="'ref_explosion_station_explosion01'"/>
                              </actions>
                            </cue>

                            <cue name="Ch4_Prison_Escape_Cutscene_Explosions2">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <find_object_component name="$StationModules" object="$HOJStation" class="[class.storage, class.pier, class.production, class.defencemodule]" multiple="true"/>
                                <create_position name="$EffectOffset1" object="$HOJStation" x="-200" y="20m" z="0"/>
                                <create_position name="$EffectOffset2" object="$HOJStation" x="200" y="-20m" z="0"/>
                                <add_effect object="$HOJStation.zone" effect="'pm_topexplosion'">
                                  <position value="$EffectOffset1"/>
                                </add_effect>
                                <add_effect object="$HOJStation.zone" effect="'pm_finalblast'">
                                  <position value="$EffectOffset2"/>
                                </add_effect>
                              </actions>
                            </cue>

                            <cue name="Ch4_Prison_Escape_Cutscene_Complete">
                              <conditions>
                                <event_cutscene_stopped key="'Story_Split_Escape'"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch4_Escape_Explosions"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_PoliceSquad_Launch">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="2s"/>
                          <actions>
                            <do_all exact="$PoliceSquad.count" counter="$i">
                              <debug_text text="'Ordering: ' + $i"/>
                              <create_order object="$PoliceSquad.{$i}" id="'Follow'" immediate="true">
                                <param name="target" value="$SlaveTraderShip"/>
                              </create_order>
                            </do_all>
                          </actions>
                        </cue>

                        <cue name="Ch4_Escape_GetAway">
                          <cues>

                            <cue name="Ch4_Escape_GetAway_Player_Embarked" instantiate="true">
                              <conditions>
                                <event_object_changed_room object="player.entity" room="$GetAwayShip.controlroom"/>
                              </conditions>
                              <actions>
                                <do_if value="($PrisonerEscapeCount != $DoorsLockedMax) and ($GetAwayShip.owner != faction.player)">
                                  <set_objective cue="$MissionCue" action="objective.wait" text="{30221,4019}" object="$GetAwayShip" updatebriefing="false"/>
                                </do_if>
                                <signal_cue cue="Ch4_Escape_GetAway_AllAboard" comment="checks if now everyone is onboard (player entering last)"/>
                              </actions>
                            </cue>

                            <cue name="Ch4_Escape_GetAway_Player_Disembarked" instantiate="true">
                              <conditions>
                                <event_object_changed_room object="player.entity"/>
                                <check_value value="event.param2 == $GetAwayShip.controlroom"/>
                                <check_value value="$GetAwayShip.owner != faction.player" comment="only as long as player doesn't own ship (avoids overwriting 'undock' objective)"/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue" action="objective.embark" text="{30221,4018}" object="$GetAwayShip" updatebriefing="false"/>
                              </actions>
                            </cue>

                            <cue name="Ch4_Escape_GetAway_Prisoner1">
                              <conditions>
                                <event_object_changed_room object="$Prisoner1Actor" room="$GetAwayShip.controlroom"/>
                              </conditions>
                              <actions>
                                <set_value name="$PrisonerEscapeCount" operation="add"/>
                                <!-- When promoting this prisoner to pilot and letting him pilot the ship, CreateNPCFromPerson will early-out in the GetInstantiatedPerson. 
                                     This means the ownership (which is usually set automatically to the owner of the ship) doesn't happen, so the pilot has the wrong faction (civilian), and the player loses control of his ship. 
                                     destroying the object (in an attempt to avoid it finding the InstantiatedPerson doesn't work. As a workaround, just set the owner shortly before we create the template. -->
                                <set_owner object="$Prisoner1Actor" faction="faction.player"/>
                                <!--TODO @Owen make this less of a hassle-->
                                <set_entity_role entity="$Prisoner1Actor" role="entityrole.passenger"/>
                                <set_entity_role_object entity="$Prisoner1Actor" object="$GetAwayShip"/>
                                <create_npc_template name="$Template" object="$GetAwayShip" entity="$Prisoner1Actor" role="entityrole.passenger" comment="changed to crew shortly"/>
                                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $Prisoner1Actor, namespace]"/>
                                <signal_cue cue="Ch4_Escape_GetAway_AllAboard" comment="checks if now everyone is onboard"/>
                              </actions>
                            </cue>

                            <cue name="Ch4_Escape_GetAway_Prisoner2">
                              <conditions>
                                <event_object_changed_room object="$Prisoner2Actor" room="$GetAwayShip.controlroom"/>
                              </conditions>
                              <actions>
                                <set_value name="$PrisonerEscapeCount" operation="add"/>
                                <!-- When promoting this prisoner to pilot and letting him pilot the ship, CreateNPCFromPerson will early-out in the GetInstantiatedPerson. 
                                     This means the ownership (which is usually set automatically to the owner of the ship) doesn't happen, so the pilot has the wrong faction (civilian), and the player loses control of his ship. 
                                     destroying the object (in an attempt to avoid it finding the InstantiatedPerson doesn't work. As a workaround, just set the owner shortly before we create the template. -->
                                <set_owner object="$Prisoner2Actor" faction="faction.player"/>
                                <create_npc_template name="$Template" object="$GetAwayShip" entity="$Prisoner2Actor" role="entityrole.passenger" comment="changed to crew shortly"/>
                                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['remove_request', $Prisoner2Actor, namespace]"/>
                                <signal_cue cue="Ch4_Escape_GetAway_AllAboard" comment="checks if now everyone is onboard"/>
                              </actions>
                            </cue>

                            <cue name="Ch4_Escape_GetAway_AllAboard" instantiate="true">
                              <conditions>
                                <event_cue_signalled/>
                                <check_value value="$PrisonerEscapeCount == 2" comment="all prisoners escaped?"/>
                                <!--check_value value="$PrisonerEscapeCount == $DoorsLockedMax" comment="all prisoners escaped?"/-->
                                <check_value value="player.entity.room == $GetAwayShip.controlroom" comment="player on board?"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch4_Escape_GetAway_Dialog" check="false"/>
                                <cancel_cue cue="Ch4_Prisoner_OneLiner_Thank"/>

                                <do_if value="$Prisoner1Actor.exists">
                                  <set_entity_traits entity="$Prisoner1Actor" customhandler="false"/>
                                  <set_npc_template_traits object="$GetAwayShip" template="$Prisoner1Actor.npctemplate" customhandler="false"/>
                                  <set_entity_overrides entity="$Prisoner1Actor" icon="''" title="''"/>
                                </do_if>
                                <do_if value="$Prisoner2Actor.exists">
                                  <set_entity_traits entity="$Prisoner2Actor" customhandler="false"/>
                                  <set_npc_template_traits object="$GetAwayShip" template="$Prisoner2Actor.npctemplate" customhandler="false"/>
                                  <set_entity_overrides entity="$Prisoner2Actor" icon="''" title="''"/>
                                </do_if>
                              </actions>
                            </cue>

                            <cue name="Ch4_Escape_GetAway_Dialog">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch4_Escape_GetAway_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor"             value="[$EscapedActor, $OutcastActor, $EscapedActor, $OutcastActor]"/>
                                  <param name="CutsceneKey"       value="[$EscapedCutsceneKey, $OutcastCutsceneKey, $EscapedCutsceneKey, $OutcastCutsceneKey]"/>
                                  <param name="Lines"             value="[[[30221420]],
                                                                          [[30221452], [30221453]],
                                                                          [[30221421]],
                                                                          [[30221454], [if player.entity.isfemale then 30221456 else 30221455]],
                                                                         ]"/>
                                  <param name="EndSignalCue"      value="[null, null, Ch4_Escape_GetAway_ReceivedAccessCode, null]"/>
                                  <!-- 
                                    <t id="30221420">Security breached, ready for takeover.</t>
                                    <t id="30221452">Understood.</t>
                                    <t id="30221453">Passengers secured.</t>
                                    <t id="30221421">Transmitting ship access codes to your new friend.</t>
                                    <t id="30221454">Received.</t>
                                    <t id="30221455">Get out.</t>
                                    <t id="30221456">(spoken to female 'you'){,30221455}</t>
                                  -->
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch4_Escape_GetAway_ReceivedAccessCode" version="2">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <!-- ownership transferred to player, so he can control his new ship -->
                                <set_owner object="$GetAwayShip" faction="faction.player"/>
                                <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                                  <param name="Ship" value="$GetAwayShip"/>
                                  <param name="Faction" value="faction.player"/>
                                </run_actions>
                                <set_object_min_hull object="$GetAwayShip" exact="0"/>
                                <!-- and undock from halls of justice -->
                                <set_value name="$ObjectiveStep" operation="add"/>
                                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.undock" text="$HOJStation.knownname" updatebriefing="true"/>
                              </actions>
                              <patch sinceversion="2" state="complete">
                                <set_object_min_hull object="$GetAwayShip" exact="0"/>
                              </patch>
                              <patch sinceversion="2" state="cancelled">
                                <set_object_min_hull object="$GetAwayShip" exact="0"/>
                              </patch>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Ch4_Escape_Explosions">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch4_Escape_MoreExplosions" checkinterval="12s" instantiate="true">
                              <actions>
                                <add_effect object="$HOJStation" effect="'ref_explosion_station_explosion01'" comment="effect lasts about 10 seconds"/>
                              </actions>
                            </cue>
                            <cue name="Ch4_Escape_Station" checkinterval="10s" instantiate="true">
                              <conditions>
                                <check_value value="player.entity.station != $HOJStation" comment="player left station (stop explosions)"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Ch4_Escape_Station_Liberated"/>
                                <cancel_cue cue="Ch4_Escape_Explosions"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch4_Escape_Station_Liberated">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- TODO: Check this, relationboost might be 'overwritten' by something else -->
                            <set_relation_boost object="$HOJStation" value="0.15" faction="faction.player" silent="true" decay="0" reason="relationchangereason.missioncompleted"/>

                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.retreat" object="$SlaveTraderShip" updatebriefing="true"/>
                            <set_object_min_hull object="$SlaveTraderShip" exact="0" comment="not invulnerable anymore!"/>

                            <cancel_cue cue="Ch4_Collaborate_Outcast_Location_Failsafe" comment="stop enforcing character location"/>
                            <cancel_cue cue="HallsOfJudgement_Setup" comment="stop respawning this station"/>

                            <run_actions ref="md.LIB_Generic.TransferStationOwnership">
                              <param name="Station" value="$HOJStation"/>
                              <param name="Faction" value="faction.argon"/>
                            </run_actions>
                          </actions>
                          <cues>

                            <cue name="Ch4_Escape_Station_Liberate_Dal_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                              <param name="Lines"             value="[[30221410]]"/>
                              <param name="MissionCue"        value="$MissionCue"/>
                              <param name="EndSignalCue"      value="Ch4_Escape_NewCrew"/>
                              <!--             
                                <t id="30221410">The slaves have taken over the station.</t>
                              -->
                            </cue>

                            <cue name="Ch4_Escape_NewCrew">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <!-- TODO: Can we add the prisoners as passengers initially, and change them into 'crew' at this point? -->
                                <cue name="Ch4_Escape_NewCrew_Curb_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor" checktime="player.age + 4s">
                                  <param name="Actor"             value="$CurbActor"/>
                                  <param name="CutsceneKey"       value="$CurbCutsceneKey"/>
                                  <param name="Lines"             value="[[if player.entity.isfemale then 30221411 else 30221410]]"/>
                                  <param name="EndSignalCue"      value="Ch4_Escape_NewCrew_ChangeRole"/>
                                  <!--             
                                    <t id="30221410">Pilot is congratulated on new crew.</t>
                                  -->
                                </cue>
                                <cue name="Ch4_Escape_NewCrew_ChangeRole">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <set_value name="$GetAwayPassengers" exact="$GetAwayShip.people.passengers.list"/>
                                    <do_all exact="$GetAwayPassengers.count" counter="$i">
                                      <set_npc_template_role object="$GetAwayShip" template="$GetAwayPassengers.{$i}" role="entityrole.service"/>
                                      <set_npc_template_traits object="$GetAwayShip" template="$GetAwayPassengers.{$i}" customhandler="false"/>
                                    </do_all>
                                    <!--Note: This will leave the entities existing but hidden. They will behave correctly when promoted or reassigned, using this entity instead if instantiating a new one-->
                                    <set_entity_traits entity="$Prisoner1Actor" customhandler="false" temporary="true"/>
                                    <set_entity_role entity="$Prisoner1Actor" role="entityrole.service"/>
                                    <remove_cue_actor cue="namespace" actor="$Prisoner1Actor"/>
                                    <signal_objects object="$Prisoner1Actor" param="'npc_state_reinit'"/>

                                    <set_entity_traits entity="$Prisoner2Actor" customhandler="false" temporary="true"/>
                                    <set_entity_role entity="$Prisoner2Actor" role="entityrole.service"/>
                                    <remove_cue_actor cue="namespace" actor="$Prisoner2Actor"/>
                                    <signal_objects object="$Prisoner2Actor" param="'npc_state_reinit'"/>
                                  </actions>
                                  <delay exact="10s"/>
                                  <actions>
                                    <signal_cue cue="Ch4_Battle_v2"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch4_Escaped_Station_Delayed10">
                              <delay exact="10s"/>
                              <actions>
                                <set_alert_level object="$HOJStation" level="yellow"/>
                              </actions>
                            </cue>

                            <cue name="Ch4_Escaped_Station_Delayed15">
                              <delay exact="18s"/>
                              <actions>
                                <set_alert_level object="$HOJStation" level="green"/>

                                <run_actions ref="md.LIB_Generic.SetStationMinHull" comment="destructible again">
                                  <param name="Station" value="$HOJStation"/>
                                  <param name="MinHullPercent" value="0"/>
                                </run_actions>

                              </actions>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch4_Battle_v2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" operation="add"/>
              </actions>
              <cues>

                <!--cue name="Ch4_Station_LeftProximity" checkinterval="5s">
                  <conditions>
                    <check_value value="player.entity.distanceto.{$HOJStation} gt 10km"/>
                  </conditions>
                  <actions>
                  </actions>
                </cue-->

                <cue name="Ch_4_Police_Fallback">
                  <delay exact="120s"/>
                  <actions>
                    <!--Last resort to skip the battle if no Police shows up-->
                    <signal_cue cue="Ch4_BattleOver" check="false"/>
                  </actions>
                </cue>

                <cue name="Ch4_Police_Proximity_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.retreat" group="$PoliceSquad" updatebriefing="false"/>
                  </actions>
                </cue>


                <cue name="Ch4_Police_Proximity" checkinterval="5s">
                  <conditions>
                    <check_any exact="$PoliceSquad.count" counter="$p">
                      <check_value value="($PoliceSquad.{$p}.sector == $SlaveTraderShip.sector) and ($PoliceSquad.{$p}.distanceto.{$SlaveTraderShip} lt 7km)"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch_4_Police_Fallback"/>
                    <signal_cue cue="Ch4_Police"/>
                  </actions>
                </cue>

                <cue name="Ch4_Police">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$InitialDistance" exact="player.entity.distanceto.{$SlaveTraderShip}"/>
                    <set_value name="$InitialDistance" min="50km" max="$InitialDistance" comment="in case the player was already closeby"/>
                  </actions>
                  <cues>
                    <cue name="Ch4_Police_Dialog1" onfail="cancel">
                      <conditions>
                        <check_value value="@$WarnedLoyalist"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Police_Dialog1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$LoyalistActor"/>
                          <param name="CutsceneKey"       value="$LoyalistCutsceneKey"/>
                          <param name="Lines"             value="[[30221401], [30221402], [30221403], [if player.entity.isfemale then 30221405 else 30221404], [if player.entity.isfemale then 30221407 else 30221406]]"/>
                          <param name="EndSignalCue"      value="Ch4_Police_HoldOff"/>
                          <!-- 
                            <t id="30221401">Patriarchy Police calling terrorists!</t>
                            <t id="30221402">Surrender now!</t>
                            <t id="30221403">Split open private channel.</t>
                            <t id="30221404">Split hope you worth it.</t>
                            <t id="30221405">(spoken to female 'you'){,30221404}</t>
                            <t id="30221406">Get out before Split have to shoot you.</t>
                            <t id="30221407">(spoken to female 'you'){,30221406}</t>
                          -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch4_Police_Dialog2" onfail="cancel">
                      <conditions>
                        <check_value value="not @$WarnedLoyalist"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Police_Dialog2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$LoyalistActor"/>
                          <param name="CutsceneKey"       value="$LoyalistCutsceneKey"/>
                          <param name="Lines"             value="[[30221401], [30221402], [if player.entity.isfemale then 30221423 else 30221422]]"/>
                          <param name="EndSignalCue"      value="Ch4_Police_Engage"/>
                          <!-- 
                            <t id="30221401">Patriarchy Police calling terrorists!</t>
                            <t id="30221402">Surrender now!</t>
                            <t id="30221422">Should have run when Split warned you!</t>
                            <t id="30221423">(spoken to female 'you'){,30221422}</t>
                          -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Ch4_Police_HoldOff">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- police remains neutral for short period -->
                      </actions>
                      <cues>
                        <cue name="Ch4_Police_HoldOff_Engage">
                          <delay exact="200s"/>
                          <actions>
                            <signal_cue cue="Ch4_Police_Engage"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <library name="Ch4_Police_EngageOrders" purpose="include_actions">
                      <actions>
                        <do_if value="(cuestate.waiting == Ch4_PoliceSquad_Destroyed.state) and $PoliceSquad.count and $SlaveTraderShip.exists">
                          <do_for_each in="$PoliceSquad" name="$police">
                            <set_relation_boost object="$police" otherobject="$SlaveTraderShip" value="-1.0" decay="0" comment="fight terrorists!"/>
                            <set_relation_boost object="$SlaveTraderShip" otherobject="$police" value="-1.0" decay="0" comment="fight oppressors"/>
                            <cancel_all_orders object="$police"/>
                            <create_order id="'Patrol'" object="$police" default="true">
                              <param name="space" value="$SlaveTraderShip.zone"/>
                            </create_order>
                            <create_order object="$police" id="'Attack'" immediate="true">
                              <param name="primarytarget" value="$SlaveTraderShip"/>
                              <param name="pursuetargets" value="true"/>
                            </create_order>
                          </do_for_each>
                          <cancel_all_orders object="$SlaveTraderShip"/>
                          <create_order object="$SlaveTraderShip" id="'MoveGeneric'">
                            <param name="destination" value="$HeartOfAcrimonySector"/>
                            <param name="noboost" value="true"/>
                          </create_order>
                        </do_if>
                      </actions>
                    </library>

                    <cue name="Ch4_Police_Engage" version="2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <do_if value="Ch4_BattleOver.state == cuestate.waiting">
                          <set_objective cue="$MissionCue" action="objective.protect" object="$SlaveTraderShip" updatebriefing="false"/>
                        </do_if>
                        <include_actions ref="Ch4_Police_EngageOrders"/>
                      </actions>
                      <patch sinceversion="2">
                        <include_actions ref="Ch4_Police_EngageOrders"/>
                      </patch>
                      <cues>
                        <cue name="Ch4_SlaveTrader_AttackLost" checkinterval="11s" instantiate="true">
                          <conditions>
                            <check_value value="$PoliceSquad.count"/>
                            <check_any>
                              <check_value value="not $PoliceSquad.{1}.orders.count"/>
                              <check_value value="$PoliceSquad.{1}.orders.{1}.id != 'Attack'"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <include_actions ref="Ch4_Police_EngageOrders"/>
                          </actions>
                        </cue>

                        <cue name="Ch4_SlaveTraderSwitchedZone" instantiate="true">
                          <conditions>
                            <event_object_changed_zone object="$SlaveTraderShip"/>
                            <check_value value="$PoliceSquad.count"/>
                          </conditions>
                          <actions>
                            <include_actions ref="Ch4_Police_EngageOrders"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_Outcast_Defend">
                      <conditions>
                        <event_object_attacked object="$SlaveTraderShip"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Outcast_Defend_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$OutcastActor"/>
                          <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                          <param name="Lines"             value="[[30221460]]"/>
                          <!-- 
                              <t id="30221460">Fighters, defend Slave Trader!</t>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch4_SladeTrader_PlayerFlee_v2" checkinterval="5s">
                      <conditions>
                        <check_all>
                          <check_value value="$PoliceSquad.count gt 0" comment="player can only be seen fleeing if there are enemies remaining"/>
                          <check_any>
                            <check_value value="player.entity.sector != $SlaveTraderShip.sector"/>
                            <check_value value="player.entity.distanceto.{$SlaveTraderShip} gt ($InitialDistance + 10km)"/>
                          </check_any>
                        </check_all>
                      </conditions>
                      <actions>
                        <set_value name="$Achievement_Working_With_Police" exact="1" operation="add"/>
                        <set_value name="$CurbRelationBonus" exact="1" operation="subtract"/>
                        <set_value name="$ZyarthRelationBonus" exact="1" operation="add"/>
                      </actions>
                      <cues>
                        <cue name="Ch4_SlaveTrader_PlayerFlee_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$CurbActor"/>
                          <param name="CutsceneKey"       value="$CurbCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30221413 else 30221412], [if player.entity.isfemale then 30221415 else 30221414]]"/>
                          <param name="EndSignalCue"      value="Ch4_SlaveTrader_PlayerFlee_BattleOver"/>
                          <!--             
                            <t id="30221412">Pilot cowardly. Did not expect this.</t>
                            <t id="30221413">(spoken to female 'Pilot'){,30221412}</t>
                            <t id="30221414">Pilot not worry. We are not Patriarchy and still find use for cowards.</t>
                            <t id="30221415">(spoken to female 'Pilot'){,30221414}</t>
                          -->
                        </cue>
                        <cue name="Ch4_SlaveTrader_PlayerFlee_BattleOver">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch4_BattleOver" check="false"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_SlaveTrader_Destroyed" version="2">
                  <conditions>
                    <event_object_destroyed object="$SlaveTraderShip"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch4_SlaveTraderSwitchedZone"/>
                  </actions>
                  <delay exact="10s"/>
                  <actions>
                    <signal_cue cue="Ch4_BattleOver" check="false"/>
                  </actions>
                  <patch sinceversion="2">
                    <cancel_cue cue="Ch4_SlaveTraderSwitchedZone"/>
                  </patch>
                  <cues>
                    <cue name="Ch4_SlaveTrader_Destroyed_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$OutcastActor"/>
                      <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                      <param name="Lines"             value="[[30221462], [30221463]]"/>
                      <!--             
                        <t id="30221462">Slave Trader lost!</t>
                        <t id="30221463">Retreat immediately.</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_PoliceSquad_Destroyed">
                  <conditions>
                    <check_any>
                      <event_object_changed_sector object="$SlaveTraderShip"/>
                      <check_all>
                        <event_object_destroyed group="$PoliceSquad"/>
                        <check_value value="$PoliceSquad.count == 1" comment="last one about to be destroyed"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <delay exact="10s"/>
                  <actions>
                    <signal_cue cue="Ch4_BattleOver" check="false"/>
                  </actions>
                  <cues>
                    <cue name="Ch4_PoliceSquad_Destroyed_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$LoyalistActor"/>
                      <param name="CutsceneKey"       value="$LoyalistCutsceneKey"/>
                      <param name="Lines"             value="[[30221408]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                          <t id="30221408">Fall back and report to command.</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <!--
                random engagement lines:
                loyalist
                <t id="30221409">Death to terrorists!</t>
                <t id="30221410">Long live Patriarch!</t>
                OutcastActor
                <t id="30221464">For Free Families!</t>
                -->

                <cue name="Ch4_BattleOver" comment="battle was either won or lost (both ok)">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_for_each in="$PoliceSquad" name="$police">
                      <cancel_all_orders object="$police"/>
                      <create_order object="$police" id="'MoveDie'"/>
                    </do_for_each>
                  </actions>
                  <cues>
                    <cue name="Ch4_BattleOver_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actors" checktime="player.age + 12s">
                      <param name="Actor"             value="[$OutcastActor, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$OutcastCutsceneKey, $Dal2CutsceneKey]"/>
                      <param name="Lines"             value="[[[30221465]],
                                                              [[30221420], [30221421], [if player.entity.isfemale then 30221423 else 30221422], [30221424]]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="[null, Ch4_TheBoneyard]"/>
                      <!--
                      <t id="30221420">Right, off we go back to their lair.</t>
                      <t id="30221421">Now that we're tried and tested field operators, they might loosen up to us a bit about about their separatist movement.</t>
                      <t id="30221422">Ask her when you can speak to their leaders.</t>
                      <t id="30221423">(spoken to female 'you'){,30221422}</t>
                      <t id="30221424">They're quite elusive, and I'm having a hard time finding out which of the local Patriarchs are involved.</t>
                    -->
                    </cue>

                    <cue name="Ch4_Story_Reminder_After" checkinterval="1s" onfail="cancel">
                      <conditions>
                        <check_value value="Ch4_ThroneRoom_Arrived_v3.state == cuestate.waiting"/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Story_Reminder_v2_After_Ref" ref="md.Story_Paranid.Story_Reminder">
                          <param name="Actor"       value="$DalBusta"/>
                          <param name="CutsceneKey" value="$Dal2CutsceneKey"/>
                          <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30200108 else 30200107]]"/>
                          <param name="CancelCue"   value="Ch4_ThroneRoom_Arrived_v3"/>
                          <param name="Delay"       value="20min"/>
                          <!--  <t id="30200001">Hey there partner.</t>
                                <t id="30200002">(spoken to female player){10111,30200001}</t>
                                <t id="30200105">Don't keep our contact waiting for too long.</t>
                                <t id="30200106">(spoken to female player){,30200105}</t>
                                <t id="30200107">Where have you wandered off to?</t>
                                <t id="30200108">(spoken to female player 'you'){,30200107}</t>    -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch4_TheBoneyard" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_thrones"/>

                <remove_mission cue="$MissionCue" type="completed"/>
                <set_value name="$Description" exact="if player.entity.isfemale then {30221,4102} else {30221,4101}"/>
                <set_value name="$Description" exact="$Description + '\n\n'"/>
                <do_if value="@$WarnedLoyalist">
                  <do_if value="@$EscapedBattle">
                    <set_value name="$Description" exact="$Description + (if player.entity.isfemale then {30221,4104} else {30221,4103})"/>
                  </do_if>
                  <do_else>
                    <set_value name="$Description" exact="$Description + (if player.entity.isfemale then {30221,4106} else {30221,4105})"/>
                  </do_else>
                </do_if>
                <do_else>
                  <set_value name="$Description" exact="$Description + (if player.entity.isfemale then {30221,4108} else {30221,4107})"/>
                </do_else>

                <write_to_logbook category="missions" faction="faction.freesplit" title="{30221,4001}" text="$Description"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <!-- Mission: Turning the Tide -->
                <create_mission cue="$MissionCue" name="{30221,5001}" description="if player.entity.isfemale then {30221,5003} else {30221,5002}" rewardtext="{30221,5099}" type="missiontype.plot" faction="faction.freesplit" abortable="false"
                                    icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name" difficulty="level.easy" group="missiongroup.story_split">
                  <briefing>
                    <objective step="1" action="objective.retreat" text="$ThroneRoom_Interior.knownname" object="$BoneYardAccelerator_InTo"/>
                    <objective step="2" action="objective.talkto" object="$CurbActor"/>
                    <objective step="3" action="objective.talkto" object="$DalBusta"/>
                  </briefing>
                </create_mission>
                <set_value name="$ObjectiveStep" exact="1"/>
                <set_objective_from_briefing cue="$MissionCue" step="1"/>
                <!-- can't directly set throneroom as object, since the accelerator leading to the boneyard is disabled -->
              </actions>
              <patch sinceversion="2" state="complete">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_thrones"/>
              </patch>
              <patch sinceversion="2" state="cancelled">
                <signal_cue_instantly cue="md.X4Ep1_Mentor_Subscriptions.Add_Player_Office_Trophy" param="tag.trophy_story_split_thrones"/>
              </patch>
              <cues>
                <cue name="Ch4_Place_Throneroom_Curbs">
                  <actions>

                    <create_cue_actor name="$NPC_Curb_1" cue="namespace" macro="character_split_female_generic_05_macro">
                      <owner exact="faction.civilian"/>
                      <skills>
                        <skill type="management"  min="12" max="15"/>
                        <skill type="morale"      exact="15"/>
                        <skill type="piloting"    min="0" max="7"/>
                        <skill type="engineering" min="0" max="3"/>
                        <skill type="boarding"    min="0" max="6"/>
                      </skills>
                    </create_cue_actor>
                    <set_entity_traits entity="$NPC_Curb_1" missionactor="true" customhandler="true" subtitlename="true"/>
                    <set_entity_overrides entity="$NPC_Curb_1" icon="'factionrepresentative'" title="'{30221,156}'"/>

                    <create_cue_actor name="$NPC_Curb_2" cue="namespace" macro="character_split_female_generic_05_macro">
                      <owner exact="faction.civilian"/>
                      <skills>
                        <skill type="management"  min="12" max="15"/>
                        <skill type="morale"      exact="15"/>
                        <skill type="piloting"    min="0" max="7"/>
                        <skill type="engineering" min="0" max="3"/>
                        <skill type="boarding"    min="0" max="6"/>
                      </skills>
                    </create_cue_actor>
                    <set_entity_traits entity="$NPC_Curb_2" missionactor="true" customhandler="true" subtitlename="true"/>
                    <set_entity_overrides entity="$NPC_Curb_2" icon="'factionrepresentative'" title="'{30221,156}'"/>

                    <create_cue_actor name="$NPC_Curb_3" cue="namespace" macro="character_split_female_generic_05_macro">
                      <owner exact="faction.civilian"/>
                      <skills>
                        <skill type="management"  min="12" max="15"/>
                        <skill type="morale"      exact="15"/>
                        <skill type="piloting"    min="0" max="7"/>
                        <skill type="engineering" min="0" max="3"/>
                        <skill type="boarding"    min="0" max="6"/>
                      </skills>
                    </create_cue_actor>
                    <set_entity_traits entity="$NPC_Curb_3" missionactor="true" customhandler="true" subtitlename="true"/>
                    <set_entity_overrides entity="$NPC_Curb_3" icon="'factionrepresentative'" title="'{30221,156}'"/>

                    <create_cue_actor name="$NPC_Curb_4" cue="namespace" macro="character_split_female_generic_05_macro">
                      <owner exact="faction.civilian"/>
                      <skills>
                        <skill type="management"  min="12" max="15"/>
                        <skill type="morale"      exact="15"/>
                        <skill type="piloting"    min="0" max="7"/>
                        <skill type="engineering" min="0" max="3"/>
                        <skill type="boarding"    min="0" max="6"/>
                      </skills>
                    </create_cue_actor>
                    <set_entity_traits entity="$NPC_Curb_4" missionactor="true" customhandler="true" subtitlename="true"/>
                    <set_entity_overrides entity="$NPC_Curb_4" icon="'factionrepresentative'" title="'{30221,156}'"/>



                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $NPC_Curb_1,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $CurbActor.room,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.sit],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $NPC_Curb_2,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $CurbActor.room,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.sit],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $NPC_Curb_3,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $CurbActor.room,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.sit],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $NPC_Curb_4,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $CurbActor.room,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.sit],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $OutcastActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $priority = 100,
                                                                                                      $location = 'disconnect',
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                  </actions>
                </cue>

                <cue name="Ch4_SladeTraderMove" onfail="cancel" version="2">
                  <conditions>
                    <check_value value="$SlaveTraderShip.exists"/>
                  </conditions>
                  <actions>
                    <create_order object="$SlaveTraderShip" id="'MoveWait'" default="true">
                      <param name="destination" value="[$BoneYardAccelerator_InTo, position.[5km, 5km, 5km]]" />
                    </create_order>
                  </actions>
                  <patch sinceversion="2" state="complete">
                    <do_if value="(not $LeftoverShips?) and $SlaveTraderShip.exists">
                      <create_order object="$SlaveTraderShip" id="'MoveWait'" default="true">
                        <param name="destination" value="[$BoneYardAccelerator_InTo, position.[5km, 5km, 5km]]" />
                      </create_order>
                    </do_if>
                  </patch>
                  <patch sinceversion="2" state="cancelled">
                    <do_if value="(not $LeftoverShips?) and $SlaveTraderShip.exists">
                      <create_order object="$SlaveTraderShip" id="'MoveWait'" default="true">
                        <param name="destination" value="[$BoneYardAccelerator_InTo, position.[5km, 5km, 5km]]" />
                      </create_order>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch4_Player_Accelerator" checkinterval="13s">
                  <conditions>
                    <check_value value="(player.entity.sector == $BoneYardAccelerator_InTo.sector) and (player.entity.distanceto.{$BoneYardAccelerator_InTo} lt 5km)"/>
                  </conditions>
                  <actions>
                    <!-- TODO: @Heinrich: magic to get the player through the deactivated accelerator -->
                    <debug_text text="'Arrived in throneroom'"/>
                  </actions>
                </cue>

                <cue name="Ch4_Player_Boneyard" instantiate="true">
                  <conditions>
                    <event_object_changed_sector object="player.entity"/>
                  </conditions>
                  <actions>
                    <do_if value="event.param == $BoneYardSector" comment="entered the boneyard">
                      <find_npc_slot name="$ThroneRoom_NpcSlots" object="$ThroneRoom_Room" tags="[tag.npc]" multiple="true" comment="TODO: Remove"/>
                      <add_actor_to_room actor="$CurbActor" slot="$ThroneRoom_NpcSlots.random" />
                      <set_objective cue="$MissionCue" action="objective.retreat" text="$ThroneRoom_Interior.knownname" object="$ThroneRoom_Room" updatebriefing="false"/>
                    </do_if>
                    <do_elseif value="event.param2 == $BoneYardSector" comment="left the sector">
                      <remove_actor_from_room actor="$CurbActor"/>
                      <set_objective cue="$MissionCue" action="objective.retreat" text="$ThroneRoom_Interior.knownname" object="$BoneYardAccelerator_InTo" updatebriefing="false"/>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Ch4_Player_Boneyard_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <find_npc_slot name="$ThroneRoom_NpcSlots" object="$ThroneRoom_Room" tags="[tag.npc]" multiple="true" />
                    <add_actor_to_room actor="$CurbActor" slot="$ThroneRoom_NpcSlots.random" />
                  </actions>
                </cue>

                <cue name="Ch4_ThroneRoom_Arrived_v3">
                  <conditions>
                    <check_any>
                      <event_object_changed_room object="player.entity"/>
                      <event_player_teleport_successful />
                    </check_any>
                    <check_value value="player.entity.room == $CurbActor.room"/>
                    <!--<event_object_changed_room object="player.entity"/> never triggered -->
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch4_Player_Boneyard" comment="stop objective regression"/>
                    <set_value name="$ObjectiveStep" exact="1" operation="add"/>
                    <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep"/>
                    <set_value name="$AllowConversationEscape" exact="false"/>
                  </actions>
                </cue>

                <cue name="Ch4_ThroneRoom_Curb_Talk" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$CurbActor"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <add_player_choice text="{30221,4061}" section="c_meetpatriarch" comment="(Player Choice)When can I meet your Patriarch?" highlighted="true"/>
                  </actions>
                </cue>

                <cue name="Ch4_ThroneRoom_Curb_Talk_Meet_Patriarch" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$CurbActor" section="c_meetpatriarch" />
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line line="30221417" hidechoices="true" comment="Patriarchs? Ha!"/>
                    <add_npc_line line="30221418" hidechoices="true" comment="Only dead Patriarchs here."/>
                    <add_npc_line line="30221419" hidechoices="true" comment="This Cabal of Curbs."/>
                    <add_npc_line line="30221420" hidechoices="true" comment="Curbs leave shackles of Patriarchy and bring Ghus t'Gllt vision to conclusion."/>
                    <add_npc_line speaker="$DalBusta" hidechoices="true">
                      <text line="30221425" comment="That.. wow... that is unprecedented."/>
                      <text line="30221426" comment="They're rebelling not only against the Zyarth Patriarchy, but also against their own Patriarchs!"/>
                      <text line="30221427" comment="I'll start looking into the local Curbs and try to identify which might have worked against their Patriarch's interests."/>
                    </add_npc_line>
                    <add_player_choice section="g_cancel" selectable="$AllowConversationEscape" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" tooltip="if $AllowConversationEscape then '' else {30221,1162}"/>
                    <add_player_choice text="{30221,4054}" section="c_ghusvision" comment="Ghus' vision?"/>
                    <add_player_choice text="{30221,4053}" section="c_nextstep" comment="What's the next step?" highlighted="true"/>
                    <add_player_choice text="{30221,4055}" section="c_collude" comment="You collude with Argon slaves?"/>
                  </actions>
                </cue>

                <cue name="Ch4_ThroneRoom_Curb_NextStep" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$CurbActor" section="c_nextstep" />
                  </conditions>
                  <actions>
                    <set_value name="$AllowConversationEscape" exact="true"/>
                    <add_npc_line line="30221440" hidechoices="true" comment="With Patriarchy occupation weakened, we focus on logistics."/>
                    <add_npc_line line="if player.entity.isfemale then 30221442 else 30221441" hidechoices="true" comment="Pilot deliver fleet."/>
                    <add_npc_line line="30221443" hidechoices="true" comment="Details later."/>
                    <add_player_choice section="g_cancel" selectable="$AllowConversationEscape" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" tooltip="if $AllowConversationEscape then '' else {30221,1162}"/>
                    <add_player_choice text="{30221,4054}" section="c_ghusvision" comment="Ghus' vision?"/>
                    <add_player_choice text="{30221,4053}" section="c_nextstep" comment="What's the next step?"/>
                    <add_player_choice text="{30221,4055}" section="c_collude" comment="You collude with Argon slaves?"/>
                  </actions>
                </cue>

                <cue name="Ch4_ThroneRoom_Curb_GhusVision" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$CurbActor" section="c_ghusvision" />
                  </conditions>
                  <actions>
                    <do_if value="$AllowConversationEscape">
                      <allow_conversation_escape enabled="true" comment="doesn't accept variables"/>
                    </do_if>
                    <do_else>
                      <allow_conversation_escape enabled="false" comment="doesn't accept variables"/>
                    </do_else>
                    <add_npc_line line="30221444" hidechoices="true" comment="To finally curb not only Patriarchs, but Split society!"/>
                    <add_npc_line line="30221445" hidechoices="true" comment="Curbs tired of playing politics from shadows."/>
                    <add_npc_line line="30221446" hidechoices="true" comment="Free Families Patriarchs failed to expel Zyarth's Patriarchy!"/>
                    <add_npc_line line="30221447" hidechoices="true" comment="Victory is for Curbs."/>
                    <add_player_choice section="g_cancel" selectable="$AllowConversationEscape" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right" tooltip="if $AllowConversationEscape then '' else {30221,1162}"/>
                    <add_player_choice text="{30221,4054}" section="c_ghusvision" comment="Ghus' vision?"/>
                    <add_player_choice text="{30221,4053}" section="c_nextstep" comment="What's the next step?" highlighted="not $AllowConversationEscape"/>
                    <add_player_choice text="{30221,4055}" section="c_collude" comment="You collude with Argon slaves?"/>
                  </actions>
                </cue>

                <cue name="Ch4_ThroneRoom_Curb_Collude" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$CurbActor" section="c_collude" />
                  </conditions>
                  <actions>
                    <do_if value="$AllowConversationEscape">
                      <allow_conversation_escape enabled="true" comment="doesn't accept variables"/>
                    </do_if>
                    <do_else>
                      <allow_conversation_escape enabled="false" comment="doesn't accept variables"/>
                    </do_else>
                    <do_if value="not $CurbSaid.indexof.{30221448}">
                      <set_value name="$Achievement_Informed_On_Slavery" exact="1" operation="add"/>
                    </do_if>
                    <append_to_list name="$CurbSaid" exact="30221448"/>
                    <add_npc_line line="30221448" hidechoices="true" comment="Escaped slave returns to free others."/>
                    <add_npc_line line="30221449" hidechoices="true" comment="Slave rebellions force Patriarchy to comprimise. Force slave right bills to quell insurgent Argons."/>
                    <add_npc_line line="30221450" hidechoices="true" comment="Old Zyarth like compromise. Kept him alive."/>
                    <add_npc_line line="30221451" hidechoices="true" comment="Slave rights anger Free Families and increase our numbers."/>
                    <add_npc_line line="30221452" hidechoices="true" comment="Under Patriarchy oppression, escaped slave welcome to free more."/>
                    <add_npc_line line="30221453" hidechoices="true" comment="Old Zyarth's compromises weaken Patriarchy."/>
                    <add_player_choice section="g_cancel" selectable="$AllowConversationEscape" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                    <add_player_choice text="{30221,4054}" section="c_ghusvision" comment="Ghus' vision?"/>
                    <add_player_choice text="{30221,4053}" section="c_nextstep" comment="What's the next step?" highlighted="not $AllowConversationEscape"/>
                    <add_player_choice text="{30221,4055}" section="c_collude" comment="You collude with Argon slaves?"/>
                  </actions>
                </cue>

                <cue name="Ch4_ThroneRoom_Dal_Dialog">
                  <conditions>
                    <check_any>
                      <event_speak_line_finished actor="$CurbActor" line="30221440" comment="unreliable"/>
                      <event_conversation_finished actor="$CurbActor" comment="conversation escape is allowed at this point"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.await" text="{30220,3014}" comment="(objective.await)Further Instructions"/>
                  </actions>
                  <cues>

                    <cue name="Ch4_ThroneRoom_Dal_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor" checktime="player.age + 3s">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$Dal2CutsceneKey"/>
                      <!--<param name="Lines"             value="[[30221501], [30221502], [30221503], [30221504],
                                                              [30221507], [30221508], [30221509], [30221510],
                                                              [if player.entity.isfemale then 30221506 else 30221505]]"/>-->
                      <param name="Lines"             value="[[30221501], [30200201], [30221502], [30221503], [30200251],
                             
                                                              [30200252],[30200205],[30200253]]"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="EndSignalCue"      value="Ch4_ThroneRoom_Completed"/>
                      <!--
                      <t id="30221501">Right, I think that's all we need to know for now.</t>
                   NEW<text line="30200201" comment="As predicted, your choice has created a series of opportunities for us to influence the political landscape of the Gate network to our liking."/>
                      <t id="30221502">Both, the Zyarth Patriarchy and the Cabal of Curbs have a chance of uniting the Free Families under their rule.</t>
                      <t id="30221503">Maybe not all of the Free Families; there are still the occasional pirate bands and mob bosses.</t>
                   NEW<text line="30200251" comment="Given enough time and effort, we can decide the outcome of this conflict in favour of either the Patriarchy or the Curbs."/>
                   
                   x   <t id="30221504">Anyway, it's time to decide whose effort we are going support.</t>
                    x    <t id="30221507">A stronger Patriarchy would have more resources to fight the Argon Federation, its allies, and whoever else they might decide to fight one day.</t>
                     x   <t id="30221508">The Curbs, on the other hand, would be an additional enemy for the Patriarchy, which could relieve the pressure on the Patriarchy's other foes.</  t>
                      x  <t id="30221509">Our choice comes down to strenghtening or weakening the Patriarchy.</t>
                       x <t id="30221510">Both options have their merits.</t>
                      x<t id="30221505">You'd better meet me to discuss this.</t>
                      x<t id="30221506">(spoken to female 'you'){,30221505}</t>                     
                      
                      
                   NEW<text line="30200252" comment="But for now, feel free to lean back for a while and brood over our discovery."/>
                   NEW<text line="30200205" comment="Even Boso would agree that you've earned it."/>
                  x NEW<text line="30200206" comment="You know where to find me once you're ready to spend your hard-earned credits."/>
                   NEW<text line="30200253" comment="You know where to find me once you're ready to support either faction with substantial investments."/>  
                    -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_ThroneRoom_Completed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch5_Choose"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Ch5_Choose_DEBUG">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_object_active object="$FuneralGate" activate="true"/>
            <create_mission cue="$MissionCue" name="{30221,5001}" description="if player.entity.isfemale then {30221,5003} else {30221,5002}" rewardtext="{30221,5099}" type="missiontype.plot" faction="faction.freesplit" abortable="false"
                                    icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name" group="missiongroup.story_split">
              <briefing>
                <objective step="1" action="objective.retreat" text="$ThroneRoom_Interior.knownname" object="$BoneYardAccelerator_InTo"/>
                <objective step="2" action="objective.talkto" object="$CurbActor"/>
                <objective step="3" action="objective.talkto" object="$DalBusta"/>
              </briefing>
            </create_mission>
            <set_value name="$ObjectiveStep" exact="2"/>
            <signal_cue cue="Dal_Dialog_Option_Split_Story" check="false"/>
            <signal_cue cue="Ch5_Choose"/>
          </actions>
        </cue>

        <cue name="Ch5_Choose" comment="Text IDs 500">
          <!-- 1. Meet Dal closeby for Dialogue & Choice -->
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!--<cancel_cue cue="Ch3_Police_Snitch"/>-->
            <cancel_cue cue="Ch4_Collaborate"/>
            <set_value name="$ObjectiveStep" exact="1" operation="add"/>
            <update_mission cue="$MissionCue" description="if player.entity.isfemale then {30221,5011} else {30221,5010}"/>
            <set_objective_from_briefing cue="$MissionCue" step="$ObjectiveStep" comment="Talk To: Dal Busta"/>
            <set_userdata storystate="'story_split_faction_decision'" value="1"/>
          </actions>
          <cues>
            <cue name="Ch5_Story_Reminder" checkinterval="1s" onfail="cancel">
              <conditions>
                <check_value value="Ch5_Dal_Player_Conversation_Started.state == cuestate.waiting"/>
              </conditions>
              <cues>
                <cue name="Ch5_Story_Reminder_v2_Ref" ref="md.Story_Paranid.Story_Reminder">
                  <param name="Actor"       value="$DalBusta"/>
                  <param name="CutsceneKey" value="$Dal2CutsceneKey"/>
                  <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30200108 else 30200107]]"/>
                  <param name="CancelCue"   value="Ch5_Dal_Player_Conversation_Started"/>
                  <param name="Delay"       value="20min"/>
                  <!--  <t id="30200001">Hey there partner.</t>
                                <t id="30200002">(spoken to female player){10111,30200001}</t>
                                <t id="30200105">Don't keep our contact waiting for too long.</t>
                                <t id="30200106">(spoken to female player){,30200105}</t>
                                <t id="30200107">Where have you wandered off to?</t>
                                <t id="30200108">(spoken to female player 'you'){,30200107}</t>    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_Dal_Player_Conversation_Started">
              <conditions>
                <event_cue_signalled/>
              </conditions>
            </cue>

            <cue name="Ch5_Dal_Choose_Side_Dialog" instantiate="true">
              <conditions>
                <check_any>
                  <event_conversation_next_section section="story_split"/>
                  <event_conversation_returned_to_section section="story_split" />
                </check_any>
                <check_value value="event.object == $DalBusta"/>
              </conditions>
              <actions>
                <!-- Voice Lines -->
                <do_if value="event.param2 == null and @$ShowPlayerChoices != 'decision'">
                  <do_if value="Ch5_Dal_Player_Conversation_Started.state == cuestate.waiting">
                    <signal_cue cue="Ch5_Dal_Player_Conversation_Started"/>
                  </do_if>
                  <set_value name="$ShowPlayerChoices" exact="'main'"/>
                  <!--<add_npc_line speaker="$DalBusta" hidechoices="true">
                    <text line="30221502" comment="Both, the Zyarth Patriarchy and the Cabal of Curbs have a chance of uniting the Free Families under their rule."/>
                    <text line="30221503" comment="Maybe not all of the Free Families; there are still the occasional pirate bands and mob bosses."/>
                    <text line="30221504" comment="Anyway, it's time to decide whose effort we are going support."/>
                  </add_npc_line>-->
                  <add_npc_line speaker="$DalBusta" hidechoices="true">
                    <text line="30200207" comment="Ready to make a change?"/>
                    <text line="30200208" comment="All right, here's how it's going to work."/>
                    <text line="30200209" comment="I've taken the liberty of dividing our diplomatic effort into a few clear-cut steps."/>
                    <text line="30200210" comment="Each step will require serious investment and decisive action. Don't expect change to come at the push of a button."/>
                    <text line="30200211" comment="I'll always do my best to predict the political and economic outcome, so that you can gauge whether it's worth your time and effort."/>
                    <text line="30200212" comment="Have a glance at your briefing and personal log whenever you're uncertain; I'll sneak in a few comments before and after each step is complete."/>
                    <text line="30200213" comment="Of course, once you're happy with the results, you can always pull back and leave the involved factions to their own devices."/>
                    <text line="30200214" comment="There's no need to work through the entire process immediately, or even at all."/>
                    <text line="30200215" comment="Capital! Let's take a look at the current state of affairs."/>
                  </add_npc_line>
                  <!--                  
                  <add_npc_line speaker="$DalBusta" hidechoices="true">
                   <text line="30200250" comment="Anyway, we have the unique opportunity to influence the emerging political landscape to our liking."/>
                   <text line="30200260" comment="We need to consider our options and decide which of the factions we intend to support."/>
                  </add_npc_line>
                  -->

                </do_if>
                <do_elseif value="event.param2 == 'ch5_main'">
                  <set_value name="$ShowPlayerChoices" exact="'main'"/>
                </do_elseif>
                <do_elseif value="event.param2 == 'ch5_achieve'">
                  <add_npc_line speaker="$DalBusta" hidechoices="true">
                    <text line="30221502" comment="Both, the Zyarth Patriarchy and the Cabal of Curbs have a chance of uniting the Free Families under their rule."/>
                    <text line="30221503" comment="Maybe not all of the Free Families; there are still the occasional pirate bands and mob bosses."/>
                    <text line="30221507" comment="A stronger Patriarchy would have more resources to fight the Argon Federation, its allies, and whoever else they might decide to fight one day."/>
                    <text line="30221508" comment="The Curbs, on the other hand, would be an additional enemy for the Patriarchy, which could relieve the pressure on the Patriarchy's other foes."/>
                    <text line="30221509" comment="Our choice comes down to strenghtening or weakening the Patriarchy."/>
                    <text line="30221510" comment="Both options have their merits."/>
                  </add_npc_line>
                </do_elseif>
                <do_elseif value="event.param2 == 'ch5_side_with_slaves'">
                  <set_value name="$Achievement_Informed_On_Slavery" exact="1" operation="add"/>
                  <do_if value="$Achievement_Informed_On_Slavery ge 4">
                    <unlock_achievement name="SV_LEARN_SLAVERY"/>
                  </do_if>
                  <add_npc_line speaker="$DalBusta" hidechoices="true">
                    <text line="30221519" comment="That sort of cultural change is too big for them to swallow, and far from popular with the Split."/>
                    <text line="30221532" comment="It is a society based on thralls and slave labour after all."/>
                    <text line="30221512" comment="The Patriarchy will enact slave rights, but only until their Argon enemies are defeated."/>
                    <text line="30221513" comment="Afterwards they probably backtrack on it."/>
                    <text line="30221514" comment="If the Patriarchy is overthrown, they'll abolish those rights even faster."/>
                    <text line="30221520" comment="Patriarchy stations do treat the enslaved a bit better, but as long as there are Split stations there won't be an end to slavery."/>
                    <text line="30221515" comment="The Curbs, on the other hand, support slave revolts, but only until the Patriarchy is driven out."/>
                    <text line="30221516" comment="They have no genuine interest in helping them."/>
                    <text line="30221517" comment="So to help the slaves, the first priority is to not let the Patriarchy fall, and to support them in defeating the Curbs."/>
                  </add_npc_line>
                </do_elseif>
                <do_elseif value="event.param2 == 'ch5_task'">
                  <add_npc_line speaker="$DalBusta" hidechoices="true">
                    <text line="30221521" comment="Either way, we're delivering a fleet. It's just that in one case it will be riddled with bombs, which they're clearly not going to like."/>
                    <text line="if player.entity.isfemale then 30221531 else 30221522" comment="Also, if you side with the Patriarchy then we'll need to inform their authorities, to coordinate our efforts and reap any rewards."/>
                  </add_npc_line>
                </do_elseif>
                <do_elseif value="event.param2 == 'ch5_pat'">
                  <set_value name="$ShowPlayerChoices" exact="'done'"/>
                  <add_npc_line speaker="$DalBusta" hidechoices="true">
                    <text line="30220984" comment="Excellent"/>
                    <text line="if player.entity.isfemale then 30221525 else 30221524" comment="You meet with the Patriarchy Police. I'll set up a meeting."/>
                  </add_npc_line>

                  <remove_mission cue="$MissionCue" type="completed"/>
                  <write_to_logbook category="missions" faction="faction.player" title="{30221,5001}" text="if player.entity.isfemale then {30221,5005} else {30221,5004}"/>

                  <signal_cue_instantly cue="Ch6_Sink" param="'Patriarchy'"/>
                </do_elseif>
                <do_elseif value="event.param2 == 'ch5_curbs'">
                  <set_value name="$ShowPlayerChoices" exact="'done'"/>
                  <add_npc_line speaker="$DalBusta" hidechoices="true">
                    <text line="30221526" comment="Very well. I'll monitor the Curb's missions and any Patriarchy chatter to make sure they're not planning any successful raids."/>
                    <text line="if player.entity.isfemale then 30221528 else 30221527" comment="You just wait until they come up with their fleet requirements."/>
                    <text line="if player.entity.isfemale then 30221529 else 30221530" comment="Oh, and keep some caviar handy. You're probably going to need it."/>
                  </add_npc_line>

                  <remove_mission cue="$MissionCue" type="completed"/>
                  <write_to_logbook category="missions" faction="faction.player" title="{30221,5001}" text="if player.entity.isfemale then {30221,5007} else {30221,5006}"/>

                  <signal_cue_instantly cue="Ch6_Sink" param="'Curbs'"/>
                </do_elseif>

                <!-- (Back) out of Player Choices -->
                <do_if value="($ShowPlayerChoices == 'main')">
                  <add_player_choice section="stories" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                  <add_player_choice section="story_split" choiceparam="'ch5_achieve'"          highlighted="false" text="{30221,5051}" comment="(Player Choice)What can we achieve?"/>
                  <add_player_choice section="story_split" choiceparam="'ch5_side_with_slaves'" highlighted="false" text="{30221,5052}" comment="(Player Choice)Can I side with the slaves?"/>
                  <add_player_choice section="story_split" choiceparam="'ch5_task'"             highlighted="false" text="{30221,5055}" comment="(Player Choice)What do we need to do?"/>
                  <add_player_choice_sub section="story_split_decision_briefing"                highlighted="true"  text="{30221,5058}" comment="(Player Choice)I have made up my mind."/>
                </do_if>
                <do_elseif value="($ShowPlayerChoices == 'decision')">
                  <add_player_choice section="story_split" choiceparam="'ch5_main'" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                  <add_player_choice section="story_split" choiceparam="'ch5_pat'"              highlighted="true"  text="{30221,5056}" comment="(Player Choice)I side with the Patriarchy."/>
                  <add_player_choice section="story_split" choiceparam="'ch5_curbs'"            highlighted="true"  text="{30221,5057}" comment="(Player Choice)I side with the Curbs."/>
                </do_elseif>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Ch5_Dal_Choose_Side_Dialog_Briefing" instantiate="true">
          <!-- Show the Mission Briefing -->
          <conditions>
            <event_conversation_next_section section="story_split_decision_briefing"/>
            <check_value value="event.object == $DalBusta"/>
          </conditions>
          <actions>
            <set_value name="$descr" exact="if player.entity.isfemale then ({30221,5013} + ' ' + {30221,5101}) else ({30221,5012} + ' ' + {30221,5100})"/>

            <set_value name="$descr" exact="$descr + '\n\n' + (if player.entity.isfemale then {30221,5103} else {30221,5102})" comment="Support the Curb Rebellion"/>
            <set_value name="$descrSinkCurb" exact="'\n' + {30221,9100} + ' ' + {30221,9101} + ' ' + {30221,9102}" comment="effect info CUB1"/>
            <set_value name="$descr" exact="$descr + '\n' + $descrSinkCurb " comment="effect info CUB1"/>

            <set_value name="$descr" exact="$descr + '\n\n' + (if player.entity.isfemale then {30221,5105} else {30221,5104})" comment="Strengthen the Zyarth Patriarchy"/>
            <set_value name="$descrSinkPat" exact="'\n' + {30221,9113} + ' ' + {30221,9114} + ' ' + {30221,9115} + ' ' + {30221,9116}" comment="effect info ZYA1"/>
            <set_value name="$descr" exact="$descr + '\n' + $descrSinkPat" comment="effect info ZYA1"/>
            <update_mission cue="$MissionCue" description="$descr"/>

            <open_conversation_menu menu="MissionBriefingMenu" param="[0, 0, $MissionCue, false]" />
            <set_value name="$ShowPlayerChoices" exact="'decision'"/>
          </actions>
        </cue>

        <cue name="Debug_Ch6_Patriarchy">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$descrSinkPat" exact="'\n\n' + {30221,9113} + ' ' + {30221,9114} + ' ' + {30221,9115} + ' ' + {30221,9116}" comment="effect info ZYA1"/>
            <signal_cue_instantly cue="Ch6_Sink" param="'Patriarchy'"/>
          </actions>
        </cue>

        <cue name="Debug_Ch6_Curbs">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$descrSinkCurb" exact="'\n\n' + {30221,9100} + ' ' + {30221,9101} + ' ' + {30221,9102}" comment="effect info CUB1"/>
            <add_inventory ware="ware.inv_spaceflycaviar" exact="1"/>
            <signal_cue_instantly cue="Ch6_Sink" param="'Curbs'"/>
          </actions>
        </cue>

        <cue name="Ch6_Sink" comment="Text IDs 600" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <unlock_achievement name="SV_PLOT_SPLIT"/>

            <cancel_cue cue="Ch5_Choose"/>
            <cancel_cue cue="Dal_Dialog_Option_Split_Story"/>

            <set_object_active object="$FuneralGate" activate="true"/>

            <set_value name="$CurrentStep" exact="1"/>
            <set_value name="$PlayerChose" exact="event.param"/>

            <do_if value="$PlayerChose == 'Patriarchy'">
              <signal_cue_instantly cue="Police_Rattlesnake" param="[$HeartOfAcrimonySector]"/>
              <set_object_min_hull object="$PoliceRattleSnake" exact="50"/>
              <create_position name="$TargetOffset" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="20km"/>
              <create_order id="'MoveWait'" object="$PoliceRattleSnake" default="true">
                <param name="destination" value="[$PoliceRattleSnake.sector, $TargetOffset]"/>
                <param name="debugchance" value="$DeepDebugChance"/>
              </create_order>

              <set_object_docking_enabled object="$PoliceRattleSnake" enabled="true"/>
              <!-- PLACE Loyalist -->
              <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $LoyalistActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $PoliceRattleSnake,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
              <!-- Patriarchy Mission -->
              <set_object_name object="$LoyalistActor" page="30221" line="159" comment="Zyarth Secret Police"/>
              <!-- Mission: Fires of Fate -->
              <set_value name="$descr" exact="if player.entity.isfemale then {30221,6103} else {30221,6102}"/>
              <create_mission cue="$MissionCue" name="{30221,6101}" faction="faction.player" type="missiontype.plot" abortable="false" group="missiongroup.story_split_zyarth"
                              description="$descr + $descrSinkPat" rewardtext="{30221,6199}" difficulty="level.veryhard"
                                    icon="'briefing_fau_t_nnt_01'" iconcaption="$LoyalistActor.name">
                <briefing>
                  <objective step="1" action="objective.talkto" object="$LoyalistActor"/>
                </briefing>
              </create_mission>
              <set_value name="$CurrentStep" exact="1"/>
              <signal_cue_instantly cue="md.GenericMissions.DisconnectedActorObjectiveLibrary" param="table[
                                              $actor = $LoyalistActor,
                                              $object = $PoliceRattleSnake,
                                              $missioncue = $MissionCue,
                                              $cancelcue = Ch6_Rigged_Fleet_Mission,
                                              $libfailedcue = null,
                                              $objective = objective.talkto,
                                              $debugchance = $DebugChance]"/>
              <!--<set_objective_from_briefing step="1" cue="$MissionCue"/>-->
            </do_if>
            <do_else>
              <!-- Mission: Declaration of Curbs Curb Mission -->
              <set_value name="$descr" exact="if player.entity.isfemale then {30221,6203} else {30221,6202}"/>
              <create_mission cue="$MissionCue" name="{30221,6201}" faction="faction.player" type="missiontype.plot" abortable="false" group="missiongroup.story_split_court"
                              description="$descr + $descrSinkCurb" rewardtext="{30221,6299}" difficulty="level.veryhard"
                                    icon="'briefing_yu_t_knk_01'" iconcaption="$OutcastActor.name">
                <briefing>
                  <objective step="1" action="objective.await" text="{30220,3014}" comment="(objective.await)Further Instructions"/>
                </briefing>
              </create_mission>
              <set_value name="$CurrentStep" exact="1"/>
              <set_objective_from_briefing step="1" cue="$MissionCue"/>
            </do_else>
          </actions>
          <patch sinceversion="2" state="complete">
            <cancel_cue cue="Dal_Dialog_Option_Split_Story"/>
          </patch>
          <patch sinceversion="2" state="cancelled">
            <cancel_cue cue="Dal_Dialog_Option_Split_Story"/>
          </patch>
          <cues>
            <cue name="Ch6_Init">
              <actions>
                <do_if value="$PlayerChose == 'Patriarchy'">
                  <signal_cue cue="Ch6_Patriarchy_Dialog"/>
                </do_if>
                <do_else>
                  <signal_cue cue="Ch6_Both_Fleet_Delivery"/>
                </do_else>
              </actions>
            </cue>

            <cue name="Ch6_Patriarchy_Dialog">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- Talk To Loyalist -->
              <actions>
              </actions>
              <cues>
                <cue name="Ch6_Loyalist_Dialog" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$LoyalistActor"/>
                      <event_conversation_next_section section="story_split" actor="$LoyalistActor"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.param2 == null">
                      <set_object_name object="$LoyalistActor" page="30221" line="103" comment="Fau t'Nnt"/>
                      <set_value name="$ShowPlayerChoices" exact="'main'"/>
                      <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                        <text line="if player.entity.isfemale then 30221602 else 30221601" comment="Split heard you have information on terrorists."/>
                      </add_npc_line>
                    </do_if>
                    <do_elseif value="event.param2 == 'back_out'">
                      <set_value name="$ShowPlayerChoices" exact="''"/>
                      <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                        <text line="if player.entity.isfemale then 30221304 else 30221303" comment="(Disappointed)You remain failure."/>
                      </add_npc_line>
                    </do_elseif>
                    <do_elseif value="event.param2 == 'ch6_rebellion'">
                      <set_value name="$ShowPlayerChoices" exact="''"/>
                      <add_npc_line speaker="$LoyalistActor" hidechoices="true">
                        <text line="30221603" comment="Very concerning."/>
                        <text line="30221604" comment="Split noticed terrorist cells but underestimated them."/>
                        <text line="if player.entity.isfemale then 30221606 else 30221605" comment="Split help you deliver rigged fleet."/>
                        <text line="if player.entity.isfemale then 30221608 else 30221607" comment="Split contact Patriarchy fleet to attack at accelerator after your delivery."/>
                        <text line="if player.entity.isfemale then 30221610 else 30221609" comment="Patriarchy will compensate you."/>
                      </add_npc_line>
                      <signal_cue cue="Ch6_Rigged_Fleet_Mission"/>
                    </do_elseif>

                    <!-- Player Choices -->
                    <do_if value="$ShowPlayerChoices == 'main'">
                      <add_player_choice section="story_split" choiceparam="'back_out'" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                      <add_player_choice section="story_split" choiceparam="'ch6_rebellion'" text="{30221,6051}" comment="(Player Choice)They are preparing a rebellion!"/>
                    </do_if>
                  </actions>
                </cue>
                <cue name="Ch6_Rigged_Fleet_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_Loyalist_Finished_Talking">
                      <conditions>
                        <event_conversation_finished actor="$LoyalistActor"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch6_Loyalist_Dialog"/>
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,3014}" comment="(objective.await)Further Instructions" updatebriefing="true"/>
                        <signal_cue cue="Ch6_Both_Fleet_Delivery"/>

                        <do_if value="faction.player.relationto.{faction.split} lt (faction.player.relation.dock.min - 0.001)">
                          <get_suitable_job result="$locColonialJobs" faction="faction.split" tags="tag.colonial" exceedquota="true" multiple="true"/>
                          <do_for_each name="$locjob" in="$locColonialJobs">
                            <find_ship groupname="$Colonial" space="player.galaxy" job="$locjob" multiple="true" append="true"/>
                          </do_for_each>
                          <remove_value name="$locColonialJobs"/>
                          <!-- Set 'friendly' relation to make it easier to deliver the fleet -->

                          <do_for_each in="$Colonial" name="$c">
                            <reset_relation_boost object="$c" faction="faction.player"/>
                            <set_relation_boost faction="faction.player" object="$c" value="faction.player.relation.dock.min - 0.001" comment="docking is barely not allowed"/>
                            <do_for_each in="$c.allsubordinates" name="$sub">
                              <do_if value="$sub.isoperational and $sub.isclass.ship and not $sub.isdeployable">
                                <reset_relation_boost object="$sub" faction="faction.player"/>
                                <set_relation_boost faction="faction.player" object="$sub" value="faction.player.relation.dock.min - 0.001" comment="docking is barely not allowed"/>
                              </do_if>
                            </do_for_each>
                          </do_for_each>

                        </do_if>


                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Both_Fleet_Delivery">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- Patriarchy Case: Other Location, SAbotage-Cutscene (patriarchy ships dock, space suit people), fleet will remain out of players control and go where it's supposed to go -->
              <cues>
                <cue name="Ch6_Deliver_Delay">
                  <delay exact="30s"/>
                  <actions>
                    <signal_cue cue="Ch6_Deliver_Fleet_Specs"/>
                  </actions>
                </cue>
                <cue name="Ch6_Deliver_Fleet_Specs">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_Deliver_Fleet_Specs_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$OutcastActor"/>
                      <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30221602 else 30221601],
                                                                  [30221603],
                                                                  [if player.entity.isfemale then 30221607 else 30221606],
                                                                  [if player.entity.isfemale then 30221605 else 30221604],
                                                                  [30221608]]"/>
                      <param name="EndSignalCue"      value="Ch6_Deliver_Fleet_Setup"/>
                      <!--
                      <t id="30221601">Split pleased to see you.</t>
                      <t id="30221602">(spoken to female 'you'){,30221601}</t>
                      <t id="30221603">Sending fleet specifications now.</t>
                      <t id="30221604">Pilot formally invited to declaration of Curbs.</t>
                      <t id="30221605">(spoken to female 'Pilot'){,30221604}</t>
                      <t id="30221606">Bring requested fleet and report back to accelerator.</t>
                      <t id="30221607">(spoken to female 'you'){,30221606}</t>
                      <t id="30221608">Split celebrate Court of Curbs there! Politically capable and good.</t>-->
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch6_Deliver_Fleet_Setup" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- 
                        Supplier    ~ 30    mil Cr each | 2x =>  60   mil Cr
                        Destroyer   ~ 23    mil Cr each | 5x => 115   mil Cr
                        Corvette    ~ 2,8   mil Cr each | 8x =>  22,4 mil Cr
                                                        TOTAL ~ 197   mil Cr
                                                        
                                                        Changed to a target of ~50 mil Cr
                                                        10*Corvette, 1x Destroyer
                    -->
                    <set_value name="$Fleet" exact="[
                          table[
                            $macro = macro.ship_spl_l_destroyer_01_a_macro,
                            $amount = 1,
                            $equipment = [
                                            macro.engine_spl_l_travel_01_mk1_macro,
                                            macro.weapon_spl_l_destroyer_01_mk1_macro,
                                            macro.shield_spl_l_standard_01_mk1_macro,
                                            macro.shield_spl_m_standard_02_mk1_macro,
                                            macro.turret_spl_m_flak_02_mk1_macro,
                                            macro.turret_spl_l_beam_01_mk1_macro,
                                            macro.thruster_gen_l_allround_01_mk3_macro
                            ]
                          ],
                          table[
                            $macro = macro.ship_spl_m_corvette_01_b_macro,
                            $amount = 10,
                            $equipment = [
                                            macro.engine_spl_m_combat_01_mk3_macro,
                                            macro.weapon_spl_m_gatling_01_mk2_macro,
                                            macro.shield_spl_m_standard_01_mk1_macro,
                                            macro.turret_spl_m_flak_01_mk1_macro,
                                            macro.thruster_gen_m_combat_01_mk3_macro
                            ]
                          ]
                         ]"/>

                    <do_for_each in="$Fleet" name="$Ship_Def">
                      <generate_loadout result="this.$loadout" macro="$Ship_Def.$macro" level="1.0" variation="0" macros="$Ship_Def.$equipment"/>
                      <set_value name="$Ship_Def.$equipment" exact="this.$loadout.{1}" comment="generate_loadout creates a list of loadouts"/>
                    </do_for_each>

                    <!-- Set $TextTable variables for GM briefing generation. -->
                    <set_value name="$TextTable" exact="table[]"/>

                    <set_value name="$TextTable.$objective"           exact="{30221,6153}"/>
                    <set_value name="$TextTable.$objective_transfer"  exact="{30221,6154}"/>
                    <set_value name="$TextTable.$progressbar"         exact="{30221,6155}"/>
                    <set_value name="$TextTable.$accept_transfer"     exact="{30004,5302}"/>
                    <set_value name="$TextTable.$reject_transfer"     exact="{30221,6157}"/>

                    <!-- Set $ShipCount variable so that GenerateTextTable doesn't complain. -->
                    <do_all exact="$Fleet.count" counter="$i">
                      <set_value name="$ShipCount" exact="$Fleet.{$i}.$amount" operation="add"/>
                    </do_all>

                    <run_actions ref="md.GM_GetExactFleet.ConstructFleetRequirementsText" result="$FleetText">
                      <param name="Fleet" value="$Fleet"/>
                    </run_actions>

                    <!-- Determine a delivery location closish to the Accelerator -->
                    <set_value name="$TargetSector" exact="$FuneralGate.sector"/>

                    <do_if value="$PlayerChose == 'Patriarchy'">
                      <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30221,6103} else {30221,6102}) + $descrSinkPat + '\n' + $FleetText"/>
                      <create_position name="$TargetOffset" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="20km"/>
                      <set_value name="$TargetRadius" exact="25km" comment="50km diameter should be enough to avoid stations that might be in the way."/>
                      <set_value name="$FleetDeliveryClient" exact="$LoyalistActor"/>
                      <set_value name="$FleetDeliveryFaction" exact="faction.freesplit"/>
                    </do_if>
                    <do_else comment="Curbs">
                      <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30221,6203} else {30221,6202}) + $descrSinkCurb + '\n' + $FleetText"/>
                      <create_position name="$TargetOffset" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="20km"/>
                      <set_value name="$TargetRadius" exact="20km"/>
                      <set_value name="$FleetDeliveryClient" exact="$OutcastActor" comment="needs to be a generic character"/>
                      <set_value name="$FleetDeliveryFaction" exact="faction.freesplit"/>
                    </do_else>

                    <signal_cue cue="Ch6_Deliver_Fleet_Mission"/>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="Ch6_Deliver_Fleet_Ref.state != cuestate.cancelled">
                      <set_value name="$Ch6_Deliver_Fleet_Ref_LoadoutPatch"/>

                      <!-- new fleet setup without the unsupported ammo -->
                      <set_value name="$Fleet" exact="[
                          table[
                            $macro = macro.ship_spl_l_destroyer_01_a_macro,
                            $amount = 1,
                            $equipment = [
                                            macro.engine_spl_l_travel_01_mk1_macro,
                                            macro.weapon_spl_l_destroyer_01_mk1_macro,
                                            macro.shield_spl_l_standard_01_mk1_macro,
                                            macro.shield_spl_m_standard_02_mk1_macro,
                                            macro.turret_spl_m_flak_02_mk1_macro,
                                            macro.turret_spl_l_beam_01_mk1_macro,
                                            macro.thruster_gen_l_allround_01_mk3_macro
                            ]
                          ],
                          table[
                            $macro = macro.ship_spl_m_corvette_01_b_macro,
                            $amount = 10,
                            $equipment = [
                                            macro.engine_spl_m_combat_01_mk3_macro,
                                            macro.weapon_spl_m_gatling_01_mk2_macro,
                                            macro.shield_spl_m_standard_01_mk1_macro,
                                            macro.turret_spl_m_flak_01_mk1_macro,
                                            macro.thruster_gen_m_combat_01_mk3_macro
                            ]
                          ]
                         ]"/>

                      <!-- update suggested loadout -->
                      <do_for_each in="$Fleet" name="$Ship_Def">
                        <generate_loadout result="this.$loadout" macro="$Ship_Def.$macro" level="1.0" variation="0" macros="$Ship_Def.$equipment"/>
                        <set_value name="$Ship_Def.$equipment" exact="this.$loadout.{1}" comment="generate_loadout creates a list of loadouts"/>
                      </do_for_each>

                      <!-- update briefing text to not show repair drones -->
                      <run_actions ref="md.GM_GetExactFleet.ConstructFleetRequirementsText" result="$FleetText">
                        <param name="Fleet" value="$Fleet"/>
                      </run_actions>
                      <do_if value="$PlayerChose == 'Patriarchy'">
                        <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30221,6103} else {30221,6102}) + $descrSinkPat + '\n' + $FleetText"/>
                      </do_if>
                      <do_else comment="Curbs">
                        <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30221,6203} else {30221,6202}) + $descrSinkCurb + '\n' + $FleetText"/>
                      </do_else>

                      <!-- reset delivery mission -->
                      <reset_cue cue="Ch6_Deliver_Fleet_Ref"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch6_Deliver_Fleet_Patch" onfail="cancel">
                  <conditions>
                    <check_value value="$Patch_Ch6_Deliver_Fleet_Setup?"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch6_Deliver_Fleet_Setup_Delayed"/>
                  </actions>
                </cue>
                <cue name="Ch6_Deliver_Fleet_Setup_Delayed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue cue="Ch6_Deliver_Fleet_Setup"/>
                  </actions>
                </cue>

                <cue name="Ch6_Deliver_Fleet_Mission" version="4">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                  </actions>
                  <patch sinceversion="2">
                    <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep" />
                  </patch>
                  <patch sinceversion="3" comment="Lowered delivery requirements">
                    <do_if value="Ch6_Deliver_Fleet_Mission_Completed.state == cuestate.waiting">
                      <set_value name="$CurrentStep" exact="1" operation="subtract"/>
                      <reset_cue cue="this"/>
                      <reset_cue cue="Ch6_Deliver_Fleet_Setup"/>
                      <!--<signal_cue cue="Ch6_Deliver_Fleet_Setup_Delayed"/> No corresponding listeners, Patch before child cue event-->
                    </do_if>
                  </patch>
                  <patch sinceversion="4" state="complete">
                    <set_value name="$Patch_Ch6_Deliver_Fleet_Setup"/>
                  </patch>
                  <patch sinceversion="4" state="waiting">
                    <set_value name="$Patch_Ch6_Deliver_Fleet_Setup"/>
                  </patch>
                  <cues>
                    <cue name="Ch6_Deliver_Fleet_Ref" ref="md.RML_Deliver_Fleet.DeliverFleet">
                      <param name="EndSignalCue"            value="Ch6_Deliver_Fleet_Mission_Completed"/>
                      <param name="MissionCue"              value="$MissionCue"/>
                      <param name="StartStep"               value="$CurrentStep"                    comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"          value="true"                            comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"             value="$DebugChance"/>

                      <param name="Text_MissionName"        value="if $PlayerChose == 'Patriarchy' then {30221,6101} else {30221,6201}"/>
                      <param name="Text_Objective_Get"      value="$TextTable.$objective"           comment="Objective text to get ships"/>
                      <param name="Text_Objective_Transfer" value="$TextTable.$objective_transfer"  comment="Objective text to transfer ownership"/>
                      <param name="Text_AcceptTransfer"     value="$TextTable.$accept_transfer"     comment="Player choice text to initiate transfer"/>
                      <param name="Text_RejectTransfer"     value="$TextTable.$reject_transfer"     comment="Player choice text to reject transfer"/>
                      <param name="Text_ProgressBar"        value="$TextTable.$progressbar"         comment="Progress bar text for multiple ships"/>
                      <param name="Fleet"                   value="$Fleet"                          comment="The specific fleet we are looking for"/>
                      <param name="Transfer"                value="true"                            comment="Mission ends with a transfer of ownership to $Faction. Otherwise ends when ships are in position."/>
                      <param name="Faction"                 value="$FleetDeliveryFaction"           comment="The faction to which it needs to be delivered. Required if $Transfer is true"/>
                      <param name="Client"                  value="$FleetDeliveryClient"            comment="client who wants the fleet. Required if $Transfer is true"/>
                      <param name="TargetSector"            value="$TargetSector"                   comment="Sector to which to deliver the fleet"/>
                      <param name="TargetOffset"            value="$TargetOffset"                   comment="Location to which to deliver the fleet"/>
                      <param name="TargetRadius"            value="$TargetRadius"                   comment="Radius around location in which we need to put the fleet"/>
                      <param name="CriteriaResultCue"       value="null"                            comment="Cue to signal with a table of ships with the result of the most recent processing of 'CheckMissionStatus'"/>
                      <param name="AdditionCheckCue"        value="null"                            comment="Cue to signal instantly to run additional checks on the object. event.param = [namespace, $ship]. Result saved to namespace.$CheckCueResult"/>
                      <param name="ReturnFleetShips"        value="true"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Deliver_Fleet_Mission_Completed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="this.$EndFeedbackValue != 1">
                      <debug_text text="'Fleet transfer declined. Resetting mission.'" chance="$DebugChance"/>
                      <reset_cue cue="Ch6_Deliver_Fleet_Mission_Completed"/>
                      <reset_cue cue="Ch6_Deliver_Fleet_Ref"/>
                    </do_if>
                    <do_else>
                      <set_value name="$FleetShips" exact="if Ch6_Deliver_Fleet_Mission_Completed.$FleetShips? then Ch6_Deliver_Fleet_Mission_Completed.$FleetShips else 0"/>

                      <!-- Fill Deployables so they don't want to equip-->
                      <do_for_each in="$FleetShips" name="$s">
                        <add_ammo object="$s" macro="macro.countermeasure_flares_01_macro" amount="$s.ammostorage.countermeasure.capacity"/>
                        <add_ammo object="$s" macro="macro.ship_gen_s_lasertower_01_a_macro" amount="$s.ammostorage.deployable.capacity"/>
                        <add_units object="$s" macro="macro.ship_gen_xs_repairdrone_01_a_macro" exact="$s.units.maxcount * 0.7"/>
                        <add_units object="$s" macro="macro.ship_gen_xs_cargodrone_empty_01_a_macro" exact="$s.units.maxcount * 0.3"/>
                      </do_for_each>

                      <!-- Find an XL Commander -->
                      <do_for_each in="$FleetShips" name="$s">
                        <do_if value="$s.isclass.ship_xl">
                          <set_value name="$SinkFleetCommander" exact="$s"/>
                          <break/>
                        </do_if>
                      </do_for_each>
                      <!-- No XL Commander, find Carrier -->
                      <do_if value="not $SinkFleetCommander?">
                        <do_for_each in="$FleetShips" name="$s">
                          <do_if value="[shiptype.carrier].indexof.{$s.type}">
                            <set_value name="$SinkFleetCommander" exact="$s"/>
                            <break/>
                          </do_if>
                        </do_for_each>
                      </do_if>
                      <!-- No Carrier, find destroyer -->
                      <do_if value="not $SinkFleetCommander?">
                        <do_for_each in="$FleetShips" name="$s">
                          <do_if value="[shiptype.destroyer].indexof.{$s.type}">
                            <set_value name="$SinkFleetCommander" exact="$s"/>
                            <break/>
                          </do_if>
                        </do_for_each>
                      </do_if>
                      <!-- No Destroyer, find frigate -->
                      <do_if value="not $SinkFleetCommander?">
                        <do_for_each in="$FleetShips" name="$s">
                          <do_if value="[shiptype.frigate].indexof.{$s.type}">
                            <set_value name="$SinkFleetCommander" exact="$s"/>
                            <break/>
                          </do_if>
                        </do_for_each>
                      </do_if>
                      <!-- No Frigate, find random -->
                      <do_if value="not $SinkFleetCommander?">
                        <set_value name="$SinkFleetCommander" exact="$FleetShips.random"/>
                      </do_if>

                      <do_if value="$PlayerChose == 'Patriarchy'">
                        <!-- Patriarchy -->
                        <do_for_each in="$FleetShips" name="$s">
                          <create_order id="'Wait'" object="$s" default="true">
                            <param name="noattackresponse" value="true"/>
                          </create_order>
                        </do_for_each>
                        <signal_cue cue="Ch6_Patriarchy_Rigging_Cutscene"/>
                      </do_if>
                      <do_else>
                        <!-- Curbs -->
                        <signal_cue cue="Ch6_Invitation"/>
                      </do_else>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch6_Patriarchy_Rigging_Cutscene">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>

                    <create_loadout result="$Patriarchy_S_Light">
                      <macros>
                        <engine macro="engine_spl_s_combat_01_mk4_macro" path="../con_engine_03"/>
                        <engine macro="engine_spl_s_combat_01_mk4_macro" path="../con_engine_02"/>
                        <weapon macro="weapon_spl_s_railgun_01_mk2_macro" path="../con_weapon_04"/>
                        <weapon macro="weapon_spl_s_railgun_01_mk2_macro" path="../con_weapon_03"/>
                        <weapon macro="weapon_spl_s_railgun_01_mk2_macro" path="../con_weapon_02"/>
                        <shield macro="shield_spl_s_standard_01_mk3_macro" path="../con_shield_01"/>
                      </macros>
                      <software>
                        <software ware="software_dockmk1"/>
                        <software ware="software_flightassistmk1"/>
                        <software ware="software_scannerlongrangemk1"/>
                        <software ware="software_scannerobjectmk1"/>
                        <software ware="software_targetmk1"/>
                      </software>
                      <virtualmacros>
                        <thruster macro="thruster_gen_s_combat_01_mk3_macro"/>
                      </virtualmacros>
                    </create_loadout>

                    <do_for_each in="$FleetShips" name="$s">
                      <do_if value="$s == $SinkFleetCommander" comment="Special Case - We want more ships docking on the Commander for cutscene close-up">
                        <find_dockingbay name="$sDocks" object="$s" checkoperational="true" multiple="true">
                          <match_dock size="tag.dock_s"/>
                        </find_dockingbay>

                        <do_if value="$sDocks.count">
                          <!-- Ship has a dock, spawn a ship which docks on it -->
                          <!--<create_ship-->
                          <!-- ship spl s figher 02 a macro -->
                          <do_all exact=" if $sDocks.count le 5 then $sDocks.count else 6" counter="$dock">
                            <create_ship name="$RiggingCommanderShip" groupname="$RiggingShips" macro="ship_spl_s_fighter_02_a_macro"
                                    commandeerable="false" missioncue="namespace" sector="$s.sector">
                              <owner exact="faction.split"/>
                              <paint ware="$SplitPaintMods.$splitCover"/>
                              <pilot>
                                <select faction="faction.split" tags="tag.fighterpilot"/>
                              </pilot>
                              <loadout loadout="$Patriarchy_S_Light"/>
                              <position x="$sDocks.{$dock}.launchpos.x" y="$sDocks.{$dock}.launchpos.y + 0.4km" z="$sDocks.{$dock}.launchpos.z - 0.3km" object="$sDocks.{$dock}"/>
                            </create_ship>
                            <set_value name="$ShipAmount" operation="add" exact="1"/>
                            <set_object_relation_behaviour object="$RiggingCommanderShip" disable="true"/>
                            <create_order object="$RiggingCommanderShip" id="'DockAndWait'">
                              <param name="destination" value="$s" comment="stay docked for the cutscene"/>
                            </create_order>
                          </do_all>
                        </do_if>
                      </do_if>
                      <do_else>
                        <find_dockingbay name="$sDock" object="$s" checkoperational="true" multiple="false">
                          <match_dock size="tag.dock_s"/>
                        </find_dockingbay>
                        <do_if value="$sDock">
                          <!-- Ship has a dock, spawn a ship which docks on it -->
                          <!--<create_ship-->
                          <!-- ship spl s figher 02 a macro -->
                          <create_ship name="$RiggingShip" groupname="$RiggingShips" macro="ship_spl_s_fighter_02_a_macro"
                                       commandeerable="false" missioncue="namespace" sector="$s.sector">
                            <owner exact="faction.split"/>
                            <paint ware="$SplitPaintMods.$splitCover"/>
                            <pilot>
                              <select faction="faction.split" tags="tag.fighterpilot"/>
                            </pilot>
                            <loadout loadout="$Patriarchy_S_Light"/>
                            <position x="$sDock.launchpos.x" y="$sDock.launchpos.y + 0.3km" z="$sDock.launchpos.z - 0.3km" object="$sDock"/>
                          </create_ship>
                          <set_value name="$ShipAmount" operation="add" exact="1"/>
                          <set_object_relation_behaviour object="$RiggingShip" disable="true"/>
                          <create_order object="$RiggingShip" id="'DockAndWait'">
                            <param name="destination" value="$s" comment="stay docked for the cutscene"/>
                          </create_order>
                        </do_if>
                      </do_else>
                    </do_for_each>
                    <debug_text text="'Ships spawned: ' + $ShipAmount" chance="$DebugChance"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_Patriarchy_Rigging_Commander_Assigned">
                      <conditions>
                        <event_object_dock_assigned object="$RiggingCommanderShip"/>
                      </conditions>
                      <actions>
                        <!--Make sure the camera focuses on a dock that is actually used-->
                        <set_value name="$SinkFleetRiggingDock" exact="$RiggingCommanderShip.assigneddock"/>
                        <signal_cue cue="Ch6_Patriarchy_Rigging_Trigger_Cutscene"/>
                      </actions>
                    </cue>
                    <cue name="Ch6_Patriarchy_Rigging_Trigger_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$CutsceneKey" exact="'story_split_rigging_ships'"/>
                        <play_cutscene key="$CutsceneKey" result="this.$CutsceneID" abortable="false">
                          <param name="targetship"        object="$SinkFleetCommander"/>
                          <param name="targetobject"      object="$SinkFleetRiggingDock"/>
                          <param name="orbitdist"         number="($SinkFleetCommander.length * 0.1)"/>
                          <param name="orbitelevation"    number="800"/>
                        </play_cutscene>
                      </actions>
                      <cues>
                        <cue name="Ch6_Patriarchy_Rigging_Cutscene_Started_v2">
                          <conditions>
                            <event_cutscene_started cutscene="parent.$CutsceneID"/>
                          </conditions>
                          <actions>
                            <!-- Ships land there -->
                          </actions>
                          <delay exact="25s"/>
                          <actions>
                            <stop_cutscene cutscene="parent.$CutsceneID"/>
                            <create_position name="$TargetOffset" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="20km"/>
                            <create_order id="'MoveWait'" object="$PoliceRattleSnake" immediate="true">
                              <param name="destination" value="[$PoliceRattleSnake.sector, $TargetOffset]"/>
                              <param name="debugchance" value="$DeepDebugChance"/>
                            </create_order>
                          </actions>
                        </cue>
                        <cue name="Ch6_Patriarchy_Rigging_Cutscene_Complete_v2">
                          <conditions>
                            <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                          </conditions>
                          <actions>
                            <!-- Move the Fleet to the Accelerator -->
                            <do_for_each in="$RiggingShips" name="$rs">
                              <create_order object="$rs" id="'DockAndWait'" immediate="true">
                                <param name="destination" value="$PoliceRattleSnake" comment="police goes back to the mother ship"/>
                              </create_order>
                            </do_for_each>
                          </actions>
                          <delay exact="10s"/>
                          <actions>
                            <signal_cue cue="Ch6_Succsessfully_Rigged"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Succsessfully_Rigged">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch6_Successfully_Rigged_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30221601],
                                                          [30221602]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="Ch6_Invitation"/>
                  <!--
                 <t id="30221601">Right. The agents of the patriarchy have placed the bombs on board the ships.</t>
                 <t id="30221602">We're ready to deliver.</t>
                      -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Invitation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Create a Fleet -->
                <do_for_each in="$FleetShips" name="$s">
                  <cancel_all_orders object="$s"/>
                  <create_order id="'AssignCommander'" object="$s" immediate="true">
                    <param name="commander" value="$BoneyardCarrier"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>

                  <create_order id="'Escort'" object="$s" default="true">
                    <param name="target" value="$BoneyardCarrier"/>
                    <param name="formation" value="formationshape.dartvertical"/>
                    <param name="formationparam" value="2500m"/>
                  </create_order>
                </do_for_each>

                <do_if value="$PlayerChose == 'Patriarchy'">
                  <set_value name="$Ch6EndSignalCue" exact="Ch6_Patriarchy_Sabotage"/>
                </do_if>
                <do_else comment="Curbs">
                  <set_value name="$Ch6EndSignalCue" exact="Ch6_Curb_Attend"/>
                </do_else>

              </actions>
              <cues>
                <cue name="Ch6_Invitation_Delay">
                  <actions>
                    <!-- Flavour Objective -->
                    <set_objective cue="$MissionCue" action="objective.await" text="{30220,3014}" comment="(objective.await)Further Instructions"/>
                  </actions>
                  <delay exact="10s"/>
                  <actions>
                    <signal_cue cue="Ch6_Invitation_Speak"/>
                  </actions>
                </cue>
                <cue name="Ch6_Invitation_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_Invitation_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$OutcastActor"/>
                      <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                      <param name="Lines"             value="[[30221609],
                                                              [if player.entity.isfemale then 30221610 else 30221610]]"/>
                      <param name="EndSignalCue"      value="$Ch6EndSignalCue"/>
                      <!--
                          Outcast	<t id="30221609	">	Excellent!
                          Outcast	<t id="30221610	">	Pilot attend Curb announcement now.
                      -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Patriarchy_Sabotage" comment="the player places bombs on the Curb ship">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch6_Patriarchy_Sabotage_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$DalBusta, $BosoTa]"/>
                  <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey]"/>
                  <param name="Lines"             value="[[[if player.entity.isfemale then 30221606 else 30221605]],
                                                          [[30221602]]]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="[null, Ch6_Patriarchy_Sabotage_Mission]"/>
                  <!--
            Dal:  <t id="30221605">You could use this opportunity to place some bombs on their ship.
            Dal:  <t id="30221606">(spoken to female 'you'){,30221605}
            Boso: <t id="30221602">I have calculated the structural weaknesses and marked some locations for efficient bomb placement.
  not used: Boso: <t id="30221603">You can trigger the bombs whenever you are ready, but do be aware that this will trigger the Patriarchy's attack.
  not used: Boso: <t id="30221604">(spoken to female 'you'){,30221603}
                      -->
                </cue>

                <cue name="Ch6_Patriarchy_Sabotage_Mission">
                  <!-- Mission to trigger the effect after the sink -->
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>

                    <update_mission cue="$MissionCue" abortable="false" description="(if player.entity.isfemale then {30221,6121} else {30221,6120}) + $descrSinkPat"/>

                    <!-- Find Bomb Locations -->
                    <find_object_component name="$BYC_Shield" object="$BoneyardCarrier" class="[class.shieldgenerator]" multiple="false" macro="macro.shield_spl_xl_standard_01_mk1_macro" comment="We don't want 20 small shields as targets"/>
                    <find_object_component name="$BYC_Engine" object="$BoneyardCarrier" class="[class.engine]" multiple="false"/>
                    <set_value name="$TotalAmount" exact="2"/>
                    <set_value name="$RemainingAmountShield" exact="$TotalAmount"/>
                    <set_value name="$RemainingAmountEngine" exact="$TotalAmount"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_Patriarchy_Sabotage_Mission_Start" version="2">
                      <actions>
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" object="$BoneyardCarrier" action="objective.sabotage" step="$CurrentStep" updatebriefing="true"/>

                        <do_if value="$BYC_Engine.iswreck">
                          <set_value name="$RemainingAmountEngine" operation="subtract" exact="2"/>
                        </do_if>
                        <do_if value="$BYC_Shield.iswreck">
                          <set_value name="$RemainingAmountShield" operation="subtract" exact="2"/>
                        </do_if>

                        <signal_cue cue="Ch6_Patriarchy_Sabotage_Mission_Update_Briefing"/>
                      </actions>
                      <patch sinceversion="2">
                        <do_if value="cuestate.waiting == Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship.state">
                          <reset_cue cue="this"/>
                        </do_if>
                      </patch>
                    </cue>

                    <cue name="Ch6_Patriarchy_Sabotage_Mission_Update_Briefing" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="($RemainingAmountEngine gt 0) or ($RemainingAmountShield gt 0)">
                          <do_if value="$RemainingAmountEngine gt 0">
                            <set_value name="$CurrentSabotageRemaining" exact="$RemainingAmountEngine"/>
                            <set_value name="$CurrentSabotageTarget" exact="$BYC_Engine"/>
                          </do_if>
                          <do_elseif value="$RemainingAmountShield gt 0">
                            <set_value name="$CurrentSabotageRemaining" exact="$RemainingAmountShield"/>
                            <set_value name="$CurrentSabotageTarget" exact="$BYC_Shield"/>
                          </do_elseif>

                          <substitute_text text="$ObjectiveText" source="{30004, 1053}" comment="$WARENAME$ \($COUNT$ / $TOTAL$\)">
                            <replace string="'$WARENAME$'" with="$CurrentSabotageTarget.knownname" />
                            <replace string="'$COUNT$'" with="$TotalAmount - $CurrentSabotageRemaining" />
                            <replace string="'$TOTAL$'" with="$TotalAmount" />
                          </substitute_text>

                          <set_objective cue="$MissionCue" object="$CurrentSabotageTarget" action="objective.sabotage" text="$ObjectiveText"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch6_Patriarchy_Sabotage_Mission_Bomb_Attached" instantiate="true">
                      <conditions>
                        <event_player_bomb_attached/>
                        <check_value value="cuestate.waiting == Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship.state"/>
                        <check_value value="event.param.macro == macro.bomb_player_limpet_mine_01_mk1_macro"/>
                        <check_any>
                          <check_value value="event.param.parent == $BoneyardCarrier"/>
                          <check_value value="event.param.parent == $BYC_Shield"/>
                          <check_value value="event.param.parent == $BYC_Engine"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="event.param.parent.knownname"/>
                        <do_if value="event.param.parent == $BYC_Shield">
                          <set_value name="$RemainingAmountShield" operation="subtract" exact="1"/>
                        </do_if>
                        <do_if value="event.param.parent == $BYC_Engine">
                          <set_value name="$RemainingAmountEngine" operation="subtract" exact="1"/>
                        </do_if>
                        <set_owner object="event.param" faction="faction.civilian"/>
                        <set_object_min_hull object="event.param" exact="50"/>
                        <add_to_group groupname="$Ch6_Bombs" object="event.param"/>

                        <do_if value="($RemainingAmountShield le 0) and ($RemainingAmountEngine le 0)">
                          <cancel_cue cue="Ch6_Player_Placed_BombOther"/>
                          <signal_cue cue="Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship"/>
                        </do_if>
                        <do_elseif value="event.param.parent == $BoneyardCarrier">
                          <!-- No Briefing Update -->
                        </do_elseif>
                        <do_else>
                          <signal_cue cue="Ch6_Patriarchy_Sabotage_Mission_Update_Briefing"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch6_Patriarchy_Sabotage_Target_Destroyed" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_object_destroyed object="$BYC_Engine"/>
                          <event_object_destroyed object="$BYC_Shield"/>
                        </check_any>
                        <check_value value="cuestate.waiting == Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship.state"/>
                      </conditions>
                      <actions>
                        <debug_text text="event.object.knownname"/>
                        <do_if value="event.object == $BYC_Engine">
                          <set_value name="$RemainingAmountEngine" operation="subtract" exact="2"/>
                        </do_if>
                        <do_if value="event.object == $BYC_Shield">
                          <set_value name="$RemainingAmountShield" operation="subtract" exact="2"/>
                        </do_if>
                        <do_if value="($RemainingAmountShield le 0) and ($RemainingAmountEngine le 0)">
                          <cancel_cue cue="Ch6_Player_Placed_BombOther"/>
                          <signal_cue cue="Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch6_Patriarchy_Sabotage_Mission_Update_Briefing"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="PATCH_Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship" onfail="cancel">
                      <conditions>
                        <check_value value="cuestate.waiting == Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship.state"/>
                        <check_value value="$RemainingAmountShield le 0"/>
                        <check_value value="$RemainingAmountEngine le 0"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch6_Player_Placed_BombOther"/>
                        <signal_cue cue="Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Player_Placed_BombOther">
                      <conditions>
                        <event_player_bomb_attached/>
                        <check_value value="cuestate.waiting == Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship.state"/>
                        <check_value value="event.param.macro != macro.bomb_player_limpet_mine_01_mk1_macro"/>
                        <check_any>
                          <check_value value="event.param.parent == $BYC_Shield"/>
                          <check_value value="event.param.parent == $BYC_Engine"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <!--show_help line="7201" duration="10s" position="13" force="true" comment="Switch the ammo of your launcher to 'Spacesuit Bombs'."/-->
                      </actions>
                      <cues>
                        <cue name="Ch6_Player_Placed_BombOther_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor" value="$BosoTa"/>
                          <param name="CutsceneKey" value="$BosoCutsceneKey"/>
                          <param name="Lines" value="[[if player.entity.isfemale then 30200005 else 30200004], [30200007, 1s]]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="Ch6_Player_Placed_BombOther_Delay"/>
                          <!--
                          <t id="30200004">The ordnance you are using does not appear to be particularly suitable for the job.</t>
                          <t id="30200005">(spoken to female player 'you'){,30200004}</t>
                          <t id="30200007">I recommend switching to explosive charges.</t>
                          -->
                        </cue>
                        <cue name="Ch6_Player_Placed_BombOther_Delay">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="20s"/>
                          <actions>
                            <reset_cue cue="Ch6_Player_Placed_BombOther"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" action="objective.custom" customaction="{30193,32}" comment="Return to your Ship"/>

                        <!-- position in the throneroom -->
                        <create_position name="$CurbPos" x="-0.09" z="-10.75"/>
                        <create_rotation name="$CurbRot" yaw="0.0deg"/>
                        <create_position name="$OutcastPos" x="1.5" z="-11.25"/>
                        <create_rotation name="$OutcastRot" yaw="-30.0deg" />
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $CurbActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $ThroneRoom_Room,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $CurbRot,
                                                                                                      $position = $CurbPos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship_Check" onfail="cancel">
                          <conditions>
                            <check_value value="player.ship and player.ship.isplayerowned"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship_finished"/>
                          </actions>
                        </cue>

                        <cue name="Ch6_Patriarchy_Sabotage_Mission_Return_To_Ship_finished">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <check_all>
                                <event_object_changed_object object="player.entity"/>
                                <check_value value="event.param.isplayerowned and event.param.isclass.ship"/>
                              </check_all>
                            </check_any>
                            <check_value value="not @player.controlled.isclass.spacesuit"/>
                          </conditions>
                          <actions>
                            <set_objective cue="$MissionCue" action="objective.await" text="{30220,3014}" comment="(objective.await)Further Instructions"/>
                            <signal_cue cue="Ch6_Both_Declaration"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
            <cue name="Ch6_Curb_Attend">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- Go to the Throneroom / Deliver Caviar to trigger Declaration -->
              <actions>
                <!-- Mission: Declaration of Curbs Curb Mission -->
                <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30221,6221} else {30221,6220}) + $descrSinkCurb"/>


                <!-- position in the throneroom -->
                <create_position name="$CurbPos" x="-0.09" z="-10.75"/>
                <create_rotation name="$CurbRot" yaw="0.0deg"/>
                <create_position name="$OutcastPos" x="1.5" z="-11.25"/>
                <create_rotation name="$OutcastRot" yaw="-30.0deg" />
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $CurbActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $ThroneRoom_Room,
                                                                                                      $priority = 100,
                                                                                                      $rotation = $CurbRot,
                                                                                                      $position = $CurbPos,
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
              </actions>
              <cues>
                <cue name="Ch6_Outcast_Lines" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$OutcastActor"/>
                  </conditions>
                  <actions>
                    <add_npc_line hidechoices="true" line="if player.entity.isfemale then 30221602 else 30221601" comment="Split pleased to see you."/>
                  </actions>
                </cue>

                <cue name="Ch6_Curb_Lines" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$CurbActor"/>
                  </conditions>
                  <actions>
                    <add_npc_line hidechoices="true" line="if player.entity.isfemale then 30221617 else 30221601" comment="Pilot welcome and thanked for service!"/>
                  </actions>
                </cue>

                <cue name="Ch6_Curb_Caviar" ref="md.RML_Deliver_Inventory.Deliver_Inventory">
                  <param name="EndSignalCue"    value="Ch6_Curb_Caviar_Continue_Conversation"/>
                  <param name="MissionCue"      value="$MissionCue"/>
                  <param name="StartStep"       value="3"           comment="Briefing step to start the mission on"/>
                  <param name="UpdateBriefing"  value="true"        comment="Update the briefing objective step when the objective is updated"/>

                  <!--Delivery params-->
                  <param name="WaresTableParam"         value="table[{ware.inv_spaceflycaviar} = 1]"/>
                  <param name="DeliveryNPC"             value="$CurbActor"      comment="The NPC to which the items should be delivered." />
                  <param name="DeliveryObject"          value="$ThroneRoom_Room"  comment="The object on which to point to before the NPC is placed. Also used to create the interior with the below parameters" />
                  <param name="ProgressBarText"         value="{30004,1054}" comment="Text to be displayed next to the ware delivery progress bar e.g. ('Delivered')"/>
                  <param name="ConversationOptionText"  value="{30221,2151}" comment="(Player Choice)I brought the caviar."/>
                  <param name="ConversationTipText"     value="{30221,2152}" comment="(Tooltip for an unselectable Player Choice)Insufficient Inventory"/>
                  <!--<param name="DeliveryNPCLine"         value="30221256"/>-->
                  <param name="PlaceNPC"                value="false" comment="we place them ourselves now"/>
                  <param name="DebugChance"             value="$DeepDebugChance"/>
                </cue>

                <cue name="Ch6_Curb_Caviar_Continue_Conversation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <add_npc_line line="30221256" comment="Split accept offering."/>
                    <add_npc_line line="30221602" comment="Together we achieve greatness."/>
                    <add_npc_line line="30221603" comment="Time to declare our legitimacy and worth to all. Free Families and Zyarth Tyranny will learn!"/>
                    <!--<add_npc_line line="30221604" comment="All channels open."/>-->
                  </actions>
                  <cues>
                    <cue name="Ch6_Curb_Start_Cutscene">
                      <conditions>
                        <event_conversation_finished actor="$CurbActor"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_Both_Declaration"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
            <cue name="Ch6_Both_Declaration">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- Declaration Cutscene, varies depending on bombs placed or not -->
              <actions>
                <do_if value="$PlayerChose != 'Patriarchy'" comment="$PlayerChose curbs">
                  <speak actor="$CurbActor" priority="90">
                    <text line="30221604" comment="All channels open."/>
                    <!-- Is this immediately cut of by the announcement? -->
                  </speak>
                </do_if>
                <do_if value="$PlayerChose != 'Patriarchy'">
                  <create_order id="'MoveWait'" object="$BoneyardCarrier" immediate="true">
                    <param name="destination" value="[$FuneralGate.sector, $FuneralGate.position]"/>
                    <param name="debugchance" value="$DeepDebugChance"/>
                  </create_order>
                </do_if>

                <set_value name="$CutsceneKey" exact="'story_split_curb_declaration'"/>
                <play_cutscene key="$CutsceneKey" result="this.$CutsceneID" abortable="true">
                  <param name="targetobject"      object="$CurbActor"/>
                  <param name="orbitdist"         number="4.2"/>
                  <param name="orbitelevation"    number="-0.9"/>
                </play_cutscene>

                <set_objective cue="$MissionCue" action="objective.wait"/>

                <!-- SET UP PATRIARHCY FLEET -->
                <!-- ASP S Light -->
                <create_loadout result="$Patriarchy_S_Light">
                  <macros>
                    <engine macro="engine_spl_s_combat_01_mk4_macro" path="../con_engine_03"/>
                    <engine macro="engine_spl_s_combat_01_mk4_macro" path="../con_engine_02"/>
                    <weapon macro="weapon_spl_s_railgun_01_mk2_macro" path="../con_weapon_04"/>
                    <weapon macro="weapon_spl_s_railgun_01_mk2_macro" path="../con_weapon_03"/>
                    <weapon macro="weapon_spl_s_railgun_01_mk2_macro" path="../con_weapon_02"/>
                    <shield macro="shield_spl_s_standard_01_mk3_macro" path="../con_shield_01"/>
                  </macros>
                  <software>
                    <software ware="software_dockmk1"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk1"/>
                    <software ware="software_scannerobjectmk1"/>
                    <software ware="software_targetmk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_s_combat_01_mk3_macro"/>
                  </virtualmacros>
                </create_loadout>
                <!-- CHIMERA S Heavy -->
                <create_loadout result="$Patriarchy_S_Heavy">
                  <macros>
                    <engine macro="engine_spl_s_combat_01_mk4_macro" path="../con_engine_03"/>
                    <engine macro="engine_spl_s_combat_01_mk4_macro" path="../con_engine_02"/>
                    <weapon macro="weapon_spl_s_railgun_01_mk2_macro" path="../con_weapon_04"/>
                    <weapon macro="weapon_spl_s_railgun_01_mk2_macro" path="../con_weapon_03"/>
                    <weapon macro="weapon_spl_s_railgun_01_mk2_macro" path="../con_weapon_02"/>
                    <shield macro="shield_spl_s_standard_01_mk3_macro" path="../con_shield_01"/>
                  </macros>
                  <software>
                    <software ware="software_dockmk1"/>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk1"/>
                    <software ware="software_scannerobjectmk1"/>
                    <software ware="software_targetmk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_s_combat_01_mk3_macro"/>
                  </virtualmacros>
                </create_loadout>

              </actions>
              <cues>
                <cue name="Ch6_Both_Declaration_Cutscene">
                  <conditions>
                    <event_cutscene_started cutscene="parent.$CutsceneID"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Police_Rattlesnake"/>

                    <run_actions ref="md.LIB_Generic.SuppressChatter_AddCue">
                      <param name="Cue" value="Ch6_Both_Declaration_Cutscene"/>
                    </run_actions>
                    <speak actor="$CurbActor" priority="90">
                      <text line="30221605" delay="0.3s" comment="(announcement to the populous)Proud, Free Families' Patriarchs failed to expel Zyarth Tyranny."/>
                      <text line="30221606" delay="0.5s" comment="(announcement)Invader of Free Families' economy, enforcer of slave rights against Split culture, confiscator of assets in unjust trials."/>
                      <text line="30221607" delay="0.5s" comment="(announcement)Quarreling Families failed to gather enough forces. Brave Patriarchs died in Fires of Defeat."/>
                      <text line="30221608" delay="0.5s" comment="(announcement)Patriarchy ways failed us. Split families still quarreling."/>
                      <text line="30221609" delay="1.0s" comment="(announcement)Split see this before, Patriarch Ghus t'Gllt see this."/>
                      <text line="30221610" delay="0.7s" comment="(announcement)Patriarchs alone always fail us."/>
                      <text line="30221611" delay="0.5s" comment="(announcement)We are your Curbs, decreed by Ghus t'Gllt."/>
                      <text line="30221612" delay="0.5s" comment="(announcement)Curbs destroyed occupiers' unjust tribunal."/>
                    </speak>

                  </actions>
                  <cues>
                    <cue name="Ch6_Declaration_Part_2">
                      <conditions>
                        <event_speak_finished actor="$CurbActor" line="30221605"/>
                      </conditions>
                      <delay exact="0.2s"/>
                      <actions>
                        <do_if value="$PlayerChose == 'Patriarchy'">
                          <add_effect object="$BYC_Shield" effect="'ref_explosion_station_explosion01'"/>
                          <set_value name="$ExplosionDelay" exact="2.4s"/>
                        </do_if>
                        <do_else>
                          <set_value name="$ExplosionDelay" exact="0s"/>
                        </do_else>
                      </actions>
                      <delay exact="$ExplosionDelay"/>
                      <actions>
                        <set_value name="$CutsceneEvent" exact="'DeclarationPanIntense'"/>
                        <debug_text text="player.age + ' Signal cutscene with: ' + $CutsceneEvent" chance="$DebugChance"/>
                        <cutscene_event key="$CutsceneKey" event="$CutsceneEvent"/>

                        <do_if value="$PlayerChose == 'Patriarchy'">
                          <speak actor="$CurbActor" priority="90">
                            <text line="30221621" comment="Betrayal!"/>
                            <text line="30221620" comment="(announcement interrupted by explosion)Betrayal! All pilots attack!" delay="0.5s"/>
                          </speak>
                        </do_if>
                        <do_else comment="$PlayerChose curbs">
                          <speak actor="$CurbActor" priority="90">
                            <text line="30221613" delay="0.5s" comment="(announcement)Curbs mustered fleets of all Free Families, quarreling or not."/>
                            <text line="30221614" delay="0.5s" comment="(announcement)Join Curb rebellion."/>
                            <text line="30221615" delay="0.5s" comment="(announcement)Fulfil will of Ghus."/>
                            <text line="30221616" delay="0.3s" comment="(announcement)Victory to Curbs."/>
                          </speak>
                        </do_else>

                      </actions>
                      <delay exact="2.2s"/>
                      <actions>
                        <do_if value="$PlayerChose == 'Patriarchy'">
                          <!-- Explosion Sound -->
                          <play_sound object="$CurbActor" sound="'story_split_explosion'"/>

                          <set_value name="$HackedDuration" exact="600s"/>
                          <do_for_each in="$FleetShips" name="$s">
                            <do_if value="$s.iscapitalship">
                              <set_object_hull exact="50" object="$s"/>

                              <set_object_hacked object="$s" duration="$HackedDuration"/>
                              <find_object_component name="$Turrets" object="$s" class="[class.turret]" multiple="true"/>
                              <do_for_each in="$Turrets" name="$t">
                                <destroy_object explosion="true" object="$t"/>
                              </do_for_each>
                              <find_object_component name="$Shields" object="$s" class="[class.shieldgenerator]" multiple="true"/>
                              <do_for_each in="$Shields" name="$sh">
                                <destroy_object explosion="true" object="$sh"/>
                              </do_for_each>
                              <find_object_component name="$Engines" object="$s" class="[class.engine]" multiple="true"/>
                              <do_for_each in="$Engines" name="$e">
                                <destroy_object explosion="true" object="$e"/>
                              </do_for_each>
                              <signal_objects object="$s" param="'engineer_hacked'" param2="$HackedDuration"/>
                            </do_if>
                            <do_else>
                              <!-- Dragons are too strong and cannot have their surface elements sabotaged -->
                              <destroy_object explosion="true" object="$s"/>
                            </do_else>
                          </do_for_each>

                          <do_if value="not $Ch6_Bombs?">
                            <create_group groupname="$Ch6_Bombs"/>
                          </do_if>
                          <set_value name="$BombDamage" exact="[$Ch6_Bombs.count, 66].min"/>
                          <do_for_each in="$Ch6_Bombs" name="$b">
                            <set_object_hull object="$b" exact="0"/>
                          </do_for_each>

                          <do_if value="not $BYC_Shield.iswreck">
                            <destroy_object object="$BYC_Shield" explosion="true" />
                          </do_if>
                          <do_if value="not $BYC_Engine.iswreck">
                            <destroy_object object="$BYC_Engine" explosion="true"/>
                          </do_if>

                          <set_object_min_hull object="$BoneyardCarrier" exact="0"/>
                          <set_object_hull object="$BoneyardCarrier" exact="100 - $BombDamage"/>

                          <!-- place the attacking fleet -->
                          <destroy_object object="$PoliceRattleSnake" explosion="false"/>

                          <create_position name="$FuneralLaunchPos" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="1km"/>
                          <create_position name="$TargetOffset" object="$FuneralGate.exit" space="$FuneralGate.exit.sector" x="0km" y="0km" z="2km"/>
                          <do_for_each in="$RiggingShips" name="$rs">
                            <warp object="$rs" sector="$FuneralGate.sector" zone="$FuneralGate.zone"/>
                            <create_order id="'MoveWait'" object="$rs" immediate="true">
                              <param name="destination" value="[$rs.sector, $TargetOffset]"/>
                              <param name="debugchance" value="$DeepDebugChance"/>
                            </create_order>
                          </do_for_each>

                          <signal_cue_instantly cue="Police_Rattlesnake" param="[$BoneYardSector]"/>
                          <signal_cue cue="Ch6_Patriarchy_Attack" check="false"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch6_Declaration_Done" version="2">
                      <conditions>
                        <check_any>
                          <event_speak_finished actor="$CurbActor" line="30221621"/>
                          <event_speak_finished actor="$CurbActor" line="30221613"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.SuppressChatter_RemoveCue">
                          <param name="Cue" value="Ch6_Both_Declaration_Cutscene"/>
                        </run_actions>
                        <do_if value="$PlayerChose != 'Patriarchy'">
                          <set_value name="$Ch6_Curb_RemoveMissionLater"/>
                          <!--<remove_mission cue="$MissionCue" type="completed"/>
                          <write_to_logbook category="missions" faction="faction.player" title="{30221,6201}" text="if player.entity.isfemale then {30221,6223} else {30221,6222}"/>-->
                        </do_if>
                      </actions>
                      <delay exact="1.2s" comment="pause for effect"/>
                      <actions>
                        <stop_cutscene cutscene="parent.parent.$CutsceneID"/>
                        <do_if value="$PlayerChose != 'Patriarchy'">
                          <signal_cue cue="Sink_Effect_Curbs_Stage1_NewFaction"/>
                          <add_faction_relation faction="faction.player" otherfaction="faction.court" value="($CurbRelationBonus/$CurbRelationBonusMax) * 0.032" reason="relationchangereason.missioncompleted" />
                          <signal_cue cue="Ch6_Curb_Attack" check="false"/>
                          <substitute_text text="$PaintModRewardText" source="{30004,10001}">
                            <replace string="'$MODNAME$'" with="ware.paintmod_0095.name"/>
                          </substitute_text>
                          <add_inventory entity="player.entity" ware="ware.paintmod_0095" exact="10"/>
                          <show_notification text="{1015,90} + '\n' + $PaintModRewardText" sound="notification_achievement" comment="Reward received"/>
                        </do_if>
                      </actions>
                      <patch sinceversion="2" state="complete">
                        <do_if value="$PlayerChose != 'Patriarchy'">
                          <substitute_text text="$PaintModRewardText" source="{30004,10001}">
                            <replace string="'$MODNAME$'" with="ware.paintmod_0095.name"/>
                          </substitute_text>
                          <add_inventory entity="player.entity" ware="ware.paintmod_0095" exact="10"/>
                          <show_notification text="{1015,90} + '\n' + $PaintModRewardText" sound="notification_achievement" comment="Reward received"/>
                        </do_if>
                      </patch>
                      <patch sinceversion="2" state="cancelled">
                        <do_if value="$PlayerChose != 'Patriarchy'">
                          <substitute_text text="$PaintModRewardText" source="{30004,10001}">
                            <replace string="'$MODNAME$'" with="ware.paintmod_0095.name"/>
                          </substitute_text>
                          <add_inventory entity="player.entity" ware="ware.paintmod_0095" exact="10"/>
                          <show_notification text="{1015,90} + '\n' + $PaintModRewardText" sound="notification_achievement" comment="Reward received"/>
                        </do_if>
                      </patch>
                    </cue>

                    <cue name="Ch6_Aborted_Cutscene">
                      <conditions>
                        <event_cutscene_stopped cutscene="parent.parent.$CutsceneID"/>
                      </conditions>
                      <actions>
                        <do_if value="$PlayerChose != 'Patriarchy'">
                          <signal_cue cue="Ch6_Curb_Attack" check="false"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Ch6_Patriarchy_Attack" check="false"/>
                        </do_else>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
            <cue name="Ch6_Patriarchy_Attack" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <!-- Loyalist/ZYA attack the CRB faction through the Accelerator, fight vs. the greatly damaged XL ship (Torpedos) -->
              <!--<conditions>
                            <event_object_changed_sector object="$PoliceRattleSnake" sector="$FuneralGate.exit.sector"/>
                          </conditions>-->
              <delay exact="5s"/>
              <actions>
                <set_value name="$MainAttack"/>
                <cancel_cue cue="Police_Rattlesnake_Uncovered"/>
                <signal_objects object="$PoliceRattleSnake" param="'LoseCover'"/>
              </actions>
              <delay exact="0.1s"/>
              <actions>
                <do_for_each in="$Colonial" name="$c">
                  <reset_relation_boost object="$c" faction="faction.player"/>
                </do_for_each>

                <!-- Set proper relation + sink effects -->
                <!--<set_faction_relation faction="faction.court" otherfaction="faction.player" value="-1.0"/>-->

                <set_object_relation_behaviour object="$BoneyardCarrier" disable="false"/>
                <set_owner object="$BoneyardCarrier" faction="faction.court" overridenpc="true"/>
                <do_for_each in="$BoneyardCarrier.subordinates" name="$sub">
                  <set_owner object="$sub" faction="faction.court" overridenpc="true"/>
                  <do_for_each in="$sub.subordinates" name="$subsub">
                    <set_owner object="$subsub" faction="faction.court" overridenpc="true"/>
                  </do_for_each>
                </do_for_each>

                <do_for_each in="$FleetShips" name="$s">
                  <set_owner object="$s" faction="faction.court" overridenpc="true"/>
                </do_for_each>
              </actions>
              <delay exact="2s"/>
              <actions>
                <signal_cue_instantly cue="Ch6_Both_Create_Patriarchy_Fleet"/>
              </actions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="Sink_Effect_Zyarth_Stage1_NewFaction"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$MainAttack"/>
                <cancel_cue cue="Police_Rattlesnake_Uncovered"/>
                <signal_objects object="$PoliceRattleSnake" param="'LoseCover'"/>
              </patch>
            </cue>

            <cue name="Ch6_Both_Create_Patriarchy_Fleet">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="$PlayerChose == 'Patriarchy'">
                  <create_position name="$PatriarchyFleetPos" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="1km"/>
                </do_if>
                <do_else>
                  <create_position name="$PatriarchyFleetPos" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="18km"/>
                </do_else>

                <do_all exact="6" counter="$s">
                  <create_ship name="$RiggingShip" groupname="$RiggingShips" macro="ship_spl_s_fighter_02_a_macro"
                               commandeerable="false" missioncue="namespace" sector="$FuneralGate.sector">
                    <owner exact="faction.split"/>
                    <paint ware="$SplitPaintMods.$splitCover"/>
                    <pilot>
                      <select faction="faction.split" tags="tag.fighterpilot"/>
                    </pilot>
                    <loadout loadout="$Patriarchy_S_Light"/>
                    <position x="$PatriarchyFleetPos.x" y="$PatriarchyFleetPos.y" z="$PatriarchyFleetPos.z"/>
                  </create_ship>
                </do_all>

                <do_for_each in="$RiggingShips" name="$rs" comment="Add the earlier created once to this, too.">
                  <create_order id="'AssignCommander'" object="$rs" immediate="true">
                    <param name="commander" value="$PoliceRattleSnake"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>
                </do_for_each>

                <set_value name="$Asps_Per_Chimera" exact="2"/>
                <set_value name="$Chimera_Subordination_Table" exact="table[]"/>
                <!-- BALAUR Heavy Fighters -->
                <do_all exact="10">
                  <set_value name="$Current_Paint" exact="[$SplitPaintMods.$splitStripes, $SplitPaintMods.$splitBasic].random"/>

                  <create_ship name="$Chimera" groupname="$Chimeras" sector="$FuneralGate.sector"
                               macro="ship_spl_s_heavyfighter_01_a_macro" commandeerable="false" missioncue="namespace">
                    <owner exact="faction.split"/>
                    <paint ware="$Current_Paint"/>
                    <pilot>
                      <select faction="faction.split" tags="tag.fighterpilot"/>
                    </pilot>
                    <loadout loadout="$Patriarchy_S_Heavy"/>
                    <position x="$PatriarchyFleetPos.x" y="$PatriarchyFleetPos.y" z="$PatriarchyFleetPos.z"/>
                  </create_ship>

                  <!-- ASP Light Fighters -->
                  <do_all exact="$Asps_Per_Chimera">
                    <create_ship name="$Asp_Defender" groupname="$Chimera_Subordination_Table.{$Chimera}" sector="$FuneralGate.sector"
                                 macro="ship_spl_s_fighter_02_b_macro" commandeerable="false" missioncue="namespace">
                      <owner exact="faction.split"/>
                      <paint ware="$Current_Paint"/>
                      <pilot>
                        <select faction="faction.freesplit" tags="tag.fighterpilot"/>
                      </pilot>
                      <loadout loadout="$Patriarchy_S_Light"/>
                      <position x="$PatriarchyFleetPos.x" y="$PatriarchyFleetPos.y" z="$PatriarchyFleetPos.z"/>
                    </create_ship>
                  </do_all>
                </do_all>

                <do_for_each in="$Chimeras" name="$B">
                  <create_order id="'AssignCommander'" object="$B">
                    <param name="commander" value="$PoliceRattleSnake"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>

                  <do_for_each in="$Chimera_Subordination_Table.{$B}" name="$Asp">
                    <create_order id="'AssignCommander'" object="$Asp">
                      <param name="commander" value="$B"/>
                      <param name="assignment" value="assignment.attack"/>
                      <param name="cancelorders" value="true"/>
                    </create_order>
                  </do_for_each>
                </do_for_each>

              </actions>
              <cues>
                <cue name="Ch6_Patriarchy_Attack_Delay">
                  <delay exact="10s"/>
                  <actions>
                    <create_order id="'Attack'" object="$PoliceRattleSnake">
                      <param name="primarytarget" value="$BoneyardCarrier"/>
                      <param name="pursuetargets" value="true"/>
                    </create_order>

                    <do_if value="$PlayerChose == 'Patriarchy'">
                      <signal_cue cue="Ch6_Speak_Loyalist_620"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch6_Speak_Loyalist_620" comment="Patriarchy Only">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Lines" exact="[[30221620],
                                                                  [30221621]]"/>
                    <do_if value="$BoneyardCarrier">
                      <append_to_list name="$Lines" exact="[if player.entity.isfemale then 30221623 else 30221622]"/>
                    </do_if>
                  </actions>
                  <cues>

                    <cue name="Ch6_Speak_Loyalist_620_Pat_DND" checkinterval="2s">
                      <conditions>
                        <check_value value="not md.$MissionDND.count"/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Speak_Loyalist_620_PAT_v2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$LoyalistActor"/>
                          <param name="CutsceneKey"       value="$LoyalistCutsceneKey"/>
                          <param name="Lines"             value="$Lines"/>
                          <param name="MissionCue"        value="if ($Ch6_Patriarchy_RemoveMissionLater? and not $Ch6_Patriarchy_RemovedMission?) then $MissionCue else null"/>
                          <param name="IsInMission"       value="$Ch6_Patriarchy_RemoveMissionLater? and not $Ch6_Patriarchy_RemovedMission?"/>
                          <param name="EndSignalCue"      value="BoneyardCarrierCompensation"/>
                          <!-- Loyalist	<t id="30221	620	">	All units, engage!
                           Loyalist	<t id="30221	621	">	Today Split end this terrorism.
       Main Target Alive Case:      
                           Loyalist	<t id="30221	622	">	Pilot receive compensation after destroying main target.
                           Loyalist	<t id="30221	623	">	(spoken to female 'pilot'){,30221622}
                         -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="BoneyardCarrierCompensation">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="10s"/>
                      <actions>
                        <set_faction_relation faction="faction.court" otherfaction="faction.player" value="-1.0"/>
                      </actions>
                      <cues>
                        <cue name="BoneyardCarrierDead_Init">
                          <actions>
                            <do_if value="not $BoneyardCarrier.exists">
                              <signal_cue cue="BoneyardCarrierDead"/>
                            </do_if>
                            <do_else>
                              <do_if value="Ch7_Stage_2.state == cuestate.waiting">
                                <set_objective cue="$MissionCue" action="objective.destroy" object="$BoneyardCarrier"/>
                              </do_if>
                            </do_else>
                          </actions>
                        </cue>
                        <cue name="BoneyardCarrierDead" version="2">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_object_destroyed object="$BoneyardCarrier"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <!-- Compensation -->
                            <!--<set_value name="$FactionBonusCalculation" exact="($ZyarthRelationBonus/$ZyarthRelationBonusMax) * $MaxRelationBonus"/>-->
                            <set_value name="$RelationUpToZero" exact="0"/>
                            <do_if value="faction.player.relationto.{faction.split} lt 0">
                              <set_value name="$RelationUpToZero" exact="-1 * (faction.player.relationto.{faction.split})"/>
                            </do_if>
                            <add_faction_relation faction="faction.player" otherfaction="faction.split" value="(($ZyarthRelationBonus/$ZyarthRelationBonusMax) * 0.032) + $RelationUpToZero" reason="relationchangereason.missioncompleted" />

                            <set_value name="$Ch6_Patriarchy_RemoveMissionLater"/>
                            <!--
                            <remove_mission cue="$MissionCue" type="completed"/>
                            <write_to_logbook category="missions" faction="faction.player" title="{30221,6101}" text="if player.entity.isfemale then {30221,6123} else {30221,6122}"/>
                            -->

                            <substitute_text text="$PaintModRewardText" source="{30004,10001}">
                              <replace string="'$MODNAME$'" with="ware.paintmod_0091.name"/>
                            </substitute_text>
                            <add_inventory entity="player.entity" ware="ware.paintmod_0091" exact="10"/>
                            <show_notification text="{1015,90} + '\n' + $PaintModRewardText" sound="notification_achievement" comment="Reward received"/>

                          </actions>
                          <patch sinceversion="2" state="complete">
                            <substitute_text text="$PaintModRewardText" source="{30004,10001}">
                              <replace string="'$MODNAME$'" with="ware.paintmod_0091.name"/>
                            </substitute_text>
                            <add_inventory entity="player.entity" ware="ware.paintmod_0091" exact="10"/>
                            <show_notification text="{1015,90} + '\n' + $PaintModRewardText" sound="notification_achievement" comment="Reward received"/>
                          </patch>
                          <patch sinceversion="2" state="cancelled">
                            <substitute_text text="$PaintModRewardText" source="{30004,10001}">
                              <replace string="'$MODNAME$'" with="ware.paintmod_0091.name"/>
                            </substitute_text>
                            <add_inventory entity="player.entity" ware="ware.paintmod_0091" exact="10"/>
                            <show_notification text="{1015,90} + '\n' + $PaintModRewardText" sound="notification_achievement" comment="Reward received"/>
                          </patch>
                          <cues>
                            <cue name="Ch6_Speak_Loyalist_624_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$LoyalistActor"/>
                              <param name="CutsceneKey"       value="$LoyalistCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30221625 else 30221624]]"/>
                              <param name="MissionCue"        value="if ($Ch6_Patriarchy_RemoveMissionLater? and not $Ch6_Patriarchy_RemovedMission?) then $MissionCue else null"/>
                              <param name="IsInMission"       value="$Ch6_Patriarchy_RemoveMissionLater? and not $Ch6_Patriarchy_RemovedMission?"/>
                              <!--Loyalist	<t id="30221	624	">	Zyarth Patriarchy thank you for service!
                                  Loyalist	<t id="30221	625	">	(spoken to female 'you'){,30221624}
                              -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_Curb_Attack" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="Police_Rattlesnake" param="[$HeartOfAcrimonySector]"/>
                <set_object_min_hull object="$PoliceRattleSnake" exact="0"/>
                <create_position name="$TargetOffset" object="$FuneralGate" space="$FuneralGate.sector" x="0km" y="0km" z="20km"/>
                <create_order id="'MoveWait'" object="$PoliceRattleSnake" default="true">
                  <param name="destination" value="[$PoliceRattleSnake.sector, $TargetOffset]"/>
                  <param name="debugchance" value="$DeepDebugChance"/>
                </create_order>
                <signal_cue_instantly cue="Ch6_Both_Create_Patriarchy_Fleet"/>

                <set_object_relation_behaviour object="$BoneyardCarrier" disable="false"/>
                <do_for_each in="$BoneyardCarrier.subordinates" name="$sub">
                  <set_owner object="$sub" faction="faction.court" overridenpc="true"/>
                  <do_for_each in="$sub.subordinates" name="$subsub">
                    <set_owner object="$subsub" faction="faction.court" overridenpc="true"/>
                  </do_for_each>
                </do_for_each>
                <set_owner object="$BoneyardCarrier" faction="faction.court" overridenpc="true"/>
                <cancel_all_orders object="$BoneyardCarrier"/>
                <create_order id="'Attack'" object="$BoneyardCarrier">
                  <param name="primarytarget" value="$PoliceRattleSnake"/>
                  <param name="pursuetargets" value="true"/>
                  <param name="forceprimarytarget" value="true"/>
                </create_order>

                <do_for_each in="$FleetShips" name="$s">
                  <set_owner object="$s" faction="faction.court" overridenpc="true"/>
                </do_for_each>

                <set_value name="$MainAttack"/>
                <cancel_cue cue="Police_Rattlesnake_Uncovered"/>
                <signal_objects object="$PoliceRattleSnake" param="'LoseCover'"/>
              </actions>
              <patch sinceversion="2">
                <set_value name="$MainAttack"/>
                <cancel_cue cue="Police_Rattlesnake_Uncovered"/>
                <signal_objects object="$PoliceRattleSnake" param="'LoseCover'"/>
              </patch>
              <cues>
                <cue name="Ch6_Speak_Dal_620_DND" checkinterval="2s">
                  <conditions>
                    <check_value value="not md.$MissionDND.count"/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_Speak_Dal_620_v2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30221620],
                                                                  [30221621]]"/>
                      <param name="MissionCue"        value="if ($Ch6_Curb_RemoveMissionLater? and not $Ch6_Curb_RemovedMission?) then $MissionCue else null"/>
                      <param name="IsInMission"       value="$Ch6_Curb_RemoveMissionLater? and not $Ch6_Curb_RemovedMission?"/>
                      <!-- 
                      Dal	<t id="30221	620	">	I don't believe it. They've done it.
                      Dal	<t id="30221	621	">	The Court of Curbs has just declared its independence.
                  -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Curb_Attack_LooseCover">
                  <conditions>
                    <check_any>
                      <event_object_hull_damaged object="$PoliceRattleSnake"/>
                      <event_object_hull_damaged object="$BoneyardCarrier"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Police_Rattlesnake_Uncovered"/>
                    <signal_objects object="$PoliceRattleSnake" param="'LoseCover'"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_Speak_Loyalist_620_CRB_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$LoyalistActor"/>
                      <param name="CutsceneKey"       value="$LoyalistCutsceneKey"/>
                      <param name="Lines"             value="[[30221620],[30221621]]"/>
                      <param name="MissionCue"        value="if ($Ch6_Curb_RemoveMissionLater? and not $Ch6_Curb_RemovedMission?) then $MissionCue else null"/>
                      <param name="IsInMission"       value="$Ch6_Curb_RemoveMissionLater? and not $Ch6_Curb_RemovedMission?"/>
                      <!-- Loyalist	<t id="30221	620	">	All units, engage!
                           Loyalist	<t id="30221	621	">	Today Split end this terrorism.
                         -->
                    </cue>

                  </cues>
                </cue>
              </cues>

            </cue>
          </cues>

          <!-- **** FACTION ****              
              PLAYER CHOSES CURBS:
              - Add .court to faction logic instances (enemy with .split, friendly .argon etc.)              
          curb path stage 1
          .freesplit -> .freesplit + .curb
          .court forms by changing ownership of various .freesplitstations/ships
              there will still be .freesplit around
          .court ist hostile to .split, but friendly to .player
          
                PLAYER CHOSES PATRIARCHY:                
                - Add .court(cabal) faction logic instances (enemy with .split, enemy with .player)
                - .split rep bonus dependent (telling the police on all occasions gives +5 each time (min relation 5, max 20))
                - enable police_colonial job (disabled by default)
          .split path stage 1
          .freesplit -> .freesplit + .court(cabal)

          .split relation towards .player improves to allow docking/missions
          .court(cabal) forms by changing ownership of various .freefamilies stations/ships, there will still be .freefamilies around
              .court(cabal) is a weaker version of .court (gets less stations/ships) and hostile to the player
          .split increases police presence in .freefamilies (2nd police ship per sector)
          .split takes gets all .freefamilies defence stations in one sector
          .split relation towards .player improves -->
        </cue>

        <cue name="Debug_Ch7_Stage_2_Patriarchy">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$PlayerChose" exact="'Patriarchy'"/>
            <signal_cue cue="Ch7_Stage_2"/>
          </actions>
        </cue>
        <cue name="Debug_Ch7_Stage_2_Curb">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$PlayerChose" exact="'Curb'"/>
            <signal_cue cue="Ch7_Stage_2"/>
          </actions>
        </cue>

        <cue name="Ch7_Stage_2" comment="Text IDs 700 Curbs/ 800 Patriarchy">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions comment="CleanUp Ships">
            <!-- Cleanup Ch6 Mission -->
            <do_if value="$Ch6_Curb_RemoveMissionLater?">
              <set_value name="$Ch6_Curb_RemovedMission"/>
              <remove_mission cue="$MissionCue" type="completed"/>
              <write_to_logbook category="missions" faction="faction.player" title="{30221,6201}" text="if player.entity.isfemale then {30221,6223} else {30221,6222}"/>
            </do_if>
            <do_if value="$Ch6_Patriarchy_RemoveMissionLater?">
              <set_value name="$Ch6_Patriarchy_RemovedMission"/>
              <remove_mission cue="$MissionCue" type="completed"/>
              <write_to_logbook category="missions" faction="faction.player" title="{30221,6101}" text="if player.entity.isfemale then {30221,6123} else {30221,6122}"/>
            </do_if>

            <create_list name="$LeftoverShips"/>

            <do_if value="$BoneyardCarrier?">
              <append_to_list name="$LeftoverShips" exact="$BoneyardCarrier"/>
            </do_if>
            <do_if value="$PoliceRattleSnake?">
              <append_to_list name="$LeftoverShips" exact="$PoliceRattleSnake"/>
            </do_if>
            <do_if value="$Ch2_SlaveTraderShip?">
              <append_to_list name="$LeftoverShips" exact="$Ch2_SlaveTraderShip"/>
            </do_if>
            <do_if value="$FuneralServiceShip?">
              <append_to_list name="$LeftoverShips" exact="$FuneralServiceShip"/>
            </do_if>
            <do_if value="$SlaveTraderShip?">
              <append_to_list name="$LeftoverShips" exact="$SlaveTraderShip"/>
            </do_if>

            <cancel_cue cue="Ch6_Sink"/>
            <set_value name="$Cr_Amount" exact="(400 * 1000 * 1000)"/>
            <do_if value="$PlayerChose == 'Patriarchy'">
              <set_value name="$BribeActor"   exact="$LoyalistActor"/>
              <set_value name="$BribeFaction" exact="faction.split"/>
              <set_value name="$DalLines" exact="[[30221801], [30221802]]"/>
              <set_value name="$descrSink2Pat" exact="'\n\n' + {30221,9117} + ' ' + {30221,9118} + ' ' + {30221,9119} + ' ' + {30221,9121}"/>
              <set_userdata storystate="'story_split_cabal_coup'" value="1"/>
            </do_if>
            <do_else>
              <set_value name="$BribeActor" exact="$OutcastActor"/>
              <set_value name="$BribeFaction" exact="faction.court"/>
              <set_value name="$DalLines" exact="[[30221701], [30221702], [30221703]]"/>
              <set_value name="$descrSink2Curb" exact="'\n\n' + {30221,9103} + ' ' + {30221,9104} + ' ' + {30221,9105} + ' ' + {30221,9106}"/>
              <set_userdata storystate="'story_split_curbs_declaration'" value="1"/>
            </do_else>
          </actions>
          <cues>

            <cue name="Ch6_EitherDestroyedOrLeftSector_Init" onfail="cancel">
              <conditions>
                <check_any>
                  <check_value value="$BoneyardCarrier.exists and (not $PoliceRattleSnake.exists)"/>
                  <check_value value="$PoliceRattleSnake.exists and (not $BoneyardCarrier.exists)"/>
                  <check_value value="$BoneYardSector != $BoneyardCarrier.sector"/>
                  <check_value value="$BoneYardSector != $PoliceRattleSnake.sector"/>
                </check_any>
              </conditions>
              <actions>
                <signal_cue cue="Ch6_EitherDestroyedOrLeftSector"/>
              </actions>
            </cue>

            <cue name="Ch6_EitherDestroyedOrLeftSector">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_object_destroyed object="$BoneyardCarrier"/>
                  <event_object_destroyed object="$PoliceRattleSnake"/>
                  <event_object_changed_sector object="$BoneyardCarrier"/>
                  <event_object_changed_sector object="$PoliceRattleSnake"/>
                </check_any>
              </conditions>
              <actions>
                <do_for_each in="$LeftoverShips" name="$ship">
                  <do_if value="$ship.exists">
                    <set_object_min_hull object="$ship" exact="0"/>
                    <set_object_min_shield object="$ship" exact="0"/>
                    <create_order id="'Patrol'" object="$ship" immediate="true">
                      <param name="space" value="$HeartOfAcrimonySector"/>
                    </create_order>
                  </do_if>
                </do_for_each>
              </actions>
            </cue>

            <cue name="Ch7_Debug_Remove_Money">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <transfer_money from="faction.player" to="faction.ownerless" amount="(player.money)"/>
              </actions>
            </cue>

            <cue name="Ch7_Speak_Dal_801">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch7_Speak_Dal_801_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="$DalLines"/>
                  <param name="MissionCue"        value="if $Ch7_CreateMissionEarly? then $MissionCue else null"/>
                  <param name="IsInMission"       value="$Ch7_CreateMissionEarly?"/>
                  <!--<param name="EndSignalCue"      value="Ch7_Accumulate_Wealth"/>-->
                  <!--
                Dal	<t id="30221	801	">	After their initial attack on the terrorist cells, the Patriachy Secret Police is trying to get funds for anti-terrorism initiatives.	</t>
                Dal	<t id="30221	802	">	If we can add a significant contribution to their funds, the Patriarchy will be able to establish themselves deep within the rogue sectors to prevent similar incidents.	</t>
                
                Dal	<t id="30221	701	">	After establishing their territory with their initial declaration, the Curbs are rallying support to fight the Zyarth Patriarchy.
                Dal	<t id="30221	702	">	While the Curbs themselves are giving speeches to win over Split hearts and minds, the devoted followers are being asked to contribute finanically.
                Dal	<t id="30221	703	">	If we can add a significant contribution to their funds, they will be able to end Patriarchy policing of Free Families' sectors.
                -->
                </cue>
              </cues>

            </cue>
            <cue name="Ch7_Accumulate_Wealth">
              <!--<conditions>
                <event_cue_signalled/>
              </conditions>-->
              <actions>
                <set_value name="$Ch7_CreateMissionEarly"/>
                <set_value name="$Sink_Money" exact="(400 * 1000 * 1000)Cr"/>

                <do_if value="$PlayerChose == 'Patriarchy'">
                  <set_value name="$name" exact="{30221,7002}"/>
                  <set_value name="$desc" exact="{30221,7020} + $descrSink2Pat"/>
                  <set_value name="$rwrd" exact="{30221,7025}"/>
                  <create_mission cue="$MissionCue" name="$name" difficulty="level.veryhard" group="missiongroup.story_split_zyarth"
                                  description="$desc"
                                  rewardtext="$rwrd" type="missiontype.plot" faction="faction.freesplit" abortable="false"
                                      icon="'briefing_fau_t_nnt_01'" iconcaption="$LoyalistActor.name">
                    <briefing>
                      <objective step="1" action="objective.custom" customaction="{1004,78} + ' ' + ($Sink_Money).formatted.default + ' ' + {1001,101}" comment="'Acquire 400 million Cr'"/>
                      <!-- 
                    <t id="78">Acquire(inventory)</t>
                    <t id="101">(unit Credits)Cr</t> -->
                      <objective step="2" action="objective.talkto" text="$BribeActor.knownname"/>
                    </briefing>
                  </create_mission>
                </do_if>
                <do_else>
                  <set_value name="$name" exact="{30221,7001}"/>
                  <set_value name="$desc" exact="{30221,7004} + $descrSink2Curb"/>
                  <set_value name="$rwrd" exact="{30221,7009}"/>
                  <create_mission cue="$MissionCue" name="$name" difficulty="level.veryhard" group="missiongroup.story_split_court"
                                  description="$desc"
                                  rewardtext="$rwrd" type="missiontype.plot" faction="faction.freesplit" abortable="false"
                                  icon="'briefing_yu_t_knk_01'" iconcaption="$OutcastActor.name">
                    <briefing>
                      <objective step="1" action="objective.custom" customaction="{1004,78} + ' ' + ($Sink_Money).formatted.default + ' ' + {1001,101}" comment="'Acquire 400 million Cr'"/>
                      <!-- 
                    <t id="78">Acquire(inventory)</t>
                    <t id="101">(unit Credits)Cr</t> -->
                      <objective step="2" action="objective.talkto" text="$BribeActor.knownname"/>
                    </briefing>
                  </create_mission>
                </do_else>

                <set_value name="$CurrentStep" exact="1"/>
                <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep"/>

                <signal_cue cue="Ch7_Speak_Dal_801"/>
              </actions>
              <cues>
                <cue name="Ch7_Player_Wealthy" comment="Deprecated"></cue>
                <cue name="Ch7_Player_Accumulated" comment="Deprecated"></cue>

                <cue name="Ch7_Player_Accumulated_Init" version="2">
                  <actions>
                    <set_value name="$Player_Has_Sink_Money" exact="false"/>
                    <signal_cue cue="Ch7_Player_Accumulated_Sink_Money"/>
                  </actions>
                  <patch sinceversion="2">
                    <do_if value="$Sink_Container? and (not $Sink_Container.exists)" comment="component.{0x0}">
                      <signal_cue cue="Ch7_Sink_Find_Container"/>
                    </do_if>
                  </patch>
                </cue>

                <cue name="Ch7_Player_Accumulated_Sink_Money" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_player_money_updated/>
                    </check_any>
                    <check_value value="player.money ge $Sink_Money"/>
                    <check_value value="not $Player_Has_Sink_Money" comment="Update only if the state was different before"/>
                    <check_value value="Ch7_Mission_To_Initiate_Sink.state == cuestate.waiting" comment="We did not pay already"/>
                  </conditions>
                  <actions>
                    <set_value name="$Player_Has_Sink_Money" exact="true"/>

                    <do_if value="not ($Sink_Container? and $SinkContainer.exists)">
                      <signal_cue cue="Ch7_Sink_Find_Container"/>
                    </do_if>
                    <do_elseif value="$BribeActor.container != $Sink_Container">
                      <signal_cue cue="Ch7_Container_Destroyed" comment="Will figure out placement again"/>
                    </do_elseif>
                    <do_else>
                      <signal_cue cue="Ch7_Sink_Money"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch7_Player_Lost_Sink_Money" instantiate="true">
                  <conditions>
                    <event_player_money_updated/>
                    <check_value value="player.money lt $Sink_Money"/>
                    <check_value value="$Player_Has_Sink_Money" comment="Update only if the state was different before"/>
                    <check_value value="Ch7_Mission_To_Initiate_Sink.state == cuestate.waiting" comment="We did not pay already"/>
                  </conditions>
                  <actions>
                    <set_value name="$Player_Has_Sink_Money" exact="false"/>
                    <set_value name="$CurrentStep" exact="1"/>
                    <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep" comment="Accumulate Money Objective"/>
                    <reset_cue cue="Ch7_Sink_Money"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch7_Sink_Init_Wait_For_Faction">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Set Objective "Wait for a Meeting to be Arranged" -->
                <set_objective cue="$MissionCue" action="objective.await" text="{30220,3014}" step="$CurrentStep" comment="(objective.await)Further Instructions"/>
              </actions>
              <delay exact="5987s"/>
              <actions>
                <signal_cue cue="Ch7_Sink_Find_Container"/>
                <reset_cue cue="this"/>
              </actions>
            </cue>

            <cue name="Ch7_Sink_Find_Container" comment="Sets $Sink_Container">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="if (Ch7_Sink_Money.state == cuestate.waiting) then 0s else 1s"/>
              <actions>
                <set_value name="$Sink_Container" exact="null"/>
                <!-- Find  Location, if none Reset and try again later (some war ship)-->
                <find_ship_by_true_owner faction="$BribeFaction" sortbydistanceto="player.entity"
                                         space="player.galaxy" name="$Sink_Container">
                  <match_hull min="50"/>
                  <match_dock size="[tag.dock_s, tag.dock_m]"/>
                </find_ship_by_true_owner>

                <do_if value="not $Sink_Container.exists">
                  <find_station_by_true_owner faction="$BribeFaction" sortbydistanceto="player.entity"
                                              sortlimit="1" space="player.galaxy" name="$Sink_Container">
                    <match_hull min="50"/>
                    <match_dock size="[tag.dock_s, tag.dock_m]"/>
                  </find_station_by_true_owner>
                </do_if>

                <do_if value="$Sink_Container.exists">
                  <signal_cue cue="Ch7_Sink_Money"/>
                  <debug_text text="'New Sink Container: %s %s in %s'.[$Sink_Container.knownname, $Sink_Container, $Sink_Container.sector.knownname]" chance="$DebugChance"/>
                </do_if>
                <do_else>
                  <signal_cue cue="Ch7_Sink_Init_Wait_For_Faction"/>
                </do_else>
                <reset_cue cue="this"/>
              </actions>
            </cue>

            <cue name="Ch7_Sink_Money_Cancel_Sink_TalkTo" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
            </cue>

            <cue name="Ch7_Sink_Money">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Place Actor, Guidance even if she's not there, Catch Dead Station -->
                <set_value name="$CurrentStep" exact="2"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $BribeActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Sink_Container,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>

                <signal_cue_instantly cue="md.GenericMissions.DisconnectedActorObjectiveLibrary" param="table[
                                              $actor = $BribeActor,
                                              $object = $Sink_Container,
                                              $missioncue = $MissionCue,
                                              $cancelcue = Ch7_Sink_Money_Cancel_Sink_TalkTo,
                                              $libfailedcue = null,
                                              $objective = objective.talkto,
                                              $step = $CurrentStep,
                                              $debugchance = $DebugChance]"/>

                <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                  <param name="Object" value="$Sink_Container"/>
                  <param name="RequesterCue" value="namespace"/>
                  <param name="ReachedThresholdSignalCue" value="Ch7_Container_Destroyed"/>
                  <param name="DebugChance" value="$DebugChance"/>
                </run_actions>

              </actions>
              <cues>

                <cue name="Ch7_MissingActor_Mantis_1336" onfail="cancel">
                  <conditions>
                    <check_value value="$Sink_Container.exists"/>
                    <check_value value="$BribeActor.container != $Sink_Container"/>
                  </conditions>
                  <actions>
                    <!-- Bullet-Proofing case where NPC_Instantiation_Manager has no entry and DisconnectedActorObjective is not running -->
                    <set_value name="$Ch7_MissingActor_Mantis_1336"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $BribeActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Sink_Container,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <signal_cue_instantly cue="md.GenericMissions.DisconnectedActorObjectiveLibrary" param="table[
                                              $actor = $BribeActor,
                                              $object = $Sink_Container,
                                              $missioncue = $MissionCue,
                                              $cancelcue = Ch7_Sink_Money_Cancel_Sink_TalkTo,
                                              $libfailedcue = null,
                                              $objective = objective.talkto,
                                              $step = $CurrentStep,
                                              $debugchance = $DebugChance]"/>
                  </actions>
                </cue>

                <cue name="Ch7_MissingActor_Mantis_2879" checkinterval="1s" checktime="player.age + 5s">
                  <conditions>
                    <check_value value="$Sink_Container.exists"/>
                    <check_value value="$BribeActor.container != $Sink_Container"/>
                  </conditions>
                  <actions>
                    <!-- Bullet-Proofing case where NPC_Instantiation_Manager has no entry and DisconnectedActorObjective is not running -->
                    <set_value name="$Ch7_MissingActor_Mantis_2879"/>
                    <debug_text text="'Placing Missing BribeActor %s %s on %s %s'.[$BribeActor.knownname, $BribeActor, $Sink_Container.knownname, $Sink_Container]" chance="100"/>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $BribeActor,
                                                                                                      table[
                                                                                                      $requestercue = namespace,
                                                                                                      $location = $Sink_Container,
                                                                                                      $priority = 100,
                                                                                                      $slottags = [tag.stand],
                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                      ]"/>
                    <signal_cue_instantly cue="md.GenericMissions.DisconnectedActorObjectiveLibrary" param="table[
                                              $actor = $BribeActor,
                                              $object = $Sink_Container,
                                              $missioncue = $MissionCue,
                                              $cancelcue = Ch7_Sink_Money_Cancel_Sink_TalkTo,
                                              $libfailedcue = null,
                                              $objective = objective.talkto,
                                              $step = $CurrentStep,
                                              $debugchance = $DebugChance]"/>
                  </actions>
                </cue>

                <cue name="Ch7_Patch_Container_Destroyed" onfail="cancel">
                  <conditions>
                    <check_value value="not $Sink_Container.exists"/>
                    <check_value value="cuestate.waiting == Ch7_Mission_To_Initiate_Sink.state"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch7_Container_Destroyed"/>
                  </actions>
                </cue>

                <cue name="Ch7_Container_Destroyed" version="3">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <event_object_destroyed object="$Sink_Container"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $BribeActor,
                                                      table[
                                                      $requestercue = namespace,
                                                      $location = 'disconnect',
                                                      $priority = 100,
                                                      $debugchance = $DeepDebugChance,
                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                      ]"/>
                    <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                      <param name="Object" value="$Sink_Container"/>
                      <param name="RequesterCue" value="namespace"/>
                      <param name="DebugChance" value="$DebugChance"/>
                    </run_actions>

                    <signal_cue cue="Ch7_Sink_Money_Cancel_Sink_TalkTo"/>
                    <signal_cue cue="Ch7_Sink_Find_Container"/>
                    <reset_cue cue="Ch7_Sink_Money"/>
                    <reset_cue cue="this"/>
                  </actions>
                  <patch sinceversion="2" state="complete">
                    <signal_cue cue="Ch7_Sink_Find_Container"/>
                    <reset_cue cue="Ch7_Sink_Money"/>
                    <reset_cue cue="this"/>
                  </patch>
                </cue>

                <cue name="Ch7_Payment_Ship_Wait_Handling" comment="Stop the Ship with the plot relevant NPC from avoiding the player">
                  <cues>

                    <cue name="Ch7_Player_In_SinkContainer_Sector_Check">
                      <cues>
                        <cue name="Ch7_Player_In_SinkContainer_Sector_Check_Ref" ref="md.LIB_Generic.ReachedSameSector">
                          <param name="TargetObject"      value="$Sink_Container"/>
                          <param name="TargetObject2"     value="player.entity"/>
                          <param name="SuccessSignalCue"  value="Ch7_Player_In_SinkContainer_Sector"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch7_Player_In_SinkContainer_Sector">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch7_Sink_Container_Wait">
                          <actions>
                            <debug_text text="'Attempting to stop ' + $Sink_Container.knownname" chance="$DebugChance"/>
                            <create_order object="$Sink_Container" immediate="true" id="'MoveWait'">
                              <param name="destination"   value="[$Sink_Container.sector, position.[$Sink_Container.position.x, $Sink_Container.position.y + 10km, $Sink_Container.position.z]]"/>
                              <param name="timeout"       value="10min"/>
                            </create_order>
                          </actions>
                        </cue>

                        <cue name="Ch7_Player_Outside_SinkContainer_Sector_Ref" ref="md.LIB_Generic.LeftSector">
                          <param name="TargetObject"      value="player.entity"/>
                          <param name="TargetSector"      value="$Sink_Container.sector"/>
                          <param name="SuccessSignalCue"  value="Ch7_Player_Outside_SinkContainer_Sector"/>
                        </cue>

                        <cue name="Ch7_Player_Outside_SinkContainer_Sector">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <reset_cue cue="Ch7_Payment_Ship_Wait_Handling"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch7_Payment" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$BribeActor" conversation="default"/>
                      <event_conversation_next_section actor="$BribeActor"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.name == 'event_conversation_started'">
                      <do_if value="$BribeActor == $LoyalistActor">
                        <add_npc_line speaker="$BribeActor" line="if player.entity.isfemale then 30221625 else 30221624"
                                      comment="Zyarth Patriarchy thank you for service!" hidechoices="true"/>
                      </do_if>
                      <do_else comment="$OutcastActor">
                        <add_npc_line speaker="$BribeActor" line="if player.entity.isfemale then 30221601 else 30221602"
                                      comment="male: Split greet fellow fighter! female: Split pleased to see you. (Forgot the female fighter var :/)" hidechoices="true"/>
                      </do_else>
                      <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                        <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                      </substitute_text>
                      <set_value name="$PlayerHasEnoughMoney" exact="player.money ge ($Cr_Amount)Cr"/>
                      <do_if value="Ch7_Mission_To_Initiate_Sink.state == cuestate.waiting">
                        <add_player_choice section="Ch7_Pay" choiceparam="'contribution'"
                                           text="$OfferCredits" comment="Offer Cr"
                                           selectable="$PlayerHasEnoughMoney"
                                           tooltip="if $PlayerHasEnoughMoney then '' else {30221,3271}"/>
                      </do_if>
                    </do_if>
                    <do_elseif value="event.param == 'Ch7_Pay'">
                      <transfer_money from="faction.player" to="$BribeFaction" amount="($Cr_Amount)Cr"/>
                      <do_if value="$BribeActor == $LoyalistActor">
                        <add_npc_line speaker="$BribeActor" hidechoices="true">
                          <text line="30221801" comment="Patriarchy Police grateful for contribution."/>
                          <text line="30221802" comment="Split round up dissident terrorists." delay="1s"/>
                          <text line="30221803" comment="Informant reported on hidden traitor cells on station."/>
                          <text line="if player.entity.isfemale then 30221805 else 30221804" comment="Check station communication for verification."/>
                          <text line="if player.entity.isfemale then 30221807 else 30221806" comment="Scan leaks for relevant messages on rebel frequencies."/>
                          <text line="if player.entity.isfemale then 30221809 else 30221808" comment="If confirmed, destroy station."/>
                        </add_npc_line>
                      </do_if>
                      <do_else>
                        <add_npc_line speaker="$BribeActor" hidechoices="true">
                          <text line="if player.entity.isfemale then 30221703 else 30221702" comment="Curbs accept your devoted contribution."/>
                          <text line="30221704" comment="Curbs ready to make move."/>
                          <text line="if player.entity.isfemale then 30221706 else 30221705" comment="Join Curb fight to banish Patriarchy from our sectors."/>
                          <text line="if player.entity.isfemale then 30221708 else 30221707" comment="Feel free to engage."/>
                        </add_npc_line>
                      </do_else>
                      <signal_cue cue="Ch7_Mission_To_Initiate_Sink"/>
                      <cancel_cue cue="this"/>
                      <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager"
                                            param="['add_definition', $BribeActor, table[
                                                                                              $requestercue = namespace,
                                                                                              $priority = 100,
                                                                                              $location = 'disconnect',
                                                                                              $slottags = [tag.stand],
                                                                                              $debugchance = $DebugChance,
                                                                                              $debugcaller = if $DebugChance == 100 then this else null]
                                                                                             ]"/>

                      <run_actions ref="md.LIB_Generic.RequestObjectVulnerability">
                        <param name="Object" value="$Sink_Container"/>
                        <param name="RequesterCue" value="namespace"/>
                        <param name="DebugChance" value="$DebugChance"/>
                      </run_actions>
                    </do_elseif>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch7_Mission_To_Initiate_Sink" version="3">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <cancel_cue cue="Ch7_Sink_Money"/>

                <set_value name="$CurrentStep" exact="1" operation="add"/>

                <do_if value="$PlayerChose == 'Patriarchy'">
                  <update_mission cue="$MissionCue" description="{30221,7020} + '\n\n' + (if player.entity.isfemale then {30221,7022} else {30221,7021}) + $descrSink2Pat"/>
                </do_if>
                <do_else>
                  <update_mission cue="$MissionCue" description="{30221,7004} + '\n\n' + (if player.entity.isfemale then {30221,7006} else {30221,7005}) + $descrSink2Curb"/>
                </do_else>
                <signal_cue cue="Ch7_Sink_Money_Cancel_Sink_TalkTo"/>

              </actions>
              <patch sinceversion="2" state="waiting">
                <do_if value="$BribeActor.hascontext.{$Sink_Container}">
                  <debug_text text="'Bribe actor is on board object ' + $Sink_Container + '. Setting object to invincible.'" filter="savegame"/>
                  <run_actions ref="md.LIB_Generic.RequestObjectInvincibility">
                    <param name="Object" value="$Sink_Container"/>
                    <param name="RequesterCue" value="namespace"/>
                    <param name="ReachedThresholdSignalCue" value="Ch7_Container_Destroyed"/>
                    <param name="DebugChance" value="$DebugChance"/>
                  </run_actions>
                </do_if>
                <do_else>
                  <debug_text text="'Bribe actor was not on board object ' + $Sink_Container + '. Triggering placement again for a new object.'" filter="savegame"/>
                  <signal_cue cue="Ch7_Sink_Find_Container"/>
                  <reset_cue cue="Ch7_Sink_Money"/>
                </do_else>
              </patch>
              <patch sinceversion="3">
                <cancel_cue cue="Ch7_Sink_Money"/>
              </patch>
              <cues>
                <cue name="Ch7_Mission_Find_Target_Station_Init">
                  <actions>
                    <signal_cue cue="Ch7_Mission_Find_Target_Station"/>
                  </actions>
                </cue>

                <cue name="Ch7_Mission_Find_Target_Station_Retry">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.await" text="{30220,3014}" comment="(objective.await)Further Instructions //No station available"/>
                  </actions>
                  <delay exact="5987s"/>
                  <actions>
                    <signal_cue cue="Ch7_Mission_Find_Target_Station"/>
                  </actions>
                </cue>

                <cue name="Ch7_Mission_Find_Target_Station">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Set a Mission Target and some reaction voices once it's destroyed -->
                    <do_if value="$PlayerChose == 'Patriarchy'">
                      <set_value name="$TargetFaction" exact="faction.freesplit"/>
                    </do_if>
                    <do_else comment="Curb Mission">
                      <set_value name="$TargetFaction" exact="faction.split"/>
                    </do_else>
                    <find_station_by_true_owner faction="$TargetFaction" sortbydistanceto="player.entity"
                                                sortlimit="1" space="player.galaxy" name="$TargetStation">
                      <match_dock size="[tag.dock_s, tag.dock_m]"/>
                    </find_station_by_true_owner>

                    <do_if value="$PlayerChose == 'Patriarchy'">
                      <set_value name="$LeakObject" exact="$TargetStation"/>
                      <include_actions ref="md.Signal_Leaks.GetLeakSlots"/>
                      <do_if value="$LeakLocations.count gt 1" comment="need more than 1 to not repeat locations on failure">
                        <set_value name="$TargetStation" exact="$LeakObject"/>
                      </do_if>
                      <do_else>
                        <set_value name="$TargetStation" exact="null"/>
                      </do_else>
                    </do_if>

                    <do_if value="not $TargetStation">
                      <signal_cue cue="Ch7_Mission_Find_Target_Station_Retry"/>
                      <reset_cue cue="this"/>
                    </do_if>
                    <do_else>
                      <do_if value="$PlayerChose == 'Patriarchy'">
                        <set_objective step="$CurrentStep" cue="$MissionCue" action="objective.flyto" object="$TargetStation" updatebriefing="true"/>
                        <signal_cue cue="Ch7_Scan_Target_Station"/>
                        <reset_cue cue="this"/>
                      </do_if>
                      <do_else>
                        <set_objective step="$CurrentStep" cue="$MissionCue" action="objective.destroy" object="$TargetStation" updatebriefing="true"/>
                        <signal_cue cue="Ch7_Destroy_Target_Station"/>
                      </do_else>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch7_Scan_Target_Station">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch7_Prematurely_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$TargetStation"/>
                      </conditions>
                      <cues>
                        <cue name="Ch7_Speak_Loyalist_810_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$LoyalistActor"/>
                          <param name="CutsceneKey"       value="$LoyalistCutsceneKey"/>
                          <param name="Lines"             value="[[30221810]]"/>
                          <!--Loyalist	<t id="30221	810	">	Station lost, but rebels remained.
                              -->
                          <param name="EndSignalCue"      value="Ch7_Prematurely_Destroyed_Resetter"/>
                        </cue>
                        <cue name="Ch7_Prematurely_Destroyed_Resetter">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch7_Mission_Find_Target_Station"/>
                            <reset_cue cue="Ch7_Scan_Target_Station"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch7_Place_Leaks_Init">
                      <actions>
                        <signal_cue cue="Ch7_Place_Leaks"/>
                      </actions>
                    </cue>
                    <cue name="Ch7_Place_Leaks_Reset">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <reset_cue cue="Ch7_Scan_Target_Station_Leak"/>
                        <reset_cue cue="Ch7_Place_Leaks"/>
                      </actions>
                      <delay exact="13s"/>
                      <actions>
                        <reset_cue cue="this"/>
                        <signal_cue cue="Ch7_Place_Leaks"/>
                      </actions>
                    </cue>

                    <cue name="Ch7_Place_Leaks" version="2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$LeakObject" exact="$TargetStation"/>
                        <include_actions ref="md.Signal_Leaks.GetLeakSlots"/>
                        <do_if value="$LeakLocations.count gt 1" comment="need more than 1 to not repeat locations on failure">
                          <set_value name="$SignalLeakLocation" exact="$LeakLocations.random"/>
                        </do_if>
                        <do_if value="$SignalLeakLocation == null">
                          <signal_cue cue="Ch7_Place_Leaks_Reset"/>
                        </do_if>
                        <do_else>
                          <do_if value="$TargetStation.attention lt $AttentionActivePhysics">
                            <signal_cue cue="Ch7_Place_Leaks_Reset"/>
                          </do_if>
                          <do_else>
                            <set_value name="$MissionLeakMacro" exact="macro.signalleak_s_standard_01_macro" />
                            <find_object_surface posname="$SurfacePos" rotname="$SurfaceRot" object="$SignalLeakLocation.component" height="$MissionLeakMacro.boundingbox.max.y - $MissionLeakMacro.boundingbox.center.y">
                              <position value="$SignalLeakLocation.offset" />
                              <!-- the rotation created by the normal would look away from the surface, we want a rotation that's looking parallel to the surface -->
                              <offsetrotation pitch="-90deg" />
                            </find_object_surface>
                            <do_if value="@$SurfacePos">
                              <create_signal_leak name="$SignalLeak" groupname="$Leaks" macro="$MissionLeakMacro" type="signalleaktype.mission" object="$SignalLeakLocation.component">
                                <position value="$SurfacePos" />
                                <rotation value="$SurfaceRot" />
                                <!--<voice page="$SignalLeakActor.page" lines="[1000003, 1000004, 1000005]"/>-->
                              </create_signal_leak>
                              <create_position name="$SignalLeakPos" object="$SignalLeak" space="$SignalLeak.sector"/>
                              <signal_cue cue="Ch7_Scan_Target_Station_Leak"/>
                            </do_if>
                            <do_elseif value="Ch7_Place_Leaks_Reset.state == cuestate.waiting" comment="if not it is already running">
                              <signal_cue cue="Ch7_Place_Leaks_Reset"/>
                            </do_elseif>
                          </do_else>
                        </do_else>
                      </actions>
                      <patch sinceversion="2">
                        <do_if value="not $SurfacePos">
                          <signal_cue cue="Ch7_Place_Leaks_Reset"/>
                        </do_if>
                      </patch>
                      <cues>
                        <cue name="Ch7_AttentionChange">
                          <conditions>
                            <event_object_changed_attention object="$LeakObject"/>
                            <check_value value="$LeakObject.attention ge $AttentionActivePhysics"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch7_Place_Leaks_Reset"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch7_Scan_Target_Station_Leak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective step="$CurrentStep" cue="$MissionCue" action="objective.scan" object="$SignalLeak" updatebriefing="true"/>
                      </actions>
                      <cues>
                        <!--
                        Loyalist	<t id="30221	811	">	Check this station for rebel frequencies.
                        Loyalist	<t id="30221	812	">	(spoken to female 'you'){,30221811}-->
                        <cue name="Ch7_Scan_Target_Station_Leak_Unlocked">
                          <conditions>
                            <event_player_signal_unlock_finished signal="$SignalLeak"/>
                          </conditions>
                          <actions>
                            <destroy_object object="$SignalLeak" explosion="false"/>
                            <signal_cue cue="Ch7_Destroy_Target_Station"/>
                            <set_owner object="$TargetStation" faction="faction.court" overridenpc="true"/>
                          </actions>
                          <cues>
                            <cue name="Ch7_Speak_Loyalist_813_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$LoyalistActor"/>
                              <param name="CutsceneKey"       value="$LoyalistCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30221814 else 30221813], [if player.entity.isfemale then 30221816 else 30221815]]"/>
                              <!--
                                Loyalist	<t id="30221	813	">	You found rebels! Excellent.
                                Loyalist	<t id="30221	814	">	(spoken to female 'you'){,30221813}
                                Loyalist	<t id="30221	815	">	Now destroy them in name of Patriarch Zyarth!
                                Loyalist	<t id="30221	816	">	(spoken to female 'you'){,30221815}
                              -->
                              <param name="EndSignalCue"      value="Ch7_Scan_Cleanup"/>
                            </cue>
                            <cue name="Ch7_Scan_Cleanup">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <cancel_cue cue="Ch7_Scan_Target_Station"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch7_Destroy_Target_Station" version="3">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!--<set_value name="$CurrentStep" exact="1" operation="add"/>-->
                    <do_if value="$PlayerChose == 'Patriarchy'">
                      <set_objective step="$CurrentStep" cue="$MissionCue" action="objective.destroy" object="$TargetStation" updatebriefing="true"/>
                    </do_if>
                  </actions>
                  <patch sinceversion="2">
                    <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep"/>
                  </patch>
                  <patch sinceversion="3">
                    <do_if value="$PlayerChose == 'Patriarchy'">
                      <set_objective step="$CurrentStep" cue="$MissionCue" action="objective.destroy" object="$TargetStation" updatebriefing="true"/>
                    </do_if>
                  </patch>
                  <cues>
                    <cue name="Ch7_Debug_Destroy_Target_Station">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <destroy_object object="$TargetStation" explosion="true"/>
                      </actions>
                    </cue>
                    <cue name="Ch7_Target_Station_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$TargetStation"/>
                      </conditions>
                      <actions>
                        <do_if value="$PlayerChose == 'Patriarchy'">
                          <set_value name="$SpeakActor"     exact="$LoyalistActor"/>
                          <set_value name="$SpeakCutscene"  exact="$LoyalistCutsceneKey"/>
                          <set_value name="$SpeakLines"     exact="[[30221817], [30221818], [30221819]]"/>
                          <set_value name="$DalLines"       exact="[[30221803], [30221804], [30221805]]"/>
                          <set_value name="$EndSignalCue"    exact="Sink_Effect_Zyarth_Stage2_TakeOverSectors"/>
                          <do_if value="$Achievement_Working_With_Police ge 3">
                            <unlock_achievement name="SV_PATRIARCHY_POLICE" />
                          </do_if>
                        </do_if>
                        <do_else>
                          <set_value name="$SpeakActor"     exact="$CurbActor"/>
                          <set_value name="$SpeakCutscene"  exact="$CurbCutsceneKey"/>
                          <set_value name="$SpeakLines"     exact="[[30221701], [30221702], [30221703]]"/>
                          <set_value name="$DalLines"       exact="[[30221704], [30221705], [30221706]]"/>
                          <set_value name="$EndSignalCue"    exact="Sink_Effect_Curbs_Stage2_StopPolice"/>
                        </do_else>

                      </actions>
                      <cues>
                        <cue name="Ch7_Speak_Destroyed_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$SpeakActor, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$SpeakCutscene, $DalCutsceneKey]"/>
                          <param name="Lines"             value="[$SpeakLines, $DalLines]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <param name="EndSignalCue"      value="[$EndSignalCue, Ch7_Logbook]"/>
                        </cue>
                        <cue name="Ch7_Logbook">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="$PlayerChose == 'Patriarchy'">
                              <remove_mission cue="$MissionCue" type="completed"/>
                              <write_to_logbook category="missions" faction="faction.player" title="{30221,7002}" text="if player.entity.isfemale then {30221,7024} else {30221,7023}"/>
                              <set_userdata storystate="'story_split_cabal_complete'" value="1"/>
                              <unlock_achievement name="SV_PLOT_SPLIT_SINK2" comment="Patriarchy Achievement"/>
                            </do_if>
                            <do_else>
                              <remove_mission cue="$MissionCue" type="completed"/>
                              <write_to_logbook category="missions" faction="faction.player" title="{30221,7001}" text="if player.entity.isfemale then {30221,7008} else {30221,7007}"/>
                              <set_value name="$Ch8_Patch"/>
                              <signal_cue cue="Ch8_Stage_3_v2"/>
                            </do_else>
                            <cancel_cue cue="Ch7_Stage_2"/>
                          </actions>
                        </cue>
                      </cues>
                      <!-- PATRIARCHY CASE 
                      Loyalist	<t id="30221817">Rebel station is destroyed!
                      Loyalist	<t id="30221818">We coordinated multiple raids on other stations and seized rebel assets.
                      Loyalist	<t id="30221819">Glory to Zyarth Patriarchy!
                      Dal	      <t id="30221803">We did it! The Patriarchy took over a couple of sectors.
                      Dal	      <t id="30221804">There may be still terrorists left, but they shouldn't pose a major threat any more.
                      Dal	      <t id="30221805">The Patriarchy has established itself further as a stable power in the free sectors.  
                      -->
                      <!-- CURB CASE 
                      Curb	<t id="30221701	">	Victory for Curbs and all free Split.	</t>
                      Curb	<t id="30221702	">	Tyrannical Patriarchy driven out of Free Families' sectors.	</t>
                      Curb	<t id="30221703	">	Free Families may decide to rot in independence or submit to victorious Curb rule.	</t>
                      Dal	  <t id="30221704	">	We did it. The Patriarchy Police has been driven out of the Free Families' sectors.	</t>
                      Dal	  <t id="30221705	">	But don't underestimate the Curbs' ambition.	</t>
                      Dal	  <t id="30221706	">	They are still fighting the Patriarchy.	</t>                    
                    -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
          </cues>

          <!-- 1. Sink: Money -->
          <!-- 2. Mission: Destroy a PA defence station -->
          <!-- 3. Sink: Get Missile Components (deliver-resources) -->
          <!-- 4. Coverowner-Deliver to a ZYA station -->
          <!--

    curb path stage 2

    .split stops policing .freesplit
    .court gets more .freesplit sectors
    

    curb path stage 3
    .split -> renamed to "rhak" + .freesplit

    .split loses some rebellious stations/sectors to .freesplit
    rest of .split is renamed to "rhak"
    .split(rhak) is at peace with .court
        .split(rhak) could be at peace with .argon
        .split(rhak) could be neutral enough with .player for him to improve relations
        (.court could start a war with .argon)            
        
        -->
        </cue>

        <cue name="Ch8_Stage_3_Patch">
          <actions>
            <do_if value="(Ch7_Logbook.state == cuestate.complete) and
                          ($PlayerChose? and ($PlayerChose != 'Patriarchy')) and
                          not $Ch8_Patch?">
              <signal_cue cue="Ch8_Stage_3_v2"/>
              <set_value name="$Ch8_Patch"/>
            </do_if>
          </actions>
        </cue>

        <cue name="Ch8_Stage_3_v2" comment="Text IDs 800" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!--    missilecomponents: price min: 6, av: 9, max: 12
                     weaponcomponents: price min: 171, av 285, max 399
                     
                    .averageprice is in ct
                -->
            <set_value name="$TargetValue" exact="(800 * 1000 * 1000)Cr" comment="800 million"/>

            <set_value name="$Ware_MissileComp" exact="ware.missilecomponents"/>
            <set_value name="$Ware_WeaponComp"  exact="ware.weaponcomponents"/>

            <set_value name="$TargetCapacity" exact="20000" comment="~average cargo capacity of L freighters 34000"/>

            <set_value name="$Ware_MissileComp_Amount" exact="$TargetCapacity / $Ware_MissileComp.volume" comment="OLD: (($TargetValue/4*1) / $Ware_MissileComp.averageprice)i"/>
            <set_value name="$Ware_WeaponComp_Amount"  exact="$TargetCapacity / $Ware_WeaponComp.volume" comment="OLD: (($TargetValue/4*3) / $Ware_WeaponComp.averageprice)i"/>
            <set_value name="$Pay_Value" exact="$TargetValue - (($Ware_MissileComp_Amount * $Ware_MissileComp.averageprice) + ($Ware_WeaponComp_Amount*$Ware_WeaponComp.averageprice))"/>

            <set_value name="$DeliverResourcesTable" exact="table[
                  {$Ware_MissileComp} = $Ware_MissileComp_Amount,
                  {$Ware_WeaponComp} = $Ware_WeaponComp_Amount           
                ]"/>

            <set_userdata storystate="'story_split_curbs_no_colonial_police'" value="1"/>

          </actions>
          <patch sinceversion="2">
            <set_value name="$Patch_Decreased_Ware_Amount_patch_v2"/>
            <set_value name="$OldResourcesTable" exact="$DeliverResourcesTable.clone"/>

            <set_value name="$TargetCapacity" exact="20000" comment="~average cargo capacity of L freighters"/>

            <set_value name="$Ware_MissileComp_Amount" exact="$TargetCapacity / $Ware_MissileComp.volume" comment="OLD: (($TargetValue/4*1) / $Ware_MissileComp.averageprice)i"/>
            <set_value name="$Ware_WeaponComp_Amount"  exact="$TargetCapacity / $Ware_WeaponComp.volume" comment="OLD: (($TargetValue/4*3) / $Ware_WeaponComp.averageprice)i"/>

            <set_value name="$Pay_Value" exact="$TargetValue - (($Ware_MissileComp_Amount * $Ware_MissileComp.averageprice) + ($Ware_WeaponComp_Amount*$Ware_WeaponComp.averageprice))"/>

            <set_value name="$DeliverResourcesTable" exact="table[
                  {$Ware_MissileComp} = $Ware_MissileComp_Amount,
                  {$Ware_WeaponComp} = $Ware_WeaponComp_Amount           
                ]"/>
          </patch>
          <cues>
            <cue name="Debug_Ch8_Destroy_DeliveryStation_v2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <destroy_object object="$DeliveryStation" explosion="true"/>
              </actions>
            </cue>
            <cue name="Debug_Ch8_Befriend_DeliveryStation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_relation_boost object="$DeliveryStation" otherobject="player.ship" value="9999.0"/>
                <set_relation_boost object="$DeliveryStation" faction="faction.player" value="9999.0"/>
              </actions>
            </cue>
            <cue name="Ch8_Stage_3_Deliver_DEBUG" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_ship name="$LentFreighter" zone="player.zone" macro="[macro.ship_arg_l_trans_container_02_b_macro].random">
                  <owner exact="faction.player" overridenpc="true"/>
                  <pilot group="argon.pilot"/>
                  <position object="player.ship" z="1km"/>
                </create_ship>
                <add_cargo result="$result1" object="$LentFreighter" ware="ware.weaponcomponents" exact="550" comment="total needed = 1k"/>
                <add_cargo result="$result2" object="$LentFreighter" ware="ware.missilecomponents" exact="5500" comment="total needed = 10k"/>
              </actions>
            </cue>
            <cue name="Debug_Add_Cargo_Drones">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <add_units object="player.ship" exact="199999" category="unitcategory.transport" mk="1"/>
              </actions>
            </cue>
            <cue name="Debug_Ch8_Add_DeliveryWares_v2_Missile">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="player.ship">
                  <!--<do_for_each in="$DeliverResourcesTable.keys.list" name="$ware">
                    <add_cargo object="player.ship" ware="$ware" exact="$DeliverResourcesTable.{$ware}"/>
                    -->
                  <!--<add_tradeware object="$DeliveryStation" allowbuy="true" allowsell="false" ware="$ware"/>-->
                  <!--
                  </do_for_each>-->
                  <add_cargo object="player.ship" ware="$Ware_MissileComp" exact="999999"/>
                </do_if>
              </actions>
            </cue>
            <cue name="Debug_Ch8_Add_DeliveryWares_v2_Weapon">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="player.ship">
                  <!--<do_for_each in="$DeliverResourcesTable.keys.list" name="$ware">
                    <add_cargo object="player.ship" ware="$ware" exact="$DeliverResourcesTable.{$ware}"/>
                    -->
                  <!--<add_tradeware object="$DeliveryStation" allowbuy="true" allowsell="false" ware="$ware"/>-->
                  <!--
                  </do_for_each>-->
                  <add_cargo object="player.ship" ware="$Ware_WeaponComp" exact="999999"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Ch8_Delivery_Init_v2">
              <actions>
                <signal_cue cue="Ch8_Set_DeliveryStation_v2"/>
              </actions>
            </cue>

            <cue name="Ch8_Set_DeliveryStation_v2" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$DeliveryStation" exact="null"/>
                <set_value name="$PossibleDeliveryFactions" exact="[faction.court, faction.freesplit]"/>

                <!-- Find a station which does not actually need this wares, look at .court first but accept .freesplit, too -->
                <do_for_each in="$PossibleDeliveryFactions" name="$faction">
                  <find_station_by_true_owner faction="$faction" space="player.galaxy" name="$PossibleStations" multiple="true" tradestation="true">
                    <!--<match_cargo>
                      <ware ware="$Ware_MissileComp"/>
                      <ware ware="$Ware_WeaponComp"/>
                    </match_cargo>
                    breaks if the TradingStation doesn't have the cargo
                    if not set, it sends the player to a defence station with no storage whatsoever-->
                  </find_station_by_true_owner>
                  <do_for_each in="$PossibleStations" name="$s">
                    <set_value name="$StationNeedsWare" exact="false"/>
                    <do_for_each in="$DeliverResourcesTable.keys.list" name="$res">
                      <do_if value="$s.products.{$res}.exists or $s.resources.{$res}.exists">
                        <set_value name="$StationNeedsWare" exact="true"/>
                      </do_if>
                    </do_for_each>
                    <do_if value="not $StationNeedsWare">
                      <set_value name="$DeliveryStation" exact="$s"/>
                      <break/>
                    </do_if>
                  </do_for_each>
                  <do_if value="$DeliveryStation">
                    <break/>
                  </do_if>
                </do_for_each>

                <do_if value="$DeliveryStation">
                  <create_list name="$TradeOfferList"/>
                  <do_for_each in="$DeliverResourcesTable.keys.list" name="$CurrentWare">
                    <create_trade_offer buyer="$DeliveryStation" object="$DeliveryStation" ware="$CurrentWare" amount="$DeliverResourcesTable.{$CurrentWare}" missioncue="namespace" name="$TradeOffer" playeronly="true" price="0ct" virtualmoney="true"/>
                    <append_to_list name="$TradeOfferList" exact="$TradeOffer"/>
                  </do_for_each>
                  <do_if value="Ch8_Create_Mission_v2.state == cuestate.waiting">
                    <signal_cue cue="Ch8_Create_Mission_v2"/>
                  </do_if>
                  <do_else>
                    <signal_cue cue="Ch8_Deliver_Resources_v2"/>
                  </do_else>
                </do_if>
                <do_else>
                  <signal_cue cue="Ch8_Set_DeliveryStation_Retry_v2"/>
                </do_else>
                <reset_cue cue="this"/>
              </actions>
              <patch sinceversion="2">
                <!-- Private beta testers might still have the tradeware version of the mission, which we need to replace. -->
                <do_if value="not $TradeOfferList?" comment="Only for private beta testers.">
                  <do_for_each in="$DeliverResourcesTable" name="$CurrentWare">
                    <remove_tradeware object="$DeliveryStation" ware="$CurrentWare"/>
                  </do_for_each>
                </do_if>
                <do_if value="$DeliveryStation">
                  <create_list name="$TradeOfferList"/>
                  <do_for_each in="$DeliverResourcesTable.keys.list" name="$CurrentWare">
                    <create_trade_offer buyer="$DeliveryStation" object="$DeliveryStation" ware="$CurrentWare" amount="$DeliverResourcesTable.{$CurrentWare}" missioncue="namespace" name="$TradeOffer" playeronly="true" price="0ct"/>
                    <append_to_list name="$TradeOfferList" exact="$TradeOffer"/>
                  </do_for_each>
                  <do_if value="Ch8_Create_Mission_v2.state == cuestate.waiting">
                    <signal_cue cue="Ch8_Create_Mission_v2"/>
                  </do_if>
                  <do_else>
                    <signal_cue cue="Ch8_Deliver_Resources_v2"/>
                  </do_else>
                </do_if>
                <do_else>
                  <signal_cue cue="Ch8_Set_DeliveryStation_Retry_v2"/>
                </do_else>
                <reset_cue cue="this"/>
              </patch>
            </cue>

            <cue name="Ch8_Create_Mission_v2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$Ch8_CreateMissionEarly"/>
                <set_value name="$descrSink3Curb" exact="'\n\n' + {30221,9107} + ' ' + {30221,9108} + ' ' + {30221,9109} + ' ' + {30221,9110}"/>
                <!--  + '\n\n' + {30221,9111} -->

                <!-- Mission : Zyarth's Coffin -->
                <create_mission cue="$MissionCue" description="{30221,8002} + ' ' + {30221,8003} + $descrSink3Curb" name="{30221,8001}" group="missiongroup.story_split_court"
                                faction="faction.player" type="missiontype.plot" abortable="false" difficulty="level.veryhard" rewardtext="{30221,8007}"
                                icon="'briefing_yu_t_knk_01'" iconcaption="$OutcastActor.name">
                  <!-- Is a briefing required? -->
                </create_mission>
              </actions>
              <cues>
                <cue name="Ch8_Speak_Dal_711_Ref_v2" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$DalBusta, $BosoTa]"/>
                  <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey]"/>
                  <param name="Lines"             value="[[[30221711], [30221712], [30221713], [30221714], [30221715]],
                                                          [[30221711]]
                                                                      ]"/>
                  <param name="MissionCue"        value="if $Ch8_CreateMissionEarly? then $MissionCue else null"/>
                  <param name="IsInMission"       value="$Ch8_CreateMissionEarly?"/>
                  <param name="EndSignalCue"      value="[Ch8_Create_Mission_Briefing_v2, null]"/>
                  <!--
                Dal	<t id="30221711	">	I've picked up some news from the rebel broadcasts.	</t>
                Dal	<t id="30221712	">	The Curb rebels, I mean, not the slave revolt.	</t>
                Dal	<t id="30221713	">	The Curbs are planning a major attack on the Patriarchy; no details given.	</t>
                Dal	<t id="30221714	">	From what I can work out, they are planning to put an end to the Zyarth Patriarchy through major attacks on Zyarth home sectors.	</t>
                Dal	<t id="30221715	">	For this purpose they're asking for a huge delivery.	</t>
                Boso	<t id="30221	711	">	It would seem they have something explosive in mind.	</t>
                -->
                </cue>
                <cue name="Ch8_Create_Mission_Briefing_v2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch8_Deliver_Resources_v2"/>
                    <do_if value="not $Ch8_CreateMissionEarly?">
                      <set_value name="$descrSink3Curb" exact="'\n\n' + {30221,9107} + ' ' + {30221,9108} + ' ' + {30221,9109} + ' ' + {30221,9110}"/>
                      <!--  + '\n\n' + {30221,9111} -->

                      <!-- Mission : Zyarth's Coffin -->
                      <create_mission cue="$MissionCue" description="{30221,8002} + ' ' + {30221,8003} + $descrSink3Curb" name="{30221,8001}" group="missiongroup.story_split_court"
                                      faction="faction.player" type="missiontype.plot" abortable="false" difficulty="level.veryhard" rewardtext="{30221,8007}"
                                      icon="'briefing_yu_t_knk_01'" iconcaption="$OutcastActor.name">
                        <!-- Is a briefing required? -->
                      </create_mission>
                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch8_Set_DeliveryStation_Retry_v2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="6277s"/>
              <actions>
                <signal_cue cue="Ch8_Set_DeliveryStation_v2"/>
                <reset_cue cue="this"/>
              </actions>
            </cue>

            <cue name="Ch8_Deliver_Resources_v2" version="3">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <patch sinceversion="2">
                <set_value name="Ch8_Deliver_Resources_Ref_v2.$Offers" exact="$TradeOfferList"/>
              </patch>
              <patch sinceversion="3">
                <do_if value="not Ch8_Deliver_Resources_Ref_v2.$Offers">
                  <set_value name="Ch8_Deliver_Resources_Ref_v2.$Offers" exact="$TradeOfferList"/>
                </do_if>
              </patch>
              <cues>
                <cue name="Ch8_Deliver_Resources_Ref_v2" ref="md.RML_Deliver_Wares.DeliverWares">
                  <param name="EndSignalCue"  value="Ch8_Deliver_Resources_End_v2"/>
                  <param name="MissionCue"    value="$MissionCue"/>
                  <param name="StartStep"     value="1"                       comment="Briefing step to start the mission on." />
                  <param name="Station"       value="$DeliveryStation"          comment="The station to which the player should deliver wares" />
                  <param name="Wares"         value="$DeliverResourcesTable"  comment="Table of wares to accept. Format: table[{$Ware1} = $Amount1, {$Ware2} = $Amount2, ...]" />
                  <param name="Offers"        value="$TradeOfferList"         comment="" />
                  <param name="PlayerOnly"    value="true"                    comment="Should the RML only accept trades made by player-owned ships?"/>
                  <param name="DebugChance"   value="$DebugChance" />
                </cue>

                <cue name="Ch8_Deliver_Resources_Failsafe" onfail="cancel">
                  <conditions>
                    <check_value value="Ch8_Deliver_Resources_End_v2.state == cuestate.waiting"/>
                  </conditions>
                  <cues>

                    <cue name="Ch8_Deliver_Resources_Failsafe_Check">
                      <delay exact="10s"/>
                      <actions>
                        <set_value name="$CompletedTradeOffersCount" exact="0"/>
                        <do_for_each in="$TradeOfferList" name="$CurrentOffer">
                          <do_if value="not @$CurrentOffer.available or not $CurrentOffer.offeramount">
                            <do_if value="not @$CurrentOffer.available">
                              <debug_text text="'Offer no longer available.'" chance="$DebugChance"/>
                            </do_if>
                            <do_else>
                              <debug_text text="'BUG! OFFER IS AVAILABLE BUT OFFERAMOUNT IS 0: ' + $CurrentOffer.ware" chance="$DebugChance"/>
                            </do_else>
                            <set_value name="$CompletedTradeOffersCount" operation="add"/>
                          </do_if>
                          <do_else>
                            <debug_text text="$CurrentOffer.ware + ' needed: ' + $CurrentOffer.offeramount" chance="$DebugChance"/>
                          </do_else>
                        </do_for_each>

                        <debug_text text="$CompletedTradeOffersCount + ' offers out of ' + $TradeOfferList.count + ' completed.'" chance="$DebugChance"/>

                        <do_if value="$CompletedTradeOffersCount == $TradeOfferList.count">
                          <debug_text text="'All trades completed.'" chance="$DebugChance"/>
                          <signal_cue cue="Ch8_Deliver_Resources_End_v2"/>
                          <cancel_cue cue="Ch8_Deliver_Resources_Ref_v2"/>
                        </do_if>
                        <do_else>
                          <reset_cue cue="this"/>
                        </do_else>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="PATCH_Ch8_Reduce_Ware_Amount">
                  <actions>
                    <do_if value="$Patch_Decreased_Ware_Amount_patch_v2?">

                      <!-- Calculate the value of already delivered wares -->
                      <set_value name="$DeliveredValue" exact="0"/>

                      <do_for_each in="$OldResourcesTable" name="$Ware">
                        <do_if value="md.Story_Split.Ch8_Deliver_Resources_Ref_v2.$RemainingWares.{$Ware}?">
                          <set_value name="$DeliveredAmount" exact="$OldResourcesTable.{$Ware} - (md.Story_Split.Ch8_Deliver_Resources_Ref_v2.$RemainingWares.{$Ware})"/>
                        </do_if>
                        <do_else>
                          <set_value name="$DeliveredAmount" exact="$OldResourcesTable.{$Ware}"/>
                        </do_else>
                        <set_value name="$DeliveredValue" exact="$DeliveredAmount * $Ware.averageprice" operation="add"/>

                        <!-- Remove the delivered Amount from the new table-->
                        <do_if value="($DeliverResourcesTable.{$Ware} - $DeliveredAmount) le 0">
                          <remove_value name="$DeliverResourcesTable.{$Ware}"/>
                        </do_if>
                        <do_else>
                          <set_value name="$DeliverResourcesTable.{$Ware}" exact="($DeliverResourcesTable.{$Ware} - $DeliveredAmount)"/>
                        </do_else>
                      </do_for_each>



                      <set_value name="$Pay_Value" exact="($DeliveredValue)" operation="subtract"/>

                      <set_value name="$AllZero" exact="true"/>

                      <!-- Reset Trade Offers -->
                      <do_for_each in="$TradeOfferList" name="$TradeOffer">
                        <remove_trade_offer object="$DeliveryStation" tradeoffer="$TradeOffer"/>
                      </do_for_each>
                      <create_list name="$TradeOfferList"/>
                      <do_for_each in="$DeliverResourcesTable.keys.list" name="$CurrentWare">
                        <do_if value="$DeliverResourcesTable.{$CurrentWare} gt 0">
                          <set_value name="$AllZero" exact="false"/>
                          <create_trade_offer buyer="$DeliveryStation" object="$DeliveryStation" ware="$CurrentWare" amount="$DeliverResourcesTable.{$CurrentWare}" missioncue="namespace" name="$TradeOffer" playeronly="true" price="0ct"/>
                          <append_to_list name="$TradeOfferList" exact="$TradeOffer"/>
                        </do_if>
                      </do_for_each>

                      <do_if value="$AllZero">
                        <set_value name="Ch8_Deliver_Resources_End_v2.$EndFeedbackValue" exact="999999" />
                        <signal_cue cue="Ch8_Deliver_Resources_End_v2"/>
                      </do_if>
                      <do_else>
                        <reset_cue cue="Ch8_Deliver_Resources_Ref_v2"/>
                        <update_mission cue="$MissionCue">
                          <briefing replace="true"/>
                        </update_mission>
                      </do_else>

                    </do_if>
                  </actions>
                </cue>
              </cues>
            </cue>
            <cue name="Ch8_Deliver_Resources_End_v2" version="3">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <reset_cue cue="Ch8_Deliver_Resources_v2"/>
                <cancel_cue cue="Ch8_Deliver_Resources_Failsafe_Check"/>

                <do_if value="not this.$EndFeedbackValue? and (Ch8_Deliver_Resources_Failsafe_Check.state != cuestate.complete)">
                  <assert value="false" text="'[Heinrich] RML_Deliver_Wares did not provide a feedback value.'"/>
                </do_if>

                <do_if value="(@this.$EndFeedbackValue gt 0) or (Ch8_Deliver_Resources_Failsafe_Check.state == cuestate.complete)" comment="Successfully Delivered Everything">
                  <set_value name="$CurrentStep" exact="$DeliverResourcesTable.keys.count"/>
                  <do_if value="$Pay_Value gt 0">
                    <signal_cue cue="Ch8_Payment"/>
                  </do_if>
                  <do_else>
                    <signal_cue cue="Ch8_Mission_To_Initiate_Sink_v2"/>
                  </do_else>
                  <do_for_each in="$TradeOfferList" name="$TradeOffer">
                    <remove_trade_offer object="$DeliveryStation" tradeoffer="$TradeOffer"/>
                  </do_for_each>
                </do_if>
                <do_else comment="Container most likely destroyed, retry">
                  <signal_cue cue="Ch8_Set_DeliveryStation_v2"/>
                  <reset_cue cue="this"/>
                </do_else>
              </actions>
              <patch sinceversion="2">
                <set_value name="$CurrentStep" exact="$DeliverResourcesTable.keys.count"/>
              </patch>
              <patch sinceversion="3">
                <do_if value="(this.$EndFeedbackValue == 1) and Ch8_Mission_To_Initiate_Sink_v2.state == cuestate.waiting and Ch8_Payment.state == cuestate.waiting">
                  <reset_cue cue="Ch8_Deliver_Resources_v2"/>
                  <set_value name="$CurrentStep" exact="$DeliverResourcesTable.keys.count"/>
                  <do_if value="$Pay_Value gt 0">
                    <signal_cue cue="Ch8_Payment"/>
                  </do_if>
                  <do_else>
                    <signal_cue cue="Ch8_Mission_To_Initiate_Sink_v2"/>
                  </do_else>
                  <do_for_each in="$TradeOfferList" name="$TradeOffer">
                    <remove_trade_offer object="$DeliveryStation" tradeoffer="$TradeOffer"/>
                  </do_for_each>
                </do_if>
              </patch>
            </cue>

            <cue name="Ch8_Payment" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" exact="1" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$DalBusta" updatebriefing="true"/>

              </actions>
              <patch sinceversion="2">
                <set_value name="$CurrentStep" exact="1" operation="add"/>
              </patch>
              <cues>
                <cue name="Ch8_Payment_Dialog" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$DalBusta" conversation="default"/>
                      <event_conversation_next_section actor="$DalBusta"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="event.name == 'event_conversation_started'">
                      <add_player_choice section="story_split" selectable="true"
                   text="{30221,302}" comment="'The Split Connection'"/>
                      <!-- choice param remains null for Ch0_Dal_Split_Dialog -->
                      <add_player_choice section="main" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>
                    </do_if>
                    <do_elseif value="event.name == 'event_conversation_next_section'">
                      <do_if value="event.param == 'story_split'">
                        <add_npc_line speaker="$DalBusta" line="30220981" comment="This will be rather expensive." hidechoices="true"/>
                        <add_player_choice section="main" selectable="true" text="readtext.{1002}.{20}" comment="\(Back\)" position="bottom_right"/>


                        <substitute_text text="$OfferCredits" source="{30221,3280}" comment="(Player Choice to Pay)Offer $CREDITS$ Cr">
                          <replace string="'$CREDITS$'" with="'' + (($Pay_Value)).formatted.default" />
                        </substitute_text>
                        <set_value name="$PlayerHasEnoughMoney" exact="player.money ge ($Pay_Value)"/>

                        <add_player_choice section="ch8_paid" choiceparam="'contribution'"
                                           text="$OfferCredits" comment="Offer Cr"
                                           selectable="$PlayerHasEnoughMoney"
                                           tooltip="if $PlayerHasEnoughMoney then '' else {30221,3271}"/>
                      </do_if>
                      <do_elseif value="event.param == 'ch8_paid'">
                        <add_npc_line speaker="$DalBusta" line="30220985" comment="That should do it!" hidechoices="true"/>
                        <transfer_money from="faction.player" to="faction.court" amount="($Pay_Value)"/>

                        <cancel_cue cue="parent"/>
                        <signal_cue cue="Ch8_Mission_To_Initiate_Sink_v2"/>
                      </do_elseif>
                    </do_elseif>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch8_Mission_To_Initiate_Sink_Retry_v2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <reset_cue cue="Ch8_Mission_To_Initiate_Sink_v2"/>
              </actions>
              <cues>
                <cue name="Ch8_Mission_To_Initiate_Sink_Retry2_v2" checkinterval="3s">
                  <conditions>
                    <check_value value="Ch8_Mission_To_Initiate_Sink_v2.state == cuestate.waiting"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch8_Mission_To_Initiate_Sink_v2"/>
                    <reset_cue cue="parent"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch8_Mission_To_Initiate_Sink_v2" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_group groupname="$SabotageTargetStation_Group"/>
                <create_group groupname="$CoverStation"/>
                <set_objective cue="$MissionCue" action="objective.wait"/>
                <create_loadout result="$loadout_Trading_Boa">
                  <macros>
                    <engine macro="engine_spl_m_travel_01_mk1_macro" path="../con_engine_02"/>
                    <engine macro="engine_spl_m_travel_01_mk1_macro" path="../con_engine_01"/>
                    <shield macro="shield_spl_m_standard_01_mk1_macro" path="../con_shield_01"/>
                    <turret macro="turret_spl_m_flak_01_mk1_macro" path="../con_turret_l01"/>
                    <turret macro="turret_spl_m_flak_01_mk1_macro" path="../con_turret_r01"/>
                  </macros>
                  <software>
                    <software ware="software_flightassistmk1"/>
                    <software ware="software_scannerlongrangemk1"/>
                    <software ware="software_scannerobjectmk1"/>
                    <software ware="software_trademk1"/>
                  </software>
                  <virtualmacros>
                    <thruster macro="thruster_gen_m_allround_01_mk1_macro"/>
                  </virtualmacros>
                </create_loadout>
              </actions>
              <patch sinceversion="2">
                <create_group groupname="$CoverStation"/>
              </patch>
              <cues>
                <cue name="Ch8_Outcast_711_v2" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$OutcastActor"/>
                  <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                  <param name="Lines"             value="[
                                [30221711],[30221712]
                  ]"/>
                  <!--                       
                  Outcast	<t id="30221711	">	Wonderful.	</t>
                  Outcast	<t id="30221712	">	With this delivery Split can set plan in motion.	</t>-->
                  <param name="EndSignalCue"    value="Ch8_Find_Sabotage_Source_Station_v2"/>
                </cue>

                <cue name="Ch8_Find_Sabotage_Source_Station_v2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$DeliveryStation.exists">
                      <find_dockingbay name="$dock" object="$DeliveryStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_m" storage="true" free="true"/>
                      </find_dockingbay>
                    </do_if>

                    <do_if value="not $dock.exists">
                      <find_station_by_true_owner faction="faction.court" space="player.galaxy" name="$Station" sortbygatedistanceto="player.entity">
                        <match_dock size="tag.dock_m" storage="true" free="true"/>
                      </find_station_by_true_owner>
                      <do_if value="not $Station">
                        <find_station_by_true_owner faction="faction.freesplit" space="player.galaxy" name="$Station" sortbygatedistanceto="player.entity">
                          <match_dock size="tag.dock_m" storage="true" free="true"/>
                        </find_station_by_true_owner>
                      </do_if>

                      <do_if value="$Station">
                        <find_dockingbay name="$dock" object="$Station" checkoperational="true" multiple="false">
                          <match_dock size="tag.dock_m" storage="true" free="true"/>
                        </find_dockingbay>
                      </do_if>
                    </do_if>

                    <find_station_by_true_owner faction="faction.split" space="player.galaxy" name="$SabotageTargetStation" multiple="false" defencestation="true" sortbygatedistanceto="player.entity">
                      <match_dock size="tag.dock_m"/>
                    </find_station_by_true_owner>

                    <do_if value="not $SabotageTargetStation.exists">
                      <find_station_by_true_owner faction="faction.split" space="player.galaxy" name="$SabotageTargetStation" multiple="false" sortbygatedistanceto="player.entity">
                        <match_dock size="tag.dock_m"/>
                      </find_station_by_true_owner>
                    </do_if>

                    <do_if value="$dock? and $dock.exists and $SabotageTargetStation.exists">
                      <add_to_group groupname="$SabotageTargetStation_Group" object="$SabotageTargetStation"/>
                      <signal_cue cue="Ch8_Create_Trading_Ship_v2"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Ch8_Find_Sabotage_Source_Station_Retry_v2"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch8_Find_Sabotage_Source_Station_Retry_v2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Ch8_Find_Sabotage_Source_Station_v2"/>
                  </actions>
                  <delay exact="63s" comment="6277s"/>
                  <actions>
                    <signal_cue cue="Ch8_Find_Sabotage_Source_Station_v2"/>
                    <reset_cue cue="this"/>
                  </actions>
                </cue>

                <cue name="Ch8_Create_Trading_Ship_v2" version="6">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_ship name="$SabotageTrader" macro="ship_spl_m_trans_container_01_a_macro" sector="$dock.sector" dock="$dock" sellable="false" groupname="$SabotageTraderGroup">
                      <owner exact="$dock.owner" comment="pitfall: needs to be dock owner to not fail if player is not at docking relations"/>
                      <paint ware="$SplitPaintMods.$familiesStripes"/>
                      <!--<paint ware="$SplitPaintMods.$familiesBasic"/>-->
                      <loadout loadout="$loadout_Trading_Boa"/>
                      <!--<pilot>
                        <select faction="faction.player" tags="tag.fighterpilot"/>
                      </pilot>-->
                      <people ref="split_elite_military_crew">
                        <fillpercent exact="0"/>
                      </people>
                    </create_ship>
                    <set_owner object="$SabotageTrader" faction="faction.player" comment="pitfall: needs to be done after creation to avoid spawn failure cases due to relations"/>
                    <signal_cue cue="Ch8_SabotageTrader_Cover_Init"/>
                    <set_object_npc_assignment_restricted object="$SabotageTrader" restricted="true"/>

                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.embark" object="$SabotageTrader" updatebriefing="true" text="{30221,8004}"/>
                  </actions>
                  <patch sinceversion="2">
                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                  </patch>
                  <patch sinceversion="3">
                    <do_if value="Ch8_Escape_Station_Liberated_v2.state != cuestate.complete and Ch8_Escape_Station_Liberated_v2.state != cuestate.cancelled">
                      <set_object_npc_assignment_restricted object="$SabotageTrader" restricted="true"/>
                    </do_if>
                  </patch>
                  <patch sinceversion="4">
                    <do_if value="$SabotageTrader.exists and
                                  ($SabotageTrader.trueowner != faction.player) and
                                  (not $Ch8_CoverMission_Done?)">
                      <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                        <param name="Ship" value="$SabotageTrader"/>
                        <param name="Faction" value="faction.player"/>
                      </run_actions>
                    </do_if>
                    <set_object_sellable object="$SabotageTrader" sellable="false"/>
                  </patch>
                  <patch sinceversion="5">
                    <do_if value="(null == $SabotageTrader) and (not $Ch8_CoverMission_Done?)">
                      <set_value name="$PATCH_CreateShip_SabotageTrader"/>
                      <signal_cue cue="Ch8_Mission_To_Initiate_Sink_Retry_v2"/>
                    </do_if>
                  </patch>
                  <patch sinceversion="6">
                    <do_if value="not $Ch8_CoverMission_Done?">
                      <set_value name="$Patch_CoverHandler_SwitchToButton"/>
                    </do_if>
                    <add_to_group groupname="$SabotageTraderGroup" object="$SabotageTrader"/>
                    <set_value name="$Patch_Ch8_SabotageTrader_Cover_Init"/>
                  </patch>
                  <cues>

                    <cue name="Ch8_SabotageTrader_FixOwner" checkinterval="60s" instantiate="true">
                      <conditions>
                        <check_value value="$SabotageTrader.trueowner != faction.player"/>
                      </conditions>
                      <actions>
                        <run_actions ref="md.LIB_Generic.TransferShipOwnership">
                          <param name="Ship" value="$SabotageTrader"/>
                          <param name="Faction" value="faction.player"/>
                        </run_actions>
                      </actions>
                    </cue>

                    <cue name="Ch8_Retrieve_SabotageTrader2" ref="md.LIB_Generic.RetrieveShip">
                      <param name="Ship"                  value="$SabotageTrader"/>
                      <param name="SignalCue_Retrieved" value="Ch8_Retrieved"/>
                    </cue>
                    <cue name="Ch8_Retrieved" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Retrieved $SabotageTrader '" chance="$DebugChance"/>
                      </actions>
                    </cue>

                    <cue name="Ch8_Mission_Ship_Destroyed_Reset_v2">
                      <conditions>
                        <event_object_destroyed object="$SabotageTrader"/>
                        <check_value value="not $Ch8_CoverMission_Done?"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch8_Mission_To_Initiate_Sink_Retry_v2"/>
                      </actions>
                    </cue>

                    <!-- Deprecated Cues, kept to not duplicate names in future cues -->
                    <!-- Deleted library:
                    <cue name="Ch8_SabotageTrader_Cover_Handler" ref="md.LIB_Generic.Cover_Handler"></cue>-->
                    <cue name="Ch8_Mission_Ship_Lost_Cover_Reset" comment="deprecated"></cue>
                    <cue name="Ch8_Mission_Ship_Lost_Cover_Init" comment="deprecated"></cue>
                    <cue name="Ch8_Mission_Ship_Reset_Cover" comment="Deprecated" version="2">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="false"/>
                      </conditions>
                      <patch sinceversion="2">
                        <cancel_cue cue="this"/>
                      </patch>
                      <cues>
                        <cue name="Ch8_Find_CoverStation" comment="deprecated">
                          <cues>
                            <cue name="Ch8_Find_CoverStation_Retry" comment="deprecated"></cue>
                            <cue name="Ch8_CoverStation_Destroyed" comment="deprecated"></cue>
                            <cue name="Ch8_CoverShip_Docked" comment="deprecated"></cue>
                          </cues>
                        </cue>
                        <cue name="Ch8_CoverShip_On_CoverStation" comment="deprecated">
                          <cues>
                            <cue name="Ch8_Reset_Cover" comment="deprecated"></cue>
                          </cues>
                        </cue>
                        <cue name="Ch8_Faction_Relation_Changed" comment="deprecated"></cue>
                      </cues>
                    </cue>
                    <cue name="Ch8_Covership_Embark" instantiate="true" comment="deprecated">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                    </cue>
                    <cue name="Ch8_Covership_In_Control" instantiate="true" comment="deprecated">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                    </cue>
                    <!-- End of Deprecated Cues -->

                    <cue name="Ch8_Mission_TargetStation_Destroyed_Reset_v2" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$SabotageTargetStation_Group"/>
                        <check_value value="not $Ch8_CoverMission_Done?"/>
                      </conditions>
                      <actions>
                        <create_group groupname="$SabotageTargetStation_Group" comment="empty the group"/>

                        <find_station_by_true_owner faction="faction.split" space="player.galaxy" name="$SabotageTargetStation" multiple="false" defencestation="true" sortbygatedistanceto="$SabotageTrader">
                          <match_dock size="tag.dock_m"/>
                        </find_station_by_true_owner>

                        <do_if value="not $SabotageTargetStation.exists">
                          <find_station_by_true_owner faction="faction.split" space="player.galaxy" name="$SabotageTargetStation" multiple="false" sortbygatedistanceto="$SabotageTrader">
                            <match_dock size="tag.dock_m"/>
                          </find_station_by_true_owner>
                        </do_if>
                        <add_to_group groupname="$SabotageTargetStation_Group" object="$SabotageTargetStation"/>
                        <do_if value="not $SabotageTargetStation_Group.count">
                          <signal_cue cue="Ch8_Mission_TargetStation_Destroyed_Reset_Retry" check="false"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch8_Mission_TargetStation_Destroyed_Reset_Retry">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="63s"/>
                      <actions>
                        <do_if value="not $Ch8_CoverMission_Done?">
                          <signal_cue cue="Ch8_Mission_TargetStation_Destroyed_Reset_v2"/>
                          <reset_cue cue="this"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch8_Patch_Fix_Objective">
                      <actions>
                        <signal_cue cue="Ch8_Objective_Setup"/>
                      </actions>
                    </cue>
                    <cue name="Ch8_Objective_Setup" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_player_stopped_control/>
                          <check_all>
                            <event_player_started_control/>
                            <check_value value="player.controlled == $SabotageTrader"/>
                          </check_all>
                        </check_any>
                        <check_value value="not $Ch8_CoverMission_Done?"/>
                      </conditions>
                      <actions>
                        <do_if value="$SabotageTrader == player.controlled">
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.dockat" group="$SabotageTargetStation_Group" updatebriefing="true"/>
                        </do_if>
                        <do_else>
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.embark" object="$SabotageTrader" text="{30221,8004}" updatebriefing="true"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Ch8_Outcast_713_v2" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$OutcastActor"/>
                      <param name="CutsceneKey"       value="$OutcastCutsceneKey"/>
                      <param name="Lines"             value="[
                                [if player.entity.isfemale then 30221714 else 30221713],
                                [if player.entity.isfemale then 30221716 else 30221715]
                      ]"/>
                      <!--                       
                  Outcast	<t id="30221713	">	Trusted pilot will get control of trade ship.	</t>
                  Outcast	<t id="30221714	">	(spoken to female 'you'){,30221713}	</t>
                  Outcast	<t id="30221715	">	Task is to dock at Patriarchy station to deliver bombs. Agents on station will set rest in motion.	</t>
                  Outcast	<t id="30221716	">	(spoken to female 'you'){,30221715}	</t>-->
                      <param name="EndSignalCue"    value="null"/>
                    </cue>

                    <cue name="Ch8_Sabotage_Target_Station_v2">
                      <conditions>
                        <event_object_undocked object="$SabotageTrader" comment="player owned, but not necessarily the player"/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.dockat" group="$SabotageTargetStation_Group" updatebriefing="true"/>
                      </actions>
                      <cues>
                        <cue name="Ch8_Sabotage_Docked_v2" instantiate="true">
                          <conditions>
                            <event_object_docked_at group="$SabotageTargetStation_Group"/>
                          </conditions>
                          <actions>
                            <do_if value="(Ch8_Sabotage_Docked_Successful.state == cuestate.waiting) and (event.param == $SabotageTrader)">
                              <set_value name="$CutsceneStation" exact="event.object"/>
                              <signal_cue cue="Ch8_Sabotage_Docked_Successful"/>
                            </do_if>
                          </actions>
                        </cue>
                        <cue name="Ch8_Sabotage_Docked_Successful" version="2">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$Ch8_CoverMission_Done"/>
                          </actions>
                          <patch sinceversion="2">
                            <set_value name="$Ch8_CoverMission_Done"/>
                          </patch>
                          <cues>
                            <cue name="Ch8_Escaped_713_ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$EscapedActor"/>
                              <param name="CutsceneKey"       value="$EscapedCutsceneKey"/>
                              <param name="Lines"             value="[
                                [if player.entity.isfemale then 30221712 else 30221711],
                                [if player.entity.isfemale then 30221714 else 30221713],
                                [30221715]
                          ]"/>
                              <!--                       
                          <t id="30221711">Looks like you got promoted since our last station takeover.</t>
                          <t id="30221712">(spoken to female 'you'){,30221711}</t>
                          <t id="30221713">Ready to liberate another station?</t>
                          <t id="30221714">(spoken to female 'you'){,30221713}</t>
                          <t id="30221715">Patriarchy security didn't learn much from last time.</t>
                          -->
                              <param name="EndSignalCue"    value="Ch8_Cutscene_v2"/>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch8_Cutscene_v2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <play_cutscene result="$CutsceneID" key="'Story_Split_Escape'" abortable="true">
                      <param name="target_station" object="$CutsceneStation" />
                      <param name="target_ship" object="$SabotageTrader" />
                    </play_cutscene>
                  </actions>
                  <cues>
                    <cue name="Ch8_Explosions1_v2">
                      <conditions>
                        <event_cutscene_started key="'Story_Split_Escape'"/>
                      </conditions>
                      <actions>
                        <add_effect object="$CutsceneStation" effect="'ref_explosion_station_explosion01'"/>
                      </actions>
                      <delay exact="3s"/>
                      <actions>
                        <add_effect object="$CutsceneStation" effect="'ref_explosion_station_explosion01'"/>
                        <add_effect object="$CutsceneStation" effect="'ref_explosion_station_explosion01'"/>
                      </actions>
                      <delay exact="6s"/>
                      <actions>
                        <add_effect object="$CutsceneStation" effect="'ref_explosion_station_explosion01'"/>
                        <add_effect object="$CutsceneStation" effect="'ref_explosion_station_explosion01'"/>
                      </actions>
                    </cue>

                    <cue name="Ch8_Cutscene_Complete_v2" version="2">
                      <conditions>
                        <event_cutscene_stopped key="'Story_Split_Escape'"/>
                      </conditions>
                      <actions>
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.undock" updatebriefing="true"/>
                        <signal_cue cue="Ch8_Escape_Explosions_v2"/>
                      </actions>
                      <patch sinceversion="2">
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                      </patch>
                    </cue>

                    <cue name="Ch8_Escape_Explosions_v2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch8_Escape_MoreExplosions_v2" checkinterval="12s" instantiate="true">
                          <actions>
                            <add_effect object="$CutsceneStation" effect="'ref_explosion_station_explosion01'" comment="effect lasts about 10 seconds"/>
                          </actions>
                        </cue>
                        <cue name="Ch8_Escape_Station_v2" checkinterval="2s" instantiate="true">
                          <conditions>
                            <check_value value="player.entity.station != $CutsceneStation" comment="player left station (stop explosions)"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch8_Escape_Station_Liberated_v2"/>
                            <cancel_cue cue="Ch8_Escape_Explosions_v2"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch8_Escape_Station_Liberated_v2" version="2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.wait" updatebriefing="true"/>
                        <set_value name="$Ch8_CoverMission_Done"/>
                        <cancel_cue cue="Ch8_Covership_Embark"/>
                        <cancel_cue cue="Ch8_Covership_In_Control"/>
                        <set_object_npc_assignment_restricted object="$SabotageTrader" restricted="false"/>

                        <set_relation_boost object="$CutsceneStation" value="0.15" faction="faction.player" silent="true" decay="0" reason="relationchangereason.missioncompleted"/>

                        <run_actions ref="md.LIB_Generic.TransferStationOwnership">
                          <param name="Station" value="$CutsceneStation"/>
                          <param name="Faction" value="faction.argon"/>
                        </run_actions>
                      </actions>
                      <patch sinceversion="2">
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                      </patch>
                      <cues>
                        <cue name="Ch8_Escaped_718_v2" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$EscapedActor, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$EscapedCutsceneKey, $DalCutsceneKey]"/>
                          <param name="Lines"             value="[[
                                [if player.entity.isfemale then 30221718 else 30221716],
                                [30221717]], [[30221720]]
                          ]"/>
                          <param name="MissionCue"        value="$MissionCue"/>
                          <!--
                  <t id="30221716">The Argon thank you for your continued support.</t>
                  <t id="30221717">Station is under Argon control, I repeat, station is now under the territorial sovereignty of the Federation.</t>
                  <t id="30221718">(spoken to female 'you'){,30221716}</t>
                  Dal	<t id="30221720	">	The slave revolt is spreading to a couple of other stations nearby.	</t>-->
                          <param name="EndSignalCue"    value="[Sink_Effect_Curbs_Stage3_NewPatriarchy, null]"/>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch8_Sink_Completed_v2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
              </actions>
              <cues>
                <cue name="Ch8_Speak_Curb_721_Ref_v2" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$CurbActor, $DalBusta]"/>
                  <param name="CutsceneKey"       value="[$CurbCutsceneKey, $DalCutsceneKey]"/>
                  <param name="Lines"             value="[
                                                         [[30221721], [30221722], [30221723], [30221724], [30221725]],
                                                         [[30221721], [30221722], [30221723], [30221724], [30221726]]
                                                         ]"/>
                  <param name="MissionCue"        value="$MissionCue"/>
                  <param name="EndSignalCue"      value="[null, Ch8_Achievement_Curbs_v2]"/>
                  <!--
                Curb	<t id="30221721	">	Patriarchs weak and traitorous.	</t>
                Curb	<t id="30221722	">	Zyarth no more.	</t>
                Curb	<t id="30221723	">	Rhak took over Patriarchy.	</t>
                Curb	<t id="30221724	">	No creature oppose reign of Curbs.	</t>
                Curb	<t id="30221725	">	Free Families decide to submit to victorious Curb rule or perish.	</t>
                Dal	  <t id="30221721	">	She's right.	</t>
                Dal	  <t id="30221722	">	Patriarch Zyarth was overthrown by one of his subjects, a Patriarch by the name of Rhak t'Ttk.	</t>
                Dal	  <t id="30221723	">	The Rhak Patriarchy declared an armistice with the Curbs.	</t>
                Dal	  <t id="30221724	">	They saw where their war would lead and decided to put an end to it.	</t>
 not used       Dal	  <t id="30221725	">	The Curbs, however, decided to take over the unassociated Families.	</t>
                Dal	  <t id="30221726	">	There are already tensions between the Curbs and the Argon Federation over slavery, but as long as the Curbs don't attack Argon stations there won't be an all-out war.	</t>-->
                </cue>
                <cue name="Ch8_Achievement_Curbs_v2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <remove_mission cue="$MissionCue" type="completed"/>
                    <write_to_logbook category="missions" faction="faction.player" title="{30221,8001}" text="if player.entity.isfemale then {30221,8006} else {30221,8005}"/>

                    <unlock_achievement name="SV_PLOT_SPLIT_SINK1"/>
                    <set_userdata storystate="'story_split_court_complete'" value="1"/>
                    <cancel_cue cue="Ch8_Stage_3_v2"/>
                  </actions>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Ch8_SabotageTrade_Cover">
          <cues>

            <cue name="Patch_Ch8_SabotageTrader_Cover_Init" onfail="cancel">
              <conditions>
                <check_value value="$Patch_Ch8_SabotageTrader_Cover_Init?"/>
              </conditions>
              <actions>
                <signal_cue cue="Ch8_SabotageTrader_Cover_Init"/>
              </actions>
            </cue>
            <cue name="Ch8_SabotageTrader_Cover_Init" version="2">
              <conditions>
                <event_cue_signalled/>
                <check_value value="$SabotageTraderGroup.count"/>
                <check_value value="$SabotageTraderGroup.{1}.isoperational"/>
                <check_value value="$SabotageTraderGroup.{1}.isplayerowned"/>
                <!--<check_value value="not $CoverDisabled_Penalty?"/>-->
              </conditions>
              <actions>
                <!-- remove potential existing cover owner (old cover system) -->
                <do_if value="($SabotageTraderGroup.{1}.coverowner == faction.split)
                          and (not $Patch_CoverHandler_SwitchToButton?)">
                  <!--<speak actor="player.computer" line="1505" comment="Cover deactivated"/>-->
                  <set_cover_owner object="$SabotageTraderGroup.{1}"/>
                  <set_cover_owner object="player.entity"/>
                </do_if>
                <!-- setup new cover system -->
                <signal_cue_instantly cue="md.Cover.RegisterCoverAbility" param="[$SabotageTraderGroup.{1}, faction.split]"/>
                <do_if value="player.entity.hascontext.{$SabotageTraderGroup.{1}}
                          and ($SabotageTraderGroup.{1}.coverowner != faction.split)">
                  <speak actor="player.computer" comment="Cover available: Factionname">
                    <text line="1508"/>
                    <name value="faction.split"/>
                  </speak>
                </do_if>
              </actions>
              <patch sinceversion="2">
                <signal_cue_instantly cue="md.Cover.RegisterCoverAbility" param="[$SabotageTraderGroup.{1}, faction.split]"/>
                <set_value name="$Patch_TranslatedToNewCoverSystem"/>
              </patch>
            </cue>

            <!-- Deprecated: this is not needed anymore since r563103 -->
            <cue name="Ch8_SabotageTrader_Cover_AttackedCoverFaction" instantiate="true">
              <conditions>
                <event_object_attacked_object group="$SabotageTraderGroup"/>
                <check_value value="false"/>
                <check_value value="$SabotageTraderGroup.{1}.isoperational"/>
                <check_value value="$SabotageTraderGroup.{1}.isplayerowned"/>
                <check_value value="[faction.split].indexof.{event.param.owner}"/>
              </conditions>
              <actions>
                <!-- penalty: remove cover -->
                <signal_objects object="player.ship" param="'lose_cover_ability'" />
                <speak actor="player.computer" line="1506" comment="Cover exposed"/>
                <set_cover_owner object="$SabotageTraderGroup.{1}"/>
                <set_cover_owner object="player.entity"/>
                <!-- setup timeout to reset cover handler -->
                <set_value name="$CoverDisabled_Penalty"/>
                <reset_cue cue="Ch8_SabotageTrader_Cover_Init"/>
                <reset_cue cue="Ch8_SabotageTrader_Cover_Timeout"/>
              </actions>
            </cue>

            <!-- Deprecated: this is not needed anymore since r563103,
                 but the cue might already be running (cover temporarily removed case)
                 and will register the new cover system through signalling Ch8_SabotageTrader_Cover_Init. -->
            <cue name="Ch8_SabotageTrader_Cover_Timeout" onfail="cancel">
              <conditions>
                <check_value value="$CoverDisabled_Penalty?"/>
              </conditions>
              <delay exact="1min"/>
              <actions>
                <remove_value name="$CoverDisabled_Penalty"/>
                <signal_cue cue="Ch8_SabotageTrader_Cover_Init"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Utility_Mission_Cues" comment="Used by other cues to avoid code duplicates">
          <cues>
            <cue name="Mission_Reset" comment="Resets $ResetableCue">
              <conditions>
                <!-- find the current chapter in the list and reset afterwards -->
                <event_cue_signalled/>
              </conditions>
              <actions>
                <reset_cue cue="$ResetableCue"/>
              </actions>
              <cues>
                <cue name="Mission_Reset_Delay">
                  <delay min="0.1s" max="0.5s"/>
                  <actions>
                    <signal_cue cue="$ResetableCue"/>
                    <reset_cue cue="parent"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <!-- No Mission-Appropriate Stations are around, the mission will reactivate once this changes -->
            <cue name="WaitForFactionToHaveStations" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="this.$Faction"    exact="event.param.{1}"/>
                <set_value name="this.$SignalCue"  exact="event.param.{2}"/>
              </actions>
              <cues>
                <cue name="Wait_For_Faction_Station_Station" checkinterval="613s" comment="~10 minutes">
                  <conditions>
                    <!-- Ask for event: <event_station_built/>-->
                    <count_stations trueowner="parent.$Faction" min="1" space="player.galaxy"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="parent.$SignalCue"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <!-- New version -->
            <cue name="WaitForFactionToHaveStations_Handler" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="this.$Faction"     exact="event.param.{'$Faction'}"/>
                <set_value name="this.$SignalCue"   exact="event.param.{'$SignalCue'}"/>
                <set_value name="this.$Delay"       exact="if event.param.$Delay? then event.param.$Delay else 59s"/>
                <debug_text text="'Waiting for faction ' + this.$Faction + ' to have (reachable) stations'" chance="$DebugChance"/>
              </actions>
              <cues>
                <cue name="WaitForFactionToHaveStations_Delay">
                  <delay exact="parent.$Delay"/>
                  <actions>
                    <signal_cue cue="WaitForFactionToHaveStations_Check_Start"/>
                  </actions>
                </cue>

                <cue name="WaitForFactionToHaveStations_Check_Start">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="WaitForFactionToHaveStations_Check" checkinterval="541s" comment="with the delay ~ 10 minutes for the first check, then every 9 minutes">
                      <conditions>
                        <!-- Ask for event: <event_station_built/>-->
                        <count_stations trueowner="parent.parent.$Faction" min="1" space="player.galaxy"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Found Stations in player.galaxy - Signalling SignalCue'" chance="$DebugChance"/>
                        <signal_cue cue="parent.parent.$SignalCue"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Sink_Effect_Court_Jobs">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!--<get_suitable_job result="$locCourtJobs" faction="faction.court" exceedquota="true" includeinactive="true" multiple="true"/>
            <do_for_each name="$locjob" in="$locCourtJobs">
              <set_job_active job="$locjob" activate="true"/>
            </do_for_each>
            <remove_value name="$locCourtJobs"/>
            
            There are new "defeated" state successor jobs which we don't want to be active immediately.
            -->

            <set_job_active activate="true" job="'court_carrier_patrol_xl_center'"/>
            <set_job_active activate="true" job="'court_frigate_patrol_m_sector'"/>

            <set_job_active activate="true" job="'court_destroyer_patrol_l_border_sector'"/>
            <set_job_active activate="true" job="'court_corvette_patrol_m_sector_exp'"/>
            <set_job_active activate="true" job="'court_fighter_patrol_s_border_zone'"/>

            <set_job_active activate="true" job="'court_frigate_patrol_m_sector_mission'"/>
            <set_job_active activate="true" job="'court_police_patrol_s'"/>

          </actions>
        </cue>

        <!--event.param = immediate (bool, optional)-->
        <cue name="Sink_Effect_Curbs_Stage1_NewFaction" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Sink_Effect_Curbs_Stage1_NewFaction signalled'"/>
            <set_value name="this.$Immediate" exact="event.param"/>
            <signal_cue cue="Sink_Effect_Court_Jobs"/>

            <!-- find relevant freesplit sectors (maybe in addition look for owner faction.freesplit, in case they expanded?) -->
            <find_sector name="this.$sector1" groupname="this.$sectors" macro="macro.cluster_409_sector001_macro" comment="Tharka's Ravine 1"/>
            <find_sector name="this.$sector2" groupname="this.$sectors" macro="macro.cluster_410_sector001_macro" comment="Tharka's Ravine 2"/>
            <find_sector name="this.$sector3" groupname="this.$sectors" macro="macro.cluster_412_sector001_macro" comment="Tharka's Ravine 3"/>
            <find_sector name="this.$sector4" groupname="this.$sectors" macro="macro.cluster_413_sector001_macro" comment="Tharka's Ravine 4"/>
            <find_sector name="this.$sector5" groupname="this.$sectors" macro="macro.cluster_411_sector001_macro" comment="Heart of Acrimony"/>

            <!-- takeover all freesplit claiming-stations, which will automatically transfer sector-ownership (assuming the faction can claim and no other faction has a station which can claim)
            Note, this leaves the HOJ - which is faction.split - untouched, and as a result Tharka's Ravine XXIV ownership does not change! ) -->
            <find_station name="this.$defencestations" space="this.$sectors.list" owner="faction.freesplit" canclaimownership="true" multiple="true"/>
            <debug_text text="'Found ' + this.$defencestations.count + ' claiming-stations owned by FRF in ' + this.$sector1.knownname + ', ' + this.$sector2.knownname + ', ' + this.$sector3.knownname + ', ' + this.$sector4.knownname + ', and ' + this.$sector5.knownname"/>

            <!--take over most of the factories-->
            <find_station name="this.$factories" space="this.$sectors.list" owner="faction.freesplit" defencestation="false" equipmentdock="false" wharf="false" shipyard="false" tradestation="false" multiple="true"/>
            <debug_text text="'Found ' + this.$factories.count + ' factories owned by FRF in ' + this.$sector1.knownname + ', ' + this.$sector2.knownname + ', ' + this.$sector3.knownname + ', ' + this.$sector4.knownname + ', and ' + this.$sector5.knownname"/>

            <!--TODO: also switch ownership of other job ships in those sectors that don't have a commander? Nick is aware -->

            <!-- Start .court factionlogic, which specifies "Heart of Acrimony | The Boneyard" as preferred HQ space. -->
            <signal_cue cue="md.FactionLogic.CourtFactionLogic" comment=".court(Court of Curbs)"/>
            <set_faction_active faction="faction.court" active="true"/>

            <run_actions ref="md.Diplomacy.Diplomacy_ActivateFactionLibrary">
              <param name="Faction" value="faction.court"/>
              <param name="DiplomatCapable" value="true"/>
              <param name="EventCapable" value="true"/>
            </run_actions>

            <remove_value name="this.$sectors"/>
          </actions>
          <patch sinceversion="2">
            <set_value name="$Split_Diplomacy_ActivateCurbs_Patch"/>
          </patch>
          <cues>

            <cue name="Sink_Effect_Curbs_Stage1_Takeover_DefenseStations" ref="md.LIB_Generic.TakeoverStations">
              <param name="Stations" value="parent.$defencestations"/>
              <param name="TargetFaction" value="faction.court"/>
              <param name="SuccessSignalCue" value="Sink_Effect_Curbs_Stage1_TakeOver_DefenseStations_Complete"/>
              <param name="Delay" value="if Sink_Effect_Curbs_Stage1_NewFaction.$Immediate then [0s] else [20s,30s]"/>
              <param name="Chance" value="90"/>
            </cue>

            <cue name="Sink_Effect_Curbs_Stage1_TakeOver_DefenseStations_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'defensestation takeover complete!'"/>
              </actions>
            </cue>

            <cue name="Sink_Effect_Curbs_Stage1_Takeover_Factories" ref="md.LIB_Generic.TakeoverStations">
              <param name="Stations" value="parent.$factories"/>
              <param name="TargetFaction" value="faction.court"/>
              <param name="SuccessSignalCue" value="Sink_Effect_Curbs_Stage1_TakeOver_Factories_Complete"/>
              <param name="Delay" value="if Sink_Effect_Curbs_Stage1_NewFaction.$Immediate then [0s] else [5s,10s]"/>
              <param name="Chance" value="90"/>
            </cue>

            <cue name="Sink_Effect_Curbs_Stage1_TakeOver_Factories_Complete" version="4">
              <conditions>
                <event_cue_signalled/>
                <check_value value="not Sink_Effect_Curbs_Stage1_NewFaction.$Immediate"/>
              </conditions>
              <actions>
                <debug_text text="'factory takeover complete!'"/>

                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10102}"/>
                <set_value name="$mail_signature" exact="{30221,10002}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10101}" comment="GalNet - Declaration of Curbs"
                                        text="$mail_message + $mail_signature"/>
              </actions>
              <delay exact="5min"/>
              <actions>
                <signal_cue cue="Ch7_Stage_2" comment="Delayed, check-false for people who saved in the middle of the sinks" check="false"/>
                <run_actions ref="md.LIB_Generic.FixFactionRepresentative">
                  <param name="Faction" value="[faction.freesplit, faction.split]"/>
                </run_actions>
              </actions>
              <patch sinceversion="2">
                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10102}"/>
                <set_value name="$mail_signature" exact="{30221,10002}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10101}" comment="GalNet - Declaration of Curbs"
                                        text="$mail_message + $mail_signature"/>
              </patch>
              <patch sinceversion="3" state="waiting">
                <do_if value="Sink_Effect_Curbs_Stage1_Takeover_Factories.state == cuestate.complete and Ch7_Stage_2.state == cuestate.waiting and not Sink_Effect_Curbs_Stage1_NewFaction.$Immediate">
                  <debug_text text="'Signalling cue Ch7_Stage_2'" filter="savegame"/>
                  <signal_cue cue="Ch7_Stage_2"/>
                </do_if>
              </patch>
              <patch sinceversion="3" state="complete">
                <do_if value="Ch7_Stage_2.state == cuestate.waiting">
                  <debug_text text="'Signalling cue Ch7_Stage_2'" filter="savegame"/>
                  <signal_cue cue="Ch7_Stage_2"/>
                </do_if>
              </patch>
              <patch sinceversion="4" state="complete">
                <!-- patch only the first case/stage to not do it trice unnecessarily -->
                <run_actions ref="md.LIB_Generic.FixFactionRepresentative">
                  <param name="Faction" value="[faction.freesplit, faction.split]"/>
                </run_actions>
              </patch>
            </cue>

          </cues>
        </cue>

        <!--event.param = immediate (bool, optional)-->
        <cue name="Sink_Effect_Curbs_Stage2_StopPolice" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Sink_Effect_Curbs_Stage2_StopPolice signalled'"/>
            <set_value name="this.$Immediate" exact="event.param"/>
            <find_sector name="this.$sector" macro="macro.cluster_407_sector001_macro" comment="Family Tkr"/>
            <!--<find_sector name="this.$sector" macro="macro.Cluster_16_Sector001_macro" comment="testmatrix"/>-->

            <!-- Switch all non-player-owned stations with a claimable module to court (automatically changes sector-ownership) -->
            <find_station name="this.$defencestations" space="this.$sector" canclaimownership="true" multiple="true">
              <match owner="[faction.split, faction.freesplit]"/>
            </find_station>
            <debug_text text="'Found ' + this.$defencestations.count + ' defence stations in sector ' + this.$sector.knownname"/>

            <!--TODO: ZYA stops policing FRF-->
            <!--<set_job_active activate="false" job="'zyarth_dronecarrier_patrol_m_sector_colonial'"/>-->
            <get_suitable_job result="$locColonialPoliceJobs" faction="faction.split" tags="tag.colonialpolice" exceedquota="true" multiple="true"/>
            <do_for_each name="$locjob" in="$locColonialPoliceJobs">
              <set_job_active activate="false" job="$locjob"/>
            </do_for_each>
            <remove_value name="$locColonialPoliceJobs"/>
            <!--<find_ship job="'zyarth_dronecarrier_patrol_m_sector_colonial'" multiple="true" name="$colonialPoliceForce" space="player.galaxy"/>-->
            <!--<set_job_active activate="false" job="'zyarth_destroyer_patrol_l_border_sector_colonial'"/>-->

          </actions>
          <patch sinceversion="2">
            <set_value name="$Patch_ReturnXenonStations"/>
          </patch>
          <cues>

            <cue name="Sink_Effect_Curbs_Stage2_StopPolice_DefenseStations" ref="md.LIB_Generic.TakeoverStations">
              <param name="Stations" value="parent.$defencestations"/>
              <param name="TargetFaction" value="faction.court"/>
              <param name="SuccessSignalCue" value="Sink_Effect_Curbs_Stage2_StopPolice_DefenseStations_Complete"/>
              <param name="Delay" value="if Sink_Effect_Curbs_Stage2_StopPolice.$Immediate then [0s] else [5s,10s]"/>
            </cue>

            <cue name="Sink_Effect_Curbs_Stage2_StopPolice_DefenseStations_Complete" version="2">
              <conditions>
                <event_cue_signalled/>
                <check_value value="not Sink_Effect_Curbs_Stage2_StopPolice.$Immediate"/>
              </conditions>
              <actions>
                <run_actions ref="md.LIB_Generic.FixFactionRepresentative">
                  <param name="Faction" value="[faction.freesplit, faction.split]"/>
                </run_actions>
                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10202}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10201}" comment="GalNet - Zyarth Patriarchy Withdraws Colonial Police"
                                        text="$mail_message"/>
              </actions>
              <patch sinceversion="2">
                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10202}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10201}" comment="GalNet - Zyarth Patriarchy Withdraws Colonial Police"
                                        text="$mail_message"/>
              </patch>
            </cue>

            <cue name="Patch_Return_XenonStations" onfail="cancel">
              <conditions>
                <check_value value="$Patch_ReturnXenonStations?"/>
              </conditions>
              <actions>
                <find_sector name="this.$sector" macro="macro.cluster_407_sector001_macro" comment="Family Tkr"/>
                <find_station name="$Debug_defencestations" space="this.$sector" canclaimownership="true" multiple="true">
                  <match owner="[faction.court]" comment="curb only"/>
                </find_station>

                <create_list name="$XenonStations"/>
                <do_for_each in="$Debug_defencestations" name="$station">
                  <do_if value="$station.controlentity.{controlpost.manager}.race == race.xenon">
                    <append_to_list name="$XenonStations" exact="$station"/>
                  </do_if>
                </do_for_each>
                <set_value name="$XenonStationsCount" exact="$XenonStations.count"/>
                <debug_text text="'Returning Xenon Stations ' + $XenonStations" chance="if $XenonStationsCount then 100 else 0"/>
              </actions>
              <cues>
                <cue name="Return_XenonStations" ref="md.LIB_Generic.TakeoverStations">
                  <param name="Stations" value="$XenonStations"/>
                  <param name="TargetFaction" value="faction.xenon"/>
                  <param name="SuccessSignalCue" value="Return_XenonStations_Complete"/>
                  <param name="Delay" value="if @Sink_Effect_Curbs_Stage2_StopPolice.$Immediate then [0s] else [5s,10s]"/>
                </cue>

                <cue name="Return_XenonStations_Complete">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Returned Xenon Stations: ' + $XenonStations" chance="if $XenonStationsCount then 100 else 0"/>
                  </actions>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <!--event.param = immediate (bool, optional)-->
        <cue name="Sink_Effect_Curbs_Stage3_NewPatriarchy" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Sink_Effect_Curbs_Stage3_NewPatriarchy signalled'"/>
            <set_value name="this.$Immediate" exact="event.param"/>

            <!-- find relevant freesplit sectors -->
            <find_sector name="this.$sector1" groupname="this.$sectors" macro="macro.cluster_400_sector001_macro" comment="Wretched Skies 1"/>
            <find_sector name="this.$sector2" groupname="this.$sectors" macro="macro.cluster_403_sector001_macro" comment="Wretched Skies 2"/>
            <find_sector name="this.$sector3" groupname="this.$sectors" macro="macro.cluster_422_sector001_macro" comment="Wretched Skies 3"/>
            <find_sector name="this.$sector4" groupname="this.$sectors" macro="macro.cluster_401_sector001_macro" comment="Family Zein"/>

            <!-- find defense-stations -->
            <find_station name="this.$defencestations" space="this.$sectors.list" owner="faction.split" canclaimownership="true" multiple="true"/>
            <debug_text text="'Found ' + this.$defencestations.count + ' .split defence stations in ' + this.$sector1.knownname + ', ' + this.$sector2.knownname + ', ' + this.$sector3.knownname + ', and ' + this.$sector4.knownname"/>

            <!--slave revolts, up to 3 random ZYA stations (not the "important ones") go to ARG-->
            <find_station name="this.$factories" owner="faction.split" space="player.galaxy" canclaimownership="false" equipmentdock="false" wharf="false" shipyard="false" tradestation="false" multiple="true"/>

            <remove_value name="this.$sectors"/>

            <clear_faction_diplomacy_exclusion faction="faction.split" otherfaction="faction.argon" flags="dlc1_1"/>
            <clear_faction_diplomacy_exclusion faction="faction.split" otherfaction="faction.court" flags="dlc1_1"/>
          </actions>
          <patch sinceversion="2">
            <set_value name="$Split_Diplomacy_ClearAllFactions_Patch"/>
          </patch>
          <cues>
            <cue name="Sink_Effect_Curbs_Stage3_TakeOver_Revolt" ref="md.LIB_Generic.TakeoverStations" comment="argon revolt on 3 stations">
              <param name="Stations" value="parent.$factories"/>
              <param name="TargetFaction" value="faction.argon"/>
              <param name="SuccessSignalCue" value="Sink_Effect_Curbs_Stage3_TakeOver_Revolt_Complete"/>
              <param name="Delay" value="if Sink_Effect_Curbs_Stage3_NewPatriarchy.$Immediate then [0s] else [5s]" comment="takeover goes very quickly"/>
              <param name="RandomCount" value="3"/>
            </cue>

            <cue name="Sink_Effect_Curbs_Stage3_TakeOver_Revolt_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'revolt takeover complete!'"/>
              </actions>
            </cue>

            <cue name="Sink_Effect_Curbs_Stage3_FactionRename" version="4">
              <actions>
                <!-- rename .split from "patriarch zyarth" to "patriarch rhak" (+ description + shortname + logo) -->
                <set_faction_identity faction="faction.split" name="'{20203,2201}'" description="'{20203,2202}'" shortname="'{20203,2203}'" prefixname="'{20203,2204}'" spacename="'{20203,2205}'" homespacename="'{20203,2206}'" icon="'faction_rhak'"/>
                <!-- default relations for faction Rhak-->
                <set_faction_relation faction="faction.split" otherfaction="faction.buccaneers" value="0.011"/>
                <set_faction_relation faction="faction.split" otherfaction="faction.fallensplit" value="-0.1"/>
                <!-- REMOVED: This was never announced in the story; No war between RHA and Argon/Antigone -->
                <!--<set_faction_relation faction="faction.split" otherfaction="faction.argon" value="faction.split.relation.enemy.max"/>
                <set_faction_relation faction="faction.split" otherfaction="faction.antigone" value="faction.split.relation.enemy.max"/>-->
              </actions>
              <patch sinceversion="2">
                <set_faction_identity faction="faction.split" name="'{20203,2201}'" description="'{20203,2202}'" shortname="'{20203,2203}'" prefixname="'{20203,2204}'" icon="'faction_rhak'"/>
              </patch>
              <patch sinceversion="3">
                <!-- Reset ARG/ANT relations towards Faction.Split -->
                <set_faction_relation faction="faction.split" otherfaction="faction.argon"    value="-0.1f"/>
                <set_faction_relation faction="faction.split" otherfaction="faction.antigone" value="-0.1f"/>
              </patch>
              <patch sinceversion="4">
                <set_faction_identity faction="faction.split" name="'{20203,2201}'" description="'{20203,2202}'" shortname="'{20203,2203}'" prefixname="'{20203,2204}'" spacename="'{20203,2205}'" homespacename="'{20203,2206}'" icon="'faction_rhak'"/>
              </patch>
            </cue>

            <cue name="Sink_Effect_Curbs_Stage3_SytemRename">
              <actions>
                <!-- "Zyarths's Dominion" sectors are renamed to "Rhak's Dominion" -->
                <find_sector name="this.$sector_zya1" macro="macro.cluster_404_sector001_macro" comment="Zyarth's Dominion I"/>
                <find_sector name="this.$sector_zya4" macro="macro.cluster_405_sector001_macro" comment="Zyarth's Dominion IV"/>
                <find_sector name="this.$sector_zya10" macro="macro.cluster_406_sector001_macro" comment="Zyarth's Dominion X"/>
                <!-- 1 system made of 3 clusters (2nd and 3rd cluster reference the text of the first) -->
                <set_object_name        object="this.$sector_zya1.cluster" page="20003" line="4040008"/>
                <set_object_description object="this.$sector_zya1.cluster" page="20003" line="4040009"/>
                <set_object_name        object="this.$sector_zya4.cluster" page="20003" line="4050008"/>
                <set_object_description object="this.$sector_zya4.cluster" page="20003" line="4050009"/>
                <set_object_name        object="this.$sector_zya10.cluster" page="20003" line="4060008"/>
                <set_object_description object="this.$sector_zya10.cluster" page="20003" line="4060009"/>
                <!-- each cluster has 1 sector-->
                <set_object_name        object="this.$sector_zya1" page="20004" line="4040018"/>
                <set_object_description object="this.$sector_zya1" page="20004" line="4040019"/>
                <set_object_name        object="this.$sector_zya4" page="20004" line="4050018"/>
                <set_object_description object="this.$sector_zya4" page="20004" line="4050019"/>
                <set_object_name        object="this.$sector_zya10" page="20004" line="4060018"/>
                <set_object_description object="this.$sector_zya10" page="20004" line="4060019"/>
                <!--set_object_description/-->
              </actions>
            </cue>

            <cue name="Sink_Effect_Curbs_Stage3_TakeOver_DefenseStations" ref="md.LIB_Generic.TakeoverStations" comment="claiming stations to .freesplit">
              <param name="Stations" value="parent.$defencestations"/>
              <param name="TargetFaction" value="faction.freesplit"/>
              <param name="SuccessSignalCue" value="Sink_Effect_Curbs_Stage3_TakeOver_DefenseStations_Complete"/>
              <param name="Delay" value="if Sink_Effect_Curbs_Stage3_NewPatriarchy.$Immediate then [100ms] else [20s,30s]" comment="If immediate, have a slight delay to keep order of events the same"/>
            </cue>

            <cue name="Sink_Effect_Curbs_Stage3_TakeOver_DefenseStations_Complete" version="2">
              <conditions>
                <event_cue_signalled/>
                <check_value value="not Sink_Effect_Curbs_Stage3_NewPatriarchy.$Immediate"/>
              </conditions>
              <actions>
                <debug_text text="'defensestation takeover complete!'"/>
                <signal_cue cue="Ch8_Sink_Completed_v2"/>
                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10402}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10401}" comment="GalNet - Rhak Patriarchy Succeeds Zyarth Patriarchy"
                                        text="$mail_message"/>

                <run_actions ref="md.LIB_Generic.FixFactionRepresentative">
                  <param name="Faction" value="[faction.freesplit, faction.split]"/>
                </run_actions>
              </actions>
              <patch sinceversion="2">
                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10402}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10401}" comment="GalNet - Rhak Patriarchy Succeeds Zyarth Patriarchy"
                                        text="$mail_message"/>
              </patch>
            </cue>

          </cues>
        </cue>

        <!--event.param = immediate (bool, optional)-->
        <cue name="Sink_Effect_Zyarth_Stage1_NewFaction" comment="Cabal of Curbs">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Sink_Effect_Zyarth_Stage1_NewFaction signalled'"/>
            <set_value name="this.$Immediate" exact="event.param"/>
            <signal_cue cue="Sink_Effect_Court_Jobs"/>

            <!-- find relevant freesplit sectors -->
            <find_sector name="this.$sector1" groupname="this.$sectors" macro="macro.cluster_409_sector001_macro" comment="Tharka's Ravine 1"/>
            <find_sector name="this.$sector2" groupname="this.$sectors" macro="macro.cluster_410_sector001_macro" comment="Tharka's Ravine 2"/>
            <find_sector name="this.$sector3" groupname="this.$sectors" macro="macro.cluster_412_sector001_macro" comment="Tharka's Ravine 3"/>
            <find_sector name="this.$sector4" groupname="this.$sectors" macro="macro.cluster_413_sector001_macro" comment="Tharka's Ravine 4"/>
            <find_sector name="this.$sector5" groupname="this.$sectors" macro="macro.cluster_411_sector001_macro" comment="Heart of Acrimony"/>

            <!-- takeover all freesplit claiming-stations, which will automatically transfer sector-ownership (assuming the faction can claim and no other faction has a station which can claim) -->
            <find_station name="this.$defencestations" space="this.$sectors.list" owner="faction.freesplit" canclaimownership="true" multiple="true"/>

            <debug_text text="'Found ' + this.$defencestations.count + ' objects owned by FRF in ' + this.$sector1.knownname + ', ' + this.$sector2.knownname + ', ' + this.$sector3.knownname + ', ' + this.$sector4.knownname + ', and ' + this.$sector5.knownname"/>

            <!--take over most of the factories-->
            <find_station name="this.$factories" space="this.$sectors.list" owner="faction.freesplit" defencestation="false" equipmentdock="false" wharf="false" shipyard="false" tradestation="false" multiple="true"/>
            <debug_text text="'Found ' + this.$factories.count + ' factories owned by .freesplit in ' + this.$sector1.knownname + ', ' + this.$sector2.knownname + ', ' + this.$sector3.knownname + ', ' + this.$sector4.knownname + ', and ' + this.$sector5.knownname"/>

            <!-- TODO: Tried to active state for job ID zyarth_police_patrol_colonial_increased_s, which is not valid! -->
            <!--set_job_active activate="true" job="'zyarth_police_patrol_colonial_increased_s'" comment="increase ZYA police presence in FRF space"/-->

            <remove_value name="this.$sectors"/>
          </actions>
          <cues>
            <cue name="Sink_Effect_Zyarth_Stage1_RenameFaction" version="4">
              <actions>
                <set_faction_active faction="faction.court" active="true"/>
                <!-- rename .court from 'Court of Curbs' to 'Cabal of Curbs' (+ description + shortname + logo) -->
                <set_faction_identity faction="faction.court" name="'{20203,1901}'" description="'{20203,1902}'" shortname="'{20203,1903}'" prefixname="'{20203,1904}'" spacename="'{20203,1905}'" homespacename="'{20203,1906}'" icon="'faction_cabal'" />
              </actions>
              <delay exact="if Sink_Effect_Zyarth_Stage1_NewFaction.$Immediate then 1s else 0s" comment="The immediate flag is primarily to instantly change the station owners. The faction logic / renaming can wait until after that."/>
              <actions>
                <!-- Start .court faction logic (which is simply named "Cabal of Curbs") -->
                <signal_cue_instantly cue="md.FactionLogic.CourtFactionLogic"/>
                <append_to_list name="md.FactionLogic.CourtFactionLogic_Manager.$PreferredHQTypes" exact="'any'"/>
              </actions>
              <patch sinceversion="2">
                <set_faction_identity faction="faction.court" name="'{20203,1901}'" description="'{20203,1902}'" shortname="'{20203,1903}'" prefixname="'{20203,1904}'"  icon="'faction_cabal'" />
              </patch>
              <patch sinceversion="3">
                <set_faction_identity faction="faction.court" name="'{20203,1901}'" description="'{20203,1902}'" shortname="'{20203,1903}'" prefixname="'{20203,1904}'" spacename="'{20203,1905}'" homespacename="'{20203,1906}'"  icon="'faction_cabal'" />
              </patch>
              <patch sinceversion="4">
                <set_value name="$Split_Diplomacy_ActivateCurbs_Patch"/>
              </patch>
            </cue>

            <cue name="Sink_Effect_Zyarth_Stage1_Takeover_DefenseStations" ref="md.LIB_Generic.TakeoverStations" comment="claiming stations to .split(zyarth)">
              <param name="Stations" value="parent.$defencestations"/>
              <param name="TargetFaction" value="faction.split"/>
              <param name="SuccessSignalCue" value="Sink_Effect_Zyarth_Stage1_TakeOver_DefenseStations_Complete"/>
              <param name="Delay" value="if Sink_Effect_Zyarth_Stage1_NewFaction.$Immediate then [0s] else [20s,30s]"/>
            </cue>

            <cue name="Sink_Effect_Zyarth_Stage1_TakeOver_DefenseStations_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'defensestation takeover complete!'"/>
              </actions>
            </cue>

            <cue name="Sink_Effect_Zyarth_Stage1_Takeover_Factories" ref="md.LIB_Generic.TakeoverStations">
              <param name="Stations" value="parent.$factories"/>
              <param name="TargetFaction" value="faction.court" comment="Court(Cabal)"/>
              <param name="SuccessSignalCue" value="Sink_Effect_Zyarth_Stage1_TakeOver_Factories_Complete"/>
              <param name="Delay" value="if Sink_Effect_Zyarth_Stage1_NewFaction.$Immediate then [0s] else [10s,20s,30s]" comment="can be ~60 stations, so this takes a few minutes"/>
              <param name="Chance" value="90"/>
            </cue>

            <cue name="Sink_Effect_Zyarth_Stage1_TakeOver_Factories_Complete" version="3">
              <conditions>
                <event_cue_signalled/>
                <check_value value="not Sink_Effect_Zyarth_Stage1_NewFaction.$Immediate"/>
              </conditions>
              <actions>
                <debug_text text="'defensestation takeover complete!'"/>
                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10102}"/>
                <set_value name="$mail_appendix" exact="{30221,10103}"/>
                <set_value name="$mail_signature" exact="{30221,10002}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10101}" comment="GalNet - Declaration of Curbs"
                                        text="$mail_message + '\n\n' + $mail_appendix + $mail_signature"/>
              </actions>
              <delay exact="5min"/>
              <actions>
                <signal_cue cue="Ch7_Stage_2" comment="Delayed, check-false for people who saved in the middle of the sinks" check="false"/>
              </actions>
              <patch sinceversion="2">
                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10102}"/>
                <set_value name="$mail_appendix" exact="{30221,10103}"/>
                <set_value name="$mail_signature" exact="{30221,10002}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10101}" comment="GalNet - Declaration of Curbs"
                                        text="$mail_message + $mail_appendix + $mail_signature"/>
              </patch>
              <patch sinceversion="3" state="waiting">
                <do_if value="Sink_Effect_Zyarth_Stage1_Takeover_Factories.state == cuestate.complete and Ch7_Stage_2.state == cuestate.waiting and not Sink_Effect_Zyarth_Stage1_NewFaction.$Immediate">
                  <debug_text text="'Signalling cue Ch7_Stage_2'" filter="savegame"/>
                  <signal_cue cue="Ch7_Stage_2"/>
                </do_if>
              </patch>
              <patch sinceversion="3" state="complete">
                <do_if value="Ch7_Stage_2.state == cuestate.waiting">
                  <debug_text text="'Signalling cue Ch7_Stage_2'" filter="savegame"/>
                  <signal_cue cue="Ch7_Stage_2"/>
                </do_if>
              </patch>
              <cues>
                <cue name="Ch6_Speak_Dal_623_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30221623], [30221624], [30221625], [30221626]]"/>
                  <param name="MissionCue"        value="if ($Ch6_Patriarchy_RemoveMissionLater? and not $Ch6_Patriarchy_RemovedMission?) then $MissionCue else null"/>
                  <param name="IsInMission"       value="$Ch6_Patriarchy_RemoveMissionLater? and not $Ch6_Patriarchy_RemovedMission?"/>
                  <!-- Dal	<t id="30221623	">	We've done it.
                       Dal	<t id="30221624	">	The attack during the speech should put a serious dent in the number of Split who will decide to join   them.
                       Dal	<t id="30221625	">	Most of the Free Families' Patriarchs have officially denounced their Curbs.
                       Dal	<t id="30221626	">	The Patriarchy has seized stations in Tharka's Ravine.
                  -->
                </cue>
              </cues>
            </cue>

            <cue name="Sink_Effect_Zyarth_Stage1_TakeOver_Complete_Patch">
              <actions>
                <signal_cue cue="Sink_Effect_Zyarth_Stage1_TakeOver_Complete"/>
              </actions>
            </cue>
            <cue name="Sink_Effect_Zyarth_Stage1_TakeOver_Complete">
              <conditions>
                <check_any>
                  <event_cue_signalled comment="patch case"/>
                  <event_cue_signalled cue="Sink_Effect_Zyarth_Stage1_TakeOver_DefenseStations_Complete"/>
                  <event_cue_signalled cue="Sink_Effect_Zyarth_Stage1_TakeOver_Factories_Complete"/>
                </check_any>
                <check_value value="cuestate.waiting != Sink_Effect_Zyarth_Stage1_TakeOver_DefenseStations_Complete.state"/>
                <check_value value="cuestate.waiting != Sink_Effect_Zyarth_Stage1_TakeOver_Factories_Complete.state"/>
              </conditions>
              <actions>
                <run_actions ref="md.LIB_Generic.FixFactionRepresentative">
                  <param name="Faction" value="[faction.freesplit, faction.split]"/>
                </run_actions>
              </actions>
            </cue>

          </cues>
        </cue>

        <!--event.param = immediate (bool, optional)-->
        <cue name="Sink_Effect_Zyarth_Stage2_TakeOverSectors" version="3">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Sink_Effect_Zyarth_Stage2_TakeOverSectors signalled'"/>
            <set_value name="this.$Immediate" exact="event.param"/>

            <!-- find relevant freesplit sectors -->
            <find_sector name="this.$sector1" macro="macro.cluster_407_sector001_macro" comment="Family Tkr"/>
            <find_sector name="this.$sector2" macro="macro.cluster_421_sector001_macro" comment="Fires of Defeat"/>

            <!-- takeover freesplit claiming-stations, which will automatically transfer sector-ownership (assuming the faction can claim and no other faction has a station which can claim) -->
            <find_station name="this.$defencestations" space="this.$sector1" owner="faction.freesplit" canclaimownership="true" multiple="true"/>
            <find_station name="this.$defencestations" space="this.$sector2" owner="faction.freesplit" canclaimownership="true" multiple="true" append="true"/>
            <debug_text text="'Found ' + this.$defencestations.count + ' defence stations owned by FRF in ' + this.$sector1.knownname + ' and ' + this.$sector2.knownname"/>

            <!-- Deactivate FAF RAider Jobs as promised -->

            <set_job_active activate="false" job="'fallensplit_raider_mixed_cluster'"/>

            <!-- Deactivate Curb jobs so they are sort of defeated.-->
            <set_job_active activate="false" job="'court_carrier_patrol_xl_center'" comment="1 quota"/>
            <set_job_active activate="false" job="'court_frigate_patrol_m_sector'" comment="~13 - 29"/>

            <!-- Successor Jobs: -->
            <set_job_active activate="false" job="'court_destroyer_patrol_l_border_sector'"   successor="'court_destroyer_patrol_l_defeated'"/>
            <set_job_active activate="false" job="'court_corvette_patrol_m_sector_exp'"       successor="'court_corvette_patrol_m_sector_defeated'"/>
            <set_job_active activate="false" job="'court_fighter_patrol_s_border_zone'"       successor="'court_fighter_patrol_s_border_zone_defeated'"/>

            <!-- Keep Jobs: -->
            <!--  'court_frigate_patrol_m_sector_mission'
                  'court_police_patrol_s' -->

            <clear_faction_diplomacy_exclusion faction="faction.split" otherfaction="faction.argon" flags="dlc1_1"/>
            <clear_faction_diplomacy_exclusion faction="faction.split" otherfaction="faction.court" flags="dlc1_1"/>
          </actions>
          <patch sinceversion="2">

            <!-- Deactivate Curb jobs so they are sort of defeated.-->
            <set_job_active activate="false" job="'court_carrier_patrol_xl_center'" comment="1 quota"/>
            <set_job_active activate="false" job="'court_frigate_patrol_m_sector'" comment="~13 - 29"/>

            <!-- Successor Jobs: -->
            <set_job_active activate="false" job="'court_destroyer_patrol_l_border_sector'"   successor="'court_destroyer_patrol_l_defeated'"/>
            <set_job_active activate="false" job="'court_corvette_patrol_m_sector_exp'"       successor="'court_corvette_patrol_m_sector_defeated'"/>
            <set_job_active activate="false" job="'court_fighter_patrol_s_border_zone'"       successor="'court_fighter_patrol_s_border_zone_defeated'"/>

            <!-- Keep Jobs: -->
            <!--  'court_frigate_patrol_m_sector_mission'
                  'court_police_patrol_s' -->

          </patch>
          <patch sinceversion="3">
            <set_value name="$Split_Diplomacy_ClearAllFactions_Patch"/>
          </patch>
          <cues>

            <cue name="Sink_Effect_Zyarth_Stage2_TakeOver_DefenseStations" ref="md.LIB_Generic.TakeoverStations">
              <param name="Stations" value="parent.$defencestations"/>
              <param name="TargetFaction" value="faction.split"/>
              <param name="SuccessSignalCue" value="Sink_Effect_Zyarth_Stage2_TakeOver_DefenseStations_Complete"/>
              <param name="Delay" value="if Sink_Effect_Zyarth_Stage2_TakeOverSectors.$Immediate then [0s] else [20s, 30s]"/>
            </cue>

            <cue name="Sink_Effect_Zyarth_Stage2_TakeOver_DefenseStations_Complete" version="2">
              <conditions>
                <event_cue_signalled/>
                <check_value value="not Sink_Effect_Zyarth_Stage2_TakeOverSectors.$Immediate"/>
              </conditions>
              <actions>
                <debug_text text="'defensestation takeover complete!'"/>

                <run_actions ref="md.LIB_Generic.FixFactionRepresentative">
                  <param name="Faction" value="[faction.freesplit, faction.split]"/>
                </run_actions>
                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10302}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10301}" comment="GalNet - Zyarth Patriarchy Seizes Assets"
                                        text="$mail_message"/>
              </actions>
              <patch sinceversion="2">
                <!-- Sink Effect E-Mail -->
                <set_value name="$mail_message" exact="{30221,10302}"/>
                <write_incoming_message source="{30221,10001}" highpriority="true"
                                        title="{30221,10301}" comment="GalNet - Zyarth Patriarchy Seizes Assets"
                                        text="$mail_message"/>
              </patch>
            </cue>

          </cues>
        </cue>


      </cues>
    </cue>

    <cue name="Patch_Userdata" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
      </conditions>
      <actions>
        <do_if value="Ch5_Choose.state == cuestate.complete or Ch5_Choose.state == cuestate.cancelled">
          <set_userdata storystate="'story_split_faction_decision'" value="1"/>
        </do_if>

        <do_if value="Ch7_Stage_2.state == cuestate.complete or Ch7_Stage_2.state == cuestate.cancelled">
          <do_if value="Start.$PlayerChose == 'Patriarchy'">
            <set_userdata storystate="'story_split_cabal_coup'" value="1"/>
          </do_if>
          <do_else>
            <set_userdata storystate="'story_split_curbs_declaration'" value="1"/>
          </do_else>
        </do_if>

        <do_if value="Ch8_Stage_3_v2.state == cuestate.complete or Ch8_Stage_3_v2.state == cuestate.cancelled">
          <set_userdata storystate="'story_split_curbs_no_colonial_police'" value="1"/>
        </do_if>

        <do_if value="Sink_Effect_Zyarth_Stage2_TakeOverSectors.state == cuestate.complete or Sink_Effect_Zyarth_Stage2_TakeOverSectors.state == cuestate.cancelled">
          <set_userdata storystate="'story_split_cabal_complete'" value="1"/>
        </do_if>

        <do_if value="Sink_Effect_Curbs_Stage3_NewPatriarchy.state == cuestate.complete or Sink_Effect_Curbs_Stage3_NewPatriarchy.state == cuestate.cancelled">
          <set_userdata storystate="'story_split_court_complete'" value="1"/>
        </do_if>
      </actions>
    </cue>

    <cue name="PatchCue_Check_AllDiplomaticChanges" onfail="cancel">
      <conditions>
        <check_value value="md.Diplomacy.Start.state == cuestate.complete"/>
      </conditions>
      <actions>
        <signal_cue cue="PatchCue_AllDiplomaticChanges" check="false"/>
      </actions>
    </cue>
    <cue name="PatchCue_AllDiplomaticChanges">
      <conditions>
        <check_any>
          <event_cue_completed cue="md.Diplomacy.Start"/>
          <event_cue_signalled/>
        </check_any>
        <check_any>
          <check_value value="md.Story_Split.Start.$Split_Diplomacy_ClearAllFactions_Patch?"/>
          <check_value value="md.Story_Split.Start.$Split_Diplomacy_ActivateCurbs_Patch?"/>
        </check_any>
      </conditions>
      <actions>
        <do_if value="md.Story_Split.Start.$Split_Diplomacy_ClearAllFactions_Patch?">
          <clear_faction_diplomacy_exclusion faction="faction.split" otherfaction="faction.argon" flags="dlc1_1"/>
          <clear_faction_diplomacy_exclusion faction="faction.split" otherfaction="faction.court" flags="dlc1_1"/>
        </do_if>

        <do_if value="md.Story_Split.Start.$Split_Diplomacy_ActivateCurbs_Patch?">
          <run_actions ref="md.Diplomacy.Diplomacy_ActivateFactionLibrary">
            <param name="Faction" value="faction.court"/>
            <param name="DiplomatCapable" value="true"/>
            <param name="EventCapable" value="true"/>
          </run_actions>
        </do_if>
      </actions>
    </cue>

    <cue name="Debug_Curbs_Jobs">
      <cues>
        <cue name="Print_Jobs">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <find_ship name="$CurbShips" multiple="true" owner="faction.court" space="player.galaxy"/>
            <create_list name="$L"/>
            <do_for_each name="$s" in="$CurbShips">
              <do_if value="not $L.indexof.{$s.job}">
                <append_to_list name="$L" exact="$s.job"/>
              </do_if>
            </do_for_each>
            <debug_text text="$L"/>
          </actions>
        </cue>
      </cues>
    </cue>

  </cues>
</mdscript>
